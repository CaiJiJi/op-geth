<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-GLhlTQ8iRABdZLl6O3oVMWSktQOp6b7In1Zl3/Jr59b6EGGoI1aFkw7cmDA6j6gD" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.2/font/bootstrap-icons.css">

    <title>op-geth - go-ethereum fork diff overview</title>

    <link rel="icon" type="image/x-icon" href="">

    <style>
        .line-stat {
            width: 14rem;
            float: right;
        }
        .line-stat div {
            width: 50%;
        }
    </style>

    
<style>
    .term-container {
        background: #171717;
        border-radius: 5px;
        color: white;
        word-break: break-word;
        overflow-wrap: break-word;
        font-family: "SFMono-Regular", Monaco, Menlo, Consolas, "Liberation Mono", Courier, monospace;
        font-size: 12px;
        line-height: 20px;
        padding: 14px 18px;
        white-space: pre-wrap;
    }

    .term-container img { max-width: 100%; }

    .term a { color: inherit; text-decoration: underline; text-decoration-style: dashed; }
    .term a:hover { color: #2882F9 }

    @keyframes blink-animation {
        to {
            visibility: hidden;
        }
    }

    .term-fg1 { } /* don't bold beccause it looks weird */
    .term-fg2 { color: #838887; } /* faint (decreased intensity) - same as gray really */
    .term-fg3 { font-style: italic; } /* italic */
    .term-fg4 { text-decoration: underline; } /* underline */
    .term-fg5 { animation: blink-animation 1s steps(3, start) infinite; } /* blink */
    .term-fg9 { text-decoration: line-through; } /* crossed-out */

    .term-fg30 { color: #666666; } /* black (but we can't use black, so a diff color) */
    .term-fg31 { color: #ff7070; } /* red */
    .term-fg32 { color: #b0f986; } /* green */
    .term-fg33 { color: #c6c502; } /* yellow */
    .term-fg34 { color: #8db7e0; } /* blue */
    .term-fg35 { color: #f271fb; } /* magenta */
    .term-fg36 { color: #6bf7ff; } /* cyan */

    /* high intense colors */
    .term-fgi1 { color: #5ef765; }
    .term-fgi90 { color: #838887; } /* grey */
    .term-fgi91 { color: #ff3333; } /* red */
    .term-fgi92 { color: #00FF00; } /* green */
    .term-fgi93 { color: #fffc67; } /* yellow */
    .term-fgi94 { color: #6871ff; } /* blue */
    .term-fgi95 { color: #ff76ff; } /* magenta */
    .term-fgi96 { color: #60fcff; } /* cyan */

    /* background colors */
    .term-bg40 { background: #676767; } /* grey */
    .term-bg41 { background: #ff4343; } /* red */
    .term-bg42 { background: #99ff5f; } /* green */

    /* custom foreground/background combos for readability */
    .term-fg31.term-bg40 { color: #F8A39F; }

    /* xterm colors */
    .term-fgx16 { color: #000000; }
    .term-fgx17 { color: #00005f; }
    .term-fgx18 { color: #000087; }
    .term-fgx19 { color: #0000af; }
    .term-fgx20 { color: #0000d7; }
    .term-fgx21 { color: #0000ff; }
    .term-fgx22 { color: #005f00; }
    .term-fgx23 { color: #005f5f; }
    .term-fgx24 { color: #005f87; }
    .term-fgx25 { color: #005faf; }
    .term-fgx26 { color: #005fd7; }
    .term-fgx27 { color: #005fff; }
    .term-fgx28 { color: #008700; }
    .term-fgx29 { color: #00875f; }
    .term-fgx30 { color: #008787; }
    .term-fgx31 { color: #0087af; }
    .term-fgx32 { color: #0087d7; }
    .term-fgx33 { color: #0087ff; }
    .term-fgx34 { color: #00af00; }
    .term-fgx35 { color: #00af5f; }
    .term-fgx36 { color: #00af87; }
    .term-fgx37 { color: #00afaf; }
    .term-fgx38 { color: #00afd7; }
    .term-fgx39 { color: #00afff; }
    .term-fgx40 { color: #00d700; }
    .term-fgx41 { color: #00d75f; }
    .term-fgx42 { color: #00d787; }
    .term-fgx43 { color: #00d7af; }
    .term-fgx44 { color: #00d7d7; }
    .term-fgx45 { color: #00d7ff; }
    .term-fgx46 { color: #00ff00; }
    .term-fgx47 { color: #00ff5f; }
    .term-fgx48 { color: #00ff87; }
    .term-fgx49 { color: #00ffaf; }
    .term-fgx50 { color: #00ffd7; }
    .term-fgx51 { color: #00ffff; }
    .term-fgx52 { color: #5f0000; }
    .term-fgx53 { color: #5f005f; }
    .term-fgx54 { color: #5f0087; }
    .term-fgx55 { color: #5f00af; }
    .term-fgx56 { color: #5f00d7; }
    .term-fgx57 { color: #5f00ff; }
    .term-fgx58 { color: #5f5f00; }
    .term-fgx59 { color: #5f5f5f; }
    .term-fgx60 { color: #5f5f87; }
    .term-fgx61 { color: #5f5faf; }
    .term-fgx62 { color: #5f5fd7; }
    .term-fgx63 { color: #5f5fff; }
    .term-fgx64 { color: #5f8700; }
    .term-fgx65 { color: #5f875f; }
    .term-fgx66 { color: #5f8787; }
    .term-fgx67 { color: #5f87af; }
    .term-fgx68 { color: #5f87d7; }
    .term-fgx69 { color: #5f87ff; }
    .term-fgx70 { color: #5faf00; }
    .term-fgx71 { color: #5faf5f; }
    .term-fgx72 { color: #5faf87; }
    .term-fgx73 { color: #5fafaf; }
    .term-fgx74 { color: #5fafd7; }
    .term-fgx75 { color: #5fafff; }
    .term-fgx76 { color: #5fd700; }
    .term-fgx77 { color: #5fd75f; }
    .term-fgx78 { color: #5fd787; }
    .term-fgx79 { color: #5fd7af; }
    .term-fgx80 { color: #5fd7d7; }
    .term-fgx81 { color: #5fd7ff; }
    .term-fgx82 { color: #5fff00; }
    .term-fgx83 { color: #5fff5f; }
    .term-fgx84 { color: #5fff87; }
    .term-fgx85 { color: #5fffaf; }
    .term-fgx86 { color: #5fffd7; }
    .term-fgx87 { color: #5fffff; }
    .term-fgx88 { color: #870000; }
    .term-fgx89 { color: #87005f; }
    .term-fgx90 { color: #870087; }
    .term-fgx91 { color: #8700af; }
    .term-fgx92 { color: #8700d7; }
    .term-fgx93 { color: #8700ff; }
    .term-fgx94 { color: #875f00; }
    .term-fgx95 { color: #875f5f; }
    .term-fgx96 { color: #875f87; }
    .term-fgx97 { color: #875faf; }
    .term-fgx98 { color: #875fd7; }
    .term-fgx99 { color: #875fff; }
    .term-fgx100 { color: #878700; }
    .term-fgx101 { color: #87875f; }
    .term-fgx102 { color: #878787; }
    .term-fgx103 { color: #8787af; }
    .term-fgx104 { color: #8787d7; }
    .term-fgx105 { color: #8787ff; }
    .term-fgx106 { color: #87af00; }
    .term-fgx107 { color: #87af5f; }
    .term-fgx108 { color: #87af87; }
    .term-fgx109 { color: #87afaf; }
    .term-fgx110 { color: #87afd7; }
    .term-fgx111 { color: #87afff; }
    .term-fgx112 { color: #87d700; }
    .term-fgx113 { color: #87d75f; }
    .term-fgx114 { color: #87d787; }
    .term-fgx115 { color: #87d7af; }
    .term-fgx116 { color: #87d7d7; }
    .term-fgx117 { color: #87d7ff; }
    .term-fgx118 { color: #87ff00; }
    .term-fgx119 { color: #87ff5f; }
    .term-fgx120 { color: #87ff87; }
    .term-fgx121 { color: #87ffaf; }
    .term-fgx122 { color: #87ffd7; }
    .term-fgx123 { color: #87ffff; }
    .term-fgx124 { color: #af0000; }
    .term-fgx125 { color: #af005f; }
    .term-fgx126 { color: #af0087; }
    .term-fgx127 { color: #af00af; }
    .term-fgx128 { color: #af00d7; }
    .term-fgx129 { color: #af00ff; }
    .term-fgx130 { color: #af5f00; }
    .term-fgx131 { color: #af5f5f; }
    .term-fgx132 { color: #af5f87; }
    .term-fgx133 { color: #af5faf; }
    .term-fgx134 { color: #af5fd7; }
    .term-fgx135 { color: #af5fff; }
    .term-fgx136 { color: #af8700; }
    .term-fgx137 { color: #af875f; }
    .term-fgx138 { color: #af8787; }
    .term-fgx139 { color: #af87af; }
    .term-fgx140 { color: #af87d7; }
    .term-fgx141 { color: #af87ff; }
    .term-fgx142 { color: #afaf00; }
    .term-fgx143 { color: #afaf5f; }
    .term-fgx144 { color: #afaf87; }
    .term-fgx145 { color: #afafaf; }
    .term-fgx146 { color: #afafd7; }
    .term-fgx147 { color: #afafff; }
    .term-fgx148 { color: #afd700; }
    .term-fgx149 { color: #afd75f; }
    .term-fgx150 { color: #afd787; }
    .term-fgx151 { color: #afd7af; }
    .term-fgx152 { color: #afd7d7; }
    .term-fgx153 { color: #afd7ff; }
    .term-fgx154 { color: #afff00; }
    .term-fgx155 { color: #afff5f; }
    .term-fgx156 { color: #afff87; }
    .term-fgx157 { color: #afffaf; }
    .term-fgx158 { color: #afffd7; }
    .term-fgx159 { color: #afffff; }
    .term-fgx160 { color: #d70000; }
    .term-fgx161 { color: #d7005f; }
    .term-fgx162 { color: #d70087; }
    .term-fgx163 { color: #d700af; }
    .term-fgx164 { color: #d700d7; }
    .term-fgx165 { color: #d700ff; }
    .term-fgx166 { color: #d75f00; }
    .term-fgx167 { color: #d75f5f; }
    .term-fgx168 { color: #d75f87; }
    .term-fgx169 { color: #d75faf; }
    .term-fgx170 { color: #d75fd7; }
    .term-fgx171 { color: #d75fff; }
    .term-fgx172 { color: #d78700; }
    .term-fgx173 { color: #d7875f; }
    .term-fgx174 { color: #d78787; }
    .term-fgx175 { color: #d787af; }
    .term-fgx176 { color: #d787d7; }
    .term-fgx177 { color: #d787ff; }
    .term-fgx178 { color: #d7af00; }
    .term-fgx179 { color: #d7af5f; }
    .term-fgx180 { color: #d7af87; }
    .term-fgx181 { color: #d7afaf; }
    .term-fgx182 { color: #d7afd7; }
    .term-fgx183 { color: #d7afff; }
    .term-fgx184 { color: #d7d700; }
    .term-fgx185 { color: #d7d75f; }
    .term-fgx186 { color: #d7d787; }
    .term-fgx187 { color: #d7d7af; }
    .term-fgx188 { color: #d7d7d7; }
    .term-fgx189 { color: #d7d7ff; }
    .term-fgx190 { color: #d7ff00; }
    .term-fgx191 { color: #d7ff5f; }
    .term-fgx192 { color: #d7ff87; }
    .term-fgx193 { color: #d7ffaf; }
    .term-fgx194 { color: #d7ffd7; }
    .term-fgx195 { color: #d7ffff; }
    .term-fgx196 { color: #ff0000; }
    .term-fgx197 { color: #ff005f; }
    .term-fgx198 { color: #ff0087; }
    .term-fgx199 { color: #ff00af; }
    .term-fgx200 { color: #ff00d7; }
    .term-fgx201 { color: #ff00ff; }
    .term-fgx202 { color: #ff5f00; }
    .term-fgx203 { color: #ff5f5f; }
    .term-fgx204 { color: #ff5f87; }
    .term-fgx205 { color: #ff5faf; }
    .term-fgx206 { color: #ff5fd7; }
    .term-fgx207 { color: #ff5fff; }
    .term-fgx208 { color: #ff8700; }
    .term-fgx209 { color: #ff875f; }
    .term-fgx210 { color: #ff8787; }
    .term-fgx211 { color: #ff87af; }
    .term-fgx212 { color: #ff87d7; }
    .term-fgx213 { color: #ff87ff; }
    .term-fgx214 { color: #ffaf00; }
    .term-fgx215 { color: #ffaf5f; }
    .term-fgx216 { color: #ffaf87; }
    .term-fgx217 { color: #ffafaf; }
    .term-fgx218 { color: #ffafd7; }
    .term-fgx219 { color: #ffafff; }
    .term-fgx220 { color: #ffd700; }
    .term-fgx221 { color: #ffd75f; }
    .term-fgx222 { color: #ffd787; }
    .term-fgx223 { color: #ffd7af; }
    .term-fgx224 { color: #ffd7d7; }
    .term-fgx225 { color: #ffd7ff; }
    .term-fgx226 { color: #ffff00; }
    .term-fgx227 { color: #ffff5f; }
    .term-fgx228 { color: #ffff87; }
    .term-fgx229 { color: #ffffaf; }
    .term-fgx230 { color: #ffffd7; }
    .term-fgx231 { color: #ffffff; }
    .term-fgx232 { color: #080808; }
    .term-fgx233 { color: #121212; }
    .term-fgx234 { color: #1c1c1c; }
    .term-fgx235 { color: #262626; }
    .term-fgx236 { color: #303030; }
    .term-fgx237 { color: #3a3a3a; }
    .term-fgx238 { color: #444444; }
    .term-fgx239 { color: #4e4e4e; }
    .term-fgx240 { color: #585858; }
    .term-fgx241 { color: #626262; }
    .term-fgx242 { color: #6c6c6c; }
    .term-fgx243 { color: #767676; }
    .term-fgx244 { color: #808080; }
    .term-fgx245 { color: #8a8a8a; }
    .term-fgx246 { color: #949494; }
    .term-fgx247 { color: #9e9e9e; }
    .term-fgx248 { color: #a8a8a8; }
    .term-fgx249 { color: #b2b2b2; }
    .term-fgx250 { color: #bcbcbc; }
    .term-fgx251 { color: #c6c6c6; }
    .term-fgx252 { color: #d0d0d0; }
    .term-fgx253 { color: #dadada; }
    .term-fgx254 { color: #e4e4e4; }
    .term-fgx255 { color: #eeeeee; }
</style>

</head>
<body>
    <div class="col-xl-10 col-xxl-8 mx-auto px-3 py-1 py-md-3">
        <main class="container-fluid">
            <div class="row">
                <div>
                    <div class="float-end">
                        <div class="form-check form-switch">
                            <i class="bi bi-brightness-low" id="dark-mode-icon"></i>
                            <input class="form-check-input" type="checkbox" role="switch" id="dark-mode-toggle" data-bs-toggle="tooltip"
                                   data-bs-placement="bottom" data-bs-title="Toggle Dark Mode"/>
                        </div>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="ps-1 py-2 my-1"><div class="row border-bottom border-1"role="button" aria-expanded="true" aria-controls="id-94c973eb4d8d30d7ba9ddf6a">
        
            <div class="col-12 col-sm-9 text-start"><h1>op-geth</h1></div>
        
        <div class="col-12 col-sm-3 ms-auto mt-2">
            <div class="row line-stat">
                <div class="text-end"><span class="text-success">+7729</span></div>
                <div class="text-start"><span class="text-danger">-2681</span></div>
            </div>
        </div>
    </div>

    <div class="row forkdef-content collapse show border-1 ps-3 my-3" id="id-94c973eb4d8d30d7ba9ddf6a">
        <div><p>This is an overview of the changes in <a href="https://github.com/ethereum-optimism/op-geth"><code>op-geth</code></a>,
a fork of <a href="https://github.com/ethereum/go-ethereum"><code>go-ethereum</code></a>, part of the OP-stack.</p>

<p>The OP-stack architecture is modular, following the Consensus/Execution split of post-Merge Ethereum L1:</p>

<ul>
<li><a href="https://github.com/ethereum-optimism/optimism/tree/develop/op-node"><code>op-node</code></a> implements most rollup-specific functionality as Consensus-Layer, similar to a L1 beacon-node.</li>
<li><a href="https://github.com/ethereum-optimism/op-geth"><code>op-geth</code></a> implements the Execution-Layer, with <strong>minimal changes</strong> for a secure Ethereum-equivalent application environment.</li>
</ul>

<p>Related <a href="https://github.com/ethereum-optimism/optimism/tree/develop/specs">op-stack specifications</a>:</p>

<ul>
<li><a href="https://github.com/ethereum-optimism/optimism/blob/develop/specs/exec-engine.md">L2 Execution Engine spec</a></li>
<li><a href="https://github.com/ethereum-optimism/optimism/blob/develop/specs/deposits.md">Deposit Transaction spec</a></li>
</ul>
</div>
        <div>
            
        </div>
        <div>
            
                <div class="ps-1 py-2 my-1"><div class="row border-bottom border-1"data-bs-toggle="collapse" data-bs-target="#id-1c84d2c1128e86fdb3161fa2"role="button" aria-expanded="false" aria-controls="id-1c84d2c1128e86fdb3161fa2">
        
            <div class="col-12 col-sm-9 text-start"><h2>Core modifications</h2></div>
        
        <div class="col-12 col-sm-3 ms-auto mt-2">
            <div class="row line-stat">
                <div class="text-end"><span class="text-success">+949</span></div>
                <div class="text-start"><span class="text-danger">-131</span></div>
            </div>
        </div>
    </div>

    <div class="row forkdef-content collapse  border-1 ps-3 my-3" id="id-1c84d2c1128e86fdb3161fa2">
        <div></div>
        <div>
            
        </div>
        <div>
            
                <div class="ps-1 py-2 my-1"><div class="row border-bottom border-1"data-bs-toggle="collapse" data-bs-target="#id-c248b099c7ddd9f803bd3298"role="button" aria-expanded="false" aria-controls="id-c248b099c7ddd9f803bd3298">
        
            <div class="col-12 col-sm-9 text-start"><h3>State-transition modifications</h3></div>
        
        <div class="col-12 col-sm-3 ms-auto mt-2">
            <div class="row line-stat">
                <div class="text-end"><span class="text-success">+541</span></div>
                <div class="text-start"><span class="text-danger">-45</span></div>
            </div>
        </div>
    </div>

    <div class="row forkdef-content collapse  border-1 ps-3 my-3" id="id-c248b099c7ddd9f803bd3298">
        <div></div>
        <div>
            
        </div>
        <div>
            
                <div class="ps-1 py-2 my-1"><div class="row border-bottom border-1"data-bs-toggle="collapse" data-bs-target="#id-8a46d7ab866ff251fe8054ae"role="button" aria-expanded="false" aria-controls="id-8a46d7ab866ff251fe8054ae">
        
            <div class="col-12 col-sm-9 text-start"><h4>Deposit Transaction type</h4></div>
        
        <div class="col-12 col-sm-3 ms-auto mt-2">
            <div class="row line-stat">
                <div class="text-end"><span class="text-success">+198</span></div>
                <div class="text-start"><span class="text-danger">-1</span></div>
            </div>
        </div>
    </div>

    <div class="row forkdef-content collapse  border-1 ps-3 my-3" id="id-8a46d7ab866ff251fe8054ae">
        <div><p>The Bedrock upgrade introduces a <code>Deposit</code> transaction-type (<code>0x7E</code>) to enable both users and the
rollup system itself to change the L2 state based on L1 events and system rules as
<a href="https://github.com/ethereum-optimism/optimism/blob/develop/specs/deposits.md">specified</a>.</p>
</div>
        <div>
            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-8bc56a8eb9ec31635a6f4577" role="button"
                   aria-expanded="false" aria-controls="id-8bc56a8eb9ec31635a6f4577">
                    <code>core/types/deposit_tx.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <span class="text-muted">(new)</span>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/650bb2f2b1dcfe30d9b1fa6f7dc9608055ed60e1/core/types/deposit_tx.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+103</span></div>
                        <div class="text-start"><span class="text-danger">-0</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-8bc56a8eb9ec31635a6f4577"><span class="term-fg1">diff --git go-ethereum&#47;core&#47;types&#47;deposit_tx.go op-geth&#47;core&#47;types&#47;deposit_tx.go</span>
<span class="term-fg1">new file mode 100644</span>
<span class="term-fg1">index 0000000000000000000000000000000000000000..4131ee7af037275dcacd795baab4e0d55a1acb07</span>
<span class="term-fg1">--- &#47;dev&#47;null</span>
<span class="term-fg1">+++ op-geth&#47;core&#47;types&#47;deposit_tx.go</span>
<span class="term-fg36">@@ -0,0 +1,103 @@</span>
<span class="term-fg32">+&#47;&#47; Copyright 2021 The go-ethereum Authors</span>
<span class="term-fg32">+&#47;&#47; This file is part of the go-ethereum library.</span>
<span class="term-fg32">+&#47;&#47;</span>
<span class="term-fg32">+&#47;&#47; The go-ethereum library is free software: you can redistribute it and&#47;or modify</span>
<span class="term-fg32">+&#47;&#47; it under the terms of the GNU Lesser General Public License as published by</span>
<span class="term-fg32">+&#47;&#47; the Free Software Foundation, either version 3 of the License, or</span>
<span class="term-fg32">+&#47;&#47; (at your option) any later version.</span>
<span class="term-fg32">+&#47;&#47;</span>
<span class="term-fg32">+&#47;&#47; The go-ethereum library is distributed in the hope that it will be useful,</span>
<span class="term-fg32">+&#47;&#47; but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="term-fg32">+&#47;&#47; MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the</span>
<span class="term-fg32">+&#47;&#47; GNU Lesser General Public License for more details.</span>
<span class="term-fg32">+&#47;&#47;</span>
<span class="term-fg32">+&#47;&#47; You should have received a copy of the GNU Lesser General Public License</span>
<span class="term-fg32">+&#47;&#47; along with the go-ethereum library. If not, see &lt;http:&#47;&#47;www.gnu.org&#47;licenses&#47;&gt;.</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+package types</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+import (</span>
<span class="term-fg32">+	&quot;bytes&quot;</span>
<span class="term-fg32">+	&quot;math&#47;big&quot;</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;common&quot;</span>
<span class="term-fg32">+	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;rlp&quot;</span>
<span class="term-fg32">+)</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+const DepositTxType = 0x7E</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+type DepositTx struct {</span>
<span class="term-fg32">+	&#47;&#47; SourceHash uniquely identifies the source of the deposit</span>
<span class="term-fg32">+	SourceHash common.Hash</span>
<span class="term-fg32">+	&#47;&#47; From is exposed through the types.Signer, not through TxData</span>
<span class="term-fg32">+	From common.Address</span>
<span class="term-fg32">+	&#47;&#47; nil means contract creation</span>
<span class="term-fg32">+	To *common.Address `rlp:&quot;nil&quot;`</span>
<span class="term-fg32">+	&#47;&#47; Mint is minted on L2, locked on L1, nil if no minting.</span>
<span class="term-fg32">+	Mint *big.Int `rlp:&quot;nil&quot;`</span>
<span class="term-fg32">+	&#47;&#47; Value is transferred from L2 balance, executed after Mint (if any)</span>
<span class="term-fg32">+	Value *big.Int</span>
<span class="term-fg32">+	&#47;&#47; gas limit</span>
<span class="term-fg32">+	Gas uint64</span>
<span class="term-fg32">+	&#47;&#47; Field indicating if this transaction is exempt from the L2 gas limit.</span>
<span class="term-fg32">+	IsSystemTransaction bool</span>
<span class="term-fg32">+	&#47;&#47; Normal Tx data</span>
<span class="term-fg32">+	Data []byte</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+&#47;&#47; copy creates a deep copy of the transaction data and initializes all fields.</span>
<span class="term-fg32">+func (tx *DepositTx) copy() TxData {</span>
<span class="term-fg32">+	cpy := &amp;DepositTx{</span>
<span class="term-fg32">+		SourceHash:          tx.SourceHash,</span>
<span class="term-fg32">+		From:                tx.From,</span>
<span class="term-fg32">+		To:                  copyAddressPtr(tx.To),</span>
<span class="term-fg32">+		Mint:                nil,</span>
<span class="term-fg32">+		Value:               new(big.Int),</span>
<span class="term-fg32">+		Gas:                 tx.Gas,</span>
<span class="term-fg32">+		IsSystemTransaction: tx.IsSystemTransaction,</span>
<span class="term-fg32">+		Data:                common.CopyBytes(tx.Data),</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	if tx.Mint != nil {</span>
<span class="term-fg32">+		cpy.Mint = new(big.Int).Set(tx.Mint)</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	if tx.Value != nil {</span>
<span class="term-fg32">+		cpy.Value.Set(tx.Value)</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	return cpy</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+&#47;&#47; accessors for innerTx.</span>
<span class="term-fg32">+func (tx *DepositTx) txType() byte           { return DepositTxType }</span>
<span class="term-fg32">+func (tx *DepositTx) chainID() *big.Int      { return common.Big0 }</span>
<span class="term-fg32">+func (tx *DepositTx) accessList() AccessList { return nil }</span>
<span class="term-fg32">+func (tx *DepositTx) data() []byte           { return tx.Data }</span>
<span class="term-fg32">+func (tx *DepositTx) gas() uint64            { return tx.Gas }</span>
<span class="term-fg32">+func (tx *DepositTx) gasFeeCap() *big.Int    { return new(big.Int) }</span>
<span class="term-fg32">+func (tx *DepositTx) gasTipCap() *big.Int    { return new(big.Int) }</span>
<span class="term-fg32">+func (tx *DepositTx) gasPrice() *big.Int     { return new(big.Int) }</span>
<span class="term-fg32">+func (tx *DepositTx) value() *big.Int        { return tx.Value }</span>
<span class="term-fg32">+func (tx *DepositTx) nonce() uint64          { return 0 }</span>
<span class="term-fg32">+func (tx *DepositTx) to() *common.Address    { return tx.To }</span>
<span class="term-fg32">+func (tx *DepositTx) isSystemTx() bool       { return tx.IsSystemTransaction }</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func (tx *DepositTx) effectiveGasPrice(dst *big.Int, baseFee *big.Int) *big.Int {</span>
<span class="term-fg32">+	return dst.Set(new(big.Int))</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func (tx *DepositTx) effectiveNonce() *uint64 { return nil }</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func (tx *DepositTx) rawSignatureValues() (v, r, s *big.Int) {</span>
<span class="term-fg32">+	return common.Big0, common.Big0, common.Big0</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func (tx *DepositTx) setSignatureValues(chainID, v, r, s *big.Int) {</span>
<span class="term-fg32">+	&#47;&#47; this is a noop for deposit transactions</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func (tx *DepositTx) encode(b *bytes.Buffer) error {</span>
<span class="term-fg32">+	return rlp.Encode(b, tx)</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func (tx *DepositTx) decode(input []byte) error {</span>
<span class="term-fg32">+	return rlp.DecodeBytes(input, tx)</span>
<span class="term-fg32">+}</span></div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-2f4d99890f0468b60fca1b69" role="button"
                   aria-expanded="false" aria-controls="id-2f4d99890f0468b60fca1b69">
                    <code>core/types/transaction_marshalling.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/3f40e65c484486dea6cff80b7db178985d21a2c6/core/types/transaction_marshalling.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/650bb2f2b1dcfe30d9b1fa6f7dc9608055ed60e1/core/types/transaction_marshalling.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+80</span></div>
                        <div class="text-start"><span class="text-danger">-0</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-2f4d99890f0468b60fca1b69"><span class="term-fg1">diff --git go-ethereum&#47;core&#47;types&#47;transaction_marshalling.go op-geth&#47;core&#47;types&#47;transaction_marshalling.go</span>
<span class="term-fg1">index e5d71a85d6b1c693ea7efe5235c554d8a4829f89..b15ac26c5da9f21945b4d0d44d46f15a93195d74 100644</span>
<span class="term-fg1">--- go-ethereum&#47;core&#47;types&#47;transaction_marshalling.go</span>
<span class="term-fg1">+++ op-geth&#47;core&#47;types&#47;transaction_marshalling.go</span>
<span class="term-fg36">@@ -19,10 +19,12 @@</span>
 import (
 	&quot;encoding&#47;json&quot;
 	&quot;errors&quot;
<span class="term-fg32">+	&quot;io&quot;</span>
 	&quot;math&#47;big&quot;
&nbsp;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;common&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;common&#47;hexutil&quot;
<span class="term-fg32">+	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;rlp&quot;</span>
 	&quot;github.com&#47;holiman&#47;uint256&quot;
 )
&nbsp;
<span class="term-fg36">@@ -46,6 +48,12 @@</span> 	V                    *hexutil.Big    `json:&quot;v&quot;`
 	R                    *hexutil.Big    `json:&quot;r&quot;`
 	S                    *hexutil.Big    `json:&quot;s&quot;`
 	YParity              *hexutil.Uint64 `json:&quot;yParity,omitempty&quot;`
<span class="term-fg32">+</span>
<span class="term-fg32">+	&#47;&#47; Deposit transaction fields</span>
<span class="term-fg32">+	SourceHash *common.Hash    `json:&quot;sourceHash,omitempty&quot;`</span>
<span class="term-fg32">+	From       *common.Address `json:&quot;from,omitempty&quot;`</span>
<span class="term-fg32">+	Mint       *hexutil.Big    `json:&quot;mint,omitempty&quot;`</span>
<span class="term-fg32">+	IsSystemTx *bool           `json:&quot;isSystemTx,omitempty&quot;`</span>
&nbsp;
 	&#47;&#47; Only used for encoding:
 	Hash common.Hash `json:&quot;hash&quot;`
<span class="term-fg36">@@ -142,6 +150,18 @@</span> 		enc.R = (*hexutil.Big)(itx.R.ToBig())
 		enc.S = (*hexutil.Big)(itx.S.ToBig())
 		yparity := itx.V.Uint64()
 		enc.YParity = (*hexutil.Uint64)(&amp;yparity)
<span class="term-fg32">+	case *DepositTx:</span>
<span class="term-fg32">+		enc.Gas = (*hexutil.Uint64)(&amp;itx.Gas)</span>
<span class="term-fg32">+		enc.Value = (*hexutil.Big)(itx.Value)</span>
<span class="term-fg32">+		enc.Input = (*hexutil.Bytes)(&amp;itx.Data)</span>
<span class="term-fg32">+		enc.To = tx.To()</span>
<span class="term-fg32">+		enc.SourceHash = &amp;itx.SourceHash</span>
<span class="term-fg32">+		enc.From = &amp;itx.From</span>
<span class="term-fg32">+		if itx.Mint != nil {</span>
<span class="term-fg32">+			enc.Mint = (*hexutil.Big)(itx.Mint)</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+		enc.IsSystemTx = &amp;itx.IsSystemTransaction</span>
<span class="term-fg32">+		&#47;&#47; other fields will show up as null.</span>
 	}
 	return json.Marshal(&amp;enc)
 }
<span class="term-fg36">@@ -404,6 +424,54 @@</span> 				return err
 			}
 		}
&nbsp;
<span class="term-fg32">+	case DepositTxType:</span>
<span class="term-fg32">+		if dec.AccessList != nil || dec.MaxFeePerGas != nil ||</span>
<span class="term-fg32">+			dec.MaxPriorityFeePerGas != nil {</span>
<span class="term-fg32">+			return errors.New(&quot;unexpected field(s) in deposit transaction&quot;)</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+		if dec.GasPrice != nil &amp;&amp; dec.GasPrice.ToInt().Cmp(common.Big0) != 0 {</span>
<span class="term-fg32">+			return errors.New(&quot;deposit transaction GasPrice must be 0&quot;)</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+		if (dec.V != nil &amp;&amp; dec.V.ToInt().Cmp(common.Big0) != 0) ||</span>
<span class="term-fg32">+			(dec.R != nil &amp;&amp; dec.R.ToInt().Cmp(common.Big0) != 0) ||</span>
<span class="term-fg32">+			(dec.S != nil &amp;&amp; dec.S.ToInt().Cmp(common.Big0) != 0) {</span>
<span class="term-fg32">+			return errors.New(&quot;deposit transaction signature must be 0 or unset&quot;)</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+		var itx DepositTx</span>
<span class="term-fg32">+		inner = &amp;itx</span>
<span class="term-fg32">+		if dec.To != nil {</span>
<span class="term-fg32">+			itx.To = dec.To</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+		if dec.Gas == nil {</span>
<span class="term-fg32">+			return errors.New(&quot;missing required field &#39;gas&#39; for txdata&quot;)</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+		itx.Gas = uint64(*dec.Gas)</span>
<span class="term-fg32">+		if dec.Value == nil {</span>
<span class="term-fg32">+			return errors.New(&quot;missing required field &#39;value&#39; in transaction&quot;)</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+		itx.Value = (*big.Int)(dec.Value)</span>
<span class="term-fg32">+		&#47;&#47; mint may be omitted or nil if there is nothing to mint.</span>
<span class="term-fg32">+		itx.Mint = (*big.Int)(dec.Mint)</span>
<span class="term-fg32">+		if dec.Input == nil {</span>
<span class="term-fg32">+			return errors.New(&quot;missing required field &#39;input&#39; in transaction&quot;)</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+		itx.Data = *dec.Input</span>
<span class="term-fg32">+		if dec.From == nil {</span>
<span class="term-fg32">+			return errors.New(&quot;missing required field &#39;from&#39; in transaction&quot;)</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+		itx.From = *dec.From</span>
<span class="term-fg32">+		if dec.SourceHash == nil {</span>
<span class="term-fg32">+			return errors.New(&quot;missing required field &#39;sourceHash&#39; in transaction&quot;)</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+		itx.SourceHash = *dec.SourceHash</span>
<span class="term-fg32">+		&#47;&#47; IsSystemTx may be omitted. Defaults to false.</span>
<span class="term-fg32">+		if dec.IsSystemTx != nil {</span>
<span class="term-fg32">+			itx.IsSystemTransaction = *dec.IsSystemTx</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+		if dec.Nonce != nil {</span>
<span class="term-fg32">+			inner = &amp;depositTxWithNonce{DepositTx: itx, EffectiveNonce: uint64(*dec.Nonce)}</span>
<span class="term-fg32">+		}</span>
 	default:
 		return ErrTxTypeNotSupported
 	}
<span class="term-fg36">@@ -414,3 +482,15 @@</span>
 	&#47;&#47; TODO: check hash here?
 	return nil
 }
<span class="term-fg32">+</span>
<span class="term-fg32">+type depositTxWithNonce struct {</span>
<span class="term-fg32">+	DepositTx</span>
<span class="term-fg32">+	EffectiveNonce uint64</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+&#47;&#47; EncodeRLP ensures that RLP encoding this transaction excludes the nonce. Otherwise, the tx Hash would change</span>
<span class="term-fg32">+func (tx *depositTxWithNonce) EncodeRLP(w io.Writer) error {</span>
<span class="term-fg32">+	return rlp.Encode(w, tx.DepositTx)</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func (tx *depositTxWithNonce) effectiveNonce() *uint64 { return &amp;tx.EffectiveNonce }</span></div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-9b76661078697baa00c315b7" role="button"
                   aria-expanded="false" aria-controls="id-9b76661078697baa00c315b7">
                    <code>core/types/transaction_signing.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/3f40e65c484486dea6cff80b7db178985d21a2c6/core/types/transaction_signing.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/650bb2f2b1dcfe30d9b1fa6f7dc9608055ed60e1/core/types/transaction_signing.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+15</span></div>
                        <div class="text-start"><span class="text-danger">-1</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-9b76661078697baa00c315b7"><span class="term-fg1">diff --git go-ethereum&#47;core&#47;types&#47;transaction_signing.go op-geth&#47;core&#47;types&#47;transaction_signing.go</span>
<span class="term-fg1">index cd57effcb124f26f7a22b8f6ca3beb15591e88ad..f0fb643cadb1fa53c84e5147ccb69e3019b776c0 100644</span>
<span class="term-fg1">--- go-ethereum&#47;core&#47;types&#47;transaction_signing.go</span>
<span class="term-fg1">+++ op-geth&#47;core&#47;types&#47;transaction_signing.go</span>
<span class="term-fg36">@@ -57,7 +57,7 @@</span> 	return signer
 }
&nbsp;
 &#47;&#47; LatestSigner returns the &#39;most permissive&#39; Signer available for the given chain
<span class="term-fg31">-&#47;&#47; configuration. Specifically, this enables support of all types of transacrions</span>
<span class="term-fg32">+&#47;&#47; configuration. Specifically, this enables support of all types of transactions</span>
 &#47;&#47; when their respective forks are scheduled to occur at any block number (or time)
 &#47;&#47; in the chain config.
 &#47;&#47;
<span class="term-fg36">@@ -256,6 +256,14 @@</span> 	return londonSigner{eip2930Signer{NewEIP155Signer(chainId)}}
 }
&nbsp;
 func (s londonSigner) Sender(tx *Transaction) (common.Address, error) {
<span class="term-fg32">+	if tx.Type() == DepositTxType {</span>
<span class="term-fg32">+		switch tx.inner.(type) {</span>
<span class="term-fg32">+		case *DepositTx:</span>
<span class="term-fg32">+			return tx.inner.(*DepositTx).From, nil</span>
<span class="term-fg32">+		case *depositTxWithNonce:</span>
<span class="term-fg32">+			return tx.inner.(*depositTxWithNonce).From, nil</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+	}</span>
 	if tx.Type() != DynamicFeeTxType {
 		return s.eip2930Signer.Sender(tx)
 	}
<span class="term-fg36">@@ -275,6 +283,9 @@</span> 	return ok &amp;&amp; x.chainId.Cmp(s.chainId) == 0
 }
&nbsp;
 func (s londonSigner) SignatureValues(tx *Transaction, sig []byte) (R, S, V *big.Int, err error) {
<span class="term-fg32">+	if tx.Type() == DepositTxType {</span>
<span class="term-fg32">+		return nil, nil, nil, fmt.Errorf(&quot;deposits do not have a signature&quot;)</span>
<span class="term-fg32">+	}</span>
 	txdata, ok := tx.inner.(*DynamicFeeTx)
 	if !ok {
 		return s.eip2930Signer.SignatureValues(tx, sig)
<span class="term-fg36">@@ -292,6 +303,9 @@</span>
 &#47;&#47; Hash returns the hash to be signed by the sender.
 &#47;&#47; It does not uniquely identify the transaction.
 func (s londonSigner) Hash(tx *Transaction) common.Hash {
<span class="term-fg32">+	if tx.Type() == DepositTxType {</span>
<span class="term-fg32">+		panic(&quot;deposits cannot be signed and do not have a signing hash&quot;)</span>
<span class="term-fg32">+	}</span>
 	if tx.Type() != DynamicFeeTxType {
 		return s.eip2930Signer.Hash(tx)
 	}</div>
    </div>

            
        </div>
        <div>
            
        </div>
    </div>
</div>

            
                <div class="ps-1 py-2 my-1"><div class="row border-bottom border-1"data-bs-toggle="collapse" data-bs-target="#id-46c37c02f1dd609341108e2f"role="button" aria-expanded="false" aria-controls="id-46c37c02f1dd609341108e2f">
        
            <div class="col-12 col-sm-9 text-start"><h4>Transaction properties</h4></div>
        
        <div class="col-12 col-sm-3 ms-auto mt-2">
            <div class="row line-stat">
                <div class="text-end"><span class="text-success">+85</span></div>
                <div class="text-start"><span class="text-danger">-3</span></div>
            </div>
        </div>
    </div>

    <div class="row forkdef-content collapse  border-1 ps-3 my-3" id="id-46c37c02f1dd609341108e2f">
        <div><p>The <code>Transaction</code> type now exposes the deposit-transaction and L1-cost properties required for the rollup.</p>
</div>
        <div>
            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-231438370c98fb511fe1e20c" role="button"
                   aria-expanded="false" aria-controls="id-231438370c98fb511fe1e20c">
                    <code>core/types/transaction.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/3f40e65c484486dea6cff80b7db178985d21a2c6/core/types/transaction.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/650bb2f2b1dcfe30d9b1fa6f7dc9608055ed60e1/core/types/transaction.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+81</span></div>
                        <div class="text-start"><span class="text-danger">-3</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-231438370c98fb511fe1e20c"><span class="term-fg1">diff --git go-ethereum&#47;core&#47;types&#47;transaction.go op-geth&#47;core&#47;types&#47;transaction.go</span>
<span class="term-fg1">index 78a1b9ba64867394e23200fc68e6dda5ca305ff0..fc00327ea622cf3ce3f2d9de6c85612880fb856b 100644</span>
<span class="term-fg1">--- go-ethereum&#47;core&#47;types&#47;transaction.go</span>
<span class="term-fg1">+++ op-geth&#47;core&#47;types&#47;transaction.go</span>
<span class="term-fg36">@@ -27,6 +27,7 @@</span>
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;common&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;common&#47;math&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;crypto&quot;
<span class="term-fg32">+	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;log&quot;</span>
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;rlp&quot;
 )
&nbsp;
<span class="term-fg36">@@ -56,6 +57,9 @@</span> 	&#47;&#47; caches
 	hash atomic.Value
 	size atomic.Value
 	from atomic.Value
<span class="term-fg32">+</span>
<span class="term-fg32">+	&#47;&#47; cache of RollupGasData details to compute the gas the tx takes on L1 for its share of rollup data</span>
<span class="term-fg32">+	rollupGas atomic.Value</span>
 }
&nbsp;
 &#47;&#47; NewTx creates a new transaction.
<span class="term-fg36">@@ -82,6 +86,7 @@</span> 	gasFeeCap() *big.Int
 	value() *big.Int
 	nonce() uint64
 	to() *common.Address
<span class="term-fg32">+	isSystemTx() bool</span>
&nbsp;
 	rawSignatureValues() (v, r, s *big.Int)
 	setSignatureValues(chainID, v, r, s *big.Int)
<span class="term-fg36">@@ -168,7 +173,7 @@</span> 	}
 }
&nbsp;
 &#47;&#47; UnmarshalBinary decodes the canonical encoding of transactions.
<span class="term-fg31">-&#47;&#47; It supports legacy RLP transactions and EIP2718 typed transactions.</span>
<span class="term-fg32">+&#47;&#47; It supports legacy RLP transactions and EIP-2718 typed transactions.</span>
 func (tx *Transaction) UnmarshalBinary(b []byte) error {
 	if len(b) &gt; 0 &amp;&amp; b[0] &gt; 0x7f {
 		&#47;&#47; It&#39;s a legacy transaction.
<span class="term-fg36">@@ -180,7 +185,7 @@</span> 		}
 		tx.setDecoded(&amp;data, uint64(len(b)))
 		return nil
 	}
<span class="term-fg31">-	&#47;&#47; It&#39;s an EIP2718 typed transaction envelope.</span>
<span class="term-fg32">+	&#47;&#47; It&#39;s an EIP-2718 typed transaction envelope.</span>
 	inner, err := tx.decodeTyped(b)
 	if err != nil {
 		return err
<span class="term-fg36">@@ -202,6 +207,8 @@</span> 	case DynamicFeeTxType:
 		inner = new(DynamicFeeTx)
 	case BlobTxType:
 		inner = new(BlobTx)
<span class="term-fg32">+	case DepositTxType:</span>
<span class="term-fg32">+		inner = new(DepositTx)</span>
 	default:
 		return nil, ErrTxTypeNotSupported
 	}
<span class="term-fg36">@@ -299,12 +306,56 @@</span>
 &#47;&#47; Nonce returns the sender account nonce of the transaction.
 func (tx *Transaction) Nonce() uint64 { return tx.inner.nonce() }
&nbsp;
<span class="term-fg32">+&#47;&#47; EffectiveNonce returns the nonce that was actually used as part of transaction execution</span>
<span class="term-fg32">+&#47;&#47; Returns nil if the effective nonce is not known</span>
<span class="term-fg32">+func (tx *Transaction) EffectiveNonce() *uint64 {</span>
<span class="term-fg32">+	type txWithEffectiveNonce interface {</span>
<span class="term-fg32">+		effectiveNonce() *uint64</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	if itx, ok := tx.inner.(txWithEffectiveNonce); ok {</span>
<span class="term-fg32">+		return itx.effectiveNonce()</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	nonce := tx.inner.nonce()</span>
<span class="term-fg32">+	return &amp;nonce</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
 &#47;&#47; To returns the recipient address of the transaction.
 &#47;&#47; For contract-creation transactions, To returns nil.
 func (tx *Transaction) To() *common.Address {
 	return copyAddressPtr(tx.inner.to())
 }
&nbsp;
<span class="term-fg32">+&#47;&#47; SourceHash returns the hash that uniquely identifies the source of the deposit tx,</span>
<span class="term-fg32">+&#47;&#47; e.g. a user deposit event, or a L1 info deposit included in a specific L2 block height.</span>
<span class="term-fg32">+&#47;&#47; Non-deposit transactions return a zeroed hash.</span>
<span class="term-fg32">+func (tx *Transaction) SourceHash() common.Hash {</span>
<span class="term-fg32">+	if dep, ok := tx.inner.(*DepositTx); ok {</span>
<span class="term-fg32">+		return dep.SourceHash</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	return common.Hash{}</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+&#47;&#47; Mint returns the ETH to mint in the deposit tx.</span>
<span class="term-fg32">+&#47;&#47; This returns nil if there is nothing to mint, or if this is not a deposit tx.</span>
<span class="term-fg32">+func (tx *Transaction) Mint() *big.Int {</span>
<span class="term-fg32">+	if dep, ok := tx.inner.(*DepositTx); ok {</span>
<span class="term-fg32">+		return dep.Mint</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	return nil</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+&#47;&#47; IsDepositTx returns true if the transaction is a deposit tx type.</span>
<span class="term-fg32">+func (tx *Transaction) IsDepositTx() bool {</span>
<span class="term-fg32">+	return tx.Type() == DepositTxType</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+&#47;&#47; IsSystemTx returns true for deposits that are system transactions. These transactions</span>
<span class="term-fg32">+&#47;&#47; are executed in an unmetered environment &amp; do not contribute to the block gas limit.</span>
<span class="term-fg32">+func (tx *Transaction) IsSystemTx() bool {</span>
<span class="term-fg32">+	return tx.inner.isSystemTx()</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
 &#47;&#47; Cost returns (gas * gasPrice) + (blobGas * blobGasPrice) + value.
 func (tx *Transaction) Cost() *big.Int {
 	total := new(big.Int).Mul(tx.GasPrice(), new(big.Int).SetUint64(tx.Gas()))
<span class="term-fg36">@@ -315,6 +366,30 @@</span> 	total.Add(total, tx.Value())
 	return total
 }
&nbsp;
<span class="term-fg32">+&#47;&#47; RollupDataGas is the amount of gas it takes to confirm the tx on L1 as a rollup</span>
<span class="term-fg32">+func (tx *Transaction) RollupDataGas() RollupGasData {</span>
<span class="term-fg32">+	if tx.Type() == DepositTxType {</span>
<span class="term-fg32">+		return RollupGasData{}</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	if v := tx.rollupGas.Load(); v != nil {</span>
<span class="term-fg32">+		return v.(RollupGasData)</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	data, err := tx.MarshalBinary()</span>
<span class="term-fg32">+	if err != nil { &#47;&#47; Silent error, invalid txs will not be marshalled&#47;unmarshalled for batch submission anyway.</span>
<span class="term-fg32">+		log.Error(&quot;failed to encode tx for L1 cost computation&quot;, &quot;err&quot;, err)</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	var out RollupGasData</span>
<span class="term-fg32">+	for _, byt := range data {</span>
<span class="term-fg32">+		if byt == 0 {</span>
<span class="term-fg32">+			out.Zeroes++</span>
<span class="term-fg32">+		} else {</span>
<span class="term-fg32">+			out.Ones++</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	tx.rollupGas.Store(out)</span>
<span class="term-fg32">+	return out</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
 &#47;&#47; RawSignatureValues returns the V, R, S signature values of the transaction.
 &#47;&#47; The return values should not be modified by the caller.
 func (tx *Transaction) RawSignatureValues() (v, r, s *big.Int) {
<span class="term-fg36">@@ -345,6 +420,9 @@</span> &#47;&#47; EffectiveGasTip returns the effective miner gasTipCap for the given base fee.
 &#47;&#47; Note: if the effective gasTipCap is negative, this method returns both error
 &#47;&#47; the actual negative value, _and_ ErrGasFeeCapTooLow
 func (tx *Transaction) EffectiveGasTip(baseFee *big.Int) (*big.Int, error) {
<span class="term-fg32">+	if tx.Type() == DepositTxType {</span>
<span class="term-fg32">+		return new(big.Int), nil</span>
<span class="term-fg32">+	}</span>
 	if baseFee == nil {
 		return tx.GasTipCap(), nil
 	}
<span class="term-fg36">@@ -395,7 +473,7 @@</span> 	}
 	return nil
 }
&nbsp;
<span class="term-fg31">-&#47;&#47; BlobHashes returns the hases of the blob commitments for blob transactions, nil otherwise.</span>
<span class="term-fg32">+&#47;&#47; BlobHashes returns the hashes of the blob commitments for blob transactions, nil otherwise.</span>
 func (tx *Transaction) BlobHashes() []common.Hash {
 	if blobtx, ok := tx.inner.(*BlobTx); ok {
 		return blobtx.BlobHashes</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-17bd7916c3c13adb39d816dc" role="button"
                   aria-expanded="false" aria-controls="id-17bd7916c3c13adb39d816dc">
                    <code>core/types/tx_access_list.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/3f40e65c484486dea6cff80b7db178985d21a2c6/core/types/tx_access_list.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/650bb2f2b1dcfe30d9b1fa6f7dc9608055ed60e1/core/types/tx_access_list.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+1</span></div>
                        <div class="text-start"><span class="text-danger">-0</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-17bd7916c3c13adb39d816dc"><span class="term-fg1">diff --git go-ethereum&#47;core&#47;types&#47;tx_access_list.go op-geth&#47;core&#47;types&#47;tx_access_list.go</span>
<span class="term-fg1">index 730a77b752866afb5e6ba3d7ea8f4a5af6456d00..59880b0eabb182cd889a27b58d6c449187f4701a 100644</span>
<span class="term-fg1">--- go-ethereum&#47;core&#47;types&#47;tx_access_list.go</span>
<span class="term-fg1">+++ op-geth&#47;core&#47;types&#47;tx_access_list.go</span>
<span class="term-fg36">@@ -107,6 +107,7 @@</span> func (tx *AccessListTx) gasFeeCap() *big.Int    { return tx.GasPrice }
 func (tx *AccessListTx) value() *big.Int        { return tx.Value }
 func (tx *AccessListTx) nonce() uint64          { return tx.Nonce }
 func (tx *AccessListTx) to() *common.Address    { return tx.To }
<span class="term-fg32">+func (tx *AccessListTx) isSystemTx() bool       { return false }</span>
&nbsp;
 func (tx *AccessListTx) effectiveGasPrice(dst *big.Int, baseFee *big.Int) *big.Int {
 	return dst.Set(tx.GasPrice)</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-1a52cb259525357e791c2a9c" role="button"
                   aria-expanded="false" aria-controls="id-1a52cb259525357e791c2a9c">
                    <code>core/types/tx_dynamic_fee.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/3f40e65c484486dea6cff80b7db178985d21a2c6/core/types/tx_dynamic_fee.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/650bb2f2b1dcfe30d9b1fa6f7dc9608055ed60e1/core/types/tx_dynamic_fee.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+1</span></div>
                        <div class="text-start"><span class="text-danger">-0</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-1a52cb259525357e791c2a9c"><span class="term-fg1">diff --git go-ethereum&#47;core&#47;types&#47;tx_dynamic_fee.go op-geth&#47;core&#47;types&#47;tx_dynamic_fee.go</span>
<span class="term-fg1">index 8b5b514fdec5b58fc8058e582a0a7c355e0ccba8..9c52cde57754d4826e6d673f297238ce02212657 100644</span>
<span class="term-fg1">--- go-ethereum&#47;core&#47;types&#47;tx_dynamic_fee.go</span>
<span class="term-fg1">+++ op-geth&#47;core&#47;types&#47;tx_dynamic_fee.go</span>
<span class="term-fg36">@@ -96,6 +96,7 @@</span> func (tx *DynamicFeeTx) gasPrice() *big.Int     { return tx.GasFeeCap }
 func (tx *DynamicFeeTx) value() *big.Int        { return tx.Value }
 func (tx *DynamicFeeTx) nonce() uint64          { return tx.Nonce }
 func (tx *DynamicFeeTx) to() *common.Address    { return tx.To }
<span class="term-fg32">+func (tx *DynamicFeeTx) isSystemTx() bool       { return false }</span>
&nbsp;
 func (tx *DynamicFeeTx) effectiveGasPrice(dst *big.Int, baseFee *big.Int) *big.Int {
 	if baseFee == nil {</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-3e4ec5007f07d659bd936ab3" role="button"
                   aria-expanded="false" aria-controls="id-3e4ec5007f07d659bd936ab3">
                    <code>core/types/tx_legacy.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/3f40e65c484486dea6cff80b7db178985d21a2c6/core/types/tx_legacy.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/650bb2f2b1dcfe30d9b1fa6f7dc9608055ed60e1/core/types/tx_legacy.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+1</span></div>
                        <div class="text-start"><span class="text-danger">-0</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-3e4ec5007f07d659bd936ab3"><span class="term-fg1">diff --git go-ethereum&#47;core&#47;types&#47;tx_legacy.go op-geth&#47;core&#47;types&#47;tx_legacy.go</span>
<span class="term-fg1">index 71025b78fc060692c1d034f84b59b4cdc8e6cf65..bcb65c39349a3a1bef78948af48a30a1e14c71ba 100644</span>
<span class="term-fg1">--- go-ethereum&#47;core&#47;types&#47;tx_legacy.go</span>
<span class="term-fg1">+++ op-geth&#47;core&#47;types&#47;tx_legacy.go</span>
<span class="term-fg36">@@ -103,6 +103,7 @@</span> func (tx *LegacyTx) gasFeeCap() *big.Int    { return tx.GasPrice }
 func (tx *LegacyTx) value() *big.Int        { return tx.Value }
 func (tx *LegacyTx) nonce() uint64          { return tx.Nonce }
 func (tx *LegacyTx) to() *common.Address    { return tx.To }
<span class="term-fg32">+func (tx *LegacyTx) isSystemTx() bool       { return false }</span>
&nbsp;
 func (tx *LegacyTx) effectiveGasPrice(dst *big.Int, baseFee *big.Int) *big.Int {
 	return dst.Set(tx.GasPrice)</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-6d17d84c1db55d72ab196b74" role="button"
                   aria-expanded="false" aria-controls="id-6d17d84c1db55d72ab196b74">
                    <code>core/types/tx_blob.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/3f40e65c484486dea6cff80b7db178985d21a2c6/core/types/tx_blob.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/650bb2f2b1dcfe30d9b1fa6f7dc9608055ed60e1/core/types/tx_blob.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+1</span></div>
                        <div class="text-start"><span class="text-danger">-0</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-6d17d84c1db55d72ab196b74"><span class="term-fg1">diff --git go-ethereum&#47;core&#47;types&#47;tx_blob.go op-geth&#47;core&#47;types&#47;tx_blob.go</span>
<span class="term-fg1">index da4a9b72f17aaa1a438e0b89ce591550e76cb8d9..2f135a490e64cce4adc4d7bb91ec5bf64ac45197 100644</span>
<span class="term-fg1">--- go-ethereum&#47;core&#47;types&#47;tx_blob.go</span>
<span class="term-fg1">+++ op-geth&#47;core&#47;types&#47;tx_blob.go</span>
<span class="term-fg36">@@ -161,6 +161,7 @@</span> func (tx *BlobTx) value() *big.Int        { return tx.Value.ToBig() }
 func (tx *BlobTx) nonce() uint64          { return tx.Nonce }
 func (tx *BlobTx) to() *common.Address    { tmp := tx.To; return &amp;tmp }
 func (tx *BlobTx) blobGas() uint64        { return params.BlobTxBlobGasPerBlob * uint64(len(tx.BlobHashes)) }
<span class="term-fg32">+func (tx *BlobTx) isSystemTx() bool       { return false }</span>
&nbsp;
 func (tx *BlobTx) effectiveGasPrice(dst *big.Int, baseFee *big.Int) *big.Int {
 	if baseFee == nil {</div>
    </div>

            
        </div>
        <div>
            
        </div>
    </div>
</div>

            
                <div class="ps-1 py-2 my-1"><div class="row border-bottom border-1"data-bs-toggle="collapse" data-bs-target="#id-a88c9c57128e4c9ee6115914"role="button" aria-expanded="false" aria-controls="id-a88c9c57128e4c9ee6115914">
        
            <div class="col-12 col-sm-9 text-start"><h4>L1 cost computation</h4></div>
        
        <div class="col-12 col-sm-3 ms-auto mt-2">
            <div class="row line-stat">
                <div class="text-end"><span class="text-success">+136</span></div>
                <div class="text-start"><span class="text-danger">-27</span></div>
            </div>
        </div>
    </div>

    <div class="row forkdef-content collapse  border-1 ps-3 my-3" id="id-a88c9c57128e4c9ee6115914">
        <div><p>Transactions must pay an additional L1 cost based on the amount of rollup-data-gas they consume,
estimated based on gas-price-oracle information and encoded tx size.&rdquo;</p>
</div>
        <div>
            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-fafef8adc541c3cce2a36d3e" role="button"
                   aria-expanded="false" aria-controls="id-fafef8adc541c3cce2a36d3e">
                    <code>core/vm/evm.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/3f40e65c484486dea6cff80b7db178985d21a2c6/core/vm/evm.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/650bb2f2b1dcfe30d9b1fa6f7dc9608055ed60e1/core/vm/evm.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+12</span></div>
                        <div class="text-start"><span class="text-danger">-9</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-fafef8adc541c3cce2a36d3e"><span class="term-fg1">diff --git go-ethereum&#47;core&#47;vm&#47;evm.go op-geth&#47;core&#47;vm&#47;evm.go</span>
<span class="term-fg1">index 40e2f3554f4665839c06be647f736e1de143f721..c96fa88176fa0cde20d8a08692f1031a9dedf16f 100644</span>
<span class="term-fg1">--- go-ethereum&#47;core&#47;vm&#47;evm.go</span>
<span class="term-fg1">+++ op-geth&#47;core&#47;vm&#47;evm.go</span>
<span class="term-fg36">@@ -20,11 +20,12 @@</span> import (
 	&quot;math&#47;big&quot;
 	&quot;sync&#47;atomic&quot;
&nbsp;
<span class="term-fg32">+	&quot;github.com&#47;holiman&#47;uint256&quot;</span>
<span class="term-fg32">+</span>
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;common&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;core&#47;types&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;crypto&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;params&quot;
<span class="term-fg31">-	&quot;github.com&#47;holiman&#47;uint256&quot;</span>
 )
&nbsp;
 type (
<span class="term-fg36">@@ -65,16 +66,18 @@</span> 	&#47;&#47; Transfer transfers ether from one account to the other
 	Transfer TransferFunc
 	&#47;&#47; GetHash returns the hash corresponding to n
 	GetHash GetHashFunc
<span class="term-fg32">+	&#47;&#47; L1CostFunc returns the L1 cost of the rollup message, the function may be nil, or return nil</span>
<span class="term-fg32">+	L1CostFunc types.L1CostFunc</span>
&nbsp;
 	&#47;&#47; Block information
<span class="term-fg31">-	Coinbase      common.Address &#47;&#47; Provides information for COINBASE</span>
<span class="term-fg31">-	GasLimit      uint64         &#47;&#47; Provides information for GASLIMIT</span>
<span class="term-fg31">-	BlockNumber   *big.Int       &#47;&#47; Provides information for NUMBER</span>
<span class="term-fg31">-	Time          uint64         &#47;&#47; Provides information for TIME</span>
<span class="term-fg31">-	Difficulty    *big.Int       &#47;&#47; Provides information for DIFFICULTY</span>
<span class="term-fg31">-	BaseFee       *big.Int       &#47;&#47; Provides information for BASEFEE</span>
<span class="term-fg31">-	Random        *common.Hash   &#47;&#47; Provides information for PREVRANDAO</span>
<span class="term-fg31">-	ExcessBlobGas *uint64        &#47;&#47; ExcessBlobGas field in the header, needed to compute the data</span>
<span class="term-fg32">+	Coinbase    common.Address &#47;&#47; Provides information for COINBASE</span>
<span class="term-fg32">+	GasLimit    uint64         &#47;&#47; Provides information for GASLIMIT</span>
<span class="term-fg32">+	BlockNumber *big.Int       &#47;&#47; Provides information for NUMBER</span>
<span class="term-fg32">+	Time        uint64         &#47;&#47; Provides information for TIME</span>
<span class="term-fg32">+	Difficulty  *big.Int       &#47;&#47; Provides information for DIFFICULTY</span>
<span class="term-fg32">+	BaseFee     *big.Int       &#47;&#47; Provides information for BASEFEE</span>
<span class="term-fg32">+	BlobBaseFee *big.Int       &#47;&#47; Provides information for BLOBBASEFEE</span>
<span class="term-fg32">+	Random      *common.Hash   &#47;&#47; Provides information for PREVRANDAO</span>
 }
&nbsp;
 &#47;&#47; TxContext provides the EVM with information about a transaction.</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-fd76e12c0199b6d093eeb303" role="button"
                   aria-expanded="false" aria-controls="id-fd76e12c0199b6d093eeb303">
                    <code>core/evm.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/3f40e65c484486dea6cff80b7db178985d21a2c6/core/evm.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/650bb2f2b1dcfe30d9b1fa6f7dc9608055ed60e1/core/evm.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+19</span></div>
                        <div class="text-start"><span class="text-danger">-12</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-fd76e12c0199b6d093eeb303"><span class="term-fg1">diff --git go-ethereum&#47;core&#47;evm.go op-geth&#47;core&#47;evm.go</span>
<span class="term-fg1">index 104f2c09dc1da27e863a99c3f542da455a9e3c93..32315e297266fb0b60de4acce70333e980ee54f6 100644</span>
<span class="term-fg1">--- go-ethereum&#47;core&#47;evm.go</span>
<span class="term-fg1">+++ op-geth&#47;core&#47;evm.go</span>
<span class="term-fg36">@@ -21,8 +21,10 @@</span> 	&quot;math&#47;big&quot;
&nbsp;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;common&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;consensus&quot;
<span class="term-fg32">+	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;consensus&#47;misc&#47;eip4844&quot;</span>
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;core&#47;types&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;core&#47;vm&quot;
<span class="term-fg32">+	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;params&quot;</span>
 )
&nbsp;
 &#47;&#47; ChainContext supports retrieving headers and consensus parameters from the
<span class="term-fg36">@@ -36,10 +38,11 @@</span> 	GetHeader(common.Hash, uint64) *types.Header
 }
&nbsp;
 &#47;&#47; NewEVMBlockContext creates a new context for use in the EVM.
<span class="term-fg31">-func NewEVMBlockContext(header *types.Header, chain ChainContext, author *common.Address) vm.BlockContext {</span>
<span class="term-fg32">+func NewEVMBlockContext(header *types.Header, chain ChainContext, author *common.Address, config *params.ChainConfig, statedb types.StateGetter) vm.BlockContext {</span>
 	var (
 		beneficiary common.Address
 		baseFee     *big.Int
<span class="term-fg32">+		blobBaseFee *big.Int</span>
 		random      *common.Hash
 	)
&nbsp;
<span class="term-fg36">@@ -51,22 +54,26 @@</span> 		beneficiary = *author
 	}
 	if header.BaseFee != nil {
 		baseFee = new(big.Int).Set(header.BaseFee)
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	if header.ExcessBlobGas != nil {</span>
<span class="term-fg32">+		blobBaseFee = eip4844.CalcBlobFee(*header.ExcessBlobGas)</span>
 	}
 	if header.Difficulty.Cmp(common.Big0) == 0 {
 		random = &amp;header.MixDigest
 	}
 	return vm.BlockContext{
<span class="term-fg31">-		CanTransfer:   CanTransfer,</span>
<span class="term-fg31">-		Transfer:      Transfer,</span>
<span class="term-fg31">-		GetHash:       GetHashFn(header, chain),</span>
<span class="term-fg31">-		Coinbase:      beneficiary,</span>
<span class="term-fg31">-		BlockNumber:   new(big.Int).Set(header.Number),</span>
<span class="term-fg31">-		Time:          header.Time,</span>
<span class="term-fg31">-		Difficulty:    new(big.Int).Set(header.Difficulty),</span>
<span class="term-fg31">-		BaseFee:       baseFee,</span>
<span class="term-fg31">-		GasLimit:      header.GasLimit,</span>
<span class="term-fg31">-		Random:        random,</span>
<span class="term-fg31">-		ExcessBlobGas: header.ExcessBlobGas,</span>
<span class="term-fg32">+		CanTransfer: CanTransfer,</span>
<span class="term-fg32">+		Transfer:    Transfer,</span>
<span class="term-fg32">+		GetHash:     GetHashFn(header, chain),</span>
<span class="term-fg32">+		Coinbase:    beneficiary,</span>
<span class="term-fg32">+		BlockNumber: new(big.Int).Set(header.Number),</span>
<span class="term-fg32">+		Time:        header.Time,</span>
<span class="term-fg32">+		Difficulty:  new(big.Int).Set(header.Difficulty),</span>
<span class="term-fg32">+		BaseFee:     baseFee,</span>
<span class="term-fg32">+		BlobBaseFee: blobBaseFee,</span>
<span class="term-fg32">+		GasLimit:    header.GasLimit,</span>
<span class="term-fg32">+		Random:      random,</span>
<span class="term-fg32">+		L1CostFunc:  types.NewL1CostFunc(config, statedb),</span>
 	}
 }
</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-d3d4cfd9e8d7162d8652f256" role="button"
                   aria-expanded="false" aria-controls="id-d3d4cfd9e8d7162d8652f256">
                    <code>core/types/rollup_l1_cost.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <span class="text-muted">(new)</span>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/650bb2f2b1dcfe30d9b1fa6f7dc9608055ed60e1/core/types/rollup_l1_cost.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+83</span></div>
                        <div class="text-start"><span class="text-danger">-0</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-d3d4cfd9e8d7162d8652f256"><span class="term-fg1">diff --git go-ethereum&#47;core&#47;types&#47;rollup_l1_cost.go op-geth&#47;core&#47;types&#47;rollup_l1_cost.go</span>
<span class="term-fg1">new file mode 100644</span>
<span class="term-fg1">index 0000000000000000000000000000000000000000..521dfc10d7a7f086456cea4d16b2a756a0dbc777</span>
<span class="term-fg1">--- &#47;dev&#47;null</span>
<span class="term-fg1">+++ op-geth&#47;core&#47;types&#47;rollup_l1_cost.go</span>
<span class="term-fg36">@@ -0,0 +1,83 @@</span>
<span class="term-fg32">+&#47;&#47; Copyright 2022 The go-ethereum Authors</span>
<span class="term-fg32">+&#47;&#47; This file is part of the go-ethereum library.</span>
<span class="term-fg32">+&#47;&#47;</span>
<span class="term-fg32">+&#47;&#47; The go-ethereum library is free software: you can redistribute it and&#47;or modify</span>
<span class="term-fg32">+&#47;&#47; it under the terms of the GNU Lesser General Public License as published by</span>
<span class="term-fg32">+&#47;&#47; the Free Software Foundation, either version 3 of the License, or</span>
<span class="term-fg32">+&#47;&#47; (at your option) any later version.</span>
<span class="term-fg32">+&#47;&#47;</span>
<span class="term-fg32">+&#47;&#47; The go-ethereum library is distributed in the hope that it will be useful,</span>
<span class="term-fg32">+&#47;&#47; but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="term-fg32">+&#47;&#47; MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the</span>
<span class="term-fg32">+&#47;&#47; GNU Lesser General Public License for more details.</span>
<span class="term-fg32">+&#47;&#47;</span>
<span class="term-fg32">+&#47;&#47; You should have received a copy of the GNU Lesser General Public License</span>
<span class="term-fg32">+&#47;&#47; along with the go-ethereum library. If not, see &lt;http:&#47;&#47;www.gnu.org&#47;licenses&#47;&gt;.</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+package types</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+import (</span>
<span class="term-fg32">+	&quot;math&#47;big&quot;</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;common&quot;</span>
<span class="term-fg32">+	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;params&quot;</span>
<span class="term-fg32">+)</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+type RollupGasData struct {</span>
<span class="term-fg32">+	Zeroes, Ones uint64</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func (r RollupGasData) DataGas(time uint64, cfg *params.ChainConfig) (gas uint64) {</span>
<span class="term-fg32">+	gas = r.Zeroes * params.TxDataZeroGas</span>
<span class="term-fg32">+	if cfg.IsRegolith(time) {</span>
<span class="term-fg32">+		gas += r.Ones * params.TxDataNonZeroGasEIP2028</span>
<span class="term-fg32">+	} else {</span>
<span class="term-fg32">+		gas += (r.Ones + 68) * params.TxDataNonZeroGasEIP2028</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	return gas</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+type StateGetter interface {</span>
<span class="term-fg32">+	GetState(common.Address, common.Hash) common.Hash</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+&#47;&#47; L1CostFunc is used in the state transition to determine the cost of a rollup message.</span>
<span class="term-fg32">+&#47;&#47; Returns nil if there is no cost.</span>
<span class="term-fg32">+type L1CostFunc func(blockNum uint64, blockTime uint64, dataGas RollupGasData, isDepositTx bool) *big.Int</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+var (</span>
<span class="term-fg32">+	L1BaseFeeSlot = common.BigToHash(big.NewInt(1))</span>
<span class="term-fg32">+	OverheadSlot  = common.BigToHash(big.NewInt(5))</span>
<span class="term-fg32">+	ScalarSlot    = common.BigToHash(big.NewInt(6))</span>
<span class="term-fg32">+)</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+var L1BlockAddr = common.HexToAddress(&quot;0x4200000000000000000000000000000000000015&quot;)</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+&#47;&#47; NewL1CostFunc returns a function used for calculating L1 fee cost.</span>
<span class="term-fg32">+&#47;&#47; This depends on the oracles because gas costs can change over time.</span>
<span class="term-fg32">+&#47;&#47; It returns nil if there is no applicable cost function.</span>
<span class="term-fg32">+func NewL1CostFunc(config *params.ChainConfig, statedb StateGetter) L1CostFunc {</span>
<span class="term-fg32">+	cacheBlockNum := ^uint64(0)</span>
<span class="term-fg32">+	var l1BaseFee, overhead, scalar *big.Int</span>
<span class="term-fg32">+	return func(blockNum uint64, blockTime uint64, dataGas RollupGasData, isDepositTx bool) *big.Int {</span>
<span class="term-fg32">+		rollupDataGas := dataGas.DataGas(blockTime, config) &#47;&#47; Only fake txs for RPC view-calls are 0.</span>
<span class="term-fg32">+		if config.Optimism == nil || isDepositTx || rollupDataGas == 0 {</span>
<span class="term-fg32">+			return nil</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+		if blockNum != cacheBlockNum {</span>
<span class="term-fg32">+			l1BaseFee = statedb.GetState(L1BlockAddr, L1BaseFeeSlot).Big()</span>
<span class="term-fg32">+			overhead = statedb.GetState(L1BlockAddr, OverheadSlot).Big()</span>
<span class="term-fg32">+			scalar = statedb.GetState(L1BlockAddr, ScalarSlot).Big()</span>
<span class="term-fg32">+			cacheBlockNum = blockNum</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+		return L1Cost(rollupDataGas, l1BaseFee, overhead, scalar)</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func L1Cost(rollupDataGas uint64, l1BaseFee, overhead, scalar *big.Int) *big.Int {</span>
<span class="term-fg32">+	l1GasUsed := new(big.Int).SetUint64(rollupDataGas)</span>
<span class="term-fg32">+	l1GasUsed = l1GasUsed.Add(l1GasUsed, overhead)</span>
<span class="term-fg32">+	l1Cost := l1GasUsed.Mul(l1GasUsed, l1BaseFee)</span>
<span class="term-fg32">+	l1Cost = l1Cost.Mul(l1Cost, scalar)</span>
<span class="term-fg32">+	return l1Cost.Div(l1Cost, big.NewInt(1_000_000))</span>
<span class="term-fg32">+}</span></div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-b0418ff2e7aaa6a3d4ac8fda" role="button"
                   aria-expanded="false" aria-controls="id-b0418ff2e7aaa6a3d4ac8fda">
                    <code>core/state_processor.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/3f40e65c484486dea6cff80b7db178985d21a2c6/core/state_processor.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/650bb2f2b1dcfe30d9b1fa6f7dc9608055ed60e1/core/state_processor.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+21</span></div>
                        <div class="text-start"><span class="text-danger">-5</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-b0418ff2e7aaa6a3d4ac8fda"><span class="term-fg1">diff --git go-ethereum&#47;core&#47;state_processor.go op-geth&#47;core&#47;state_processor.go</span>
<span class="term-fg1">index 6a208a1811b29ef99a3d3b7be4874344c1277776..b674731a34eaa87fd08aa75fb0382daa99e57036 100644</span>
<span class="term-fg1">--- go-ethereum&#47;core&#47;state_processor.go</span>
<span class="term-fg1">+++ op-geth&#47;core&#47;state_processor.go</span>
<span class="term-fg36">@@ -24,7 +24,6 @@</span>
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;common&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;consensus&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;consensus&#47;misc&quot;
<span class="term-fg31">-	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;consensus&#47;misc&#47;eip4844&quot;</span>
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;core&#47;state&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;core&#47;types&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;core&#47;vm&quot;
<span class="term-fg36">@@ -72,8 +71,9 @@</span> 	&#47;&#47; Mutate the block and state according to any hard-fork specs
 	if p.config.DAOForkSupport &amp;&amp; p.config.DAOForkBlock != nil &amp;&amp; p.config.DAOForkBlock.Cmp(block.Number()) == 0 {
 		misc.ApplyDAOHardFork(statedb)
 	}
<span class="term-fg32">+	misc.EnsureCreate2Deployer(p.config, block.Time(), statedb)</span>
 	var (
<span class="term-fg31">-		context = NewEVMBlockContext(header, p.bc, nil)</span>
<span class="term-fg32">+		context = NewEVMBlockContext(header, p.bc, nil, p.config, statedb)</span>
 		vmenv   = vm.NewEVM(context, vm.TxContext{}, statedb, p.config, cfg)
 		signer  = types.MakeSigner(p.config, header.Number, header.Time)
 	)
<span class="term-fg36">@@ -110,6 +110,11 @@</span> 	&#47;&#47; Create a new context to be used in the EVM environment.
 	txContext := NewEVMTxContext(msg)
 	evm.Reset(txContext, statedb)
&nbsp;
<span class="term-fg32">+	nonce := tx.Nonce()</span>
<span class="term-fg32">+	if msg.IsDepositTx &amp;&amp; config.IsOptimismRegolith(evm.Context.Time) {</span>
<span class="term-fg32">+		nonce = statedb.GetNonce(msg.From)</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+</span>
 	&#47;&#47; Apply the transaction to the current state (included in the env).
 	result, err := ApplyMessage(evm, msg, gp)
 	if err != nil {
<span class="term-fg36">@@ -136,14 +141,25 @@</span> 	}
 	receipt.TxHash = tx.Hash()
 	receipt.GasUsed = result.UsedGas
&nbsp;
<span class="term-fg32">+	if msg.IsDepositTx &amp;&amp; config.IsOptimismRegolith(evm.Context.Time) {</span>
<span class="term-fg32">+		&#47;&#47; The actual nonce for deposit transactions is only recorded from Regolith onwards and</span>
<span class="term-fg32">+		&#47;&#47; otherwise must be nil.</span>
<span class="term-fg32">+		receipt.DepositNonce = &amp;nonce</span>
<span class="term-fg32">+		&#47;&#47; The DepositReceiptVersion for deposit transactions is only recorded from Canyon onwards</span>
<span class="term-fg32">+		&#47;&#47; and otherwise must be nil.</span>
<span class="term-fg32">+		if config.IsOptimismCanyon(evm.Context.Time) {</span>
<span class="term-fg32">+			receipt.DepositReceiptVersion = new(uint64)</span>
<span class="term-fg32">+			*receipt.DepositReceiptVersion = types.CanyonDepositReceiptVersion</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+	}</span>
 	if tx.Type() == types.BlobTxType {
 		receipt.BlobGasUsed = uint64(len(tx.BlobHashes()) * params.BlobTxBlobGasPerBlob)
<span class="term-fg31">-		receipt.BlobGasPrice = eip4844.CalcBlobFee(*evm.Context.ExcessBlobGas)</span>
<span class="term-fg32">+		receipt.BlobGasPrice = evm.Context.BlobBaseFee</span>
 	}
&nbsp;
 	&#47;&#47; If the transaction created a contract, store the creation address in the receipt.
 	if msg.To == nil {
<span class="term-fg31">-		receipt.ContractAddress = crypto.CreateAddress(evm.TxContext.Origin, tx.Nonce())</span>
<span class="term-fg32">+		receipt.ContractAddress = crypto.CreateAddress(evm.TxContext.Origin, nonce)</span>
 	}
&nbsp;
 	&#47;&#47; Set the receipt logs and create the bloom filter.
<span class="term-fg36">@@ -165,7 +181,7 @@</span> 	if err != nil {
 		return nil, err
 	}
 	&#47;&#47; Create a new context to be used in the EVM environment
<span class="term-fg31">-	blockContext := NewEVMBlockContext(header, bc, author)</span>
<span class="term-fg32">+	blockContext := NewEVMBlockContext(header, bc, author, config, statedb)</span>
 	vmenv := vm.NewEVM(blockContext, vm.TxContext{BlobHashes: tx.BlobHashes()}, statedb, config, cfg)
 	return applyTransaction(msg, config, gp, statedb, header.Number, header.Hash(), tx, usedGas, vmenv)
 }</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-b02bfafd4c015ca4e2d0430a" role="button"
                   aria-expanded="false" aria-controls="id-b02bfafd4c015ca4e2d0430a">
                    <code>core/state_prefetcher.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/3f40e65c484486dea6cff80b7db178985d21a2c6/core/state_prefetcher.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/650bb2f2b1dcfe30d9b1fa6f7dc9608055ed60e1/core/state_prefetcher.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+1</span></div>
                        <div class="text-start"><span class="text-danger">-1</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-b02bfafd4c015ca4e2d0430a"><span class="term-fg1">diff --git go-ethereum&#47;core&#47;state_prefetcher.go op-geth&#47;core&#47;state_prefetcher.go</span>
<span class="term-fg1">index ff867309de302b90dc3e071e97cbe3705d34c970..bb6835202b9758e49611f8da677ddee3edc346f1 100644</span>
<span class="term-fg1">--- go-ethereum&#47;core&#47;state_prefetcher.go</span>
<span class="term-fg1">+++ op-geth&#47;core&#47;state_prefetcher.go</span>
<span class="term-fg36">@@ -51,7 +51,7 @@</span> func (p *statePrefetcher) Prefetch(block *types.Block, statedb *state.StateDB, cfg vm.Config, interrupt *atomic.Bool) {
 	var (
 		header       = block.Header()
 		gaspool      = new(GasPool).AddGas(block.GasLimit())
<span class="term-fg31">-		blockContext = NewEVMBlockContext(header, p.bc, nil)</span>
<span class="term-fg32">+		blockContext = NewEVMBlockContext(header, p.bc, nil, p.config, statedb)</span>
 		evm          = vm.NewEVM(blockContext, vm.TxContext{}, statedb, p.config, cfg)
 		signer       = types.MakeSigner(p.config, header.Number, header.Time)
 	)</div>
    </div>

            
        </div>
        <div>
            
        </div>
    </div>
</div>

            
                <div class="ps-1 py-2 my-1"><div class="row border-bottom border-1"data-bs-toggle="collapse" data-bs-target="#id-61c6e98d1937f0a5c5f1c3bf"role="button" aria-expanded="false" aria-controls="id-61c6e98d1937f0a5c5f1c3bf">
        
            <div class="col-12 col-sm-9 text-start"><h4>Transaction processing</h4></div>
        
        <div class="col-12 col-sm-3 ms-auto mt-2">
            <div class="row line-stat">
                <div class="text-end"><span class="text-success">+112</span></div>
                <div class="text-start"><span class="text-danger">-12</span></div>
            </div>
        </div>
    </div>

    <div class="row forkdef-content collapse  border-1 ps-3 my-3" id="id-61c6e98d1937f0a5c5f1c3bf">
        <div><p>Deposit transactions have special processing rules: gas is pre-paid on L1,
and deposits with EVM-failure are included with rolled back changes (except mint).
For regular transactions, at the end of the transition, the 1559 burn and L1 cost are routed to vaults.</p>
</div>
        <div>
            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-cb7f84a08a02243d40d04ec8" role="button"
                   aria-expanded="false" aria-controls="id-cb7f84a08a02243d40d04ec8">
                    <code>core/state_transition.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/3f40e65c484486dea6cff80b7db178985d21a2c6/core/state_transition.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/650bb2f2b1dcfe30d9b1fa6f7dc9608055ed60e1/core/state_transition.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+112</span></div>
                        <div class="text-start"><span class="text-danger">-12</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-cb7f84a08a02243d40d04ec8"><span class="term-fg1">diff --git go-ethereum&#47;core&#47;state_transition.go op-geth&#47;core&#47;state_transition.go</span>
<span class="term-fg1">index f84757be781fba4beec4d64c5fa832c259a80a3e..f4a8e44e724fdfc988398fe750542a5e457a5640 100644</span>
<span class="term-fg1">--- go-ethereum&#47;core&#47;state_transition.go</span>
<span class="term-fg1">+++ op-geth&#47;core&#47;state_transition.go</span>
<span class="term-fg36">@@ -24,7 +24,6 @@</span> 	&quot;math&#47;big&quot;
&nbsp;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;common&quot;
 	cmath &quot;github.com&#47;ethereum&#47;go-ethereum&#47;common&#47;math&quot;
<span class="term-fg31">-	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;consensus&#47;misc&#47;eip4844&quot;</span>
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;core&#47;types&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;core&#47;vm&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;params&quot;
<span class="term-fg36">@@ -144,20 +143,30 @@</span> 	&#47;&#47; When SkipAccountChecks is true, the message nonce is not checked against the
 	&#47;&#47; account nonce in state. It also disables checking that the sender is an EOA.
 	&#47;&#47; This field will be set to true for operations like RPC eth_call.
 	SkipAccountChecks bool
<span class="term-fg32">+</span>
<span class="term-fg32">+	IsSystemTx    bool                &#47;&#47; IsSystemTx indicates the message, if also a deposit, does not emit gas usage.</span>
<span class="term-fg32">+	IsDepositTx   bool                &#47;&#47; IsDepositTx indicates the message is force-included and can persist a mint.</span>
<span class="term-fg32">+	Mint          *big.Int            &#47;&#47; Mint is the amount to mint before EVM processing, or nil if there is no minting.</span>
<span class="term-fg32">+	RollupDataGas types.RollupGasData &#47;&#47; RollupDataGas indicates the rollup cost of the message, 0 if not a rollup or no cost.</span>
 }
&nbsp;
 &#47;&#47; TransactionToMessage converts a transaction into a Message.
 func TransactionToMessage(tx *types.Transaction, s types.Signer, baseFee *big.Int) (*Message, error) {
 	msg := &amp;Message{
<span class="term-fg31">-		Nonce:             tx.Nonce(),</span>
<span class="term-fg31">-		GasLimit:          tx.Gas(),</span>
<span class="term-fg31">-		GasPrice:          new(big.Int).Set(tx.GasPrice()),</span>
<span class="term-fg31">-		GasFeeCap:         new(big.Int).Set(tx.GasFeeCap()),</span>
<span class="term-fg31">-		GasTipCap:         new(big.Int).Set(tx.GasTipCap()),</span>
<span class="term-fg31">-		To:                tx.To(),</span>
<span class="term-fg31">-		Value:             tx.Value(),</span>
<span class="term-fg31">-		Data:              tx.Data(),</span>
<span class="term-fg31">-		AccessList:        tx.AccessList(),</span>
<span class="term-fg32">+		Nonce:         tx.Nonce(),</span>
<span class="term-fg32">+		GasLimit:      tx.Gas(),</span>
<span class="term-fg32">+		GasPrice:      new(big.Int).Set(tx.GasPrice()),</span>
<span class="term-fg32">+		GasFeeCap:     new(big.Int).Set(tx.GasFeeCap()),</span>
<span class="term-fg32">+		GasTipCap:     new(big.Int).Set(tx.GasTipCap()),</span>
<span class="term-fg32">+		To:            tx.To(),</span>
<span class="term-fg32">+		Value:         tx.Value(),</span>
<span class="term-fg32">+		Data:          tx.Data(),</span>
<span class="term-fg32">+		AccessList:    tx.AccessList(),</span>
<span class="term-fg32">+		IsSystemTx:    tx.IsSystemTx(),</span>
<span class="term-fg32">+		IsDepositTx:   tx.IsDepositTx(),</span>
<span class="term-fg32">+		Mint:          tx.Mint(),</span>
<span class="term-fg32">+		RollupDataGas: tx.RollupDataGas(),</span>
<span class="term-fg32">+</span>
 		SkipAccountChecks: false,
 		BlobHashes:        tx.BlobHashes(),
 		BlobGasFeeCap:     tx.BlobGasFeeCap(),
<span class="term-fg36">@@ -234,11 +243,21 @@</span>
 func (st *StateTransition) buyGas() error {
 	mgval := new(big.Int).SetUint64(st.msg.GasLimit)
 	mgval = mgval.Mul(mgval, st.msg.GasPrice)
<span class="term-fg32">+	var l1Cost *big.Int</span>
<span class="term-fg32">+	if st.evm.Context.L1CostFunc != nil &amp;&amp; !st.msg.SkipAccountChecks {</span>
<span class="term-fg32">+		l1Cost = st.evm.Context.L1CostFunc(st.evm.Context.BlockNumber.Uint64(), st.evm.Context.Time, st.msg.RollupDataGas, st.msg.IsDepositTx)</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	if l1Cost != nil {</span>
<span class="term-fg32">+		mgval = mgval.Add(mgval, l1Cost)</span>
<span class="term-fg32">+	}</span>
 	balanceCheck := new(big.Int).Set(mgval)
 	if st.msg.GasFeeCap != nil {
 		balanceCheck.SetUint64(st.msg.GasLimit)
 		balanceCheck = balanceCheck.Mul(balanceCheck, st.msg.GasFeeCap)
 		balanceCheck.Add(balanceCheck, st.msg.Value)
<span class="term-fg32">+		if l1Cost != nil {</span>
<span class="term-fg32">+			balanceCheck.Add(balanceCheck, l1Cost)</span>
<span class="term-fg32">+		}</span>
 	}
 	if st.evm.ChainConfig().IsCancun(st.evm.Context.BlockNumber, st.evm.Context.Time) {
 		if blobGas := st.blobGasUsed(); blobGas &gt; 0 {
<span class="term-fg36">@@ -248,7 +267,7 @@</span> 			blobBalanceCheck.Mul(blobBalanceCheck, st.msg.BlobGasFeeCap)
 			balanceCheck.Add(balanceCheck, blobBalanceCheck)
 			&#47;&#47; Pay for blobGasUsed * actual blob fee
 			blobFee := new(big.Int).SetUint64(blobGas)
<span class="term-fg31">-			blobFee.Mul(blobFee, eip4844.CalcBlobFee(*st.evm.Context.ExcessBlobGas))</span>
<span class="term-fg32">+			blobFee.Mul(blobFee, st.evm.Context.BlobBaseFee)</span>
 			mgval.Add(mgval, blobFee)
 		}
 	}
<span class="term-fg36">@@ -266,6 +285,21 @@</span> 	return nil
 }
&nbsp;
 func (st *StateTransition) preCheck() error {
<span class="term-fg32">+	if st.msg.IsDepositTx {</span>
<span class="term-fg32">+		&#47;&#47; No fee fields to check, no nonce to check, and no need to check if EOA (L1 already verified it for us)</span>
<span class="term-fg32">+		&#47;&#47; Gas is free, but no refunds!</span>
<span class="term-fg32">+		st.initialGas = st.msg.GasLimit</span>
<span class="term-fg32">+		st.gasRemaining += st.msg.GasLimit &#47;&#47; Add gas here in order to be able to execute calls.</span>
<span class="term-fg32">+		&#47;&#47; Don&#39;t touch the gas pool for system transactions</span>
<span class="term-fg32">+		if st.msg.IsSystemTx {</span>
<span class="term-fg32">+			if st.evm.ChainConfig().IsOptimismRegolith(st.evm.Context.Time) {</span>
<span class="term-fg32">+				return fmt.Errorf(&quot;%w: address %v&quot;, ErrSystemTxNotSupported,</span>
<span class="term-fg32">+					st.msg.From.Hex())</span>
<span class="term-fg32">+			}</span>
<span class="term-fg32">+			return nil</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+		return st.gp.SubGas(st.msg.GasLimit) &#47;&#47; gas used by deposits may not be used by other txs</span>
<span class="term-fg32">+	}</span>
 	&#47;&#47; Only check transactions that are not fake
 	msg := st.msg
 	if !msg.SkipAccountChecks {
<span class="term-fg36">@@ -329,7 +363,7 @@</span>
 	if st.evm.ChainConfig().IsCancun(st.evm.Context.BlockNumber, st.evm.Context.Time) {
 		if st.blobGasUsed() &gt; 0 {
 			&#47;&#47; Check that the user is paying at least the current blob fee
<span class="term-fg31">-			blobFee := eip4844.CalcBlobFee(*st.evm.Context.ExcessBlobGas)</span>
<span class="term-fg32">+			blobFee := st.evm.Context.BlobBaseFee</span>
 			if st.msg.BlobGasFeeCap.Cmp(blobFee) &lt; 0 {
 				return fmt.Errorf(&quot;%w: address %v have %v want %v&quot;, ErrBlobFeeCapTooLow, st.msg.From.Hex(), st.msg.BlobGasFeeCap, blobFee)
 			}
<span class="term-fg36">@@ -350,6 +384,37 @@</span> &#47;&#47;
 &#47;&#47; However if any consensus issue encountered, return the error directly with
 &#47;&#47; nil evm execution result.
 func (st *StateTransition) TransitionDb() (*ExecutionResult, error) {
<span class="term-fg32">+	if mint := st.msg.Mint; mint != nil {</span>
<span class="term-fg32">+		st.state.AddBalance(st.msg.From, mint)</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	snap := st.state.Snapshot()</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	result, err := st.innerTransitionDb()</span>
<span class="term-fg32">+	&#47;&#47; Failed deposits must still be included. Unless we cannot produce the block at all due to the gas limit.</span>
<span class="term-fg32">+	&#47;&#47; On deposit failure, we rewind any state changes from after the minting, and increment the nonce.</span>
<span class="term-fg32">+	if err != nil &amp;&amp; err != ErrGasLimitReached &amp;&amp; st.msg.IsDepositTx {</span>
<span class="term-fg32">+		st.state.RevertToSnapshot(snap)</span>
<span class="term-fg32">+		&#47;&#47; Even though we revert the state changes, always increment the nonce for the next deposit transaction</span>
<span class="term-fg32">+		st.state.SetNonce(st.msg.From, st.state.GetNonce(st.msg.From)+1)</span>
<span class="term-fg32">+		&#47;&#47; Record deposits as using all their gas (matches the gas pool)</span>
<span class="term-fg32">+		&#47;&#47; System Transactions are special &amp; are not recorded as using any gas (anywhere)</span>
<span class="term-fg32">+		&#47;&#47; Regolith changes this behaviour so the actual gas used is reported.</span>
<span class="term-fg32">+		&#47;&#47; In this case the tx is invalid so is recorded as using all gas.</span>
<span class="term-fg32">+		gasUsed := st.msg.GasLimit</span>
<span class="term-fg32">+		if st.msg.IsSystemTx &amp;&amp; !st.evm.ChainConfig().IsRegolith(st.evm.Context.Time) {</span>
<span class="term-fg32">+			gasUsed = 0</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+		result = &amp;ExecutionResult{</span>
<span class="term-fg32">+			UsedGas:    gasUsed,</span>
<span class="term-fg32">+			Err:        fmt.Errorf(&quot;failed deposit: %w&quot;, err),</span>
<span class="term-fg32">+			ReturnData: nil,</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+		err = nil</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	return result, err</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func (st *StateTransition) innerTransitionDb() (*ExecutionResult, error) {</span>
 	&#47;&#47; First check this message satisfies all consensus rules before
 	&#47;&#47; applying the message. The rules include these clauses
 	&#47;&#47;
<span class="term-fg36">@@ -416,6 +481,24 @@</span> 		st.state.SetNonce(msg.From, st.state.GetNonce(sender.Address())+1)
 		ret, st.gasRemaining, vmerr = st.evm.Call(sender, st.to(), msg.Data, st.gasRemaining, msg.Value)
 	}
&nbsp;
<span class="term-fg32">+	&#47;&#47; if deposit: skip refunds, skip tipping coinbase</span>
<span class="term-fg32">+	&#47;&#47; Regolith changes this behaviour to report the actual gasUsed instead of always reporting all gas used.</span>
<span class="term-fg32">+	if st.msg.IsDepositTx &amp;&amp; !rules.IsOptimismRegolith {</span>
<span class="term-fg32">+		&#47;&#47; Record deposits as using all their gas (matches the gas pool)</span>
<span class="term-fg32">+		&#47;&#47; System Transactions are special &amp; are not recorded as using any gas (anywhere)</span>
<span class="term-fg32">+		gasUsed := st.msg.GasLimit</span>
<span class="term-fg32">+		if st.msg.IsSystemTx {</span>
<span class="term-fg32">+			gasUsed = 0</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+		return &amp;ExecutionResult{</span>
<span class="term-fg32">+			UsedGas:    gasUsed,</span>
<span class="term-fg32">+			Err:        vmerr,</span>
<span class="term-fg32">+			ReturnData: ret,</span>
<span class="term-fg32">+		}, nil</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	&#47;&#47; Note for deposit tx there is no ETH refunded for unused gas, but that&#39;s taken care of by the fact that gasPrice</span>
<span class="term-fg32">+	&#47;&#47; is always 0 for deposit tx. So calling refundGas will ensure the gasUsed accounting is correct without actually</span>
<span class="term-fg32">+	&#47;&#47; changing the sender&#39;s balance</span>
 	if !rules.IsLondon {
 		&#47;&#47; Before EIP-3529: refunds were capped to gasUsed &#47; 2
 		st.refundGas(params.RefundQuotient)
<span class="term-fg36">@@ -423,6 +506,14 @@</span> 	} else {
 		&#47;&#47; After EIP-3529: refunds are capped to gasUsed &#47; 5
 		st.refundGas(params.RefundQuotientEIP3529)
 	}
<span class="term-fg32">+	if st.msg.IsDepositTx &amp;&amp; rules.IsOptimismRegolith {</span>
<span class="term-fg32">+		&#47;&#47; Skip coinbase payments for deposit tx in Regolith</span>
<span class="term-fg32">+		return &amp;ExecutionResult{</span>
<span class="term-fg32">+			UsedGas:    st.gasUsed(),</span>
<span class="term-fg32">+			Err:        vmerr,</span>
<span class="term-fg32">+			ReturnData: ret,</span>
<span class="term-fg32">+		}, nil</span>
<span class="term-fg32">+	}</span>
 	effectiveTip := msg.GasPrice
 	if rules.IsLondon {
 		effectiveTip = cmath.BigMin(msg.GasTipCap, new(big.Int).Sub(msg.GasFeeCap, st.evm.Context.BaseFee))
<span class="term-fg36">@@ -436,6 +527,15 @@</span> 	} else {
 		fee := new(big.Int).SetUint64(st.gasUsed())
 		fee.Mul(fee, effectiveTip)
 		st.state.AddBalance(st.evm.Context.Coinbase, fee)
<span class="term-fg32">+	}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	&#47;&#47; Check that we are post bedrock to enable op-geth to be able to create pseudo pre-bedrock blocks (these are pre-bedrock, but don&#39;t follow l2 geth rules)</span>
<span class="term-fg32">+	&#47;&#47; Note optimismConfig will not be nil if rules.IsOptimismBedrock is true</span>
<span class="term-fg32">+	if optimismConfig := st.evm.ChainConfig().Optimism; optimismConfig != nil &amp;&amp; rules.IsOptimismBedrock {</span>
<span class="term-fg32">+		st.state.AddBalance(params.OptimismBaseFeeRecipient, new(big.Int).Mul(new(big.Int).SetUint64(st.gasUsed()), st.evm.Context.BaseFee))</span>
<span class="term-fg32">+		if cost := st.evm.Context.L1CostFunc(st.evm.Context.BlockNumber.Uint64(), st.evm.Context.Time, st.msg.RollupDataGas, st.msg.IsDepositTx); cost != nil {</span>
<span class="term-fg32">+			st.state.AddBalance(params.OptimismL1FeeRecipient, cost)</span>
<span class="term-fg32">+		}</span>
 	}
&nbsp;
 	return &amp;ExecutionResult{</div>
    </div>

            
        </div>
        <div>
            
        </div>
    </div>
</div>

            
                <div class="ps-1 py-2 my-1"><div class="row border-bottom border-1"data-bs-toggle="collapse" data-bs-target="#id-94ead981f0f3fbf71f31d819"role="button" aria-expanded="false" aria-controls="id-94ead981f0f3fbf71f31d819">
        
            <div class="col-12 col-sm-9 text-start"><h4>Core Error definitions</h4></div>
        
        <div class="col-12 col-sm-3 ms-auto mt-2">
            <div class="row line-stat">
                <div class="text-end"><span class="text-success">+3</span></div>
                <div class="text-start"><span class="text-danger">-0</span></div>
            </div>
        </div>
    </div>

    <div class="row forkdef-content collapse  border-1 ps-3 my-3" id="id-94ead981f0f3fbf71f31d819">
        <div></div>
        <div>
            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-5f45b9ae04655da64c96d6db" role="button"
                   aria-expanded="false" aria-controls="id-5f45b9ae04655da64c96d6db">
                    <code>core/error.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/3f40e65c484486dea6cff80b7db178985d21a2c6/core/error.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/650bb2f2b1dcfe30d9b1fa6f7dc9608055ed60e1/core/error.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+3</span></div>
                        <div class="text-start"><span class="text-danger">-0</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-5f45b9ae04655da64c96d6db"><span class="term-fg1">diff --git go-ethereum&#47;core&#47;error.go op-geth&#47;core&#47;error.go</span>
<span class="term-fg1">index 4214ed207a91cedc38b5c4bd731d178a106d4945..43f25106807856df23218623a57220c0006df4e8 100644</span>
<span class="term-fg1">--- go-ethereum&#47;core&#47;error.go</span>
<span class="term-fg1">+++ op-geth&#47;core&#47;error.go</span>
<span class="term-fg36">@@ -104,4 +104,7 @@</span>
 	&#47;&#47; ErrBlobFeeCapTooLow is returned if the transaction fee cap is less than the
 	&#47;&#47; blob gas fee of the block.
 	ErrBlobFeeCapTooLow = errors.New(&quot;max fee per blob gas less than block blob gas fee&quot;)
<span class="term-fg32">+</span>
<span class="term-fg32">+	&#47;&#47; ErrSystemTxNotSupported is returned for any deposit tx with IsSystemTx=true after the Regolith fork</span>
<span class="term-fg32">+	ErrSystemTxNotSupported = errors.New(&quot;system tx not supported&quot;)</span>
 )</div>
    </div>

            
        </div>
        <div>
            
        </div>
    </div>
</div>

            
                <div class="ps-1 py-2 my-1"><div class="row border-bottom border-1"data-bs-toggle="collapse" data-bs-target="#id-7b0eb38dd5438c380c66c258"role="button" aria-expanded="false" aria-controls="id-7b0eb38dd5438c380c66c258">
        
            <div class="col-12 col-sm-9 text-start"><h4>Gaslimit</h4></div>
        
        <div class="col-12 col-sm-3 ms-auto mt-2">
            <div class="row line-stat">
                <div class="text-end"><span class="text-success">+4</span></div>
                <div class="text-start"><span class="text-danger">-2</span></div>
            </div>
        </div>
    </div>

    <div class="row forkdef-content collapse  border-1 ps-3 my-3" id="id-7b0eb38dd5438c380c66c258">
        <div><p>The gaslimit is free to be set by the Engine API caller, instead of enforcing adjustments of the
gaslimit in increments of <sup>1</sup>&frasl;<sub>1024</sub> of the previous gaslimit.
The gaslimit is changed (and limited) through the <code>SystemConfig</code> contract.</p>
</div>
        <div>
            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-ea5acf67bfb361dab0a113fc" role="button"
                   aria-expanded="false" aria-controls="id-ea5acf67bfb361dab0a113fc">
                    <code>consensus/misc/eip1559/eip1559.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/3f40e65c484486dea6cff80b7db178985d21a2c6/consensus/misc/eip1559/eip1559.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/650bb2f2b1dcfe30d9b1fa6f7dc9608055ed60e1/consensus/misc/eip1559/eip1559.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+4</span></div>
                        <div class="text-start"><span class="text-danger">-2</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-ea5acf67bfb361dab0a113fc"><span class="term-fg1">diff --git go-ethereum&#47;consensus&#47;misc&#47;eip1559&#47;eip1559.go op-geth&#47;consensus&#47;misc&#47;eip1559&#47;eip1559.go</span>
<span class="term-fg1">index 84b82c4c492ec1351da2129b51b99fc50d3c6b28..5e5d8a7e3f74f54e10cfc15b99c30367a6faaba9 100644</span>
<span class="term-fg1">--- go-ethereum&#47;consensus&#47;misc&#47;eip1559&#47;eip1559.go</span>
<span class="term-fg1">+++ op-geth&#47;consensus&#47;misc&#47;eip1559&#47;eip1559.go</span>
<span class="term-fg36">@@ -37,8 +37,10 @@</span> 	parentGasLimit := parent.GasLimit
 	if !config.IsLondon(parent.Number) {
 		parentGasLimit = parent.GasLimit * config.ElasticityMultiplier()
 	}
<span class="term-fg31">-	if err := misc.VerifyGaslimit(parentGasLimit, header.GasLimit); err != nil {</span>
<span class="term-fg31">-		return err</span>
<span class="term-fg32">+	if config.Optimism == nil { &#47;&#47; gasLimit can adjust instantly in optimism</span>
<span class="term-fg32">+		if err := misc.VerifyGaslimit(parentGasLimit, header.GasLimit); err != nil {</span>
<span class="term-fg32">+			return err</span>
<span class="term-fg32">+		}</span>
 	}
 	&#47;&#47; Verify the header is not malformed
 	if header.BaseFee == nil {</div>
    </div>

            
        </div>
        <div>
            
        </div>
    </div>
</div>

            
                <div class="ps-1 py-2 my-1"><div class="row border-bottom border-1"data-bs-toggle="collapse" data-bs-target="#id-293a8d7eaa2121b773b20c0e"role="button" aria-expanded="false" aria-controls="id-293a8d7eaa2121b773b20c0e">
        
            <div class="col-12 col-sm-9 text-start"><h4>Consensus tweaks</h4></div>
        
        <div class="col-12 col-sm-3 ms-auto mt-2">
            <div class="row line-stat">
                <div class="text-end"><span class="text-success">+3</span></div>
                <div class="text-start"><span class="text-danger">-0</span></div>
            </div>
        </div>
    </div>

    <div class="row forkdef-content collapse  border-1 ps-3 my-3" id="id-293a8d7eaa2121b773b20c0e">
        <div><p>The Engine API is activated at the Merge transition, with a Total Terminal Difficulty (TTD).
The rollup starts post-merge, and thus sets the TTD to 0.</p>
</div>
        <div>
            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-5f0c50821c6abf6e9f151e89" role="button"
                   aria-expanded="false" aria-controls="id-5f0c50821c6abf6e9f151e89">
                    <code>consensus/beacon/consensus.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/3f40e65c484486dea6cff80b7db178985d21a2c6/consensus/beacon/consensus.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/650bb2f2b1dcfe30d9b1fa6f7dc9608055ed60e1/consensus/beacon/consensus.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+3</span></div>
                        <div class="text-start"><span class="text-danger">-0</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-5f0c50821c6abf6e9f151e89"><span class="term-fg1">diff --git go-ethereum&#47;consensus&#47;beacon&#47;consensus.go op-geth&#47;consensus&#47;beacon&#47;consensus.go</span>
<span class="term-fg1">index e856f4e6ceadb62947b39d7858e4b44282a6fd22..a7d0e58161a3465cf4a3ccad71c1f376067d3616 100644</span>
<span class="term-fg1">--- go-ethereum&#47;consensus&#47;beacon&#47;consensus.go</span>
<span class="term-fg1">+++ op-geth&#47;consensus&#47;beacon&#47;consensus.go</span>
<span class="term-fg36">@@ -464,6 +464,9 @@</span> func IsTTDReached(chain consensus.ChainHeaderReader, parentHash common.Hash, parentNumber uint64) (bool, error) {
 	if chain.Config().TerminalTotalDifficulty == nil {
 		return false, nil
 	}
<span class="term-fg32">+	if common.Big0.Cmp(chain.Config().TerminalTotalDifficulty) == 0 { &#47;&#47; in case TTD is reached at genesis.</span>
<span class="term-fg32">+		return true, nil</span>
<span class="term-fg32">+	}</span>
 	td := chain.GetTd(parentHash, parentNumber)
 	if td == nil {
 		return false, consensus.ErrUnknownAncestor</div>
    </div>

            
        </div>
        <div>
            
        </div>
    </div>
</div>

            
        </div>
    </div>
</div>

            
                <div class="ps-1 py-2 my-1"><div class="row border-bottom border-1"data-bs-toggle="collapse" data-bs-target="#id-5fde78eb6a52bd6522263f48"role="button" aria-expanded="false" aria-controls="id-5fde78eb6a52bd6522263f48">
        
            <div class="col-12 col-sm-9 text-start"><h3>Engine API modifications</h3></div>
        
        <div class="col-12 col-sm-3 ms-auto mt-2">
            <div class="row line-stat">
                <div class="text-end"><span class="text-success">+67</span></div>
                <div class="text-start"><span class="text-danger">-12</span></div>
            </div>
        </div>
    </div>

    <div class="row forkdef-content collapse  border-1 ps-3 my-3" id="id-5fde78eb6a52bd6522263f48">
        <div><p>The Engine API is extended to insert transactions into the block and optionally exclude the tx-pool,
to reproduce the exact block of the sequencer from just the inputs, as derived from L1 by the rollup-node.
See <a href="https://github.com/ethereum-optimism/optimism/blob/develop/specs/exec-engine.md">L2 execution engine specs</a>.</p>
</div>
        <div>
            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-599d6da5ffcebc8b8aa2294b" role="button"
                   aria-expanded="false" aria-controls="id-599d6da5ffcebc8b8aa2294b">
                    <code>beacon/engine/types.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/3f40e65c484486dea6cff80b7db178985d21a2c6/beacon/engine/types.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/650bb2f2b1dcfe30d9b1fa6f7dc9608055ed60e1/beacon/engine/types.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+11</span></div>
                        <div class="text-start"><span class="text-danger">-0</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-599d6da5ffcebc8b8aa2294b"><span class="term-fg1">diff --git go-ethereum&#47;beacon&#47;engine&#47;types.go op-geth&#47;beacon&#47;engine&#47;types.go</span>
<span class="term-fg1">index 67f30d4455aa3f88d9867931918a957cae1d51b7..6f3aa006b8776fe3fb28689fdbee4247951ceed9 100644</span>
<span class="term-fg1">--- go-ethereum&#47;beacon&#47;engine&#47;types.go</span>
<span class="term-fg1">+++ op-geth&#47;beacon&#47;engine&#47;types.go</span>
<span class="term-fg36">@@ -36,11 +36,22 @@</span> 	Random                common.Hash         `json:&quot;prevRandao&quot;            gencodec:&quot;required&quot;`
 	SuggestedFeeRecipient common.Address      `json:&quot;suggestedFeeRecipient&quot; gencodec:&quot;required&quot;`
 	Withdrawals           []*types.Withdrawal `json:&quot;withdrawals&quot;`
 	BeaconRoot            *common.Hash        `json:&quot;parentBeaconBlockRoot&quot;`
<span class="term-fg32">+</span>
<span class="term-fg32">+	&#47;&#47; Transactions is a field for rollups: the transactions list is forced into the block</span>
<span class="term-fg32">+	Transactions [][]byte `json:&quot;transactions,omitempty&quot;  gencodec:&quot;optional&quot;`</span>
<span class="term-fg32">+	&#47;&#47; NoTxPool is a field for rollups: if true, the no transactions are taken out of the tx-pool,</span>
<span class="term-fg32">+	&#47;&#47; only transactions from the above Transactions list will be included.</span>
<span class="term-fg32">+	NoTxPool bool `json:&quot;noTxPool,omitempty&quot; gencodec:&quot;optional&quot;`</span>
<span class="term-fg32">+	&#47;&#47; GasLimit is a field for rollups: if set, this sets the exact gas limit the block produced with.</span>
<span class="term-fg32">+	GasLimit *uint64 `json:&quot;gasLimit,omitempty&quot; gencodec:&quot;optional&quot;`</span>
 }
&nbsp;
 &#47;&#47; JSON type overrides for PayloadAttributes.
 type payloadAttributesMarshaling struct {
 	Timestamp hexutil.Uint64
<span class="term-fg32">+</span>
<span class="term-fg32">+	Transactions []hexutil.Bytes</span>
<span class="term-fg32">+	GasLimit     *hexutil.Uint64</span>
 }
&nbsp;
 &#47;&#47;go:generate go run github.com&#47;fjl&#47;gencodec -type ExecutableData -field-override executableDataMarshaling -out gen_ed.go</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-7bb88bdcb1178a39c07bd38c" role="button"
                   aria-expanded="false" aria-controls="id-7bb88bdcb1178a39c07bd38c">
                    <code>beacon/engine/gen_blockparams.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/3f40e65c484486dea6cff80b7db178985d21a2c6/beacon/engine/gen_blockparams.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/650bb2f2b1dcfe30d9b1fa6f7dc9608055ed60e1/beacon/engine/gen_blockparams.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+26</span></div>
                        <div class="text-start"><span class="text-danger">-0</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-7bb88bdcb1178a39c07bd38c"><span class="term-fg1">diff --git go-ethereum&#47;beacon&#47;engine&#47;gen_blockparams.go op-geth&#47;beacon&#47;engine&#47;gen_blockparams.go</span>
<span class="term-fg1">index b1f01b50ff8e3b1adf0454ff989356a6f612a337..c343e5890668558738a5f31b287a89a427888f66 100644</span>
<span class="term-fg1">--- go-ethereum&#47;beacon&#47;engine&#47;gen_blockparams.go</span>
<span class="term-fg1">+++ op-geth&#47;beacon&#47;engine&#47;gen_blockparams.go</span>
<span class="term-fg36">@@ -21,6 +21,9 @@</span> 		Random                common.Hash         `json:&quot;prevRandao&quot;            gencodec:&quot;required&quot;`
 		SuggestedFeeRecipient common.Address      `json:&quot;suggestedFeeRecipient&quot; gencodec:&quot;required&quot;`
 		Withdrawals           []*types.Withdrawal `json:&quot;withdrawals&quot;`
 		BeaconRoot            *common.Hash        `json:&quot;parentBeaconBlockRoot&quot;`
<span class="term-fg32">+		Transactions          []hexutil.Bytes     `json:&quot;transactions,omitempty&quot;  gencodec:&quot;optional&quot;`</span>
<span class="term-fg32">+		NoTxPool              bool                `json:&quot;noTxPool,omitempty&quot; gencodec:&quot;optional&quot;`</span>
<span class="term-fg32">+		GasLimit              *hexutil.Uint64     `json:&quot;gasLimit,omitempty&quot; gencodec:&quot;optional&quot;`</span>
 	}
 	var enc PayloadAttributes
 	enc.Timestamp = hexutil.Uint64(p.Timestamp)
<span class="term-fg36">@@ -28,6 +31,14 @@</span> 	enc.Random = p.Random
 	enc.SuggestedFeeRecipient = p.SuggestedFeeRecipient
 	enc.Withdrawals = p.Withdrawals
 	enc.BeaconRoot = p.BeaconRoot
<span class="term-fg32">+	if p.Transactions != nil {</span>
<span class="term-fg32">+		enc.Transactions = make([]hexutil.Bytes, len(p.Transactions))</span>
<span class="term-fg32">+		for k, v := range p.Transactions {</span>
<span class="term-fg32">+			enc.Transactions[k] = v</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	enc.NoTxPool = p.NoTxPool</span>
<span class="term-fg32">+	enc.GasLimit = (*hexutil.Uint64)(p.GasLimit)</span>
 	return json.Marshal(&amp;enc)
 }
&nbsp;
<span class="term-fg36">@@ -39,6 +50,9 @@</span> 		Random                *common.Hash        `json:&quot;prevRandao&quot;            gencodec:&quot;required&quot;`
 		SuggestedFeeRecipient *common.Address     `json:&quot;suggestedFeeRecipient&quot; gencodec:&quot;required&quot;`
 		Withdrawals           []*types.Withdrawal `json:&quot;withdrawals&quot;`
 		BeaconRoot            *common.Hash        `json:&quot;parentBeaconBlockRoot&quot;`
<span class="term-fg32">+		Transactions          []hexutil.Bytes     `json:&quot;transactions,omitempty&quot;  gencodec:&quot;optional&quot;`</span>
<span class="term-fg32">+		NoTxPool              *bool               `json:&quot;noTxPool,omitempty&quot; gencodec:&quot;optional&quot;`</span>
<span class="term-fg32">+		GasLimit              *hexutil.Uint64     `json:&quot;gasLimit,omitempty&quot; gencodec:&quot;optional&quot;`</span>
 	}
 	var dec PayloadAttributes
 	if err := json.Unmarshal(input, &amp;dec); err != nil {
<span class="term-fg36">@@ -61,6 +75,18 @@</span> 		p.Withdrawals = dec.Withdrawals
 	}
 	if dec.BeaconRoot != nil {
 		p.BeaconRoot = dec.BeaconRoot
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	if dec.Transactions != nil {</span>
<span class="term-fg32">+		p.Transactions = make([][]byte, len(dec.Transactions))</span>
<span class="term-fg32">+		for k, v := range dec.Transactions {</span>
<span class="term-fg32">+			p.Transactions[k] = v</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	if dec.NoTxPool != nil {</span>
<span class="term-fg32">+		p.NoTxPool = *dec.NoTxPool</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	if dec.GasLimit != nil {</span>
<span class="term-fg32">+		p.GasLimit = (*uint64)(dec.GasLimit)</span>
 	}
 	return nil
 }</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-efed79b6f636096f1a0d753b" role="button"
                   aria-expanded="false" aria-controls="id-efed79b6f636096f1a0d753b">
                    <code>eth/catalyst/api.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/3f40e65c484486dea6cff80b7db178985d21a2c6/eth/catalyst/api.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/650bb2f2b1dcfe30d9b1fa6f7dc9608055ed60e1/eth/catalyst/api.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+30</span></div>
                        <div class="text-start"><span class="text-danger">-12</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-efed79b6f636096f1a0d753b"><span class="term-fg1">diff --git go-ethereum&#47;eth&#47;catalyst&#47;api.go op-geth&#47;eth&#47;catalyst&#47;api.go</span>
<span class="term-fg1">index 08cce0558baeb8849e414b75f31d1f9a9410f75f..69599d8c6c290d4e3c8dbd9a99d2c12008b28cfd 100644</span>
<span class="term-fg1">--- go-ethereum&#47;eth&#47;catalyst&#47;api.go</span>
<span class="term-fg1">+++ op-geth&#47;eth&#47;catalyst&#47;api.go</span>
<span class="term-fg36">@@ -320,7 +320,7 @@</span> 	} else if api.eth.BlockChain().CurrentBlock().Hash() == update.HeadBlockHash {
 		&#47;&#47; If the specified head matches with our local head, do nothing and keep
 		&#47;&#47; generating the payload. It&#39;s a special corner case that a few slots are
 		&#47;&#47; missing and we are requested to generate the payload in slot.
<span class="term-fg31">-	} else {</span>
<span class="term-fg32">+	} else if api.eth.BlockChain().Config().Optimism == nil { &#47;&#47; minor Engine API divergence: allow proposers to reorg their own chain</span>
 		&#47;&#47; If the head block is already in our canonical chain, the beacon client is
 		&#47;&#47; probably resyncing. Ignore the update.
 		log.Info(&quot;Ignoring beacon update to old head&quot;, &quot;number&quot;, block.NumberU64(), &quot;hash&quot;, update.HeadBlockHash, &quot;age&quot;, common.PrettyAge(time.Unix(int64(block.Time()), 0)), &quot;have&quot;, api.eth.BlockChain().CurrentBlock().Number)
<span class="term-fg36">@@ -364,6 +364,17 @@</span> 	&#47;&#47; If payload generation was requested, create a new block to be potentially
 	&#47;&#47; sealed by the beacon client. The payload will be requested later, and we
 	&#47;&#47; will replace it arbitrarily many times in between.
 	if payloadAttributes != nil {
<span class="term-fg32">+		if api.eth.BlockChain().Config().Optimism != nil &amp;&amp; payloadAttributes.GasLimit == nil {</span>
<span class="term-fg32">+			return engine.STATUS_INVALID, engine.InvalidPayloadAttributes.With(errors.New(&quot;gasLimit parameter is required&quot;))</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+		transactions := make(types.Transactions, 0, len(payloadAttributes.Transactions))</span>
<span class="term-fg32">+		for i, otx := range payloadAttributes.Transactions {</span>
<span class="term-fg32">+			var tx types.Transaction</span>
<span class="term-fg32">+			if err := tx.UnmarshalBinary(otx); err != nil {</span>
<span class="term-fg32">+				return engine.STATUS_INVALID, fmt.Errorf(&quot;transaction %d is not valid: %v&quot;, i, err)</span>
<span class="term-fg32">+			}</span>
<span class="term-fg32">+			transactions = append(transactions, &amp;tx)</span>
<span class="term-fg32">+		}</span>
 		args := &amp;miner.BuildPayloadArgs{
 			Parent:       update.HeadBlockHash,
 			Timestamp:    payloadAttributes.Timestamp,
<span class="term-fg36">@@ -371,6 +382,9 @@</span> 			FeeRecipient: payloadAttributes.SuggestedFeeRecipient,
 			Random:       payloadAttributes.Random,
 			Withdrawals:  payloadAttributes.Withdrawals,
 			BeaconRoot:   payloadAttributes.BeaconRoot,
<span class="term-fg32">+			NoTxPool:     payloadAttributes.NoTxPool,</span>
<span class="term-fg32">+			Transactions: transactions,</span>
<span class="term-fg32">+			GasLimit:     payloadAttributes.GasLimit,</span>
 		}
 		id := args.Id()
 		&#47;&#47; If we already are busy generating this work, then we do not need
<span class="term-fg36">@@ -513,7 +527,7 @@</span> 	log.Trace(&quot;Engine API request received&quot;, &quot;method&quot;, &quot;NewPayload&quot;, &quot;number&quot;, params.Number, &quot;hash&quot;, params.BlockHash)
 	block, err := engine.ExecutableDataToBlock(params, versionedHashes, beaconRoot)
 	if err != nil {
 		log.Warn(&quot;Invalid NewPayload params&quot;, &quot;params&quot;, params, &quot;error&quot;, err)
<span class="term-fg31">-		return engine.PayloadStatusV1{Status: engine.INVALID}, nil</span>
<span class="term-fg32">+		return api.invalid(err, nil), nil</span>
 	}
 	&#47;&#47; Stash away the last update to warn the user if the beacon client goes offline
 	api.lastNewPayloadLock.Lock()
<span class="term-fg36">@@ -560,7 +574,7 @@</span> 	if block.Time() &lt;= parent.Time() {
 		log.Warn(&quot;Invalid timestamp&quot;, &quot;parent&quot;, block.Time(), &quot;block&quot;, block.Time())
 		return api.invalid(errors.New(&quot;invalid timestamp&quot;), parent.Header()), nil
 	}
<span class="term-fg31">-	&#47;&#47; Another cornercase: if the node is in snap sync mode, but the CL client</span>
<span class="term-fg32">+	&#47;&#47; Another corner case: if the node is in snap sync mode, but the CL client</span>
 	&#47;&#47; tries to make it import a block. That should be denied as pushing something
 	&#47;&#47; into the database directly will conflict with the assumptions of snap sync
 	&#47;&#47; that it has an empty db that it can fill itself.
<span class="term-fg36">@@ -694,20 +708,21 @@</span> 		ValidationError: &amp;failure,
 	}
 }
&nbsp;
<span class="term-fg31">-&#47;&#47; invalid returns a response &quot;INVALID&quot; with the latest valid hash supplied by latest or to the current head</span>
<span class="term-fg31">-&#47;&#47; if no latestValid block was provided.</span>
<span class="term-fg32">+&#47;&#47; invalid returns a response &quot;INVALID&quot; with the latest valid hash supplied by latest.</span>
 func (api *ConsensusAPI) invalid(err error, latestValid *types.Header) engine.PayloadStatusV1 {
<span class="term-fg31">-	currentHash := api.eth.BlockChain().CurrentBlock().Hash()</span>
<span class="term-fg32">+	var currentHash *common.Hash</span>
 	if latestValid != nil {
<span class="term-fg31">-		&#47;&#47; Set latest valid hash to 0x0 if parent is PoW block</span>
<span class="term-fg31">-		currentHash = common.Hash{}</span>
<span class="term-fg31">-		if latestValid.Difficulty.BitLen() == 0 {</span>
<span class="term-fg32">+		if latestValid.Difficulty.BitLen() != 0 {</span>
<span class="term-fg32">+			&#47;&#47; Set latest valid hash to 0x0 if parent is PoW block</span>
<span class="term-fg32">+			currentHash = &amp;common.Hash{}</span>
<span class="term-fg32">+		} else {</span>
 			&#47;&#47; Otherwise set latest valid hash to parent hash
<span class="term-fg31">-			currentHash = latestValid.Hash()</span>
<span class="term-fg32">+			h := latestValid.Hash()</span>
<span class="term-fg32">+			currentHash = &amp;h</span>
 		}
 	}
 	errorMsg := err.Error()
<span class="term-fg31">-	return engine.PayloadStatusV1{Status: engine.INVALID, LatestValidHash: &amp;currentHash, ValidationError: &amp;errorMsg}</span>
<span class="term-fg32">+	return engine.PayloadStatusV1{Status: engine.INVALID, LatestValidHash: currentHash, ValidationError: &amp;errorMsg}</span>
 }
&nbsp;
 &#47;&#47; heartbeat loops indefinitely, and checks if there have been beacon client updates
<span class="term-fg36">@@ -716,6 +731,9 @@</span> &#47;&#47; user that something might be off with their consensus node.
 &#47;&#47;
 &#47;&#47; TODO(karalabe): Spin this goroutine down somehow
 func (api *ConsensusAPI) heartbeat() {
<span class="term-fg32">+	if api.eth.BlockChain().Config().Optimism != nil { &#47;&#47; don&#39;t start the api heartbeat, there is no transition</span>
<span class="term-fg32">+		return</span>
<span class="term-fg32">+	}</span>
 	&#47;&#47; Sleep a bit on startup since there&#39;s obviously no beacon client yet
 	&#47;&#47; attached, so no need to print scary warnings to the user.
 	time.Sleep(beaconUpdateStartupTimeout)
<span class="term-fg36">@@ -776,7 +794,7 @@</span>
 &#47;&#47; GetPayloadBodiesByHashV1 implements engine_getPayloadBodiesByHashV1 which allows for retrieval of a list
 &#47;&#47; of block bodies by the engine api.
 func (api *ConsensusAPI) GetPayloadBodiesByHashV1(hashes []common.Hash) []*engine.ExecutionPayloadBodyV1 {
<span class="term-fg31">-	var bodies = make([]*engine.ExecutionPayloadBodyV1, len(hashes))</span>
<span class="term-fg32">+	bodies := make([]*engine.ExecutionPayloadBodyV1, len(hashes))</span>
 	for i, hash := range hashes {
 		block := api.eth.BlockChain().GetBlockByHash(hash)
 		bodies[i] = getBody(block)</div>
    </div>

            
        </div>
        <div>
            
        </div>
    </div>
</div>

            
                <div class="ps-1 py-2 my-1"><div class="row border-bottom border-1"data-bs-toggle="collapse" data-bs-target="#id-9cf9dbff2d86dbc2e47c82b3"role="button" aria-expanded="false" aria-controls="id-9cf9dbff2d86dbc2e47c82b3">
        
            <div class="col-12 col-sm-9 text-start"><h3>Block-building modifications</h3></div>
        
        <div class="col-12 col-sm-3 ms-auto mt-2">
            <div class="row line-stat">
                <div class="text-end"><span class="text-success">+142</span></div>
                <div class="text-start"><span class="text-danger">-20</span></div>
            </div>
        </div>
    </div>

    <div class="row forkdef-content collapse  border-1 ps-3 my-3" id="id-9cf9dbff2d86dbc2e47c82b3">
        <div><p>The block-building code (in the &ldquo;miner&rdquo; package because of Proof-Of-Work legacy of ethereum) implements the
changes to support the transaction-inclusion, tx-pool toggle and gaslimit parameters of the Engine API.</p>
</div>
        <div>
            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-b3b0210136bea84849092676" role="button"
                   aria-expanded="false" aria-controls="id-b3b0210136bea84849092676">
                    <code>miner/payload_building.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/3f40e65c484486dea6cff80b7db178985d21a2c6/miner/payload_building.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/650bb2f2b1dcfe30d9b1fa6f7dc9608055ed60e1/miner/payload_building.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+28</span></div>
                        <div class="text-start"><span class="text-danger">-0</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-b3b0210136bea84849092676"><span class="term-fg1">diff --git go-ethereum&#47;miner&#47;payload_building.go op-geth&#47;miner&#47;payload_building.go</span>
<span class="term-fg1">index 7d8c4368bfc4068c1a270a9f61b4f57b55e9030e..145f91df761adb20ab205e85547f22100cfe1845 100644</span>
<span class="term-fg1">--- go-ethereum&#47;miner&#47;payload_building.go</span>
<span class="term-fg1">+++ op-geth&#47;miner&#47;payload_building.go</span>
<span class="term-fg36">@@ -41,6 +41,10 @@</span> 	FeeRecipient common.Address    &#47;&#47; The provided recipient address for collecting transaction fee
 	Random       common.Hash       &#47;&#47; The provided randomness value
 	Withdrawals  types.Withdrawals &#47;&#47; The provided withdrawals
 	BeaconRoot   *common.Hash      &#47;&#47; The provided beaconRoot (Cancun)
<span class="term-fg32">+</span>
<span class="term-fg32">+	NoTxPool     bool                 &#47;&#47; Optimism addition: option to disable tx pool contents from being included</span>
<span class="term-fg32">+	Transactions []*types.Transaction &#47;&#47; Optimism addition: txs forced into the block via engine API</span>
<span class="term-fg32">+	GasLimit     *uint64              &#47;&#47; Optimism addition: override gas limit of the block to build</span>
 }
&nbsp;
 &#47;&#47; Id computes an 8-byte identifier by hashing the components of the payload arguments.
<span class="term-fg36">@@ -55,6 +59,19 @@</span> 	rlp.Encode(hasher, args.Withdrawals)
 	if args.BeaconRoot != nil {
 		hasher.Write(args.BeaconRoot[:])
 	}
<span class="term-fg32">+</span>
<span class="term-fg32">+	if args.NoTxPool || len(args.Transactions) &gt; 0 { &#47;&#47; extend if extra payload attributes are used</span>
<span class="term-fg32">+		binary.Write(hasher, binary.BigEndian, args.NoTxPool)</span>
<span class="term-fg32">+		binary.Write(hasher, binary.BigEndian, uint64(len(args.Transactions)))</span>
<span class="term-fg32">+		for _, tx := range args.Transactions {</span>
<span class="term-fg32">+			h := tx.Hash()</span>
<span class="term-fg32">+			hasher.Write(h[:])</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	if args.GasLimit != nil {</span>
<span class="term-fg32">+		binary.Write(hasher, binary.BigEndian, *args.GasLimit)</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+</span>
 	var out engine.PayloadID
 	copy(out[:], hasher.Sum(nil)[:8])
 	return out
<span class="term-fg36">@@ -179,6 +196,7 @@</span> func (w *worker) buildPayload(args *BuildPayloadArgs) (*Payload, error) {
 	&#47;&#47; Build the initial version with no transaction included. It should be fast
 	&#47;&#47; enough to run. The empty payload can at least make sure there is something
 	&#47;&#47; to deliver for not missing slot.
<span class="term-fg32">+	&#47;&#47; In OP-Stack, the &quot;empty&quot; block is constructed from provided txs only, i.e. no tx-pool usage.</span>
 	emptyParams := &amp;generateParams{
 		timestamp:   args.Timestamp,
 		forceTime:   true,
<span class="term-fg36">@@ -188,6 +206,8 @@</span> 		random:      args.Random,
 		withdrawals: args.Withdrawals,
 		beaconRoot:  args.BeaconRoot,
 		noTxs:       true,
<span class="term-fg32">+		txs:         args.Transactions,</span>
<span class="term-fg32">+		gasLimit:    args.GasLimit,</span>
 	}
 	empty := w.getSealingBlock(emptyParams)
 	if empty.err != nil {
<span class="term-fg36">@@ -196,6 +216,12 @@</span> 	}
&nbsp;
 	&#47;&#47; Construct a payload object for return.
 	payload := newPayload(empty.block, args.Id())
<span class="term-fg32">+	if args.NoTxPool { &#47;&#47; don&#39;t start the background payload updating job if there is no tx pool to pull from</span>
<span class="term-fg32">+		&#47;&#47; make sure to make it appear as full, otherwise it will wait indefinitely for payload building to complete.</span>
<span class="term-fg32">+		payload.full = empty.block</span>
<span class="term-fg32">+		payload.fullFees = empty.fees</span>
<span class="term-fg32">+		return payload, nil</span>
<span class="term-fg32">+	}</span>
&nbsp;
 	&#47;&#47; Spin up a routine for updating the payload in background. This strategy
 	&#47;&#47; can maximum the revenue for including transactions with highest fee.
<span class="term-fg36">@@ -219,6 +245,8 @@</span> 			random:      args.Random,
 			withdrawals: args.Withdrawals,
 			beaconRoot:  args.BeaconRoot,
 			noTxs:       false,
<span class="term-fg32">+			txs:         args.Transactions,</span>
<span class="term-fg32">+			gasLimit:    args.GasLimit,</span>
 		}
&nbsp;
 		for {</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-8ee457b54e19bd0bc5521dcb" role="button"
                   aria-expanded="false" aria-controls="id-8ee457b54e19bd0bc5521dcb">
                    <code>miner/worker_test.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/3f40e65c484486dea6cff80b7db178985d21a2c6/miner/worker_test.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/650bb2f2b1dcfe30d9b1fa6f7dc9608055ed60e1/miner/worker_test.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+2</span></div>
                        <div class="text-start"><span class="text-danger">-1</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-8ee457b54e19bd0bc5521dcb"><span class="term-fg1">diff --git go-ethereum&#47;miner&#47;worker_test.go op-geth&#47;miner&#47;worker_test.go</span>
<span class="term-fg1">index 9c4694c0e20deade0c1c929f61dab094205c8d1c..d0a5ced8f9b6082613c10bfed460b6044464ae9e 100644</span>
<span class="term-fg1">--- go-ethereum&#47;miner&#47;worker_test.go</span>
<span class="term-fg1">+++ op-geth&#47;miner&#47;worker_test.go</span>
<span class="term-fg36">@@ -297,7 +297,8 @@</span> 			min := float64(3 * time.Second.Nanoseconds())
 			estimate = estimate*(1-intervalAdjustRatio) + intervalAdjustRatio*(min-intervalAdjustBias)
 			wantMinInterval, wantRecommitInterval = 3*time.Second, time.Duration(estimate)*time.Nanosecond
 		case 3:
<span class="term-fg31">-			wantMinInterval, wantRecommitInterval = time.Second, time.Second</span>
<span class="term-fg32">+			&#47;&#47; lower than upstream test, since enforced min recommit interval is lower</span>
<span class="term-fg32">+			wantMinInterval, wantRecommitInterval = 500*time.Millisecond, 500*time.Millisecond</span>
 		}
&nbsp;
 		&#47;&#47; Check interval</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-15336c68c4a2b26d7b432ec6" role="button"
                   aria-expanded="false" aria-controls="id-15336c68c4a2b26d7b432ec6">
                    <code>miner/miner_test.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/3f40e65c484486dea6cff80b7db178985d21a2c6/miner/miner_test.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/650bb2f2b1dcfe30d9b1fa6f7dc9608055ed60e1/miner/miner_test.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+6</span></div>
                        <div class="text-start"><span class="text-danger">-1</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-15336c68c4a2b26d7b432ec6"><span class="term-fg1">diff --git go-ethereum&#47;miner&#47;miner_test.go op-geth&#47;miner&#47;miner_test.go</span>
<span class="term-fg1">index 489bc46a911a22ba35e4eebbc1a82ff346951d22..36d5166c6dbef7d97f559c252d0b937e98f6fac6 100644</span>
<span class="term-fg1">--- go-ethereum&#47;miner&#47;miner_test.go</span>
<span class="term-fg1">+++ op-geth&#47;miner&#47;miner_test.go</span>
<span class="term-fg36">@@ -64,6 +64,7 @@</span> 	return nil, errors.New(&quot;not supported&quot;)
 }
&nbsp;
 type testBlockChain struct {
<span class="term-fg32">+	root          common.Hash</span>
 	config        *params.ChainConfig
 	statedb       *state.StateDB
 	gasLimit      uint64
<span class="term-fg36">@@ -87,6 +88,10 @@</span> }
&nbsp;
 func (bc *testBlockChain) StateAt(common.Hash) (*state.StateDB, error) {
 	return bc.statedb, nil
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func (bc *testBlockChain) HasState(root common.Hash) bool {</span>
<span class="term-fg32">+	return bc.root == root</span>
 }
&nbsp;
 func (bc *testBlockChain) SubscribeChainHeadEvent(ch chan&lt;- core.ChainHeadEvent) event.Subscription {
<span class="term-fg36">@@ -302,7 +307,7 @@</span> 	if err != nil {
 		t.Fatalf(&quot;can&#39;t create new chain %v&quot;, err)
 	}
 	statedb, _ := state.New(bc.Genesis().Root(), bc.StateCache(), nil)
<span class="term-fg31">-	blockchain := &amp;testBlockChain{chainConfig, statedb, 10000000, new(event.Feed)}</span>
<span class="term-fg32">+	blockchain := &amp;testBlockChain{bc.Genesis().Root(), chainConfig, statedb, 10000000, new(event.Feed)}</span>
&nbsp;
 	pool := legacypool.New(testTxPoolConfig, blockchain)
 	txpool, _ := txpool.New(new(big.Int).SetUint64(testTxPoolConfig.PriceLimit), blockchain, []txpool.SubPool{pool})</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-bc109beeed7f37219ccc0211" role="button"
                   aria-expanded="false" aria-controls="id-bc109beeed7f37219ccc0211">
                    <code>miner/miner.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/3f40e65c484486dea6cff80b7db178985d21a2c6/miner/miner.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/650bb2f2b1dcfe30d9b1fa6f7dc9608055ed60e1/miner/miner.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+8</span></div>
                        <div class="text-start"><span class="text-danger">-0</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-bc109beeed7f37219ccc0211"><span class="term-fg1">diff --git go-ethereum&#47;miner&#47;miner.go op-geth&#47;miner&#47;miner.go</span>
<span class="term-fg1">index b7273948f5e75dac52548cc07faa19abd5705072..82d353a336eff601566da2f938e344a62f474027 100644</span>
<span class="term-fg1">--- go-ethereum&#47;miner&#47;miner.go</span>
<span class="term-fg1">+++ op-geth&#47;miner&#47;miner.go</span>
<span class="term-fg36">@@ -18,6 +18,7 @@</span> &#47;&#47; Package miner implements Ethereum block creation and mining.
 package miner
&nbsp;
 import (
<span class="term-fg32">+	&quot;context&quot;</span>
 	&quot;fmt&quot;
 	&quot;math&#47;big&quot;
 	&quot;sync&quot;
<span class="term-fg36">@@ -31,6 +32,7 @@</span> 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;core&#47;state&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;core&#47;txpool&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;core&#47;types&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;eth&#47;downloader&quot;
<span class="term-fg32">+	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;eth&#47;tracers&quot;</span>
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;event&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;log&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;params&quot;
<span class="term-fg36">@@ -43,6 +45,10 @@</span> 	BlockChain() *core.BlockChain
 	TxPool() *txpool.TxPool
 }
&nbsp;
<span class="term-fg32">+type BackendWithHistoricalState interface {</span>
<span class="term-fg32">+	StateAtBlock(ctx context.Context, block *types.Block, reexec uint64, base *state.StateDB, readOnly bool, preferDisk bool) (*state.StateDB, tracers.StateReleaseFunc, error)</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
 &#47;&#47; Config is the configuration parameters of mining.
 type Config struct {
 	Etherbase common.Address `toml:&quot;,omitempty&quot;` &#47;&#47; Public address for block mining rewards
<span class="term-fg36">@@ -53,6 +59,8 @@</span> 	GasPrice  *big.Int       &#47;&#47; Minimum gas price for mining a transaction
 	Recommit  time.Duration  &#47;&#47; The time interval for miner to re-create mining work.
&nbsp;
 	NewPayloadTimeout time.Duration &#47;&#47; The maximum time allowance for creating a new payload
<span class="term-fg32">+</span>
<span class="term-fg32">+	RollupComputePendingBlock bool &#47;&#47; Compute the pending block from tx-pool, instead of copying the latest-block</span>
 }
&nbsp;
 &#47;&#47; DefaultConfig contains default settings for miner.</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-059487de9bd488f23dcf8a50" role="button"
                   aria-expanded="false" aria-controls="id-059487de9bd488f23dcf8a50">
                    <code>miner/ordering_test.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/3f40e65c484486dea6cff80b7db178985d21a2c6/miner/ordering_test.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/650bb2f2b1dcfe30d9b1fa6f7dc9608055ed60e1/miner/ordering_test.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+4</span></div>
                        <div class="text-start"><span class="text-danger">-0</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-059487de9bd488f23dcf8a50"><span class="term-fg1">diff --git go-ethereum&#47;miner&#47;ordering_test.go op-geth&#47;miner&#47;ordering_test.go</span>
<span class="term-fg1">index bdbdc321485157e7c05bed7610e6785f925e8a75..59d478274d7419e398737a62c9a06a7d4e68143d 100644</span>
<span class="term-fg1">--- go-ethereum&#47;miner&#47;ordering_test.go</span>
<span class="term-fg1">+++ op-geth&#47;miner&#47;ordering_test.go</span>
<span class="term-fg36">@@ -92,6 +92,8 @@</span> 				Tx:        tx,
 				Time:      tx.Time(),
 				GasFeeCap: tx.GasFeeCap(),
 				GasTipCap: tx.GasTipCap(),
<span class="term-fg32">+				Gas:       tx.Gas(),</span>
<span class="term-fg32">+				BlobGas:   tx.BlobGas(),</span>
 			})
 		}
 		expectedCount += count
<span class="term-fg36">@@ -157,6 +159,8 @@</span> 			Tx:        tx,
 			Time:      tx.Time(),
 			GasFeeCap: tx.GasFeeCap(),
 			GasTipCap: tx.GasTipCap(),
<span class="term-fg32">+			Gas:       tx.Gas(),</span>
<span class="term-fg32">+			BlobGas:   tx.BlobGas(),</span>
 		})
 	}
 	&#47;&#47; Sort the transactions and cross check the nonce ordering</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-0aa6a28f71468f4524fa48ff" role="button"
                   aria-expanded="false" aria-controls="id-0aa6a28f71468f4524fa48ff">
                    <code>miner/worker.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/3f40e65c484486dea6cff80b7db178985d21a2c6/miner/worker.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/650bb2f2b1dcfe30d9b1fa6f7dc9608055ed60e1/miner/worker.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+94</span></div>
                        <div class="text-start"><span class="text-danger">-18</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-0aa6a28f71468f4524fa48ff"><span class="term-fg1">diff --git go-ethereum&#47;miner&#47;worker.go op-geth&#47;miner&#47;worker.go</span>
<span class="term-fg1">index 711149232ba19089c0c13b13425178ee22508791..433399b68b34109aa740819462f989e25205bdd6 100644</span>
<span class="term-fg1">--- go-ethereum&#47;miner&#47;worker.go</span>
<span class="term-fg1">+++ op-geth&#47;miner&#47;worker.go</span>
<span class="term-fg36">@@ -17,6 +17,7 @@</span>
 package miner
&nbsp;
 import (
<span class="term-fg32">+	&quot;context&quot;</span>
 	&quot;errors&quot;
 	&quot;fmt&quot;
 	&quot;math&#47;big&quot;
<span class="term-fg36">@@ -26,6 +27,7 @@</span> 	&quot;time&quot;
&nbsp;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;common&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;consensus&quot;
<span class="term-fg32">+	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;consensus&#47;misc&quot;</span>
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;consensus&#47;misc&#47;eip1559&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;consensus&#47;misc&#47;eip4844&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;core&quot;
<span class="term-fg36">@@ -33,6 +35,7 @@</span> 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;core&#47;state&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;core&#47;txpool&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;core&#47;types&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;core&#47;vm&quot;
<span class="term-fg32">+	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;eth&#47;tracers&quot;</span>
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;event&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;log&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;params&quot;
<span class="term-fg36">@@ -55,7 +58,7 @@</span> 	resubmitAdjustChanSize = 10
&nbsp;
 	&#47;&#47; minRecommitInterval is the minimal time interval to recreate the sealing block with
 	&#47;&#47; any newly arrived transactions.
<span class="term-fg31">-	minRecommitInterval = 1 * time.Second</span>
<span class="term-fg32">+	minRecommitInterval = 100 * time.Millisecond</span>
&nbsp;
 	&#47;&#47; maxRecommitInterval is the maximum time interval to recreate the sealing block with
 	&#47;&#47; any newly arrived transactions.
<span class="term-fg36">@@ -263,8 +266,8 @@</span> 		exitCh:             make(chan struct{}),
 		resubmitIntervalCh: make(chan time.Duration),
 		resubmitAdjustCh:   make(chan *intervalAdjust, resubmitAdjustChanSize),
 	}
<span class="term-fg31">-	&#47;&#47; Subscribe NewTxsEvent for tx pool</span>
<span class="term-fg31">-	worker.txsSub = eth.TxPool().SubscribeNewTxsEvent(worker.txsCh)</span>
<span class="term-fg32">+	&#47;&#47; Subscribe for transaction insertion events (whether from network or resurrects)</span>
<span class="term-fg32">+	worker.txsSub = eth.TxPool().SubscribeTransactions(worker.txsCh, true)</span>
 	&#47;&#47; Subscribe events for blockchain
 	worker.chainHeadSub = eth.BlockChain().SubscribeChainHeadEvent(worker.chainHeadCh)
&nbsp;
<span class="term-fg36">@@ -338,6 +341,9 @@</span>
 &#47;&#47; pending returns the pending state and corresponding block. The returned
 &#47;&#47; values can be nil in case the pending block is not initialized.
 func (w *worker) pending() (*types.Block, *state.StateDB) {
<span class="term-fg32">+	if w.chainConfig.Optimism != nil &amp;&amp; !w.config.RollupComputePendingBlock {</span>
<span class="term-fg32">+		return nil, nil &#47;&#47; when not computing the pending block, there is never a pending state</span>
<span class="term-fg32">+	}</span>
 	w.snapshotMu.RLock()
 	defer w.snapshotMu.RUnlock()
 	if w.snapshotState == nil {
<span class="term-fg36">@@ -349,6 +355,12 @@</span>
 &#47;&#47; pendingBlock returns pending block. The returned block can be nil in case the
 &#47;&#47; pending block is not initialized.
 func (w *worker) pendingBlock() *types.Block {
<span class="term-fg32">+	if w.chainConfig.Optimism != nil &amp;&amp; !w.config.RollupComputePendingBlock {</span>
<span class="term-fg32">+		&#47;&#47; For compatibility when not computing a pending block, we serve the latest block as &quot;pending&quot;</span>
<span class="term-fg32">+		headHeader := w.eth.BlockChain().CurrentHeader()</span>
<span class="term-fg32">+		headBlock := w.eth.BlockChain().GetBlock(headHeader.Hash(), headHeader.Number.Uint64())</span>
<span class="term-fg32">+		return headBlock</span>
<span class="term-fg32">+	}</span>
 	w.snapshotMu.RLock()
 	defer w.snapshotMu.RUnlock()
 	return w.snapshotBlock
<span class="term-fg36">@@ -357,6 +369,9 @@</span>
 &#47;&#47; pendingBlockAndReceipts returns pending block and corresponding receipts.
 &#47;&#47; The returned values can be nil in case the pending block is not initialized.
 func (w *worker) pendingBlockAndReceipts() (*types.Block, types.Receipts) {
<span class="term-fg32">+	if w.chainConfig.Optimism != nil &amp;&amp; !w.config.RollupComputePendingBlock {</span>
<span class="term-fg32">+		return nil, nil &#47;&#47; when not computing the pending block, there are no pending receipts, and thus no pending logs</span>
<span class="term-fg32">+	}</span>
 	w.snapshotMu.RLock()
 	defer w.snapshotMu.RUnlock()
 	return w.snapshotBlock, w.snapshotReceipts
<span class="term-fg36">@@ -411,6 +426,19 @@</span>
 &#47;&#47; newWorkLoop is a standalone goroutine to submit new sealing work upon received events.
 func (w *worker) newWorkLoop(recommit time.Duration) {
 	defer w.wg.Done()
<span class="term-fg32">+	if w.chainConfig.Optimism != nil &amp;&amp; !w.config.RollupComputePendingBlock {</span>
<span class="term-fg32">+		for { &#47;&#47; do not update the pending-block, instead drain work without doing it, to keep producers from blocking.</span>
<span class="term-fg32">+			select {</span>
<span class="term-fg32">+			case &lt;-w.startCh:</span>
<span class="term-fg32">+			case &lt;-w.chainHeadCh:</span>
<span class="term-fg32">+			case &lt;-w.resubmitIntervalCh:</span>
<span class="term-fg32">+			case &lt;-w.resubmitAdjustCh:</span>
<span class="term-fg32">+			case &lt;-w.exitCh:</span>
<span class="term-fg32">+				return</span>
<span class="term-fg32">+			}</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+</span>
 	var (
 		interrupt   *atomic.Int32
 		minRecommit = recommit &#47;&#47; minimal resubmit interval specified by user.
<span class="term-fg36">@@ -528,6 +556,9 @@</span> 		case req := &lt;-w.getWorkCh:
 			req.result &lt;- w.generateWork(req.params)
&nbsp;
 		case ev := &lt;-w.txsCh:
<span class="term-fg32">+			if w.chainConfig.Optimism != nil &amp;&amp; !w.config.RollupComputePendingBlock {</span>
<span class="term-fg32">+				continue &#47;&#47; don&#39;t update the pending-block snapshot if we are not computing the pending block</span>
<span class="term-fg32">+			}</span>
 			&#47;&#47; Apply transactions to the pending state if we&#39;re not sealing
 			&#47;&#47;
 			&#47;&#47; Note all transactions received may not be continuous with transactions
<span class="term-fg36">@@ -542,11 +573,14 @@</span> 				txs := make(map[common.Address][]*txpool.LazyTransaction, len(ev.Txs))
 				for _, tx := range ev.Txs {
 					acc, _ := types.Sender(w.current.signer, tx)
 					txs[acc] = append(txs[acc], &amp;txpool.LazyTransaction{
<span class="term-fg32">+						Pool:      w.eth.TxPool(), &#47;&#47; We don&#39;t know where this came from, yolo resolve from everywhere</span>
 						Hash:      tx.Hash(),
<span class="term-fg31">-						Tx:        tx.WithoutBlobTxSidecar(),</span>
<span class="term-fg32">+						Tx:        nil, &#47;&#47; Do *not* set this! We need to resolve it later to pull blobs in</span>
 						Time:      tx.Time(),
 						GasFeeCap: tx.GasFeeCap(),
 						GasTipCap: tx.GasTipCap(),
<span class="term-fg32">+						Gas:       tx.Gas(),</span>
<span class="term-fg32">+						BlobGas:   tx.BlobGas(),</span>
 					})
 				}
 				txset := newTransactionsByPriceAndNonce(w.current.signer, txs, w.current.header.BaseFee)
<span class="term-fg36">@@ -705,6 +739,15 @@</span> func (w *worker) makeEnv(parent *types.Header, header *types.Header, coinbase common.Address) (*environment, error) {
 	&#47;&#47; Retrieve the parent state to execute on top and start a prefetcher for
 	&#47;&#47; the miner to speed block sealing up a bit.
 	state, err := w.chain.StateAt(parent.Root)
<span class="term-fg32">+	if err != nil &amp;&amp; w.chainConfig.Optimism != nil { &#47;&#47; Allow the miner to reorg its own chain arbitrarily deep</span>
<span class="term-fg32">+		if historicalBackend, ok := w.eth.(BackendWithHistoricalState); ok {</span>
<span class="term-fg32">+			var release tracers.StateReleaseFunc</span>
<span class="term-fg32">+			parentBlock := w.eth.BlockChain().GetBlockByHash(parent.Hash())</span>
<span class="term-fg32">+			state, release, err = historicalBackend.StateAtBlock(context.Background(), parentBlock, ^uint64(0), nil, false, false)</span>
<span class="term-fg32">+			state = state.Copy()</span>
<span class="term-fg32">+			release()</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+	}</span>
 	if err != nil {
 		return nil, err
 	}
<span class="term-fg36">@@ -742,7 +785,6 @@</span> func (w *worker) commitTransaction(env *environment, tx *types.Transaction) ([]*types.Log, error) {
 	if tx.Type() == types.BlobTxType {
 		return w.commitBlobTransaction(env, tx)
 	}
<span class="term-fg31">-</span>
 	receipt, err := w.applyTransaction(env, tx)
 	if err != nil {
 		return nil, err
<span class="term-fg36">@@ -764,7 +806,6 @@</span> 	&#47;&#47; tx has too many blobs. So we have to explicitly check it here.
 	if (env.blobs+len(sc.Blobs))*params.BlobTxBlobGasPerBlob &gt; params.MaxBlobGasPerBlock {
 		return nil, errors.New(&quot;max data blobs reached&quot;)
 	}
<span class="term-fg31">-</span>
 	receipt, err := w.applyTransaction(env, tx)
 	if err != nil {
 		return nil, err
<span class="term-fg36">@@ -815,13 +856,24 @@</span> 		ltx := txs.Peek()
 		if ltx == nil {
 			break
 		}
<span class="term-fg32">+		&#47;&#47; If we don&#39;t have enough space for the next transaction, skip the account.</span>
<span class="term-fg32">+		if env.gasPool.Gas() &lt; ltx.Gas {</span>
<span class="term-fg32">+			log.Trace(&quot;Not enough gas left for transaction&quot;, &quot;hash&quot;, ltx.Hash, &quot;left&quot;, env.gasPool.Gas(), &quot;needed&quot;, ltx.Gas)</span>
<span class="term-fg32">+			txs.Pop()</span>
<span class="term-fg32">+			continue</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+		if left := uint64(params.MaxBlobGasPerBlock - env.blobs*params.BlobTxBlobGasPerBlob); left &lt; ltx.BlobGas {</span>
<span class="term-fg32">+			log.Trace(&quot;Not enough blob gas left for transaction&quot;, &quot;hash&quot;, ltx.Hash, &quot;left&quot;, left, &quot;needed&quot;, ltx.BlobGas)</span>
<span class="term-fg32">+			txs.Pop()</span>
<span class="term-fg32">+			continue</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+		&#47;&#47; Transaction seems to fit, pull it up from the pool</span>
 		tx := ltx.Resolve()
 		if tx == nil {
<span class="term-fg31">-			log.Warn(&quot;Ignoring evicted transaction&quot;)</span>
<span class="term-fg32">+			log.Trace(&quot;Ignoring evicted transaction&quot;, &quot;hash&quot;, ltx.Hash)</span>
 			txs.Pop()
 			continue
 		}
<span class="term-fg31">-</span>
 		&#47;&#47; Error may be ignored here. The error has already been checked
 		&#47;&#47; during transaction acceptance is the transaction pool.
 		from, _ := types.Sender(env.signer, tx)
<span class="term-fg36">@@ -829,11 +881,10 @@</span>
 		&#47;&#47; Check whether the tx is replay protected. If we&#39;re not in the EIP155 hf
 		&#47;&#47; phase, start ignoring the sender until we do.
 		if tx.Protected() &amp;&amp; !w.chainConfig.IsEIP155(env.header.Number) {
<span class="term-fg31">-			log.Trace(&quot;Ignoring replay protected transaction&quot;, &quot;hash&quot;, tx.Hash(), &quot;eip155&quot;, w.chainConfig.EIP155Block)</span>
<span class="term-fg32">+			log.Trace(&quot;Ignoring replay protected transaction&quot;, &quot;hash&quot;, ltx.Hash, &quot;eip155&quot;, w.chainConfig.EIP155Block)</span>
 			txs.Pop()
 			continue
 		}
<span class="term-fg31">-</span>
 		&#47;&#47; Start executing the transaction
 		env.state.SetTxContext(tx.Hash(), env.tcount)
&nbsp;
<span class="term-fg36">@@ -841,7 +892,7 @@</span> 		logs, err := w.commitTransaction(env, tx)
 		switch {
 		case errors.Is(err, core.ErrNonceTooLow):
 			&#47;&#47; New head notification data race between the transaction pool and miner, shift
<span class="term-fg31">-			log.Trace(&quot;Skipping transaction with low nonce&quot;, &quot;sender&quot;, from, &quot;nonce&quot;, tx.Nonce())</span>
<span class="term-fg32">+			log.Trace(&quot;Skipping transaction with low nonce&quot;, &quot;hash&quot;, ltx.Hash, &quot;sender&quot;, from, &quot;nonce&quot;, tx.Nonce())</span>
 			txs.Shift()
&nbsp;
 		case errors.Is(err, nil):
<span class="term-fg36">@@ -853,7 +904,7 @@</span>
 		default:
 			&#47;&#47; Transaction is regarded as invalid, drop all consecutive transactions from
 			&#47;&#47; the same sender because of `nonce-too-high` clause.
<span class="term-fg31">-			log.Debug(&quot;Transaction failed, account skipped&quot;, &quot;hash&quot;, tx.Hash(), &quot;err&quot;, err)</span>
<span class="term-fg32">+			log.Debug(&quot;Transaction failed, account skipped&quot;, &quot;hash&quot;, ltx.Hash, &quot;err&quot;, err)</span>
 			txs.Pop()
 		}
 	}
<span class="term-fg36">@@ -885,6 +936,9 @@</span> 	random      common.Hash       &#47;&#47; The randomness generated by beacon chain, empty before the merge
 	withdrawals types.Withdrawals &#47;&#47; List of withdrawals to include in block.
 	beaconRoot  *common.Hash      &#47;&#47; The beacon root (cancun field).
 	noTxs       bool              &#47;&#47; Flag whether an empty block without any transaction is expected
<span class="term-fg32">+</span>
<span class="term-fg32">+	txs      types.Transactions &#47;&#47; Deposit transactions to include at the start of the block</span>
<span class="term-fg32">+	gasLimit *uint64            &#47;&#47; Optional gas limit override</span>
 }
&nbsp;
 &#47;&#47; prepareWork constructs the sealing task according to the given parameters,
<span class="term-fg36">@@ -921,7 +975,7 @@</span> 		Time:       timestamp,
 		Coinbase:   genParams.coinbase,
 	}
 	&#47;&#47; Set the extra field.
<span class="term-fg31">-	if len(w.extra) != 0 {</span>
<span class="term-fg32">+	if len(w.extra) != 0 &amp;&amp; w.chainConfig.Optimism == nil { &#47;&#47; Optimism chains must not set any extra data.</span>
 		header.Extra = w.extra
 	}
 	&#47;&#47; Set the randomness field from the beacon chain if it&#39;s available.
<span class="term-fg36">@@ -936,6 +990,12 @@</span> 			parentGasLimit := parent.GasLimit * w.chainConfig.ElasticityMultiplier()
 			header.GasLimit = core.CalcGasLimit(parentGasLimit, w.config.GasCeil)
 		}
 	}
<span class="term-fg32">+	if genParams.gasLimit != nil { &#47;&#47; override gas limit if specified</span>
<span class="term-fg32">+		header.GasLimit = *genParams.gasLimit</span>
<span class="term-fg32">+	} else if w.chain.Config().Optimism != nil &amp;&amp; w.config.GasCeil != 0 {</span>
<span class="term-fg32">+		&#47;&#47; configure the gas limit of pending blocks with the miner gas limit config when using optimism</span>
<span class="term-fg32">+		header.GasLimit = w.config.GasCeil</span>
<span class="term-fg32">+	}</span>
 	&#47;&#47; Apply EIP-4844, EIP-4788.
 	if w.chainConfig.IsCancun(header.Number, header.Time) {
 		var excessBlobGas uint64
<span class="term-fg36">@@ -963,7 +1023,7 @@</span> 		log.Error(&quot;Failed to create sealing context&quot;, &quot;err&quot;, err)
 		return nil, err
 	}
 	if header.ParentBeaconRoot != nil {
<span class="term-fg31">-		context := core.NewEVMBlockContext(header, w.chain, nil)</span>
<span class="term-fg32">+		context := core.NewEVMBlockContext(header, w.chain, nil, w.chainConfig, env.state)</span>
 		vmenv := vm.NewEVM(context, vm.TxContext{}, env.state, w.chainConfig, vm.Config{})
 		core.ProcessBeaconBlockRoot(*header.ParentBeaconRoot, vmenv, env.state)
 	}
<span class="term-fg36">@@ -1002,14 +1062,30 @@</span> 	return nil
 }
&nbsp;
 &#47;&#47; generateWork generates a sealing block based on the given parameters.
<span class="term-fg31">-func (w *worker) generateWork(params *generateParams) *newPayloadResult {</span>
<span class="term-fg31">-	work, err := w.prepareWork(params)</span>
<span class="term-fg32">+func (w *worker) generateWork(genParams *generateParams) *newPayloadResult {</span>
<span class="term-fg32">+	work, err := w.prepareWork(genParams)</span>
 	if err != nil {
 		return &amp;newPayloadResult{err: err}
 	}
 	defer work.discard()
<span class="term-fg32">+	if work.gasPool == nil {</span>
<span class="term-fg32">+		work.gasPool = new(core.GasPool).AddGas(work.header.GasLimit)</span>
<span class="term-fg32">+	}</span>
&nbsp;
<span class="term-fg31">-	if !params.noTxs {</span>
<span class="term-fg32">+	misc.EnsureCreate2Deployer(w.chainConfig, work.header.Time, work.state)</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	for _, tx := range genParams.txs {</span>
<span class="term-fg32">+		from, _ := types.Sender(work.signer, tx)</span>
<span class="term-fg32">+		work.state.SetTxContext(tx.Hash(), work.tcount)</span>
<span class="term-fg32">+		_, err := w.commitTransaction(work, tx)</span>
<span class="term-fg32">+		if err != nil {</span>
<span class="term-fg32">+			return &amp;newPayloadResult{err: fmt.Errorf(&quot;failed to force-include tx: %s type: %d sender: %s nonce: %d, err: %w&quot;, tx.Hash(), tx.Type(), from, tx.Nonce(), err)}</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+		work.tcount++</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	&#47;&#47; forced transactions done, fill rest of block with transactions</span>
<span class="term-fg32">+	if !genParams.noTxs {</span>
 		interrupt := new(atomic.Int32)
 		timer := time.AfterFunc(w.newpayloadTimeout, func() {
 			interrupt.Store(commitInterruptTimeout)
<span class="term-fg36">@@ -1021,7 +1097,7 @@</span> 		if errors.Is(err, errBlockInterruptedByTimeout) {
 			log.Warn(&quot;Block building is interrupted&quot;, &quot;allowance&quot;, common.PrettyDuration(w.newpayloadTimeout))
 		}
 	}
<span class="term-fg31">-	block, err := w.engine.FinalizeAndAssemble(w.chain, work.header, work.state, work.txs, nil, work.receipts, params.withdrawals)</span>
<span class="term-fg32">+	block, err := w.engine.FinalizeAndAssemble(w.chain, work.header, work.state, work.txs, nil, work.receipts, genParams.withdrawals)</span>
 	if err != nil {
 		return &amp;newPayloadResult{err: err}
 	}</div>
    </div>

            
        </div>
        <div>
            
        </div>
    </div>
</div>

            
                <div class="ps-1 py-2 my-1"><div class="row border-bottom border-1"data-bs-toggle="collapse" data-bs-target="#id-80714fc0bc435c8c37d0db27"role="button" aria-expanded="false" aria-controls="id-80714fc0bc435c8c37d0db27">
        
            <div class="col-12 col-sm-9 text-start"><h3>Tx-pool tx cost updates</h3></div>
        
        <div class="col-12 col-sm-3 ms-auto mt-2">
            <div class="row line-stat">
                <div class="text-end"><span class="text-success">+199</span></div>
                <div class="text-start"><span class="text-danger">-54</span></div>
            </div>
        </div>
    </div>

    <div class="row forkdef-content collapse  border-1 ps-3 my-3" id="id-80714fc0bc435c8c37d0db27">
        <div><p>Transaction queueing and inclusion needs to account for the L1 cost component.</p>
</div>
        <div>
            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-a62c0005aa5fb630309f5a76" role="button"
                   aria-expanded="false" aria-controls="id-a62c0005aa5fb630309f5a76">
                    <code>core/txpool/txpool.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/3f40e65c484486dea6cff80b7db178985d21a2c6/core/txpool/txpool.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/650bb2f2b1dcfe30d9b1fa6f7dc9608055ed60e1/core/txpool/txpool.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+11</span></div>
                        <div class="text-start"><span class="text-danger">-8</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-a62c0005aa5fb630309f5a76"><span class="term-fg1">diff --git go-ethereum&#47;core&#47;txpool&#47;txpool.go op-geth&#47;core&#47;txpool&#47;txpool.go</span>
<span class="term-fg1">index e40b41405454ef7ab3966d02c387c55da4b01733..76b4e7dab89b7c2d35d3ad0e66d0cf168f471e4b 100644</span>
<span class="term-fg1">--- go-ethereum&#47;core&#47;txpool&#47;txpool.go</span>
<span class="term-fg1">+++ op-geth&#47;core&#47;txpool&#47;txpool.go</span>
<span class="term-fg36">@@ -30,6 +30,8 @@</span> 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;log&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;metrics&quot;
 )
&nbsp;
<span class="term-fg32">+type L1CostFunc func(dataGas types.RollupGasData) *big.Int</span>
<span class="term-fg32">+</span>
 &#47;&#47; TxStatus is the current status of a transaction as seen by the pool.
 type TxStatus uint
&nbsp;
<span class="term-fg36">@@ -70,7 +72,7 @@</span>
 	reservations map[common.Address]SubPool &#47;&#47; Map with the account to pool reservations
 	reserveLock  sync.Mutex                 &#47;&#47; Lock protecting the account reservations
&nbsp;
<span class="term-fg31">-	subs event.SubscriptionScope &#47;&#47; Subscription scope to unscubscribe all on shutdown</span>
<span class="term-fg32">+	subs event.SubscriptionScope &#47;&#47; Subscription scope to unsubscribe all on shutdown</span>
 	quit chan chan error         &#47;&#47; Quit channel to tear down the head updater
 }
&nbsp;
<span class="term-fg36">@@ -155,13 +157,15 @@</span> 	p.quit &lt;- errc
 	if err := &lt;-errc; err != nil {
 		errs = append(errs, err)
 	}
<span class="term-fg31">-</span>
 	&#47;&#47; Terminate each subpool
 	for _, subpool := range p.subpools {
 		if err := subpool.Close(); err != nil {
 			errs = append(errs, err)
 		}
 	}
<span class="term-fg32">+	&#47;&#47; Unsubscribe anyone still listening for tx events</span>
<span class="term-fg32">+	p.subs.Close()</span>
<span class="term-fg32">+</span>
 	if len(errs) &gt; 0 {
 		return fmt.Errorf(&quot;subpool close errors: %v&quot;, errs)
 	}
<span class="term-fg36">@@ -205,7 +209,6 @@</span> 						subpool.Reset(oldHead, newHead)
 					}
 					resetDone &lt;- newHead
 				}(oldHead, newHead)
<span class="term-fg31">-</span>
 			default:
 				&#47;&#47; Reset already running, wait until it finishes
 			}
<span class="term-fg36">@@ -316,12 +319,12 @@</span> 	}
 	return txs
 }
&nbsp;
<span class="term-fg31">-&#47;&#47; SubscribeNewTxsEvent registers a subscription of NewTxsEvent and starts sending</span>
<span class="term-fg31">-&#47;&#47; events to the given channel.</span>
<span class="term-fg31">-func (p *TxPool) SubscribeNewTxsEvent(ch chan&lt;- core.NewTxsEvent) event.Subscription {</span>
<span class="term-fg32">+&#47;&#47; SubscribeTransactions registers a subscription for new transaction events,</span>
<span class="term-fg32">+&#47;&#47; supporting feeding only newly seen or also resurrected transactions.</span>
<span class="term-fg32">+func (p *TxPool) SubscribeTransactions(ch chan&lt;- core.NewTxsEvent, reorgs bool) event.Subscription {</span>
 	subs := make([]event.Subscription, len(p.subpools))
 	for i, subpool := range p.subpools {
<span class="term-fg31">-		subs[i] = subpool.SubscribeTransactions(ch)</span>
<span class="term-fg32">+		subs[i] = subpool.SubscribeTransactions(ch, reorgs)</span>
 	}
 	return p.subs.Track(event.JoinSubscriptions(subs...))
 }
<span class="term-fg36">@@ -404,7 +407,7 @@</span> 	return flat
 }
&nbsp;
 &#47;&#47; Status returns the known status (unknown&#47;pending&#47;queued) of a transaction
<span class="term-fg31">-&#47;&#47; identified by their hashes.</span>
<span class="term-fg32">+&#47;&#47; identified by its hash.</span>
 func (p *TxPool) Status(hash common.Hash) TxStatus {
 	for _, subpool := range p.subpools {
 		if status := subpool.Status(hash); status != TxStatusUnknown {</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-b5bf1742c5a6fa32d6dadd8a" role="button"
                   aria-expanded="false" aria-controls="id-b5bf1742c5a6fa32d6dadd8a">
                    <code>core/txpool/validation.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/3f40e65c484486dea6cff80b7db178985d21a2c6/core/txpool/validation.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/650bb2f2b1dcfe30d9b1fa6f7dc9608055ed60e1/core/txpool/validation.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+34</span></div>
                        <div class="text-start"><span class="text-danger">-4</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-b5bf1742c5a6fa32d6dadd8a"><span class="term-fg1">diff --git go-ethereum&#47;core&#47;txpool&#47;validation.go op-geth&#47;core&#47;txpool&#47;validation.go</span>
<span class="term-fg1">index 630d5340cfc4e1d35fc12eae590d56eb588b331f..a708d09ae37169761e733937f2527707b767c7af 100644</span>
<span class="term-fg1">--- go-ethereum&#47;core&#47;txpool&#47;validation.go</span>
<span class="term-fg1">+++ op-geth&#47;core&#47;txpool&#47;validation.go</span>
<span class="term-fg36">@@ -30,6 +30,22 @@</span> 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;log&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;params&quot;
 )
&nbsp;
<span class="term-fg32">+&#47;&#47; L1 Info Gas Overhead is the amount of gas the the L1 info deposit consumes.</span>
<span class="term-fg32">+&#47;&#47; It is removed from the tx pool max gas to better indicate that L2 transactions</span>
<span class="term-fg32">+&#47;&#47; are not able to consume all of the gas in a L2 block as the L1 info deposit is always present.</span>
<span class="term-fg32">+const l1InfoGasOverhead = uint64(70_000)</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func EffectiveGasLimit(chainConfig *params.ChainConfig, gasLimit uint64) uint64 {</span>
<span class="term-fg32">+	if chainConfig.Optimism != nil {</span>
<span class="term-fg32">+		if l1InfoGasOverhead &lt; gasLimit {</span>
<span class="term-fg32">+			gasLimit -= l1InfoGasOverhead</span>
<span class="term-fg32">+		} else {</span>
<span class="term-fg32">+			gasLimit = 0</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	return gasLimit</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
 &#47;&#47; ValidationOptions define certain differences between transaction validation
 &#47;&#47; across the different pools without having to duplicate those checks.
 type ValidationOptions struct {
<span class="term-fg36">@@ -47,6 +63,12 @@</span> &#47;&#47;
 &#47;&#47; This check is public to allow different transaction pools to check the basic
 &#47;&#47; rules without duplicating code and running the risk of missed updates.
 func ValidateTransaction(tx *types.Transaction, head *types.Header, signer types.Signer, opts *ValidationOptions) error {
<span class="term-fg32">+	&#47;&#47; No unauthenticated deposits allowed in the transaction pool.</span>
<span class="term-fg32">+	&#47;&#47; This is for spam protection, not consensus,</span>
<span class="term-fg32">+	&#47;&#47; as the external engine-API user authenticates deposits.</span>
<span class="term-fg32">+	if tx.Type() == types.DepositTxType {</span>
<span class="term-fg32">+		return core.ErrTxTypeNotSupported</span>
<span class="term-fg32">+	}</span>
 	&#47;&#47; Ensure transactions not implemented by the calling pool are rejected
 	if opts.Accept&amp;(1&lt;&lt;tx.Type()) == 0 {
 		return fmt.Errorf(&quot;%w: tx type %v not supported by this pool&quot;, core.ErrTxTypeNotSupported, tx.Type())
<span class="term-fg36">@@ -76,7 +98,7 @@</span> 	if tx.Value().Sign() &lt; 0 {
 		return ErrNegativeValue
 	}
 	&#47;&#47; Ensure the transaction doesn&#39;t exceed the current block limit gas
<span class="term-fg31">-	if head.GasLimit &lt; tx.Gas() {</span>
<span class="term-fg32">+	if EffectiveGasLimit(opts.Config, head.GasLimit) &lt; tx.Gas() {</span>
 		return ErrGasLimit
 	}
 	&#47;&#47; Sanity check for extremely large numbers (supported by RLP or RPC)
<span class="term-fg36">@@ -114,7 +136,7 @@</span> 		sidecar := tx.BlobTxSidecar()
 		if sidecar == nil {
 			return fmt.Errorf(&quot;missing sidecar in blob transaction&quot;)
 		}
<span class="term-fg31">-		&#47;&#47; Ensure the number of items in the blob transaction and vairous side</span>
<span class="term-fg32">+		&#47;&#47; Ensure the number of items in the blob transaction and various side</span>
 		&#47;&#47; data match up before doing any expensive validations
 		hashes := tx.BlobHashes()
 		if len(hashes) == 0 {
<span class="term-fg36">@@ -182,13 +204,16 @@</span> 	&#47;&#47; used and the number still permitted for an account. New transactions will
 	&#47;&#47; be rejected once the number of remaining slots reaches zero.
 	UsedAndLeftSlots func(addr common.Address) (int, int)
&nbsp;
<span class="term-fg31">-	&#47;&#47; ExistingExpenditure is a mandatory callback to retrieve the cummulative</span>
<span class="term-fg32">+	&#47;&#47; ExistingExpenditure is a mandatory callback to retrieve the cumulative</span>
 	&#47;&#47; cost of the already pooled transactions to check for overdrafts.
 	ExistingExpenditure func(addr common.Address) *big.Int
&nbsp;
 	&#47;&#47; ExistingCost is a mandatory callback to retrieve an already pooled
 	&#47;&#47; transaction&#39;s cost with the given nonce to check for overdrafts.
 	ExistingCost func(addr common.Address, nonce uint64) *big.Int
<span class="term-fg32">+</span>
<span class="term-fg32">+	&#47;&#47; L1CostFn is an optional extension, to validate L1 rollup costs of a tx</span>
<span class="term-fg32">+	L1CostFn L1CostFunc</span>
 }
&nbsp;
 &#47;&#47; ValidateTransactionWithState is a helper method to check whether a transaction
<span class="term-fg36">@@ -219,6 +244,11 @@</span> 	var (
 		balance = opts.State.GetBalance(from)
 		cost    = tx.Cost()
 	)
<span class="term-fg32">+	if opts.L1CostFn != nil {</span>
<span class="term-fg32">+		if l1Cost := opts.L1CostFn(tx.RollupDataGas()); l1Cost != nil { &#47;&#47; add rollup cost</span>
<span class="term-fg32">+			cost = cost.Add(cost, l1Cost)</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+	}</span>
 	if balance.Cmp(cost) &lt; 0 {
 		return fmt.Errorf(&quot;%w: balance %v, tx cost %v, overshot %v&quot;, core.ErrInsufficientFunds, balance, cost, new(big.Int).Sub(cost, balance))
 	}
<span class="term-fg36">@@ -237,7 +267,7 @@</span> 		if balance.Cmp(need) &lt; 0 {
 			return fmt.Errorf(&quot;%w: balance %v, queued cost %v, tx cost %v, overshot %v&quot;, core.ErrInsufficientFunds, balance, spent, cost, new(big.Int).Sub(need, balance))
 		}
 		&#47;&#47; Transaction takes a new nonce value out of the pool. Ensure it doesn&#39;t
<span class="term-fg31">-		&#47;&#47; overflow the number of permitted transactions from a single accoun</span>
<span class="term-fg32">+		&#47;&#47; overflow the number of permitted transactions from a single account</span>
 		&#47;&#47; (i.e. max cancellable via out-of-bound transaction).
 		if used, left := opts.UsedAndLeftSlots(from); left &lt;= 0 {
 			return fmt.Errorf(&quot;%w: pooled %d txs&quot;, ErrAccountLimitExceeded, used)</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-5f45c7deaef34ed481f92952" role="button"
                   aria-expanded="false" aria-controls="id-5f45c7deaef34ed481f92952">
                    <code>core/txpool/subpool.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/3f40e65c484486dea6cff80b7db178985d21a2c6/core/txpool/subpool.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/650bb2f2b1dcfe30d9b1fa6f7dc9608055ed60e1/core/txpool/subpool.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+16</span></div>
                        <div class="text-start"><span class="text-danger">-3</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-5f45c7deaef34ed481f92952"><span class="term-fg1">diff --git go-ethereum&#47;core&#47;txpool&#47;subpool.go op-geth&#47;core&#47;txpool&#47;subpool.go</span>
<span class="term-fg1">index 85312c431807ea9b0525f4358f6910220245de03..de05b38d433d6b507991e892d723bb08eb01d4a2 100644</span>
<span class="term-fg1">--- go-ethereum&#47;core&#47;txpool&#47;subpool.go</span>
<span class="term-fg1">+++ op-geth&#47;core&#47;txpool&#47;subpool.go</span>
<span class="term-fg36">@@ -30,13 +30,16 @@</span> &#47;&#47; LazyTransaction contains a small subset of the transaction properties that is
 &#47;&#47; enough for the miner and other APIs to handle large batches of transactions;
 &#47;&#47; and supports pulling up the entire transaction when really needed.
 type LazyTransaction struct {
<span class="term-fg31">-	Pool SubPool            &#47;&#47; Transaction subpool to pull the real transaction up</span>
<span class="term-fg32">+	Pool LazyResolver       &#47;&#47; Transaction resolver to pull the real transaction up</span>
 	Hash common.Hash        &#47;&#47; Transaction hash to pull up if needed
 	Tx   *types.Transaction &#47;&#47; Transaction if already resolved
&nbsp;
 	Time      time.Time &#47;&#47; Time when the transaction was first seen
 	GasFeeCap *big.Int  &#47;&#47; Maximum fee per gas the transaction may consume
 	GasTipCap *big.Int  &#47;&#47; Maximum miner tip per gas the transaction can pay
<span class="term-fg32">+</span>
<span class="term-fg32">+	Gas     uint64 &#47;&#47; Amount of gas required by the transaction</span>
<span class="term-fg32">+	BlobGas uint64 &#47;&#47; Amount of blob gas required by the transaction</span>
 }
&nbsp;
 &#47;&#47; Resolve retrieves the full transaction belonging to a lazy handle if it is still
<span class="term-fg36">@@ -46,6 +49,14 @@</span> 	if ltx.Tx == nil {
 		ltx.Tx = ltx.Pool.Get(ltx.Hash)
 	}
 	return ltx.Tx
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+&#47;&#47; LazyResolver is a minimal interface needed for a transaction pool to satisfy</span>
<span class="term-fg32">+&#47;&#47; resolving lazy transactions. It&#39;s mostly a helper to avoid the entire sub-</span>
<span class="term-fg32">+&#47;&#47; pool being injected into the lazy transaction.</span>
<span class="term-fg32">+type LazyResolver interface {</span>
<span class="term-fg32">+	&#47;&#47; Get returns a transaction if it is contained in the pool, or nil otherwise.</span>
<span class="term-fg32">+	Get(hash common.Hash) *types.Transaction</span>
 }
&nbsp;
 &#47;&#47; AddressReserver is passed by the main transaction pool to subpools, so they
<span class="term-fg36">@@ -99,8 +110,10 @@</span> 	&#47;&#47; Pending retrieves all currently processable transactions, grouped by origin
 	&#47;&#47; account and sorted by nonce.
 	Pending(enforceTips bool) map[common.Address][]*LazyTransaction
&nbsp;
<span class="term-fg31">-	&#47;&#47; SubscribeTransactions subscribes to new transaction events.</span>
<span class="term-fg31">-	SubscribeTransactions(ch chan&lt;- core.NewTxsEvent) event.Subscription</span>
<span class="term-fg32">+	&#47;&#47; SubscribeTransactions subscribes to new transaction events. The subscriber</span>
<span class="term-fg32">+	&#47;&#47; can decide whether to receive notifications only for newly seen transactions</span>
<span class="term-fg32">+	&#47;&#47; or also for reorged out ones.</span>
<span class="term-fg32">+	SubscribeTransactions(ch chan&lt;- core.NewTxsEvent, reorgs bool) event.Subscription</span>
&nbsp;
 	&#47;&#47; Nonce returns the next nonce of an account, with all transactions executable
 	&#47;&#47; by the pool already applied on top.</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-5477fd3b9aaeed556fae3597" role="button"
                   aria-expanded="false" aria-controls="id-5477fd3b9aaeed556fae3597">
                    <code>core/txpool/errors.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/3f40e65c484486dea6cff80b7db178985d21a2c6/core/txpool/errors.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/650bb2f2b1dcfe30d9b1fa6f7dc9608055ed60e1/core/txpool/errors.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+1</span></div>
                        <div class="text-start"><span class="text-danger">-1</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-5477fd3b9aaeed556fae3597"><span class="term-fg1">diff --git go-ethereum&#47;core&#47;txpool&#47;errors.go op-geth&#47;core&#47;txpool&#47;errors.go</span>
<span class="term-fg1">index bc26550f78ca27a90e41286f77d1dfe3d1a774b1..61daa999ffdc0d0c1631d9d3a5e62071a6265541 100644</span>
<span class="term-fg1">--- go-ethereum&#47;core&#47;txpool&#47;errors.go</span>
<span class="term-fg1">+++ op-geth&#47;core&#47;txpool&#47;errors.go</span>
<span class="term-fg36">@@ -52,6 +52,6 @@</span> 	&#47;&#47; making the transaction invalid, rather a DOS protection.
 	ErrOversizedData = errors.New(&quot;oversized data&quot;)
&nbsp;
 	&#47;&#47; ErrFutureReplacePending is returned if a future transaction replaces a pending
<span class="term-fg31">-	&#47;&#47; transaction. Future transactions should only be able to replace other future transactions.</span>
<span class="term-fg32">+	&#47;&#47; one. Future transactions should only be able to replace other future transactions.</span>
 	ErrFutureReplacePending = errors.New(&quot;future transaction tries to replace pending&quot;)
 )</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-45e7a45ca8d85beae1a4228e" role="button"
                   aria-expanded="false" aria-controls="id-45e7a45ca8d85beae1a4228e">
                    <code>core/txpool/legacypool/legacypool_test.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/3f40e65c484486dea6cff80b7db178985d21a2c6/core/txpool/legacypool/legacypool_test.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/650bb2f2b1dcfe30d9b1fa6f7dc9608055ed60e1/core/txpool/legacypool/legacypool_test.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+21</span></div>
                        <div class="text-start"><span class="text-danger">-7</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-45e7a45ca8d85beae1a4228e"><span class="term-fg1">diff --git go-ethereum&#47;core&#47;txpool&#47;legacypool&#47;legacypool_test.go op-geth&#47;core&#47;txpool&#47;legacypool&#47;legacypool_test.go</span>
<span class="term-fg1">index a8f3dd7d862476416ea6e41e026143f8eae3f46f..43dfeee92c2a6ec279b270faa353589df6a6da9c 100644</span>
<span class="term-fg1">--- go-ethereum&#47;core&#47;txpool&#47;legacypool&#47;legacypool_test.go</span>
<span class="term-fg1">+++ op-geth&#47;core&#47;txpool&#47;legacypool&#47;legacypool_test.go</span>
<span class="term-fg36">@@ -2301,10 +2301,13 @@</span> }
&nbsp;
 &#47;&#47; Tests that local transactions are journaled to disk, but remote transactions
 &#47;&#47; get discarded between restarts.
<span class="term-fg31">-func TestJournaling(t *testing.T)         { testJournaling(t, false) }</span>
<span class="term-fg31">-func TestJournalingNoLocals(t *testing.T) { testJournaling(t, true) }</span>
<span class="term-fg32">+func TestJournaling(t *testing.T)         { testJournaling(t, false, false) }</span>
<span class="term-fg32">+func TestJournalingNoLocals(t *testing.T) { testJournaling(t, true, false) }</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func TestJournalingRemotes(t *testing.T)         { testJournaling(t, false, true) }</span>
<span class="term-fg32">+func TestJournalingRemotesNoLocals(t *testing.T) { testJournaling(t, true, true) }</span>
&nbsp;
<span class="term-fg31">-func testJournaling(t *testing.T, nolocals bool) {</span>
<span class="term-fg32">+func testJournaling(t *testing.T, nolocals bool, journalRemotes bool) {</span>
 	t.Parallel()
&nbsp;
 	&#47;&#47; Create a temporary file for the journal
<span class="term-fg36">@@ -2325,6 +2328,7 @@</span> 	blockchain := newTestBlockChain(params.TestChainConfig, 1000000, statedb, new(event.Feed))
&nbsp;
 	config := testTxPoolConfig
 	config.NoLocals = nolocals
<span class="term-fg32">+	config.JournalRemote = journalRemotes</span>
 	config.Journal = journal
 	config.Rejournal = time.Second
&nbsp;
<span class="term-fg36">@@ -2373,10 +2377,14 @@</span> 	pending, queued = pool.Stats()
 	if queued != 0 {
 		t.Fatalf(&quot;queued transactions mismatched: have %d, want %d&quot;, queued, 0)
 	}
<span class="term-fg31">-	if nolocals {</span>
<span class="term-fg32">+	if nolocals &amp;&amp; !journalRemotes {</span>
 		if pending != 0 {
 			t.Fatalf(&quot;pending transactions mismatched: have %d, want %d&quot;, pending, 0)
 		}
<span class="term-fg32">+	} else if journalRemotes {</span>
<span class="term-fg32">+		if pending != 3 {</span>
<span class="term-fg32">+			t.Fatalf(&quot;pending transactions mismatched: have %d, want %d&quot;, pending, 3)</span>
<span class="term-fg32">+		}</span>
 	} else {
 		if pending != 2 {
 			t.Fatalf(&quot;pending transactions mismatched: have %d, want %d&quot;, pending, 2)
<span class="term-fg36">@@ -2397,10 +2405,16 @@</span> 	pool = New(config, blockchain)
 	pool.Init(new(big.Int).SetUint64(config.PriceLimit), blockchain.CurrentBlock(), makeAddressReserver())
&nbsp;
 	pending, queued = pool.Stats()
<span class="term-fg31">-	if pending != 0 {</span>
<span class="term-fg31">-		t.Fatalf(&quot;pending transactions mismatched: have %d, want %d&quot;, pending, 0)</span>
<span class="term-fg32">+	if journalRemotes {</span>
<span class="term-fg32">+		if pending != 1 { &#47;&#47; Remove the 2 replaced local transactions, but preserve the remote</span>
<span class="term-fg32">+			t.Fatalf(&quot;pending transactions mismatched: have %d, want %d&quot;, pending, 1)</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+	} else {</span>
<span class="term-fg32">+		if pending != 0 {</span>
<span class="term-fg32">+			t.Fatalf(&quot;pending transactions mismatched: have %d, want %d&quot;, pending, 0)</span>
<span class="term-fg32">+		}</span>
 	}
<span class="term-fg31">-	if nolocals {</span>
<span class="term-fg32">+	if nolocals &amp;&amp; !journalRemotes {</span>
 		if queued != 0 {
 			t.Fatalf(&quot;queued transactions mismatched: have %d, want %d&quot;, queued, 0)
 		}</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-98b3c2eee91e6d37e05200b7" role="button"
                   aria-expanded="false" aria-controls="id-98b3c2eee91e6d37e05200b7">
                    <code>core/txpool/legacypool/list.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/3f40e65c484486dea6cff80b7db178985d21a2c6/core/txpool/legacypool/list.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/650bb2f2b1dcfe30d9b1fa6f7dc9608055ed60e1/core/txpool/legacypool/list.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+18</span></div>
                        <div class="text-start"><span class="text-danger">-3</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-98b3c2eee91e6d37e05200b7"><span class="term-fg1">diff --git go-ethereum&#47;core&#47;txpool&#47;legacypool&#47;list.go op-geth&#47;core&#47;txpool&#47;legacypool&#47;list.go</span>
<span class="term-fg1">index 384fa7b61bad3fc089b8f90fd3dac0feffe1215f..c61f7a0f8c1f1883f64ed4ffd41d50934cc3ae09 100644</span>
<span class="term-fg1">--- go-ethereum&#47;core&#47;txpool&#47;legacypool&#47;list.go</span>
<span class="term-fg1">+++ op-geth&#47;core&#47;txpool&#47;legacypool&#47;list.go</span>
<span class="term-fg36">@@ -26,6 +26,7 @@</span> 	&quot;sync&#47;atomic&quot;
 	&quot;time&quot;
&nbsp;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;common&quot;
<span class="term-fg32">+	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;core&#47;txpool&quot;</span>
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;core&#47;types&quot;
 )
&nbsp;
<span class="term-fg36">@@ -205,7 +206,7 @@</span> &#47;&#47; provided nonce that is ready for processing. The returned transactions will be
 &#47;&#47; removed from the list.
 &#47;&#47;
 &#47;&#47; Note, all transactions with nonces lower than start will also be returned to
<span class="term-fg31">-&#47;&#47; prevent getting into and invalid state. This is not something that should ever</span>
<span class="term-fg32">+&#47;&#47; prevent getting into an invalid state. This is not something that should ever</span>
 &#47;&#47; happen but better to be self correcting than failing!
 func (m *sortedMap) Ready(start uint64) types.Transactions {
 	&#47;&#47; Short circuit if no transactions are available
<span class="term-fg36">@@ -263,6 +264,15 @@</span> 	cache := m.flatten()
 	return cache[len(cache)-1]
 }
&nbsp;
<span class="term-fg32">+&#47;&#47; FirstElement returns the first element from the heap (guaranteed to be lowest), thus, the</span>
<span class="term-fg32">+&#47;&#47; transaction with the lowest nonce. Returns nil if there are no elements.</span>
<span class="term-fg32">+func (m *sortedMap) FirstElement() *types.Transaction {</span>
<span class="term-fg32">+	if m.Len() == 0 {</span>
<span class="term-fg32">+		return nil</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	return m.Get((*m.index)[0])</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
 &#47;&#47; list is a &quot;list&quot; of transactions belonging to an account, sorted by account
 &#47;&#47; nonce. The same type can be used both for storing contiguous transactions for
 &#47;&#47; the executable&#47;pending queue; and for storing gapped transactions for the non-
<span class="term-fg36">@@ -298,7 +308,7 @@</span> &#47;&#47; transaction was accepted, and if yes, any previous transaction it replaced.
 &#47;&#47;
 &#47;&#47; If the new transaction is accepted into the list, the lists&#39; cost and gas
 &#47;&#47; thresholds are also potentially updated.
<span class="term-fg31">-func (l *list) Add(tx *types.Transaction, priceBump uint64) (bool, *types.Transaction) {</span>
<span class="term-fg32">+func (l *list) Add(tx *types.Transaction, priceBump uint64, l1CostFn txpool.L1CostFunc) (bool, *types.Transaction) {</span>
 	&#47;&#47; If there&#39;s an older better transaction, abort
 	old := l.txs.Get(tx.Nonce())
 	if old != nil {
<span class="term-fg36">@@ -326,6 +336,11 @@</span> 		l.subTotalCost([]*types.Transaction{old})
 	}
 	&#47;&#47; Add new tx cost to totalcost
 	l.totalcost.Add(l.totalcost, tx.Cost())
<span class="term-fg32">+	if l1CostFn != nil {</span>
<span class="term-fg32">+		if l1Cost := l1CostFn(tx.RollupDataGas()); l1Cost != nil { &#47;&#47; add rollup cost</span>
<span class="term-fg32">+			l.totalcost.Add(l.totalcost, l1Cost)</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+	}</span>
 	&#47;&#47; Otherwise overwrite the old transaction with the current one
 	l.txs.Put(tx)
 	if cost := tx.Cost(); l.costcap.Cmp(cost) &lt; 0 {
<span class="term-fg36">@@ -421,7 +436,7 @@</span> &#47;&#47; provided nonce that is ready for processing. The returned transactions will be
 &#47;&#47; removed from the list.
 &#47;&#47;
 &#47;&#47; Note, all transactions with nonces lower than start will also be returned to
<span class="term-fg31">-&#47;&#47; prevent getting into and invalid state. This is not something that should ever</span>
<span class="term-fg32">+&#47;&#47; prevent getting into an invalid state. This is not something that should ever</span>
 &#47;&#47; happen but better to be self correcting than failing!
 func (l *list) Ready(start uint64) types.Transactions {
 	txs := l.txs.Ready(start)</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-79e14bbefa560dae7042fe2c" role="button"
                   aria-expanded="false" aria-controls="id-79e14bbefa560dae7042fe2c">
                    <code>core/txpool/legacypool/list_test.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/3f40e65c484486dea6cff80b7db178985d21a2c6/core/txpool/legacypool/list_test.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/650bb2f2b1dcfe30d9b1fa6f7dc9608055ed60e1/core/txpool/legacypool/list_test.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+2</span></div>
                        <div class="text-start"><span class="text-danger">-2</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-79e14bbefa560dae7042fe2c"><span class="term-fg1">diff --git go-ethereum&#47;core&#47;txpool&#47;legacypool&#47;list_test.go op-geth&#47;core&#47;txpool&#47;legacypool&#47;list_test.go</span>
<span class="term-fg1">index b5cd34b23b622425518f8fcd1a9896eb5a4ec021..b1f6ec305d575c8e7e0d6bc1d84fcedcfaf7d28e 100644</span>
<span class="term-fg1">--- go-ethereum&#47;core&#47;txpool&#47;legacypool&#47;list_test.go</span>
<span class="term-fg1">+++ op-geth&#47;core&#47;txpool&#47;legacypool&#47;list_test.go</span>
<span class="term-fg36">@@ -38,7 +38,7 @@</span> 	}
 	&#47;&#47; Insert the transactions in a random order
 	list := newList(true)
 	for _, v := range rand.Perm(len(txs)) {
<span class="term-fg31">-		list.Add(txs[v], DefaultConfig.PriceBump)</span>
<span class="term-fg32">+		list.Add(txs[v], DefaultConfig.PriceBump, nil)</span>
 	}
 	&#47;&#47; Verify internal state
 	if len(list.txs.items) != len(txs) {
<span class="term-fg36">@@ -65,7 +65,7 @@</span> 	b.ResetTimer()
 	for i := 0; i &lt; b.N; i++ {
 		list := newList(true)
 		for _, v := range rand.Perm(len(txs)) {
<span class="term-fg31">-			list.Add(txs[v], DefaultConfig.PriceBump)</span>
<span class="term-fg32">+			list.Add(txs[v], DefaultConfig.PriceBump, nil)</span>
 			list.Filter(priceLimit, DefaultConfig.PriceBump)
 		}
 	}</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-2294142a7f4e62f9b935895a" role="button"
                   aria-expanded="false" aria-controls="id-2294142a7f4e62f9b935895a">
                    <code>core/txpool/legacypool/legacypool.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/3f40e65c484486dea6cff80b7db178985d21a2c6/core/txpool/legacypool/legacypool.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/650bb2f2b1dcfe30d9b1fa6f7dc9608055ed60e1/core/txpool/legacypool/legacypool.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+96</span></div>
                        <div class="text-start"><span class="text-danger">-26</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-2294142a7f4e62f9b935895a"><span class="term-fg1">diff --git go-ethereum&#47;core&#47;txpool&#47;legacypool&#47;legacypool.go op-geth&#47;core&#47;txpool&#47;legacypool&#47;legacypool.go</span>
<span class="term-fg1">index 00e326c4b87fec124e93feb62149bcad5445552e..652043ec11ed13f33220240cb0c32019cfc0ec7c 100644</span>
<span class="term-fg1">--- go-ethereum&#47;core&#47;txpool&#47;legacypool&#47;legacypool.go</span>
<span class="term-fg1">+++ op-geth&#47;core&#47;txpool&#47;legacypool&#47;legacypool.go</span>
<span class="term-fg36">@@ -129,6 +129,10 @@</span> 	NoLocals  bool             &#47;&#47; Whether local transaction handling should be disabled
 	Journal   string           &#47;&#47; Journal of local transactions to survive node restarts
 	Rejournal time.Duration    &#47;&#47; Time interval to regenerate the local transaction journal
&nbsp;
<span class="term-fg32">+	&#47;&#47; JournalRemote controls whether journaling includes remote transactions or not.</span>
<span class="term-fg32">+	&#47;&#47; When true, all transactions loaded from the journal are treated as remote.</span>
<span class="term-fg32">+	JournalRemote bool</span>
<span class="term-fg32">+</span>
 	PriceLimit uint64 &#47;&#47; Minimum gas price to enforce for acceptance into the pool
 	PriceBump  uint64 &#47;&#47; Minimum price bump percentage to replace an already existing transaction (nonce)
&nbsp;
<span class="term-fg36">@@ -208,7 +212,6 @@</span> 	chainconfig *params.ChainConfig
 	chain       BlockChain
 	gasTip      atomic.Pointer[big.Int]
 	txFeed      event.Feed
<span class="term-fg31">-	scope       event.SubscriptionScope</span>
 	signer      types.Signer
 	mu          sync.RWMutex
&nbsp;
<span class="term-fg36">@@ -235,6 +238,8 @@</span> 	wg              sync.WaitGroup &#47;&#47; tracks loop, scheduleReorgLoop
 	initDoneCh      chan struct{}  &#47;&#47; is closed once the pool is initialized (for tests)
&nbsp;
 	changesSinceReorg int &#47;&#47; A counter for how many drops we&#39;ve performed in-between reorg.
<span class="term-fg32">+</span>
<span class="term-fg32">+	l1CostFn txpool.L1CostFunc &#47;&#47; To apply L1 costs as rollup, optional field, may be nil.</span>
 }
&nbsp;
 type txpoolResetRequest struct {
<span class="term-fg36">@@ -271,7 +276,7 @@</span> 		pool.locals.add(addr)
 	}
 	pool.priced = newPricedList(pool.all)
&nbsp;
<span class="term-fg31">-	if !config.NoLocals &amp;&amp; config.Journal != &quot;&quot; {</span>
<span class="term-fg32">+	if (!config.NoLocals || config.JournalRemote) &amp;&amp; config.Journal != &quot;&quot; {</span>
 		pool.journal = newTxJournal(config.Journal)
 	}
 	return pool
<span class="term-fg36">@@ -298,7 +303,20 @@</span> 	pool.reserve = reserve
&nbsp;
 	&#47;&#47; Set the basic pool parameters
 	pool.gasTip.Store(gasTip)
<span class="term-fg31">-	pool.reset(nil, head)</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	&#47;&#47; Initialize the state with head block, or fallback to empty one in</span>
<span class="term-fg32">+	&#47;&#47; case the head state is not available(might occur when node is not</span>
<span class="term-fg32">+	&#47;&#47; fully synced).</span>
<span class="term-fg32">+	statedb, err := pool.chain.StateAt(head.Root)</span>
<span class="term-fg32">+	if err != nil {</span>
<span class="term-fg32">+		statedb, err = pool.chain.StateAt(types.EmptyRootHash)</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	if err != nil {</span>
<span class="term-fg32">+		return err</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	pool.currentHead.Store(head)</span>
<span class="term-fg32">+	pool.currentState = statedb</span>
<span class="term-fg32">+	pool.pendingNonces = newNoncer(statedb)</span>
&nbsp;
 	&#47;&#47; Start the reorg loop early, so it can handle requests generated during
 	&#47;&#47; journal loading.
<span class="term-fg36">@@ -307,10 +325,14 @@</span> 	go pool.scheduleReorgLoop()
&nbsp;
 	&#47;&#47; If local transactions and journaling is enabled, load from disk
 	if pool.journal != nil {
<span class="term-fg31">-		if err := pool.journal.load(pool.addLocals); err != nil {</span>
<span class="term-fg32">+		add := pool.addLocals</span>
<span class="term-fg32">+		if pool.config.JournalRemote {</span>
<span class="term-fg32">+			add = pool.addRemotesSync &#47;&#47; Use sync version to match pool.AddLocals</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+		if err := pool.journal.load(add); err != nil {</span>
 			log.Warn(&quot;Failed to load transaction journal&quot;, &quot;err&quot;, err)
 		}
<span class="term-fg31">-		if err := pool.journal.rotate(pool.local()); err != nil {</span>
<span class="term-fg32">+		if err := pool.journal.rotate(pool.toJournal()); err != nil {</span>
 			log.Warn(&quot;Failed to rotate transaction journal&quot;, &quot;err&quot;, err)
 		}
 	}
<span class="term-fg36">@@ -380,7 +402,7 @@</span> 		&#47;&#47; Handle local transaction journal rotation
 		case &lt;-journal.C:
 			if pool.journal != nil {
 				pool.mu.Lock()
<span class="term-fg31">-				if err := pool.journal.rotate(pool.local()); err != nil {</span>
<span class="term-fg32">+				if err := pool.journal.rotate(pool.toJournal()); err != nil {</span>
 					log.Warn(&quot;Failed to rotate local tx journal&quot;, &quot;err&quot;, err)
 				}
 				pool.mu.Unlock()
<span class="term-fg36">@@ -391,9 +413,6 @@</span> }
&nbsp;
 &#47;&#47; Close terminates the transaction pool.
 func (pool *LegacyPool) Close() error {
<span class="term-fg31">-	&#47;&#47; Unsubscribe all subscriptions registered from txpool</span>
<span class="term-fg31">-	pool.scope.Close()</span>
<span class="term-fg31">-</span>
 	&#47;&#47; Terminate the pool reorger and return
 	close(pool.reorgShutdownCh)
 	pool.wg.Wait()
<span class="term-fg36">@@ -406,16 +425,20 @@</span> 	return nil
 }
&nbsp;
 &#47;&#47; Reset implements txpool.SubPool, allowing the legacy pool&#39;s internal state to be
<span class="term-fg31">-&#47;&#47; kept in sync with the main transacion pool&#39;s internal state.</span>
<span class="term-fg32">+&#47;&#47; kept in sync with the main transaction pool&#39;s internal state.</span>
 func (pool *LegacyPool) Reset(oldHead, newHead *types.Header) {
 	wait := pool.requestReset(oldHead, newHead)
 	&lt;-wait
 }
&nbsp;
<span class="term-fg31">-&#47;&#47; SubscribeTransactions registers a subscription of NewTxsEvent and</span>
<span class="term-fg31">-&#47;&#47; starts sending event to the given channel.</span>
<span class="term-fg31">-func (pool *LegacyPool) SubscribeTransactions(ch chan&lt;- core.NewTxsEvent) event.Subscription {</span>
<span class="term-fg31">-	return pool.scope.Track(pool.txFeed.Subscribe(ch))</span>
<span class="term-fg32">+&#47;&#47; SubscribeTransactions registers a subscription for new transaction events,</span>
<span class="term-fg32">+&#47;&#47; supporting feeding only newly seen or also resurrected transactions.</span>
<span class="term-fg32">+func (pool *LegacyPool) SubscribeTransactions(ch chan&lt;- core.NewTxsEvent, reorgs bool) event.Subscription {</span>
<span class="term-fg32">+	&#47;&#47; The legacy pool has a very messed up internal shuffling, so it&#39;s kind of</span>
<span class="term-fg32">+	&#47;&#47; hard to separate newly discovered transaction from resurrected ones. This</span>
<span class="term-fg32">+	&#47;&#47; is because the new txs are added to the queue, resurrected ones too and</span>
<span class="term-fg32">+	&#47;&#47; reorgs run lazily, so separating the two would need a marker.</span>
<span class="term-fg32">+	return pool.txFeed.Subscribe(ch)</span>
 }
&nbsp;
 &#47;&#47; SetGasTip updates the minimum gas tip required by the transaction pool for a
<span class="term-fg36">@@ -539,6 +562,8 @@</span> 					Tx:        txs[i],
 					Time:      txs[i].Time(),
 					GasFeeCap: txs[i].GasFeeCap(),
 					GasTipCap: txs[i].GasTipCap(),
<span class="term-fg32">+					Gas:       txs[i].Gas(),</span>
<span class="term-fg32">+					BlobGas:   txs[i].BlobGas(),</span>
 				}
 			}
 			pending[addr] = lazies
<span class="term-fg36">@@ -555,6 +580,23 @@</span>
 	return pool.locals.flatten()
 }
&nbsp;
<span class="term-fg32">+&#47;&#47; toJournal retrieves all transactions that should be included in the journal,</span>
<span class="term-fg32">+&#47;&#47; grouped by origin account and sorted by nonce.</span>
<span class="term-fg32">+&#47;&#47; The returned transaction set is a copy and can be freely modified by calling code.</span>
<span class="term-fg32">+func (pool *LegacyPool) toJournal() map[common.Address]types.Transactions {</span>
<span class="term-fg32">+	if !pool.config.JournalRemote {</span>
<span class="term-fg32">+		return pool.local()</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	txs := make(map[common.Address]types.Transactions)</span>
<span class="term-fg32">+	for addr, pending := range pool.pending {</span>
<span class="term-fg32">+		txs[addr] = append(txs[addr], pending.Flatten()...)</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	for addr, queued := range pool.queue {</span>
<span class="term-fg32">+		txs[addr] = append(txs[addr], queued.Flatten()...)</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	return txs</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
 &#47;&#47; local retrieves all currently known local transactions, grouped by origin
 &#47;&#47; account and sorted by nonce. The returned transaction set is a copy and can be
 &#47;&#47; freely modified by calling code.
<span class="term-fg36">@@ -620,11 +662,18 @@</span> 		},
 		ExistingCost: func(addr common.Address, nonce uint64) *big.Int {
 			if list := pool.pending[addr]; list != nil {
 				if tx := list.txs.Get(nonce); tx != nil {
<span class="term-fg31">-					return tx.Cost()</span>
<span class="term-fg32">+					cost := tx.Cost()</span>
<span class="term-fg32">+					if pool.l1CostFn != nil {</span>
<span class="term-fg32">+						if l1Cost := pool.l1CostFn(tx.RollupDataGas()); l1Cost != nil { &#47;&#47; add rollup cost</span>
<span class="term-fg32">+							cost = cost.Add(cost, l1Cost)</span>
<span class="term-fg32">+						}</span>
<span class="term-fg32">+					}</span>
<span class="term-fg32">+					return cost</span>
 				}
 			}
 			return nil
 		},
<span class="term-fg32">+		L1CostFn: pool.l1CostFn,</span>
 	}
 	if err := txpool.ValidateTransactionWithState(tx, pool.signer, opts); err != nil {
 		return err
<span class="term-fg36">@@ -637,7 +686,7 @@</span> &#47;&#47; pending promotion and execution. If the transaction is a replacement for an already
 &#47;&#47; pending or queued one, it overwrites the previous transaction if its price is higher.
 &#47;&#47;
 &#47;&#47; If a newly added transaction is marked as local, its sending account will be
<span class="term-fg31">-&#47;&#47; be added to the allowlist, preventing any associated transaction from being dropped</span>
<span class="term-fg32">+&#47;&#47; added to the allowlist, preventing any associated transaction from being dropped</span>
 &#47;&#47; out of the pool due to pricing constraints.
 func (pool *LegacyPool) add(tx *types.Transaction, local bool) (replaced bool, err error) {
 	&#47;&#47; If the transaction is already known, discard it
<span class="term-fg36">@@ -747,7 +796,7 @@</span>
 	&#47;&#47; Try to replace an existing transaction in the pending pool
 	if list := pool.pending[from]; list != nil &amp;&amp; list.Contains(tx.Nonce()) {
 		&#47;&#47; Nonce already pending, check if required price bump is met
<span class="term-fg31">-		inserted, old := list.Add(tx, pool.config.PriceBump)</span>
<span class="term-fg32">+		inserted, old := list.Add(tx, pool.config.PriceBump, pool.l1CostFn)</span>
 		if !inserted {
 			pendingDiscardMeter.Mark(1)
 			return false, txpool.ErrReplaceUnderpriced
<span class="term-fg36">@@ -821,7 +870,7 @@</span> 	from, _ := types.Sender(pool.signer, tx) &#47;&#47; already validated
 	if pool.queue[from] == nil {
 		pool.queue[from] = newList(false)
 	}
<span class="term-fg31">-	inserted, old := pool.queue[from].Add(tx, pool.config.PriceBump)</span>
<span class="term-fg32">+	inserted, old := pool.queue[from].Add(tx, pool.config.PriceBump, pool.l1CostFn)</span>
 	if !inserted {
 		&#47;&#47; An older transaction was better, discard this
 		queuedDiscardMeter.Mark(1)
<span class="term-fg36">@@ -856,7 +905,7 @@</span> &#47;&#47; journalTx adds the specified transaction to the local disk journal if it is
 &#47;&#47; deemed to have been sent from a local account.
 func (pool *LegacyPool) journalTx(from common.Address, tx *types.Transaction) {
 	&#47;&#47; Only journal if it&#39;s enabled and the transaction is local
<span class="term-fg31">-	if pool.journal == nil || !pool.locals.contains(from) {</span>
<span class="term-fg32">+	if pool.journal == nil || (!pool.config.JournalRemote &amp;&amp; !pool.locals.contains(from)) {</span>
 		return
 	}
 	if err := pool.journal.insert(tx); err != nil {
<span class="term-fg36">@@ -875,7 +924,7 @@</span> 		pool.pending[addr] = newList(true)
 	}
 	list := pool.pending[addr]
&nbsp;
<span class="term-fg31">-	inserted, old := list.Add(tx, pool.config.PriceBump)</span>
<span class="term-fg32">+	inserted, old := list.Add(tx, pool.config.PriceBump, pool.l1CostFn)</span>
 	if !inserted {
 		&#47;&#47; An older transaction was better, discard this
 		pool.all.Remove(hash)
<span class="term-fg36">@@ -901,7 +950,7 @@</span> 	return true
 }
&nbsp;
 &#47;&#47; addLocals enqueues a batch of transactions into the pool if they are valid, marking the
<span class="term-fg31">-&#47;&#47; senders as a local ones, ensuring they go around the local pricing constraints.</span>
<span class="term-fg32">+&#47;&#47; senders as local ones, ensuring they go around the local pricing constraints.</span>
 &#47;&#47;
 &#47;&#47; This method is used to add transactions from the RPC API and performs synchronous pool
 &#47;&#47; reorganization and event propagation.
<span class="term-fg36">@@ -943,7 +992,7 @@</span> 	return pool.Add([]*types.Transaction{tx}, false, true)[0]
 }
&nbsp;
 &#47;&#47; Add enqueues a batch of transactions into the pool if they are valid. Depending
<span class="term-fg31">-&#47;&#47; on the local flag, full pricing contraints will or will not be applied.</span>
<span class="term-fg32">+&#47;&#47; on the local flag, full pricing constraints will or will not be applied.</span>
 &#47;&#47;
 &#47;&#47; If sync is set, the method will block until all internal maintenance related
 &#47;&#47; to the add is finished. Only use this during tests for determinism!
<span class="term-fg36">@@ -1400,6 +1449,11 @@</span> 	pool.currentHead.Store(newHead)
 	pool.currentState = statedb
 	pool.pendingNonces = newNoncer(statedb)
&nbsp;
<span class="term-fg32">+	costFn := types.NewL1CostFunc(pool.chainconfig, statedb)</span>
<span class="term-fg32">+	pool.l1CostFn = func(dataGas types.RollupGasData) *big.Int {</span>
<span class="term-fg32">+		return costFn(newHead.Number.Uint64(), newHead.Time, dataGas, false)</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+</span>
 	&#47;&#47; Inject any transactions discarded due to reorgs
 	log.Debug(&quot;Reinjecting stale transactions&quot;, &quot;count&quot;, len(reinject))
 	core.SenderCacher.Recover(pool.signer, reinject)
<span class="term-fg36">@@ -1414,7 +1468,7 @@</span> 	&#47;&#47; Track the promoted transactions to broadcast them at once
 	var promoted []*types.Transaction
&nbsp;
 	&#47;&#47; Iterate over all accounts and promote any executable transactions
<span class="term-fg31">-	gasLimit := pool.currentHead.Load().GasLimit</span>
<span class="term-fg32">+	gasLimit := txpool.EffectiveGasLimit(pool.chainconfig, pool.currentHead.Load().GasLimit)</span>
 	for _, addr := range accounts {
 		list := pool.queue[addr]
 		if list == nil {
<span class="term-fg36">@@ -1427,8 +1481,16 @@</span> 			hash := tx.Hash()
 			pool.all.Remove(hash)
 		}
 		log.Trace(&quot;Removed old queued transactions&quot;, &quot;count&quot;, len(forwards))
<span class="term-fg32">+		balance := pool.currentState.GetBalance(addr)</span>
<span class="term-fg32">+		if !list.Empty() &amp;&amp; pool.l1CostFn != nil {</span>
<span class="term-fg32">+			&#47;&#47; Reduce the cost-cap by L1 rollup cost of the first tx if necessary. Other txs will get filtered out afterwards.</span>
<span class="term-fg32">+			el := list.txs.FirstElement()</span>
<span class="term-fg32">+			if l1Cost := pool.l1CostFn(el.RollupDataGas()); l1Cost != nil {</span>
<span class="term-fg32">+				balance = new(big.Int).Sub(balance, l1Cost) &#47;&#47; negative big int is fine</span>
<span class="term-fg32">+			}</span>
<span class="term-fg32">+		}</span>
 		&#47;&#47; Drop all transactions that are too costly (low balance or out of gas)
<span class="term-fg31">-		drops, _ := list.Filter(pool.currentState.GetBalance(addr), gasLimit)</span>
<span class="term-fg32">+		drops, _ := list.Filter(balance, gasLimit)</span>
 		for _, tx := range drops {
 			hash := tx.Hash()
 			pool.all.Remove(hash)
<span class="term-fg36">@@ -1617,7 +1679,7 @@</span> &#47;&#47; is always explicitly triggered by SetBaseFee and it would be unnecessary and wasteful
 &#47;&#47; to trigger a re-heap is this function
 func (pool *LegacyPool) demoteUnexecutables() {
 	&#47;&#47; Iterate over all accounts and demote any non-executable transactions
<span class="term-fg31">-	gasLimit := pool.currentHead.Load().GasLimit</span>
<span class="term-fg32">+	gasLimit := txpool.EffectiveGasLimit(pool.chainconfig, pool.currentHead.Load().GasLimit)</span>
 	for addr, list := range pool.pending {
 		nonce := pool.currentState.GetNonce(addr)
&nbsp;
<span class="term-fg36">@@ -1628,8 +1690,16 @@</span> 			hash := tx.Hash()
 			pool.all.Remove(hash)
 			log.Trace(&quot;Removed old pending transaction&quot;, &quot;hash&quot;, hash)
 		}
<span class="term-fg32">+		balance := pool.currentState.GetBalance(addr)</span>
<span class="term-fg32">+		if !list.Empty() &amp;&amp; pool.l1CostFn != nil {</span>
<span class="term-fg32">+			&#47;&#47; Reduce the cost-cap by L1 rollup cost of the first tx if necessary. Other txs will get filtered out afterwards.</span>
<span class="term-fg32">+			el := list.txs.FirstElement()</span>
<span class="term-fg32">+			if l1Cost := pool.l1CostFn(el.RollupDataGas()); l1Cost != nil {</span>
<span class="term-fg32">+				balance = new(big.Int).Sub(balance, l1Cost) &#47;&#47; negative big int is fine</span>
<span class="term-fg32">+			}</span>
<span class="term-fg32">+		}</span>
 		&#47;&#47; Drop all transactions that are too costly (low balance or out of gas), and queue any invalids back for later
<span class="term-fg31">-		drops, invalids := list.Filter(pool.currentState.GetBalance(addr), gasLimit)</span>
<span class="term-fg32">+		drops, invalids := list.Filter(balance, gasLimit)</span>
 		for _, tx := range drops {
 			hash := tx.Hash()
 			log.Trace(&quot;Removed unpayable pending transaction&quot;, &quot;hash&quot;, hash)</div>
    </div>

            
        </div>
        <div>
            
        </div>
    </div>
</div>

            
        </div>
    </div>
</div>

            
                <div class="ps-1 py-2 my-1"><div class="row border-bottom border-1"data-bs-toggle="collapse" data-bs-target="#id-bda647b8718105ca2c2d32d4"role="button" aria-expanded="false" aria-controls="id-bda647b8718105ca2c2d32d4">
        
            <div class="col-12 col-sm-9 text-start"><h2>Chain Configuration</h2></div>
        
        <div class="col-12 col-sm-3 ms-auto mt-2">
            <div class="row line-stat">
                <div class="text-end"><span class="text-success">+550</span></div>
                <div class="text-start"><span class="text-danger">-47</span></div>
            </div>
        </div>
    </div>

    <div class="row forkdef-content collapse  border-1 ps-3 my-3" id="id-bda647b8718105ca2c2d32d4">
        <div></div>
        <div>
            
        </div>
        <div>
            
                <div class="ps-1 py-2 my-1"><div class="row border-bottom border-1"data-bs-toggle="collapse" data-bs-target="#id-1a9c7da509d2d2e6945bf004"role="button" aria-expanded="false" aria-controls="id-1a9c7da509d2d2e6945bf004">
        
            <div class="col-12 col-sm-9 text-start"><h3>Chain config</h3></div>
        
        <div class="col-12 col-sm-3 ms-auto mt-2">
            <div class="row line-stat">
                <div class="text-end"><span class="text-success">+168</span></div>
                <div class="text-start"><span class="text-danger">-47</span></div>
            </div>
        </div>
    </div>

    <div class="row forkdef-content collapse  border-1 ps-3 my-3" id="id-1a9c7da509d2d2e6945bf004">
        <div><p>The rollup functionality is enabled with the <code>optimism</code> field in the chain config.
The EIP-1559 parameters are configurable to adjust for faster more frequent and smaller blocks.
The parameters can be overriden for testing.</p>
</div>
        <div>
            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-77047cadded26847fb232311" role="button"
                   aria-expanded="false" aria-controls="id-77047cadded26847fb232311">
                    <code>params/config.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/3f40e65c484486dea6cff80b7db178985d21a2c6/params/config.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/650bb2f2b1dcfe30d9b1fa6f7dc9608055ed60e1/params/config.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+107</span></div>
                        <div class="text-start"><span class="text-danger">-4</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-77047cadded26847fb232311"><span class="term-fg1">diff --git go-ethereum&#47;params&#47;config.go op-geth&#47;params&#47;config.go</span>
<span class="term-fg1">index f503862422f5c9f6a9c16ed2adf434d391612396..f1fcf08b918d72ba95088a520b3287743585c3b1 100644</span>
<span class="term-fg1">--- go-ethereum&#47;params&#47;config.go</span>
<span class="term-fg1">+++ op-geth&#47;params&#47;config.go</span>
<span class="term-fg36">@@ -26,9 +26,30 @@</span>
 &#47;&#47; Genesis hashes to enforce below configs on.
 var (
 	MainnetGenesisHash = common.HexToHash(&quot;0xd4e56740f876aef8c010b86a40d5f56745a118d0906a34e69aec8c0db1cb8fa3&quot;)
<span class="term-fg31">-	HoleskyGenesisHash = common.HexToHash(&quot;0xff9006519a8ce843ac9c28549d24211420b546e12ce2d170c77a8cca7964f23d&quot;)</span>
<span class="term-fg32">+	HoleskyGenesisHash = common.HexToHash(&quot;0xb5f7f912443c940f21fd611f12828d75b534364ed9e95ca4e307729a4661bde4&quot;)</span>
 	SepoliaGenesisHash = common.HexToHash(&quot;0x25a5cc106eea7138acab33231d7160d69cb777ee0c2c553fcddf5138993e6dd9&quot;)
 	GoerliGenesisHash  = common.HexToHash(&quot;0xbf7e331f7f7c1dd2e05159666b3bf8bc7a8a3a9eb1d518969eab529dd9b88c1a&quot;)
<span class="term-fg32">+)</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+const (</span>
<span class="term-fg32">+	OPMainnetChainID   = 10</span>
<span class="term-fg32">+	OPGoerliChainID    = 420</span>
<span class="term-fg32">+	BaseMainnetChainID = 8453</span>
<span class="term-fg32">+	BaseGoerliChainID  = 84531</span>
<span class="term-fg32">+	devnetChainID      = 997</span>
<span class="term-fg32">+	chaosnetChainID    = 888</span>
<span class="term-fg32">+)</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+&#47;&#47; OP Stack chain config</span>
<span class="term-fg32">+var (</span>
<span class="term-fg32">+	&#47;&#47; March 17, 2023 @ 7:00:00 pm UTC</span>
<span class="term-fg32">+	OptimismGoerliRegolithTime = uint64(1679079600)</span>
<span class="term-fg32">+	&#47;&#47; May 4, 2023 @ 5:00:00 pm UTC</span>
<span class="term-fg32">+	BaseGoerliRegolithTime = uint64(1683219600)</span>
<span class="term-fg32">+	&#47;&#47; March 5, 2023 @ 2:48:00 am UTC</span>
<span class="term-fg32">+	devnetRegolithTime = uint64(1677984480)</span>
<span class="term-fg32">+	&#47;&#47; August 16, 2023 @ 3:34:22 am UTC</span>
<span class="term-fg32">+	chaosnetRegolithTime = uint64(1692156862)</span>
 )
&nbsp;
 func newUint64(val uint64) *uint64 { return &amp;val }
<span class="term-fg36">@@ -80,8 +101,7 @@</span> 		GrayGlacierBlock:              nil,
 		TerminalTotalDifficulty:       big.NewInt(0),
 		TerminalTotalDifficultyPassed: true,
 		MergeNetsplitBlock:            nil,
<span class="term-fg31">-		ShanghaiTime:                  newUint64(1694790240),</span>
<span class="term-fg31">-		CancunTime:                    newUint64(2000000000),</span>
<span class="term-fg32">+		ShanghaiTime:                  newUint64(1696000704),</span>
 		Ethash:                        new(EthashConfig),
 	}
 	&#47;&#47; SepoliaChainConfig contains the chain parameters to run a node on the Sepolia test network.
<span class="term-fg36">@@ -215,7 +235,7 @@</span> 		Clique:                        &amp;CliqueConfig{Period: 0, Epoch: 30000},
 	}
&nbsp;
 	&#47;&#47; TestChainConfig contains every protocol change (EIPs) introduced
<span class="term-fg31">-	&#47;&#47; and accepted by the Ethereum core developers for testing proposes.</span>
<span class="term-fg32">+	&#47;&#47; and accepted by the Ethereum core developers for testing purposes.</span>
 	TestChainConfig = &amp;ChainConfig{
 		ChainID:                       big.NewInt(1),
 		HomesteadBlock:                big.NewInt(0),
<span class="term-fg36">@@ -274,6 +294,16 @@</span> 		Ethash:                        new(EthashConfig),
 		Clique:                        nil,
 	}
 	TestRules = TestChainConfig.Rules(new(big.Int), false, 0)
<span class="term-fg32">+</span>
<span class="term-fg32">+	&#47;&#47; This is an Optimism chain config with bedrock starting a block 5, introduced for historical endpoint testing, largely based on the clique config</span>
<span class="term-fg32">+	OptimismTestConfig = func() *ChainConfig {</span>
<span class="term-fg32">+		conf := *AllCliqueProtocolChanges &#47;&#47; copy the config</span>
<span class="term-fg32">+		conf.Clique = nil</span>
<span class="term-fg32">+		conf.TerminalTotalDifficultyPassed = true</span>
<span class="term-fg32">+		conf.BedrockBlock = big.NewInt(5)</span>
<span class="term-fg32">+		conf.Optimism = &amp;OptimismConfig{EIP1559Elasticity: 50, EIP1559Denominator: 10}</span>
<span class="term-fg32">+		return &amp;conf</span>
<span class="term-fg32">+	}()</span>
 )
&nbsp;
 &#47;&#47; NetworkNames are user friendly names to use in the chain spec banner.
<span class="term-fg36">@@ -319,6 +349,10 @@</span> 	ShanghaiTime *uint64 `json:&quot;shanghaiTime,omitempty&quot;` &#47;&#47; Shanghai switch time (nil = no fork, 0 = already on shanghai)
 	CancunTime   *uint64 `json:&quot;cancunTime,omitempty&quot;`   &#47;&#47; Cancun switch time (nil = no fork, 0 = already on cancun)
 	PragueTime   *uint64 `json:&quot;pragueTime,omitempty&quot;`   &#47;&#47; Prague switch time (nil = no fork, 0 = already on prague)
 	VerkleTime   *uint64 `json:&quot;verkleTime,omitempty&quot;`   &#47;&#47; Verkle switch time (nil = no fork, 0 = already on verkle)
<span class="term-fg32">+</span>
<span class="term-fg32">+	BedrockBlock *big.Int `json:&quot;bedrockBlock,omitempty&quot;` &#47;&#47; Bedrock switch block (nil = no fork, 0 = already on optimism bedrock)</span>
<span class="term-fg32">+	RegolithTime *uint64  `json:&quot;regolithTime,omitempty&quot;` &#47;&#47; Regolith switch time (nil = no fork, 0 = already on optimism regolith)</span>
<span class="term-fg32">+	CanyonTime   *uint64  `json:&quot;canyonTime,omitempty&quot;`   &#47;&#47; Canyon switch time (nil = no fork, 0 = already on optimism canyon)</span>
&nbsp;
 	&#47;&#47; TerminalTotalDifficulty is the amount of total difficulty reached by
 	&#47;&#47; the network that triggers the consensus upgrade.
<span class="term-fg36">@@ -333,6 +367,9 @@</span> 	&#47;&#47; Various consensus engines
 	Ethash    *EthashConfig `json:&quot;ethash,omitempty&quot;`
 	Clique    *CliqueConfig `json:&quot;clique,omitempty&quot;`
 	IsDevMode bool          `json:&quot;isDev,omitempty&quot;`
<span class="term-fg32">+</span>
<span class="term-fg32">+	&#47;&#47; Optimism config, nil if not active</span>
<span class="term-fg32">+	Optimism *OptimismConfig `json:&quot;optimism,omitempty&quot;`</span>
 }
&nbsp;
 &#47;&#47; EthashConfig is the consensus engine configs for proof-of-work based sealing.
<span class="term-fg36">@@ -352,6 +389,17 @@</span>
 &#47;&#47; String implements the stringer interface, returning the consensus engine details.
 func (c *CliqueConfig) String() string {
 	return &quot;clique&quot;
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+&#47;&#47; OptimismConfig is the optimism config.</span>
<span class="term-fg32">+type OptimismConfig struct {</span>
<span class="term-fg32">+	EIP1559Elasticity  uint64 `json:&quot;eip1559Elasticity&quot;`</span>
<span class="term-fg32">+	EIP1559Denominator uint64 `json:&quot;eip1559Denominator&quot;`</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+&#47;&#47; String implements the stringer interface, returning the optimism fee config details.</span>
<span class="term-fg32">+func (o *OptimismConfig) String() string {</span>
<span class="term-fg32">+	return &quot;optimism&quot;</span>
 }
&nbsp;
 &#47;&#47; Description returns a human-readable description of ChainConfig.
<span class="term-fg36">@@ -365,6 +413,8 @@</span> 		network = &quot;unknown&quot;
 	}
 	banner += fmt.Sprintf(&quot;Chain ID:  %v (%s)\n&quot;, c.ChainID, network)
 	switch {
<span class="term-fg32">+	case c.Optimism != nil:</span>
<span class="term-fg32">+		banner += &quot;Consensus: Optimism\n&quot;</span>
 	case c.Ethash != nil:
 		if c.TerminalTotalDifficulty == nil {
 			banner += &quot;Consensus: Ethash (proof-of-work)\n&quot;
<span class="term-fg36">@@ -442,6 +492,12 @@</span> 		banner += fmt.Sprintf(&quot; - Prague:                      @%-10v\n&quot;, *c.PragueTime)
 	}
 	if c.VerkleTime != nil {
 		banner += fmt.Sprintf(&quot; - Verkle:                      @%-10v\n&quot;, *c.VerkleTime)
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	if c.RegolithTime != nil {</span>
<span class="term-fg32">+		banner += fmt.Sprintf(&quot; - Regolith:                    @%-10v\n&quot;, *c.RegolithTime)</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	if c.CanyonTime != nil {</span>
<span class="term-fg32">+		banner += fmt.Sprintf(&quot; - Canyon:                      @%-10v\n&quot;, *c.CanyonTime)</span>
 	}
 	return banner
 }
<span class="term-fg36">@@ -546,6 +602,41 @@</span> func (c *ChainConfig) IsVerkle(num *big.Int, time uint64) bool {
 	return c.IsLondon(num) &amp;&amp; isTimestampForked(c.VerkleTime, time)
 }
&nbsp;
<span class="term-fg32">+&#47;&#47; IsBedrock returns whether num is either equal to the Bedrock fork block or greater.</span>
<span class="term-fg32">+func (c *ChainConfig) IsBedrock(num *big.Int) bool {</span>
<span class="term-fg32">+	return isBlockForked(c.BedrockBlock, num)</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func (c *ChainConfig) IsRegolith(time uint64) bool {</span>
<span class="term-fg32">+	return isTimestampForked(c.RegolithTime, time)</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func (c *ChainConfig) IsCanyon(time uint64) bool {</span>
<span class="term-fg32">+	return isTimestampForked(c.CanyonTime, time)</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+&#47;&#47; IsOptimism returns whether the node is an optimism node or not.</span>
<span class="term-fg32">+func (c *ChainConfig) IsOptimism() bool {</span>
<span class="term-fg32">+	return c.Optimism != nil</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+&#47;&#47; IsOptimismBedrock returns true iff this is an optimism node &amp; bedrock is active</span>
<span class="term-fg32">+func (c *ChainConfig) IsOptimismBedrock(num *big.Int) bool {</span>
<span class="term-fg32">+	return c.IsOptimism() &amp;&amp; c.IsBedrock(num)</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func (c *ChainConfig) IsOptimismRegolith(time uint64) bool {</span>
<span class="term-fg32">+	return c.IsOptimism() &amp;&amp; c.IsRegolith(time)</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+func (c *ChainConfig) IsOptimismCanyon(time uint64) bool {</span>
<span class="term-fg32">+	return c.IsOptimism() &amp;&amp; c.IsCanyon(time)</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+&#47;&#47; IsOptimismPreBedrock returns true iff this is an optimism node &amp; bedrock is not yet active</span>
<span class="term-fg32">+func (c *ChainConfig) IsOptimismPreBedrock(num *big.Int) bool {</span>
<span class="term-fg32">+	return c.IsOptimism() &amp;&amp; !c.IsBedrock(num)</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
 &#47;&#47; CheckCompatible checks whether scheduled fork transitions have been imported
 &#47;&#47; with a mismatching chain configuration.
 func (c *ChainConfig) CheckCompatible(newcfg *ChainConfig, height uint64, time uint64) *ConfigCompatError {
<span class="term-fg36">@@ -712,11 +803,17 @@</span> }
&nbsp;
 &#47;&#47; BaseFeeChangeDenominator bounds the amount the base fee can change between blocks.
 func (c *ChainConfig) BaseFeeChangeDenominator() uint64 {
<span class="term-fg32">+	if c.Optimism != nil {</span>
<span class="term-fg32">+		return c.Optimism.EIP1559Denominator</span>
<span class="term-fg32">+	}</span>
 	return DefaultBaseFeeChangeDenominator
 }
&nbsp;
 &#47;&#47; ElasticityMultiplier bounds the maximum gas limit an EIP-1559 block may have.
 func (c *ChainConfig) ElasticityMultiplier() uint64 {
<span class="term-fg32">+	if c.Optimism != nil {</span>
<span class="term-fg32">+		return c.Optimism.EIP1559Elasticity</span>
<span class="term-fg32">+	}</span>
 	return DefaultElasticityMultiplier
 }
&nbsp;
<span class="term-fg36">@@ -853,6 +950,8 @@</span> 	IsByzantium, IsConstantinople, IsPetersburg, IsIstanbul bool
 	IsBerlin, IsLondon                                      bool
 	IsMerge, IsShanghai, IsCancun, IsPrague                 bool
 	IsVerkle                                                bool
<span class="term-fg32">+	IsOptimismBedrock, IsOptimismRegolith                   bool</span>
<span class="term-fg32">+	IsOptimismCanyon                                        bool</span>
 }
&nbsp;
 &#47;&#47; Rules ensures c&#39;s ChainID is not nil.
<span class="term-fg36">@@ -878,5 +977,9 @@</span> 		IsShanghai:       c.IsShanghai(num, timestamp),
 		IsCancun:         c.IsCancun(num, timestamp),
 		IsPrague:         c.IsPrague(num, timestamp),
 		IsVerkle:         c.IsVerkle(num, timestamp),
<span class="term-fg32">+		&#47;&#47; Optimism</span>
<span class="term-fg32">+		IsOptimismBedrock:  c.IsOptimismBedrock(num),</span>
<span class="term-fg32">+		IsOptimismRegolith: c.IsOptimismRegolith(timestamp),</span>
<span class="term-fg32">+		IsOptimismCanyon:   c.IsOptimismCanyon(timestamp),</span>
 	}
 }</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-4bab437f0903397da2d16df3" role="button"
                   aria-expanded="false" aria-controls="id-4bab437f0903397da2d16df3">
                    <code>params/protocol_params.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/3f40e65c484486dea6cff80b7db178985d21a2c6/params/protocol_params.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/650bb2f2b1dcfe30d9b1fa6f7dc9608055ed60e1/params/protocol_params.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+8</span></div>
                        <div class="text-start"><span class="text-danger">-1</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-4bab437f0903397da2d16df3"><span class="term-fg1">diff --git go-ethereum&#47;params&#47;protocol_params.go op-geth&#47;params&#47;protocol_params.go</span>
<span class="term-fg1">index 353ad1e03f0147db75c8c874d72272da8745fa41..7a204a3fe27b0b6a99046aebd20c65db9ec348be 100644</span>
<span class="term-fg1">--- go-ethereum&#47;params&#47;protocol_params.go</span>
<span class="term-fg1">+++ op-geth&#47;params&#47;protocol_params.go</span>
<span class="term-fg36">@@ -22,6 +22,13 @@</span>
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;common&quot;
 )
&nbsp;
<span class="term-fg32">+var (</span>
<span class="term-fg32">+	&#47;&#47; The base fee portion of the transaction fee accumulates at this predeploy</span>
<span class="term-fg32">+	OptimismBaseFeeRecipient = common.HexToAddress(&quot;0x4200000000000000000000000000000000000019&quot;)</span>
<span class="term-fg32">+	&#47;&#47; The L1 portion of the transaction fee accumulates at this predeploy</span>
<span class="term-fg32">+	OptimismL1FeeRecipient = common.HexToAddress(&quot;0x420000000000000000000000000000000000001A&quot;)</span>
<span class="term-fg32">+)</span>
<span class="term-fg32">+</span>
 const (
 	GasLimitBoundDivisor uint64 = 1024               &#47;&#47; The bound divisor of the gas limit, used in update calculations.
 	MinGasLimit          uint64 = 5000               &#47;&#47; Minimum the gas limit may ever be.
<span class="term-fg36">@@ -186,7 +193,7 @@</span> 	MinimumDifficulty      = big.NewInt(131072) &#47;&#47; The minimum that the difficulty may ever be.
 	DurationLimit          = big.NewInt(13)     &#47;&#47; The decision boundary on the blocktime duration used to determine whether difficulty should go up or not.
&nbsp;
 	&#47;&#47; BeaconRootsStorageAddress is the address where historical beacon roots are stored as per EIP-4788
<span class="term-fg31">-	BeaconRootsStorageAddress = common.HexToAddress(&quot;0xbEac00dDB15f3B6d645C48263dC93862413A222D&quot;)</span>
<span class="term-fg32">+	BeaconRootsStorageAddress = common.HexToAddress(&quot;0x000F3df6D732807Ef1319fB7B8bB8522d0Beac02&quot;)</span>
 	&#47;&#47; SystemAddress is where the system-transaction is sent from as per EIP-4788
 	SystemAddress common.Address = common.HexToAddress(&quot;0xfffffffffffffffffffffffffffffffffffffffe&quot;)
 )</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-2489cf4da5fc5ce8f63512a7" role="button"
                   aria-expanded="false" aria-controls="id-2489cf4da5fc5ce8f63512a7">
                    <code>core/genesis.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/3f40e65c484486dea6cff80b7db178985d21a2c6/core/genesis.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/650bb2f2b1dcfe30d9b1fa6f7dc9608055ed60e1/core/genesis.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+53</span></div>
                        <div class="text-start"><span class="text-danger">-42</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-2489cf4da5fc5ce8f63512a7"><span class="term-fg1">diff --git go-ethereum&#47;core&#47;genesis.go op-geth&#47;core&#47;genesis.go</span>
<span class="term-fg1">index 86a3e42a62f4e54da46bfdf40e7ba2e8d02c4145..7998aa6d70ebbeb1df2fc4f56be0e0d5c8b93af1 100644</span>
<span class="term-fg1">--- go-ethereum&#47;core&#47;genesis.go</span>
<span class="term-fg1">+++ op-geth&#47;core&#47;genesis.go</span>
<span class="term-fg36">@@ -25,6 +25,8 @@</span> 	&quot;fmt&quot;
 	&quot;math&#47;big&quot;
 	&quot;strings&quot;
&nbsp;
<span class="term-fg32">+	&quot;github.com&#47;ethereum-optimism&#47;superchain-registry&#47;superchain&quot;</span>
<span class="term-fg32">+</span>
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;common&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;common&#47;hexutil&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;common&#47;math&quot;
<span class="term-fg36">@@ -65,6 +67,11 @@</span> 	ParentHash    common.Hash `json:&quot;parentHash&quot;`
 	BaseFee       *big.Int    `json:&quot;baseFeePerGas&quot;` &#47;&#47; EIP-1559
 	ExcessBlobGas *uint64     `json:&quot;excessBlobGas&quot;` &#47;&#47; EIP-4844
 	BlobGasUsed   *uint64     `json:&quot;blobGasUsed&quot;`   &#47;&#47; EIP-4844
<span class="term-fg32">+</span>
<span class="term-fg32">+	&#47;&#47; StateHash represents the genesis state, to allow instantiation of a chain with missing initial state.</span>
<span class="term-fg32">+	&#47;&#47; Chains with history pruning, or extraordinarily large genesis allocation (e.g. after a regenesis event)</span>
<span class="term-fg32">+	&#47;&#47; may utilize this to get started, and then state-sync the latest state, while still verifying the header chain.</span>
<span class="term-fg32">+	StateHash *common.Hash `json:&quot;stateHash,omitempty&quot;`</span>
 }
&nbsp;
 func ReadGenesis(db ethdb.Database) (*Genesis, error) {
<span class="term-fg36">@@ -101,6 +108,10 @@</span> 	genesis.Coinbase = genesisHeader.Coinbase
 	genesis.BaseFee = genesisHeader.BaseFee
 	genesis.ExcessBlobGas = genesisHeader.ExcessBlobGas
 	genesis.BlobGasUsed = genesisHeader.BlobGasUsed
<span class="term-fg32">+	if genesis.Alloc == nil {</span>
<span class="term-fg32">+		h := genesisHeader.Hash()</span>
<span class="term-fg32">+		genesis.StateHash = &amp;h</span>
<span class="term-fg32">+	}</span>
&nbsp;
 	return &amp;genesis, nil
 }
<span class="term-fg36">@@ -120,8 +131,8 @@</span> 	}
 	return nil
 }
&nbsp;
<span class="term-fg31">-&#47;&#47; deriveHash computes the state root according to the genesis specification.</span>
<span class="term-fg31">-func (ga *GenesisAlloc) deriveHash() (common.Hash, error) {</span>
<span class="term-fg32">+&#47;&#47; hash computes the state root according to the genesis specification.</span>
<span class="term-fg32">+func (ga *GenesisAlloc) hash() (common.Hash, error) {</span>
 	&#47;&#47; Create an ephemeral in-memory database for computing hash,
 	&#47;&#47; all the derived states will be discarded to not pollute disk.
 	db := state.NewDatabase(rawdb.NewMemoryDatabase())
<span class="term-fg36">@@ -142,9 +153,9 @@</span> 	}
 	return statedb.Commit(0, false)
 }
&nbsp;
<span class="term-fg31">-&#47;&#47; flush is very similar with deriveHash, but the main difference is</span>
<span class="term-fg31">-&#47;&#47; all the generated states will be persisted into the given database.</span>
<span class="term-fg31">-&#47;&#47; Also, the genesis state specification will be flushed as well.</span>
<span class="term-fg32">+&#47;&#47; flush is very similar with hash, but the main difference is all the generated</span>
<span class="term-fg32">+&#47;&#47; states will be persisted into the given database. Also, the genesis state</span>
<span class="term-fg32">+&#47;&#47; specification will be flushed as well.</span>
 func (ga *GenesisAlloc) flush(db ethdb.Database, triedb *trie.Database, blockhash common.Hash) error {
 	statedb, err := state.New(types.EmptyRootHash, state.NewDatabaseWithNodeDB(db, triedb), nil)
 	if err != nil {
<span class="term-fg36">@@ -179,39 +190,6 @@</span> 	rawdb.WriteGenesisStateSpec(db, blockhash, blob)
 	return nil
 }
&nbsp;
<span class="term-fg31">-&#47;&#47; CommitGenesisState loads the stored genesis state with the given block</span>
<span class="term-fg31">-&#47;&#47; hash and commits it into the provided trie database.</span>
<span class="term-fg31">-func CommitGenesisState(db ethdb.Database, triedb *trie.Database, blockhash common.Hash) error {</span>
<span class="term-fg31">-	var alloc GenesisAlloc</span>
<span class="term-fg31">-	blob := rawdb.ReadGenesisStateSpec(db, blockhash)</span>
<span class="term-fg31">-	if len(blob) != 0 {</span>
<span class="term-fg31">-		if err := alloc.UnmarshalJSON(blob); err != nil {</span>
<span class="term-fg31">-			return err</span>
<span class="term-fg31">-		}</span>
<span class="term-fg31">-	} else {</span>
<span class="term-fg31">-		&#47;&#47; Genesis allocation is missing and there are several possibilities:</span>
<span class="term-fg31">-		&#47;&#47; the node is legacy which doesn&#39;t persist the genesis allocation or</span>
<span class="term-fg31">-		&#47;&#47; the persisted allocation is just lost.</span>
<span class="term-fg31">-		&#47;&#47; - supported networks(mainnet, testnets), recover with defined allocations</span>
<span class="term-fg31">-		&#47;&#47; - private network, can&#39;t recover</span>
<span class="term-fg31">-		var genesis *Genesis</span>
<span class="term-fg31">-		switch blockhash {</span>
<span class="term-fg31">-		case params.MainnetGenesisHash:</span>
<span class="term-fg31">-			genesis = DefaultGenesisBlock()</span>
<span class="term-fg31">-		case params.GoerliGenesisHash:</span>
<span class="term-fg31">-			genesis = DefaultGoerliGenesisBlock()</span>
<span class="term-fg31">-		case params.SepoliaGenesisHash:</span>
<span class="term-fg31">-			genesis = DefaultSepoliaGenesisBlock()</span>
<span class="term-fg31">-		}</span>
<span class="term-fg31">-		if genesis != nil {</span>
<span class="term-fg31">-			alloc = genesis.Alloc</span>
<span class="term-fg31">-		} else {</span>
<span class="term-fg31">-			return errors.New(&quot;not found&quot;)</span>
<span class="term-fg31">-		}</span>
<span class="term-fg31">-	}</span>
<span class="term-fg31">-	return alloc.flush(db, triedb, blockhash)</span>
<span class="term-fg31">-}</span>
<span class="term-fg31">-</span>
 &#47;&#47; GenesisAccount is an account in the state of the genesis block.
 type GenesisAccount struct {
 	Code       []byte                      `json:&quot;code,omitempty&quot;`
<span class="term-fg36">@@ -278,6 +256,9 @@</span> &#47;&#47; ChainOverrides contains the changes to chain config.
 type ChainOverrides struct {
 	OverrideCancun *uint64
 	OverrideVerkle *uint64
<span class="term-fg32">+	&#47;&#47; optimism</span>
<span class="term-fg32">+	OverrideOptimismCanyon  *uint64</span>
<span class="term-fg32">+	ApplySuperchainUpgrades bool</span>
 }
&nbsp;
 &#47;&#47; SetupGenesisBlock writes or updates the genesis block in db.
<span class="term-fg36">@@ -303,11 +284,35 @@</span> 		return params.AllEthashProtocolChanges, common.Hash{}, errGenesisNoConfig
 	}
 	applyOverrides := func(config *params.ChainConfig) {
 		if config != nil {
<span class="term-fg32">+			&#47;&#47; If applying the superchain-registry to a known OP-Stack chain,</span>
<span class="term-fg32">+			&#47;&#47; then override the local chain-config with that from the registry.</span>
<span class="term-fg32">+			if overrides != nil &amp;&amp; overrides.ApplySuperchainUpgrades &amp;&amp; config.IsOptimism() &amp;&amp; config.ChainID != nil &amp;&amp; genesis.Config.ChainID.IsUint64() {</span>
<span class="term-fg32">+				if _, ok := superchain.OPChains[config.ChainID.Uint64()]; ok {</span>
<span class="term-fg32">+					conf, err := params.LoadOPStackChainConfig(config.ChainID.Uint64())</span>
<span class="term-fg32">+					if err != nil {</span>
<span class="term-fg32">+						log.Warn(&quot;failed to load chain config from superchain-registry, skipping override&quot;, &quot;err&quot;, err, &quot;chain_id&quot;, config.ChainID)</span>
<span class="term-fg32">+					} else {</span>
<span class="term-fg32">+						*config = *conf</span>
<span class="term-fg32">+					}</span>
<span class="term-fg32">+				}</span>
<span class="term-fg32">+			}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+			if config.IsOptimism() &amp;&amp; config.ChainID != nil &amp;&amp; config.ChainID.Cmp(big.NewInt(params.OPGoerliChainID)) == 0 {</span>
<span class="term-fg32">+				&#47;&#47; Apply Optimism Goerli regolith time</span>
<span class="term-fg32">+				config.RegolithTime = &amp;params.OptimismGoerliRegolithTime</span>
<span class="term-fg32">+			}</span>
<span class="term-fg32">+			if config.IsOptimism() &amp;&amp; config.ChainID != nil &amp;&amp; config.ChainID.Cmp(big.NewInt(params.BaseGoerliChainID)) == 0 {</span>
<span class="term-fg32">+				&#47;&#47; Apply Base Goerli regolith time</span>
<span class="term-fg32">+				config.RegolithTime = &amp;params.BaseGoerliRegolithTime</span>
<span class="term-fg32">+			}</span>
 			if overrides != nil &amp;&amp; overrides.OverrideCancun != nil {
 				config.CancunTime = overrides.OverrideCancun
 			}
 			if overrides != nil &amp;&amp; overrides.OverrideVerkle != nil {
 				config.VerkleTime = overrides.OverrideVerkle
<span class="term-fg32">+			}</span>
<span class="term-fg32">+			if overrides != nil &amp;&amp; overrides.OverrideOptimismCanyon != nil {</span>
<span class="term-fg32">+				config.CanyonTime = overrides.OverrideOptimismCanyon</span>
 			}
 		}
 	}
<span class="term-fg36">@@ -444,8 +449,15 @@</span> }
&nbsp;
 &#47;&#47; ToBlock returns the genesis block according to genesis specification.
 func (g *Genesis) ToBlock() *types.Block {
<span class="term-fg31">-	root, err := g.Alloc.deriveHash()</span>
<span class="term-fg31">-	if err != nil {</span>
<span class="term-fg32">+	var root common.Hash</span>
<span class="term-fg32">+	var err error</span>
<span class="term-fg32">+	if g.StateHash != nil {</span>
<span class="term-fg32">+		if len(g.Alloc) &gt; 0 {</span>
<span class="term-fg32">+			panic(fmt.Errorf(&quot;cannot both have genesis hash %s &quot;+</span>
<span class="term-fg32">+				&quot;and non-empty state-allocation&quot;, *g.StateHash))</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+		root = *g.StateHash</span>
<span class="term-fg32">+	} else if root, err = g.Alloc.hash(); err != nil {</span>
 		panic(err)
 	}
 	head := &amp;types.Header{
<span class="term-fg36">@@ -587,10 +599,9 @@</span> func DefaultHoleskyGenesisBlock() *Genesis {
 	return &amp;Genesis{
 		Config:     params.HoleskyChainConfig,
 		Nonce:      0x1234,
<span class="term-fg31">-		ExtraData:  hexutil.MustDecode(&quot;0x686f77206d7563682069732074686520666973683f&quot;),</span>
 		GasLimit:   0x17d7840,
 		Difficulty: big.NewInt(0x01),
<span class="term-fg31">-		Timestamp:  1694786100,</span>
<span class="term-fg32">+		Timestamp:  1695902100,</span>
 		Alloc:      decodePrealloc(holeskyAllocData),
 	}
 }</div>
    </div>

            
        </div>
        <div>
            
        </div>
    </div>
</div>

            
                <div class="ps-1 py-2 my-1"><div class="row border-bottom border-1"data-bs-toggle="collapse" data-bs-target="#id-e48785d01eb98d07eae724d2"role="button" aria-expanded="false" aria-controls="id-e48785d01eb98d07eae724d2">
        
            <div class="col-12 col-sm-9 text-start"><h3>Chain config cleanup</h3></div>
        
        <div class="col-12 col-sm-3 ms-auto mt-2">
            <div class="row line-stat">
                <div class="text-end"><span class="text-success">+3</span></div>
                <div class="text-start"><span class="text-danger">-0</span></div>
            </div>
        </div>
    </div>

    <div class="row forkdef-content collapse  border-1 ps-3 my-3" id="id-e48785d01eb98d07eae724d2">
        <div><p>The optimism Goerli testnet used clique-config data to make geth internals accept blocks.
Post-bedrock the beacon-consensus (i.e. follow Engine API) is now used, and the clique config is removed.</p>
</div>
        <div>
            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-ef731641492388eb62807c39" role="button"
                   aria-expanded="false" aria-controls="id-ef731641492388eb62807c39">
                    <code>core/rawdb/accessors_metadata.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/3f40e65c484486dea6cff80b7db178985d21a2c6/core/rawdb/accessors_metadata.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/650bb2f2b1dcfe30d9b1fa6f7dc9608055ed60e1/core/rawdb/accessors_metadata.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+3</span></div>
                        <div class="text-start"><span class="text-danger">-0</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-ef731641492388eb62807c39"><span class="term-fg1">diff --git go-ethereum&#47;core&#47;rawdb&#47;accessors_metadata.go op-geth&#47;core&#47;rawdb&#47;accessors_metadata.go</span>
<span class="term-fg1">index 859566f722f5960b0ce417514d6f20ff35a5cbe9..7dae87a98f2f5383b3b14f0d04012eb64c98a91b 100644</span>
<span class="term-fg1">--- go-ethereum&#47;core&#47;rawdb&#47;accessors_metadata.go</span>
<span class="term-fg1">+++ op-geth&#47;core&#47;rawdb&#47;accessors_metadata.go</span>
<span class="term-fg36">@@ -64,6 +64,9 @@</span> 	if err := json.Unmarshal(data, &amp;config); err != nil {
 		log.Error(&quot;Invalid chain config JSON&quot;, &quot;hash&quot;, hash, &quot;err&quot;, err)
 		return nil
 	}
<span class="term-fg32">+	if config.Optimism != nil {</span>
<span class="term-fg32">+		config.Clique = nil &#47;&#47; get rid of legacy clique data in chain config (optimism goerli issue)</span>
<span class="term-fg32">+	}</span>
 	return &amp;config
 }
</div>
    </div>

            
        </div>
        <div>
            
        </div>
    </div>
</div>

            
                <div class="ps-1 py-2 my-1"><div class="row border-bottom border-1"data-bs-toggle="collapse" data-bs-target="#id-6d54b44009c16b72c296d8ea"role="button" aria-expanded="false" aria-controls="id-6d54b44009c16b72c296d8ea">
        
            <div class="col-12 col-sm-9 text-start"><h3>Genesis loading</h3></div>
        
        <div class="col-12 col-sm-3 ms-auto mt-2">
            <div class="row line-stat">
                <div class="text-end"><span class="text-success">+6</span></div>
                <div class="text-start"><span class="text-danger">-0</span></div>
            </div>
        </div>
    </div>

    <div class="row forkdef-content collapse  border-1 ps-3 my-3" id="id-6d54b44009c16b72c296d8ea">
        <div></div>
        <div>
            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-b2f9a69ab2a5c5ed2513af99" role="button"
                   aria-expanded="false" aria-controls="id-b2f9a69ab2a5c5ed2513af99">
                    <code>core/gen_genesis.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/3f40e65c484486dea6cff80b7db178985d21a2c6/core/gen_genesis.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/650bb2f2b1dcfe30d9b1fa6f7dc9608055ed60e1/core/gen_genesis.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+6</span></div>
                        <div class="text-start"><span class="text-danger">-0</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-b2f9a69ab2a5c5ed2513af99"><span class="term-fg1">diff --git go-ethereum&#47;core&#47;gen_genesis.go op-geth&#47;core&#47;gen_genesis.go</span>
<span class="term-fg1">index 38614252a38047715e012a2f5d91973f46fdd999..bd2a069b541a67b3445e18d74af95e69874ef46b 100644</span>
<span class="term-fg1">--- go-ethereum&#47;core&#47;gen_genesis.go</span>
<span class="term-fg1">+++ op-geth&#47;core&#47;gen_genesis.go</span>
<span class="term-fg36">@@ -33,6 +33,7 @@</span> 		ParentHash    common.Hash                                 `json:&quot;parentHash&quot;`
 		BaseFee       *math.HexOrDecimal256                       `json:&quot;baseFeePerGas&quot;`
 		ExcessBlobGas *math.HexOrDecimal64                        `json:&quot;excessBlobGas&quot;`
 		BlobGasUsed   *math.HexOrDecimal64                        `json:&quot;blobGasUsed&quot;`
<span class="term-fg32">+		StateHash     *common.Hash                                `json:&quot;stateHash,omitempty&quot;`</span>
 	}
 	var enc Genesis
 	enc.Config = g.Config
<span class="term-fg36">@@ -55,6 +56,7 @@</span> 	enc.ParentHash = g.ParentHash
 	enc.BaseFee = (*math.HexOrDecimal256)(g.BaseFee)
 	enc.ExcessBlobGas = (*math.HexOrDecimal64)(g.ExcessBlobGas)
 	enc.BlobGasUsed = (*math.HexOrDecimal64)(g.BlobGasUsed)
<span class="term-fg32">+	enc.StateHash = g.StateHash</span>
 	return json.Marshal(&amp;enc)
 }
&nbsp;
<span class="term-fg36">@@ -76,6 +78,7 @@</span> 		ParentHash    *common.Hash                                `json:&quot;parentHash&quot;`
 		BaseFee       *math.HexOrDecimal256                       `json:&quot;baseFeePerGas&quot;`
 		ExcessBlobGas *math.HexOrDecimal64                        `json:&quot;excessBlobGas&quot;`
 		BlobGasUsed   *math.HexOrDecimal64                        `json:&quot;blobGasUsed&quot;`
<span class="term-fg32">+		StateHash     *common.Hash                                `json:&quot;stateHash,omitempty&quot;`</span>
 	}
 	var dec Genesis
 	if err := json.Unmarshal(input, &amp;dec); err != nil {
<span class="term-fg36">@@ -131,6 +134,9 @@</span> 		g.ExcessBlobGas = (*uint64)(dec.ExcessBlobGas)
 	}
 	if dec.BlobGasUsed != nil {
 		g.BlobGasUsed = (*uint64)(dec.BlobGasUsed)
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	if dec.StateHash != nil {</span>
<span class="term-fg32">+		g.StateHash = dec.StateHash</span>
 	}
 	return nil
 }</div>
    </div>

            
        </div>
        <div>
            
        </div>
    </div>
</div>

            
                <div class="ps-1 py-2 my-1"><div class="row border-bottom border-1"data-bs-toggle="collapse" data-bs-target="#id-545e4bae32d530fcda278293"role="button" aria-expanded="false" aria-controls="id-545e4bae32d530fcda278293">
        
            <div class="col-12 col-sm-9 text-start"><h3>Superchain config</h3></div>
        
        <div class="col-12 col-sm-3 ms-auto mt-2">
            <div class="row line-stat">
                <div class="text-end"><span class="text-success">+373</span></div>
                <div class="text-start"><span class="text-danger">-0</span></div>
            </div>
        </div>
    </div>

    <div class="row forkdef-content collapse  border-1 ps-3 my-3" id="id-545e4bae32d530fcda278293">
        <div><p>Testing of the superchain configuration</p>
</div>
        <div>
            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-b62f9d996b50bcb7b162fe59" role="button"
                   aria-expanded="false" aria-controls="id-b62f9d996b50bcb7b162fe59">
                    <code>core/superchain.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <span class="text-muted">(new)</span>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/650bb2f2b1dcfe30d9b1fa6f7dc9608055ed60e1/core/superchain.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+99</span></div>
                        <div class="text-start"><span class="text-danger">-0</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-b62f9d996b50bcb7b162fe59"><span class="term-fg1">diff --git go-ethereum&#47;core&#47;superchain.go op-geth&#47;core&#47;superchain.go</span>
<span class="term-fg1">new file mode 100644</span>
<span class="term-fg1">index 0000000000000000000000000000000000000000..96f68cedcf437f251d18e35764e4d49f4ddcab6b</span>
<span class="term-fg1">--- &#47;dev&#47;null</span>
<span class="term-fg1">+++ op-geth&#47;core&#47;superchain.go</span>
<span class="term-fg36">@@ -0,0 +1,99 @@</span>
<span class="term-fg32">+package core</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+import (</span>
<span class="term-fg32">+	&quot;fmt&quot;</span>
<span class="term-fg32">+	&quot;math&#47;big&quot;</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	&quot;github.com&#47;ethereum-optimism&#47;superchain-registry&#47;superchain&quot;</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;common&quot;</span>
<span class="term-fg32">+	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;params&quot;</span>
<span class="term-fg32">+)</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func LoadOPStackGenesis(chainID uint64) (*Genesis, error) {</span>
<span class="term-fg32">+	chConfig, ok := superchain.OPChains[chainID]</span>
<span class="term-fg32">+	if !ok {</span>
<span class="term-fg32">+		return nil, fmt.Errorf(&quot;unknown chain ID: %d&quot;, chainID)</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	cfg, err := params.LoadOPStackChainConfig(chainID)</span>
<span class="term-fg32">+	if err != nil {</span>
<span class="term-fg32">+		return nil, fmt.Errorf(&quot;failed to load params.ChainConfig for chain %d: %w&quot;, chainID, err)</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	gen, err := superchain.LoadGenesis(chainID)</span>
<span class="term-fg32">+	if err != nil {</span>
<span class="term-fg32">+		return nil, fmt.Errorf(&quot;failed to load genesis definition for chain %d: %w&quot;, chainID, err)</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	genesis := &amp;Genesis{</span>
<span class="term-fg32">+		Config:     cfg,</span>
<span class="term-fg32">+		Nonce:      gen.Nonce,</span>
<span class="term-fg32">+		Timestamp:  gen.Timestamp,</span>
<span class="term-fg32">+		ExtraData:  gen.ExtraData,</span>
<span class="term-fg32">+		GasLimit:   gen.GasLimit,</span>
<span class="term-fg32">+		Difficulty: (*big.Int)(gen.Difficulty),</span>
<span class="term-fg32">+		Mixhash:    common.Hash(gen.Mixhash),</span>
<span class="term-fg32">+		Coinbase:   common.Address(gen.Coinbase),</span>
<span class="term-fg32">+		Alloc:      make(GenesisAlloc),</span>
<span class="term-fg32">+		Number:     gen.Number,</span>
<span class="term-fg32">+		GasUsed:    gen.GasUsed,</span>
<span class="term-fg32">+		ParentHash: common.Hash(gen.ParentHash),</span>
<span class="term-fg32">+		BaseFee:    (*big.Int)(gen.BaseFee),</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	for addr, acc := range gen.Alloc {</span>
<span class="term-fg32">+		var code []byte</span>
<span class="term-fg32">+		if acc.CodeHash != ([32]byte{}) {</span>
<span class="term-fg32">+			dat, err := superchain.LoadContractBytecode(acc.CodeHash)</span>
<span class="term-fg32">+			if err != nil {</span>
<span class="term-fg32">+				return nil, fmt.Errorf(&quot;failed to load bytecode %s of address %s in chain %d: %w&quot;, acc.CodeHash, addr, chainID, err)</span>
<span class="term-fg32">+			}</span>
<span class="term-fg32">+			code = dat</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+		var storage map[common.Hash]common.Hash</span>
<span class="term-fg32">+		if len(acc.Storage) &gt; 0 {</span>
<span class="term-fg32">+			storage = make(map[common.Hash]common.Hash)</span>
<span class="term-fg32">+			for k, v := range acc.Storage {</span>
<span class="term-fg32">+				storage[common.Hash(k)] = common.Hash(v)</span>
<span class="term-fg32">+			}</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+		bal := common.Big0</span>
<span class="term-fg32">+		if acc.Balance != nil {</span>
<span class="term-fg32">+			bal = (*big.Int)(acc.Balance)</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+		genesis.Alloc[common.Address(addr)] = GenesisAccount{</span>
<span class="term-fg32">+			Code:    code,</span>
<span class="term-fg32">+			Storage: storage,</span>
<span class="term-fg32">+			Balance: bal,</span>
<span class="term-fg32">+			Nonce:   acc.Nonce,</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	if gen.StateHash != nil {</span>
<span class="term-fg32">+		if len(gen.Alloc) &gt; 0 {</span>
<span class="term-fg32">+			return nil, fmt.Errorf(&quot;chain definition unexpectedly contains both allocation (%d) and state-hash %s&quot;, len(gen.Alloc), *gen.StateHash)</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+		genesis.StateHash = (*common.Hash)(gen.StateHash)</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	genesisBlock := genesis.ToBlock()</span>
<span class="term-fg32">+	genesisBlockHash := genesisBlock.Hash()</span>
<span class="term-fg32">+	expectedHash := common.Hash([32]byte(chConfig.Genesis.L2.Hash))</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	&#47;&#47; Verify we correctly produced the genesis config by recomputing the genesis-block-hash,</span>
<span class="term-fg32">+	&#47;&#47; and check the genesis matches the chain genesis definition.</span>
<span class="term-fg32">+	if chConfig.Genesis.L2.Number != genesisBlock.NumberU64() {</span>
<span class="term-fg32">+		switch chainID {</span>
<span class="term-fg32">+		case params.OPMainnetChainID:</span>
<span class="term-fg32">+			expectedHash = common.HexToHash(&quot;0x7ca38a1916c42007829c55e69d3e9a73265554b586a499015373241b8a3fa48b&quot;)</span>
<span class="term-fg32">+		case params.OPGoerliChainID:</span>
<span class="term-fg32">+			expectedHash = common.HexToHash(&quot;0xc1fc15cd51159b1f1e5cbc4b82e85c1447ddfa33c52cf1d98d14fba0d6354be1&quot;)</span>
<span class="term-fg32">+		default:</span>
<span class="term-fg32">+			return nil, fmt.Errorf(&quot;unknown stateless genesis definition for chain %d&quot;, chainID)</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	if expectedHash != genesisBlockHash {</span>
<span class="term-fg32">+		return nil, fmt.Errorf(&quot;produced genesis with hash %s but expected %s&quot;, genesisBlockHash, expectedHash)</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	return genesis, nil</span>
<span class="term-fg32">+}</span></div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-2d292ba26a342ff9ded782fb" role="button"
                   aria-expanded="false" aria-controls="id-2d292ba26a342ff9ded782fb">
                    <code>params/superchain.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <span class="text-muted">(new)</span>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/650bb2f2b1dcfe30d9b1fa6f7dc9608055ed60e1/params/superchain.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+274</span></div>
                        <div class="text-start"><span class="text-danger">-0</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-2d292ba26a342ff9ded782fb"><span class="term-fg1">diff --git go-ethereum&#47;params&#47;superchain.go op-geth&#47;params&#47;superchain.go</span>
<span class="term-fg1">new file mode 100644</span>
<span class="term-fg1">index 0000000000000000000000000000000000000000..00eb424731ca77ce873114158f7f4deae81f5de1</span>
<span class="term-fg1">--- &#47;dev&#47;null</span>
<span class="term-fg1">+++ op-geth&#47;params&#47;superchain.go</span>
<span class="term-fg36">@@ -0,0 +1,274 @@</span>
<span class="term-fg32">+package params</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+import (</span>
<span class="term-fg32">+	&quot;encoding&#47;binary&quot;</span>
<span class="term-fg32">+	&quot;fmt&quot;</span>
<span class="term-fg32">+	&quot;math&#47;big&quot;</span>
<span class="term-fg32">+	&quot;sort&quot;</span>
<span class="term-fg32">+	&quot;strings&quot;</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	&quot;github.com&#47;ethereum-optimism&#47;superchain-registry&#47;superchain&quot;</span>
<span class="term-fg32">+	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;common&quot;</span>
<span class="term-fg32">+)</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+var OPStackSupport = ProtocolVersionV0{Build: [8]byte{}, Major: 3, Minor: 1, Patch: 0, PreRelease: 0}.Encode()</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func init() {</span>
<span class="term-fg32">+	for id, ch := range superchain.OPChains {</span>
<span class="term-fg32">+		NetworkNames[fmt.Sprintf(&quot;%d&quot;, id)] = ch.Name</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func OPStackChainIDByName(name string) (uint64, error) {</span>
<span class="term-fg32">+	for id, ch := range superchain.OPChains {</span>
<span class="term-fg32">+		if ch.Chain+&quot;-&quot;+ch.Superchain == name {</span>
<span class="term-fg32">+			return id, nil</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	return 0, fmt.Errorf(&quot;unknown chain %q&quot;, name)</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func OPStackChainNames() (out []string) {</span>
<span class="term-fg32">+	for _, ch := range superchain.OPChains {</span>
<span class="term-fg32">+		out = append(out, ch.Chain+&quot;-&quot;+ch.Superchain)</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	sort.Strings(out)</span>
<span class="term-fg32">+	return</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func LoadOPStackChainConfig(chainID uint64) (*ChainConfig, error) {</span>
<span class="term-fg32">+	chConfig, ok := superchain.OPChains[chainID]</span>
<span class="term-fg32">+	if !ok {</span>
<span class="term-fg32">+		return nil, fmt.Errorf(&quot;unknown chain ID: %d&quot;, chainID)</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	superchainConfig, ok := superchain.Superchains[chConfig.Superchain]</span>
<span class="term-fg32">+	if !ok {</span>
<span class="term-fg32">+		return nil, fmt.Errorf(&quot;unknown superchain %q&quot;, chConfig.Superchain)</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	genesisActivation := uint64(0)</span>
<span class="term-fg32">+	out := &amp;ChainConfig{</span>
<span class="term-fg32">+		ChainID:                       new(big.Int).SetUint64(chainID),</span>
<span class="term-fg32">+		HomesteadBlock:                common.Big0,</span>
<span class="term-fg32">+		DAOForkBlock:                  nil,</span>
<span class="term-fg32">+		DAOForkSupport:                false,</span>
<span class="term-fg32">+		EIP150Block:                   common.Big0,</span>
<span class="term-fg32">+		EIP155Block:                   common.Big0,</span>
<span class="term-fg32">+		EIP158Block:                   common.Big0,</span>
<span class="term-fg32">+		ByzantiumBlock:                common.Big0,</span>
<span class="term-fg32">+		ConstantinopleBlock:           common.Big0,</span>
<span class="term-fg32">+		PetersburgBlock:               common.Big0,</span>
<span class="term-fg32">+		IstanbulBlock:                 common.Big0,</span>
<span class="term-fg32">+		MuirGlacierBlock:              common.Big0,</span>
<span class="term-fg32">+		BerlinBlock:                   common.Big0,</span>
<span class="term-fg32">+		LondonBlock:                   common.Big0,</span>
<span class="term-fg32">+		ArrowGlacierBlock:             common.Big0,</span>
<span class="term-fg32">+		GrayGlacierBlock:              common.Big0,</span>
<span class="term-fg32">+		MergeNetsplitBlock:            common.Big0,</span>
<span class="term-fg32">+		ShanghaiTime:                  nil,</span>
<span class="term-fg32">+		CancunTime:                    nil,</span>
<span class="term-fg32">+		PragueTime:                    nil,</span>
<span class="term-fg32">+		BedrockBlock:                  common.Big0,</span>
<span class="term-fg32">+		RegolithTime:                  &amp;genesisActivation,</span>
<span class="term-fg32">+		TerminalTotalDifficulty:       common.Big0,</span>
<span class="term-fg32">+		TerminalTotalDifficultyPassed: true,</span>
<span class="term-fg32">+		Ethash:                        nil,</span>
<span class="term-fg32">+		Clique:                        nil,</span>
<span class="term-fg32">+		Optimism: &amp;OptimismConfig{</span>
<span class="term-fg32">+			EIP1559Elasticity:  6,</span>
<span class="term-fg32">+			EIP1559Denominator: 50,</span>
<span class="term-fg32">+		},</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	&#47;&#47; note: no actual parameters are being loaded, yet.</span>
<span class="term-fg32">+	&#47;&#47; Future superchain upgrades are loaded from the superchain chConfig and applied to the geth ChainConfig here.</span>
<span class="term-fg32">+	_ = superchainConfig.Config</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	&#47;&#47; special overrides for OP-Stack chains with pre-Regolith upgrade history</span>
<span class="term-fg32">+	switch chainID {</span>
<span class="term-fg32">+	case OPGoerliChainID:</span>
<span class="term-fg32">+		out.LondonBlock = big.NewInt(4061224)</span>
<span class="term-fg32">+		out.ArrowGlacierBlock = big.NewInt(4061224)</span>
<span class="term-fg32">+		out.GrayGlacierBlock = big.NewInt(4061224)</span>
<span class="term-fg32">+		out.MergeNetsplitBlock = big.NewInt(4061224)</span>
<span class="term-fg32">+		out.BedrockBlock = big.NewInt(4061224)</span>
<span class="term-fg32">+		out.RegolithTime = &amp;OptimismGoerliRegolithTime</span>
<span class="term-fg32">+		out.Optimism.EIP1559Elasticity = 10</span>
<span class="term-fg32">+	case OPMainnetChainID:</span>
<span class="term-fg32">+		out.BerlinBlock = big.NewInt(3950000)</span>
<span class="term-fg32">+		out.LondonBlock = big.NewInt(105235063)</span>
<span class="term-fg32">+		out.ArrowGlacierBlock = big.NewInt(105235063)</span>
<span class="term-fg32">+		out.GrayGlacierBlock = big.NewInt(105235063)</span>
<span class="term-fg32">+		out.MergeNetsplitBlock = big.NewInt(105235063)</span>
<span class="term-fg32">+		out.BedrockBlock = big.NewInt(105235063)</span>
<span class="term-fg32">+	case BaseGoerliChainID:</span>
<span class="term-fg32">+		out.RegolithTime = &amp;BaseGoerliRegolithTime</span>
<span class="term-fg32">+	case devnetChainID:</span>
<span class="term-fg32">+		out.RegolithTime = &amp;devnetRegolithTime</span>
<span class="term-fg32">+		out.Optimism.EIP1559Elasticity = 10</span>
<span class="term-fg32">+	case chaosnetChainID:</span>
<span class="term-fg32">+		out.RegolithTime = &amp;chaosnetRegolithTime</span>
<span class="term-fg32">+		out.Optimism.EIP1559Elasticity = 10</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	return out, nil</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+&#47;&#47; ProtocolVersion encodes the OP-Stack protocol version. See OP-Stack superchain-upgrade specification.</span>
<span class="term-fg32">+type ProtocolVersion [32]byte</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func (p ProtocolVersion) MarshalText() ([]byte, error) {</span>
<span class="term-fg32">+	return common.Hash(p).MarshalText()</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func (p *ProtocolVersion) UnmarshalText(input []byte) error {</span>
<span class="term-fg32">+	return (*common.Hash)(p).UnmarshalText(input)</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func (p ProtocolVersion) Parse() (versionType uint8, build [8]byte, major, minor, patch, preRelease uint32) {</span>
<span class="term-fg32">+	versionType = p[0]</span>
<span class="term-fg32">+	if versionType != 0 {</span>
<span class="term-fg32">+		return</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	&#47;&#47; bytes 1:8 reserved for future use</span>
<span class="term-fg32">+	copy(build[:], p[8:16])                        &#47;&#47; differentiates forks and custom-builds of standard protocol</span>
<span class="term-fg32">+	major = binary.BigEndian.Uint32(p[16:20])      &#47;&#47; incompatible API changes</span>
<span class="term-fg32">+	minor = binary.BigEndian.Uint32(p[20:24])      &#47;&#47; identifies additional functionality in backwards compatible manner</span>
<span class="term-fg32">+	patch = binary.BigEndian.Uint32(p[24:28])      &#47;&#47; identifies backward-compatible bug-fixes</span>
<span class="term-fg32">+	preRelease = binary.BigEndian.Uint32(p[28:32]) &#47;&#47; identifies unstable versions that may not satisfy the above</span>
<span class="term-fg32">+	return</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func (p ProtocolVersion) String() string {</span>
<span class="term-fg32">+	versionType, build, major, minor, patch, preRelease := p.Parse()</span>
<span class="term-fg32">+	if versionType != 0 {</span>
<span class="term-fg32">+		return &quot;v0.0.0-unknown.&quot; + common.Hash(p).String()</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	ver := fmt.Sprintf(&quot;v%d.%d.%d&quot;, major, minor, patch)</span>
<span class="term-fg32">+	if preRelease != 0 {</span>
<span class="term-fg32">+		ver += fmt.Sprintf(&quot;-%d&quot;, preRelease)</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	if build != ([8]byte{}) {</span>
<span class="term-fg32">+		if humanBuildTag(build) {</span>
<span class="term-fg32">+			ver += fmt.Sprintf(&quot;+%s&quot;, strings.TrimRight(string(build[:]), &quot;\x00&quot;))</span>
<span class="term-fg32">+		} else {</span>
<span class="term-fg32">+			ver += fmt.Sprintf(&quot;+0x%x&quot;, build)</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	return ver</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+&#47;&#47; humanBuildTag identifies which build tag we can stringify for human-readable versions</span>
<span class="term-fg32">+func humanBuildTag(v [8]byte) bool {</span>
<span class="term-fg32">+	for i, c := range v { &#47;&#47; following semver.org advertised regex, alphanumeric with &#39;-&#39; and &#39;.&#39;, except leading &#39;.&#39;.</span>
<span class="term-fg32">+		if c == 0 { &#47;&#47; trailing zeroed are allowed</span>
<span class="term-fg32">+			for _, d := range v[i:] {</span>
<span class="term-fg32">+				if d != 0 {</span>
<span class="term-fg32">+					return false</span>
<span class="term-fg32">+				}</span>
<span class="term-fg32">+			}</span>
<span class="term-fg32">+			return true</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+		if !((c &gt;= &#39;A&#39; &amp;&amp; c &lt;= &#39;Z&#39;) || (c &gt;= &#39;a&#39; &amp;&amp; c &lt;= &#39;z&#39;) || (c &gt;= &#39;0&#39; &amp;&amp; c &lt;= &#39;9&#39;) || c == &#39;-&#39; || (c == &#39;.&#39; &amp;&amp; i &gt; 0)) {</span>
<span class="term-fg32">+			return false</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	return true</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+&#47;&#47; ProtocolVersionComparison is used to identify how far ahead&#47;outdated a protocol version is relative to another.</span>
<span class="term-fg32">+&#47;&#47; This value is used in metrics and switch comparisons, to easily identify each type of version difference.</span>
<span class="term-fg32">+&#47;&#47; Negative values mean the version is outdated.</span>
<span class="term-fg32">+&#47;&#47; Positive values mean the version is up-to-date.</span>
<span class="term-fg32">+&#47;&#47; Matching versions have a 0.</span>
<span class="term-fg32">+type ProtocolVersionComparison int</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+const (</span>
<span class="term-fg32">+	AheadMajor         ProtocolVersionComparison = 4</span>
<span class="term-fg32">+	OutdatedMajor      ProtocolVersionComparison = -4</span>
<span class="term-fg32">+	AheadMinor         ProtocolVersionComparison = 3</span>
<span class="term-fg32">+	OutdatedMinor      ProtocolVersionComparison = -3</span>
<span class="term-fg32">+	AheadPatch         ProtocolVersionComparison = 2</span>
<span class="term-fg32">+	OutdatedPatch      ProtocolVersionComparison = -2</span>
<span class="term-fg32">+	AheadPrerelease    ProtocolVersionComparison = 1</span>
<span class="term-fg32">+	OutdatedPrerelease ProtocolVersionComparison = -1</span>
<span class="term-fg32">+	Matching           ProtocolVersionComparison = 0</span>
<span class="term-fg32">+	DiffVersionType    ProtocolVersionComparison = 100</span>
<span class="term-fg32">+	DiffBuild          ProtocolVersionComparison = 101</span>
<span class="term-fg32">+	EmptyVersion       ProtocolVersionComparison = 102</span>
<span class="term-fg32">+	InvalidVersion     ProtocolVersionComparison = 103</span>
<span class="term-fg32">+)</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func (p ProtocolVersion) Compare(other ProtocolVersion) (cmp ProtocolVersionComparison) {</span>
<span class="term-fg32">+	if p == (ProtocolVersion{}) || (other == (ProtocolVersion{})) {</span>
<span class="term-fg32">+		return EmptyVersion</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	aVersionType, aBuild, aMajor, aMinor, aPatch, aPreRelease := p.Parse()</span>
<span class="term-fg32">+	bVersionType, bBuild, bMajor, bMinor, bPatch, bPreRelease := other.Parse()</span>
<span class="term-fg32">+	if aVersionType != bVersionType {</span>
<span class="term-fg32">+		return DiffVersionType</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	if aBuild != bBuild {</span>
<span class="term-fg32">+		return DiffBuild</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	&#47;&#47; max values are reserved, consider versions with these values invalid</span>
<span class="term-fg32">+	if aMajor == ^uint32(0) || aMinor == ^uint32(0) || aPatch == ^uint32(0) || aPreRelease == ^uint32(0) ||</span>
<span class="term-fg32">+		bMajor == ^uint32(0) || bMinor == ^uint32(0) || bPatch == ^uint32(0) || bPreRelease == ^uint32(0) {</span>
<span class="term-fg32">+		return InvalidVersion</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	fn := func(a, b uint32, ahead, outdated ProtocolVersionComparison) ProtocolVersionComparison {</span>
<span class="term-fg32">+		if a == b {</span>
<span class="term-fg32">+			return Matching</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+		if a &gt; b {</span>
<span class="term-fg32">+			return ahead</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+		return outdated</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	if aPreRelease != 0 { &#47;&#47; if A is a pre-release, then decrement the version before comparison</span>
<span class="term-fg32">+		if aPatch != 0 {</span>
<span class="term-fg32">+			aPatch -= 1</span>
<span class="term-fg32">+		} else if aMinor != 0 {</span>
<span class="term-fg32">+			aMinor -= 1</span>
<span class="term-fg32">+			aPatch = ^uint32(0) &#47;&#47; max value</span>
<span class="term-fg32">+		} else if aMajor != 0 {</span>
<span class="term-fg32">+			aMajor -= 1</span>
<span class="term-fg32">+			aMinor = ^uint32(0) &#47;&#47; max value</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	if bPreRelease != 0 { &#47;&#47; if B is a pre-release, then decrement the version before comparison</span>
<span class="term-fg32">+		if bPatch != 0 {</span>
<span class="term-fg32">+			bPatch -= 1</span>
<span class="term-fg32">+		} else if bMinor != 0 {</span>
<span class="term-fg32">+			bMinor -= 1</span>
<span class="term-fg32">+			bPatch = ^uint32(0) &#47;&#47; max value</span>
<span class="term-fg32">+		} else if bMajor != 0 {</span>
<span class="term-fg32">+			bMajor -= 1</span>
<span class="term-fg32">+			bMinor = ^uint32(0) &#47;&#47; max value</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	if c := fn(aMajor, bMajor, AheadMajor, OutdatedMajor); c != Matching {</span>
<span class="term-fg32">+		return c</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	if c := fn(aMinor, bMinor, AheadMinor, OutdatedMinor); c != Matching {</span>
<span class="term-fg32">+		return c</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	if c := fn(aPatch, bPatch, AheadPatch, OutdatedPatch); c != Matching {</span>
<span class="term-fg32">+		return c</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	return fn(aPreRelease, bPreRelease, AheadPrerelease, OutdatedPrerelease)</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+type ProtocolVersionV0 struct {</span>
<span class="term-fg32">+	Build                           [8]byte</span>
<span class="term-fg32">+	Major, Minor, Patch, PreRelease uint32</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func (v ProtocolVersionV0) Encode() (out ProtocolVersion) {</span>
<span class="term-fg32">+	copy(out[8:16], v.Build[:])</span>
<span class="term-fg32">+	binary.BigEndian.PutUint32(out[16:20], v.Major)</span>
<span class="term-fg32">+	binary.BigEndian.PutUint32(out[20:24], v.Minor)</span>
<span class="term-fg32">+	binary.BigEndian.PutUint32(out[24:28], v.Patch)</span>
<span class="term-fg32">+	binary.BigEndian.PutUint32(out[28:32], v.PreRelease)</span>
<span class="term-fg32">+	return</span>
<span class="term-fg32">+}</span></div>
    </div>

            
        </div>
        <div>
            
        </div>
    </div>
</div>

            
        </div>
    </div>
</div>

            
                <div class="ps-1 py-2 my-1"><div class="row border-bottom border-1"data-bs-toggle="collapse" data-bs-target="#id-984635c08c3def5f02c881ce"role="button" aria-expanded="false" aria-controls="id-984635c08c3def5f02c881ce">
        
            <div class="col-12 col-sm-9 text-start"><h2>Node modifications</h2></div>
        
        <div class="col-12 col-sm-3 ms-auto mt-2">
            <div class="row line-stat">
                <div class="text-end"><span class="text-success">+604</span></div>
                <div class="text-start"><span class="text-danger">-304</span></div>
            </div>
        </div>
    </div>

    <div class="row forkdef-content collapse  border-1 ps-3 my-3" id="id-984635c08c3def5f02c881ce">
        <div><p>Changes to the node configuration and services.</p>
</div>
        <div>
            
        </div>
        <div>
            
                <div class="ps-1 py-2 my-1"><div class="row border-bottom border-1"data-bs-toggle="collapse" data-bs-target="#id-d18bec15651cf4742149a990"role="button" aria-expanded="false" aria-controls="id-d18bec15651cf4742149a990">
        
            <div class="col-12 col-sm-9 text-start"><h3>CLI</h3></div>
        
        <div class="col-12 col-sm-3 ms-auto mt-2">
            <div class="row line-stat">
                <div class="text-end"><span class="text-success">+256</span></div>
                <div class="text-start"><span class="text-danger">-106</span></div>
            </div>
        </div>
    </div>

    <div class="row forkdef-content collapse  border-1 ps-3 my-3" id="id-d18bec15651cf4742149a990">
        <div></div>
        <div>
            
        </div>
        <div>
            
                <div class="ps-1 py-2 my-1"><div class="row border-bottom border-1"data-bs-toggle="collapse" data-bs-target="#id-1b86412d0679d0cf21be761e"role="button" aria-expanded="false" aria-controls="id-1b86412d0679d0cf21be761e">
        
            <div class="col-12 col-sm-9 text-start"><h4>Flags</h4></div>
        
        <div class="col-12 col-sm-3 ms-auto mt-2">
            <div class="row line-stat">
                <div class="text-end"><span class="text-success">+201</span></div>
                <div class="text-start"><span class="text-danger">-100</span></div>
            </div>
        </div>
    </div>

    <div class="row forkdef-content collapse  border-1 ps-3 my-3" id="id-1b86412d0679d0cf21be761e">
        <div><p>Flag changes:
  - Transactions can be forwarded to an RPC for sequencing.
  - Historical calls can be forwarded to a legacy node.
  - The tx pool propagation can be enabled/disabled.
  - The Optimism bedrock fork activation can be changed for testing.</p>
</div>
        <div>
            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-b151846f8cb7117edf913b79" role="button"
                   aria-expanded="false" aria-controls="id-b151846f8cb7117edf913b79">
                    <code>cmd/utils/flags.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/3f40e65c484486dea6cff80b7db178985d21a2c6/cmd/utils/flags.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/650bb2f2b1dcfe30d9b1fa6f7dc9608055ed60e1/cmd/utils/flags.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+164</span></div>
                        <div class="text-start"><span class="text-danger">-93</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-b151846f8cb7117edf913b79"><span class="term-fg1">diff --git go-ethereum&#47;cmd&#47;utils&#47;flags.go op-geth&#47;cmd&#47;utils&#47;flags.go</span>
<span class="term-fg1">index f5f131951af84c964355785eafbd16363dd0b7b3..58be0d5cf072b54b4dbd6637325e678d34ef8b27 100644</span>
<span class="term-fg1">--- go-ethereum&#47;cmd&#47;utils&#47;flags.go</span>
<span class="term-fg1">+++ op-geth&#47;cmd&#47;utils&#47;flags.go</span>
<span class="term-fg36">@@ -18,7 +18,6 @@</span> &#47;&#47; Package utils contains internal helper functions for go-ethereum commands.
 package utils
&nbsp;
 import (
<span class="term-fg31">-	&quot;bytes&quot;</span>
 	&quot;context&quot;
 	&quot;crypto&#47;ecdsa&quot;
 	&quot;encoding&#47;hex&quot;
<span class="term-fg36">@@ -39,11 +38,9 @@</span> 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;accounts&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;accounts&#47;keystore&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;common&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;common&#47;fdlimit&quot;
<span class="term-fg31">-	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;common&#47;hexutil&quot;</span>
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;core&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;core&#47;rawdb&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;core&#47;txpool&#47;legacypool&quot;
<span class="term-fg31">-	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;core&#47;types&quot;</span>
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;core&#47;vm&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;crypto&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;crypto&#47;kzg4844&quot;
<span class="term-fg36">@@ -72,7 +69,6 @@</span> 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;p2p&#47;enode&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;p2p&#47;nat&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;p2p&#47;netutil&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;params&quot;
<span class="term-fg31">-	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;rlp&quot;</span>
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;rpc&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;trie&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;trie&#47;triedb&#47;hashdb&quot;
<span class="term-fg36">@@ -160,6 +156,15 @@</span> 		Name:     &quot;holesky&quot;,
 		Usage:    &quot;Holesky network: pre-configured proof-of-stake test network&quot;,
 		Category: flags.EthCategory,
 	}
<span class="term-fg32">+</span>
<span class="term-fg32">+	OPNetworkFlag = &amp;cli.StringFlag{</span>
<span class="term-fg32">+		Name:    &quot;op-network&quot;,</span>
<span class="term-fg32">+		Aliases: []string{&quot;beta.op-network&quot;},</span>
<span class="term-fg32">+		Usage: &quot;Select a pre-configured OP-Stack network (warning: op-mainnet and op-goerli require special sync,&quot; +</span>
<span class="term-fg32">+			&quot; datadir is recommended), options: &quot; + strings.Join(params.OPStackChainNames(), &quot;, &quot;),</span>
<span class="term-fg32">+		Category: flags.EthCategory,</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+</span>
 	&#47;&#47; Dev mode
 	DeveloperFlag = &amp;cli.BoolFlag{
 		Name:     &quot;dev&quot;,
<span class="term-fg36">@@ -257,6 +262,11 @@</span> 		Name:     &quot;override.verkle&quot;,
 		Usage:    &quot;Manually specify the Verkle fork timestamp, overriding the bundled setting&quot;,
 		Category: flags.EthCategory,
 	}
<span class="term-fg32">+	OverrideOptimismCanyon = &amp;flags.BigFlag{</span>
<span class="term-fg32">+		Name:     &quot;override.canyon&quot;,</span>
<span class="term-fg32">+		Usage:    &quot;Manually specify the Optimsim Canyon fork timestamp, overriding the bundled setting&quot;,</span>
<span class="term-fg32">+		Category: flags.EthCategory,</span>
<span class="term-fg32">+	}</span>
 	SyncModeFlag = &amp;flags.TextMarshalerFlag{
 		Name:     &quot;syncmode&quot;,
 		Usage:    `Blockchain sync mode (&quot;snap&quot;, &quot;full&quot; or &quot;light&quot;)`,
<span class="term-fg36">@@ -272,7 +282,6 @@</span> 	}
 	StateSchemeFlag = &amp;cli.StringFlag{
 		Name:     &quot;state.scheme&quot;,
 		Usage:    &quot;Scheme to use for storing ethereum state (&#39;hash&#39; or &#39;path&#39;)&quot;,
<span class="term-fg31">-		Value:    rawdb.HashScheme,</span>
 		Category: flags.StateCategory,
 	}
 	StateHistoryFlag = &amp;cli.Uint64Flag{
<span class="term-fg36">@@ -337,6 +346,11 @@</span> 	TxPoolJournalFlag = &amp;cli.StringFlag{
 		Name:     &quot;txpool.journal&quot;,
 		Usage:    &quot;Disk journal for local transaction to survive node restarts&quot;,
 		Value:    ethconfig.Defaults.TxPool.Journal,
<span class="term-fg32">+		Category: flags.TxPoolCategory,</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	TxPoolJournalRemotesFlag = &amp;cli.BoolFlag{</span>
<span class="term-fg32">+		Name:     &quot;txpool.journalremotes&quot;,</span>
<span class="term-fg32">+		Usage:    &quot;Includes remote transactions in the journal&quot;,</span>
 		Category: flags.TxPoolCategory,
 	}
 	TxPoolRejournalFlag = &amp;cli.DurationFlag{
<span class="term-fg36">@@ -595,9 +609,9 @@</span> 		Category: flags.LoggingCategory,
 	}
&nbsp;
 	&#47;&#47; MISC settings
<span class="term-fg31">-	SyncTargetFlag = &amp;cli.PathFlag{</span>
<span class="term-fg32">+	SyncTargetFlag = &amp;cli.StringFlag{</span>
 		Name:      &quot;synctarget&quot;,
<span class="term-fg31">-		Usage:     `File for containing the hex-encoded block-rlp as sync target(dev feature)`,</span>
<span class="term-fg32">+		Usage:     `Hash of the block to full sync to (dev testing feature)`,</span>
 		TakesFile: true,
 		Category:  flags.MiscCategory,
 	}
<span class="term-fg36">@@ -854,6 +868,59 @@</span> 		Usage:    &quot;Gas price below which gpo will ignore transactions&quot;,
 		Value:    ethconfig.Defaults.GPO.IgnorePrice.Int64(),
 		Category: flags.GasPriceCategory,
 	}
<span class="term-fg32">+	GpoMinSuggestedPriorityFeeFlag = &amp;cli.Int64Flag{</span>
<span class="term-fg32">+		Name:     &quot;gpo.minsuggestedpriorityfee&quot;,</span>
<span class="term-fg32">+		Usage:    &quot;Minimum transaction priority fee to suggest. Used on OP chains when blocks are not full.&quot;,</span>
<span class="term-fg32">+		Value:    ethconfig.Defaults.GPO.MinSuggestedPriorityFee.Int64(),</span>
<span class="term-fg32">+		Category: flags.GasPriceCategory,</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	&#47;&#47; Rollup Flags</span>
<span class="term-fg32">+	RollupSequencerHTTPFlag = &amp;cli.StringFlag{</span>
<span class="term-fg32">+		Name:     &quot;rollup.sequencerhttp&quot;,</span>
<span class="term-fg32">+		Usage:    &quot;HTTP endpoint for the sequencer mempool&quot;,</span>
<span class="term-fg32">+		Category: flags.RollupCategory,</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	RollupHistoricalRPCFlag = &amp;cli.StringFlag{</span>
<span class="term-fg32">+		Name:     &quot;rollup.historicalrpc&quot;,</span>
<span class="term-fg32">+		Usage:    &quot;RPC endpoint for historical data.&quot;,</span>
<span class="term-fg32">+		Category: flags.RollupCategory,</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	RollupHistoricalRPCTimeoutFlag = &amp;cli.StringFlag{</span>
<span class="term-fg32">+		Name:     &quot;rollup.historicalrpctimeout&quot;,</span>
<span class="term-fg32">+		Usage:    &quot;Timeout for historical RPC requests.&quot;,</span>
<span class="term-fg32">+		Value:    &quot;5s&quot;,</span>
<span class="term-fg32">+		Category: flags.RollupCategory,</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	RollupDisableTxPoolGossipFlag = &amp;cli.BoolFlag{</span>
<span class="term-fg32">+		Name:     &quot;rollup.disabletxpoolgossip&quot;,</span>
<span class="term-fg32">+		Usage:    &quot;Disable transaction pool gossip.&quot;,</span>
<span class="term-fg32">+		Category: flags.RollupCategory,</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	RollupEnableTxPoolAdmissionFlag = &amp;cli.BoolFlag{</span>
<span class="term-fg32">+		Name:     &quot;rollup.enabletxpooladmission&quot;,</span>
<span class="term-fg32">+		Usage:    &quot;Add RPC-submitted transactions to the txpool (on by default if --rollup.sequencerhttp is not set).&quot;,</span>
<span class="term-fg32">+		Category: flags.RollupCategory,</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	RollupComputePendingBlock = &amp;cli.BoolFlag{</span>
<span class="term-fg32">+		Name:     &quot;rollup.computependingblock&quot;,</span>
<span class="term-fg32">+		Usage:    &quot;By default the pending block equals the latest block to save resources and not leak txs from the tx-pool, this flag enables computing of the pending block from the tx-pool instead.&quot;,</span>
<span class="term-fg32">+		Category: flags.RollupCategory,</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	RollupHaltOnIncompatibleProtocolVersionFlag = &amp;cli.StringFlag{</span>
<span class="term-fg32">+		Name:     &quot;rollup.halt&quot;,</span>
<span class="term-fg32">+		Usage:    &quot;Opt-in option to halt on incompatible protocol version requirements of the given level (major&#47;minor&#47;patch&#47;none), as signaled through the Engine API by the rollup node&quot;,</span>
<span class="term-fg32">+		Category: flags.RollupCategory,</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	RollupSuperchainUpgradesFlag = &amp;cli.BoolFlag{</span>
<span class="term-fg32">+		Name:     &quot;rollup.superchain-upgrades&quot;,</span>
<span class="term-fg32">+		Aliases:  []string{&quot;beta.rollup.superchain-upgrades&quot;},</span>
<span class="term-fg32">+		Usage:    &quot;Apply superchain-registry config changes to the local chain-configuration&quot;,</span>
<span class="term-fg32">+		Category: flags.RollupCategory,</span>
<span class="term-fg32">+	}</span>
&nbsp;
 	&#47;&#47; Metrics flags
 	MetricsEnabledFlag = &amp;cli.BoolFlag{
<span class="term-fg36">@@ -959,20 +1026,21 @@</span> 		SepoliaFlag,
 		HoleskyFlag,
 	}
 	&#47;&#47; NetworkFlags is the flag group of all built-in supported networks.
<span class="term-fg31">-	NetworkFlags = append([]cli.Flag{MainnetFlag}, TestnetFlags...)</span>
<span class="term-fg32">+	NetworkFlags = append([]cli.Flag{MainnetFlag, OPNetworkFlag}, TestnetFlags...)</span>
&nbsp;
<span class="term-fg31">-	&#47;&#47; DatabasePathFlags is the flag group of all database path flags.</span>
<span class="term-fg31">-	DatabasePathFlags = []cli.Flag{</span>
<span class="term-fg32">+	&#47;&#47; DatabaseFlags is the flag group of all database flags.</span>
<span class="term-fg32">+	DatabaseFlags = []cli.Flag{</span>
 		DataDirFlag,
 		AncientFlag,
 		RemoteDBFlag,
<span class="term-fg32">+		StateSchemeFlag,</span>
 		HttpHeaderFlag,
 	}
 )
&nbsp;
 func init() {
 	if rawdb.PebbleEnabled {
<span class="term-fg31">-		DatabasePathFlags = append(DatabasePathFlags, DBEngineFlag)</span>
<span class="term-fg32">+		DatabaseFlags = append(DatabaseFlags, DBEngineFlag)</span>
 	}
 }
&nbsp;
<span class="term-fg36">@@ -990,6 +1058,9 @@</span> 		}
 		if ctx.Bool(HoleskyFlag.Name) {
 			return filepath.Join(path, &quot;holesky&quot;)
 		}
<span class="term-fg32">+		if ctx.IsSet(OPNetworkFlag.Name) {</span>
<span class="term-fg32">+			return filepath.Join(path, ctx.String(OPNetworkFlag.Name))</span>
<span class="term-fg32">+		}</span>
 		return path
 	}
 	Fatalf(&quot;Cannot determine default data directory, please set manually (--datadir)&quot;)
<span class="term-fg36">@@ -998,7 +1069,7 @@</span> }
&nbsp;
 &#47;&#47; setNodeKey creates a node key from set command line flags, either loading it
 &#47;&#47; from a file or as a specified hex value. If neither flags were provided, this
<span class="term-fg31">-&#47;&#47; method returns nil and an emphemeral key is to be generated.</span>
<span class="term-fg32">+&#47;&#47; method returns nil and an ephemeral key is to be generated.</span>
 func setNodeKey(ctx *cli.Context, cfg *p2p.Config) {
 	var (
 		hex  = ctx.String(NodeKeyHexFlag.Name)
<span class="term-fg36">@@ -1031,35 +1102,45 @@</span> }
&nbsp;
 &#47;&#47; setBootstrapNodes creates a list of bootstrap nodes from the command line
 &#47;&#47; flags, reverting to pre-configured ones if none have been specified.
<span class="term-fg32">+&#47;&#47; Priority order for bootnodes configuration:</span>
<span class="term-fg32">+&#47;&#47;</span>
<span class="term-fg32">+&#47;&#47; 1. --bootnodes flag</span>
<span class="term-fg32">+&#47;&#47; 2. Config file</span>
<span class="term-fg32">+&#47;&#47; 3. Network preset flags (e.g. --goerli)</span>
<span class="term-fg32">+&#47;&#47; 4. default to mainnet nodes</span>
 func setBootstrapNodes(ctx *cli.Context, cfg *p2p.Config) {
 	urls := params.MainnetBootnodes
<span class="term-fg31">-	switch {</span>
<span class="term-fg31">-	case ctx.IsSet(BootnodesFlag.Name):</span>
<span class="term-fg32">+	if ctx.IsSet(BootnodesFlag.Name) {</span>
 		urls = SplitAndTrim(ctx.String(BootnodesFlag.Name))
<span class="term-fg31">-	case ctx.Bool(HoleskyFlag.Name):</span>
<span class="term-fg31">-		urls = params.HoleskyBootnodes</span>
<span class="term-fg31">-	case ctx.Bool(SepoliaFlag.Name):</span>
<span class="term-fg31">-		urls = params.SepoliaBootnodes</span>
<span class="term-fg31">-	case ctx.Bool(GoerliFlag.Name):</span>
<span class="term-fg31">-		urls = params.GoerliBootnodes</span>
<span class="term-fg32">+	} else {</span>
<span class="term-fg32">+		if cfg.BootstrapNodes != nil {</span>
<span class="term-fg32">+			return &#47;&#47; Already set by config file, don&#39;t apply defaults.</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+		switch {</span>
<span class="term-fg32">+		case ctx.Bool(HoleskyFlag.Name):</span>
<span class="term-fg32">+			urls = params.HoleskyBootnodes</span>
<span class="term-fg32">+		case ctx.Bool(SepoliaFlag.Name):</span>
<span class="term-fg32">+			urls = params.SepoliaBootnodes</span>
<span class="term-fg32">+		case ctx.Bool(GoerliFlag.Name):</span>
<span class="term-fg32">+			urls = params.GoerliBootnodes</span>
<span class="term-fg32">+		}</span>
 	}
<span class="term-fg32">+	cfg.BootstrapNodes = mustParseBootnodes(urls)</span>
<span class="term-fg32">+}</span>
&nbsp;
<span class="term-fg31">-	&#47;&#47; don&#39;t apply defaults if BootstrapNodes is already set</span>
<span class="term-fg31">-	if cfg.BootstrapNodes != nil {</span>
<span class="term-fg31">-		return</span>
<span class="term-fg31">-	}</span>
<span class="term-fg31">-</span>
<span class="term-fg31">-	cfg.BootstrapNodes = make([]*enode.Node, 0, len(urls))</span>
<span class="term-fg32">+func mustParseBootnodes(urls []string) []*enode.Node {</span>
<span class="term-fg32">+	nodes := make([]*enode.Node, 0, len(urls))</span>
 	for _, url := range urls {
 		if url != &quot;&quot; {
 			node, err := enode.Parse(enode.ValidSchemes, url)
 			if err != nil {
 				log.Crit(&quot;Bootstrap URL invalid&quot;, &quot;enode&quot;, url, &quot;err&quot;, err)
<span class="term-fg31">-				continue</span>
<span class="term-fg32">+				return nil</span>
 			}
<span class="term-fg31">-			cfg.BootstrapNodes = append(cfg.BootstrapNodes, node)</span>
<span class="term-fg32">+			nodes = append(nodes, node)</span>
 		}
 	}
<span class="term-fg32">+	return nodes</span>
 }
&nbsp;
 &#47;&#47; setBootstrapNodesV5 creates a list of bootstrap nodes from the command line
<span class="term-fg36">@@ -1492,6 +1573,8 @@</span> 	case ctx.Bool(SepoliaFlag.Name) &amp;&amp; cfg.DataDir == node.DefaultDataDir():
 		cfg.DataDir = filepath.Join(node.DefaultDataDir(), &quot;sepolia&quot;)
 	case ctx.Bool(HoleskyFlag.Name) &amp;&amp; cfg.DataDir == node.DefaultDataDir():
 		cfg.DataDir = filepath.Join(node.DefaultDataDir(), &quot;holesky&quot;)
<span class="term-fg32">+	case ctx.IsSet(OPNetworkFlag.Name) &amp;&amp; cfg.DataDir == node.DefaultDataDir():</span>
<span class="term-fg32">+		cfg.DataDir = filepath.Join(node.DefaultDataDir(), ctx.String(OPNetworkFlag.Name))</span>
 	}
 }
&nbsp;
<span class="term-fg36">@@ -1513,6 +1596,9 @@</span> 	}
 	if ctx.IsSet(GpoIgnoreGasPriceFlag.Name) {
 		cfg.IgnorePrice = big.NewInt(ctx.Int64(GpoIgnoreGasPriceFlag.Name))
 	}
<span class="term-fg32">+	if ctx.IsSet(GpoMinSuggestedPriorityFeeFlag.Name) {</span>
<span class="term-fg32">+		cfg.MinSuggestedPriorityFee = big.NewInt(ctx.Int64(GpoMinSuggestedPriorityFeeFlag.Name))</span>
<span class="term-fg32">+	}</span>
 }
&nbsp;
 func setTxPool(ctx *cli.Context, cfg *legacypool.Config) {
<span class="term-fg36">@@ -1532,6 +1618,9 @@</span> 	}
 	if ctx.IsSet(TxPoolJournalFlag.Name) {
 		cfg.Journal = ctx.String(TxPoolJournalFlag.Name)
 	}
<span class="term-fg32">+	if ctx.IsSet(TxPoolJournalRemotesFlag.Name) {</span>
<span class="term-fg32">+		cfg.JournalRemote = ctx.Bool(TxPoolJournalRemotesFlag.Name)</span>
<span class="term-fg32">+	}</span>
 	if ctx.IsSet(TxPoolRejournalFlag.Name) {
 		cfg.Rejournal = ctx.Duration(TxPoolRejournalFlag.Name)
 	}
<span class="term-fg36">@@ -1573,6 +1662,9 @@</span> 		cfg.Recommit = ctx.Duration(MinerRecommitIntervalFlag.Name)
 	}
 	if ctx.IsSet(MinerNewPayloadTimeout.Name) {
 		cfg.NewPayloadTimeout = ctx.Duration(MinerNewPayloadTimeout.Name)
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	if ctx.IsSet(RollupComputePendingBlock.Name) {</span>
<span class="term-fg32">+		cfg.RollupComputePendingBlock = ctx.Bool(RollupComputePendingBlock.Name)</span>
 	}
 }
&nbsp;
<span class="term-fg36">@@ -1648,7 +1740,7 @@</span>
 &#47;&#47; SetEthConfig applies eth-related command line flags to the config.
 func SetEthConfig(ctx *cli.Context, stack *node.Node, cfg *ethconfig.Config) {
 	&#47;&#47; Avoid conflicting network flags
<span class="term-fg31">-	CheckExclusive(ctx, MainnetFlag, DeveloperFlag, GoerliFlag, SepoliaFlag, HoleskyFlag)</span>
<span class="term-fg32">+	CheckExclusive(ctx, MainnetFlag, DeveloperFlag, GoerliFlag, SepoliaFlag, HoleskyFlag, OPNetworkFlag)</span>
 	CheckExclusive(ctx, LightServeFlag, SyncModeFlag, &quot;light&quot;)
 	CheckExclusive(ctx, DeveloperFlag, ExternalSignerFlag) &#47;&#47; Can&#39;t use both ephemeral unlocked and external signer
&nbsp;
<span class="term-fg36">@@ -1680,7 +1772,9 @@</span>
 	log.Debug(&quot;Sanitizing Go&#39;s GC trigger&quot;, &quot;percent&quot;, int(gogc))
 	godebug.SetGCPercent(int(gogc))
&nbsp;
<span class="term-fg31">-	if ctx.IsSet(SyncModeFlag.Name) {</span>
<span class="term-fg32">+	if ctx.IsSet(SyncTargetFlag.Name) {</span>
<span class="term-fg32">+		cfg.SyncMode = downloader.FullSync &#47;&#47; dev sync target forces full sync</span>
<span class="term-fg32">+	} else if ctx.IsSet(SyncModeFlag.Name) {</span>
 		cfg.SyncMode = *flags.GlobalTextMarshaler(ctx, SyncModeFlag.Name).(*downloader.SyncMode)
 	}
 	if ctx.IsSet(NetworkIdFlag.Name) {
<span class="term-fg36">@@ -1712,15 +1806,9 @@</span> 	}
 	if ctx.IsSet(StateHistoryFlag.Name) {
 		cfg.StateHistory = ctx.Uint64(StateHistoryFlag.Name)
 	}
<span class="term-fg31">-	&#47;&#47; Parse state scheme, abort the process if it&#39;s not compatible.</span>
<span class="term-fg31">-	chaindb := tryMakeReadOnlyDatabase(ctx, stack)</span>
<span class="term-fg31">-	scheme, err := ParseStateScheme(ctx, chaindb)</span>
<span class="term-fg31">-	chaindb.Close()</span>
<span class="term-fg31">-	if err != nil {</span>
<span class="term-fg31">-		Fatalf(&quot;%v&quot;, err)</span>
<span class="term-fg32">+	if ctx.IsSet(StateSchemeFlag.Name) {</span>
<span class="term-fg32">+		cfg.StateScheme = ctx.String(StateSchemeFlag.Name)</span>
 	}
<span class="term-fg31">-	cfg.StateScheme = scheme</span>
<span class="term-fg31">-</span>
 	&#47;&#47; Parse transaction history flag, if user is still using legacy config
 	&#47;&#47; file with &#39;TxLookupLimit&#39; configured, copy the value to &#39;TransactionHistory&#39;.
 	if cfg.TransactionHistory == ethconfig.Defaults.TransactionHistory &amp;&amp; cfg.TxLookupLimit != ethconfig.Defaults.TxLookupLimit {
<span class="term-fg36">@@ -1793,6 +1881,20 @@</span> 		} else {
 			cfg.EthDiscoveryURLs = SplitAndTrim(urls)
 		}
 	}
<span class="term-fg32">+	&#47;&#47; Only configure sequencer http flag if we&#39;re running in verifier mode i.e. --mine is disabled.</span>
<span class="term-fg32">+	if ctx.IsSet(RollupSequencerHTTPFlag.Name) &amp;&amp; !ctx.IsSet(MiningEnabledFlag.Name) {</span>
<span class="term-fg32">+		cfg.RollupSequencerHTTP = ctx.String(RollupSequencerHTTPFlag.Name)</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	if ctx.IsSet(RollupHistoricalRPCFlag.Name) {</span>
<span class="term-fg32">+		cfg.RollupHistoricalRPC = ctx.String(RollupHistoricalRPCFlag.Name)</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	if ctx.IsSet(RollupHistoricalRPCTimeoutFlag.Name) {</span>
<span class="term-fg32">+		cfg.RollupHistoricalRPCTimeout = ctx.Duration(RollupHistoricalRPCTimeoutFlag.Name)</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	cfg.RollupDisableTxPoolGossip = ctx.Bool(RollupDisableTxPoolGossipFlag.Name)</span>
<span class="term-fg32">+	cfg.RollupDisableTxPoolAdmission = cfg.RollupSequencerHTTP != &quot;&quot; &amp;&amp; !ctx.Bool(RollupEnableTxPoolAdmissionFlag.Name)</span>
<span class="term-fg32">+	cfg.RollupHaltOnIncompatibleProtocolVersion = ctx.String(RollupHaltOnIncompatibleProtocolVersionFlag.Name)</span>
<span class="term-fg32">+	cfg.ApplySuperchainUpgrades = ctx.Bool(RollupSuperchainUpgradesFlag.Name)</span>
 	&#47;&#47; Override any default configs for hard coded networks.
 	switch {
 	case ctx.Bool(MainnetFlag.Name):
<span class="term-fg36">@@ -1879,6 +1981,12 @@</span> 		}
 		if !ctx.IsSet(MinerGasPriceFlag.Name) {
 			cfg.Miner.GasPrice = big.NewInt(1)
 		}
<span class="term-fg32">+	case ctx.IsSet(OPNetworkFlag.Name):</span>
<span class="term-fg32">+		genesis := MakeGenesis(ctx)</span>
<span class="term-fg32">+		if !ctx.IsSet(NetworkIdFlag.Name) {</span>
<span class="term-fg32">+			cfg.NetworkId = genesis.Config.ChainID.Uint64()</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+		cfg.Genesis = genesis</span>
 	default:
 		if cfg.NetworkId == 1 {
 			SetDNSDiscoveryDefaults(cfg, params.MainnetGenesisHash)
<span class="term-fg36">@@ -1965,21 +2073,9 @@</span> 	return filterSystem
 }
&nbsp;
 &#47;&#47; RegisterFullSyncTester adds the full-sync tester service into node.
<span class="term-fg31">-func RegisterFullSyncTester(stack *node.Node, eth *eth.Ethereum, path string) {</span>
<span class="term-fg31">-	blob, err := os.ReadFile(path)</span>
<span class="term-fg31">-	if err != nil {</span>
<span class="term-fg31">-		Fatalf(&quot;Failed to read block file: %v&quot;, err)</span>
<span class="term-fg31">-	}</span>
<span class="term-fg31">-	rlpBlob, err := hexutil.Decode(string(bytes.TrimRight(blob, &quot;\r\n&quot;)))</span>
<span class="term-fg31">-	if err != nil {</span>
<span class="term-fg31">-		Fatalf(&quot;Failed to decode block blob: %v&quot;, err)</span>
<span class="term-fg31">-	}</span>
<span class="term-fg31">-	var block types.Block</span>
<span class="term-fg31">-	if err := rlp.DecodeBytes(rlpBlob, &amp;block); err != nil {</span>
<span class="term-fg31">-		Fatalf(&quot;Failed to decode block: %v&quot;, err)</span>
<span class="term-fg31">-	}</span>
<span class="term-fg31">-	catalyst.RegisterFullSyncTester(stack, eth, &amp;block)</span>
<span class="term-fg31">-	log.Info(&quot;Registered full-sync tester&quot;, &quot;number&quot;, block.NumberU64(), &quot;hash&quot;, block.Hash())</span>
<span class="term-fg32">+func RegisterFullSyncTester(stack *node.Node, eth *eth.Ethereum, target common.Hash) {</span>
<span class="term-fg32">+	catalyst.RegisterFullSyncTester(stack, eth, target)</span>
<span class="term-fg32">+	log.Info(&quot;Registered full-sync tester&quot;, &quot;hash&quot;, target)</span>
 }
&nbsp;
 func SetupMetrics(ctx *cli.Context) {
<span class="term-fg36">@@ -2102,8 +2198,7 @@</span> }
&nbsp;
 func IsNetworkPreset(ctx *cli.Context) bool {
 	for _, flag := range NetworkFlags {
<span class="term-fg31">-		bFlag, _ := flag.(*cli.BoolFlag)</span>
<span class="term-fg31">-		if ctx.IsSet(bFlag.Name) {</span>
<span class="term-fg32">+		if ctx.IsSet(flag.Names()[0]) {</span>
 			return true
 		}
 	}
<span class="term-fg36">@@ -2121,7 +2216,7 @@</span> 		endpoint = endpoint[4:]
 	}
 	var opts []rpc.ClientOption
 	if len(headers) &gt; 0 {
<span class="term-fg31">-		var customHeaders = make(http.Header)</span>
<span class="term-fg32">+		customHeaders := make(http.Header)</span>
 		for _, h := range headers {
 			kv := strings.Split(h, &quot;:&quot;)
 			if len(kv) != 2 {
<span class="term-fg36">@@ -2145,6 +2240,17 @@</span> 	case ctx.Bool(SepoliaFlag.Name):
 		genesis = core.DefaultSepoliaGenesisBlock()
 	case ctx.Bool(GoerliFlag.Name):
 		genesis = core.DefaultGoerliGenesisBlock()
<span class="term-fg32">+	case ctx.IsSet(OPNetworkFlag.Name):</span>
<span class="term-fg32">+		name := ctx.String(OPNetworkFlag.Name)</span>
<span class="term-fg32">+		ch, err := params.OPStackChainIDByName(name)</span>
<span class="term-fg32">+		if err != nil {</span>
<span class="term-fg32">+			Fatalf(&quot;failed to load OP-Stack chain %q: %v&quot;, name, err)</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+		genesis, err := core.LoadOPStackGenesis(ch)</span>
<span class="term-fg32">+		if err != nil {</span>
<span class="term-fg32">+			Fatalf(&quot;failed to load genesis for OP-Stack chain %q (%d): %v&quot;, name, ch, err)</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+		return genesis</span>
 	case ctx.Bool(DeveloperFlag.Name):
 		Fatalf(&quot;Developer chains are ephemeral&quot;)
 	}
<span class="term-fg36">@@ -2168,7 +2274,7 @@</span> 	}
 	if gcmode := ctx.String(GCModeFlag.Name); gcmode != &quot;full&quot; &amp;&amp; gcmode != &quot;archive&quot; {
 		Fatalf(&quot;--%s must be either &#39;full&#39; or &#39;archive&#39;&quot;, GCModeFlag.Name)
 	}
<span class="term-fg31">-	scheme, err := ParseStateScheme(ctx, chainDb)</span>
<span class="term-fg32">+	scheme, err := rawdb.ParseStateScheme(ctx.String(StateSchemeFlag.Name), chainDb)</span>
 	if err != nil {
 		Fatalf(&quot;%v&quot;, err)
 	}
<span class="term-fg36">@@ -2227,47 +2333,12 @@</span> 	}
 	return preloads
 }
&nbsp;
<span class="term-fg31">-&#47;&#47; ParseStateScheme resolves scheme identifier from CLI flag. If the provided</span>
<span class="term-fg31">-&#47;&#47; state scheme is not compatible with the one of persistent scheme, an error</span>
<span class="term-fg31">-&#47;&#47; will be returned.</span>
<span class="term-fg31">-&#47;&#47;</span>
<span class="term-fg31">-&#47;&#47;   - none: use the scheme consistent with persistent state, or fallback</span>
<span class="term-fg31">-&#47;&#47;     to hash-based scheme if state is empty.</span>
<span class="term-fg31">-&#47;&#47;   - hash: use hash-based scheme or error out if not compatible with</span>
<span class="term-fg31">-&#47;&#47;     persistent state scheme.</span>
<span class="term-fg31">-&#47;&#47;   - path: use path-based scheme or error out if not compatible with</span>
<span class="term-fg31">-&#47;&#47;     persistent state scheme.</span>
<span class="term-fg31">-func ParseStateScheme(ctx *cli.Context, disk ethdb.Database) (string, error) {</span>
<span class="term-fg31">-	&#47;&#47; If state scheme is not specified, use the scheme consistent</span>
<span class="term-fg31">-	&#47;&#47; with persistent state, or fallback to hash mode if database</span>
<span class="term-fg31">-	&#47;&#47; is empty.</span>
<span class="term-fg31">-	stored := rawdb.ReadStateScheme(disk)</span>
<span class="term-fg31">-	if !ctx.IsSet(StateSchemeFlag.Name) {</span>
<span class="term-fg31">-		if stored == &quot;&quot; {</span>
<span class="term-fg31">-			&#47;&#47; use default scheme for empty database, flip it when</span>
<span class="term-fg31">-			&#47;&#47; path mode is chosen as default</span>
<span class="term-fg31">-			log.Info(&quot;State schema set to default&quot;, &quot;scheme&quot;, &quot;hash&quot;)</span>
<span class="term-fg31">-			return rawdb.HashScheme, nil</span>
<span class="term-fg31">-		}</span>
<span class="term-fg31">-		log.Info(&quot;State scheme set to already existing&quot;, &quot;scheme&quot;, stored)</span>
<span class="term-fg31">-		return stored, nil &#47;&#47; reuse scheme of persistent scheme</span>
<span class="term-fg31">-	}</span>
<span class="term-fg31">-	&#47;&#47; If state scheme is specified, ensure it&#39;s compatible with</span>
<span class="term-fg31">-	&#47;&#47; persistent state.</span>
<span class="term-fg31">-	scheme := ctx.String(StateSchemeFlag.Name)</span>
<span class="term-fg31">-	if stored == &quot;&quot; || scheme == stored {</span>
<span class="term-fg31">-		log.Info(&quot;State scheme set by user&quot;, &quot;scheme&quot;, scheme)</span>
<span class="term-fg31">-		return scheme, nil</span>
<span class="term-fg31">-	}</span>
<span class="term-fg31">-	return &quot;&quot;, fmt.Errorf(&quot;incompatible state scheme, stored: %s, provided: %s&quot;, stored, scheme)</span>
<span class="term-fg31">-}</span>
<span class="term-fg31">-</span>
 &#47;&#47; MakeTrieDatabase constructs a trie database based on the configured scheme.
 func MakeTrieDatabase(ctx *cli.Context, disk ethdb.Database, preimage bool, readOnly bool) *trie.Database {
 	config := &amp;trie.Config{
 		Preimages: preimage,
 	}
<span class="term-fg31">-	scheme, err := ParseStateScheme(ctx, disk)</span>
<span class="term-fg32">+	scheme, err := rawdb.ParseStateScheme(ctx.String(StateSchemeFlag.Name), disk)</span>
 	if err != nil {
 		Fatalf(&quot;%v&quot;, err)
 	}</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-36559419b374e81fec3b5052" role="button"
                   aria-expanded="false" aria-controls="id-36559419b374e81fec3b5052">
                    <code>cmd/geth/main.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/3f40e65c484486dea6cff80b7db178985d21a2c6/cmd/geth/main.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/650bb2f2b1dcfe30d9b1fa6f7dc9608055ed60e1/cmd/geth/main.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+21</span></div>
                        <div class="text-start"><span class="text-danger">-2</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-36559419b374e81fec3b5052"><span class="term-fg1">diff --git go-ethereum&#47;cmd&#47;geth&#47;main.go op-geth&#47;cmd&#47;geth&#47;main.go</span>
<span class="term-fg1">index f6fa47ad2e8e23282f60d4d00dc1ede3dad991a5..d4942aabf98c426618506d5907ded24d1b7491a5 100644</span>
<span class="term-fg1">--- go-ethereum&#47;cmd&#47;geth&#47;main.go</span>
<span class="term-fg1">+++ op-geth&#47;cmd&#47;geth&#47;main.go</span>
<span class="term-fg36">@@ -67,10 +67,12 @@</span> 		utils.USBFlag,
 		utils.SmartCardDaemonPathFlag,
 		utils.OverrideCancun,
 		utils.OverrideVerkle,
<span class="term-fg32">+		utils.OverrideOptimismCanyon,</span>
 		utils.EnablePersonal,
 		utils.TxPoolLocalsFlag,
 		utils.TxPoolNoLocalsFlag,
 		utils.TxPoolJournalFlag,
<span class="term-fg32">+		utils.TxPoolJournalRemotesFlag,</span>
 		utils.TxPoolRejournalFlag,
 		utils.TxPoolPriceLimitFlag,
 		utils.TxPoolPriceBumpFlag,
<span class="term-fg36">@@ -89,7 +91,6 @@</span> 		utils.GCModeFlag,
 		utils.SnapshotFlag,
 		utils.TxLookupLimitFlag,
 		utils.TransactionHistoryFlag,
<span class="term-fg31">-		utils.StateSchemeFlag,</span>
 		utils.StateHistoryFlag,
 		utils.LightServeFlag,
 		utils.LightIngressFlag,
<span class="term-fg36">@@ -144,8 +145,16 @@</span> 		utils.GpoBlocksFlag,
 		utils.GpoPercentileFlag,
 		utils.GpoMaxGasPriceFlag,
 		utils.GpoIgnoreGasPriceFlag,
<span class="term-fg32">+		utils.GpoMinSuggestedPriorityFeeFlag,</span>
<span class="term-fg32">+		utils.RollupSequencerHTTPFlag,</span>
<span class="term-fg32">+		utils.RollupHistoricalRPCFlag,</span>
<span class="term-fg32">+		utils.RollupHistoricalRPCTimeoutFlag,</span>
<span class="term-fg32">+		utils.RollupDisableTxPoolGossipFlag,</span>
<span class="term-fg32">+		utils.RollupComputePendingBlock,</span>
<span class="term-fg32">+		utils.RollupHaltOnIncompatibleProtocolVersionFlag,</span>
<span class="term-fg32">+		utils.RollupSuperchainUpgradesFlag,</span>
 		configFileFlag,
<span class="term-fg31">-	}, utils.NetworkFlags, utils.DatabasePathFlags)</span>
<span class="term-fg32">+	}, utils.NetworkFlags, utils.DatabaseFlags)</span>
&nbsp;
 	rpcFlags = []cli.Flag{
 		utils.HTTPEnabledFlag,
<span class="term-fg36">@@ -301,6 +310,9 @@</span>   5. Networking is disabled; there is no listen-address, the maximum number of peers is set
      to 0, and discovery is disabled.
 `)
&nbsp;
<span class="term-fg32">+	case ctx.IsSet(utils.OPNetworkFlag.Name):</span>
<span class="term-fg32">+		log.Info(&quot;Starting geth on an OP network...&quot;, &quot;network&quot;, ctx.String(utils.OPNetworkFlag.Name))</span>
<span class="term-fg32">+</span>
 	case !ctx.IsSet(utils.NetworkIdFlag.Name):
 		log.Info(&quot;Starting Geth on Ethereum mainnet...&quot;)
 	}
<span class="term-fg36">@@ -312,7 +324,14 @@</span> 			!ctx.IsSet(utils.SepoliaFlag.Name) &amp;&amp;
 			!ctx.IsSet(utils.GoerliFlag.Name) &amp;&amp;
 			!ctx.IsSet(utils.DeveloperFlag.Name) {
 			&#47;&#47; Nope, we&#39;re really on mainnet. Bump that cache up!
<span class="term-fg32">+			&#47;&#47; Note: If we don&#39;t set the OPNetworkFlag and have already initialized the database, we may hit this case.</span>
 			log.Info(&quot;Bumping default cache on mainnet&quot;, &quot;provided&quot;, ctx.Int(utils.CacheFlag.Name), &quot;updated&quot;, 4096)
<span class="term-fg32">+			ctx.Set(utils.CacheFlag.Name, strconv.Itoa(4096))</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+	} else if ctx.String(utils.SyncModeFlag.Name) != &quot;light&quot; &amp;&amp; !ctx.IsSet(utils.CacheFlag.Name) &amp;&amp; ctx.IsSet(utils.OPNetworkFlag.Name) {</span>
<span class="term-fg32">+		&#47;&#47; We haven&#39;t set the cache, but may used the OP network flag we may be on an OP stack mainnet.</span>
<span class="term-fg32">+		if strings.Contains(ctx.String(utils.OPNetworkFlag.Name), &quot;mainnet&quot;) {</span>
<span class="term-fg32">+			log.Info(&quot;Bumping default cache on mainnet&quot;, &quot;provided&quot;, ctx.Int(utils.CacheFlag.Name), &quot;updated&quot;, 4096, &quot;network&quot;, ctx.String(utils.OPNetworkFlag.Name))</span>
 			ctx.Set(utils.CacheFlag.Name, strconv.Itoa(4096))
 		}
 	}</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-4671dfe03e5453baf472222c" role="button"
                   aria-expanded="false" aria-controls="id-4671dfe03e5453baf472222c">
                    <code>internal/flags/categories.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/3f40e65c484486dea6cff80b7db178985d21a2c6/internal/flags/categories.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/650bb2f2b1dcfe30d9b1fa6f7dc9608055ed60e1/internal/flags/categories.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+1</span></div>
                        <div class="text-start"><span class="text-danger">-0</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-4671dfe03e5453baf472222c"><span class="term-fg1">diff --git go-ethereum&#47;internal&#47;flags&#47;categories.go op-geth&#47;internal&#47;flags&#47;categories.go</span>
<span class="term-fg1">index 487684d98b3e4388fae941d96e9e7ffce6c1b214..de5ef2714a8fae569ca7ce9905b8ff0ecdd073b9 100644</span>
<span class="term-fg1">--- go-ethereum&#47;internal&#47;flags&#47;categories.go</span>
<span class="term-fg1">+++ op-geth&#47;internal&#47;flags&#47;categories.go</span>
<span class="term-fg36">@@ -32,6 +32,7 @@</span> 	NetworkingCategory = &quot;NETWORKING&quot;
 	MinerCategory      = &quot;MINER&quot;
 	GasPriceCategory   = &quot;GAS PRICE ORACLE&quot;
 	VMCategory         = &quot;VIRTUAL MACHINE&quot;
<span class="term-fg32">+	RollupCategory     = &quot;ROLLUP NODE&quot;</span>
 	LoggingCategory    = &quot;LOGGING AND DEBUGGING&quot;
 	MetricsCategory    = &quot;METRICS AND STATS&quot;
 	MiscCategory       = &quot;MISC&quot;</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-adbe1ff5ba5e1c579e503b98" role="button"
                   aria-expanded="false" aria-controls="id-adbe1ff5ba5e1c579e503b98">
                    <code>cmd/geth/config.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/3f40e65c484486dea6cff80b7db178985d21a2c6/cmd/geth/config.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/650bb2f2b1dcfe30d9b1fa6f7dc9608055ed60e1/cmd/geth/config.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+15</span></div>
                        <div class="text-start"><span class="text-danger">-5</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-adbe1ff5ba5e1c579e503b98"><span class="term-fg1">diff --git go-ethereum&#47;cmd&#47;geth&#47;config.go op-geth&#47;cmd&#47;geth&#47;config.go</span>
<span class="term-fg1">index a5d628d8afca41cdeb2eb2d7245cb1b16721286e..81128ab00705ffd1e91260b406069e775898356d 100644</span>
<span class="term-fg1">--- go-ethereum&#47;cmd&#47;geth&#47;config.go</span>
<span class="term-fg1">+++ op-geth&#47;cmd&#47;geth&#47;config.go</span>
<span class="term-fg36">@@ -32,6 +32,8 @@</span> 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;accounts&#47;keystore&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;accounts&#47;scwallet&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;accounts&#47;usbwallet&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;cmd&#47;utils&quot;
<span class="term-fg32">+	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;common&quot;</span>
<span class="term-fg32">+	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;common&#47;hexutil&quot;</span>
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;eth&#47;catalyst&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;eth&#47;downloader&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;eth&#47;ethconfig&quot;
<span class="term-fg36">@@ -172,10 +174,17 @@</span> 	if ctx.IsSet(utils.OverrideCancun.Name) {
 		v := ctx.Uint64(utils.OverrideCancun.Name)
 		cfg.Eth.OverrideCancun = &amp;v
 	}
<span class="term-fg32">+</span>
<span class="term-fg32">+	if ctx.IsSet(utils.OverrideOptimismCanyon.Name) {</span>
<span class="term-fg32">+		v := ctx.Uint64(utils.OverrideOptimismCanyon.Name)</span>
<span class="term-fg32">+		cfg.Eth.OverrideOptimismCanyon = &amp;v</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+</span>
 	if ctx.IsSet(utils.OverrideVerkle.Name) {
 		v := ctx.Uint64(utils.OverrideVerkle.Name)
 		cfg.Eth.OverrideVerkle = &amp;v
 	}
<span class="term-fg32">+</span>
 	backend, eth := utils.RegisterEthService(stack, &amp;cfg.Eth)
&nbsp;
 	&#47;&#47; Create gauge with geth system and build information
<span class="term-fg36">@@ -199,17 +208,18 @@</span> 	&#47;&#47; Configure GraphQL if requested.
 	if ctx.IsSet(utils.GraphQLEnabledFlag.Name) {
 		utils.RegisterGraphQLService(stack, backend, filterSystem, &amp;cfg.Node)
 	}
<span class="term-fg31">-</span>
 	&#47;&#47; Add the Ethereum Stats daemon if requested.
 	if cfg.Ethstats.URL != &quot;&quot; {
 		utils.RegisterEthStatsService(stack, backend, cfg.Ethstats.URL)
 	}
<span class="term-fg31">-</span>
 	&#47;&#47; Configure full-sync tester service if requested
<span class="term-fg31">-	if ctx.IsSet(utils.SyncTargetFlag.Name) &amp;&amp; cfg.Eth.SyncMode == downloader.FullSync {</span>
<span class="term-fg31">-		utils.RegisterFullSyncTester(stack, eth, ctx.Path(utils.SyncTargetFlag.Name))</span>
<span class="term-fg32">+	if ctx.IsSet(utils.SyncTargetFlag.Name) {</span>
<span class="term-fg32">+		hex := hexutil.MustDecode(ctx.String(utils.SyncTargetFlag.Name))</span>
<span class="term-fg32">+		if len(hex) != common.HashLength {</span>
<span class="term-fg32">+			utils.Fatalf(&quot;invalid sync target length: have %d, want %d&quot;, len(hex), common.HashLength)</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+		utils.RegisterFullSyncTester(stack, eth, common.BytesToHash(hex))</span>
 	}
<span class="term-fg31">-</span>
 	&#47;&#47; Start the dev mode if requested, or launch the engine API for
 	&#47;&#47; interacting with external consensus client.
 	if ctx.IsSet(utils.DeveloperFlag.Name) {</div>
    </div>

            
        </div>
        <div>
            
        </div>
    </div>
</div>

            
                <div class="ps-1 py-2 my-1"><div class="row border-bottom border-1"data-bs-toggle="collapse" data-bs-target="#id-8f234d7c55ba6687969429a5"role="button" aria-expanded="false" aria-controls="id-8f234d7c55ba6687969429a5">
        
            <div class="col-12 col-sm-9 text-start"><h4>Versioning</h4></div>
        
        <div class="col-12 col-sm-3 ms-auto mt-2">
            <div class="row line-stat">
                <div class="text-end"><span class="text-success">+55</span></div>
                <div class="text-start"><span class="text-danger">-6</span></div>
            </div>
        </div>
    </div>

    <div class="row forkdef-content collapse  border-1 ps-3 my-3" id="id-8f234d7c55ba6687969429a5">
        <div><p>List the op-geth and upstream go-ethereum versions.</p>
</div>
        <div>
            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-72a4ca11b59d53ffca7ab902" role="button"
                   aria-expanded="false" aria-controls="id-72a4ca11b59d53ffca7ab902">
                    <code>cmd/geth/misccmd.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/3f40e65c484486dea6cff80b7db178985d21a2c6/cmd/geth/misccmd.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/650bb2f2b1dcfe30d9b1fa6f7dc9608055ed60e1/cmd/geth/misccmd.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+1</span></div>
                        <div class="text-start"><span class="text-danger">-0</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-72a4ca11b59d53ffca7ab902"><span class="term-fg1">diff --git go-ethereum&#47;cmd&#47;geth&#47;misccmd.go op-geth&#47;cmd&#47;geth&#47;misccmd.go</span>
<span class="term-fg1">index f3530c30fb69fe08024d9f62a1a377d416c684d9..e7fb108ebfb6a065eb1232ced8fcdf1c49eee4c5 100644</span>
<span class="term-fg1">--- go-ethereum&#47;cmd&#47;geth&#47;misccmd.go</span>
<span class="term-fg1">+++ op-geth&#47;cmd&#47;geth&#47;misccmd.go</span>
<span class="term-fg36">@@ -80,6 +80,7 @@</span> 	}
 	if git.Date != &quot;&quot; {
 		fmt.Println(&quot;Git Commit Date:&quot;, git.Date)
 	}
<span class="term-fg32">+	fmt.Println(&quot;Upstream Version:&quot;, params.GethVersionWithMeta)</span>
 	fmt.Println(&quot;Architecture:&quot;, runtime.GOARCH)
 	fmt.Println(&quot;Go Version:&quot;, runtime.Version())
 	fmt.Println(&quot;Operating System:&quot;, runtime.GOOS)</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-f6822cf68a069dba0930c503" role="button"
                   aria-expanded="false" aria-controls="id-f6822cf68a069dba0930c503">
                    <code>params/version.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/3f40e65c484486dea6cff80b7db178985d21a2c6/params/version.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/650bb2f2b1dcfe30d9b1fa6f7dc9608055ed60e1/params/version.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+50</span></div>
                        <div class="text-start"><span class="text-danger">-5</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-f6822cf68a069dba0930c503"><span class="term-fg1">diff --git go-ethereum&#47;params&#47;version.go op-geth&#47;params&#47;version.go</span>
<span class="term-fg1">index d75165f3c93a80c8abc66858e178ebe3e64d9933..cb46a6b36e4c361fb5cab10f9c2dd25bcd24446d 100644</span>
<span class="term-fg1">--- go-ethereum&#47;params&#47;version.go</span>
<span class="term-fg1">+++ op-geth&#47;params&#47;version.go</span>
<span class="term-fg36">@@ -18,23 +18,68 @@</span> package params
&nbsp;
 import (
 	&quot;fmt&quot;
<span class="term-fg32">+	&quot;regexp&quot;</span>
<span class="term-fg32">+	&quot;strconv&quot;</span>
 )
&nbsp;
<span class="term-fg32">+&#47;&#47; Version is the version of upstream geth</span>
 const (
 	VersionMajor = 1        &#47;&#47; Major version component of the current release
 	VersionMinor = 13       &#47;&#47; Minor version component of the current release
<span class="term-fg31">-	VersionPatch = 1        &#47;&#47; Patch version component of the current release</span>
<span class="term-fg32">+	VersionPatch = 3        &#47;&#47; Patch version component of the current release</span>
 	VersionMeta  = &quot;stable&quot; &#47;&#47; Version metadata to append to the version string
 )
&nbsp;
<span class="term-fg32">+&#47;&#47; OPVersion is the version of op-geth</span>
<span class="term-fg32">+var (</span>
<span class="term-fg32">+	OPVersionMajor = 0          &#47;&#47; Major version component of the current release</span>
<span class="term-fg32">+	OPVersionMinor = 1          &#47;&#47; Minor version component of the current release</span>
<span class="term-fg32">+	OPVersionPatch = 0          &#47;&#47; Patch version component of the current release</span>
<span class="term-fg32">+	OPVersionMeta  = &quot;unstable&quot; &#47;&#47; Version metadata to append to the version string</span>
<span class="term-fg32">+)</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+&#47;&#47; This is set at build-time by the linker when the build is done by build&#47;ci.go.</span>
<span class="term-fg32">+var gitTag string</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+&#47;&#47; Override the version variables if the gitTag was set at build time.</span>
<span class="term-fg32">+var _ = func() (_ string) {</span>
<span class="term-fg32">+	semver := regexp.MustCompile(`^v([0-9]+)\.([0-9]+)\.([0-9]+)(?:-([0-9A-Za-z-]+(?:\.[0-9A-Za-z-]+)*))?(?:\+[0-9A-Za-z-]+)?$`)</span>
<span class="term-fg32">+	version := semver.FindStringSubmatch(gitTag)</span>
<span class="term-fg32">+	if version == nil {</span>
<span class="term-fg32">+		return</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	if version[4] == &quot;&quot; {</span>
<span class="term-fg32">+		version[4] = &quot;stable&quot;</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	OPVersionMajor, _ = strconv.Atoi(version[1])</span>
<span class="term-fg32">+	OPVersionMinor, _ = strconv.Atoi(version[2])</span>
<span class="term-fg32">+	OPVersionPatch, _ = strconv.Atoi(version[3])</span>
<span class="term-fg32">+	OPVersionMeta = version[4]</span>
<span class="term-fg32">+	return</span>
<span class="term-fg32">+}()</span>
<span class="term-fg32">+</span>
 &#47;&#47; Version holds the textual version string.
 var Version = func() string {
<span class="term-fg31">-	return fmt.Sprintf(&quot;%d.%d.%d&quot;, VersionMajor, VersionMinor, VersionPatch)</span>
<span class="term-fg32">+	return fmt.Sprintf(&quot;%d.%d.%d&quot;, OPVersionMajor, OPVersionMinor, OPVersionPatch)</span>
 }()
&nbsp;
 &#47;&#47; VersionWithMeta holds the textual version string including the metadata.
 var VersionWithMeta = func() string {
 	v := Version
<span class="term-fg32">+	if OPVersionMeta != &quot;&quot; {</span>
<span class="term-fg32">+		v += &quot;-&quot; + OPVersionMeta</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	return v</span>
<span class="term-fg32">+}()</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+&#47;&#47; GethVersion holds the textual geth version string.</span>
<span class="term-fg32">+var GethVersion = func() string {</span>
<span class="term-fg32">+	return fmt.Sprintf(&quot;%d.%d.%d&quot;, VersionMajor, VersionMinor, VersionPatch)</span>
<span class="term-fg32">+}()</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+&#47;&#47; GethVersionWithMeta holds the textual geth version string including the metadata.</span>
<span class="term-fg32">+var GethVersionWithMeta = func() string {</span>
<span class="term-fg32">+	v := GethVersion</span>
 	if VersionMeta != &quot;&quot; {
 		v += &quot;-&quot; + VersionMeta
 	}
<span class="term-fg36">@@ -46,8 +91,8 @@</span> &#47;&#47; &quot;1.8.11-dea1ce05&quot; for stable releases, or &quot;1.8.13-unstable-21c059b6&quot; for unstable
 &#47;&#47; releases.
 func ArchiveVersion(gitCommit string) string {
 	vsn := Version
<span class="term-fg31">-	if VersionMeta != &quot;stable&quot; {</span>
<span class="term-fg31">-		vsn += &quot;-&quot; + VersionMeta</span>
<span class="term-fg32">+	if OPVersionMeta != &quot;stable&quot; {</span>
<span class="term-fg32">+		vsn += &quot;-&quot; + OPVersionMeta</span>
 	}
 	if len(gitCommit) &gt;= 8 {
 		vsn += &quot;-&quot; + gitCommit[:8]
<span class="term-fg36">@@ -60,7 +105,7 @@</span> 	vsn := VersionWithMeta
 	if len(gitCommit) &gt;= 8 {
 		vsn += &quot;-&quot; + gitCommit[:8]
 	}
<span class="term-fg31">-	if (VersionMeta != &quot;stable&quot;) &amp;&amp; (gitDate != &quot;&quot;) {</span>
<span class="term-fg32">+	if (OPVersionMeta != &quot;stable&quot;) &amp;&amp; (gitDate != &quot;&quot;) {</span>
 		vsn += &quot;-&quot; + gitDate
 	}
 	return vsn</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-746595e09cf6a665d204d609" role="button"
                   aria-expanded="false" aria-controls="id-746595e09cf6a665d204d609">
                    <code>build/ci.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/3f40e65c484486dea6cff80b7db178985d21a2c6/build/ci.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/650bb2f2b1dcfe30d9b1fa6f7dc9608055ed60e1/build/ci.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+4</span></div>
                        <div class="text-start"><span class="text-danger">-1</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-746595e09cf6a665d204d609"><span class="term-fg1">diff --git go-ethereum&#47;build&#47;ci.go op-geth&#47;build&#47;ci.go</span>
<span class="term-fg1">index 400c8bdd68749769f2439f7b9fe0b69133747f85..3da5794e7363db91a85c822dd8dc997c62ca9df7 100644</span>
<span class="term-fg1">--- go-ethereum&#47;build&#47;ci.go</span>
<span class="term-fg1">+++ op-geth&#47;build&#47;ci.go</span>
<span class="term-fg36">@@ -263,6 +263,9 @@</span> 	if env.Commit != &quot;&quot; {
 		ld = append(ld, &quot;-X&quot;, &quot;github.com&#47;ethereum&#47;go-ethereum&#47;internal&#47;version.gitCommit=&quot;+env.Commit)
 		ld = append(ld, &quot;-X&quot;, &quot;github.com&#47;ethereum&#47;go-ethereum&#47;internal&#47;version.gitDate=&quot;+env.Date)
 	}
<span class="term-fg32">+	if env.Tag != &quot;&quot; {</span>
<span class="term-fg32">+		ld = append(ld, &quot;-X&quot;, &quot;github.com&#47;ethereum&#47;go-ethereum&#47;params.gitTag=&quot;+env.Tag)</span>
<span class="term-fg32">+	}</span>
 	&#47;&#47; Strip DWARF on darwin. This used to be required for certain things,
 	&#47;&#47; and there is no downside to this, so we just keep doing it.
 	if runtime.GOOS == &quot;darwin&quot; {
<span class="term-fg36">@@ -544,7 +547,7 @@</span> 	switch {
 	case env.Branch == &quot;master&quot;:
 		tags = []string{&quot;latest&quot;}
 	case strings.HasPrefix(env.Tag, &quot;v1.&quot;):
<span class="term-fg31">-		tags = []string{&quot;stable&quot;, fmt.Sprintf(&quot;release-1.%d&quot;, params.VersionMinor), &quot;v&quot; + params.Version}</span>
<span class="term-fg32">+		tags = []string{&quot;stable&quot;, fmt.Sprintf(&quot;release-1.%d&quot;, params.OPVersionMinor), &quot;v&quot; + params.Version}</span>
 	}
 	&#47;&#47; If architecture specific image builds are requested, build and push them
 	if *image {</div>
    </div>

            
        </div>
        <div>
            
        </div>
    </div>
</div>

            
        </div>
    </div>
</div>

            
                <div class="ps-1 py-2 my-1"><div class="row border-bottom border-1"data-bs-toggle="collapse" data-bs-target="#id-d3d02b8ab9ef1346579c6332"role="button" aria-expanded="false" aria-controls="id-d3d02b8ab9ef1346579c6332">
        
            <div class="col-12 col-sm-9 text-start"><h3>Node config</h3></div>
        
        <div class="col-12 col-sm-3 ms-auto mt-2">
            <div class="row line-stat">
                <div class="text-end"><span class="text-success">+26</span></div>
                <div class="text-start"><span class="text-danger">-11</span></div>
            </div>
        </div>
    </div>

    <div class="row forkdef-content collapse  border-1 ps-3 my-3" id="id-d3d02b8ab9ef1346579c6332">
        <div></div>
        <div>
            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-9d95cac37845fc1bc4c10223" role="button"
                   aria-expanded="false" aria-controls="id-9d95cac37845fc1bc4c10223">
                    <code>eth/ethconfig/config.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/3f40e65c484486dea6cff80b7db178985d21a2c6/eth/ethconfig/config.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/650bb2f2b1dcfe30d9b1fa6f7dc9608055ed60e1/eth/ethconfig/config.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+26</span></div>
                        <div class="text-start"><span class="text-danger">-11</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-9d95cac37845fc1bc4c10223"><span class="term-fg1">diff --git go-ethereum&#47;eth&#47;ethconfig&#47;config.go op-geth&#47;eth&#47;ethconfig&#47;config.go</span>
<span class="term-fg1">index 55441a2cb946b696bcc638ff3952fe72661be8db..f31d31aab84a8e377f6be73c19beeb555a8408f3 100644</span>
<span class="term-fg1">--- go-ethereum&#47;eth&#47;ethconfig&#47;config.go</span>
<span class="term-fg1">+++ op-geth&#47;eth&#47;ethconfig&#47;config.go</span>
<span class="term-fg36">@@ -27,7 +27,6 @@</span> 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;consensus&#47;beacon&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;consensus&#47;clique&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;consensus&#47;ethash&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;core&quot;
<span class="term-fg31">-	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;core&#47;rawdb&quot;</span>
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;core&#47;txpool&#47;blobpool&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;core&#47;txpool&#47;legacypool&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;eth&#47;downloader&quot;
<span class="term-fg36">@@ -39,12 +38,13 @@</span> )
&nbsp;
 &#47;&#47; FullNodeGPO contains default gasprice oracle settings for full node.
 var FullNodeGPO = gasprice.Config{
<span class="term-fg31">-	Blocks:           20,</span>
<span class="term-fg31">-	Percentile:       60,</span>
<span class="term-fg31">-	MaxHeaderHistory: 1024,</span>
<span class="term-fg31">-	MaxBlockHistory:  1024,</span>
<span class="term-fg31">-	MaxPrice:         gasprice.DefaultMaxPrice,</span>
<span class="term-fg31">-	IgnorePrice:      gasprice.DefaultIgnorePrice,</span>
<span class="term-fg32">+	Blocks:                  20,</span>
<span class="term-fg32">+	Percentile:              60,</span>
<span class="term-fg32">+	MaxHeaderHistory:        1024,</span>
<span class="term-fg32">+	MaxBlockHistory:         1024,</span>
<span class="term-fg32">+	MaxPrice:                gasprice.DefaultMaxPrice,</span>
<span class="term-fg32">+	IgnorePrice:             gasprice.DefaultIgnorePrice,</span>
<span class="term-fg32">+	MinSuggestedPriorityFee: gasprice.DefaultMinSuggestedPriorityFee,</span>
 }
&nbsp;
 &#47;&#47; LightClientGPO contains default gasprice oracle settings for light client.
<span class="term-fg36">@@ -64,7 +64,6 @@</span> 	NetworkId:          1,
 	TxLookupLimit:      2350000,
 	TransactionHistory: 2350000,
 	StateHistory:       params.FullImmutabilityThreshold,
<span class="term-fg31">-	StateScheme:        rawdb.HashScheme,</span>
 	LightPeers:         100,
 	DatabaseCache:      512,
 	TrieCleanCache:     154,
<span class="term-fg36">@@ -83,7 +82,7 @@</span> }
&nbsp;
 &#47;&#47;go:generate go run github.com&#47;fjl&#47;gencodec -type Config -formats toml -out gen_config.go
&nbsp;
<span class="term-fg31">-&#47;&#47; Config contains configuration options for of the ETH and LES protocols.</span>
<span class="term-fg32">+&#47;&#47; Config contains configuration options for ETH and LES protocols.</span>
 type Config struct {
 	&#47;&#47; The genesis block, which is inserted if the database is empty.
 	&#47;&#47; If nil, the Ethereum main net block is used.
<span class="term-fg36">@@ -105,7 +104,11 @@</span> 	&#47;&#47; Deprecated, use &#39;TransactionHistory&#39; instead.
 	TxLookupLimit      uint64 `toml:&quot;,omitempty&quot;` &#47;&#47; The maximum number of blocks from head whose tx indices are reserved.
 	TransactionHistory uint64 `toml:&quot;,omitempty&quot;` &#47;&#47; The maximum number of blocks from head whose tx indices are reserved.
 	StateHistory       uint64 `toml:&quot;,omitempty&quot;` &#47;&#47; The maximum number of blocks from head whose state histories are reserved.
<span class="term-fg31">-	StateScheme        string `toml:&quot;,omitempty&quot;` &#47;&#47; State scheme used to store ethereum state and merkle trie nodes on top</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	&#47;&#47; State scheme represents the scheme used to store ethereum states and trie</span>
<span class="term-fg32">+	&#47;&#47; nodes on top. It can be &#39;hash&#39;, &#39;path&#39;, or none which means use the scheme</span>
<span class="term-fg32">+	&#47;&#47; consistent with persistent state.</span>
<span class="term-fg32">+	StateScheme string `toml:&quot;,omitempty&quot;`</span>
&nbsp;
 	&#47;&#47; RequiredBlocks is a set of block number -&gt; hash mappings which must be in the
 	&#47;&#47; canonical chain of all remote peers. Setting the option makes geth verify the
<span class="term-fg36">@@ -166,6 +169,18 @@</span> 	OverrideCancun *uint64 `toml:&quot;,omitempty&quot;`
&nbsp;
 	&#47;&#47; OverrideVerkle (TODO: remove after the fork)
 	OverrideVerkle *uint64 `toml:&quot;,omitempty&quot;`
<span class="term-fg32">+</span>
<span class="term-fg32">+	OverrideOptimismCanyon *uint64 `toml:&quot;,omitempty&quot;`</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	&#47;&#47; ApplySuperchainUpgrades requests the node to load chain-configuration from the superchain-registry.</span>
<span class="term-fg32">+	ApplySuperchainUpgrades bool `toml:&quot;,omitempty&quot;`</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	RollupSequencerHTTP                     string</span>
<span class="term-fg32">+	RollupHistoricalRPC                     string</span>
<span class="term-fg32">+	RollupHistoricalRPCTimeout              time.Duration</span>
<span class="term-fg32">+	RollupDisableTxPoolGossip               bool</span>
<span class="term-fg32">+	RollupDisableTxPoolAdmission            bool</span>
<span class="term-fg32">+	RollupHaltOnIncompatibleProtocolVersion string</span>
 }
&nbsp;
 &#47;&#47; CreateConsensusEngine creates a consensus engine for the given chain config.
<span class="term-fg36">@@ -177,7 +192,7 @@</span> 	if config.Clique != nil {
 		return beacon.New(clique.New(config.Clique, db)), nil
 	}
 	&#47;&#47; If defaulting to proof-of-work, enforce an already merged network since
<span class="term-fg31">-	&#47;&#47; we cannot run PoW algorithms and more, so we cannot even follow a chain</span>
<span class="term-fg32">+	&#47;&#47; we cannot run PoW algorithms anymore, so we cannot even follow a chain</span>
 	&#47;&#47; not coordinated by a beacon node.
 	if !config.TerminalTotalDifficultyPassed {
 		return nil, errors.New(&quot;ethash is only supported as a historical component of already merged networks&quot;)</div>
    </div>

            
        </div>
        <div>
            
        </div>
    </div>
</div>

            
                <div class="ps-1 py-2 my-1"><div class="row border-bottom border-1"data-bs-toggle="collapse" data-bs-target="#id-480dea4d9ac1dd5353d44935"role="button" aria-expanded="false" aria-controls="id-480dea4d9ac1dd5353d44935">
        
            <div class="col-12 col-sm-9 text-start"><h3>Tx gossip disable option</h3></div>
        
        <div class="col-12 col-sm-3 ms-auto mt-2">
            <div class="row line-stat">
                <div class="text-end"><span class="text-success">+87</span></div>
                <div class="text-start"><span class="text-danger">-63</span></div>
            </div>
        </div>
    </div>

    <div class="row forkdef-content collapse  border-1 ps-3 my-3" id="id-480dea4d9ac1dd5353d44935">
        <div></div>
        <div>
            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-4f727298fe30c8488486db5c" role="button"
                   aria-expanded="false" aria-controls="id-4f727298fe30c8488486db5c">
                    <code>eth/handler.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/3f40e65c484486dea6cff80b7db178985d21a2c6/eth/handler.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/650bb2f2b1dcfe30d9b1fa6f7dc9608055ed60e1/eth/handler.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+57</span></div>
                        <div class="text-start"><span class="text-danger">-51</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-4f727298fe30c8488486db5c"><span class="term-fg1">diff --git go-ethereum&#47;eth&#47;handler.go op-geth&#47;eth&#47;handler.go</span>
<span class="term-fg1">index a629ec5ee9d157f20e35eb122d002cde3b573c8a..55584f88c40e873ad30860361af43a5953235593 100644</span>
<span class="term-fg1">--- go-ethereum&#47;eth&#47;handler.go</span>
<span class="term-fg1">+++ op-geth&#47;eth&#47;handler.go</span>
<span class="term-fg36">@@ -55,9 +55,7 @@</span> 	&#47;&#47; by the peer.
 	txMaxBroadcastSize = 4096
 )
&nbsp;
<span class="term-fg31">-var (</span>
<span class="term-fg31">-	syncChallengeTimeout = 15 * time.Second &#47;&#47; Time allowance for a node to reply to the sync progress challenge</span>
<span class="term-fg31">-)</span>
<span class="term-fg32">+var syncChallengeTimeout = 15 * time.Second &#47;&#47; Time allowance for a node to reply to the sync progress challenge</span>
&nbsp;
 &#47;&#47; txPool defines the methods needed from a transaction pool implementation to
 &#47;&#47; support all the operations needed by the Ethereum chain protocols.
<span class="term-fg36">@@ -77,9 +75,10 @@</span> 	&#47;&#47; Pending should return pending transactions.
 	&#47;&#47; The slice should be modifiable by the caller.
 	Pending(enforceTips bool) map[common.Address][]*txpool.LazyTransaction
&nbsp;
<span class="term-fg31">-	&#47;&#47; SubscribeNewTxsEvent should return an event subscription of</span>
<span class="term-fg31">-	&#47;&#47; NewTxsEvent and send events to the given channel.</span>
<span class="term-fg31">-	SubscribeNewTxsEvent(chan&lt;- core.NewTxsEvent) event.Subscription</span>
<span class="term-fg32">+	&#47;&#47; SubscribeTransactions subscribes to new transaction events. The subscriber</span>
<span class="term-fg32">+	&#47;&#47; can decide whether to receive notifications only for newly seen transactions</span>
<span class="term-fg32">+	&#47;&#47; or also for reorged out ones.</span>
<span class="term-fg32">+	SubscribeTransactions(ch chan&lt;- core.NewTxsEvent, reorgs bool) event.Subscription</span>
 }
&nbsp;
 &#47;&#47; handlerConfig is the collection of initialization parameters to create a full
<span class="term-fg36">@@ -89,24 +88,27 @@</span> 	Database       ethdb.Database         &#47;&#47; Database for direct sync insertions
 	Chain          *core.BlockChain       &#47;&#47; Blockchain to serve data from
 	TxPool         txPool                 &#47;&#47; Transaction pool to propagate from
 	Merger         *consensus.Merger      &#47;&#47; The manager for eth1&#47;2 transition
<span class="term-fg31">-	Network        uint64                 &#47;&#47; Network identifier to adfvertise</span>
<span class="term-fg32">+	Network        uint64                 &#47;&#47; Network identifier to advertise</span>
 	Sync           downloader.SyncMode    &#47;&#47; Whether to snap or full sync
 	BloomCache     uint64                 &#47;&#47; Megabytes to alloc for snap sync bloom
 	EventMux       *event.TypeMux         &#47;&#47; Legacy event mux, deprecate for `feed`
 	RequiredBlocks map[uint64]common.Hash &#47;&#47; Hard coded map of required block hashes for sync challenges
<span class="term-fg32">+	NoTxGossip     bool                   &#47;&#47; Disable P2P transaction gossip</span>
 }
&nbsp;
 type handler struct {
 	networkID  uint64
 	forkFilter forkid.Filter &#47;&#47; Fork ID filter, constant across the lifetime of the node
&nbsp;
<span class="term-fg31">-	snapSync  atomic.Bool &#47;&#47; Flag whether snap sync is enabled (gets disabled if we already have blocks)</span>
<span class="term-fg31">-	acceptTxs atomic.Bool &#47;&#47; Flag whether we&#39;re considered synchronised (enables transaction processing)</span>
<span class="term-fg32">+	snapSync atomic.Bool &#47;&#47; Flag whether snap sync is enabled (gets disabled if we already have blocks)</span>
<span class="term-fg32">+	synced   atomic.Bool &#47;&#47; Flag whether we&#39;re considered synchronised (enables transaction processing)</span>
&nbsp;
 	database ethdb.Database
 	txpool   txPool
 	chain    *core.BlockChain
 	maxPeers int
<span class="term-fg32">+</span>
<span class="term-fg32">+	noTxGossip bool</span>
&nbsp;
 	downloader   *downloader.Downloader
 	blockFetcher *fetcher.BlockFetcher
<span class="term-fg36">@@ -143,6 +145,7 @@</span> 		forkFilter:     forkid.NewFilter(config.Chain),
 		eventMux:       config.EventMux,
 		database:       config.Database,
 		txpool:         config.TxPool,
<span class="term-fg32">+		noTxGossip:     config.NoTxGossip,</span>
 		chain:          config.Chain,
 		peers:          newPeerSet(),
 		merger:         config.Merger,
<span class="term-fg36">@@ -163,32 +166,25 @@</span> 		&#47;&#47; In these cases however it&#39;s safe to reenable snap sync.
 		fullBlock, snapBlock := h.chain.CurrentBlock(), h.chain.CurrentSnapBlock()
 		if fullBlock.Number.Uint64() == 0 &amp;&amp; snapBlock.Number.Uint64() &gt; 0 {
 			h.snapSync.Store(true)
<span class="term-fg31">-			log.Warn(&quot;Switch sync mode from full sync to snap sync&quot;)</span>
<span class="term-fg32">+			log.Warn(&quot;Switch sync mode from full sync to snap sync&quot;, &quot;reason&quot;, &quot;snap sync incomplete&quot;)</span>
<span class="term-fg32">+		} else if !h.chain.HasState(fullBlock.Root) {</span>
<span class="term-fg32">+			h.snapSync.Store(true)</span>
<span class="term-fg32">+			log.Warn(&quot;Switch sync mode from full sync to snap sync&quot;, &quot;reason&quot;, &quot;head state missing&quot;)</span>
 		}
 	} else {
<span class="term-fg31">-		if h.chain.CurrentBlock().Number.Uint64() &gt; 0 {</span>
<span class="term-fg32">+		head := h.chain.CurrentBlock()</span>
<span class="term-fg32">+		if head.Number.Uint64() &gt; 0 &amp;&amp; h.chain.HasState(head.Root) &amp;&amp; (!config.Chain.Config().IsOptimism() || head.Number.Cmp(config.Chain.Config().BedrockBlock) != 0) {</span>
 			&#47;&#47; Print warning log if database is not empty to run snap sync.
<span class="term-fg32">+			&#47;&#47; For OP chains, snap sync from bedrock block is allowed.</span>
 			log.Warn(&quot;Switch sync mode from snap sync to full sync&quot;)
 		} else {
 			&#47;&#47; If snap sync was requested and our database is empty, grant it
 			h.snapSync.Store(true)
<span class="term-fg32">+			log.Info(&quot;Enabled snap sync&quot;, &quot;head&quot;, head.Number, &quot;hash&quot;, head.Hash())</span>
 		}
 	}
<span class="term-fg31">-	&#47;&#47; If sync succeeds, pass a callback to potentially disable snap sync mode</span>
<span class="term-fg31">-	&#47;&#47; and enable transaction propagation.</span>
<span class="term-fg31">-	success := func() {</span>
<span class="term-fg31">-		&#47;&#47; If we were running snap sync and it finished, disable doing another</span>
<span class="term-fg31">-		&#47;&#47; round on next sync cycle</span>
<span class="term-fg31">-		if h.snapSync.Load() {</span>
<span class="term-fg31">-			log.Info(&quot;Snap sync complete, auto disabling&quot;)</span>
<span class="term-fg31">-			h.snapSync.Store(false)</span>
<span class="term-fg31">-		}</span>
<span class="term-fg31">-		&#47;&#47; If we&#39;ve successfully finished a sync cycle, accept transactions from</span>
<span class="term-fg31">-		&#47;&#47; the network</span>
<span class="term-fg31">-		h.enableSyncedFeatures()</span>
<span class="term-fg31">-	}</span>
 	&#47;&#47; Construct the downloader (long sync)
<span class="term-fg31">-	h.downloader = downloader.New(config.Database, h.eventMux, h.chain, nil, h.removePeer, success)</span>
<span class="term-fg32">+	h.downloader = downloader.New(config.Database, h.eventMux, h.chain, nil, h.removePeer, h.enableSyncedFeatures)</span>
 	if ttd := h.chain.Config().TerminalTotalDifficulty; ttd != nil {
 		if h.chain.Config().TerminalTotalDifficultyPassed {
 			log.Info(&quot;Chain post-merge, sync via beacon client&quot;)
<span class="term-fg36">@@ -245,8 +241,8 @@</span> 		&#47;&#47; clause when starting up a new network, because snap-syncing miners might not
 		&#47;&#47; accept each others&#39; blocks until a restart. Unfortunately we haven&#39;t figured
 		&#47;&#47; out a way yet where nodes can decide unilaterally whether the network is new
 		&#47;&#47; or not. This should be fixed if we figure out a solution.
<span class="term-fg31">-		if h.snapSync.Load() {</span>
<span class="term-fg31">-			log.Warn(&quot;Snap syncing, discarded propagated block&quot;, &quot;number&quot;, blocks[0].Number(), &quot;hash&quot;, blocks[0].Hash())</span>
<span class="term-fg32">+		if !h.synced.Load() {</span>
<span class="term-fg32">+			log.Warn(&quot;Syncing, discarded propagated block&quot;, &quot;number&quot;, blocks[0].Number(), &quot;hash&quot;, blocks[0].Hash())</span>
 			return 0, nil
 		}
 		if h.merger.TDDReached() {
<span class="term-fg36">@@ -263,7 +259,7 @@</span> 					return 0, nil
 				}
 				td := new(big.Int).Add(ptd, block.Difficulty())
 				if !h.chain.Config().IsTerminalPoWBlock(ptd, td) {
<span class="term-fg31">-					log.Info(&quot;Filtered out non-termimal pow block&quot;, &quot;number&quot;, block.NumberU64(), &quot;hash&quot;, block.Hash())</span>
<span class="term-fg32">+					log.Info(&quot;Filtered out non-terminal pow block&quot;, &quot;number&quot;, block.NumberU64(), &quot;hash&quot;, block.Hash())</span>
 					return 0, nil
 				}
 				if err := h.chain.InsertBlockWithoutSetHead(block); err != nil {
<span class="term-fg36">@@ -272,11 +268,7 @@</span> 				}
 			}
 			return 0, nil
 		}
<span class="term-fg31">-		n, err := h.chain.InsertChain(blocks)</span>
<span class="term-fg31">-		if err == nil {</span>
<span class="term-fg31">-			h.enableSyncedFeatures() &#47;&#47; Mark initial sync done on any fetcher import</span>
<span class="term-fg31">-		}</span>
<span class="term-fg31">-		return n, err</span>
<span class="term-fg32">+		return h.chain.InsertChain(blocks)</span>
 	}
 	h.blockFetcher = fetcher.NewBlockFetcher(false, nil, h.chain.GetBlockByHash, validator, h.BroadcastBlock, heighter, nil, inserter, h.removePeer)
&nbsp;
<span class="term-fg36">@@ -290,7 +282,7 @@</span> 	}
 	addTxs := func(txs []*types.Transaction) []error {
 		return h.txpool.Add(txs, false, false)
 	}
<span class="term-fg31">-	h.txFetcher = fetcher.NewTxFetcher(h.txpool.Has, addTxs, fetchTx)</span>
<span class="term-fg32">+	h.txFetcher = fetcher.NewTxFetcher(h.txpool.Has, addTxs, fetchTx, h.removePeer)</span>
 	h.chainSync = newChainSyncer(h)
 	return h, nil
 }
<span class="term-fg36">@@ -428,7 +420,7 @@</span> 			defer timeout.Stop()
&nbsp;
 			select {
 			case res := &lt;-resCh:
<span class="term-fg31">-				headers := ([]*types.Header)(*res.Res.(*eth.BlockHeadersPacket))</span>
<span class="term-fg32">+				headers := ([]*types.Header)(*res.Res.(*eth.BlockHeadersRequest))</span>
 				if len(headers) == 0 {
 					&#47;&#47; Required blocks are allowed to be missing if the remote
 					&#47;&#47; node is not yet synced
<span class="term-fg36">@@ -475,7 +467,7 @@</span> 			} else {
 				snap.EgressRegistrationErrorMeter.Mark(1)
 			}
 		}
<span class="term-fg31">-		peer.Log().Warn(&quot;Snapshot extension registration failed&quot;, &quot;err&quot;, err)</span>
<span class="term-fg32">+		peer.Log().Debug(&quot;Snapshot extension registration failed&quot;, &quot;err&quot;, err)</span>
 		return err
 	}
 	return handler(peer)
<span class="term-fg36">@@ -523,10 +515,10 @@</span>
 func (h *handler) Start(maxPeers int) {
 	h.maxPeers = maxPeers
&nbsp;
<span class="term-fg31">-	&#47;&#47; broadcast transactions</span>
<span class="term-fg32">+	&#47;&#47; broadcast and announce transactions (only new ones, not resurrected ones)</span>
 	h.wg.Add(1)
 	h.txsCh = make(chan core.NewTxsEvent, txChanSize)
<span class="term-fg31">-	h.txsSub = h.txpool.SubscribeNewTxsEvent(h.txsCh)</span>
<span class="term-fg32">+	h.txsSub = h.txpool.SubscribeTransactions(h.txsCh, false)</span>
 	go h.txBroadcastLoop()
&nbsp;
 	&#47;&#47; broadcast mined blocks
<span class="term-fg36">@@ -606,26 +598,33 @@</span> 	}
 }
&nbsp;
 &#47;&#47; BroadcastTransactions will propagate a batch of transactions
<span class="term-fg31">-&#47;&#47; - To a square root of all peers</span>
<span class="term-fg32">+&#47;&#47; - To a square root of all peers for non-blob transactions</span>
 &#47;&#47; - And, separately, as announcements to all peers which are not known to
 &#47;&#47; already have the given transaction.
 func (h *handler) BroadcastTransactions(txs types.Transactions) {
 	var (
<span class="term-fg31">-		annoCount   int &#47;&#47; Count of announcements made</span>
<span class="term-fg31">-		annoPeers   int</span>
<span class="term-fg31">-		directCount int &#47;&#47; Count of the txs sent directly to peers</span>
<span class="term-fg31">-		directPeers int &#47;&#47; Count of the peers that were sent transactions directly</span>
<span class="term-fg32">+		blobTxs  int &#47;&#47; Number of blob transactions to announce only</span>
<span class="term-fg32">+		largeTxs int &#47;&#47; Number of large transactions to announce only</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+		directCount int &#47;&#47; Number of transactions sent directly to peers (duplicates included)</span>
<span class="term-fg32">+		directPeers int &#47;&#47; Number of peers that were sent transactions directly</span>
<span class="term-fg32">+		annCount    int &#47;&#47; Number of transactions announced across all peers (duplicates included)</span>
<span class="term-fg32">+		annPeers    int &#47;&#47; Number of peers announced about transactions</span>
&nbsp;
 		txset = make(map[*ethPeer][]common.Hash) &#47;&#47; Set peer-&gt;hash to transfer directly
 		annos = make(map[*ethPeer][]common.Hash) &#47;&#47; Set peer-&gt;hash to announce
<span class="term-fg31">-</span>
 	)
 	&#47;&#47; Broadcast transactions to a batch of peers not knowing about it
 	for _, tx := range txs {
 		peers := h.peers.peersWithoutTransaction(tx.Hash())
&nbsp;
 		var numDirect int
<span class="term-fg31">-		if tx.Size() &lt;= txMaxBroadcastSize {</span>
<span class="term-fg32">+		switch {</span>
<span class="term-fg32">+		case tx.Type() == types.BlobTxType:</span>
<span class="term-fg32">+			blobTxs++</span>
<span class="term-fg32">+		case tx.Size() &gt; txMaxBroadcastSize:</span>
<span class="term-fg32">+			largeTxs++</span>
<span class="term-fg32">+		default:</span>
 			numDirect = int(math.Sqrt(float64(len(peers))))
 		}
 		&#47;&#47; Send the tx unconditionally to a subset of our peers
<span class="term-fg36">@@ -643,13 +642,12 @@</span> 		directCount += len(hashes)
 		peer.AsyncSendTransactions(hashes)
 	}
 	for peer, hashes := range annos {
<span class="term-fg31">-		annoPeers++</span>
<span class="term-fg31">-		annoCount += len(hashes)</span>
<span class="term-fg32">+		annPeers++</span>
<span class="term-fg32">+		annCount += len(hashes)</span>
 		peer.AsyncSendPooledTransactionHashes(hashes)
 	}
<span class="term-fg31">-	log.Debug(&quot;Transaction broadcast&quot;, &quot;txs&quot;, len(txs),</span>
<span class="term-fg31">-		&quot;announce packs&quot;, annoPeers, &quot;announced hashes&quot;, annoCount,</span>
<span class="term-fg31">-		&quot;tx packs&quot;, directPeers, &quot;broadcast txs&quot;, directCount)</span>
<span class="term-fg32">+	log.Debug(&quot;Distributed transactions&quot;, &quot;plaintxs&quot;, len(txs)-blobTxs-largeTxs, &quot;blobtxs&quot;, blobTxs, &quot;largetxs&quot;, largeTxs,</span>
<span class="term-fg32">+		&quot;bcastpeers&quot;, directPeers, &quot;bcastcount&quot;, directCount, &quot;annpeers&quot;, annPeers, &quot;anncount&quot;, annCount)</span>
 }
&nbsp;
 &#47;&#47; minedBroadcastLoop sends mined blocks to connected peers.
<span class="term-fg36">@@ -680,7 +678,15 @@</span>
 &#47;&#47; enableSyncedFeatures enables the post-sync functionalities when the initial
 &#47;&#47; sync is finished.
 func (h *handler) enableSyncedFeatures() {
<span class="term-fg31">-	h.acceptTxs.Store(true)</span>
<span class="term-fg32">+	&#47;&#47; Mark the local node as synced.</span>
<span class="term-fg32">+	h.synced.Store(true)</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	&#47;&#47; If we were running snap sync and it finished, disable doing another</span>
<span class="term-fg32">+	&#47;&#47; round on next sync cycle</span>
<span class="term-fg32">+	if h.snapSync.Load() {</span>
<span class="term-fg32">+		log.Info(&quot;Snap sync complete, auto disabling&quot;)</span>
<span class="term-fg32">+		h.snapSync.Store(false)</span>
<span class="term-fg32">+	}</span>
 	if h.chain.TrieDB().Scheme() == rawdb.PathScheme {
 		h.chain.TrieDB().SetBufferSize(pathdb.DefaultBufferSize)
 	}</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-cf7258b2060d69e3f58ca3dd" role="button"
                   aria-expanded="false" aria-controls="id-cf7258b2060d69e3f58ca3dd">
                    <code>eth/handler_eth.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/3f40e65c484486dea6cff80b7db178985d21a2c6/eth/handler_eth.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/650bb2f2b1dcfe30d9b1fa6f7dc9608055ed60e1/eth/handler_eth.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+30</span></div>
                        <div class="text-start"><span class="text-danger">-12</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-cf7258b2060d69e3f58ca3dd"><span class="term-fg1">diff --git go-ethereum&#47;eth&#47;handler_eth.go op-geth&#47;eth&#47;handler_eth.go</span>
<span class="term-fg1">index 3a5e6608bb3638cd852028413abcdcd2f9cfbc97..6dbe03e2140998359201a75f6b7a6a9ca2cb9c75 100644</span>
<span class="term-fg1">--- go-ethereum&#47;eth&#47;handler_eth.go</span>
<span class="term-fg1">+++ op-geth&#47;eth&#47;handler_eth.go</span>
<span class="term-fg36">@@ -17,6 +17,7 @@</span>
 package eth
&nbsp;
 import (
<span class="term-fg32">+	&quot;errors&quot;</span>
 	&quot;fmt&quot;
 	&quot;math&#47;big&quot;
 	&quot;time&quot;
<span class="term-fg36">@@ -33,7 +34,20 @@</span> &#47;&#47; packets that are sent as replies or broadcasts.
 type ethHandler handler
&nbsp;
 func (h *ethHandler) Chain() *core.BlockChain { return h.chain }
<span class="term-fg31">-func (h *ethHandler) TxPool() eth.TxPool      { return h.txpool }</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+&#47;&#47; NilPool satisfies the TxPool interface but does not return any tx in the</span>
<span class="term-fg32">+&#47;&#47; pool. It is used to disable transaction gossip.</span>
<span class="term-fg32">+type NilPool struct{}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+&#47;&#47; NilPool Get always returns nil</span>
<span class="term-fg32">+func (n NilPool) Get(hash common.Hash) *types.Transaction { return nil }</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func (h *ethHandler) TxPool() eth.TxPool {</span>
<span class="term-fg32">+	if h.noTxGossip {</span>
<span class="term-fg32">+		return &amp;NilPool{}</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	return h.txpool</span>
<span class="term-fg32">+}</span>
&nbsp;
 &#47;&#47; RunPeer is invoked when a peer joins on the `eth` protocol.
 func (h *ethHandler) RunPeer(peer *eth.Peer, hand eth.Handler) error {
<span class="term-fg36">@@ -51,7 +65,10 @@</span>
 &#47;&#47; AcceptTxs retrieves whether transaction processing is enabled on the node
 &#47;&#47; or if inbound transactions should simply be dropped.
 func (h *ethHandler) AcceptTxs() bool {
<span class="term-fg31">-	return h.acceptTxs.Load()</span>
<span class="term-fg32">+	if h.noTxGossip {</span>
<span class="term-fg32">+		return false</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	return h.synced.Load()</span>
 }
&nbsp;
 &#47;&#47; Handle is invoked from a peer&#39;s message handler when it receives a new remote
<span class="term-fg36">@@ -66,16 +83,21 @@</span>
 	case *eth.NewBlockPacket:
 		return h.handleBlockBroadcast(peer, packet.Block, packet.TD)
&nbsp;
<span class="term-fg31">-	case *eth.NewPooledTransactionHashesPacket66:</span>
<span class="term-fg31">-		return h.txFetcher.Notify(peer.ID(), *packet)</span>
<span class="term-fg32">+	case *eth.NewPooledTransactionHashesPacket67:</span>
<span class="term-fg32">+		return h.txFetcher.Notify(peer.ID(), nil, nil, *packet)</span>
&nbsp;
 	case *eth.NewPooledTransactionHashesPacket68:
<span class="term-fg31">-		return h.txFetcher.Notify(peer.ID(), packet.Hashes)</span>
<span class="term-fg32">+		return h.txFetcher.Notify(peer.ID(), packet.Types, packet.Sizes, packet.Hashes)</span>
&nbsp;
 	case *eth.TransactionsPacket:
<span class="term-fg32">+		for _, tx := range *packet {</span>
<span class="term-fg32">+			if tx.Type() == types.BlobTxType {</span>
<span class="term-fg32">+				return errors.New(&quot;disallowed broadcast blob transaction&quot;)</span>
<span class="term-fg32">+			}</span>
<span class="term-fg32">+		}</span>
 		return h.txFetcher.Enqueue(peer.ID(), *packet, false)
&nbsp;
<span class="term-fg31">-	case *eth.PooledTransactionsPacket:</span>
<span class="term-fg32">+	case *eth.PooledTransactionsResponse:</span>
 		return h.txFetcher.Enqueue(peer.ID(), *packet, true)
&nbsp;
 	default:
<span class="term-fg36">@@ -90,9 +112,7 @@</span> 	&#47;&#47; Drop all incoming block announces from the p2p network if
 	&#47;&#47; the chain already entered the pos stage and disconnect the
 	&#47;&#47; remote peer.
 	if h.merger.PoSFinalized() {
<span class="term-fg31">-		&#47;&#47; TODO (MariusVanDerWijden) drop non-updated peers after the merge</span>
<span class="term-fg31">-		return nil</span>
<span class="term-fg31">-		&#47;&#47; return errors.New(&quot;unexpected block announces&quot;)</span>
<span class="term-fg32">+		return errors.New(&quot;disallowed block announcement&quot;)</span>
 	}
 	&#47;&#47; Schedule all the unknown hashes for retrieval
 	var (
<span class="term-fg36">@@ -118,9 +138,7 @@</span> 	&#47;&#47; Drop all incoming block announces from the p2p network if
 	&#47;&#47; the chain already entered the pos stage and disconnect the
 	&#47;&#47; remote peer.
 	if h.merger.PoSFinalized() {
<span class="term-fg31">-		&#47;&#47; TODO (MariusVanDerWijden) drop non-updated peers after the merge</span>
<span class="term-fg31">-		return nil</span>
<span class="term-fg31">-		&#47;&#47; return errors.New(&quot;unexpected block announces&quot;)</span>
<span class="term-fg32">+		return errors.New(&quot;disallowed block broadcast&quot;)</span>
 	}
 	&#47;&#47; Schedule the block for import
 	h.blockFetcher.Enqueue(peer.ID(), block)</div>
    </div>

            
        </div>
        <div>
            
        </div>
    </div>
</div>

            
                <div class="ps-1 py-2 my-1"><div class="row border-bottom border-1"data-bs-toggle="collapse" data-bs-target="#id-dd63046d58c9415673714a0f"role="button" aria-expanded="false" aria-controls="id-dd63046d58c9415673714a0f">
        
            <div class="col-12 col-sm-9 text-start"><h3>Warn on missing hardfork data</h3></div>
        
        <div class="col-12 col-sm-3 ms-auto mt-2">
            <div class="row line-stat">
                <div class="text-end"><span class="text-success">+28</span></div>
                <div class="text-start"><span class="text-danger">-40</span></div>
            </div>
        </div>
    </div>

    <div class="row forkdef-content collapse  border-1 ps-3 my-3" id="id-dd63046d58c9415673714a0f">
        <div></div>
        <div>
            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-6578ddd7040c3b8f47a1dc0d" role="button"
                   aria-expanded="false" aria-controls="id-6578ddd7040c3b8f47a1dc0d">
                    <code>core/blockchain.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/3f40e65c484486dea6cff80b7db178985d21a2c6/core/blockchain.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/650bb2f2b1dcfe30d9b1fa6f7dc9608055ed60e1/core/blockchain.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+28</span></div>
                        <div class="text-start"><span class="text-danger">-40</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-6578ddd7040c3b8f47a1dc0d"><span class="term-fg1">diff --git go-ethereum&#47;core&#47;blockchain.go op-geth&#47;core&#47;blockchain.go</span>
<span class="term-fg1">index e371e8d9265ab855f82018f3c1232299d6fe8598..08d7c6c03a05aee0a76ba292cb874adc8b8dd1ea 100644</span>
<span class="term-fg1">--- go-ethereum&#47;core&#47;blockchain.go</span>
<span class="term-fg1">+++ op-geth&#47;core&#47;blockchain.go</span>
<span class="term-fg36">@@ -285,6 +285,10 @@</span> 	}
 	log.Info(strings.Repeat(&quot;-&quot;, 153))
 	log.Info(&quot;&quot;)
&nbsp;
<span class="term-fg32">+	if chainConfig.IsOptimism() &amp;&amp; chainConfig.RegolithTime == nil {</span>
<span class="term-fg32">+		log.Warn(&quot;Optimism RegolithTime has not been set&quot;)</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+</span>
 	bc := &amp;BlockChain{
 		chainConfig:   chainConfig,
 		cacheConfig:   cacheConfig,
<span class="term-fg36">@@ -337,17 +341,17 @@</span> 	&#47;&#47; Load blockchain states from disk
 	if err := bc.loadLastState(); err != nil {
 		return nil, err
 	}
<span class="term-fg31">-	&#47;&#47; Make sure the state associated with the block is available</span>
<span class="term-fg32">+	&#47;&#47; Make sure the state associated with the block is available, or log out</span>
<span class="term-fg32">+	&#47;&#47; if there is no available state, waiting for state sync.</span>
 	head := bc.CurrentBlock()
 	if !bc.HasState(head.Root) {
 		if head.Number.Uint64() == 0 {
 			&#47;&#47; The genesis state is missing, which is only possible in the path-based
<span class="term-fg31">-			&#47;&#47; scheme. This situation occurs when the state syncer overwrites it.</span>
<span class="term-fg31">-			&#47;&#47;</span>
<span class="term-fg31">-			&#47;&#47; The solution is to reset the state to the genesis state. Although it may not</span>
<span class="term-fg31">-			&#47;&#47; match the sync target, the state healer will later address and correct any</span>
<span class="term-fg31">-			&#47;&#47; inconsistencies.</span>
<span class="term-fg31">-			bc.resetState()</span>
<span class="term-fg32">+			&#47;&#47; scheme. This situation occurs when the initial state sync is not finished</span>
<span class="term-fg32">+			&#47;&#47; yet, or the chain head is rewound below the pivot point. In both scenario,</span>
<span class="term-fg32">+			&#47;&#47; there is no possible recovery approach except for rerunning a snap sync.</span>
<span class="term-fg32">+			&#47;&#47; Do nothing here until the state syncer picks it up.</span>
<span class="term-fg32">+			log.Info(&quot;Genesis state is missing, wait state sync&quot;)</span>
 		} else {
 			&#47;&#47; Head state is missing, before the state recovery, find out the
 			&#47;&#47; disk layer point of snapshot(if it&#39;s enabled). Make sure the
<span class="term-fg36">@@ -576,7 +580,7 @@</span> 	&#47;&#47; Send chain head event to update the transaction pool
 	header := bc.CurrentBlock()
 	block := bc.GetBlock(header.Hash(), header.Number.Uint64())
 	if block == nil {
<span class="term-fg31">-		&#47;&#47; This should never happen. In practice, previsouly currentBlock</span>
<span class="term-fg32">+		&#47;&#47; This should never happen. In practice, previously currentBlock</span>
 		&#47;&#47; contained the entire block whereas now only a &quot;marker&quot;, so there
 		&#47;&#47; is an ever so slight chance for a race we should handle.
 		log.Error(&quot;Current block not found in database&quot;, &quot;block&quot;, header.Number, &quot;hash&quot;, header.Hash())
<span class="term-fg36">@@ -598,7 +602,7 @@</span> 	&#47;&#47; Send chain head event to update the transaction pool
 	header := bc.CurrentBlock()
 	block := bc.GetBlock(header.Hash(), header.Number.Uint64())
 	if block == nil {
<span class="term-fg31">-		&#47;&#47; This should never happen. In practice, previsouly currentBlock</span>
<span class="term-fg32">+		&#47;&#47; This should never happen. In practice, previously currentBlock</span>
 		&#47;&#47; contained the entire block whereas now only a &quot;marker&quot;, so there
 		&#47;&#47; is an ever so slight chance for a race we should handle.
 		log.Error(&quot;Current block not found in database&quot;, &quot;block&quot;, header.Number, &quot;hash&quot;, header.Hash())
<span class="term-fg36">@@ -630,28 +634,6 @@</span> 		headSafeBlockGauge.Update(0)
 	}
 }
&nbsp;
<span class="term-fg31">-&#47;&#47; resetState resets the persistent state to genesis state if it&#39;s not present.</span>
<span class="term-fg31">-func (bc *BlockChain) resetState() {</span>
<span class="term-fg31">-	&#47;&#47; Short circuit if the genesis state is already present.</span>
<span class="term-fg31">-	root := bc.genesisBlock.Root()</span>
<span class="term-fg31">-	if bc.HasState(root) {</span>
<span class="term-fg31">-		return</span>
<span class="term-fg31">-	}</span>
<span class="term-fg31">-	&#47;&#47; Reset the state database to empty for committing genesis state.</span>
<span class="term-fg31">-	&#47;&#47; Note, it should only happen in path-based scheme and Reset function</span>
<span class="term-fg31">-	&#47;&#47; is also only call-able in this mode.</span>
<span class="term-fg31">-	if bc.triedb.Scheme() == rawdb.PathScheme {</span>
<span class="term-fg31">-		if err := bc.triedb.Reset(types.EmptyRootHash); err != nil {</span>
<span class="term-fg31">-			log.Crit(&quot;Failed to clean state&quot;, &quot;err&quot;, err) &#47;&#47; Shouldn&#39;t happen</span>
<span class="term-fg31">-		}</span>
<span class="term-fg31">-	}</span>
<span class="term-fg31">-	&#47;&#47; Write genesis state into database.</span>
<span class="term-fg31">-	if err := CommitGenesisState(bc.db, bc.triedb, bc.genesisBlock.Hash()); err != nil {</span>
<span class="term-fg31">-		log.Crit(&quot;Failed to commit genesis state&quot;, &quot;err&quot;, err)</span>
<span class="term-fg31">-	}</span>
<span class="term-fg31">-	log.Info(&quot;Reset state to genesis&quot;, &quot;root&quot;, root)</span>
<span class="term-fg31">-}</span>
<span class="term-fg31">-</span>
 &#47;&#47; setHeadBeyondRoot rewinds the local chain to a new head with the extra condition
 &#47;&#47; that the rewind must pass the specified state root. This method is meant to be
 &#47;&#47; used when rewinding with snapshots enabled to ensure that we go back further than
<span class="term-fg36">@@ -687,7 +669,6 @@</span> 			newHeadBlock := bc.GetBlock(header.Hash(), header.Number.Uint64())
 			if newHeadBlock == nil {
 				log.Error(&quot;Gap in the chain, rewinding to genesis&quot;, &quot;number&quot;, header.Number, &quot;hash&quot;, header.Hash())
 				newHeadBlock = bc.genesisBlock
<span class="term-fg31">-				bc.resetState()</span>
 			} else {
 				&#47;&#47; Block exists, keep rewinding until we find one with state,
 				&#47;&#47; keeping rewinding until we exceed the optional threshold
<span class="term-fg36">@@ -715,16 +696,14 @@</span> 							newHeadBlock = bc.genesisBlock
 						}
 					}
 					if beyondRoot || newHeadBlock.NumberU64() == 0 {
<span class="term-fg31">-						if newHeadBlock.NumberU64() == 0 {</span>
<span class="term-fg31">-							bc.resetState()</span>
<span class="term-fg31">-						} else if !bc.HasState(newHeadBlock.Root()) {</span>
<span class="term-fg32">+						if !bc.HasState(newHeadBlock.Root()) &amp;&amp; bc.stateRecoverable(newHeadBlock.Root()) {</span>
 							&#47;&#47; Rewind to a block with recoverable state. If the state is
 							&#47;&#47; missing, run the state recovery here.
 							if err := bc.triedb.Recover(newHeadBlock.Root()); err != nil {
 								log.Crit(&quot;Failed to rollback state&quot;, &quot;err&quot;, err) &#47;&#47; Shouldn&#39;t happen
 							}
<span class="term-fg32">+							log.Debug(&quot;Rewound to block with state&quot;, &quot;number&quot;, newHeadBlock.NumberU64(), &quot;hash&quot;, newHeadBlock.Hash())</span>
 						}
<span class="term-fg31">-						log.Debug(&quot;Rewound to block with state&quot;, &quot;number&quot;, newHeadBlock.NumberU64(), &quot;hash&quot;, newHeadBlock.Hash())</span>
 						break
 					}
 					log.Debug(&quot;Skipping block with threshold state&quot;, &quot;number&quot;, newHeadBlock.NumberU64(), &quot;hash&quot;, newHeadBlock.Hash(), &quot;root&quot;, newHeadBlock.Root())
<span class="term-fg36">@@ -739,6 +718,15 @@</span> 			&#47;&#47; last step, however the direction of SetHead is from high
 			&#47;&#47; to low, so it&#39;s safe to update in-memory markers directly.
 			bc.currentBlock.Store(newHeadBlock.Header())
 			headBlockGauge.Update(int64(newHeadBlock.NumberU64()))
<span class="term-fg32">+</span>
<span class="term-fg32">+			&#47;&#47; The head state is missing, which is only possible in the path-based</span>
<span class="term-fg32">+			&#47;&#47; scheme. This situation occurs when the chain head is rewound below</span>
<span class="term-fg32">+			&#47;&#47; the pivot point. In this scenario, there is no possible recovery</span>
<span class="term-fg32">+			&#47;&#47; approach except for rerunning a snap sync. Do nothing here until the</span>
<span class="term-fg32">+			&#47;&#47; state syncer picks it up.</span>
<span class="term-fg32">+			if !bc.HasState(newHeadBlock.Root()) {</span>
<span class="term-fg32">+				log.Info(&quot;Chain is stateless, wait state sync&quot;, &quot;number&quot;, newHeadBlock.Number(), &quot;hash&quot;, newHeadBlock.Hash())</span>
<span class="term-fg32">+			}</span>
 		}
 		&#47;&#47; Rewind the snap block in a simpleton way to the target head
 		if currentSnapBlock := bc.CurrentSnapBlock(); currentSnapBlock != nil &amp;&amp; header.Number.Uint64() &lt; currentSnapBlock.Number.Uint64() {
<span class="term-fg36">@@ -838,7 +826,7 @@</span> 	}
 	&#47;&#47; Reset the trie database with the fresh snap synced state.
 	root := block.Root()
 	if bc.triedb.Scheme() == rawdb.PathScheme {
<span class="term-fg31">-		if err := bc.triedb.Reset(root); err != nil {</span>
<span class="term-fg32">+		if err := bc.triedb.Enable(root); err != nil {</span>
 			return err
 		}
 	}
<span class="term-fg36">@@ -998,7 +986,7 @@</span> &#47;&#47; it will abort them using the procInterrupt.
 func (bc *BlockChain) Stop() {
 	bc.stopWithoutSaving()
&nbsp;
<span class="term-fg31">-	&#47;&#47; Ensure that the entirety of the state snapshot is journalled to disk.</span>
<span class="term-fg32">+	&#47;&#47; Ensure that the entirety of the state snapshot is journaled to disk.</span>
 	var snapBase common.Hash
 	if bc.snaps != nil {
 		var err error
<span class="term-fg36">@@ -1209,7 +1197,7 @@</span> 		&#47;&#47; an external ancient database, during the setup, blockchain will start
 		&#47;&#47; a background routine to re-indexed all indices in [ancients - txlookupLimit, ancients)
 		&#47;&#47; range. In this case, all tx indices of newly imported blocks should be
 		&#47;&#47; generated.
<span class="term-fg31">-		var batch = bc.db.NewBatch()</span>
<span class="term-fg32">+		batch := bc.db.NewBatch()</span>
 		for i, block := range blockChain {
 			if bc.txLookupLimit == 0 || ancientLimit &lt;= bc.txLookupLimit || block.NumberU64() &gt;= ancientLimit-bc.txLookupLimit {
 				rawdb.WriteTxLookupEntriesByBlock(batch, block)
<span class="term-fg36">@@ -2601,7 +2589,7 @@</span> func (bc *BlockChain) SetTrieFlushInterval(interval time.Duration) {
 	bc.flushInterval.Store(int64(interval))
 }
&nbsp;
<span class="term-fg31">-&#47;&#47; GetTrieFlushInterval gets the in-memroy tries flush interval</span>
<span class="term-fg32">+&#47;&#47; GetTrieFlushInterval gets the in-memory tries flush interval</span>
 func (bc *BlockChain) GetTrieFlushInterval() time.Duration {
 	return time.Duration(bc.flushInterval.Load())
 }</div>
    </div>

            
        </div>
        <div>
            
        </div>
    </div>
</div>

            
                <div class="ps-1 py-2 my-1"><div class="row border-bottom border-1"data-bs-toggle="collapse" data-bs-target="#id-124040e5edac7a5e9d7857a2"role="button" aria-expanded="false" aria-controls="id-124040e5edac7a5e9d7857a2">
        
            <div class="col-12 col-sm-9 text-start"><h3>Optional Engine API extensions</h3></div>
        
        <div class="col-12 col-sm-3 ms-auto mt-2">
            <div class="row line-stat">
                <div class="text-end"><span class="text-success">+66</span></div>
                <div class="text-start"><span class="text-danger">-0</span></div>
            </div>
        </div>
    </div>

    <div class="row forkdef-content collapse  border-1 ps-3 my-3" id="id-124040e5edac7a5e9d7857a2">
        <div></div>
        <div>
            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-474336e3782746990640a305" role="button"
                   aria-expanded="false" aria-controls="id-474336e3782746990640a305">
                    <code>eth/catalyst/superchain.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <span class="text-muted">(new)</span>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/650bb2f2b1dcfe30d9b1fa6f7dc9608055ed60e1/eth/catalyst/superchain.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+66</span></div>
                        <div class="text-start"><span class="text-danger">-0</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-474336e3782746990640a305"><span class="term-fg1">diff --git go-ethereum&#47;eth&#47;catalyst&#47;superchain.go op-geth&#47;eth&#47;catalyst&#47;superchain.go</span>
<span class="term-fg1">new file mode 100644</span>
<span class="term-fg1">index 0000000000000000000000000000000000000000..503519889f4f050ad0aa739525022044fa842bc6</span>
<span class="term-fg1">--- &#47;dev&#47;null</span>
<span class="term-fg1">+++ op-geth&#47;eth&#47;catalyst&#47;superchain.go</span>
<span class="term-fg36">@@ -0,0 +1,66 @@</span>
<span class="term-fg32">+package catalyst</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+import (</span>
<span class="term-fg32">+	&quot;fmt&quot;</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;log&quot;</span>
<span class="term-fg32">+	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;metrics&quot;</span>
<span class="term-fg32">+	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;params&quot;</span>
<span class="term-fg32">+)</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+var (</span>
<span class="term-fg32">+	requiredProtocolDeltaGauge    = metrics.NewRegisteredGauge(&quot;superchain&#47;required&#47;delta&quot;, nil)</span>
<span class="term-fg32">+	recommendedProtocolDeltaGauge = metrics.NewRegisteredGauge(&quot;superchain&#47;recommended&#47;delta&quot;, nil)</span>
<span class="term-fg32">+)</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+type SuperchainSignal struct {</span>
<span class="term-fg32">+	Recommended params.ProtocolVersion `json:&quot;recommended&quot;`</span>
<span class="term-fg32">+	Required    params.ProtocolVersion `json:&quot;required&quot;`</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func (api *ConsensusAPI) SignalSuperchainV1(signal *SuperchainSignal) (params.ProtocolVersion, error) {</span>
<span class="term-fg32">+	if signal == nil {</span>
<span class="term-fg32">+		log.Info(&quot;Received empty superchain version signal&quot;, &quot;local&quot;, params.OPStackSupport)</span>
<span class="term-fg32">+		return params.OPStackSupport, nil</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	&#47;&#47; update metrics and log any warnings&#47;info</span>
<span class="term-fg32">+	requiredProtocolDeltaGauge.Update(int64(params.OPStackSupport.Compare(signal.Required)))</span>
<span class="term-fg32">+	recommendedProtocolDeltaGauge.Update(int64(params.OPStackSupport.Compare(signal.Recommended)))</span>
<span class="term-fg32">+	logger := log.New(&quot;local&quot;, params.OPStackSupport, &quot;required&quot;, signal.Required, &quot;recommended&quot;, signal.Recommended)</span>
<span class="term-fg32">+	LogProtocolVersionSupport(logger, params.OPStackSupport, signal.Recommended, &quot;recommended&quot;)</span>
<span class="term-fg32">+	LogProtocolVersionSupport(logger, params.OPStackSupport, signal.Required, &quot;required&quot;)</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	if err := api.eth.HandleRequiredProtocolVersion(signal.Required); err != nil {</span>
<span class="term-fg32">+		log.Error(&quot;Failed to handle required protocol version&quot;, &quot;err&quot;, err, &quot;required&quot;, signal.Required)</span>
<span class="term-fg32">+		return params.OPStackSupport, err</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	return params.OPStackSupport, nil</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func LogProtocolVersionSupport(logger log.Logger, local, other params.ProtocolVersion, name string) {</span>
<span class="term-fg32">+	switch local.Compare(other) {</span>
<span class="term-fg32">+	case params.AheadMajor:</span>
<span class="term-fg32">+		logger.Info(fmt.Sprintf(&quot;Ahead with major %s protocol version change&quot;, name))</span>
<span class="term-fg32">+	case params.AheadMinor, params.AheadPatch, params.AheadPrerelease:</span>
<span class="term-fg32">+		logger.Debug(fmt.Sprintf(&quot;Ahead with compatible %s protocol version change&quot;, name))</span>
<span class="term-fg32">+	case params.Matching:</span>
<span class="term-fg32">+		logger.Debug(fmt.Sprintf(&quot;Latest %s protocol version is supported&quot;, name))</span>
<span class="term-fg32">+	case params.OutdatedMajor:</span>
<span class="term-fg32">+		logger.Error(fmt.Sprintf(&quot;Outdated with major %s protocol change&quot;, name))</span>
<span class="term-fg32">+	case params.OutdatedMinor:</span>
<span class="term-fg32">+		logger.Warn(fmt.Sprintf(&quot;Outdated with minor backward-compatible %s protocol change&quot;, name))</span>
<span class="term-fg32">+	case params.OutdatedPatch:</span>
<span class="term-fg32">+		logger.Info(fmt.Sprintf(&quot;Outdated with support backward-compatible %s protocol change&quot;, name))</span>
<span class="term-fg32">+	case params.OutdatedPrerelease:</span>
<span class="term-fg32">+		logger.Debug(fmt.Sprintf(&quot;New %s protocol pre-release is available&quot;, name))</span>
<span class="term-fg32">+	case params.DiffBuild:</span>
<span class="term-fg32">+		logger.Debug(fmt.Sprintf(&quot;Ignoring %s protocolversion signal, local build is different&quot;, name))</span>
<span class="term-fg32">+	case params.DiffVersionType:</span>
<span class="term-fg32">+		logger.Warn(fmt.Sprintf(&quot;Failed to recognize %s protocol version signal version-type&quot;, name))</span>
<span class="term-fg32">+	case params.EmptyVersion:</span>
<span class="term-fg32">+		logger.Debug(fmt.Sprintf(&quot;No %s protocol version available to check&quot;, name))</span>
<span class="term-fg32">+	case params.InvalidVersion:</span>
<span class="term-fg32">+		logger.Warn(fmt.Sprintf(&quot;Invalid protocol version comparison with %s&quot;, name))</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+}</span></div>
    </div>

            
        </div>
        <div>
            
        </div>
    </div>
</div>

            
                <div class="ps-1 py-2 my-1"><div class="row border-bottom border-1"data-bs-toggle="collapse" data-bs-target="#id-76e9680439f46fe7b825773a"role="button" aria-expanded="false" aria-controls="id-76e9680439f46fe7b825773a">
        
            <div class="col-12 col-sm-9 text-start"><h3>Support legacy DBs when snap-syncing</h3></div>
        
        <div class="col-12 col-sm-3 ms-auto mt-2">
            <div class="row line-stat">
                <div class="text-end"><span class="text-success">+14</span></div>
                <div class="text-start"><span class="text-danger">-6</span></div>
            </div>
        </div>
    </div>

    <div class="row forkdef-content collapse  border-1 ps-3 my-3" id="id-76e9680439f46fe7b825773a">
        <div><p>Snap-sync does not serve unprefixed code by default.</p>
</div>
        <div>
            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-7f06878d54c9ec7245a89ef6" role="button"
                   aria-expanded="false" aria-controls="id-7f06878d54c9ec7245a89ef6">
                    <code>core/blockchain_reader.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/3f40e65c484486dea6cff80b7db178985d21a2c6/core/blockchain_reader.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/650bb2f2b1dcfe30d9b1fa6f7dc9608055ed60e1/core/blockchain_reader.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+8</span></div>
                        <div class="text-start"><span class="text-danger">-0</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-7f06878d54c9ec7245a89ef6"><span class="term-fg1">diff --git go-ethereum&#47;core&#47;blockchain_reader.go op-geth&#47;core&#47;blockchain_reader.go</span>
<span class="term-fg1">index 466a86c144155008b88c5652b5313f44a900263d..30fbcb883b9aecfade40aa4db1c1c25032822c41 100644</span>
<span class="term-fg1">--- go-ethereum&#47;core&#47;blockchain_reader.go</span>
<span class="term-fg1">+++ op-geth&#47;core&#47;blockchain_reader.go</span>
<span class="term-fg36">@@ -319,6 +319,14 @@</span> 	&#47;&#47; in Verkle scheme. Fix it once snap-sync is supported for Verkle.
 	return bc.stateCache.(codeReader).ContractCodeWithPrefix(common.Address{}, hash)
 }
&nbsp;
<span class="term-fg32">+&#47;&#47; ContractCode retrieves a blob of data associated with a contract hash</span>
<span class="term-fg32">+&#47;&#47; either from ephemeral in-memory cache, or from persistent storage.</span>
<span class="term-fg32">+&#47;&#47; This is a legacy-method, replaced by ContractCodeWithPrefix,</span>
<span class="term-fg32">+&#47;&#47; but required for old databases to serve snap-sync.</span>
<span class="term-fg32">+func (bc *BlockChain) ContractCode(hash common.Hash) ([]byte, error) {</span>
<span class="term-fg32">+	return bc.stateCache.ContractCode(common.Address{}, hash)</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
 &#47;&#47; State returns a new mutable state based on the current HEAD block.
 func (bc *BlockChain) State() (*state.StateDB, error) {
 	return bc.StateAt(bc.CurrentBlock().Root)</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-c539ea0d5d9b77bee3c7ddb5" role="button"
                   aria-expanded="false" aria-controls="id-c539ea0d5d9b77bee3c7ddb5">
                    <code>eth/protocols/snap/handler.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/3f40e65c484486dea6cff80b7db178985d21a2c6/eth/protocols/snap/handler.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/650bb2f2b1dcfe30d9b1fa6f7dc9608055ed60e1/eth/protocols/snap/handler.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+6</span></div>
                        <div class="text-start"><span class="text-danger">-6</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-c539ea0d5d9b77bee3c7ddb5"><span class="term-fg1">diff --git go-ethereum&#47;eth&#47;protocols&#47;snap&#47;handler.go op-geth&#47;eth&#47;protocols&#47;snap&#47;handler.go</span>
<span class="term-fg1">index b2fd03766eca2b4192f79106ecd2fb8dc2dda3e2..18f2458da9ebbf182d868ca30bf10f8bca42ba12 100644</span>
<span class="term-fg1">--- go-ethereum&#47;eth&#47;protocols&#47;snap&#47;handler.go</span>
<span class="term-fg1">+++ op-geth&#47;eth&#47;protocols&#47;snap&#47;handler.go</span>
<span class="term-fg36">@@ -24,13 +24,13 @@</span>
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;common&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;core&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;core&#47;types&quot;
<span class="term-fg31">-	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;light&quot;</span>
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;log&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;metrics&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;p2p&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;p2p&#47;enode&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;p2p&#47;enr&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;trie&quot;
<span class="term-fg32">+	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;trie&#47;trienode&quot;</span>
 )
&nbsp;
 const (
<span class="term-fg36">@@ -321,7 +321,7 @@</span> 	}
 	it.Release()
&nbsp;
 	&#47;&#47; Generate the Merkle proofs for the first and last account
<span class="term-fg31">-	proof := light.NewNodeSet()</span>
<span class="term-fg32">+	proof := trienode.NewProofSet()</span>
 	if err := tr.Prove(req.Origin[:], proof); err != nil {
 		log.Warn(&quot;Failed to prove account range&quot;, &quot;origin&quot;, req.Origin, &quot;err&quot;, err)
 		return nil, nil
<span class="term-fg36">@@ -333,7 +333,7 @@</span> 			return nil, nil
 		}
 	}
 	var proofs [][]byte
<span class="term-fg31">-	for _, blob := range proof.NodeList() {</span>
<span class="term-fg32">+	for _, blob := range proof.List() {</span>
 		proofs = append(proofs, blob)
 	}
 	return accounts, proofs
<span class="term-fg36">@@ -427,7 +427,7 @@</span> 			stTrie, err := trie.NewStateTrie(id, chain.TrieDB())
 			if err != nil {
 				return nil, nil
 			}
<span class="term-fg31">-			proof := light.NewNodeSet()</span>
<span class="term-fg32">+			proof := trienode.NewProofSet()</span>
 			if err := stTrie.Prove(origin[:], proof); err != nil {
 				log.Warn(&quot;Failed to prove storage range&quot;, &quot;origin&quot;, req.Origin, &quot;err&quot;, err)
 				return nil, nil
<span class="term-fg36">@@ -438,7 +438,7 @@</span> 					log.Warn(&quot;Failed to prove storage range&quot;, &quot;last&quot;, last, &quot;err&quot;, err)
 					return nil, nil
 				}
 			}
<span class="term-fg31">-			for _, blob := range proof.NodeList() {</span>
<span class="term-fg32">+			for _, blob := range proof.List() {</span>
 				proofs = append(proofs, blob)
 			}
 			&#47;&#47; Proof terminates the reply as proofs are only added if a node
<span class="term-fg36">@@ -469,7 +469,7 @@</span> 		if hash == types.EmptyCodeHash {
 			&#47;&#47; Peers should not request the empty code, but if they do, at
 			&#47;&#47; least sent them back a correct response without db lookups
 			codes = append(codes, []byte{})
<span class="term-fg31">-		} else if blob, err := chain.ContractCodeWithPrefix(hash); err == nil {</span>
<span class="term-fg32">+		} else if blob, err := chain.ContractCode(hash); err == nil {</span>
 			codes = append(codes, blob)
 			bytes += uint64(len(blob))
 		}</div>
    </div>

            
        </div>
        <div>
            
        </div>
    </div>
</div>

            
                <div class="ps-1 py-2 my-1"><div class="row border-bottom border-1"data-bs-toggle="collapse" data-bs-target="#id-a182e6684532e32fef52150a"role="button" aria-expanded="false" aria-controls="id-a182e6684532e32fef52150a">
        
            <div class="col-12 col-sm-9 text-start"><h3>Discv5 node discovery</h3></div>
        
        <div class="col-12 col-sm-3 ms-auto mt-2">
            <div class="row line-stat">
                <div class="text-end"><span class="text-success">+1</span></div>
                <div class="text-start"><span class="text-danger">-0</span></div>
            </div>
        </div>
    </div>

    <div class="row forkdef-content collapse  border-1 ps-3 my-3" id="id-a182e6684532e32fef52150a">
        <div><p>Fix discv5 option to allow discv5 to be an active source for node-discovery.</p>
</div>
        <div>
            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-aafd17aa3fe424c7b1525506" role="button"
                   aria-expanded="false" aria-controls="id-aafd17aa3fe424c7b1525506">
                    <code>p2p/server.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/3f40e65c484486dea6cff80b7db178985d21a2c6/p2p/server.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/650bb2f2b1dcfe30d9b1fa6f7dc9608055ed60e1/p2p/server.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+1</span></div>
                        <div class="text-start"><span class="text-danger">-0</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-aafd17aa3fe424c7b1525506"><span class="term-fg1">diff --git go-ethereum&#47;p2p&#47;server.go op-geth&#47;p2p&#47;server.go</span>
<span class="term-fg1">index 8f42765a8c263fbfacacddd1bac8f331db67ad11..7975b787bd7dad63981ec1022b7d32477ace2e7c 100644</span>
<span class="term-fg1">--- go-ethereum&#47;p2p&#47;server.go</span>
<span class="term-fg1">+++ op-geth&#47;p2p&#47;server.go</span>
<span class="term-fg36">@@ -579,6 +579,7 @@</span> 		srv.DiscV5, err = discover.ListenV5(sconn, srv.localnode, cfg)
 		if err != nil {
 			return err
 		}
<span class="term-fg32">+		srv.discmix.AddSource(srv.DiscV5.RandomNodes())</span>
 	}
&nbsp;
 	&#47;&#47; Add protocol-specific discovery sources.</div>
    </div>

            
        </div>
        <div>
            
        </div>
    </div>
</div>

            
                <div class="ps-1 py-2 my-1"><div class="row border-bottom border-1"data-bs-toggle="collapse" data-bs-target="#id-18c39d4e75cbc0982f043207"role="button" aria-expanded="false" aria-controls="id-18c39d4e75cbc0982f043207">
        
            <div class="col-12 col-sm-9 text-start"><h3>Generated TOML config update</h3></div>
        
        <div class="col-12 col-sm-3 ms-auto mt-2">
            <div class="row line-stat">
                <div class="text-end"><span class="text-success">+126</span></div>
                <div class="text-start"><span class="text-danger">-78</span></div>
            </div>
        </div>
    </div>

    <div class="row forkdef-content collapse  border-1 ps-3 my-3" id="id-18c39d4e75cbc0982f043207">
        <div></div>
        <div>
            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-2f41d39dea2417500517fdfd" role="button"
                   aria-expanded="false" aria-controls="id-2f41d39dea2417500517fdfd">
                    <code>eth/ethconfig/gen_config.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/3f40e65c484486dea6cff80b7db178985d21a2c6/eth/ethconfig/gen_config.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/650bb2f2b1dcfe30d9b1fa6f7dc9608055ed60e1/eth/ethconfig/gen_config.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+126</span></div>
                        <div class="text-start"><span class="text-danger">-78</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-2f41d39dea2417500517fdfd"><span class="term-fg1">diff --git go-ethereum&#47;eth&#47;ethconfig&#47;gen_config.go op-geth&#47;eth&#47;ethconfig&#47;gen_config.go</span>
<span class="term-fg1">index 2abddc9e0d3878344f5ac547a0ac369db0d4a985..27ade8781daf6977509b46979976db974a4b46de 100644</span>
<span class="term-fg1">--- go-ethereum&#47;eth&#47;ethconfig&#47;gen_config.go</span>
<span class="term-fg1">+++ op-geth&#47;eth&#47;ethconfig&#47;gen_config.go</span>
<span class="term-fg36">@@ -17,45 +17,53 @@</span>
 &#47;&#47; MarshalTOML marshals as TOML.
 func (c Config) MarshalTOML() (interface{}, error) {
 	type Config struct {
<span class="term-fg31">-		Genesis                 *core.Genesis `toml:&quot;,omitempty&quot;`</span>
<span class="term-fg31">-		NetworkId               uint64</span>
<span class="term-fg31">-		SyncMode                downloader.SyncMode</span>
<span class="term-fg31">-		EthDiscoveryURLs        []string</span>
<span class="term-fg31">-		SnapDiscoveryURLs       []string</span>
<span class="term-fg31">-		NoPruning               bool</span>
<span class="term-fg31">-		NoPrefetch              bool</span>
<span class="term-fg31">-		TxLookupLimit           uint64                 `toml:&quot;,omitempty&quot;`</span>
<span class="term-fg31">-		TransactionHistory      uint64                 `toml:&quot;,omitempty&quot;`</span>
<span class="term-fg31">-		StateHistory            uint64                 `toml:&quot;,omitempty&quot;`</span>
<span class="term-fg31">-		StateScheme             string                 `toml:&quot;,omitempty&quot;`</span>
<span class="term-fg31">-		RequiredBlocks          map[uint64]common.Hash `toml:&quot;-&quot;`</span>
<span class="term-fg31">-		LightServ               int                    `toml:&quot;,omitempty&quot;`</span>
<span class="term-fg31">-		LightIngress            int                    `toml:&quot;,omitempty&quot;`</span>
<span class="term-fg31">-		LightEgress             int                    `toml:&quot;,omitempty&quot;`</span>
<span class="term-fg31">-		LightPeers              int                    `toml:&quot;,omitempty&quot;`</span>
<span class="term-fg31">-		LightNoPrune            bool                   `toml:&quot;,omitempty&quot;`</span>
<span class="term-fg31">-		LightNoSyncServe        bool                   `toml:&quot;,omitempty&quot;`</span>
<span class="term-fg31">-		SkipBcVersionCheck      bool                   `toml:&quot;-&quot;`</span>
<span class="term-fg31">-		DatabaseHandles         int                    `toml:&quot;-&quot;`</span>
<span class="term-fg31">-		DatabaseCache           int</span>
<span class="term-fg31">-		DatabaseFreezer         string</span>
<span class="term-fg31">-		TrieCleanCache          int</span>
<span class="term-fg31">-		TrieDirtyCache          int</span>
<span class="term-fg31">-		TrieTimeout             time.Duration</span>
<span class="term-fg31">-		SnapshotCache           int</span>
<span class="term-fg31">-		Preimages               bool</span>
<span class="term-fg31">-		FilterLogCacheSize      int</span>
<span class="term-fg31">-		Miner                   miner.Config</span>
<span class="term-fg31">-		TxPool                  legacypool.Config</span>
<span class="term-fg31">-		BlobPool                blobpool.Config</span>
<span class="term-fg31">-		GPO                     gasprice.Config</span>
<span class="term-fg31">-		EnablePreimageRecording bool</span>
<span class="term-fg31">-		DocRoot                 string `toml:&quot;-&quot;`</span>
<span class="term-fg31">-		RPCGasCap               uint64</span>
<span class="term-fg31">-		RPCEVMTimeout           time.Duration</span>
<span class="term-fg31">-		RPCTxFeeCap             float64</span>
<span class="term-fg31">-		OverrideCancun          *uint64 `toml:&quot;,omitempty&quot;`</span>
<span class="term-fg31">-		OverrideVerkle          *uint64 `toml:&quot;,omitempty&quot;`</span>
<span class="term-fg32">+		Genesis                                 *core.Genesis `toml:&quot;,omitempty&quot;`</span>
<span class="term-fg32">+		NetworkId                               uint64</span>
<span class="term-fg32">+		SyncMode                                downloader.SyncMode</span>
<span class="term-fg32">+		EthDiscoveryURLs                        []string</span>
<span class="term-fg32">+		SnapDiscoveryURLs                       []string</span>
<span class="term-fg32">+		NoPruning                               bool</span>
<span class="term-fg32">+		NoPrefetch                              bool</span>
<span class="term-fg32">+		TxLookupLimit                           uint64                 `toml:&quot;,omitempty&quot;`</span>
<span class="term-fg32">+		TransactionHistory                      uint64                 `toml:&quot;,omitempty&quot;`</span>
<span class="term-fg32">+		StateHistory                            uint64                 `toml:&quot;,omitempty&quot;`</span>
<span class="term-fg32">+		StateScheme                             string                 `toml:&quot;,omitempty&quot;`</span>
<span class="term-fg32">+		RequiredBlocks                          map[uint64]common.Hash `toml:&quot;-&quot;`</span>
<span class="term-fg32">+		LightServ                               int                    `toml:&quot;,omitempty&quot;`</span>
<span class="term-fg32">+		LightIngress                            int                    `toml:&quot;,omitempty&quot;`</span>
<span class="term-fg32">+		LightEgress                             int                    `toml:&quot;,omitempty&quot;`</span>
<span class="term-fg32">+		LightPeers                              int                    `toml:&quot;,omitempty&quot;`</span>
<span class="term-fg32">+		LightNoPrune                            bool                   `toml:&quot;,omitempty&quot;`</span>
<span class="term-fg32">+		LightNoSyncServe                        bool                   `toml:&quot;,omitempty&quot;`</span>
<span class="term-fg32">+		SkipBcVersionCheck                      bool                   `toml:&quot;-&quot;`</span>
<span class="term-fg32">+		DatabaseHandles                         int                    `toml:&quot;-&quot;`</span>
<span class="term-fg32">+		DatabaseCache                           int</span>
<span class="term-fg32">+		DatabaseFreezer                         string</span>
<span class="term-fg32">+		TrieCleanCache                          int</span>
<span class="term-fg32">+		TrieDirtyCache                          int</span>
<span class="term-fg32">+		TrieTimeout                             time.Duration</span>
<span class="term-fg32">+		SnapshotCache                           int</span>
<span class="term-fg32">+		Preimages                               bool</span>
<span class="term-fg32">+		FilterLogCacheSize                      int</span>
<span class="term-fg32">+		Miner                                   miner.Config</span>
<span class="term-fg32">+		TxPool                                  legacypool.Config</span>
<span class="term-fg32">+		BlobPool                                blobpool.Config</span>
<span class="term-fg32">+		GPO                                     gasprice.Config</span>
<span class="term-fg32">+		EnablePreimageRecording                 bool</span>
<span class="term-fg32">+		DocRoot                                 string `toml:&quot;-&quot;`</span>
<span class="term-fg32">+		RPCGasCap                               uint64</span>
<span class="term-fg32">+		RPCEVMTimeout                           time.Duration</span>
<span class="term-fg32">+		RPCTxFeeCap                             float64</span>
<span class="term-fg32">+		OverrideCancun                          *uint64 `toml:&quot;,omitempty&quot;`</span>
<span class="term-fg32">+		OverrideVerkle                          *uint64 `toml:&quot;,omitempty&quot;`</span>
<span class="term-fg32">+		OverrideOptimismCanyon                  *uint64 `toml:&quot;,omitempty&quot;`</span>
<span class="term-fg32">+		ApplySuperchainUpgrades                 bool    `toml:&quot;,omitempty&quot;`</span>
<span class="term-fg32">+		RollupSequencerHTTP                     string</span>
<span class="term-fg32">+		RollupHistoricalRPC                     string</span>
<span class="term-fg32">+		RollupHistoricalRPCTimeout              time.Duration</span>
<span class="term-fg32">+		RollupDisableTxPoolGossip               bool</span>
<span class="term-fg32">+		RollupDisableTxPoolAdmission            bool</span>
<span class="term-fg32">+		RollupHaltOnIncompatibleProtocolVersion string</span>
 	}
 	var enc Config
 	enc.Genesis = c.Genesis
<span class="term-fg36">@@ -97,51 +105,67 @@</span> 	enc.RPCEVMTimeout = c.RPCEVMTimeout
 	enc.RPCTxFeeCap = c.RPCTxFeeCap
 	enc.OverrideCancun = c.OverrideCancun
 	enc.OverrideVerkle = c.OverrideVerkle
<span class="term-fg32">+	enc.OverrideOptimismCanyon = c.OverrideOptimismCanyon</span>
<span class="term-fg32">+	enc.ApplySuperchainUpgrades = c.ApplySuperchainUpgrades</span>
<span class="term-fg32">+	enc.RollupSequencerHTTP = c.RollupSequencerHTTP</span>
<span class="term-fg32">+	enc.RollupHistoricalRPC = c.RollupHistoricalRPC</span>
<span class="term-fg32">+	enc.RollupHistoricalRPCTimeout = c.RollupHistoricalRPCTimeout</span>
<span class="term-fg32">+	enc.RollupDisableTxPoolGossip = c.RollupDisableTxPoolGossip</span>
<span class="term-fg32">+	enc.RollupDisableTxPoolAdmission = c.RollupDisableTxPoolAdmission</span>
<span class="term-fg32">+	enc.RollupHaltOnIncompatibleProtocolVersion = c.RollupHaltOnIncompatibleProtocolVersion</span>
 	return &amp;enc, nil
 }
&nbsp;
 &#47;&#47; UnmarshalTOML unmarshals from TOML.
 func (c *Config) UnmarshalTOML(unmarshal func(interface{}) error) error {
 	type Config struct {
<span class="term-fg31">-		Genesis                 *core.Genesis `toml:&quot;,omitempty&quot;`</span>
<span class="term-fg31">-		NetworkId               *uint64</span>
<span class="term-fg31">-		SyncMode                *downloader.SyncMode</span>
<span class="term-fg31">-		EthDiscoveryURLs        []string</span>
<span class="term-fg31">-		SnapDiscoveryURLs       []string</span>
<span class="term-fg31">-		NoPruning               *bool</span>
<span class="term-fg31">-		NoPrefetch              *bool</span>
<span class="term-fg31">-		TxLookupLimit           *uint64                `toml:&quot;,omitempty&quot;`</span>
<span class="term-fg31">-		TransactionHistory      *uint64                `toml:&quot;,omitempty&quot;`</span>
<span class="term-fg31">-		StateHistory            *uint64                `toml:&quot;,omitempty&quot;`</span>
<span class="term-fg31">-		StateScheme             *string                `toml:&quot;,omitempty&quot;`</span>
<span class="term-fg31">-		RequiredBlocks          map[uint64]common.Hash `toml:&quot;-&quot;`</span>
<span class="term-fg31">-		LightServ               *int                   `toml:&quot;,omitempty&quot;`</span>
<span class="term-fg31">-		LightIngress            *int                   `toml:&quot;,omitempty&quot;`</span>
<span class="term-fg31">-		LightEgress             *int                   `toml:&quot;,omitempty&quot;`</span>
<span class="term-fg31">-		LightPeers              *int                   `toml:&quot;,omitempty&quot;`</span>
<span class="term-fg31">-		LightNoPrune            *bool                  `toml:&quot;,omitempty&quot;`</span>
<span class="term-fg31">-		LightNoSyncServe        *bool                  `toml:&quot;,omitempty&quot;`</span>
<span class="term-fg31">-		SkipBcVersionCheck      *bool                  `toml:&quot;-&quot;`</span>
<span class="term-fg31">-		DatabaseHandles         *int                   `toml:&quot;-&quot;`</span>
<span class="term-fg31">-		DatabaseCache           *int</span>
<span class="term-fg31">-		DatabaseFreezer         *string</span>
<span class="term-fg31">-		TrieCleanCache          *int</span>
<span class="term-fg31">-		TrieDirtyCache          *int</span>
<span class="term-fg31">-		TrieTimeout             *time.Duration</span>
<span class="term-fg31">-		SnapshotCache           *int</span>
<span class="term-fg31">-		Preimages               *bool</span>
<span class="term-fg31">-		FilterLogCacheSize      *int</span>
<span class="term-fg31">-		Miner                   *miner.Config</span>
<span class="term-fg31">-		TxPool                  *legacypool.Config</span>
<span class="term-fg31">-		BlobPool                *blobpool.Config</span>
<span class="term-fg31">-		GPO                     *gasprice.Config</span>
<span class="term-fg31">-		EnablePreimageRecording *bool</span>
<span class="term-fg31">-		DocRoot                 *string `toml:&quot;-&quot;`</span>
<span class="term-fg31">-		RPCGasCap               *uint64</span>
<span class="term-fg31">-		RPCEVMTimeout           *time.Duration</span>
<span class="term-fg31">-		RPCTxFeeCap             *float64</span>
<span class="term-fg31">-		OverrideCancun          *uint64 `toml:&quot;,omitempty&quot;`</span>
<span class="term-fg31">-		OverrideVerkle          *uint64 `toml:&quot;,omitempty&quot;`</span>
<span class="term-fg32">+		Genesis                                 *core.Genesis `toml:&quot;,omitempty&quot;`</span>
<span class="term-fg32">+		NetworkId                               *uint64</span>
<span class="term-fg32">+		SyncMode                                *downloader.SyncMode</span>
<span class="term-fg32">+		EthDiscoveryURLs                        []string</span>
<span class="term-fg32">+		SnapDiscoveryURLs                       []string</span>
<span class="term-fg32">+		NoPruning                               *bool</span>
<span class="term-fg32">+		NoPrefetch                              *bool</span>
<span class="term-fg32">+		TxLookupLimit                           *uint64                `toml:&quot;,omitempty&quot;`</span>
<span class="term-fg32">+		TransactionHistory                      *uint64                `toml:&quot;,omitempty&quot;`</span>
<span class="term-fg32">+		StateHistory                            *uint64                `toml:&quot;,omitempty&quot;`</span>
<span class="term-fg32">+		StateScheme                             *string                `toml:&quot;,omitempty&quot;`</span>
<span class="term-fg32">+		RequiredBlocks                          map[uint64]common.Hash `toml:&quot;-&quot;`</span>
<span class="term-fg32">+		LightServ                               *int                   `toml:&quot;,omitempty&quot;`</span>
<span class="term-fg32">+		LightIngress                            *int                   `toml:&quot;,omitempty&quot;`</span>
<span class="term-fg32">+		LightEgress                             *int                   `toml:&quot;,omitempty&quot;`</span>
<span class="term-fg32">+		LightPeers                              *int                   `toml:&quot;,omitempty&quot;`</span>
<span class="term-fg32">+		LightNoPrune                            *bool                  `toml:&quot;,omitempty&quot;`</span>
<span class="term-fg32">+		LightNoSyncServe                        *bool                  `toml:&quot;,omitempty&quot;`</span>
<span class="term-fg32">+		SkipBcVersionCheck                      *bool                  `toml:&quot;-&quot;`</span>
<span class="term-fg32">+		DatabaseHandles                         *int                   `toml:&quot;-&quot;`</span>
<span class="term-fg32">+		DatabaseCache                           *int</span>
<span class="term-fg32">+		DatabaseFreezer                         *string</span>
<span class="term-fg32">+		TrieCleanCache                          *int</span>
<span class="term-fg32">+		TrieDirtyCache                          *int</span>
<span class="term-fg32">+		TrieTimeout                             *time.Duration</span>
<span class="term-fg32">+		SnapshotCache                           *int</span>
<span class="term-fg32">+		Preimages                               *bool</span>
<span class="term-fg32">+		FilterLogCacheSize                      *int</span>
<span class="term-fg32">+		Miner                                   *miner.Config</span>
<span class="term-fg32">+		TxPool                                  *legacypool.Config</span>
<span class="term-fg32">+		BlobPool                                *blobpool.Config</span>
<span class="term-fg32">+		GPO                                     *gasprice.Config</span>
<span class="term-fg32">+		EnablePreimageRecording                 *bool</span>
<span class="term-fg32">+		DocRoot                                 *string `toml:&quot;-&quot;`</span>
<span class="term-fg32">+		RPCGasCap                               *uint64</span>
<span class="term-fg32">+		RPCEVMTimeout                           *time.Duration</span>
<span class="term-fg32">+		RPCTxFeeCap                             *float64</span>
<span class="term-fg32">+		OverrideCancun                          *uint64 `toml:&quot;,omitempty&quot;`</span>
<span class="term-fg32">+		OverrideVerkle                          *uint64 `toml:&quot;,omitempty&quot;`</span>
<span class="term-fg32">+		OverrideOptimismCanyon                  *uint64 `toml:&quot;,omitempty&quot;`</span>
<span class="term-fg32">+		ApplySuperchainUpgrades                 *bool   `toml:&quot;,omitempty&quot;`</span>
<span class="term-fg32">+		RollupSequencerHTTP                     *string</span>
<span class="term-fg32">+		RollupHistoricalRPC                     *string</span>
<span class="term-fg32">+		RollupHistoricalRPCTimeout              *time.Duration</span>
<span class="term-fg32">+		RollupDisableTxPoolGossip               *bool</span>
<span class="term-fg32">+		RollupDisableTxPoolAdmission            *bool</span>
<span class="term-fg32">+		RollupHaltOnIncompatibleProtocolVersion *string</span>
 	}
 	var dec Config
 	if err := unmarshal(&amp;dec); err != nil {
<span class="term-fg36">@@ -263,6 +287,30 @@</span> 		c.OverrideCancun = dec.OverrideCancun
 	}
 	if dec.OverrideVerkle != nil {
 		c.OverrideVerkle = dec.OverrideVerkle
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	if dec.OverrideOptimismCanyon != nil {</span>
<span class="term-fg32">+		c.OverrideOptimismCanyon = dec.OverrideOptimismCanyon</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	if dec.ApplySuperchainUpgrades != nil {</span>
<span class="term-fg32">+		c.ApplySuperchainUpgrades = *dec.ApplySuperchainUpgrades</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	if dec.RollupSequencerHTTP != nil {</span>
<span class="term-fg32">+		c.RollupSequencerHTTP = *dec.RollupSequencerHTTP</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	if dec.RollupHistoricalRPC != nil {</span>
<span class="term-fg32">+		c.RollupHistoricalRPC = *dec.RollupHistoricalRPC</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	if dec.RollupHistoricalRPCTimeout != nil {</span>
<span class="term-fg32">+		c.RollupHistoricalRPCTimeout = *dec.RollupHistoricalRPCTimeout</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	if dec.RollupDisableTxPoolGossip != nil {</span>
<span class="term-fg32">+		c.RollupDisableTxPoolGossip = *dec.RollupDisableTxPoolGossip</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	if dec.RollupDisableTxPoolAdmission != nil {</span>
<span class="term-fg32">+		c.RollupDisableTxPoolAdmission = *dec.RollupDisableTxPoolAdmission</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	if dec.RollupHaltOnIncompatibleProtocolVersion != nil {</span>
<span class="term-fg32">+		c.RollupHaltOnIncompatibleProtocolVersion = *dec.RollupHaltOnIncompatibleProtocolVersion</span>
 	}
 	return nil
 }</div>
    </div>

            
        </div>
        <div>
            
        </div>
    </div>
</div>

            
        </div>
    </div>
</div>

            
                <div class="ps-1 py-2 my-1"><div class="row border-bottom border-1"data-bs-toggle="collapse" data-bs-target="#id-39f5495174cefd28b76363d1"role="button" aria-expanded="false" aria-controls="id-39f5495174cefd28b76363d1">
        
            <div class="col-12 col-sm-9 text-start"><h2>User API enhancements</h2></div>
        
        <div class="col-12 col-sm-3 ms-auto mt-2">
            <div class="row line-stat">
                <div class="text-end"><span class="text-success">+1289</span></div>
                <div class="text-start"><span class="text-danger">-111</span></div>
            </div>
        </div>
    </div>

    <div class="row forkdef-content collapse  border-1 ps-3 my-3" id="id-39f5495174cefd28b76363d1">
        <div><p>Encode the Deposit Tx properties, the L1 costs, and daisy-chain RPC-calls for pre-Bedrock historical data</p>
</div>
        <div>
            
        </div>
        <div>
            
                <div class="ps-1 py-2 my-1"><div class="row border-bottom border-1"data-bs-toggle="collapse" data-bs-target="#id-4e70d4e3d51cda93ccf36e05"role="button" aria-expanded="false" aria-controls="id-4e70d4e3d51cda93ccf36e05">
        
            <div class="col-12 col-sm-9 text-start"><h3>Receipts metadata</h3></div>
        
        <div class="col-12 col-sm-3 ms-auto mt-2">
            <div class="row line-stat">
                <div class="text-end"><span class="text-success">+260</span></div>
                <div class="text-start"><span class="text-danger">-7</span></div>
            </div>
        </div>
    </div>

    <div class="row forkdef-content collapse  border-1 ps-3 my-3" id="id-4e70d4e3d51cda93ccf36e05">
        <div><p>Pre-Bedrock L1-cost receipt data is loaded from the database if available, and post-Bedrock the L1-cost
metadata is hydrated on-the-fly based on the L1 fee information in the corresponding block.</p>
</div>
        <div>
            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-513bc92358e76eef9ac77f1d" role="button"
                   aria-expanded="false" aria-controls="id-513bc92358e76eef9ac77f1d">
                    <code>core/types/receipt.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/3f40e65c484486dea6cff80b7db178985d21a2c6/core/types/receipt.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/650bb2f2b1dcfe30d9b1fa6f7dc9608055ed60e1/core/types/receipt.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+223</span></div>
                        <div class="text-start"><span class="text-danger">-6</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-513bc92358e76eef9ac77f1d"><span class="term-fg1">diff --git go-ethereum&#47;core&#47;types&#47;receipt.go op-geth&#47;core&#47;types&#47;receipt.go</span>
<span class="term-fg1">index 4f96fde59c44278beee06e9846e158c2501644e6..100ac987959164d0c926af97c8771717f1cce5fb 100644</span>
<span class="term-fg1">--- go-ethereum&#47;core&#47;types&#47;receipt.go</span>
<span class="term-fg1">+++ op-geth&#47;core&#47;types&#47;receipt.go</span>
<span class="term-fg36">@@ -46,6 +46,9 @@</span> 	ReceiptStatusFailed = uint64(0)
&nbsp;
 	&#47;&#47; ReceiptStatusSuccessful is the status code of a transaction if execution succeeded.
 	ReceiptStatusSuccessful = uint64(1)
<span class="term-fg32">+</span>
<span class="term-fg32">+	&#47;&#47; The version number for post-canyon deposit receipts.</span>
<span class="term-fg32">+	CanyonDepositReceiptVersion = uint64(1)</span>
 )
&nbsp;
 &#47;&#47; Receipt represents the results of a transaction.
<span class="term-fg36">@@ -58,7 +61,8 @@</span> 	CumulativeGasUsed uint64 `json:&quot;cumulativeGasUsed&quot; gencodec:&quot;required&quot;`
 	Bloom             Bloom  `json:&quot;logsBloom&quot;         gencodec:&quot;required&quot;`
 	Logs              []*Log `json:&quot;logs&quot;              gencodec:&quot;required&quot;`
&nbsp;
<span class="term-fg31">-	&#47;&#47; Implementation fields: These fields are added by geth when processing a transaction.</span>
<span class="term-fg32">+	&#47;&#47; Implementation fields: These fields are added by geth when processing a transaction or retrieving a receipt.</span>
<span class="term-fg32">+	&#47;&#47; gencodec annotated fields: these are stored in the chain database.</span>
 	TxHash            common.Hash    `json:&quot;transactionHash&quot; gencodec:&quot;required&quot;`
 	ContractAddress   common.Address `json:&quot;contractAddress&quot;`
 	GasUsed           uint64         `json:&quot;gasUsed&quot; gencodec:&quot;required&quot;`
<span class="term-fg36">@@ -66,11 +70,25 @@</span> 	EffectiveGasPrice *big.Int       `json:&quot;effectiveGasPrice&quot;` &#47;&#47; required, but tag omitted for backwards compatibility
 	BlobGasUsed       uint64         `json:&quot;blobGasUsed,omitempty&quot;`
 	BlobGasPrice      *big.Int       `json:&quot;blobGasPrice,omitempty&quot;`
&nbsp;
<span class="term-fg32">+	&#47;&#47; DepositNonce was introduced in Regolith to store the actual nonce used by deposit transactions</span>
<span class="term-fg32">+	&#47;&#47; The state transition process ensures this is only set for Regolith deposit transactions.</span>
<span class="term-fg32">+	DepositNonce *uint64 `json:&quot;depositNonce,omitempty&quot;`</span>
<span class="term-fg32">+	&#47;&#47; DepositReceiptVersion was introduced in Canyon to indicate an update to how receipt hashes</span>
<span class="term-fg32">+	&#47;&#47; should be computed when set. The state transition process ensures this is only set for</span>
<span class="term-fg32">+	&#47;&#47; post-Canyon deposit transactions.</span>
<span class="term-fg32">+	DepositReceiptVersion *uint64 `json:&quot;depositReceiptVersion,omitempty&quot;`</span>
<span class="term-fg32">+</span>
 	&#47;&#47; Inclusion information: These fields provide information about the inclusion of the
 	&#47;&#47; transaction corresponding to this receipt.
 	BlockHash        common.Hash `json:&quot;blockHash,omitempty&quot;`
 	BlockNumber      *big.Int    `json:&quot;blockNumber,omitempty&quot;`
 	TransactionIndex uint        `json:&quot;transactionIndex&quot;`
<span class="term-fg32">+</span>
<span class="term-fg32">+	&#47;&#47; OVM legacy: extend receipts with their L1 price (if a rollup tx)</span>
<span class="term-fg32">+	L1GasPrice *big.Int   `json:&quot;l1GasPrice,omitempty&quot;`</span>
<span class="term-fg32">+	L1GasUsed  *big.Int   `json:&quot;l1GasUsed,omitempty&quot;`</span>
<span class="term-fg32">+	L1Fee      *big.Int   `json:&quot;l1Fee,omitempty&quot;`</span>
<span class="term-fg32">+	FeeScalar  *big.Float `json:&quot;l1FeeScalar,omitempty&quot;`</span>
 }
&nbsp;
 type receiptMarshaling struct {
<span class="term-fg36">@@ -84,6 +102,12 @@</span> 	BlobGasUsed       hexutil.Uint64
 	BlobGasPrice      *hexutil.Big
 	BlockNumber       *hexutil.Big
 	TransactionIndex  hexutil.Uint
<span class="term-fg32">+</span>
<span class="term-fg32">+	&#47;&#47; Optimism: extend receipts with their L1 price (if a rollup tx)</span>
<span class="term-fg32">+	L1GasPrice *hexutil.Big</span>
<span class="term-fg32">+	L1GasUsed  *hexutil.Big</span>
<span class="term-fg32">+	L1Fee      *hexutil.Big</span>
<span class="term-fg32">+	FeeScalar  *big.Float</span>
 }
&nbsp;
 &#47;&#47; receiptRLP is the consensus encoding of a receipt.
<span class="term-fg36">@@ -94,11 +118,98 @@</span> 	Bloom             Bloom
 	Logs              []*Log
 }
&nbsp;
<span class="term-fg32">+type depositReceiptRLP struct {</span>
<span class="term-fg32">+	PostStateOrStatus []byte</span>
<span class="term-fg32">+	CumulativeGasUsed uint64</span>
<span class="term-fg32">+	Bloom             Bloom</span>
<span class="term-fg32">+	Logs              []*Log</span>
<span class="term-fg32">+	&#47;&#47; DepositNonce was introduced in Regolith to store the actual nonce used by deposit transactions.</span>
<span class="term-fg32">+	&#47;&#47; Must be nil for any transactions prior to Regolith or that aren&#39;t deposit transactions.</span>
<span class="term-fg32">+	DepositNonce *uint64 `rlp:&quot;optional&quot;`</span>
<span class="term-fg32">+	&#47;&#47; Receipt hash post-Regolith but pre-Canyon inadvertently did not include the above</span>
<span class="term-fg32">+	&#47;&#47; DepositNonce. Post Canyon, receipts will have a non-empty DepositReceiptVersion indicating</span>
<span class="term-fg32">+	&#47;&#47; which post-Canyon receipt hash function to invoke.</span>
<span class="term-fg32">+	DepositReceiptVersion *uint64 `rlp:&quot;optional&quot;`</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
 &#47;&#47; storedReceiptRLP is the storage encoding of a receipt.
 type storedReceiptRLP struct {
 	PostStateOrStatus []byte
 	CumulativeGasUsed uint64
 	Logs              []*Log
<span class="term-fg32">+	&#47;&#47; DepositNonce was introduced in Regolith to store the actual nonce used by deposit transactions.</span>
<span class="term-fg32">+	&#47;&#47; Must be nil for any transactions prior to Regolith or that aren&#39;t deposit transactions.</span>
<span class="term-fg32">+	DepositNonce *uint64 `rlp:&quot;optional&quot;`</span>
<span class="term-fg32">+	&#47;&#47; Receipt hash post-Regolith but pre-Canyon inadvertently did not include the above</span>
<span class="term-fg32">+	&#47;&#47; DepositNonce. Post Canyon, receipts will have a non-empty DepositReceiptVersion indicating</span>
<span class="term-fg32">+	&#47;&#47; which post-Canyon receipt hash function to invoke.</span>
<span class="term-fg32">+	DepositReceiptVersion *uint64 `rlp:&quot;optional&quot;`</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+&#47;&#47; LegacyOptimismStoredReceiptRLP is the pre bedrock storage encoding of a</span>
<span class="term-fg32">+&#47;&#47; receipt. It will only exist in the database if it was migrated using the</span>
<span class="term-fg32">+&#47;&#47; migration tool. Nodes that sync using snap-sync will not have any of these</span>
<span class="term-fg32">+&#47;&#47; entries.</span>
<span class="term-fg32">+type LegacyOptimismStoredReceiptRLP struct {</span>
<span class="term-fg32">+	PostStateOrStatus []byte</span>
<span class="term-fg32">+	CumulativeGasUsed uint64</span>
<span class="term-fg32">+	Logs              []*LogForStorage</span>
<span class="term-fg32">+	L1GasUsed         *big.Int</span>
<span class="term-fg32">+	L1GasPrice        *big.Int</span>
<span class="term-fg32">+	L1Fee             *big.Int</span>
<span class="term-fg32">+	FeeScalar         string</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+&#47;&#47; LogForStorage is a wrapper around a Log that handles</span>
<span class="term-fg32">+&#47;&#47; backward compatibility with prior storage formats.</span>
<span class="term-fg32">+type LogForStorage Log</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+&#47;&#47; EncodeRLP implements rlp.Encoder.</span>
<span class="term-fg32">+func (l *LogForStorage) EncodeRLP(w io.Writer) error {</span>
<span class="term-fg32">+	rl := Log{Address: l.Address, Topics: l.Topics, Data: l.Data}</span>
<span class="term-fg32">+	return rlp.Encode(w, &amp;rl)</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+type legacyRlpStorageLog struct {</span>
<span class="term-fg32">+	Address     common.Address</span>
<span class="term-fg32">+	Topics      []common.Hash</span>
<span class="term-fg32">+	Data        []byte</span>
<span class="term-fg32">+	BlockNumber uint64</span>
<span class="term-fg32">+	TxHash      common.Hash</span>
<span class="term-fg32">+	TxIndex     uint</span>
<span class="term-fg32">+	BlockHash   common.Hash</span>
<span class="term-fg32">+	Index       uint</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+&#47;&#47; DecodeRLP implements rlp.Decoder.</span>
<span class="term-fg32">+&#47;&#47;</span>
<span class="term-fg32">+&#47;&#47; Note some redundant fields(e.g. block number, tx hash etc) will be assembled later.</span>
<span class="term-fg32">+func (l *LogForStorage) DecodeRLP(s *rlp.Stream) error {</span>
<span class="term-fg32">+	blob, err := s.Raw()</span>
<span class="term-fg32">+	if err != nil {</span>
<span class="term-fg32">+		return err</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	var dec Log</span>
<span class="term-fg32">+	err = rlp.DecodeBytes(blob, &amp;dec)</span>
<span class="term-fg32">+	if err == nil {</span>
<span class="term-fg32">+		*l = LogForStorage{</span>
<span class="term-fg32">+			Address: dec.Address,</span>
<span class="term-fg32">+			Topics:  dec.Topics,</span>
<span class="term-fg32">+			Data:    dec.Data,</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+	} else {</span>
<span class="term-fg32">+		&#47;&#47; Try to decode log with previous definition.</span>
<span class="term-fg32">+		var dec legacyRlpStorageLog</span>
<span class="term-fg32">+		err = rlp.DecodeBytes(blob, &amp;dec)</span>
<span class="term-fg32">+		if err == nil {</span>
<span class="term-fg32">+			*l = LogForStorage{</span>
<span class="term-fg32">+				Address: dec.Address,</span>
<span class="term-fg32">+				Topics:  dec.Topics,</span>
<span class="term-fg32">+				Data:    dec.Data,</span>
<span class="term-fg32">+			}</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	return err</span>
 }
&nbsp;
 &#47;&#47; NewReceipt creates a barebone transaction receipt, copying the init fields.
<span class="term-fg36">@@ -136,7 +247,13 @@</span>
 &#47;&#47; encodeTyped writes the canonical encoding of a typed receipt to w.
 func (r *Receipt) encodeTyped(data *receiptRLP, w *bytes.Buffer) error {
 	w.WriteByte(r.Type)
<span class="term-fg31">-	return rlp.Encode(w, data)</span>
<span class="term-fg32">+	switch r.Type {</span>
<span class="term-fg32">+	case DepositTxType:</span>
<span class="term-fg32">+		withNonce := &amp;depositReceiptRLP{data.PostStateOrStatus, data.CumulativeGasUsed, data.Bloom, data.Logs, r.DepositNonce, r.DepositReceiptVersion}</span>
<span class="term-fg32">+		return rlp.Encode(w, withNonce)</span>
<span class="term-fg32">+	default:</span>
<span class="term-fg32">+		return rlp.Encode(w, data)</span>
<span class="term-fg32">+	}</span>
 }
&nbsp;
 &#47;&#47; MarshalBinary returns the consensus encoding of the receipt.
<span class="term-fg36">@@ -212,6 +329,16 @@</span> 			return err
 		}
 		r.Type = b[0]
 		return r.setFromRLP(data)
<span class="term-fg32">+	case DepositTxType:</span>
<span class="term-fg32">+		var data depositReceiptRLP</span>
<span class="term-fg32">+		err := rlp.DecodeBytes(b[1:], &amp;data)</span>
<span class="term-fg32">+		if err != nil {</span>
<span class="term-fg32">+			return err</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+		r.Type = b[0]</span>
<span class="term-fg32">+		r.DepositNonce = data.DepositNonce</span>
<span class="term-fg32">+		r.DepositReceiptVersion = data.DepositReceiptVersion</span>
<span class="term-fg32">+		return r.setFromRLP(receiptRLP{data.PostStateOrStatus, data.CumulativeGasUsed, data.Bloom, data.Logs})</span>
 	default:
 		return ErrTxTypeNotSupported
 	}
<span class="term-fg36">@@ -275,6 +402,12 @@</span> 			return err
 		}
 	}
 	w.ListEnd(logList)
<span class="term-fg32">+	if r.DepositNonce != nil {</span>
<span class="term-fg32">+		w.WriteUint64(*r.DepositNonce)</span>
<span class="term-fg32">+		if r.DepositReceiptVersion != nil {</span>
<span class="term-fg32">+			w.WriteUint64(*r.DepositReceiptVersion)</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+	}</span>
 	w.ListEnd(outerList)
 	return w.Flush()
 }
<span class="term-fg36">@@ -282,8 +415,51 @@</span>
 &#47;&#47; DecodeRLP implements rlp.Decoder, and loads both consensus and implementation
 &#47;&#47; fields of a receipt from an RLP stream.
 func (r *ReceiptForStorage) DecodeRLP(s *rlp.Stream) error {
<span class="term-fg32">+	&#47;&#47; Retrieve the entire receipt blob as we need to try multiple decoders</span>
<span class="term-fg32">+	blob, err := s.Raw()</span>
<span class="term-fg32">+	if err != nil {</span>
<span class="term-fg32">+		return err</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	&#47;&#47; First try to decode the latest receipt database format, try the pre-bedrock Optimism legacy format otherwise.</span>
<span class="term-fg32">+	if err := decodeStoredReceiptRLP(r, blob); err == nil {</span>
<span class="term-fg32">+		return nil</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	return decodeLegacyOptimismReceiptRLP(r, blob)</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func decodeLegacyOptimismReceiptRLP(r *ReceiptForStorage, blob []byte) error {</span>
<span class="term-fg32">+	var stored LegacyOptimismStoredReceiptRLP</span>
<span class="term-fg32">+	if err := rlp.DecodeBytes(blob, &amp;stored); err != nil {</span>
<span class="term-fg32">+		return err</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	if err := (*Receipt)(r).setStatus(stored.PostStateOrStatus); err != nil {</span>
<span class="term-fg32">+		return err</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	r.CumulativeGasUsed = stored.CumulativeGasUsed</span>
<span class="term-fg32">+	r.Logs = make([]*Log, len(stored.Logs))</span>
<span class="term-fg32">+	for i, log := range stored.Logs {</span>
<span class="term-fg32">+		r.Logs[i] = (*Log)(log)</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	r.Bloom = CreateBloom(Receipts{(*Receipt)(r)})</span>
<span class="term-fg32">+	&#47;&#47; UsingOVM</span>
<span class="term-fg32">+	scalar := new(big.Float)</span>
<span class="term-fg32">+	if stored.FeeScalar != &quot;&quot; {</span>
<span class="term-fg32">+		var ok bool</span>
<span class="term-fg32">+		scalar, ok = scalar.SetString(stored.FeeScalar)</span>
<span class="term-fg32">+		if !ok {</span>
<span class="term-fg32">+			return errors.New(&quot;cannot parse fee scalar&quot;)</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	r.L1GasUsed = stored.L1GasUsed</span>
<span class="term-fg32">+	r.L1GasPrice = stored.L1GasPrice</span>
<span class="term-fg32">+	r.L1Fee = stored.L1Fee</span>
<span class="term-fg32">+	r.FeeScalar = scalar</span>
<span class="term-fg32">+	return nil</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func decodeStoredReceiptRLP(r *ReceiptForStorage, blob []byte) error {</span>
 	var stored storedReceiptRLP
<span class="term-fg31">-	if err := s.Decode(&amp;stored); err != nil {</span>
<span class="term-fg32">+	if err := rlp.DecodeBytes(blob, &amp;stored); err != nil {</span>
 		return err
 	}
 	if err := (*Receipt)(r).setStatus(stored.PostStateOrStatus); err != nil {
<span class="term-fg36">@@ -292,7 +468,10 @@</span> 	}
 	r.CumulativeGasUsed = stored.CumulativeGasUsed
 	r.Logs = stored.Logs
 	r.Bloom = CreateBloom(Receipts{(*Receipt)(r)})
<span class="term-fg31">-</span>
<span class="term-fg32">+	if stored.DepositNonce != nil {</span>
<span class="term-fg32">+		r.DepositNonce = stored.DepositNonce</span>
<span class="term-fg32">+		r.DepositReceiptVersion = stored.DepositReceiptVersion</span>
<span class="term-fg32">+	}</span>
 	return nil
 }
&nbsp;
<span class="term-fg36">@@ -302,7 +481,10 @@</span>
 &#47;&#47; Len returns the number of receipts in this list.
 func (rs Receipts) Len() int { return len(rs) }
&nbsp;
<span class="term-fg31">-&#47;&#47; EncodeIndex encodes the i&#39;th receipt to w.</span>
<span class="term-fg32">+&#47;&#47; EncodeIndex encodes the i&#39;th receipt to w. For DepositTxType receipts with non-nil DepositNonce</span>
<span class="term-fg32">+&#47;&#47; but nil DepositReceiptVersion, the output will differ than calling r.MarshalBinary(); this</span>
<span class="term-fg32">+&#47;&#47; behavior difference should not be changed to preserve backwards compatibility of receipt-root</span>
<span class="term-fg32">+&#47;&#47; hash computation.</span>
 func (rs Receipts) EncodeIndex(i int, w *bytes.Buffer) {
 	r := rs[i]
 	data := &amp;receiptRLP{r.statusEncoding(), r.CumulativeGasUsed, r.Bloom, r.Logs}
<span class="term-fg36">@@ -314,6 +496,14 @@</span> 	w.WriteByte(r.Type)
 	switch r.Type {
 	case AccessListTxType, DynamicFeeTxType, BlobTxType:
 		rlp.Encode(w, data)
<span class="term-fg32">+	case DepositTxType:</span>
<span class="term-fg32">+		if r.DepositReceiptVersion != nil {</span>
<span class="term-fg32">+			&#47;&#47; post-canyon receipt hash computation update</span>
<span class="term-fg32">+			depositData := &amp;depositReceiptRLP{data.PostStateOrStatus, data.CumulativeGasUsed, r.Bloom, r.Logs, r.DepositNonce, r.DepositReceiptVersion}</span>
<span class="term-fg32">+			rlp.Encode(w, depositData)</span>
<span class="term-fg32">+		} else {</span>
<span class="term-fg32">+			rlp.Encode(w, data)</span>
<span class="term-fg32">+		}</span>
 	default:
 		&#47;&#47; For unsupported types, write nothing. Since this is for
 		&#47;&#47; DeriveSha, the error will be caught matching the derived hash
<span class="term-fg36">@@ -351,7 +541,11 @@</span> 		&#47;&#47; The contract address can be derived from the transaction itself
 		if txs[i].To() == nil {
 			&#47;&#47; Deriving the signer is expensive, only do if it&#39;s actually needed
 			from, _ := Sender(signer, txs[i])
<span class="term-fg31">-			rs[i].ContractAddress = crypto.CreateAddress(from, txs[i].Nonce())</span>
<span class="term-fg32">+			nonce := txs[i].Nonce()</span>
<span class="term-fg32">+			if rs[i].DepositNonce != nil {</span>
<span class="term-fg32">+				nonce = *rs[i].DepositNonce</span>
<span class="term-fg32">+			}</span>
<span class="term-fg32">+			rs[i].ContractAddress = crypto.CreateAddress(from, nonce)</span>
 		} else {
 			rs[i].ContractAddress = common.Address{}
 		}
<span class="term-fg36">@@ -373,5 +567,28 @@</span> 			rs[i].Logs[j].Index = logIndex
 			logIndex++
 		}
 	}
<span class="term-fg32">+	if config.Optimism != nil &amp;&amp; len(txs) &gt;= 2 { &#47;&#47; need at least an info tx and a non-info tx</span>
<span class="term-fg32">+		if data := txs[0].Data(); len(data) &gt;= 4+32*8 { &#47;&#47; function selector + 8 arguments to setL1BlockValues</span>
<span class="term-fg32">+			l1Basefee := new(big.Int).SetBytes(data[4+32*2 : 4+32*3]) &#47;&#47; arg index 2</span>
<span class="term-fg32">+			overhead := new(big.Int).SetBytes(data[4+32*6 : 4+32*7])  &#47;&#47; arg index 6</span>
<span class="term-fg32">+			scalar := new(big.Int).SetBytes(data[4+32*7 : 4+32*8])    &#47;&#47; arg index 7</span>
<span class="term-fg32">+			fscalar := new(big.Float).SetInt(scalar)                  &#47;&#47; legacy: format fee scalar as big Float</span>
<span class="term-fg32">+			fdivisor := new(big.Float).SetUint64(1_000_000)           &#47;&#47; 10**6, i.e. 6 decimals</span>
<span class="term-fg32">+			feeScalar := new(big.Float).Quo(fscalar, fdivisor)</span>
<span class="term-fg32">+			for i := 0; i &lt; len(rs); i++ {</span>
<span class="term-fg32">+				if !txs[i].IsDepositTx() {</span>
<span class="term-fg32">+					gas := txs[i].RollupDataGas().DataGas(time, config)</span>
<span class="term-fg32">+					rs[i].L1GasPrice = l1Basefee</span>
<span class="term-fg32">+					&#47;&#47; GasUsed reported in receipt should include the overhead</span>
<span class="term-fg32">+					rs[i].L1GasUsed = new(big.Int).Add(new(big.Int).SetUint64(gas), overhead)</span>
<span class="term-fg32">+					rs[i].L1Fee = L1Cost(gas, l1Basefee, overhead, scalar)</span>
<span class="term-fg32">+					rs[i].FeeScalar = feeScalar</span>
<span class="term-fg32">+				}</span>
<span class="term-fg32">+			}</span>
<span class="term-fg32">+		} else {</span>
<span class="term-fg32">+			return fmt.Errorf(&quot;L1 info tx only has %d bytes, cannot read gas price parameters&quot;, len(data))</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+</span>
 	return nil
 }</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-644e66015673a1f8550ad1c9" role="button"
                   aria-expanded="false" aria-controls="id-644e66015673a1f8550ad1c9">
                    <code>core/types/gen_receipt_json.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/3f40e65c484486dea6cff80b7db178985d21a2c6/core/types/gen_receipt_json.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/650bb2f2b1dcfe30d9b1fa6f7dc9608055ed60e1/core/types/gen_receipt_json.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+28</span></div>
                        <div class="text-start"><span class="text-danger">-0</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-644e66015673a1f8550ad1c9"><span class="term-fg1">diff --git go-ethereum&#47;core&#47;types&#47;gen_receipt_json.go op-geth&#47;core&#47;types&#47;gen_receipt_json.go</span>
<span class="term-fg1">index 4c641a972795f70ce27e98baf1b3c2e032fe89c2..e821a0885bd71cdf251b7d3e0be636a969e91628 100644</span>
<span class="term-fg1">--- go-ethereum&#47;core&#47;types&#47;gen_receipt_json.go</span>
<span class="term-fg1">+++ op-geth&#47;core&#47;types&#47;gen_receipt_json.go</span>
<span class="term-fg36">@@ -31,6 +31,10 @@</span> 		BlobGasPrice      *hexutil.Big   `json:&quot;blobGasPrice,omitempty&quot;`
 		BlockHash         common.Hash    `json:&quot;blockHash,omitempty&quot;`
 		BlockNumber       *hexutil.Big   `json:&quot;blockNumber,omitempty&quot;`
 		TransactionIndex  hexutil.Uint   `json:&quot;transactionIndex&quot;`
<span class="term-fg32">+		L1GasPrice        *hexutil.Big   `json:&quot;l1GasPrice,omitempty&quot;`</span>
<span class="term-fg32">+		L1GasUsed         *hexutil.Big   `json:&quot;l1GasUsed,omitempty&quot;`</span>
<span class="term-fg32">+		L1Fee             *hexutil.Big   `json:&quot;l1Fee,omitempty&quot;`</span>
<span class="term-fg32">+		FeeScalar         *big.Float     `json:&quot;l1FeeScalar,omitempty&quot;`</span>
 	}
 	var enc Receipt
 	enc.Type = hexutil.Uint64(r.Type)
<span class="term-fg36">@@ -48,6 +52,10 @@</span> 	enc.BlobGasPrice = (*hexutil.Big)(r.BlobGasPrice)
 	enc.BlockHash = r.BlockHash
 	enc.BlockNumber = (*hexutil.Big)(r.BlockNumber)
 	enc.TransactionIndex = hexutil.Uint(r.TransactionIndex)
<span class="term-fg32">+	enc.L1GasPrice = (*hexutil.Big)(r.L1GasPrice)</span>
<span class="term-fg32">+	enc.L1GasUsed = (*hexutil.Big)(r.L1GasUsed)</span>
<span class="term-fg32">+	enc.L1Fee = (*hexutil.Big)(r.L1Fee)</span>
<span class="term-fg32">+	enc.FeeScalar = r.FeeScalar</span>
 	return json.Marshal(&amp;enc)
 }
&nbsp;
<span class="term-fg36">@@ -69,6 +77,11 @@</span> 		BlobGasPrice      *hexutil.Big    `json:&quot;blobGasPrice,omitempty&quot;`
 		BlockHash         *common.Hash    `json:&quot;blockHash,omitempty&quot;`
 		BlockNumber       *hexutil.Big    `json:&quot;blockNumber,omitempty&quot;`
 		TransactionIndex  *hexutil.Uint   `json:&quot;transactionIndex&quot;`
<span class="term-fg32">+		L1GasPrice        *hexutil.Big    `json:&quot;l1GasPrice,omitempty&quot;`</span>
<span class="term-fg32">+		L1GasUsed         *hexutil.Big    `json:&quot;l1GasUsed,omitempty&quot;`</span>
<span class="term-fg32">+		L1Fee             *hexutil.Big    `json:&quot;l1Fee,omitempty&quot;`</span>
<span class="term-fg32">+		FeeScalar         *big.Float      `json:&quot;l1FeeScalar,omitempty&quot;`</span>
<span class="term-fg32">+		DepositNonce      *hexutil.Uint64 `json:&quot;depositNonce,omitempty&quot;`</span>
 	}
 	var dec Receipt
 	if err := json.Unmarshal(input, &amp;dec); err != nil {
<span class="term-fg36">@@ -123,6 +136,21 @@</span> 		r.BlockNumber = (*big.Int)(dec.BlockNumber)
 	}
 	if dec.TransactionIndex != nil {
 		r.TransactionIndex = uint(*dec.TransactionIndex)
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	if dec.L1GasPrice != nil {</span>
<span class="term-fg32">+		r.L1GasPrice = (*big.Int)(dec.L1GasPrice)</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	if dec.L1GasUsed != nil {</span>
<span class="term-fg32">+		r.L1GasUsed = (*big.Int)(dec.L1GasUsed)</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	if dec.L1Fee != nil {</span>
<span class="term-fg32">+		r.L1Fee = (*big.Int)(dec.L1Fee)</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	if dec.FeeScalar != nil {</span>
<span class="term-fg32">+		r.FeeScalar = dec.FeeScalar</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	if dec.DepositNonce != nil {</span>
<span class="term-fg32">+		r.DepositNonce = (*uint64)(dec.DepositNonce)</span>
 	}
 	return nil
 }</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-c6af173a46fed605271ca539" role="button"
                   aria-expanded="false" aria-controls="id-c6af173a46fed605271ca539">
                    <code>core/rawdb/accessors_chain.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/3f40e65c484486dea6cff80b7db178985d21a2c6/core/rawdb/accessors_chain.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/650bb2f2b1dcfe30d9b1fa6f7dc9608055ed60e1/core/rawdb/accessors_chain.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+9</span></div>
                        <div class="text-start"><span class="text-danger">-1</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-c6af173a46fed605271ca539"><span class="term-fg1">diff --git go-ethereum&#47;core&#47;rawdb&#47;accessors_chain.go op-geth&#47;core&#47;rawdb&#47;accessors_chain.go</span>
<span class="term-fg1">index 97401d283caa0d19b19e1cd59b583d76539dfed6..44a8392c57ba5e5f613b6637a963acac2c8bf476 100644</span>
<span class="term-fg1">--- go-ethereum&#47;core&#47;rawdb&#47;accessors_chain.go</span>
<span class="term-fg1">+++ op-geth&#47;core&#47;rawdb&#47;accessors_chain.go</span>
<span class="term-fg36">@@ -638,7 +638,6 @@</span> 		log.Error(&quot;Missing body but have receipt&quot;, &quot;hash&quot;, hash, &quot;number&quot;, number)
 		return nil
 	}
 	header := ReadHeader(db, hash, number)
<span class="term-fg31">-</span>
 	var baseFee *big.Int
 	if header == nil {
 		baseFee = big.NewInt(0)
<span class="term-fg36">@@ -688,6 +687,15 @@</span> type storedReceiptRLP struct {
 	PostStateOrStatus []byte
 	CumulativeGasUsed uint64
 	Logs              []*types.Log
<span class="term-fg32">+</span>
<span class="term-fg32">+	&#47;&#47; Remaining fields are declared to allow the receipt RLP to be parsed without errors.</span>
<span class="term-fg32">+	&#47;&#47; However, they must not be used as they may not be populated correctly due to multiple receipt formats</span>
<span class="term-fg32">+	&#47;&#47; being combined into a single list of optional fields which can be mistaken for each other.</span>
<span class="term-fg32">+	&#47;&#47; DepositNonce (*uint64) from Regolith deposit tx receipts will be parsed into L1GasUsed</span>
<span class="term-fg32">+	L1GasUsed  *big.Int `rlp:&quot;optional&quot;` &#47;&#47; OVM legacy</span>
<span class="term-fg32">+	L1GasPrice *big.Int `rlp:&quot;optional&quot;` &#47;&#47; OVM legacy</span>
<span class="term-fg32">+	L1Fee      *big.Int `rlp:&quot;optional&quot;` &#47;&#47; OVM legacy</span>
<span class="term-fg32">+	FeeScalar  string   `rlp:&quot;optional&quot;` &#47;&#47; OVM legacy</span>
 }
&nbsp;
 &#47;&#47; ReceiptLogs is a barebone version of ReceiptForStorage which only keeps</div>
    </div>

            
        </div>
        <div>
            
        </div>
    </div>
</div>

            
                <div class="ps-1 py-2 my-1"><div class="row border-bottom border-1"data-bs-toggle="collapse" data-bs-target="#id-0e1c700df54e453314e7ca58"role="button" aria-expanded="false" aria-controls="id-0e1c700df54e453314e7ca58">
        
            <div class="col-12 col-sm-9 text-start"><h3>API Backend</h3></div>
        
        <div class="col-12 col-sm-3 ms-auto mt-2">
            <div class="row line-stat">
                <div class="text-end"><span class="text-success">+139</span></div>
                <div class="text-start"><span class="text-danger">-16</span></div>
            </div>
        </div>
    </div>

    <div class="row forkdef-content collapse  border-1 ps-3 my-3" id="id-0e1c700df54e453314e7ca58">
        <div><p>Forward transactions to the sequencer if configured.</p>
</div>
        <div>
            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-5904efa7c4f537bfef84615f" role="button"
                   aria-expanded="false" aria-controls="id-5904efa7c4f537bfef84615f">
                    <code>eth/api_backend.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/3f40e65c484486dea6cff80b7db178985d21a2c6/eth/api_backend.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/650bb2f2b1dcfe30d9b1fa6f7dc9608055ed60e1/eth/api_backend.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+48</span></div>
                        <div class="text-start"><span class="text-danger">-9</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-5904efa7c4f537bfef84615f"><span class="term-fg1">diff --git go-ethereum&#47;eth&#47;api_backend.go op-geth&#47;eth&#47;api_backend.go</span>
<span class="term-fg1">index dea745382eacac6d6ef58694f7ef5e5ed9142e65..b109dd9a97c569be932b2454980a89b94e290ce1 100644</span>
<span class="term-fg1">--- go-ethereum&#47;eth&#47;api_backend.go</span>
<span class="term-fg1">+++ op-geth&#47;eth&#47;api_backend.go</span>
<span class="term-fg36">@@ -19,12 +19,14 @@</span>
 import (
 	&quot;context&quot;
 	&quot;errors&quot;
<span class="term-fg32">+	&quot;fmt&quot;</span>
 	&quot;math&#47;big&quot;
 	&quot;time&quot;
&nbsp;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;accounts&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;common&quot;
<span class="term-fg32">+	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;common&#47;hexutil&quot;</span>
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;consensus&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;core&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;core&#47;bloombits&quot;
<span class="term-fg36">@@ -37,6 +39,7 @@</span> 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;eth&#47;gasprice&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;eth&#47;tracers&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;ethdb&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;event&quot;
<span class="term-fg32">+	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;log&quot;</span>
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;miner&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;params&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;rpc&quot;
<span class="term-fg36">@@ -46,6 +49,7 @@</span> &#47;&#47; EthAPIBackend implements ethapi.Backend and tracers.Backend for full nodes
 type EthAPIBackend struct {
 	extRPCEnabled       bool
 	allowUnprotectedTxs bool
<span class="term-fg32">+	disableTxPool       bool</span>
 	eth                 *Ethereum
 	gpo                 *gasprice.Oracle
 }
<span class="term-fg36">@@ -190,10 +194,11 @@</span> func (b *EthAPIBackend) StateAndHeaderByNumber(ctx context.Context, number rpc.BlockNumber) (*state.StateDB, *types.Header, error) {
 	&#47;&#47; Pending state is only known by the miner
 	if number == rpc.PendingBlockNumber {
 		block, state := b.eth.miner.Pending()
<span class="term-fg31">-		if block == nil || state == nil {</span>
<span class="term-fg31">-			return nil, nil, errors.New(&quot;pending state is not available&quot;)</span>
<span class="term-fg32">+		if block != nil &amp;&amp; state != nil {</span>
<span class="term-fg32">+			return state, block.Header(), nil</span>
<span class="term-fg32">+		} else {</span>
<span class="term-fg32">+			number = rpc.LatestBlockNumber &#47;&#47; fall back to latest state</span>
 		}
<span class="term-fg31">-		return state, block.Header(), nil</span>
 	}
 	&#47;&#47; Otherwise resolve the block number and return its state
 	header, err := b.HeaderByNumber(ctx, number)
<span class="term-fg36">@@ -201,10 +206,13 @@</span> 	if err != nil {
 		return nil, nil, err
 	}
 	if header == nil {
<span class="term-fg31">-		return nil, nil, errors.New(&quot;header not found&quot;)</span>
<span class="term-fg32">+		return nil, nil, fmt.Errorf(&quot;header %w&quot;, ethereum.NotFound)</span>
 	}
 	stateDb, err := b.eth.BlockChain().StateAt(header.Root)
<span class="term-fg31">-	return stateDb, header, err</span>
<span class="term-fg32">+	if err != nil {</span>
<span class="term-fg32">+		return nil, nil, err</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	return stateDb, header, nil</span>
 }
&nbsp;
 func (b *EthAPIBackend) StateAndHeaderByNumberOrHash(ctx context.Context, blockNrOrHash rpc.BlockNumberOrHash) (*state.StateDB, *types.Header, error) {
<span class="term-fg36">@@ -217,13 +225,16 @@</span> 		if err != nil {
 			return nil, nil, err
 		}
 		if header == nil {
<span class="term-fg31">-			return nil, nil, errors.New(&quot;header for hash not found&quot;)</span>
<span class="term-fg32">+			return nil, nil, fmt.Errorf(&quot;header for hash %w&quot;, ethereum.NotFound)</span>
 		}
 		if blockNrOrHash.RequireCanonical &amp;&amp; b.eth.blockchain.GetCanonicalHash(header.Number.Uint64()) != hash {
 			return nil, nil, errors.New(&quot;hash is not currently canonical&quot;)
 		}
 		stateDb, err := b.eth.BlockChain().StateAt(header.Root)
<span class="term-fg31">-		return stateDb, header, err</span>
<span class="term-fg32">+		if err != nil {</span>
<span class="term-fg32">+			return nil, nil, err</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+		return stateDb, header, nil</span>
 	}
 	return nil, nil, errors.New(&quot;invalid arguments; neither block nor hash specified&quot;)
 }
<span class="term-fg36">@@ -252,7 +263,7 @@</span> 	var context vm.BlockContext
 	if blockCtx != nil {
 		context = *blockCtx
 	} else {
<span class="term-fg31">-		context = core.NewEVMBlockContext(header, b.eth.BlockChain(), nil)</span>
<span class="term-fg32">+		context = core.NewEVMBlockContext(header, b.eth.BlockChain(), nil, b.eth.blockchain.Config(), state)</span>
 	}
 	return vm.NewEVM(context, txContext, state, b.eth.blockchain.Config(), *vmConfig), state.Error
 }
<span class="term-fg36">@@ -282,6 +293,26 @@</span> 	return b.eth.BlockChain().SubscribeLogsEvent(ch)
 }
&nbsp;
 func (b *EthAPIBackend) SendTx(ctx context.Context, signedTx *types.Transaction) error {
<span class="term-fg32">+	if b.eth.seqRPCService != nil {</span>
<span class="term-fg32">+		data, err := signedTx.MarshalBinary()</span>
<span class="term-fg32">+		if err != nil {</span>
<span class="term-fg32">+			return err</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+		if err := b.eth.seqRPCService.CallContext(ctx, nil, &quot;eth_sendRawTransaction&quot;, hexutil.Encode(data)); err != nil {</span>
<span class="term-fg32">+			return err</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+		if b.disableTxPool {</span>
<span class="term-fg32">+			return nil</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+		&#47;&#47; Retain tx in local tx pool after forwarding, for local RPC usage.</span>
<span class="term-fg32">+		if err := b.eth.txPool.Add([]*types.Transaction{signedTx}, true, false)[0]; err != nil {</span>
<span class="term-fg32">+			log.Warn(&quot;successfully sent tx to sequencer, but failed to persist in local tx pool&quot;, &quot;err&quot;, err, &quot;tx&quot;, signedTx.Hash())</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+		return nil</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	if b.disableTxPool {</span>
<span class="term-fg32">+		return nil</span>
<span class="term-fg32">+	}</span>
 	return b.eth.txPool.Add([]*types.Transaction{signedTx}, true, false)[0]
 }
&nbsp;
<span class="term-fg36">@@ -328,7 +359,7 @@</span> 	return b.eth.txPool
 }
&nbsp;
 func (b *EthAPIBackend) SubscribeNewTxsEvent(ch chan&lt;- core.NewTxsEvent) event.Subscription {
<span class="term-fg31">-	return b.eth.txPool.SubscribeNewTxsEvent(ch)</span>
<span class="term-fg32">+	return b.eth.txPool.SubscribeTransactions(ch, true)</span>
 }
&nbsp;
 func (b *EthAPIBackend) SyncProgress() ethereum.SyncProgress {
<span class="term-fg36">@@ -409,3 +440,11 @@</span>
 func (b *EthAPIBackend) StateAtTransaction(ctx context.Context, block *types.Block, txIndex int, reexec uint64) (*core.Message, vm.BlockContext, *state.StateDB, tracers.StateReleaseFunc, error) {
 	return b.eth.stateAtTransaction(ctx, block, txIndex, reexec)
 }
<span class="term-fg32">+</span>
<span class="term-fg32">+func (b *EthAPIBackend) HistoricalRPCService() *rpc.Client {</span>
<span class="term-fg32">+	return b.eth.historicalRPCService</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func (b *EthAPIBackend) Genesis() *types.Block {</span>
<span class="term-fg32">+	return b.eth.blockchain.Genesis()</span>
<span class="term-fg32">+}</span></div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-7f9915af9cccc56f066c8e85" role="button"
                   aria-expanded="false" aria-controls="id-7f9915af9cccc56f066c8e85">
                    <code>eth/backend.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/3f40e65c484486dea6cff80b7db178985d21a2c6/eth/backend.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/650bb2f2b1dcfe30d9b1fa6f7dc9608055ed60e1/eth/backend.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+89</span></div>
                        <div class="text-start"><span class="text-danger">-7</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-7f9915af9cccc56f066c8e85"><span class="term-fg1">diff --git go-ethereum&#47;eth&#47;backend.go op-geth&#47;eth&#47;backend.go</span>
<span class="term-fg1">index 38c0fa97434401b456c81e938f3d3bc140a2df31..97224ecbfc7bb8d2dc7e74571b5d781ee9538a28 100644</span>
<span class="term-fg1">--- go-ethereum&#47;eth&#47;backend.go</span>
<span class="term-fg1">+++ op-geth&#47;eth&#47;backend.go</span>
<span class="term-fg36">@@ -18,11 +18,13 @@</span> &#47;&#47; Package eth implements the Ethereum protocol.
 package eth
&nbsp;
 import (
<span class="term-fg32">+	&quot;context&quot;</span>
 	&quot;errors&quot;
 	&quot;fmt&quot;
 	&quot;math&#47;big&quot;
 	&quot;runtime&quot;
 	&quot;sync&quot;
<span class="term-fg32">+	&quot;time&quot;</span>
&nbsp;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;accounts&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;common&quot;
<span class="term-fg36">@@ -76,6 +78,9 @@</span> 	ethDialCandidates  enode.Iterator
 	snapDialCandidates enode.Iterator
 	merger             *consensus.Merger
&nbsp;
<span class="term-fg32">+	seqRPCService        *rpc.Client</span>
<span class="term-fg32">+	historicalRPCService *rpc.Client</span>
<span class="term-fg32">+</span>
 	&#47;&#47; DB interfaces
 	chainDb ethdb.Database &#47;&#47; Block chain database
&nbsp;
<span class="term-fg36">@@ -101,6 +106,8 @@</span>
 	lock sync.RWMutex &#47;&#47; Protects the variadic fields (e.g. gas price and etherbase)
&nbsp;
 	shutdownTracker *shutdowncheck.ShutdownTracker &#47;&#47; Tracks if and when the node has shutdown ungracefully
<span class="term-fg32">+</span>
<span class="term-fg32">+	nodeCloser func() error</span>
 }
&nbsp;
 &#47;&#47; New creates a new Ethereum object (including the
<span class="term-fg36">@@ -133,8 +140,12 @@</span> 	chainDb, err := stack.OpenDatabaseWithFreezer(&quot;chaindata&quot;, config.DatabaseCache, config.DatabaseHandles, config.DatabaseFreezer, &quot;eth&#47;db&#47;chaindata&#47;&quot;, false)
 	if err != nil {
 		return nil, err
 	}
<span class="term-fg32">+	scheme, err := rawdb.ParseStateScheme(config.StateScheme, chainDb)</span>
<span class="term-fg32">+	if err != nil {</span>
<span class="term-fg32">+		return nil, err</span>
<span class="term-fg32">+	}</span>
 	&#47;&#47; Try to recover offline state pruning only in hash-based.
<span class="term-fg31">-	if config.StateScheme == rawdb.HashScheme {</span>
<span class="term-fg32">+	if scheme == rawdb.HashScheme {</span>
 		if err := pruner.RecoverPruning(stack.ResolvePath(&quot;&quot;), chainDb); err != nil {
 			log.Error(&quot;Failed to recover state&quot;, &quot;error&quot;, err)
 		}
<span class="term-fg36">@@ -163,13 +174,13 @@</span> 		bloomRequests:     make(chan chan *bloombits.Retrieval),
 		bloomIndexer:      core.NewBloomIndexer(chainDb, params.BloomBitsBlocks, params.BloomConfirms),
 		p2pServer:         stack.Server(),
 		shutdownTracker:   shutdowncheck.NewShutdownTracker(chainDb),
<span class="term-fg32">+		nodeCloser:        stack.Close,</span>
 	}
 	bcVersion := rawdb.ReadDatabaseVersion(chainDb)
 	var dbVer = &quot;&lt;nil&gt;&quot;
 	if bcVersion != nil {
 		dbVer = fmt.Sprintf(&quot;%d&quot;, *bcVersion)
 	}
<span class="term-fg31">-	log.Info(&quot;Initialising Ethereum protocol&quot;, &quot;network&quot;, config.NetworkId, &quot;dbversion&quot;, dbVer)</span>
&nbsp;
 	if !config.SkipBcVersionCheck {
 		if bcVersion != nil &amp;&amp; *bcVersion &gt; core.BlockChainVersion {
<span class="term-fg36">@@ -194,7 +205,7 @@</span> 			TrieTimeLimit:       config.TrieTimeout,
 			SnapshotLimit:       config.SnapshotCache,
 			Preimages:           config.Preimages,
 			StateHistory:        config.StateHistory,
<span class="term-fg31">-			StateScheme:         config.StateScheme,</span>
<span class="term-fg32">+			StateScheme:         scheme,</span>
 		}
 	)
 	&#47;&#47; Override the chain config with provided settings.
<span class="term-fg36">@@ -205,10 +216,24 @@</span> 	}
 	if config.OverrideVerkle != nil {
 		overrides.OverrideVerkle = config.OverrideVerkle
 	}
<span class="term-fg32">+	if config.OverrideOptimismCanyon != nil {</span>
<span class="term-fg32">+		overrides.OverrideOptimismCanyon = config.OverrideOptimismCanyon</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	overrides.ApplySuperchainUpgrades = config.ApplySuperchainUpgrades</span>
 	eth.blockchain, err = core.NewBlockChain(chainDb, cacheConfig, config.Genesis, &amp;overrides, eth.engine, vmConfig, eth.shouldPreserve, &amp;config.TransactionHistory)
 	if err != nil {
 		return nil, err
 	}
<span class="term-fg32">+	if chainConfig := eth.blockchain.Config(); chainConfig.Optimism != nil { &#47;&#47; config.Genesis.Config.ChainID cannot be used because it&#39;s based on CLI flags only, thus default to mainnet L1</span>
<span class="term-fg32">+		config.NetworkId = chainConfig.ChainID.Uint64() &#47;&#47; optimism defaults eth network ID to chain ID</span>
<span class="term-fg32">+		eth.networkID = config.NetworkId</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	log.Info(&quot;Initialising Ethereum protocol&quot;, &quot;network&quot;, config.NetworkId, &quot;dbversion&quot;, dbVer)</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	if eth.blockchain.Config().Optimism != nil { &#47;&#47; Optimism Bedrock depends on Merge functionality</span>
<span class="term-fg32">+		eth.merger.FinalizePoS()</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+</span>
 	eth.bloomIndexer.Start(eth.blockchain)
&nbsp;
 	if config.BlobPool.Datadir != &quot;&quot; {
<span class="term-fg36">@@ -237,6 +262,7 @@</span> 		Sync:           config.SyncMode,
 		BloomCache:     uint64(cacheLimit),
 		EventMux:       eth.eventMux,
 		RequiredBlocks: config.RequiredBlocks,
<span class="term-fg32">+		NoTxGossip:     config.RollupDisableTxPoolGossip,</span>
 	}); err != nil {
 		return nil, err
 	}
<span class="term-fg36">@@ -244,7 +270,7 @@</span>
 	eth.miner = miner.New(eth, &amp;config.Miner, eth.blockchain.Config(), eth.EventMux(), eth.engine, eth.isLocalBlock)
 	eth.miner.SetExtra(makeExtraData(config.Miner.ExtraData))
&nbsp;
<span class="term-fg31">-	eth.APIBackend = &amp;EthAPIBackend{stack.Config().ExtRPCEnabled(), stack.Config().AllowUnprotectedTxs, eth, nil}</span>
<span class="term-fg32">+	eth.APIBackend = &amp;EthAPIBackend{stack.Config().ExtRPCEnabled(), stack.Config().AllowUnprotectedTxs, config.RollupDisableTxPoolAdmission, eth, nil}</span>
 	if eth.APIBackend.allowUnprotectedTxs {
 		log.Info(&quot;Unprotected transactions allowed&quot;)
 	}
<span class="term-fg36">@@ -265,6 +291,26 @@</span> 	if err != nil {
 		return nil, err
 	}
&nbsp;
<span class="term-fg32">+	if config.RollupSequencerHTTP != &quot;&quot; {</span>
<span class="term-fg32">+		ctx, cancel := context.WithTimeout(context.Background(), 5*time.Second)</span>
<span class="term-fg32">+		client, err := rpc.DialContext(ctx, config.RollupSequencerHTTP)</span>
<span class="term-fg32">+		cancel()</span>
<span class="term-fg32">+		if err != nil {</span>
<span class="term-fg32">+			return nil, err</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+		eth.seqRPCService = client</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	if config.RollupHistoricalRPC != &quot;&quot; {</span>
<span class="term-fg32">+		ctx, cancel := context.WithTimeout(context.Background(), config.RollupHistoricalRPCTimeout)</span>
<span class="term-fg32">+		client, err := rpc.DialContext(ctx, config.RollupHistoricalRPC)</span>
<span class="term-fg32">+		cancel()</span>
<span class="term-fg32">+		if err != nil {</span>
<span class="term-fg32">+			return nil, err</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+		eth.historicalRPCService = client</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+</span>
 	&#47;&#47; Start the RPC service
 	eth.netRPCService = ethapi.NewNetAPI(eth.p2pServer, config.NetworkId)
&nbsp;
<span class="term-fg36">@@ -283,7 +329,7 @@</span> func makeExtraData(extra []byte) []byte {
 	if len(extra) == 0 {
 		&#47;&#47; create default extradata
 		extra, _ = rlp.EncodeToBytes([]interface{}{
<span class="term-fg31">-			uint(params.VersionMajor&lt;&lt;16 | params.VersionMinor&lt;&lt;8 | params.VersionPatch),</span>
<span class="term-fg32">+			uint(params.OPVersionMajor&lt;&lt;16 | params.OPVersionMinor&lt;&lt;8 | params.OPVersionPatch),</span>
 			&quot;geth&quot;,
 			runtime.Version(),
 			runtime.GOOS,
<span class="term-fg36">@@ -387,7 +433,7 @@</span> 	&#47;&#47; r4         D
 	&#47;&#47; r5   A      [X] F G
 	&#47;&#47; r6    [X]
 	&#47;&#47;
<span class="term-fg31">-	&#47;&#47; In the round5, the inturn signer E is offline, so the worst case</span>
<span class="term-fg32">+	&#47;&#47; In the round5, the in-turn signer E is offline, so the worst case</span>
 	&#47;&#47; is A, F and G sign the block of round5 and reject the block of opponents
 	&#47;&#47; and in the round6, the last available signer B is offline, the whole
 	&#47;&#47; network is stuck.
<span class="term-fg36">@@ -474,7 +520,7 @@</span> func (s *Ethereum) Engine() consensus.Engine           { return s.engine }
 func (s *Ethereum) ChainDb() ethdb.Database            { return s.chainDb }
 func (s *Ethereum) IsListening() bool                  { return true } &#47;&#47; Always listening
 func (s *Ethereum) Downloader() *downloader.Downloader { return s.handler.downloader }
<span class="term-fg31">-func (s *Ethereum) Synced() bool                       { return s.handler.acceptTxs.Load() }</span>
<span class="term-fg32">+func (s *Ethereum) Synced() bool                       { return s.handler.synced.Load() }</span>
 func (s *Ethereum) SetSynced()                         { s.handler.enableSyncedFeatures() }
 func (s *Ethereum) ArchiveMode() bool                  { return s.config.NoPruning }
 func (s *Ethereum) BloomIndexer() *core.ChainIndexer   { return s.bloomIndexer }
<span class="term-fg36">@@ -533,6 +579,12 @@</span> 	s.txPool.Close()
 	s.miner.Close()
 	s.blockchain.Stop()
 	s.engine.Close()
<span class="term-fg32">+	if s.seqRPCService != nil {</span>
<span class="term-fg32">+		s.seqRPCService.Close()</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	if s.historicalRPCService != nil {</span>
<span class="term-fg32">+		s.historicalRPCService.Close()</span>
<span class="term-fg32">+	}</span>
&nbsp;
 	&#47;&#47; Clean shutdown marker as the last thing before closing db
 	s.shutdownTracker.Stop()
<span class="term-fg36">@@ -542,3 +594,33 @@</span> 	s.eventMux.Stop()
&nbsp;
 	return nil
 }
<span class="term-fg32">+</span>
<span class="term-fg32">+&#47;&#47; HandleRequiredProtocolVersion handles the protocol version signal. This implements opt-in halting,</span>
<span class="term-fg32">+&#47;&#47; the protocol version data is already logged and metered when signaled through the Engine API.</span>
<span class="term-fg32">+func (s *Ethereum) HandleRequiredProtocolVersion(required params.ProtocolVersion) error {</span>
<span class="term-fg32">+	var needLevel int</span>
<span class="term-fg32">+	switch s.config.RollupHaltOnIncompatibleProtocolVersion {</span>
<span class="term-fg32">+	case &quot;major&quot;:</span>
<span class="term-fg32">+		needLevel = 3</span>
<span class="term-fg32">+	case &quot;minor&quot;:</span>
<span class="term-fg32">+		needLevel = 2</span>
<span class="term-fg32">+	case &quot;patch&quot;:</span>
<span class="term-fg32">+		needLevel = 1</span>
<span class="term-fg32">+	default:</span>
<span class="term-fg32">+		return nil &#47;&#47; do not consider halting if not configured to</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	haveLevel := 0</span>
<span class="term-fg32">+	switch params.OPStackSupport.Compare(required) {</span>
<span class="term-fg32">+	case params.OutdatedMajor:</span>
<span class="term-fg32">+		haveLevel = 3</span>
<span class="term-fg32">+	case params.OutdatedMinor:</span>
<span class="term-fg32">+		haveLevel = 2</span>
<span class="term-fg32">+	case params.OutdatedPatch:</span>
<span class="term-fg32">+		haveLevel = 1</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	if haveLevel &gt;= needLevel { &#47;&#47; halt if we opted in to do so at this granularity</span>
<span class="term-fg32">+		log.Error(&quot;Opted to halt, unprepared for protocol change&quot;, &quot;required&quot;, required, &quot;local&quot;, params.OPStackSupport)</span>
<span class="term-fg32">+		return s.nodeCloser()</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	return nil</span>
<span class="term-fg32">+}</span></div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-6ce4701c2772824cff1af576" role="button"
                   aria-expanded="false" aria-controls="id-6ce4701c2772824cff1af576">
                    <code>internal/ethapi/backend.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/3f40e65c484486dea6cff80b7db178985d21a2c6/internal/ethapi/backend.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/650bb2f2b1dcfe30d9b1fa6f7dc9608055ed60e1/internal/ethapi/backend.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+2</span></div>
                        <div class="text-start"><span class="text-danger">-0</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-6ce4701c2772824cff1af576"><span class="term-fg1">diff --git go-ethereum&#47;internal&#47;ethapi&#47;backend.go op-geth&#47;internal&#47;ethapi&#47;backend.go</span>
<span class="term-fg1">index 458fb811edaeee090af64d1e64494190139a3257..a3ce3c9c1dea0e050934910a0f4c99af6dc05ddc 100644</span>
<span class="term-fg1">--- go-ethereum&#47;internal&#47;ethapi&#47;backend.go</span>
<span class="term-fg1">+++ op-geth&#47;internal&#47;ethapi&#47;backend.go</span>
<span class="term-fg36">@@ -86,6 +86,8 @@</span> 	SubscribeNewTxsEvent(chan&lt;- core.NewTxsEvent) event.Subscription
&nbsp;
 	ChainConfig() *params.ChainConfig
 	Engine() consensus.Engine
<span class="term-fg32">+	HistoricalRPCService() *rpc.Client</span>
<span class="term-fg32">+	Genesis() *types.Block</span>
&nbsp;
 	&#47;&#47; This is copied from filters.Backend
 	&#47;&#47; eth&#47;filters needs to be initialized from this backend type, so methods needed by</div>
    </div>

            
        </div>
        <div>
            
        </div>
    </div>
</div>

            
                <div class="ps-1 py-2 my-1"><div class="row border-bottom border-1"data-bs-toggle="collapse" data-bs-target="#id-72c996734b2adbd90d9ea97c"role="button" aria-expanded="false" aria-controls="id-72c996734b2adbd90d9ea97c">
        
            <div class="col-12 col-sm-9 text-start"><h3>Apply L1 cost in API responses</h3></div>
        
        <div class="col-12 col-sm-3 ms-auto mt-2">
            <div class="row line-stat">
                <div class="text-end"><span class="text-success">+1</span></div>
                <div class="text-start"><span class="text-danger">-1</span></div>
            </div>
        </div>
    </div>

    <div class="row forkdef-content collapse  border-1 ps-3 my-3" id="id-72c996734b2adbd90d9ea97c">
        <div></div>
        <div>
            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-c57d0b6d06c171f68a9423e4" role="button"
                   aria-expanded="false" aria-controls="id-c57d0b6d06c171f68a9423e4">
                    <code>eth/state_accessor.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/3f40e65c484486dea6cff80b7db178985d21a2c6/eth/state_accessor.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/650bb2f2b1dcfe30d9b1fa6f7dc9608055ed60e1/eth/state_accessor.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+1</span></div>
                        <div class="text-start"><span class="text-danger">-1</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-c57d0b6d06c171f68a9423e4"><span class="term-fg1">diff --git go-ethereum&#47;eth&#47;state_accessor.go op-geth&#47;eth&#47;state_accessor.go</span>
<span class="term-fg1">index 24694df66c36cd814d2d631368bf29d75cf6d9f6..19128d12b19a038f0a70d58564e179b06970f281 100644</span>
<span class="term-fg1">--- go-ethereum&#47;eth&#47;state_accessor.go</span>
<span class="term-fg1">+++ op-geth&#47;eth&#47;state_accessor.go</span>
<span class="term-fg36">@@ -241,7 +241,7 @@</span> 	for idx, tx := range block.Transactions() {
 		&#47;&#47; Assemble the transaction call message and return if the requested offset
 		msg, _ := core.TransactionToMessage(tx, signer, block.BaseFee())
 		txContext := core.NewEVMTxContext(msg)
<span class="term-fg31">-		context := core.NewEVMBlockContext(block.Header(), eth.blockchain, nil)</span>
<span class="term-fg32">+		context := core.NewEVMBlockContext(block.Header(), eth.blockchain, nil, eth.blockchain.Config(), statedb)</span>
 		if idx == txIndex {
 			return msg, context, statedb, release, nil
 		}</div>
    </div>

            
        </div>
        <div>
            
        </div>
    </div>
</div>

            
                <div class="ps-1 py-2 my-1"><div class="row border-bottom border-1"data-bs-toggle="collapse" data-bs-target="#id-3a0170fd4d0fb61bd87b3ffc"role="button" aria-expanded="false" aria-controls="id-3a0170fd4d0fb61bd87b3ffc">
        
            <div class="col-12 col-sm-9 text-start"><h3>API frontend</h3></div>
        
        <div class="col-12 col-sm-3 ms-auto mt-2">
            <div class="row line-stat">
                <div class="text-end"><span class="text-success">+278</span></div>
                <div class="text-start"><span class="text-danger">-35</span></div>
            </div>
        </div>
    </div>

    <div class="row forkdef-content collapse  border-1 ps-3 my-3" id="id-3a0170fd4d0fb61bd87b3ffc">
        <div><p>Format deposit and L1-cost data in transaction responses. Add <code>debug_chainConfig</code> API.</p>
</div>
        <div>
            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-82d336920c77eaff54a8d2f4" role="button"
                   aria-expanded="false" aria-controls="id-82d336920c77eaff54a8d2f4">
                    <code>internal/ethapi/api.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/3f40e65c484486dea6cff80b7db178985d21a2c6/internal/ethapi/api.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/650bb2f2b1dcfe30d9b1fa6f7dc9608055ed60e1/internal/ethapi/api.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+268</span></div>
                        <div class="text-start"><span class="text-danger">-35</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-82d336920c77eaff54a8d2f4"><span class="term-fg1">diff --git go-ethereum&#47;internal&#47;ethapi&#47;api.go op-geth&#47;internal&#47;ethapi&#47;api.go</span>
<span class="term-fg1">index 733e671e0abdced0e9236e0cd86ccdf4b2141535..14734ee67ad90728009d61fc06b3ebf6e1965598 100644</span>
<span class="term-fg1">--- go-ethereum&#47;internal&#47;ethapi&#47;api.go</span>
<span class="term-fg1">+++ op-geth&#47;internal&#47;ethapi&#47;api.go</span>
<span class="term-fg36">@@ -26,6 +26,9 @@</span> 	&quot;strings&quot;
 	&quot;time&quot;
&nbsp;
 	&quot;github.com&#47;davecgh&#47;go-spew&#47;spew&quot;
<span class="term-fg32">+	&quot;github.com&#47;tyler-smith&#47;go-bip39&quot;</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	&quot;github.com&#47;ethereum&#47;go-ethereum&quot;</span>
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;accounts&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;accounts&#47;abi&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;accounts&#47;keystore&quot;
<span class="term-fg36">@@ -47,7 +50,6 @@</span> 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;params&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;rlp&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;rpc&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;trie&quot;
<span class="term-fg31">-	&quot;github.com&#47;tyler-smith&#47;go-bip39&quot;</span>
 )
&nbsp;
 &#47;&#47; EthereumAPI provides an API to access Ethereum related information.
<span class="term-fg36">@@ -632,6 +634,24 @@</span> &#47;&#47; GetBalance returns the amount of wei for the given address in the state of the
 &#47;&#47; given block number. The rpc.LatestBlockNumber and rpc.PendingBlockNumber meta
 &#47;&#47; block numbers are also allowed.
 func (s *BlockChainAPI) GetBalance(ctx context.Context, address common.Address, blockNrOrHash rpc.BlockNumberOrHash) (*hexutil.Big, error) {
<span class="term-fg32">+	header, err := headerByNumberOrHash(ctx, s.b, blockNrOrHash)</span>
<span class="term-fg32">+	if err != nil {</span>
<span class="term-fg32">+		return nil, err</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	if s.b.ChainConfig().IsOptimismPreBedrock(header.Number) {</span>
<span class="term-fg32">+		if s.b.HistoricalRPCService() != nil {</span>
<span class="term-fg32">+			var res hexutil.Big</span>
<span class="term-fg32">+			err := s.b.HistoricalRPCService().CallContext(ctx, &amp;res, &quot;eth_getBalance&quot;, address, blockNrOrHash)</span>
<span class="term-fg32">+			if err != nil {</span>
<span class="term-fg32">+				return nil, fmt.Errorf(&quot;historical backend error: %w&quot;, err)</span>
<span class="term-fg32">+			}</span>
<span class="term-fg32">+			return &amp;res, nil</span>
<span class="term-fg32">+		} else {</span>
<span class="term-fg32">+			return nil, rpc.ErrNoHistoricalFallback</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+</span>
 	state, _, err := s.b.StateAndHeaderByNumberOrHash(ctx, blockNrOrHash)
 	if state == nil || err != nil {
 		return nil, err
<span class="term-fg36">@@ -671,6 +691,22 @@</span> }
&nbsp;
 &#47;&#47; GetProof returns the Merkle-proof for a given account and optionally some storage keys.
 func (s *BlockChainAPI) GetProof(ctx context.Context, address common.Address, storageKeys []string, blockNrOrHash rpc.BlockNumberOrHash) (*AccountResult, error) {
<span class="term-fg32">+	header, err := headerByNumberOrHash(ctx, s.b, blockNrOrHash)</span>
<span class="term-fg32">+	if err != nil {</span>
<span class="term-fg32">+		return nil, err</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	if s.b.ChainConfig().IsOptimismPreBedrock(header.Number) {</span>
<span class="term-fg32">+		if s.b.HistoricalRPCService() != nil {</span>
<span class="term-fg32">+			var res AccountResult</span>
<span class="term-fg32">+			err := s.b.HistoricalRPCService().CallContext(ctx, &amp;res, &quot;eth_getProof&quot;, address, storageKeys, blockNrOrHash)</span>
<span class="term-fg32">+			if err != nil {</span>
<span class="term-fg32">+				return nil, fmt.Errorf(&quot;historical backend error: %w&quot;, err)</span>
<span class="term-fg32">+			}</span>
<span class="term-fg32">+			return &amp;res, nil</span>
<span class="term-fg32">+		} else {</span>
<span class="term-fg32">+			return nil, rpc.ErrNoHistoricalFallback</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+	}</span>
 	var (
 		keys         = make([]common.Hash, len(storageKeys))
 		keyLengths   = make([]int, len(storageKeys))
<span class="term-fg36">@@ -779,7 +815,7 @@</span> func (s *BlockChainAPI) GetHeaderByNumber(ctx context.Context, number rpc.BlockNumber) (map[string]interface{}, error) {
 	header, err := s.b.HeaderByNumber(ctx, number)
 	if header != nil &amp;&amp; err == nil {
 		response := s.rpcMarshalHeader(ctx, header)
<span class="term-fg31">-		if number == rpc.PendingBlockNumber {</span>
<span class="term-fg32">+		if number == rpc.PendingBlockNumber &amp;&amp; s.b.ChainConfig().Optimism == nil { &#47;&#47; don&#39;t remove info if optimism</span>
 			&#47;&#47; Pending header need to nil out a few fields
 			for _, field := range []string{&quot;hash&quot;, &quot;nonce&quot;, &quot;miner&quot;} {
 				response[field] = nil
<span class="term-fg36">@@ -810,7 +846,7 @@</span> func (s *BlockChainAPI) GetBlockByNumber(ctx context.Context, number rpc.BlockNumber, fullTx bool) (map[string]interface{}, error) {
 	block, err := s.b.BlockByNumber(ctx, number)
 	if block != nil &amp;&amp; err == nil {
 		response, err := s.rpcMarshalBlock(ctx, block, true, fullTx)
<span class="term-fg31">-		if err == nil &amp;&amp; number == rpc.PendingBlockNumber {</span>
<span class="term-fg32">+		if err == nil &amp;&amp; number == rpc.PendingBlockNumber &amp;&amp; s.b.ChainConfig().Optimism == nil { &#47;&#47; don&#39;t remove info if optimism</span>
 			&#47;&#47; Pending blocks need to nil out a few fields
 			for _, field := range []string{&quot;hash&quot;, &quot;nonce&quot;, &quot;miner&quot;} {
 				response[field] = nil
<span class="term-fg36">@@ -881,10 +917,29 @@</span> }
&nbsp;
 &#47;&#47; GetCode returns the code stored at the given address in the state for the given block number.
 func (s *BlockChainAPI) GetCode(ctx context.Context, address common.Address, blockNrOrHash rpc.BlockNumberOrHash) (hexutil.Bytes, error) {
<span class="term-fg32">+	header, err := headerByNumberOrHash(ctx, s.b, blockNrOrHash)</span>
<span class="term-fg32">+	if err != nil {</span>
<span class="term-fg32">+		return nil, err</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	if s.b.ChainConfig().IsOptimismPreBedrock(header.Number) {</span>
<span class="term-fg32">+		if s.b.HistoricalRPCService() != nil {</span>
<span class="term-fg32">+			var res hexutil.Bytes</span>
<span class="term-fg32">+			err := s.b.HistoricalRPCService().CallContext(ctx, &amp;res, &quot;eth_getCode&quot;, address, blockNrOrHash)</span>
<span class="term-fg32">+			if err != nil {</span>
<span class="term-fg32">+				return nil, fmt.Errorf(&quot;historical backend error: %w&quot;, err)</span>
<span class="term-fg32">+			}</span>
<span class="term-fg32">+			return res, nil</span>
<span class="term-fg32">+		} else {</span>
<span class="term-fg32">+			return nil, rpc.ErrNoHistoricalFallback</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+</span>
 	state, _, err := s.b.StateAndHeaderByNumberOrHash(ctx, blockNrOrHash)
 	if state == nil || err != nil {
 		return nil, err
 	}
<span class="term-fg32">+</span>
 	code := state.GetCode(address)
 	return code, state.Error()
 }
<span class="term-fg36">@@ -893,10 +948,29 @@</span> &#47;&#47; GetStorageAt returns the storage from the state at the given address, key and
 &#47;&#47; block number. The rpc.LatestBlockNumber and rpc.PendingBlockNumber meta block
 &#47;&#47; numbers are also allowed.
 func (s *BlockChainAPI) GetStorageAt(ctx context.Context, address common.Address, hexKey string, blockNrOrHash rpc.BlockNumberOrHash) (hexutil.Bytes, error) {
<span class="term-fg32">+	header, err := headerByNumberOrHash(ctx, s.b, blockNrOrHash)</span>
<span class="term-fg32">+	if err != nil {</span>
<span class="term-fg32">+		return nil, err</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	if s.b.ChainConfig().IsOptimismPreBedrock(header.Number) {</span>
<span class="term-fg32">+		if s.b.HistoricalRPCService() != nil {</span>
<span class="term-fg32">+			var res hexutil.Bytes</span>
<span class="term-fg32">+			err := s.b.HistoricalRPCService().CallContext(ctx, &amp;res, &quot;eth_getStorageAt&quot;, address, hexKey, blockNrOrHash)</span>
<span class="term-fg32">+			if err != nil {</span>
<span class="term-fg32">+				return nil, fmt.Errorf(&quot;historical backend error: %w&quot;, err)</span>
<span class="term-fg32">+			}</span>
<span class="term-fg32">+			return res, nil</span>
<span class="term-fg32">+		} else {</span>
<span class="term-fg32">+			return nil, rpc.ErrNoHistoricalFallback</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+</span>
 	state, _, err := s.b.StateAndHeaderByNumberOrHash(ctx, blockNrOrHash)
 	if state == nil || err != nil {
 		return nil, err
 	}
<span class="term-fg32">+</span>
 	key, _, err := decodeHash(hexKey)
 	if err != nil {
 		return nil, fmt.Errorf(&quot;unable to decode storage key: %s&quot;, err)
<span class="term-fg36">@@ -905,6 +979,18 @@</span> 	res := state.GetState(address, key)
 	return res[:], state.Error()
 }
&nbsp;
<span class="term-fg32">+&#47;&#47; The HeaderByNumberOrHash method returns a nil error and nil header</span>
<span class="term-fg32">+&#47;&#47; if the header is not found, but only for nonexistent block numbers. This is</span>
<span class="term-fg32">+&#47;&#47; different from StateAndHeaderByNumberOrHash. To account for this discrepancy,</span>
<span class="term-fg32">+&#47;&#47; headerOrNumberByHash will properly convert the error into an ethereum.NotFound.</span>
<span class="term-fg32">+func headerByNumberOrHash(ctx context.Context, b Backend, blockNrOrHash rpc.BlockNumberOrHash) (*types.Header, error) {</span>
<span class="term-fg32">+	header, err := b.HeaderByNumberOrHash(ctx, blockNrOrHash)</span>
<span class="term-fg32">+	if header == nil {</span>
<span class="term-fg32">+		return nil, fmt.Errorf(&quot;header %w&quot;, ethereum.NotFound)</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	return header, err</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
 &#47;&#47; GetBlockReceipts returns the block receipts for the given block hash or number or tag.
 func (s *BlockChainAPI) GetBlockReceipts(ctx context.Context, blockNrOrHash rpc.BlockNumberOrHash) ([]map[string]interface{}, error) {
 	block, err := s.b.BlockByNumberOrHash(ctx, blockNrOrHash)
<span class="term-fg36">@@ -927,7 +1013,7 @@</span> 	signer := types.MakeSigner(s.b.ChainConfig(), block.Number(), block.Time())
&nbsp;
 	result := make([]map[string]interface{}, len(receipts))
 	for i, receipt := range receipts {
<span class="term-fg31">-		result[i] = marshalReceipt(receipt, block.Hash(), block.NumberU64(), signer, txs[i], i)</span>
<span class="term-fg32">+		result[i] = marshalReceipt(receipt, block.Hash(), block.NumberU64(), signer, txs[i], i, s.b.ChainConfig())</span>
 	}
&nbsp;
 	return result, nil
<span class="term-fg36">@@ -991,13 +1077,14 @@</span> }
&nbsp;
 &#47;&#47; BlockOverrides is a set of header fields to override.
 type BlockOverrides struct {
<span class="term-fg31">-	Number     *hexutil.Big</span>
<span class="term-fg31">-	Difficulty *hexutil.Big</span>
<span class="term-fg31">-	Time       *hexutil.Uint64</span>
<span class="term-fg31">-	GasLimit   *hexutil.Uint64</span>
<span class="term-fg31">-	Coinbase   *common.Address</span>
<span class="term-fg31">-	Random     *common.Hash</span>
<span class="term-fg31">-	BaseFee    *hexutil.Big</span>
<span class="term-fg32">+	Number      *hexutil.Big</span>
<span class="term-fg32">+	Difficulty  *hexutil.Big</span>
<span class="term-fg32">+	Time        *hexutil.Uint64</span>
<span class="term-fg32">+	GasLimit    *hexutil.Uint64</span>
<span class="term-fg32">+	Coinbase    *common.Address</span>
<span class="term-fg32">+	Random      *common.Hash</span>
<span class="term-fg32">+	BaseFee     *hexutil.Big</span>
<span class="term-fg32">+	BlobBaseFee *hexutil.Big</span>
 }
&nbsp;
 &#47;&#47; Apply overrides the given header fields into the given block context.
<span class="term-fg36">@@ -1025,6 +1112,9 @@</span> 		blockCtx.Random = diff.Random
 	}
 	if diff.BaseFee != nil {
 		blockCtx.BaseFee = diff.BaseFee.ToInt()
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	if diff.BlobBaseFee != nil {</span>
<span class="term-fg32">+		blockCtx.BlobBaseFee = diff.BlobBaseFee.ToInt()</span>
 	}
 }
&nbsp;
<span class="term-fg36">@@ -1081,7 +1171,7 @@</span> 	msg, err := args.ToMessage(globalGasCap, header.BaseFee)
 	if err != nil {
 		return nil, err
 	}
<span class="term-fg31">-	blockCtx := core.NewEVMBlockContext(header, NewChainContext(ctx, b), nil)</span>
<span class="term-fg32">+	blockCtx := core.NewEVMBlockContext(header, NewChainContext(ctx, b), nil, b.ChainConfig(), state)</span>
 	if blockOverrides != nil {
 		blockOverrides.Apply(&amp;blockCtx)
 	}
<span class="term-fg36">@@ -1158,8 +1248,31 @@</span> &#47;&#47; Additionally, the caller can specify a batch of contract for fields overriding.
 &#47;&#47;
 &#47;&#47; Note, this function doesn&#39;t make and changes in the state&#47;blockchain and is
 &#47;&#47; useful to execute and retrieve values.
<span class="term-fg31">-func (s *BlockChainAPI) Call(ctx context.Context, args TransactionArgs, blockNrOrHash rpc.BlockNumberOrHash, overrides *StateOverride, blockOverrides *BlockOverrides) (hexutil.Bytes, error) {</span>
<span class="term-fg31">-	result, err := DoCall(ctx, s.b, args, blockNrOrHash, overrides, blockOverrides, s.b.RPCEVMTimeout(), s.b.RPCGasCap())</span>
<span class="term-fg32">+func (s *BlockChainAPI) Call(ctx context.Context, args TransactionArgs, blockNrOrHash *rpc.BlockNumberOrHash, overrides *StateOverride, blockOverrides *BlockOverrides) (hexutil.Bytes, error) {</span>
<span class="term-fg32">+	if blockNrOrHash == nil {</span>
<span class="term-fg32">+		latest := rpc.BlockNumberOrHashWithNumber(rpc.LatestBlockNumber)</span>
<span class="term-fg32">+		blockNrOrHash = &amp;latest</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	header, err := headerByNumberOrHash(ctx, s.b, *blockNrOrHash)</span>
<span class="term-fg32">+	if err != nil {</span>
<span class="term-fg32">+		return nil, err</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	if s.b.ChainConfig().IsOptimismPreBedrock(header.Number) {</span>
<span class="term-fg32">+		if s.b.HistoricalRPCService() != nil {</span>
<span class="term-fg32">+			var res hexutil.Bytes</span>
<span class="term-fg32">+			err := s.b.HistoricalRPCService().CallContext(ctx, &amp;res, &quot;eth_call&quot;, args, blockNrOrHash, overrides)</span>
<span class="term-fg32">+			if err != nil {</span>
<span class="term-fg32">+				return nil, fmt.Errorf(&quot;historical backend error: %w&quot;, err)</span>
<span class="term-fg32">+			}</span>
<span class="term-fg32">+			return res, nil</span>
<span class="term-fg32">+		} else {</span>
<span class="term-fg32">+			return nil, rpc.ErrNoHistoricalFallback</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	result, err := DoCall(ctx, s.b, args, *blockNrOrHash, overrides, blockOverrides, s.b.RPCEVMTimeout(), s.b.RPCGasCap())</span>
 	if err != nil {
 		return nil, err
 	}
<span class="term-fg36">@@ -1318,6 +1431,25 @@</span> 	bNrOrHash := rpc.BlockNumberOrHashWithNumber(rpc.LatestBlockNumber)
 	if blockNrOrHash != nil {
 		bNrOrHash = *blockNrOrHash
 	}
<span class="term-fg32">+</span>
<span class="term-fg32">+	header, err := headerByNumberOrHash(ctx, s.b, bNrOrHash)</span>
<span class="term-fg32">+	if err != nil {</span>
<span class="term-fg32">+		return 0, err</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	if s.b.ChainConfig().IsOptimismPreBedrock(header.Number) {</span>
<span class="term-fg32">+		if s.b.HistoricalRPCService() != nil {</span>
<span class="term-fg32">+			var res hexutil.Uint64</span>
<span class="term-fg32">+			err := s.b.HistoricalRPCService().CallContext(ctx, &amp;res, &quot;eth_estimateGas&quot;, args, blockNrOrHash)</span>
<span class="term-fg32">+			if err != nil {</span>
<span class="term-fg32">+				return 0, fmt.Errorf(&quot;historical backend error: %w&quot;, err)</span>
<span class="term-fg32">+			}</span>
<span class="term-fg32">+			return res, nil</span>
<span class="term-fg32">+		} else {</span>
<span class="term-fg32">+			return 0, rpc.ErrNoHistoricalFallback</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+</span>
 	return DoEstimateGas(ctx, s.b, args, bNrOrHash, overrides, s.b.RPCGasCap())
 }
&nbsp;
<span class="term-fg36">@@ -1362,7 +1494,7 @@</span>
 &#47;&#47; RPCMarshalBlock converts the given block to the RPC output which depends on fullTx. If inclTx is true transactions are
 &#47;&#47; returned. When fullTx is true the returned block contains full transaction details, otherwise it will only contain
 &#47;&#47; transaction hashes.
<span class="term-fg31">-func RPCMarshalBlock(block *types.Block, inclTx bool, fullTx bool, config *params.ChainConfig) map[string]interface{} {</span>
<span class="term-fg32">+func RPCMarshalBlock(ctx context.Context, block *types.Block, inclTx bool, fullTx bool, config *params.ChainConfig, backend Backend) (map[string]interface{}, error) {</span>
 	fields := RPCMarshalHeader(block.Header())
 	fields[&quot;size&quot;] = hexutil.Uint64(block.Size())
&nbsp;
<span class="term-fg36">@@ -1372,7 +1504,7 @@</span> 			return tx.Hash()
 		}
 		if fullTx {
 			formatTx = func(idx int, tx *types.Transaction) interface{} {
<span class="term-fg31">-				return newRPCTransactionFromBlockIndex(block, uint64(idx), config)</span>
<span class="term-fg32">+				return newRPCTransactionFromBlockIndex(ctx, block, uint64(idx), config, backend)</span>
 			}
 		}
 		txs := block.Transactions()
<span class="term-fg36">@@ -1391,7 +1523,7 @@</span> 	fields[&quot;uncles&quot;] = uncleHashes
 	if block.Header().WithdrawalsHash != nil {
 		fields[&quot;withdrawals&quot;] = block.Withdrawals()
 	}
<span class="term-fg31">-	return fields</span>
<span class="term-fg32">+	return fields, nil</span>
 }
&nbsp;
 &#47;&#47; rpcMarshalHeader uses the generalized output filler, then adds the total difficulty field, which requires
<span class="term-fg36">@@ -1405,7 +1537,10 @@</span>
 &#47;&#47; rpcMarshalBlock uses the generalized output filler, then adds the total difficulty field, which requires
 &#47;&#47; a `BlockchainAPI`.
 func (s *BlockChainAPI) rpcMarshalBlock(ctx context.Context, b *types.Block, inclTx bool, fullTx bool) (map[string]interface{}, error) {
<span class="term-fg31">-	fields := RPCMarshalBlock(b, inclTx, fullTx, s.b.ChainConfig())</span>
<span class="term-fg32">+	fields, err := RPCMarshalBlock(ctx, b, inclTx, fullTx, s.b.ChainConfig(), s.b)</span>
<span class="term-fg32">+	if err != nil {</span>
<span class="term-fg32">+		return nil, err</span>
<span class="term-fg32">+	}</span>
 	if inclTx {
 		fields[&quot;totalDifficulty&quot;] = (*hexutil.Big)(s.b.GetTd(ctx, b.Hash()))
 	}
<span class="term-fg36">@@ -1436,11 +1571,18 @@</span> 	V                   *hexutil.Big      `json:&quot;v&quot;`
 	R                   *hexutil.Big      `json:&quot;r&quot;`
 	S                   *hexutil.Big      `json:&quot;s&quot;`
 	YParity             *hexutil.Uint64   `json:&quot;yParity,omitempty&quot;`
<span class="term-fg32">+</span>
<span class="term-fg32">+	&#47;&#47; deposit-tx only</span>
<span class="term-fg32">+	SourceHash *common.Hash `json:&quot;sourceHash,omitempty&quot;`</span>
<span class="term-fg32">+	Mint       *hexutil.Big `json:&quot;mint,omitempty&quot;`</span>
<span class="term-fg32">+	IsSystemTx *bool        `json:&quot;isSystemTx,omitempty&quot;`</span>
<span class="term-fg32">+	&#47;&#47; deposit-tx post-Canyon only</span>
<span class="term-fg32">+	DepositReceiptVersion *hexutil.Uint64 `json:&quot;depositReceiptVersion,omitempty&quot;`</span>
 }
&nbsp;
 &#47;&#47; newRPCTransaction returns a transaction that will serialize to the RPC
 &#47;&#47; representation, with the given location metadata set (if available).
<span class="term-fg31">-func newRPCTransaction(tx *types.Transaction, blockHash common.Hash, blockNumber uint64, blockTime uint64, index uint64, baseFee *big.Int, config *params.ChainConfig) *RPCTransaction {</span>
<span class="term-fg32">+func newRPCTransaction(tx *types.Transaction, blockHash common.Hash, blockNumber uint64, blockTime uint64, index uint64, baseFee *big.Int, config *params.ChainConfig, receipt *types.Receipt) *RPCTransaction {</span>
 	signer := types.MakeSigner(config, new(big.Int).SetUint64(blockNumber), blockTime)
 	from, _ := types.Sender(signer, tx)
 	v, r, s := tx.RawSignatureValues()
<span class="term-fg36">@@ -1465,7 +1607,27 @@</span> 		result.TransactionIndex = (*hexutil.Uint64)(&amp;index)
 	}
&nbsp;
 	switch tx.Type() {
<span class="term-fg32">+	case types.DepositTxType:</span>
<span class="term-fg32">+		srcHash := tx.SourceHash()</span>
<span class="term-fg32">+		isSystemTx := tx.IsSystemTx()</span>
<span class="term-fg32">+		result.SourceHash = &amp;srcHash</span>
<span class="term-fg32">+		if isSystemTx {</span>
<span class="term-fg32">+			&#47;&#47; Only include IsSystemTx when true</span>
<span class="term-fg32">+			result.IsSystemTx = &amp;isSystemTx</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+		result.Mint = (*hexutil.Big)(tx.Mint())</span>
<span class="term-fg32">+		if receipt != nil &amp;&amp; receipt.DepositNonce != nil {</span>
<span class="term-fg32">+			result.Nonce = hexutil.Uint64(*receipt.DepositNonce)</span>
<span class="term-fg32">+			if receipt.DepositReceiptVersion != nil {</span>
<span class="term-fg32">+				result.DepositReceiptVersion = new(hexutil.Uint64)</span>
<span class="term-fg32">+				*result.DepositReceiptVersion = hexutil.Uint64(*receipt.DepositReceiptVersion)</span>
<span class="term-fg32">+			}</span>
<span class="term-fg32">+		}</span>
 	case types.LegacyTxType:
<span class="term-fg32">+		if v.Sign() == 0 &amp;&amp; r.Sign() == 0 &amp;&amp; s.Sign() == 0 { &#47;&#47; pre-bedrock relayed tx does not have a signature</span>
<span class="term-fg32">+			result.ChainID = (*hexutil.Big)(new(big.Int).Set(config.ChainID))</span>
<span class="term-fg32">+			break</span>
<span class="term-fg32">+		}</span>
 		&#47;&#47; if a legacy transaction has an EIP-155 chain id, include it explicitly
 		if id := tx.ChainId(); id.Sign() != 0 {
 			result.ChainID = (*hexutil.Big)(id)
<span class="term-fg36">@@ -1538,16 +1700,32 @@</span> 		baseFee = eip1559.CalcBaseFee(config, current)
 		blockNumber = current.Number.Uint64()
 		blockTime = current.Time
 	}
<span class="term-fg31">-	return newRPCTransaction(tx, common.Hash{}, blockNumber, blockTime, 0, baseFee, config)</span>
<span class="term-fg32">+	return newRPCTransaction(tx, common.Hash{}, blockNumber, blockTime, 0, baseFee, config, nil)</span>
 }
&nbsp;
 &#47;&#47; newRPCTransactionFromBlockIndex returns a transaction that will serialize to the RPC representation.
<span class="term-fg31">-func newRPCTransactionFromBlockIndex(b *types.Block, index uint64, config *params.ChainConfig) *RPCTransaction {</span>
<span class="term-fg32">+func newRPCTransactionFromBlockIndex(ctx context.Context, b *types.Block, index uint64, config *params.ChainConfig, backend Backend) *RPCTransaction {</span>
 	txs := b.Transactions()
 	if index &gt;= uint64(len(txs)) {
 		return nil
 	}
<span class="term-fg31">-	return newRPCTransaction(txs[index], b.Hash(), b.NumberU64(), b.Time(), index, b.BaseFee(), config)</span>
<span class="term-fg32">+	tx := txs[index]</span>
<span class="term-fg32">+	rcpt := depositTxReceipt(ctx, b.Hash(), index, backend, tx)</span>
<span class="term-fg32">+	return newRPCTransaction(tx, b.Hash(), b.NumberU64(), b.Time(), index, b.BaseFee(), config, rcpt)</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func depositTxReceipt(ctx context.Context, blockHash common.Hash, index uint64, backend Backend, tx *types.Transaction) *types.Receipt {</span>
<span class="term-fg32">+	if tx.Type() != types.DepositTxType {</span>
<span class="term-fg32">+		return nil</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	receipts, err := backend.GetReceipts(ctx, blockHash)</span>
<span class="term-fg32">+	if err != nil {</span>
<span class="term-fg32">+		return nil</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	if index &gt;= uint64(len(receipts)) {</span>
<span class="term-fg32">+		return nil</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	return receipts[index]</span>
 }
&nbsp;
 &#47;&#47; newRPCRawTransactionFromBlockIndex returns the bytes of a transaction given a block and a transaction index.
<span class="term-fg36">@@ -1576,6 +1754,21 @@</span> 	bNrOrHash := rpc.BlockNumberOrHashWithNumber(rpc.PendingBlockNumber)
 	if blockNrOrHash != nil {
 		bNrOrHash = *blockNrOrHash
 	}
<span class="term-fg32">+</span>
<span class="term-fg32">+	header, err := headerByNumberOrHash(ctx, s.b, bNrOrHash)</span>
<span class="term-fg32">+	if err == nil &amp;&amp; header != nil &amp;&amp; s.b.ChainConfig().IsOptimismPreBedrock(header.Number) {</span>
<span class="term-fg32">+		if s.b.HistoricalRPCService() != nil {</span>
<span class="term-fg32">+			var res accessListResult</span>
<span class="term-fg32">+			err := s.b.HistoricalRPCService().CallContext(ctx, &amp;res, &quot;eth_createAccessList&quot;, args, blockNrOrHash)</span>
<span class="term-fg32">+			if err != nil {</span>
<span class="term-fg32">+				return nil, fmt.Errorf(&quot;historical backend error: %w&quot;, err)</span>
<span class="term-fg32">+			}</span>
<span class="term-fg32">+			return &amp;res, nil</span>
<span class="term-fg32">+		} else {</span>
<span class="term-fg32">+			return nil, rpc.ErrNoHistoricalFallback</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+</span>
 	acl, gasUsed, vmerr, err := AccessList(ctx, s.b, bNrOrHash, args)
 	if err != nil {
 		return nil, err
<span class="term-fg36">@@ -1686,7 +1879,7 @@</span>
 &#47;&#47; GetTransactionByBlockNumberAndIndex returns the transaction for the given block number and index.
 func (s *TransactionAPI) GetTransactionByBlockNumberAndIndex(ctx context.Context, blockNr rpc.BlockNumber, index hexutil.Uint) *RPCTransaction {
 	if block, _ := s.b.BlockByNumber(ctx, blockNr); block != nil {
<span class="term-fg31">-		return newRPCTransactionFromBlockIndex(block, uint64(index), s.b.ChainConfig())</span>
<span class="term-fg32">+		return newRPCTransactionFromBlockIndex(ctx, block, uint64(index), s.b.ChainConfig(), s.b)</span>
 	}
 	return nil
 }
<span class="term-fg36">@@ -1694,7 +1887,7 @@</span>
 &#47;&#47; GetTransactionByBlockHashAndIndex returns the transaction for the given block hash and index.
 func (s *TransactionAPI) GetTransactionByBlockHashAndIndex(ctx context.Context, blockHash common.Hash, index hexutil.Uint) *RPCTransaction {
 	if block, _ := s.b.BlockByHash(ctx, blockHash); block != nil {
<span class="term-fg31">-		return newRPCTransactionFromBlockIndex(block, uint64(index), s.b.ChainConfig())</span>
<span class="term-fg32">+		return newRPCTransactionFromBlockIndex(ctx, block, uint64(index), s.b.ChainConfig(), s.b)</span>
 	}
 	return nil
 }
<span class="term-fg36">@@ -1726,10 +1919,29 @@</span> 		}
 		return (*hexutil.Uint64)(&amp;nonce), nil
 	}
 	&#47;&#47; Resolve block number and use its state to ask for the nonce
<span class="term-fg32">+	header, err := headerByNumberOrHash(ctx, s.b, blockNrOrHash)</span>
<span class="term-fg32">+	if err != nil {</span>
<span class="term-fg32">+		return nil, err</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	if s.b.ChainConfig().IsOptimismPreBedrock(header.Number) {</span>
<span class="term-fg32">+		if s.b.HistoricalRPCService() != nil {</span>
<span class="term-fg32">+			var res hexutil.Uint64</span>
<span class="term-fg32">+			err := s.b.HistoricalRPCService().CallContext(ctx, &amp;res, &quot;eth_getTransactionCount&quot;, address, blockNrOrHash)</span>
<span class="term-fg32">+			if err != nil {</span>
<span class="term-fg32">+				return nil, fmt.Errorf(&quot;historical backend error: %w&quot;, err)</span>
<span class="term-fg32">+			}</span>
<span class="term-fg32">+			return &amp;res, nil</span>
<span class="term-fg32">+		} else {</span>
<span class="term-fg32">+			return nil, rpc.ErrNoHistoricalFallback</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+</span>
 	state, _, err := s.b.StateAndHeaderByNumberOrHash(ctx, blockNrOrHash)
 	if state == nil || err != nil {
 		return nil, err
 	}
<span class="term-fg32">+</span>
 	nonce := state.GetNonce(address)
 	return (*hexutil.Uint64)(&amp;nonce), state.Error()
 }
<span class="term-fg36">@@ -1746,7 +1958,8 @@</span> 		header, err := s.b.HeaderByHash(ctx, blockHash)
 		if err != nil {
 			return nil, err
 		}
<span class="term-fg31">-		return newRPCTransaction(tx, blockHash, blockNumber, header.Time, index, header.BaseFee, s.b.ChainConfig()), nil</span>
<span class="term-fg32">+		rcpt := depositTxReceipt(ctx, blockHash, index, s.b, tx)</span>
<span class="term-fg32">+		return newRPCTransaction(tx, blockHash, blockNumber, header.Time, index, header.BaseFee, s.b.ChainConfig(), rcpt), nil</span>
 	}
 	&#47;&#47; No finalized transaction, try to retrieve it from the pool
 	if tx := s.b.GetPoolTransaction(hash); tx != nil {
<span class="term-fg36">@@ -1797,11 +2010,11 @@</span> 	receipt := receipts[index]
&nbsp;
 	&#47;&#47; Derive the sender.
 	signer := types.MakeSigner(s.b.ChainConfig(), header.Number, header.Time)
<span class="term-fg31">-	return marshalReceipt(receipt, blockHash, blockNumber, signer, tx, int(index)), nil</span>
<span class="term-fg32">+	return marshalReceipt(receipt, blockHash, blockNumber, signer, tx, int(index), s.b.ChainConfig()), nil</span>
 }
&nbsp;
 &#47;&#47; marshalReceipt marshals a transaction receipt into a JSON object.
<span class="term-fg31">-func marshalReceipt(receipt *types.Receipt, blockHash common.Hash, blockNumber uint64, signer types.Signer, tx *types.Transaction, txIndex int) map[string]interface{} {</span>
<span class="term-fg32">+func marshalReceipt(receipt *types.Receipt, blockHash common.Hash, blockNumber uint64, signer types.Signer, tx *types.Transaction, txIndex int, chainConfig *params.ChainConfig) map[string]interface{} {</span>
 	from, _ := types.Sender(signer, tx)
&nbsp;
 	fields := map[string]interface{}{
<span class="term-fg36">@@ -1818,6 +2031,19 @@</span> 		&quot;logs&quot;:              receipt.Logs,
 		&quot;logsBloom&quot;:         receipt.Bloom,
 		&quot;type&quot;:              hexutil.Uint(tx.Type()),
 		&quot;effectiveGasPrice&quot;: (*hexutil.Big)(receipt.EffectiveGasPrice),
<span class="term-fg32">+	}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	if chainConfig.Optimism != nil &amp;&amp; !tx.IsDepositTx() {</span>
<span class="term-fg32">+		fields[&quot;l1GasPrice&quot;] = (*hexutil.Big)(receipt.L1GasPrice)</span>
<span class="term-fg32">+		fields[&quot;l1GasUsed&quot;] = (*hexutil.Big)(receipt.L1GasUsed)</span>
<span class="term-fg32">+		fields[&quot;l1Fee&quot;] = (*hexutil.Big)(receipt.L1Fee)</span>
<span class="term-fg32">+		fields[&quot;l1FeeScalar&quot;] = receipt.FeeScalar.String()</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	if chainConfig.Optimism != nil &amp;&amp; tx.IsDepositTx() &amp;&amp; receipt.DepositNonce != nil {</span>
<span class="term-fg32">+		fields[&quot;depositNonce&quot;] = hexutil.Uint64(*receipt.DepositNonce)</span>
<span class="term-fg32">+		if receipt.DepositReceiptVersion != nil {</span>
<span class="term-fg32">+			fields[&quot;depositReceiptVersion&quot;] = hexutil.Uint64(*receipt.DepositReceiptVersion)</span>
<span class="term-fg32">+		}</span>
 	}
&nbsp;
 	&#47;&#47; Assign receipt status or post state.
<span class="term-fg36">@@ -2187,20 +2413,23 @@</span> }
&nbsp;
 &#47;&#47; ChaindbProperty returns leveldb properties of the key-value database.
 func (api *DebugAPI) ChaindbProperty(property string) (string, error) {
<span class="term-fg31">-	if property == &quot;&quot; {</span>
<span class="term-fg31">-		property = &quot;leveldb.stats&quot;</span>
<span class="term-fg31">-	} else if !strings.HasPrefix(property, &quot;leveldb.&quot;) {</span>
<span class="term-fg31">-		property = &quot;leveldb.&quot; + property</span>
<span class="term-fg31">-	}</span>
 	return api.b.ChainDb().Stat(property)
 }
&nbsp;
 &#47;&#47; ChaindbCompact flattens the entire key-value database into a single level,
 &#47;&#47; removing all unused slots and merging all keys.
 func (api *DebugAPI) ChaindbCompact() error {
<span class="term-fg31">-	for b := byte(0); b &lt; 255; b++ {</span>
<span class="term-fg31">-		log.Info(&quot;Compacting chain database&quot;, &quot;range&quot;, fmt.Sprintf(&quot;0x%0.2X-0x%0.2X&quot;, b, b+1))</span>
<span class="term-fg31">-		if err := api.b.ChainDb().Compact([]byte{b}, []byte{b + 1}); err != nil {</span>
<span class="term-fg32">+	cstart := time.Now()</span>
<span class="term-fg32">+	for b := 0; b &lt;= 255; b++ {</span>
<span class="term-fg32">+		var (</span>
<span class="term-fg32">+			start = []byte{byte(b)}</span>
<span class="term-fg32">+			end   = []byte{byte(b + 1)}</span>
<span class="term-fg32">+		)</span>
<span class="term-fg32">+		if b == 255 {</span>
<span class="term-fg32">+			end = nil</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+		log.Info(&quot;Compacting database&quot;, &quot;range&quot;, fmt.Sprintf(&quot;%#X-%#X&quot;, start, end), &quot;elapsed&quot;, common.PrettyDuration(time.Since(cstart)))</span>
<span class="term-fg32">+		if err := api.b.ChainDb().Compact(start, end); err != nil {</span>
 			log.Error(&quot;Database compaction failed&quot;, &quot;err&quot;, err)
 			return err
 		}
<span class="term-fg36">@@ -2211,6 +2440,10 @@</span>
 &#47;&#47; SetHead rewinds the head of the blockchain to a previous block.
 func (api *DebugAPI) SetHead(number hexutil.Uint64) {
 	api.b.SetHead(uint64(number))
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func (api *DebugAPI) ChainConfig() *params.ChainConfig {</span>
<span class="term-fg32">+	return api.b.ChainConfig()</span>
 }
&nbsp;
 &#47;&#47; NetAPI offers network related RPC methods</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-c6561f272f55ae6a14f97ea8" role="button"
                   aria-expanded="false" aria-controls="id-c6561f272f55ae6a14f97ea8">
                    <code>rpc/errors.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/3f40e65c484486dea6cff80b7db178985d21a2c6/rpc/errors.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/650bb2f2b1dcfe30d9b1fa6f7dc9608055ed60e1/rpc/errors.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+10</span></div>
                        <div class="text-start"><span class="text-danger">-0</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-c6561f272f55ae6a14f97ea8"><span class="term-fg1">diff --git go-ethereum&#47;rpc&#47;errors.go op-geth&#47;rpc&#47;errors.go</span>
<span class="term-fg1">index 438aff218c2e306d322160d8be8dcac16dd0dfa2..67c523d11a36294e4448988dc4c906f38541ec04 100644</span>
<span class="term-fg1">--- go-ethereum&#47;rpc&#47;errors.go</span>
<span class="term-fg1">+++ op-geth&#47;rpc&#47;errors.go</span>
<span class="term-fg36">@@ -73,6 +73,16 @@</span> 	errMsgResponseTooLarge = &quot;response too large&quot;
 	errMsgBatchTooLarge    = &quot;batch too large&quot;
 )
&nbsp;
<span class="term-fg32">+var ErrNoHistoricalFallback = NoHistoricalFallbackError{}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+type NoHistoricalFallbackError struct{}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func (e NoHistoricalFallbackError) ErrorCode() int { return -32801 }</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func (e NoHistoricalFallbackError) Error() string {</span>
<span class="term-fg32">+	return &quot;no historical RPC is available for this historical (pre-bedrock) execution request&quot;</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
 type methodNotFoundError struct{ method string }
&nbsp;
 func (e *methodNotFoundError) ErrorCode() int { return -32601 }</div>
    </div>

            
        </div>
        <div>
            
        </div>
    </div>
</div>

            
                <div class="ps-1 py-2 my-1"><div class="row border-bottom border-1"data-bs-toggle="collapse" data-bs-target="#id-3c96010773286d033a7f84af"role="button" aria-expanded="false" aria-controls="id-3c96010773286d033a7f84af">
        
            <div class="col-12 col-sm-9 text-start"><h3>Tracer RPC daisy-chain</h3></div>
        
        <div class="col-12 col-sm-3 ms-auto mt-2">
            <div class="row line-stat">
                <div class="text-end"><span class="text-success">+59</span></div>
                <div class="text-start"><span class="text-danger">-12</span></div>
            </div>
        </div>
    </div>

    <div class="row forkdef-content collapse  border-1 ps-3 my-3" id="id-3c96010773286d033a7f84af">
        <div><p>Forward pre-bedrock tracing calls to legacy node.</p>
</div>
        <div>
            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-5de079c366d59de76d611c64" role="button"
                   aria-expanded="false" aria-controls="id-5de079c366d59de76d611c64">
                    <code>eth/tracers/api.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/3f40e65c484486dea6cff80b7db178985d21a2c6/eth/tracers/api.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/650bb2f2b1dcfe30d9b1fa6f7dc9608055ed60e1/eth/tracers/api.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+59</span></div>
                        <div class="text-start"><span class="text-danger">-12</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-5de079c366d59de76d611c64"><span class="term-fg1">diff --git go-ethereum&#47;eth&#47;tracers&#47;api.go op-geth&#47;eth&#47;tracers&#47;api.go</span>
<span class="term-fg1">index 300d904a997005071d0484b1f924c49066bb7c4f..7e14f6939590e0fabab30adaae9437c9c0082ae4 100644</span>
<span class="term-fg1">--- go-ethereum&#47;eth&#47;tracers&#47;api.go</span>
<span class="term-fg1">+++ op-geth&#47;eth&#47;tracers&#47;api.go</span>
<span class="term-fg36">@@ -22,6 +22,7 @@</span> 	&quot;context&quot;
 	&quot;encoding&#47;json&quot;
 	&quot;errors&quot;
 	&quot;fmt&quot;
<span class="term-fg32">+	&quot;math&#47;big&quot;</span>
 	&quot;os&quot;
 	&quot;runtime&quot;
 	&quot;sync&quot;
<span class="term-fg36">@@ -67,8 +68,6 @@</span> 	&#47;&#47; trace states exceed this limit.
 	maximumPendingTraceStates = 128
 )
&nbsp;
<span class="term-fg31">-var errTxNotFound = errors.New(&quot;transaction not found&quot;)</span>
<span class="term-fg31">-</span>
 &#47;&#47; StateReleaseFunc is used to deallocate resources held by constructing a
 &#47;&#47; historical state for tracing purposes.
 type StateReleaseFunc func()
<span class="term-fg36">@@ -87,6 +86,7 @@</span> 	Engine() consensus.Engine
 	ChainDb() ethdb.Database
 	StateAtBlock(ctx context.Context, block *types.Block, reexec uint64, base *state.StateDB, readOnly bool, preferDisk bool) (*state.StateDB, StateReleaseFunc, error)
 	StateAtTransaction(ctx context.Context, block *types.Block, txIndex int, reexec uint64) (*core.Message, vm.BlockContext, *state.StateDB, StateReleaseFunc, error)
<span class="term-fg32">+	HistoricalRPCService() *rpc.Client</span>
 }
&nbsp;
 &#47;&#47; API is the collection of tracing APIs exposed over the private debugging endpoint.
<span class="term-fg36">@@ -207,6 +207,7 @@</span>
 &#47;&#47; TraceChain returns the structured logs created during the execution of EVM
 &#47;&#47; between two blocks (excluding start) and returns them as a JSON object.
 func (api *API) TraceChain(ctx context.Context, start, end rpc.BlockNumber, config *TraceConfig) (*rpc.Subscription, error) { &#47;&#47; Fetch the block interval that we want to trace
<span class="term-fg32">+	&#47;&#47; TODO: Need to implement a fallback for this</span>
 	from, err := api.blockByNumber(ctx, start)
 	if err != nil {
 		return nil, err
<span class="term-fg36">@@ -265,7 +266,7 @@</span> 			&#47;&#47; Fetch and execute the block trace taskCh
 			for task := range taskCh {
 				var (
 					signer   = types.MakeSigner(api.backend.ChainConfig(), task.block.Number(), task.block.Time())
<span class="term-fg31">-					blockCtx = core.NewEVMBlockContext(task.block.Header(), api.chainContext(ctx), nil)</span>
<span class="term-fg32">+					blockCtx = core.NewEVMBlockContext(task.block.Header(), api.chainContext(ctx), nil, api.backend.ChainConfig(), task.statedb)</span>
 				)
 				&#47;&#47; Trace all the transactions contained within
 				for i, tx := range task.block.Transactions() {
<span class="term-fg36">@@ -435,6 +436,20 @@</span> 	block, err := api.blockByNumber(ctx, number)
 	if err != nil {
 		return nil, err
 	}
<span class="term-fg32">+</span>
<span class="term-fg32">+	if api.backend.ChainConfig().IsOptimismPreBedrock(block.Number()) {</span>
<span class="term-fg32">+		if api.backend.HistoricalRPCService() != nil {</span>
<span class="term-fg32">+			var histResult []*txTraceResult</span>
<span class="term-fg32">+			err = api.backend.HistoricalRPCService().CallContext(ctx, &amp;histResult, &quot;debug_traceBlockByNumber&quot;, number, config)</span>
<span class="term-fg32">+			if err != nil {</span>
<span class="term-fg32">+				return nil, fmt.Errorf(&quot;historical backend error: %w&quot;, err)</span>
<span class="term-fg32">+			}</span>
<span class="term-fg32">+			return histResult, nil</span>
<span class="term-fg32">+		} else {</span>
<span class="term-fg32">+			return nil, rpc.ErrNoHistoricalFallback</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+</span>
 	return api.traceBlock(ctx, block, config)
 }
&nbsp;
<span class="term-fg36">@@ -445,6 +460,20 @@</span> 	block, err := api.blockByHash(ctx, hash)
 	if err != nil {
 		return nil, err
 	}
<span class="term-fg32">+</span>
<span class="term-fg32">+	if api.backend.ChainConfig().IsOptimismPreBedrock(block.Number()) {</span>
<span class="term-fg32">+		if api.backend.HistoricalRPCService() != nil {</span>
<span class="term-fg32">+			var histResult []*txTraceResult</span>
<span class="term-fg32">+			err = api.backend.HistoricalRPCService().CallContext(ctx, &amp;histResult, &quot;debug_traceBlockByHash&quot;, hash, config)</span>
<span class="term-fg32">+			if err != nil {</span>
<span class="term-fg32">+				return nil, fmt.Errorf(&quot;historical backend error: %w&quot;, err)</span>
<span class="term-fg32">+			}</span>
<span class="term-fg32">+			return histResult, nil</span>
<span class="term-fg32">+		} else {</span>
<span class="term-fg32">+			return nil, rpc.ErrNoHistoricalFallback</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+</span>
 	return api.traceBlock(ctx, block, config)
 }
&nbsp;
<span class="term-fg36">@@ -494,6 +523,7 @@</span> &#47;&#47; IntermediateRoots executes a block (bad- or canon- or side-), and returns a list
 &#47;&#47; of intermediate roots: the stateroot after each transaction.
 func (api *API) IntermediateRoots(ctx context.Context, hash common.Hash, config *TraceConfig) ([]common.Hash, error) {
 	block, _ := api.blockByHash(ctx, hash)
<span class="term-fg32">+	&#47;&#47; TODO: Cannot get intermediate roots for pre-bedrock block without daisy chain</span>
 	if block == nil {
 		&#47;&#47; Check in the bad blocks
 		block = rawdb.ReadBadBlock(api.backend.ChainDb(), hash)
<span class="term-fg36">@@ -522,7 +552,7 @@</span> 	var (
 		roots              []common.Hash
 		signer             = types.MakeSigner(api.backend.ChainConfig(), block.Number(), block.Time())
 		chainConfig        = api.backend.ChainConfig()
<span class="term-fg31">-		vmctx              = core.NewEVMBlockContext(block.Header(), api.chainContext(ctx), nil)</span>
<span class="term-fg32">+		vmctx              = core.NewEVMBlockContext(block.Header(), api.chainContext(ctx), nil, chainConfig, statedb)</span>
 		deleteEmptyObjects = chainConfig.IsEIP158(block.Number())
 	)
 	for i, tx := range block.Transactions() {
<span class="term-fg36">@@ -598,7 +628,7 @@</span> 	var (
 		txs       = block.Transactions()
 		blockHash = block.Hash()
 		is158     = api.backend.ChainConfig().IsEIP158(block.Number())
<span class="term-fg31">-		blockCtx  = core.NewEVMBlockContext(block.Header(), api.chainContext(ctx), nil)</span>
<span class="term-fg32">+		blockCtx  = core.NewEVMBlockContext(block.Header(), api.chainContext(ctx), nil, api.backend.ChainConfig(), statedb)</span>
 		signer    = types.MakeSigner(api.backend.ChainConfig(), block.Number(), block.Time())
 		results   = make([]*txTraceResult, len(txs))
 	)
<span class="term-fg36">@@ -631,7 +661,6 @@</span> 	&#47;&#47; Execute all the transaction contained within the block concurrently
 	var (
 		txs       = block.Transactions()
 		blockHash = block.Hash()
<span class="term-fg31">-		blockCtx  = core.NewEVMBlockContext(block.Header(), api.chainContext(ctx), nil)</span>
 		signer    = types.MakeSigner(api.backend.ChainConfig(), block.Number(), block.Time())
 		results   = make([]*txTraceResult, len(txs))
 		pend      sync.WaitGroup
<span class="term-fg36">@@ -647,6 +676,7 @@</span> 		go func() {
 			defer pend.Done()
 			&#47;&#47; Fetch and execute the next transaction trace tasks
 			for task := range jobs {
<span class="term-fg32">+				blockCtx := core.NewEVMBlockContext(block.Header(), api.chainContext(ctx), nil, api.backend.ChainConfig(), task.statedb)</span>
 				msg, _ := core.TransactionToMessage(txs[task.index], signer, block.BaseFee())
 				txctx := &amp;Context{
 					BlockHash:   blockHash,
<span class="term-fg36">@@ -666,6 +696,7 @@</span> 	}
&nbsp;
 	&#47;&#47; Feed the transactions into the tracers and return
 	var failed error
<span class="term-fg32">+	blockCtx := core.NewEVMBlockContext(block.Header(), api.chainContext(ctx), nil, api.backend.ChainConfig(), statedb)</span>
 txloop:
 	for i, tx := range txs {
 		&#47;&#47; Send the trace task over for execution
<span class="term-fg36">@@ -743,7 +774,7 @@</span> 	var (
 		dumps       []string
 		signer      = types.MakeSigner(api.backend.ChainConfig(), block.Number(), block.Time())
 		chainConfig = api.backend.ChainConfig()
<span class="term-fg31">-		vmctx       = core.NewEVMBlockContext(block.Header(), api.chainContext(ctx), nil)</span>
<span class="term-fg32">+		vmctx       = core.NewEVMBlockContext(block.Header(), api.chainContext(ctx), nil, chainConfig, statedb)</span>
 		canon       = true
 	)
 	&#47;&#47; Check if there are any overrides: the caller may wish to enable a future
<span class="term-fg36">@@ -825,14 +856,25 @@</span>
 &#47;&#47; TraceTransaction returns the structured logs created during the execution of EVM
 &#47;&#47; and returns them as a JSON object.
 func (api *API) TraceTransaction(ctx context.Context, hash common.Hash, config *TraceConfig) (interface{}, error) {
<span class="term-fg31">-	tx, blockHash, blockNumber, index, err := api.backend.GetTransaction(ctx, hash)</span>
<span class="term-fg32">+	&#47;&#47; GetTransaction returns 0 for the blocknumber if the transaction is not found</span>
<span class="term-fg32">+	_, blockHash, blockNumber, index, err := api.backend.GetTransaction(ctx, hash)</span>
 	if err != nil {
 		return nil, err
 	}
<span class="term-fg31">-	&#47;&#47; Only mined txes are supported</span>
<span class="term-fg31">-	if tx == nil {</span>
<span class="term-fg31">-		return nil, errTxNotFound</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	if api.backend.ChainConfig().IsOptimismPreBedrock(new(big.Int).SetUint64(blockNumber)) {</span>
<span class="term-fg32">+		if api.backend.HistoricalRPCService() != nil {</span>
<span class="term-fg32">+			var histResult json.RawMessage</span>
<span class="term-fg32">+			err := api.backend.HistoricalRPCService().CallContext(ctx, &amp;histResult, &quot;debug_traceTransaction&quot;, hash, config)</span>
<span class="term-fg32">+			if err != nil {</span>
<span class="term-fg32">+				return nil, fmt.Errorf(&quot;historical backend error: %w&quot;, err)</span>
<span class="term-fg32">+			}</span>
<span class="term-fg32">+			return histResult, nil</span>
<span class="term-fg32">+		} else {</span>
<span class="term-fg32">+			return nil, rpc.ErrNoHistoricalFallback</span>
<span class="term-fg32">+		}</span>
 	}
<span class="term-fg32">+</span>
 	&#47;&#47; It shouldn&#39;t happen in practice.
 	if blockNumber == 0 {
 		return nil, errors.New(&quot;genesis is not traceable&quot;)
<span class="term-fg36">@@ -887,6 +929,11 @@</span> 	}
 	if err != nil {
 		return nil, err
 	}
<span class="term-fg32">+</span>
<span class="term-fg32">+	if api.backend.ChainConfig().IsOptimismPreBedrock(block.Number()) {</span>
<span class="term-fg32">+		return nil, errors.New(&quot;l2geth does not have a debug_traceCall method&quot;)</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+</span>
 	&#47;&#47; try to recompute the state
 	reexec := defaultTraceReexec
 	if config != nil &amp;&amp; config.Reexec != nil {
<span class="term-fg36">@@ -898,7 +945,7 @@</span> 		return nil, err
 	}
 	defer release()
&nbsp;
<span class="term-fg31">-	vmctx := core.NewEVMBlockContext(block.Header(), api.chainContext(ctx), nil)</span>
<span class="term-fg32">+	vmctx := core.NewEVMBlockContext(block.Header(), api.chainContext(ctx), nil, api.backend.ChainConfig(), statedb)</span>
 	&#47;&#47; Apply the customization rules if required.
 	if config != nil {
 		if err := config.StateOverrides.Apply(statedb); err != nil {</div>
    </div>

            
        </div>
        <div>
            
        </div>
    </div>
</div>

            
                <div class="ps-1 py-2 my-1"><div class="row border-bottom border-1"data-bs-toggle="collapse" data-bs-target="#id-73e2c243eda585b70b59983c"role="button" aria-expanded="false" aria-controls="id-73e2c243eda585b70b59983c">
        
            <div class="col-12 col-sm-9 text-start"><h3>Light Ethereum Subprotocol (LES) RPC</h3></div>
        
        <div class="col-12 col-sm-3 ms-auto mt-2">
            <div class="row line-stat">
                <div class="text-end"><span class="text-success">+57</span></div>
                <div class="text-start"><span class="text-danger">-19</span></div>
            </div>
        </div>
    </div>

    <div class="row forkdef-content collapse  border-1 ps-3 my-3" id="id-73e2c243eda585b70b59983c">
        <div><p>Match the RPC changes in the LES RPC</p>
</div>
        <div>
            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-2af85fbe9f01e0445ae2fde5" role="button"
                   aria-expanded="false" aria-controls="id-2af85fbe9f01e0445ae2fde5">
                    <code>les/odr_test.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/3f40e65c484486dea6cff80b7db178985d21a2c6/les/odr_test.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/650bb2f2b1dcfe30d9b1fa6f7dc9608055ed60e1/les/odr_test.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+2</span></div>
                        <div class="text-start"><span class="text-danger">-2</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-2af85fbe9f01e0445ae2fde5"><span class="term-fg1">diff --git go-ethereum&#47;les&#47;odr_test.go op-geth&#47;les&#47;odr_test.go</span>
<span class="term-fg1">index 69824a92dd083958d1d02f03ee956d9cddc35223..d5fb42589c5a133c6ecb1f2d27f9a6ad75dc68a0 100644</span>
<span class="term-fg1">--- go-ethereum&#47;les&#47;odr_test.go</span>
<span class="term-fg1">+++ op-geth&#47;les&#47;odr_test.go</span>
<span class="term-fg36">@@ -148,7 +148,7 @@</span> 					Data:              data,
 					SkipAccountChecks: true,
 				}
&nbsp;
<span class="term-fg31">-				context := core.NewEVMBlockContext(header, bc, nil)</span>
<span class="term-fg32">+				context := core.NewEVMBlockContext(header, bc, nil, config, statedb)</span>
 				txContext := core.NewEVMTxContext(msg)
 				vmenv := vm.NewEVM(context, txContext, statedb, config, vm.Config{NoBaseFee: true})
&nbsp;
<span class="term-fg36">@@ -172,7 +172,7 @@</span> 				GasTipCap:         new(big.Int),
 				Data:              data,
 				SkipAccountChecks: true,
 			}
<span class="term-fg31">-			context := core.NewEVMBlockContext(header, lc, nil)</span>
<span class="term-fg32">+			context := core.NewEVMBlockContext(header, lc, nil, config, state)</span>
 			txContext := core.NewEVMTxContext(msg)
 			vmenv := vm.NewEVM(context, txContext, state, config, vm.Config{NoBaseFee: true})
 			gp := new(core.GasPool).AddGas(math.MaxUint64)</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-f9153cde0597640fef6d630c" role="button"
                   aria-expanded="false" aria-controls="id-f9153cde0597640fef6d630c">
                    <code>les/odr_requests.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/3f40e65c484486dea6cff80b7db178985d21a2c6/les/odr_requests.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/650bb2f2b1dcfe30d9b1fa6f7dc9608055ed60e1/les/odr_requests.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+6</span></div>
                        <div class="text-start"><span class="text-danger">-5</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-f9153cde0597640fef6d630c"><span class="term-fg1">diff --git go-ethereum&#47;les&#47;odr_requests.go op-geth&#47;les&#47;odr_requests.go</span>
<span class="term-fg1">index 2b23e0540cc0e5ef17b9ea24f6ac105967159a73..c907018590fae1c263998f2f0691c36e37234479 100644</span>
<span class="term-fg1">--- go-ethereum&#47;les&#47;odr_requests.go</span>
<span class="term-fg1">+++ op-geth&#47;les&#47;odr_requests.go</span>
<span class="term-fg36">@@ -30,6 +30,7 @@</span> 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;light&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;log&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;rlp&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;trie&quot;
<span class="term-fg32">+	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;trie&#47;trienode&quot;</span>
 )
&nbsp;
 var (
<span class="term-fg36">@@ -222,9 +223,9 @@</span>
 	if msg.MsgType != MsgProofsV2 {
 		return errInvalidMessageType
 	}
<span class="term-fg31">-	proofs := msg.Obj.(light.NodeList)</span>
<span class="term-fg32">+	proofs := msg.Obj.(trienode.ProofList)</span>
 	&#47;&#47; Verify the proof and store if checks out
<span class="term-fg31">-	nodeSet := proofs.NodeSet()</span>
<span class="term-fg32">+	nodeSet := proofs.Set()</span>
 	reads := &amp;readTraceDB{db: nodeSet}
 	if _, err := trie.VerifyProof(r.Id.Root, r.Key, reads); err != nil {
 		return fmt.Errorf(&quot;merkle proof verification failed: %v&quot;, err)
<span class="term-fg36">@@ -308,7 +309,7 @@</span> 	FromLevel, AuxReq uint
 }
&nbsp;
 type HelperTrieResps struct { &#47;&#47; describes all responses, not just a single one
<span class="term-fg31">-	Proofs  light.NodeList</span>
<span class="term-fg32">+	Proofs  trienode.ProofList</span>
 	AuxData [][]byte
 }
&nbsp;
<span class="term-fg36">@@ -356,7 +357,7 @@</span> 	resp := msg.Obj.(HelperTrieResps)
 	if len(resp.AuxData) != 1 {
 		return errInvalidEntryCount
 	}
<span class="term-fg31">-	nodeSet := resp.Proofs.NodeSet()</span>
<span class="term-fg32">+	nodeSet := resp.Proofs.Set()</span>
 	headerEnc := resp.AuxData[0]
 	if len(headerEnc) == 0 {
 		return errHeaderUnavailable
<span class="term-fg36">@@ -451,7 +452,7 @@</span> 		return errInvalidMessageType
 	}
 	resps := msg.Obj.(HelperTrieResps)
 	proofs := resps.Proofs
<span class="term-fg31">-	nodeSet := proofs.NodeSet()</span>
<span class="term-fg32">+	nodeSet := proofs.Set()</span>
 	reads := &amp;readTraceDB{db: nodeSet}
&nbsp;
 	r.BloomBits = make([][]byte, len(r.SectionIndexList))</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-8e2be342c75b65e22a041e51" role="button"
                   aria-expanded="false" aria-controls="id-8e2be342c75b65e22a041e51">
                    <code>les/client.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/3f40e65c484486dea6cff80b7db178985d21a2c6/les/client.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/650bb2f2b1dcfe30d9b1fa6f7dc9608055ed60e1/les/client.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+25</span></div>
                        <div class="text-start"><span class="text-danger">-0</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-8e2be342c75b65e22a041e51"><span class="term-fg1">diff --git go-ethereum&#47;les&#47;client.go op-geth&#47;les&#47;client.go</span>
<span class="term-fg1">index be5e9fd5641dc23ce2f0268703607ac14a45bf0d..2c1d348e672b68f52adc2f8ba4d2d5fc387916d9 100644</span>
<span class="term-fg1">--- go-ethereum&#47;les&#47;client.go</span>
<span class="term-fg1">+++ op-geth&#47;les&#47;client.go</span>
<span class="term-fg36">@@ -18,6 +18,7 @@</span> &#47;&#47; Package les implements the Light Ethereum Subprotocol.
 package les
&nbsp;
 import (
<span class="term-fg32">+	&quot;context&quot;</span>
 	&quot;errors&quot;
 	&quot;strings&quot;
 	&quot;time&quot;
<span class="term-fg36">@@ -64,6 +65,9 @@</span> 	blockchain         *light.LightChain
 	serverPool         *vfc.ServerPool
 	serverPoolIterator enode.Iterator
 	merger             *consensus.Merger
<span class="term-fg32">+</span>
<span class="term-fg32">+	seqRPCService        *rpc.Client</span>
<span class="term-fg32">+	historicalRPCService *rpc.Client</span>
&nbsp;
 	bloomRequests chan chan *bloombits.Retrieval &#47;&#47; Channel receiving bloom data retrieval requests
 	bloomIndexer  *core.ChainIndexer             &#47;&#47; Bloom indexer operating during block imports
<span class="term-fg36">@@ -188,6 +192,27 @@</span> 	}
 	leth.ApiBackend.gpo = gasprice.NewOracle(leth.ApiBackend, gpoParams)
&nbsp;
 	leth.handler = newClientHandler(leth)
<span class="term-fg32">+</span>
<span class="term-fg32">+	if config.RollupSequencerHTTP != &quot;&quot; {</span>
<span class="term-fg32">+		ctx, cancel := context.WithTimeout(context.Background(), 5*time.Second)</span>
<span class="term-fg32">+		client, err := rpc.DialContext(ctx, config.RollupSequencerHTTP)</span>
<span class="term-fg32">+		cancel()</span>
<span class="term-fg32">+		if err != nil {</span>
<span class="term-fg32">+			return nil, err</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+		leth.seqRPCService = client</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	if config.RollupHistoricalRPC != &quot;&quot; {</span>
<span class="term-fg32">+		ctx, cancel := context.WithTimeout(context.Background(), config.RollupHistoricalRPCTimeout)</span>
<span class="term-fg32">+		client, err := rpc.DialContext(ctx, config.RollupHistoricalRPC)</span>
<span class="term-fg32">+		cancel()</span>
<span class="term-fg32">+		if err != nil {</span>
<span class="term-fg32">+			return nil, err</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+		leth.historicalRPCService = client</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+</span>
 	leth.netRPCService = ethapi.NewNetAPI(leth.p2pServer, leth.config.NetworkId)
&nbsp;
 	&#47;&#47; Register the backend on the node</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-df539d6b4c5d747e7a32e8ac" role="button"
                   aria-expanded="false" aria-controls="id-df539d6b4c5d747e7a32e8ac">
                    <code>les/peer.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/3f40e65c484486dea6cff80b7db178985d21a2c6/les/peer.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/650bb2f2b1dcfe30d9b1fa6f7dc9608055ed60e1/les/peer.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+2</span></div>
                        <div class="text-start"><span class="text-danger">-1</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-df539d6b4c5d747e7a32e8ac"><span class="term-fg1">diff --git go-ethereum&#47;les&#47;peer.go op-geth&#47;les&#47;peer.go</span>
<span class="term-fg1">index 48381689ef7ad7e490ea4ef9d42038cfeb048acd..58cb9287003169ada48d9eb1fd1ec659950be4be 100644</span>
<span class="term-fg1">--- go-ethereum&#47;les&#47;peer.go</span>
<span class="term-fg1">+++ op-geth&#47;les&#47;peer.go</span>
<span class="term-fg36">@@ -40,6 +40,7 @@</span> 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;light&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;p2p&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;p2p&#47;enode&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;rlp&quot;
<span class="term-fg32">+	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;trie&#47;trienode&quot;</span>
 )
&nbsp;
 var (
<span class="term-fg36">@@ -899,7 +900,7 @@</span> 	return &amp;reply{p.rw, ReceiptsMsg, reqID, data}
 }
&nbsp;
 &#47;&#47; replyProofsV2 creates a reply with a batch of merkle proofs, corresponding to the ones requested.
<span class="term-fg31">-func (p *clientPeer) replyProofsV2(reqID uint64, proofs light.NodeList) *reply {</span>
<span class="term-fg32">+func (p *clientPeer) replyProofsV2(reqID uint64, proofs trienode.ProofList) *reply {</span>
 	data, _ := rlp.EncodeToBytes(proofs)
 	return &amp;reply{p.rw, ProofsV2Msg, reqID, data}
 }</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-1fa4c8d01779092b85f0f6ae" role="button"
                   aria-expanded="false" aria-controls="id-1fa4c8d01779092b85f0f6ae">
                    <code>les/api_backend.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/3f40e65c484486dea6cff80b7db178985d21a2c6/les/api_backend.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/650bb2f2b1dcfe30d9b1fa6f7dc9608055ed60e1/les/api_backend.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+9</span></div>
                        <div class="text-start"><span class="text-danger">-1</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-1fa4c8d01779092b85f0f6ae"><span class="term-fg1">diff --git go-ethereum&#47;les&#47;api_backend.go op-geth&#47;les&#47;api_backend.go</span>
<span class="term-fg1">index 3e9dbadce86b4181ec63917a4425829754028ab0..fce7f0175870f5ed7a56e8d65ac49a88e5e71de8 100644</span>
<span class="term-fg1">--- go-ethereum&#47;les&#47;api_backend.go</span>
<span class="term-fg1">+++ op-geth&#47;les&#47;api_backend.go</span>
<span class="term-fg36">@@ -188,7 +188,7 @@</span> 	if vmConfig == nil {
 		vmConfig = new(vm.Config)
 	}
 	txContext := core.NewEVMTxContext(msg)
<span class="term-fg31">-	context := core.NewEVMBlockContext(header, b.eth.blockchain, nil)</span>
<span class="term-fg32">+	context := core.NewEVMBlockContext(header, b.eth.blockchain, nil, b.eth.chainConfig, state)</span>
 	if blockCtx != nil {
 		context = *blockCtx
 	}
<span class="term-fg36">@@ -335,3 +335,11 @@</span>
 func (b *LesApiBackend) StateAtTransaction(ctx context.Context, block *types.Block, txIndex int, reexec uint64) (*core.Message, vm.BlockContext, *state.StateDB, tracers.StateReleaseFunc, error) {
 	return b.eth.stateAtTransaction(ctx, block, txIndex, reexec)
 }
<span class="term-fg32">+</span>
<span class="term-fg32">+func (b *LesApiBackend) HistoricalRPCService() *rpc.Client {</span>
<span class="term-fg32">+	return b.eth.historicalRPCService</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func (b *LesApiBackend) Genesis() *types.Block {</span>
<span class="term-fg32">+	return b.eth.blockchain.Genesis()</span>
<span class="term-fg32">+}</span></div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-2f05e87088385c04ad3d0dcf" role="button"
                   aria-expanded="false" aria-controls="id-2f05e87088385c04ad3d0dcf">
                    <code>les/client_handler.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/3f40e65c484486dea6cff80b7db178985d21a2c6/les/client_handler.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/650bb2f2b1dcfe30d9b1fa6f7dc9608055ed60e1/les/client_handler.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+2</span></div>
                        <div class="text-start"><span class="text-danger">-1</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-2f05e87088385c04ad3d0dcf"><span class="term-fg1">diff --git go-ethereum&#47;les&#47;client_handler.go op-geth&#47;les&#47;client_handler.go</span>
<span class="term-fg1">index 4cfeba08fe14132baeac199f88a556f36b39a2c0..50f6dce879ffface3de8221662eb21e733fe9c7c 100644</span>
<span class="term-fg1">--- go-ethereum&#47;les&#47;client_handler.go</span>
<span class="term-fg1">+++ op-geth&#47;les&#47;client_handler.go</span>
<span class="term-fg36">@@ -26,6 +26,7 @@</span> 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;core&#47;forkid&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;core&#47;types&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;light&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;p2p&quot;
<span class="term-fg32">+	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;trie&#47;trienode&quot;</span>
 )
&nbsp;
 &#47;&#47; clientHandler is responsible for receiving and processing all incoming server
<span class="term-fg36">@@ -236,7 +237,7 @@</span> 	case msg.Code == ProofsV2Msg:
 		p.Log().Trace(&quot;Received les&#47;2 proofs response&quot;)
 		var resp struct {
 			ReqID, BV uint64
<span class="term-fg31">-			Data      light.NodeList</span>
<span class="term-fg32">+			Data      trienode.ProofList</span>
 		}
 		if err := msg.Decode(&amp;resp); err != nil {
 			return errResp(ErrDecode, &quot;msg %v: %v&quot;, msg, err)</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-983fae9919a99279c72a09d1" role="button"
                   aria-expanded="false" aria-controls="id-983fae9919a99279c72a09d1">
                    <code>les/handler_test.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/3f40e65c484486dea6cff80b7db178985d21a2c6/les/handler_test.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/650bb2f2b1dcfe30d9b1fa6f7dc9608055ed60e1/les/handler_test.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+5</span></div>
                        <div class="text-start"><span class="text-danger">-4</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-983fae9919a99279c72a09d1"><span class="term-fg1">diff --git go-ethereum&#47;les&#47;handler_test.go op-geth&#47;les&#47;handler_test.go</span>
<span class="term-fg1">index 26a083f475daf6594858d46c07ce8e0c6b75a92f..c803a5ddb3f29f784f7fa64858f61aa7c5c6e030 100644</span>
<span class="term-fg1">--- go-ethereum&#47;les&#47;handler_test.go</span>
<span class="term-fg1">+++ op-geth&#47;les&#47;handler_test.go</span>
<span class="term-fg36">@@ -37,6 +37,7 @@</span> 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;p2p&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;params&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;rlp&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;trie&quot;
<span class="term-fg32">+	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;trie&#47;trienode&quot;</span>
 )
&nbsp;
 func expectResponse(r p2p.MsgReader, msgcode, reqID, bv uint64, data interface{}) error {
<span class="term-fg36">@@ -401,7 +402,7 @@</span>
 	bc := server.handler.blockchain
&nbsp;
 	var proofreqs []ProofReq
<span class="term-fg31">-	proofsV2 := light.NewNodeSet()</span>
<span class="term-fg32">+	proofsV2 := trienode.NewProofSet()</span>
&nbsp;
 	accounts := []common.Address{bankAddr, userAddr1, userAddr2, signerAddr, {}}
 	for i := uint64(0); i &lt;= bc.CurrentBlock().Number.Uint64(); i++ {
<span class="term-fg36">@@ -419,7 +420,7 @@</span> 		}
 	}
 	&#47;&#47; Send the proof request and verify the response
 	sendRequest(rawPeer.app, GetProofsV2Msg, 42, proofreqs)
<span class="term-fg31">-	if err := expectResponse(rawPeer.app, ProofsV2Msg, 42, testBufLimit, proofsV2.NodeList()); err != nil {</span>
<span class="term-fg32">+	if err := expectResponse(rawPeer.app, ProofsV2Msg, 42, testBufLimit, proofsV2.List()); err != nil {</span>
 		t.Errorf(&quot;proofs mismatch: %v&quot;, err)
 	}
 }
<span class="term-fg36">@@ -456,10 +457,10 @@</span> 		sendRequest(rawPeer.app, GetProofsV2Msg, 42, []*ProofReq{req})
&nbsp;
 		var expected []rlp.RawValue
 		if wantOK {
<span class="term-fg31">-			proofsV2 := light.NewNodeSet()</span>
<span class="term-fg32">+			proofsV2 := trienode.NewProofSet()</span>
 			t, _ := trie.New(trie.StateTrieID(header.Root), server.backend.Blockchain().TrieDB())
 			t.Prove(account, proofsV2)
<span class="term-fg31">-			expected = proofsV2.NodeList()</span>
<span class="term-fg32">+			expected = proofsV2.List()</span>
 		}
 		if err := expectResponse(rawPeer.app, ProofsV2Msg, 42, testBufLimit, expected); err != nil {
 			t.Errorf(&quot;codes mismatch: %v&quot;, err)</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-0c3b6406bfa4cf77a23d3dc6" role="button"
                   aria-expanded="false" aria-controls="id-0c3b6406bfa4cf77a23d3dc6">
                    <code>les/state_accessor.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/3f40e65c484486dea6cff80b7db178985d21a2c6/les/state_accessor.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/650bb2f2b1dcfe30d9b1fa6f7dc9608055ed60e1/les/state_accessor.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+1</span></div>
                        <div class="text-start"><span class="text-danger">-1</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-0c3b6406bfa4cf77a23d3dc6"><span class="term-fg1">diff --git go-ethereum&#47;les&#47;state_accessor.go op-geth&#47;les&#47;state_accessor.go</span>
<span class="term-fg1">index 9a8214ac2f8f044493965fe989c54316a690a883..9383c2cc35019ff747ae8ec24edbac4a39121658 100644</span>
<span class="term-fg1">--- go-ethereum&#47;les&#47;state_accessor.go</span>
<span class="term-fg1">+++ op-geth&#47;les&#47;state_accessor.go</span>
<span class="term-fg36">@@ -62,7 +62,7 @@</span> 	for idx, tx := range block.Transactions() {
 		&#47;&#47; Assemble the transaction call message and return if the requested offset
 		msg, _ := core.TransactionToMessage(tx, signer, block.BaseFee())
 		txContext := core.NewEVMTxContext(msg)
<span class="term-fg31">-		context := core.NewEVMBlockContext(block.Header(), leth.blockchain, nil)</span>
<span class="term-fg32">+		context := core.NewEVMBlockContext(block.Header(), leth.blockchain, nil, leth.blockchain.Config(), statedb)</span>
 		statedb.SetTxContext(tx.Hash(), idx)
 		if idx == txIndex {
 			return msg, context, statedb, release, nil</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-95648758f3ac9bbd7faf916b" role="button"
                   aria-expanded="false" aria-controls="id-95648758f3ac9bbd7faf916b">
                    <code>les/server_requests.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/3f40e65c484486dea6cff80b7db178985d21a2c6/les/server_requests.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/650bb2f2b1dcfe30d9b1fa6f7dc9608055ed60e1/les/server_requests.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+5</span></div>
                        <div class="text-start"><span class="text-danger">-4</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-95648758f3ac9bbd7faf916b"><span class="term-fg1">diff --git go-ethereum&#47;les&#47;server_requests.go op-geth&#47;les&#47;server_requests.go</span>
<span class="term-fg1">index 485be6d9e9e6fdfdbb0cde93409af2f0da50ca84..9a249f04c9242d3ed4dacb30236f624d58c458a3 100644</span>
<span class="term-fg1">--- go-ethereum&#47;les&#47;server_requests.go</span>
<span class="term-fg1">+++ op-geth&#47;les&#47;server_requests.go</span>
<span class="term-fg36">@@ -30,6 +30,7 @@</span> 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;log&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;metrics&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;rlp&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;trie&quot;
<span class="term-fg32">+	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;trie&#47;trienode&quot;</span>
 )
&nbsp;
 &#47;&#47; serverBackend defines the backend functions needed for serving LES requests
<span class="term-fg36">@@ -378,7 +379,7 @@</span> 			header    *types.Header
 			err       error
 		)
 		bc := backend.BlockChain()
<span class="term-fg31">-		nodes := light.NewNodeSet()</span>
<span class="term-fg32">+		nodes := trienode.NewProofSet()</span>
&nbsp;
 		for i, request := range r.Reqs {
 			if i != 0 &amp;&amp; !waitOrStop() {
<span class="term-fg36">@@ -444,7 +445,7 @@</span> 			if nodes.DataSize() &gt;= softResponseLimit {
 				break
 			}
 		}
<span class="term-fg31">-		return p.replyProofsV2(r.ReqID, nodes.NodeList())</span>
<span class="term-fg32">+		return p.replyProofsV2(r.ReqID, nodes.List())</span>
 	}, r.ReqID, uint64(len(r.Reqs)), nil
 }
&nbsp;
<span class="term-fg36">@@ -463,7 +464,7 @@</span> 			auxBytes int
 			auxData  [][]byte
 		)
 		bc := backend.BlockChain()
<span class="term-fg31">-		nodes := light.NewNodeSet()</span>
<span class="term-fg32">+		nodes := trienode.NewProofSet()</span>
 		for i, request := range r.Reqs {
 			if i != 0 &amp;&amp; !waitOrStop() {
 				return nil
<span class="term-fg36">@@ -498,7 +499,7 @@</span> 			if nodes.DataSize()+auxBytes &gt;= softResponseLimit {
 				break
 			}
 		}
<span class="term-fg31">-		return p.replyHelperTrieProofs(r.ReqID, HelperTrieResps{Proofs: nodes.NodeList(), AuxData: auxData})</span>
<span class="term-fg32">+		return p.replyHelperTrieProofs(r.ReqID, HelperTrieResps{Proofs: nodes.List(), AuxData: auxData})</span>
 	}, r.ReqID, uint64(len(r.Reqs)), nil
 }
</div>
    </div>

            
        </div>
        <div>
            
        </div>
    </div>
</div>

            
                <div class="ps-1 py-2 my-1"><div class="row border-bottom border-1"data-bs-toggle="collapse" data-bs-target="#id-6c1fb2f28d3f542a84bf75f7"role="button" aria-expanded="false" aria-controls="id-6c1fb2f28d3f542a84bf75f7">
        
            <div class="col-12 col-sm-9 text-start"><h3>Daisy Chain tests</h3></div>
        
        <div class="col-12 col-sm-3 ms-auto mt-2">
            <div class="row line-stat">
                <div class="text-end"><span class="text-success">+351</span></div>
                <div class="text-start"><span class="text-danger">-18</span></div>
            </div>
        </div>
    </div>

    <div class="row forkdef-content collapse  border-1 ps-3 my-3" id="id-6c1fb2f28d3f542a84bf75f7">
        <div></div>
        <div>
            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-59efc02cbca224dc6ebe4272" role="button"
                   aria-expanded="false" aria-controls="id-59efc02cbca224dc6ebe4272">
                    <code>internal/ethapi/transaction_args_test.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/3f40e65c484486dea6cff80b7db178985d21a2c6/internal/ethapi/transaction_args_test.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/650bb2f2b1dcfe30d9b1fa6f7dc9608055ed60e1/internal/ethapi/transaction_args_test.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+3</span></div>
                        <div class="text-start"><span class="text-danger">-1</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-59efc02cbca224dc6ebe4272"><span class="term-fg1">diff --git go-ethereum&#47;internal&#47;ethapi&#47;transaction_args_test.go op-geth&#47;internal&#47;ethapi&#47;transaction_args_test.go</span>
<span class="term-fg1">index 9161d5e681f2ff2afd8f90f0838a3bbb7bb840ab..b743064625b779b46a73ad00196d0fe07bcc5aa2 100644</span>
<span class="term-fg1">--- go-ethereum&#47;internal&#47;ethapi&#47;transaction_args_test.go</span>
<span class="term-fg1">+++ op-geth&#47;internal&#47;ethapi&#47;transaction_args_test.go</span>
<span class="term-fg36">@@ -342,4 +342,6 @@</span> func (b *backendMock) SubscribeRemovedLogsEvent(ch chan&lt;- core.RemovedLogsEvent) event.Subscription {
 	return nil
 }
&nbsp;
<span class="term-fg31">-func (b *backendMock) Engine() consensus.Engine { return nil }</span>
<span class="term-fg32">+func (b *backendMock) Engine() consensus.Engine          { return nil }</span>
<span class="term-fg32">+func (b *backendMock) HistoricalRPCService() *rpc.Client { return nil }</span>
<span class="term-fg32">+func (b *backendMock) Genesis() *types.Block             { return nil }</span></div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-4713b8d3feb0895eaf6ba5ec" role="button"
                   aria-expanded="false" aria-controls="id-4713b8d3feb0895eaf6ba5ec">
                    <code>ethclient/ethclient_test.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/3f40e65c484486dea6cff80b7db178985d21a2c6/ethclient/ethclient_test.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/650bb2f2b1dcfe30d9b1fa6f7dc9608055ed60e1/ethclient/ethclient_test.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+152</span></div>
                        <div class="text-start"><span class="text-danger">-7</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-4713b8d3feb0895eaf6ba5ec"><span class="term-fg1">diff --git go-ethereum&#47;ethclient&#47;ethclient_test.go op-geth&#47;ethclient&#47;ethclient_test.go</span>
<span class="term-fg1">index d2f3710936611a170d67a97338811e74d7b665da..9cf595a1bc94cd4b0b70138135b6c673dc76713a 100644</span>
<span class="term-fg1">--- go-ethereum&#47;ethclient&#47;ethclient_test.go</span>
<span class="term-fg1">+++ op-geth&#47;ethclient&#47;ethclient_test.go</span>
<span class="term-fg36">@@ -20,10 +20,16 @@</span> import (
 	&quot;bytes&quot;
 	&quot;context&quot;
 	&quot;errors&quot;
<span class="term-fg32">+	&quot;fmt&quot;</span>
 	&quot;math&#47;big&quot;
<span class="term-fg32">+	&quot;net&quot;</span>
<span class="term-fg32">+	&quot;net&#47;http&quot;</span>
 	&quot;reflect&quot;
 	&quot;testing&quot;
 	&quot;time&quot;
<span class="term-fg32">+</span>
<span class="term-fg32">+	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;common&#47;hexutil&quot;</span>
<span class="term-fg32">+	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;internal&#47;ethapi&quot;</span>
&nbsp;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;common&quot;
<span class="term-fg36">@@ -193,6 +199,14 @@</span> 	Timestamp: 9000,
 	BaseFee:   big.NewInt(params.InitialBaseFee),
 }
&nbsp;
<span class="term-fg32">+var genesisForHistorical = &amp;core.Genesis{</span>
<span class="term-fg32">+	Config:    params.OptimismTestConfig,</span>
<span class="term-fg32">+	Alloc:     core.GenesisAlloc{testAddr: {Balance: testBalance}},</span>
<span class="term-fg32">+	ExtraData: []byte(&quot;test genesis&quot;),</span>
<span class="term-fg32">+	Timestamp: 9000,</span>
<span class="term-fg32">+	BaseFee:   big.NewInt(params.InitialBaseFee),</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
 var testTx1 = types.MustSignNewTx(testKey, types.LatestSigner(genesis.Config), &amp;types.LegacyTx{
 	Nonce:    0,
 	Value:    big.NewInt(12),
<span class="term-fg36">@@ -209,9 +223,64 @@</span> 	Gas:      params.TxGas,
 	To:       &amp;common.Address{2},
 })
&nbsp;
<span class="term-fg31">-func newTestBackend(t *testing.T) (*node.Node, []*types.Block) {</span>
<span class="term-fg32">+type mockHistoricalBackend struct{}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func (m *mockHistoricalBackend) Call(ctx context.Context, args ethapi.TransactionArgs, blockNrOrHash rpc.BlockNumberOrHash, overrides *ethapi.StateOverride) (hexutil.Bytes, error) {</span>
<span class="term-fg32">+	num, ok := blockNrOrHash.Number()</span>
<span class="term-fg32">+	if ok &amp;&amp; num == 1 {</span>
<span class="term-fg32">+		return hexutil.Bytes(&quot;test&quot;), nil</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	return nil, ethereum.NotFound</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func (m *mockHistoricalBackend) EstimateGas(ctx context.Context, args ethapi.TransactionArgs, blockNrOrHash *rpc.BlockNumberOrHash) (hexutil.Uint64, error) {</span>
<span class="term-fg32">+	num, ok := blockNrOrHash.Number()</span>
<span class="term-fg32">+	if ok &amp;&amp; num == 1 {</span>
<span class="term-fg32">+		return hexutil.Uint64(12345), nil</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	return 0, ethereum.NotFound</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func newMockHistoricalBackend(t *testing.T) string {</span>
<span class="term-fg32">+	s := rpc.NewServer()</span>
<span class="term-fg32">+	err := node.RegisterApis([]rpc.API{</span>
<span class="term-fg32">+		{</span>
<span class="term-fg32">+			Namespace:     &quot;eth&quot;,</span>
<span class="term-fg32">+			Service:       new(mockHistoricalBackend),</span>
<span class="term-fg32">+			Public:        true,</span>
<span class="term-fg32">+			Authenticated: false,</span>
<span class="term-fg32">+		},</span>
<span class="term-fg32">+	}, nil, s)</span>
<span class="term-fg32">+	if err != nil {</span>
<span class="term-fg32">+		t.Fatalf(&quot;error creating mock historical backend: %v&quot;, err)</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	hdlr := node.NewHTTPHandlerStack(s, []string{&quot;*&quot;}, []string{&quot;*&quot;}, nil)</span>
<span class="term-fg32">+	mux := http.NewServeMux()</span>
<span class="term-fg32">+	mux.Handle(&quot;&#47;&quot;, hdlr)</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	listener, err := net.Listen(&quot;tcp&quot;, &quot;127.0.0.1:0&quot;)</span>
<span class="term-fg32">+	if err != nil {</span>
<span class="term-fg32">+		t.Fatalf(&quot;error creating mock historical backend listener: %v&quot;, err)</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	go func() {</span>
<span class="term-fg32">+		httpS := &amp;http.Server{Handler: mux}</span>
<span class="term-fg32">+		httpS.Serve(listener)</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+		t.Cleanup(func() {</span>
<span class="term-fg32">+			httpS.Shutdown(context.Background())</span>
<span class="term-fg32">+		})</span>
<span class="term-fg32">+	}()</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	return fmt.Sprintf(&quot;http:&#47;&#47;%s&quot;, listener.Addr().String())</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func newTestBackend(t *testing.T, enableHistoricalState bool) (*node.Node, []*types.Block) {</span>
<span class="term-fg32">+	histAddr := newMockHistoricalBackend(t)</span>
<span class="term-fg32">+</span>
 	&#47;&#47; Generate test chain.
<span class="term-fg31">-	blocks := generateTestChain()</span>
<span class="term-fg32">+	blocks := generateTestChain(enableHistoricalState)</span>
&nbsp;
 	&#47;&#47; Create node
 	n, err := node.New(&amp;node.Config{})
<span class="term-fg36">@@ -219,7 +288,17 @@</span> 	if err != nil {
 		t.Fatalf(&quot;can&#39;t create new node: %v&quot;, err)
 	}
 	&#47;&#47; Create Ethereum Service
<span class="term-fg31">-	config := &amp;ethconfig.Config{Genesis: genesis}</span>
<span class="term-fg32">+	var actualGenesis *core.Genesis</span>
<span class="term-fg32">+	if enableHistoricalState {</span>
<span class="term-fg32">+		actualGenesis = genesisForHistorical</span>
<span class="term-fg32">+	} else {</span>
<span class="term-fg32">+		actualGenesis = genesis</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	config := &amp;ethconfig.Config{Genesis: actualGenesis}</span>
<span class="term-fg32">+	if enableHistoricalState {</span>
<span class="term-fg32">+		config.RollupHistoricalRPC = histAddr</span>
<span class="term-fg32">+		config.RollupHistoricalRPCTimeout = time.Second * 5</span>
<span class="term-fg32">+	}</span>
 	ethservice, err := eth.New(n, config)
 	if err != nil {
 		t.Fatalf(&quot;can&#39;t create new ethereum service: %v&quot;, err)
<span class="term-fg36">@@ -234,7 +313,7 @@</span> 	}
 	return n, blocks
 }
&nbsp;
<span class="term-fg31">-func generateTestChain() []*types.Block {</span>
<span class="term-fg32">+func generateTestChain(enableHistoricalState bool) []*types.Block {</span>
 	generate := func(i int, g *core.BlockGen) {
 		g.OffsetTime(5)
 		g.SetExtra([]byte(&quot;test&quot;))
<span class="term-fg36">@@ -244,12 +323,27 @@</span> 			g.AddTx(testTx1)
 			g.AddTx(testTx2)
 		}
 	}
<span class="term-fg31">-	_, blocks, _ := core.GenerateChainWithGenesis(genesis, ethash.NewFaker(), 2, generate)</span>
<span class="term-fg31">-	return append([]*types.Block{genesis.ToBlock()}, blocks...)</span>
<span class="term-fg32">+	var actualGenesis *core.Genesis</span>
<span class="term-fg32">+	if enableHistoricalState {</span>
<span class="term-fg32">+		actualGenesis = genesisForHistorical</span>
<span class="term-fg32">+	} else {</span>
<span class="term-fg32">+		actualGenesis = genesis</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	_, blocks, _ := core.GenerateChainWithGenesis(actualGenesis, ethash.NewFaker(), 2, generate)</span>
<span class="term-fg32">+	return append([]*types.Block{actualGenesis.ToBlock()}, blocks...)</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func TestEthClientHistoricalBackend(t *testing.T) {</span>
<span class="term-fg32">+	backend, _ := newTestBackend(t, true)</span>
<span class="term-fg32">+	client := backend.Attach()</span>
<span class="term-fg32">+	defer backend.Close()</span>
<span class="term-fg32">+	defer client.Close()</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	testHistoricalRPC(t, client)</span>
 }
&nbsp;
 func TestEthClient(t *testing.T) {
<span class="term-fg31">-	backend, chain := newTestBackend(t)</span>
<span class="term-fg32">+	backend, chain := newTestBackend(t, false)</span>
 	client := backend.Attach()
 	defer backend.Close()
 	defer client.Close()
<span class="term-fg36">@@ -286,6 +380,9 @@</span> 			func(t *testing.T) { testAtFunctions(t, client) },
 		},
 		&quot;TransactionSender&quot;: {
 			func(t *testing.T) { testTransactionSender(t, client) },
<span class="term-fg32">+		},</span>
<span class="term-fg32">+		&quot;EstimateGas&quot;: {</span>
<span class="term-fg32">+			func(t *testing.T) { testEstimateGas(t, client) },</span>
 		},
 	}
&nbsp;
<span class="term-fg36">@@ -682,6 +779,54 @@</span> 		t.Fatal(err)
 	}
 	if sender2 != testAddr {
 		t.Fatal(&quot;wrong sender:&quot;, sender2)
<span class="term-fg32">+	}</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func testEstimateGas(t *testing.T, client *rpc.Client) {</span>
<span class="term-fg32">+	ec := NewClient(client)</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	&#47;&#47; EstimateGas</span>
<span class="term-fg32">+	msg := ethereum.CallMsg{</span>
<span class="term-fg32">+		From:  testAddr,</span>
<span class="term-fg32">+		To:    &amp;common.Address{},</span>
<span class="term-fg32">+		Gas:   21000,</span>
<span class="term-fg32">+		Value: big.NewInt(1),</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	gas, err := ec.EstimateGas(context.Background(), msg)</span>
<span class="term-fg32">+	if err != nil {</span>
<span class="term-fg32">+		t.Fatalf(&quot;unexpected error: %v&quot;, err)</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	if gas != 21000 {</span>
<span class="term-fg32">+		t.Fatalf(&quot;unexpected gas price: %v&quot;, gas)</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func testHistoricalRPC(t *testing.T, client *rpc.Client) {</span>
<span class="term-fg32">+	ec := NewClient(client)</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	&#47;&#47; Estimate Gas RPC</span>
<span class="term-fg32">+	msg := ethereum.CallMsg{</span>
<span class="term-fg32">+		From:  testAddr,</span>
<span class="term-fg32">+		To:    &amp;common.Address{},</span>
<span class="term-fg32">+		Gas:   21000,</span>
<span class="term-fg32">+		Value: big.NewInt(1),</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	var res hexutil.Uint64</span>
<span class="term-fg32">+	err := client.CallContext(context.Background(), &amp;res, &quot;eth_estimateGas&quot;, toCallArg(msg), rpc.BlockNumberOrHashWithNumber(1))</span>
<span class="term-fg32">+	if err != nil {</span>
<span class="term-fg32">+		t.Fatalf(&quot;unexpected error: %v&quot;, err)</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	if res != 12345 {</span>
<span class="term-fg32">+		t.Fatalf(&quot;invalid result: %d&quot;, res)</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	&#47;&#47; Call Contract RPC</span>
<span class="term-fg32">+	histVal, err := ec.CallContract(context.Background(), msg, big.NewInt(1))</span>
<span class="term-fg32">+	if err != nil {</span>
<span class="term-fg32">+		t.Fatalf(&quot;unexpected error: %v&quot;, err)</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	if string(histVal) != &quot;test&quot; {</span>
<span class="term-fg32">+		t.Fatalf(&quot;expected %s to equal test&quot;, string(histVal))</span>
 	}
 }
</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-c984a39dff52a5550de39faa" role="button"
                   aria-expanded="false" aria-controls="id-c984a39dff52a5550de39faa">
                    <code>eth/tracers/api_test.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/3f40e65c484486dea6cff80b7db178985d21a2c6/eth/tracers/api_test.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/650bb2f2b1dcfe30d9b1fa6f7dc9608055ed60e1/eth/tracers/api_test.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+196</span></div>
                        <div class="text-start"><span class="text-danger">-10</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-c984a39dff52a5550de39faa"><span class="term-fg1">diff --git go-ethereum&#47;eth&#47;tracers&#47;api_test.go op-geth&#47;eth&#47;tracers&#47;api_test.go</span>
<span class="term-fg1">index 0f78af9a01e5c4857ccc0475f9067bed83276159..b2d68e09e8cff52079b7906ecfb7f4f3162133d6 100644</span>
<span class="term-fg1">--- go-ethereum&#47;eth&#47;tracers&#47;api_test.go</span>
<span class="term-fg1">+++ op-geth&#47;eth&#47;tracers&#47;api_test.go</span>
<span class="term-fg36">@@ -23,11 +23,14 @@</span> 	&quot;encoding&#47;json&quot;
 	&quot;errors&quot;
 	&quot;fmt&quot;
 	&quot;math&#47;big&quot;
<span class="term-fg32">+	&quot;net&quot;</span>
<span class="term-fg32">+	&quot;net&#47;http&quot;</span>
 	&quot;reflect&quot;
 	&quot;sync&#47;atomic&quot;
 	&quot;testing&quot;
 	&quot;time&quot;
&nbsp;
<span class="term-fg32">+	&quot;github.com&#47;davecgh&#47;go-spew&#47;spew&quot;</span>
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;common&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;common&#47;hexutil&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;consensus&quot;
<span class="term-fg36">@@ -41,16 +44,79 @@</span> 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;crypto&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;eth&#47;tracers&#47;logger&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;ethdb&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;internal&#47;ethapi&quot;
<span class="term-fg32">+	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;node&quot;</span>
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;params&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;rpc&quot;
<span class="term-fg32">+	&quot;github.com&#47;stretchr&#47;testify&#47;mock&quot;</span>
 	&quot;golang.org&#47;x&#47;exp&#47;slices&quot;
 )
&nbsp;
 var (
<span class="term-fg31">-	errStateNotFound = errors.New(&quot;state not found&quot;)</span>
<span class="term-fg31">-	errBlockNotFound = errors.New(&quot;block not found&quot;)</span>
<span class="term-fg32">+	errStateNotFound       = errors.New(&quot;state not found&quot;)</span>
<span class="term-fg32">+	errBlockNotFound       = errors.New(&quot;block not found&quot;)</span>
<span class="term-fg32">+	errTransactionNotFound = errors.New(&quot;transaction not found&quot;)</span>
 )
&nbsp;
<span class="term-fg32">+type mockHistoricalBackend struct {</span>
<span class="term-fg32">+	mock.Mock</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+&#47;&#47; mockHistoricalBackend does not have a TraceCall, because pre-bedrock there is no debug_traceCall available</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func (m *mockHistoricalBackend) TraceBlockByNumber(ctx context.Context, number rpc.BlockNumber, config *TraceConfig) ([]*txTraceResult, error) {</span>
<span class="term-fg32">+	ret := m.Mock.MethodCalled(&quot;TraceBlockByNumber&quot;, number, config)</span>
<span class="term-fg32">+	return ret[0].([]*txTraceResult), *ret[1].(*error)</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func (m *mockHistoricalBackend) ExpectTraceBlockByNumber(number rpc.BlockNumber, config *TraceConfig, out []*txTraceResult, err error) {</span>
<span class="term-fg32">+	m.Mock.On(&quot;TraceBlockByNumber&quot;, number, config).Once().Return(out, &amp;err)</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func (m *mockHistoricalBackend) TraceTransaction(ctx context.Context, hash common.Hash, config *TraceConfig) (interface{}, error) {</span>
<span class="term-fg32">+	ret := m.Mock.MethodCalled(&quot;TraceTransaction&quot;, hash, config)</span>
<span class="term-fg32">+	return ret[0], *ret[1].(*error)</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func (m *mockHistoricalBackend) ExpectTraceTransaction(hash common.Hash, config *TraceConfig, out interface{}, err error) {</span>
<span class="term-fg32">+	jsonOut, _ := json.Marshal(out)</span>
<span class="term-fg32">+	m.Mock.On(&quot;TraceTransaction&quot;, hash, config).Once().Return(json.RawMessage(jsonOut), &amp;err)</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func newMockHistoricalBackend(t *testing.T, backend *mockHistoricalBackend) string {</span>
<span class="term-fg32">+	s := rpc.NewServer()</span>
<span class="term-fg32">+	err := node.RegisterApis([]rpc.API{</span>
<span class="term-fg32">+		{</span>
<span class="term-fg32">+			Namespace:     &quot;debug&quot;,</span>
<span class="term-fg32">+			Service:       backend,</span>
<span class="term-fg32">+			Public:        true,</span>
<span class="term-fg32">+			Authenticated: false,</span>
<span class="term-fg32">+		},</span>
<span class="term-fg32">+	}, nil, s)</span>
<span class="term-fg32">+	if err != nil {</span>
<span class="term-fg32">+		t.Fatalf(&quot;error creating mock historical backend: %v&quot;, err)</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	hdlr := node.NewHTTPHandlerStack(s, []string{&quot;*&quot;}, []string{&quot;*&quot;}, nil)</span>
<span class="term-fg32">+	mux := http.NewServeMux()</span>
<span class="term-fg32">+	mux.Handle(&quot;&#47;&quot;, hdlr)</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	listener, err := net.Listen(&quot;tcp&quot;, &quot;127.0.0.1:0&quot;)</span>
<span class="term-fg32">+	if err != nil {</span>
<span class="term-fg32">+		t.Fatalf(&quot;error creating mock historical backend listener: %v&quot;, err)</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	go func() {</span>
<span class="term-fg32">+		httpS := &amp;http.Server{Handler: mux}</span>
<span class="term-fg32">+		httpS.Serve(listener)</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+		t.Cleanup(func() {</span>
<span class="term-fg32">+			httpS.Shutdown(context.Background())</span>
<span class="term-fg32">+		})</span>
<span class="term-fg32">+	}()</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	return fmt.Sprintf(&quot;http:&#47;&#47;%s&quot;, listener.Addr().String())</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
 type testBackend struct {
 	chainConfig *params.ChainConfig
 	engine      consensus.Engine
<span class="term-fg36">@@ -59,15 +125,28 @@</span> 	chain       *core.BlockChain
&nbsp;
 	refHook func() &#47;&#47; Hook is invoked when the requested state is referenced
 	relHook func() &#47;&#47; Hook is invoked when the requested state is released
<span class="term-fg32">+</span>
<span class="term-fg32">+	historical     *rpc.Client</span>
<span class="term-fg32">+	mockHistorical *mockHistoricalBackend</span>
 }
&nbsp;
 &#47;&#47; testBackend creates a new test backend. OBS: After test is done, teardown must be
 &#47;&#47; invoked in order to release associated resources.
 func newTestBackend(t *testing.T, n int, gspec *core.Genesis, generator func(i int, b *core.BlockGen)) *testBackend {
<span class="term-fg32">+	mock := new(mockHistoricalBackend)</span>
<span class="term-fg32">+	historicalAddr := newMockHistoricalBackend(t, mock)</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	historicalClient, err := rpc.Dial(historicalAddr)</span>
<span class="term-fg32">+	if err != nil {</span>
<span class="term-fg32">+		t.Fatalf(&quot;error making historical client: %v&quot;, err)</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+</span>
 	backend := &amp;testBackend{
<span class="term-fg31">-		chainConfig: gspec.Config,</span>
<span class="term-fg31">-		engine:      ethash.NewFaker(),</span>
<span class="term-fg31">-		chaindb:     rawdb.NewMemoryDatabase(),</span>
<span class="term-fg32">+		chainConfig:    gspec.Config,</span>
<span class="term-fg32">+		engine:         ethash.NewFaker(),</span>
<span class="term-fg32">+		chaindb:        rawdb.NewMemoryDatabase(),</span>
<span class="term-fg32">+		historical:     historicalClient,</span>
<span class="term-fg32">+		mockHistorical: mock,</span>
 	}
 	&#47;&#47; Generate blocks for testing
 	_, blocks, _ := core.GenerateChainWithGenesis(gspec, backend.engine, n, generator)
<span class="term-fg36">@@ -115,6 +194,9 @@</span> }
&nbsp;
 func (b *testBackend) GetTransaction(ctx context.Context, txHash common.Hash) (*types.Transaction, common.Hash, uint64, uint64, error) {
 	tx, hash, blockNumber, index := rawdb.ReadTransaction(b.chaindb, txHash)
<span class="term-fg32">+	if tx == nil {</span>
<span class="term-fg32">+		return nil, common.Hash{}, 0, 0, errTransactionNotFound</span>
<span class="term-fg32">+	}</span>
 	return tx, hash, blockNumber, index, nil
 }
&nbsp;
<span class="term-fg36">@@ -172,7 +254,7 @@</span> 	signer := types.MakeSigner(b.chainConfig, block.Number(), block.Time())
 	for idx, tx := range block.Transactions() {
 		msg, _ := core.TransactionToMessage(tx, signer, block.BaseFee())
 		txContext := core.NewEVMTxContext(msg)
<span class="term-fg31">-		context := core.NewEVMBlockContext(block.Header(), b.chain, nil)</span>
<span class="term-fg32">+		context := core.NewEVMBlockContext(block.Header(), b.chain, nil, b.chainConfig, statedb)</span>
 		if idx == txIndex {
 			return msg, context, statedb, release, nil
 		}
<span class="term-fg36">@@ -183,6 +265,10 @@</span> 		}
 		statedb.Finalise(vmenv.ChainConfig().IsEIP158(block.Number()))
 	}
 	return nil, vm.BlockContext{}, nil, nil, fmt.Errorf(&quot;transaction index %d out of range for block %#x&quot;, txIndex, block.Hash())
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func (b *testBackend) HistoricalRPCService() *rpc.Client {</span>
<span class="term-fg32">+	return b.historical</span>
 }
&nbsp;
 func TestTraceCall(t *testing.T) {
<span class="term-fg36">@@ -360,11 +446,58 @@</span> 		StructLogs:  []logger.StructLogRes{},
 	}) {
 		t.Error(&quot;Transaction tracing result is different&quot;)
 	}
<span class="term-fg32">+}</span>
<span class="term-fg32">+func TestTraceTransactionHistorical(t *testing.T) {</span>
<span class="term-fg32">+	t.Parallel()</span>
&nbsp;
<span class="term-fg31">-	&#47;&#47; Test non-existent transaction</span>
<span class="term-fg31">-	_, err = api.TraceTransaction(context.Background(), common.Hash{42}, nil)</span>
<span class="term-fg31">-	if !errors.Is(err, errTxNotFound) {</span>
<span class="term-fg31">-		t.Fatalf(&quot;want %v, have %v&quot;, errTxNotFound, err)</span>
<span class="term-fg32">+	&#47;&#47; Initialize test accounts</span>
<span class="term-fg32">+	accounts := newAccounts(2)</span>
<span class="term-fg32">+	genesis := &amp;core.Genesis{</span>
<span class="term-fg32">+		Config: params.OptimismTestConfig,</span>
<span class="term-fg32">+		Alloc: core.GenesisAlloc{</span>
<span class="term-fg32">+			accounts[0].addr: {Balance: big.NewInt(params.Ether)},</span>
<span class="term-fg32">+			accounts[1].addr: {Balance: big.NewInt(params.Ether)},</span>
<span class="term-fg32">+		},</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	target := common.Hash{}</span>
<span class="term-fg32">+	signer := types.HomesteadSigner{}</span>
<span class="term-fg32">+	backend := newTestBackend(t, 1, genesis, func(i int, b *core.BlockGen) {</span>
<span class="term-fg32">+		&#47;&#47; Transfer from account[0] to account[1]</span>
<span class="term-fg32">+		&#47;&#47;    value: 1000 wei</span>
<span class="term-fg32">+		&#47;&#47;    fee:   0 wei</span>
<span class="term-fg32">+		tx, _ := types.SignTx(types.NewTransaction(uint64(i), accounts[1].addr, big.NewInt(1000), params.TxGas, b.BaseFee(), nil), signer, accounts[0].key)</span>
<span class="term-fg32">+		b.AddTx(tx)</span>
<span class="term-fg32">+		target = tx.Hash()</span>
<span class="term-fg32">+	})</span>
<span class="term-fg32">+	defer backend.mockHistorical.AssertExpectations(t)</span>
<span class="term-fg32">+	defer backend.chain.Stop()</span>
<span class="term-fg32">+	backend.mockHistorical.ExpectTraceTransaction(</span>
<span class="term-fg32">+		target,</span>
<span class="term-fg32">+		nil,</span>
<span class="term-fg32">+		logger.ExecutionResult{</span>
<span class="term-fg32">+			Gas:         params.TxGas,</span>
<span class="term-fg32">+			Failed:      false,</span>
<span class="term-fg32">+			ReturnValue: &quot;&quot;,</span>
<span class="term-fg32">+			StructLogs:  []logger.StructLogRes{},</span>
<span class="term-fg32">+		},</span>
<span class="term-fg32">+		nil)</span>
<span class="term-fg32">+	api := NewAPI(backend)</span>
<span class="term-fg32">+	result, err := api.TraceTransaction(context.Background(), target, nil)</span>
<span class="term-fg32">+	if err != nil {</span>
<span class="term-fg32">+		t.Errorf(&quot;Failed to trace transaction %v&quot;, err)</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	var have *logger.ExecutionResult</span>
<span class="term-fg32">+	spew.Dump(result)</span>
<span class="term-fg32">+	if err := json.Unmarshal(result.(json.RawMessage), &amp;have); err != nil {</span>
<span class="term-fg32">+		t.Errorf(&quot;failed to unmarshal result %v&quot;, err)</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	if !reflect.DeepEqual(have, &amp;logger.ExecutionResult{</span>
<span class="term-fg32">+		Gas:         params.TxGas,</span>
<span class="term-fg32">+		Failed:      false,</span>
<span class="term-fg32">+		ReturnValue: &quot;&quot;,</span>
<span class="term-fg32">+		StructLogs:  []logger.StructLogRes{},</span>
<span class="term-fg32">+	}) {</span>
<span class="term-fg32">+		t.Error(&quot;Transaction tracing result is different&quot;)</span>
 	}
 }
&nbsp;
<span class="term-fg36">@@ -448,6 +581,59 @@</span> 		want := tc.want
 		if string(have) != want {
 			t.Errorf(&quot;test %d, result mismatch, have\n%v\n, want\n%v\n&quot;, i, string(have), want)
 		}
<span class="term-fg32">+	}</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func TestTraceBlockHistorical(t *testing.T) {</span>
<span class="term-fg32">+	t.Parallel()</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	&#47;&#47; Initialize test accounts</span>
<span class="term-fg32">+	accounts := newAccounts(3)</span>
<span class="term-fg32">+	genesis := &amp;core.Genesis{</span>
<span class="term-fg32">+		Config: params.OptimismTestConfig,</span>
<span class="term-fg32">+		Alloc: core.GenesisAlloc{</span>
<span class="term-fg32">+			accounts[0].addr: {Balance: big.NewInt(params.Ether)},</span>
<span class="term-fg32">+			accounts[1].addr: {Balance: big.NewInt(params.Ether)},</span>
<span class="term-fg32">+			accounts[2].addr: {Balance: big.NewInt(params.Ether)},</span>
<span class="term-fg32">+		},</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	genBlocks := 10</span>
<span class="term-fg32">+	signer := types.HomesteadSigner{}</span>
<span class="term-fg32">+	backend := newTestBackend(t, genBlocks, genesis, func(i int, b *core.BlockGen) {</span>
<span class="term-fg32">+		&#47;&#47; Transfer from account[0] to account[1]</span>
<span class="term-fg32">+		&#47;&#47;    value: 1000 wei</span>
<span class="term-fg32">+		&#47;&#47;    fee:   0 wei</span>
<span class="term-fg32">+		tx, _ := types.SignTx(types.NewTransaction(uint64(i), accounts[1].addr, big.NewInt(1000), params.TxGas, b.BaseFee(), nil), signer, accounts[0].key)</span>
<span class="term-fg32">+		b.AddTx(tx)</span>
<span class="term-fg32">+	})</span>
<span class="term-fg32">+	defer backend.mockHistorical.AssertExpectations(t)</span>
<span class="term-fg32">+	defer backend.chain.Stop()</span>
<span class="term-fg32">+	api := NewAPI(backend)</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	var expectErr error</span>
<span class="term-fg32">+	var config *TraceConfig</span>
<span class="term-fg32">+	blockNumber := rpc.BlockNumber(3)</span>
<span class="term-fg32">+	want := `[{&quot;txHash&quot;:&quot;0x0000000000000000000000000000000000000000000000000000000000000000&quot;,&quot;result&quot;:{&quot;failed&quot;:false,&quot;gas&quot;:21000,&quot;returnValue&quot;:&quot;&quot;,&quot;structLogs&quot;:[]}}]`</span>
<span class="term-fg32">+	var ret []*txTraceResult</span>
<span class="term-fg32">+	_ = json.Unmarshal([]byte(want), &amp;ret)</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	backend.mockHistorical.ExpectTraceBlockByNumber(blockNumber, config, ret, nil)</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	result, err := api.TraceBlockByNumber(context.Background(), blockNumber, config)</span>
<span class="term-fg32">+	if expectErr != nil {</span>
<span class="term-fg32">+		if err == nil {</span>
<span class="term-fg32">+			t.Errorf(&quot;want error %v&quot;, expectErr)</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+		if !reflect.DeepEqual(err, expectErr) {</span>
<span class="term-fg32">+			t.Errorf(&quot;error mismatch, want %v, get %v&quot;, expectErr, err)</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	if err != nil {</span>
<span class="term-fg32">+		t.Errorf(&quot;want no error, have %v&quot;, err)</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	have, _ := json.Marshal(result)</span>
<span class="term-fg32">+	if string(have) != want {</span>
<span class="term-fg32">+		t.Errorf(&quot;result mismatch, have\n%v\n, want\n%v\n&quot;, string(have), want)</span>
 	}
 }
</div>
    </div>

            
        </div>
        <div>
            
        </div>
    </div>
</div>

            
                <div class="ps-1 py-2 my-1"><div class="row border-bottom border-1"data-bs-toggle="collapse" data-bs-target="#id-3fceefffdae5b8c6d43f189f"role="button" aria-expanded="false" aria-controls="id-3fceefffdae5b8c6d43f189f">
        
            <div class="col-12 col-sm-9 text-start"><h3>Debug API</h3></div>
        
        <div class="col-12 col-sm-3 ms-auto mt-2">
            <div class="row line-stat">
                <div class="text-end"><span class="text-success">+4</span></div>
                <div class="text-start"><span class="text-danger">-1</span></div>
            </div>
        </div>
    </div>

    <div class="row forkdef-content collapse  border-1 ps-3 my-3" id="id-3fceefffdae5b8c6d43f189f">
        <div><p>Fix Debug API block marshaling to include deposits</p>
</div>
        <div>
            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-f8dcc9ba7bf3ee67e822bef5" role="button"
                   aria-expanded="false" aria-controls="id-f8dcc9ba7bf3ee67e822bef5">
                    <code>eth/api_debug.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/3f40e65c484486dea6cff80b7db178985d21a2c6/eth/api_debug.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/650bb2f2b1dcfe30d9b1fa6f7dc9608055ed60e1/eth/api_debug.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+4</span></div>
                        <div class="text-start"><span class="text-danger">-1</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-f8dcc9ba7bf3ee67e822bef5"><span class="term-fg1">diff --git go-ethereum&#47;eth&#47;api_debug.go op-geth&#47;eth&#47;api_debug.go</span>
<span class="term-fg1">index dc9f56814699fcb26388741e29bd725cf0bcf225..5dec47de7942680d8d26f24d9ba6f2af423de260 100644</span>
<span class="term-fg1">--- go-ethereum&#47;eth&#47;api_debug.go</span>
<span class="term-fg1">+++ op-geth&#47;eth&#47;api_debug.go</span>
<span class="term-fg36">@@ -119,7 +119,10 @@</span> 			blockRlp = err.Error() &#47;&#47; Hacky, but hey, it works
 		} else {
 			blockRlp = fmt.Sprintf(&quot;%#x&quot;, rlpBytes)
 		}
<span class="term-fg31">-		blockJSON = ethapi.RPCMarshalBlock(block, true, true, api.eth.APIBackend.ChainConfig())</span>
<span class="term-fg32">+		var err error</span>
<span class="term-fg32">+		if blockJSON, err = ethapi.RPCMarshalBlock(ctx, block, true, true, api.eth.APIBackend.ChainConfig(), api.eth.APIBackend); err != nil {</span>
<span class="term-fg32">+			blockJSON = map[string]interface{}{&quot;error&quot;: err.Error()}</span>
<span class="term-fg32">+		}</span>
 		results = append(results, &amp;BadBlockArgs{
 			Hash:  block.Hash(),
 			RLP:   blockRlp,</div>
    </div>

            
        </div>
        <div>
            
        </div>
    </div>
</div>

            
                <div class="ps-1 py-2 my-1"><div class="row border-bottom border-1"data-bs-toggle="collapse" data-bs-target="#id-353e34776ec998bc05074840"role="button" aria-expanded="false" aria-controls="id-353e34776ec998bc05074840">
        
            <div class="col-12 col-sm-9 text-start"><h3>Eth gasprice suggestions</h3></div>
        
        <div class="col-12 col-sm-3 ms-auto mt-2">
            <div class="row line-stat">
                <div class="text-end"><span class="text-success">+139</span></div>
                <div class="text-start"><span class="text-danger">-1</span></div>
            </div>
        </div>
    </div>

    <div class="row forkdef-content collapse  border-1 ps-3 my-3" id="id-353e34776ec998bc05074840">
        <div><p>gasprice suggestion adjustments to accommodate faster L2 blocks and lower fees.</p>
</div>
        <div>
            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-abdb84d0b34da4859c514511" role="button"
                   aria-expanded="false" aria-controls="id-abdb84d0b34da4859c514511">
                    <code>eth/gasprice/gasprice.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/3f40e65c484486dea6cff80b7db178985d21a2c6/eth/gasprice/gasprice.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/650bb2f2b1dcfe30d9b1fa6f7dc9608055ed60e1/eth/gasprice/gasprice.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+29</span></div>
                        <div class="text-start"><span class="text-danger">-1</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-abdb84d0b34da4859c514511"><span class="term-fg1">diff --git go-ethereum&#47;eth&#47;gasprice&#47;gasprice.go op-geth&#47;eth&#47;gasprice&#47;gasprice.go</span>
<span class="term-fg1">index b71964981145fa58b7894a2be4637d8a7e2a6c9a..e8ef6c7459ecd92841f902d54f9bf124930053df 100644</span>
<span class="term-fg1">--- go-ethereum&#47;eth&#47;gasprice&#47;gasprice.go</span>
<span class="term-fg1">+++ op-geth&#47;eth&#47;gasprice&#47;gasprice.go</span>
<span class="term-fg36">@@ -37,6 +37,8 @@</span>
 var (
 	DefaultMaxPrice    = big.NewInt(500 * params.GWei)
 	DefaultIgnorePrice = big.NewInt(2 * params.Wei)
<span class="term-fg32">+</span>
<span class="term-fg32">+	DefaultMinSuggestedPriorityFee = big.NewInt(1e6 * params.Wei) &#47;&#47; 0.001 gwei, for Optimism fee suggestion</span>
 )
&nbsp;
 type Config struct {
<span class="term-fg36">@@ -47,6 +49,8 @@</span> 	MaxBlockHistory  uint64
 	Default          *big.Int `toml:&quot;,omitempty&quot;`
 	MaxPrice         *big.Int `toml:&quot;,omitempty&quot;`
 	IgnorePrice      *big.Int `toml:&quot;,omitempty&quot;`
<span class="term-fg32">+</span>
<span class="term-fg32">+	MinSuggestedPriorityFee *big.Int `toml:&quot;,omitempty&quot;` &#47;&#47; for Optimism fee suggestion</span>
 }
&nbsp;
 &#47;&#47; OracleBackend includes all necessary background APIs for oracle.
<span class="term-fg36">@@ -74,6 +78,8 @@</span> 	checkBlocks, percentile           int
 	maxHeaderHistory, maxBlockHistory uint64
&nbsp;
 	historyCache *lru.Cache[cacheKey, processedFees]
<span class="term-fg32">+</span>
<span class="term-fg32">+	minSuggestedPriorityFee *big.Int &#47;&#47; for Optimism fee suggestion</span>
 }
&nbsp;
 &#47;&#47; NewOracle returns a new gasprice oracle which can recommend suitable
<span class="term-fg36">@@ -128,7 +134,7 @@</span> 			lastHead = ev.Block.Hash()
 		}
 	}()
&nbsp;
<span class="term-fg31">-	return &amp;Oracle{</span>
<span class="term-fg32">+	r := &amp;Oracle{</span>
 		backend:          backend,
 		lastPrice:        params.Default,
 		maxPrice:         maxPrice,
<span class="term-fg36">@@ -139,6 +145,17 @@</span> 		maxHeaderHistory: maxHeaderHistory,
 		maxBlockHistory:  maxBlockHistory,
 		historyCache:     cache,
 	}
<span class="term-fg32">+</span>
<span class="term-fg32">+	if backend.ChainConfig().IsOptimism() {</span>
<span class="term-fg32">+		r.minSuggestedPriorityFee = params.MinSuggestedPriorityFee</span>
<span class="term-fg32">+		if r.minSuggestedPriorityFee == nil || r.minSuggestedPriorityFee.Int64() &lt;= 0 {</span>
<span class="term-fg32">+			r.minSuggestedPriorityFee = DefaultMinSuggestedPriorityFee</span>
<span class="term-fg32">+			log.Warn(&quot;Sanitizing invalid optimism gasprice oracle min priority fee suggestion&quot;,</span>
<span class="term-fg32">+				&quot;provided&quot;, params.MinSuggestedPriorityFee,</span>
<span class="term-fg32">+				&quot;updated&quot;, r.minSuggestedPriorityFee)</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	return r</span>
 }
&nbsp;
 &#47;&#47; SuggestTipCap returns a tip cap so that newly created transaction can have a
<span class="term-fg36">@@ -168,6 +185,11 @@</span> 	oracle.cacheLock.RUnlock()
 	if headHash == lastHead {
 		return new(big.Int).Set(lastPrice), nil
 	}
<span class="term-fg32">+</span>
<span class="term-fg32">+	if oracle.backend.ChainConfig().IsOptimism() {</span>
<span class="term-fg32">+		return oracle.SuggestOptimismPriorityFee(ctx, head, headHash), nil</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+</span>
 	var (
 		sent, exp int
 		number    = head.Number.Uint64()
<span class="term-fg36">@@ -274,3 +296,9 @@</span> 	case result &lt;- results{prices, nil}:
 	case &lt;-quit:
 	}
 }
<span class="term-fg32">+</span>
<span class="term-fg32">+type bigIntArray []*big.Int</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func (s bigIntArray) Len() int           { return len(s) }</span>
<span class="term-fg32">+func (s bigIntArray) Less(i, j int) bool { return s[i].Cmp(s[j]) &lt; 0 }</span>
<span class="term-fg32">+func (s bigIntArray) Swap(i, j int)      { s[i], s[j] = s[j], s[i] }</span></div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-8354fa9e6588eb2d0d679442" role="button"
                   aria-expanded="false" aria-controls="id-8354fa9e6588eb2d0d679442">
                    <code>eth/gasprice/optimism-gasprice.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <span class="text-muted">(new)</span>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/650bb2f2b1dcfe30d9b1fa6f7dc9608055ed60e1/eth/gasprice/optimism-gasprice.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+110</span></div>
                        <div class="text-start"><span class="text-danger">-0</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-8354fa9e6588eb2d0d679442"><span class="term-fg1">diff --git go-ethereum&#47;eth&#47;gasprice&#47;optimism-gasprice.go op-geth&#47;eth&#47;gasprice&#47;optimism-gasprice.go</span>
<span class="term-fg1">new file mode 100644</span>
<span class="term-fg1">index 0000000000000000000000000000000000000000..71cd021f637f92e4b6d99ec5fc337d27edf547e5</span>
<span class="term-fg1">--- &#47;dev&#47;null</span>
<span class="term-fg1">+++ op-geth&#47;eth&#47;gasprice&#47;optimism-gasprice.go</span>
<span class="term-fg36">@@ -0,0 +1,110 @@</span>
<span class="term-fg32">+package gasprice</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+import (</span>
<span class="term-fg32">+	&quot;context&quot;</span>
<span class="term-fg32">+	&quot;math&#47;big&quot;</span>
<span class="term-fg32">+	&quot;sort&quot;</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;common&quot;</span>
<span class="term-fg32">+	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;core&#47;types&quot;</span>
<span class="term-fg32">+	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;log&quot;</span>
<span class="term-fg32">+	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;rpc&quot;</span>
<span class="term-fg32">+)</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+&#47;&#47; SuggestOptimismPriorityFee returns a max priority fee value that can be used such that newly</span>
<span class="term-fg32">+&#47;&#47; created transactions have a very high chance to be included in the following blocks, using a</span>
<span class="term-fg32">+&#47;&#47; simplified and more predictable algorithm appropriate for chains like Optimism with a single</span>
<span class="term-fg32">+&#47;&#47; known block builder.</span>
<span class="term-fg32">+&#47;&#47;</span>
<span class="term-fg32">+&#47;&#47; In the typical case, which results whenever the last block had room for more transactions, this</span>
<span class="term-fg32">+&#47;&#47; function returns a minimum suggested priority fee value. Otherwise it returns the higher of this</span>
<span class="term-fg32">+&#47;&#47; minimum suggestion or 10% over the median effective priority fee from the last block.</span>
<span class="term-fg32">+&#47;&#47;</span>
<span class="term-fg32">+&#47;&#47; Rationale: For a chain such as Optimism where there is a single block builder whose behavior is</span>
<span class="term-fg32">+&#47;&#47; known, we know priority fee (as long as it is non-zero) has no impact on the probability for tx</span>
<span class="term-fg32">+&#47;&#47; inclusion as long as there is capacity for it in the block. In this case then, there&#39;s no reason</span>
<span class="term-fg32">+&#47;&#47; to return any value higher than some fixed minimum. Blocks typically reach capacity only under</span>
<span class="term-fg32">+&#47;&#47; extreme events such as airdrops, meaning predicting whether the next block is going to be at</span>
<span class="term-fg32">+&#47;&#47; capacity is difficult *except* in the case where we&#39;re already experiencing the increased demand</span>
<span class="term-fg32">+&#47;&#47; from such an event. We therefore expect whether the last known block is at capacity to be one of</span>
<span class="term-fg32">+&#47;&#47; the best predictors of whether the next block is likely to be at capacity. (An even better</span>
<span class="term-fg32">+&#47;&#47; predictor is to look at the state of the transaction pool, but we want an algorithm that works</span>
<span class="term-fg32">+&#47;&#47; even if the txpool is private or unavailable.)</span>
<span class="term-fg32">+&#47;&#47;</span>
<span class="term-fg32">+&#47;&#47; In the event the next block may be at capacity, the algorithm should allow for average fees to</span>
<span class="term-fg32">+&#47;&#47; rise in order to reach a market price that appropriately reflects demand. We accomplish this by</span>
<span class="term-fg32">+&#47;&#47; returning a suggestion that is a significant amount (10%) higher than the median effective</span>
<span class="term-fg32">+&#47;&#47; priority fee from the previous block.</span>
<span class="term-fg32">+func (oracle *Oracle) SuggestOptimismPriorityFee(ctx context.Context, h *types.Header, headHash common.Hash) *big.Int {</span>
<span class="term-fg32">+	suggestion := new(big.Int).Set(oracle.minSuggestedPriorityFee)</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	&#47;&#47; find the maximum gas used by any of the transactions in the block to use as the capacity</span>
<span class="term-fg32">+	&#47;&#47; margin</span>
<span class="term-fg32">+	receipts, err := oracle.backend.GetReceipts(ctx, headHash)</span>
<span class="term-fg32">+	if receipts == nil || err != nil {</span>
<span class="term-fg32">+		log.Error(&quot;failed to get block receipts&quot;, &quot;err&quot;, err)</span>
<span class="term-fg32">+		return suggestion</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	var maxTxGasUsed uint64</span>
<span class="term-fg32">+	for i := range receipts {</span>
<span class="term-fg32">+		gu := receipts[i].GasUsed</span>
<span class="term-fg32">+		if gu &gt; maxTxGasUsed {</span>
<span class="term-fg32">+			maxTxGasUsed = gu</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	&#47;&#47; sanity check the max gas used value</span>
<span class="term-fg32">+	if maxTxGasUsed &gt; h.GasLimit {</span>
<span class="term-fg32">+		log.Error(&quot;found tx consuming more gas than the block limit&quot;, &quot;gas&quot;, maxTxGasUsed)</span>
<span class="term-fg32">+		return suggestion</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	if h.GasUsed+maxTxGasUsed &gt; h.GasLimit {</span>
<span class="term-fg32">+		&#47;&#47; A block is &quot;at capacity&quot; if, when it is built, there is a pending tx in the txpool that</span>
<span class="term-fg32">+		&#47;&#47; could not be included because the block&#39;s gas limit would be exceeded. Since we don&#39;t</span>
<span class="term-fg32">+		&#47;&#47; have access to the txpool, we instead adopt the following heuristic: consider a block as</span>
<span class="term-fg32">+		&#47;&#47; at capacity if the total gas consumed by its transactions is within max-tx-gas-used of</span>
<span class="term-fg32">+		&#47;&#47; the block limit, where max-tx-gas-used is the most gas used by any one transaction</span>
<span class="term-fg32">+		&#47;&#47; within the block. This heuristic is almost perfectly accurate when transactions always</span>
<span class="term-fg32">+		&#47;&#47; consume the same amount of gas, but becomes less accurate as tx gas consumption begins</span>
<span class="term-fg32">+		&#47;&#47; to vary. The typical error is we assume a block is at capacity when it was not because</span>
<span class="term-fg32">+		&#47;&#47; max-tx-gas-used will in most cases over-estimate the &quot;capacity margin&quot;. But it&#39;s better</span>
<span class="term-fg32">+		&#47;&#47; to err on the side of returning a higher-than-needed suggestion than a lower-than-needed</span>
<span class="term-fg32">+		&#47;&#47; one in order to satisfy our desire for high chance of inclusion and rising fees under</span>
<span class="term-fg32">+		&#47;&#47; high demand.</span>
<span class="term-fg32">+		block, err := oracle.backend.BlockByNumber(ctx, rpc.BlockNumber(h.Number.Int64()))</span>
<span class="term-fg32">+		if block == nil || err != nil {</span>
<span class="term-fg32">+			log.Error(&quot;failed to get last block&quot;, &quot;err&quot;, err)</span>
<span class="term-fg32">+			return suggestion</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+		baseFee := block.BaseFee()</span>
<span class="term-fg32">+		txs := block.Transactions()</span>
<span class="term-fg32">+		if len(txs) == 0 {</span>
<span class="term-fg32">+			log.Error(&quot;block was at capacity but doesn&#39;t have transactions&quot;)</span>
<span class="term-fg32">+			return suggestion</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+		tips := bigIntArray(make([]*big.Int, len(txs)))</span>
<span class="term-fg32">+		for i := range txs {</span>
<span class="term-fg32">+			tips[i] = txs[i].EffectiveGasTipValue(baseFee)</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+		sort.Sort(tips)</span>
<span class="term-fg32">+		median := tips[len(tips)&#47;2]</span>
<span class="term-fg32">+		newSuggestion := new(big.Int).Add(median, new(big.Int).Div(median, big.NewInt(10)))</span>
<span class="term-fg32">+		&#47;&#47; use the new suggestion only if it&#39;s bigger than the minimum</span>
<span class="term-fg32">+		if newSuggestion.Cmp(suggestion) &gt; 0 {</span>
<span class="term-fg32">+			suggestion = newSuggestion</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	&#47;&#47; the suggestion should be capped by oracle.maxPrice</span>
<span class="term-fg32">+	if suggestion.Cmp(oracle.maxPrice) &gt; 0 {</span>
<span class="term-fg32">+		suggestion.Set(oracle.maxPrice)</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	oracle.cacheLock.Lock()</span>
<span class="term-fg32">+	oracle.lastHead = headHash</span>
<span class="term-fg32">+	oracle.lastPrice = suggestion</span>
<span class="term-fg32">+	oracle.cacheLock.Unlock()</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	return new(big.Int).Set(suggestion)</span>
<span class="term-fg32">+}</span></div>
    </div>

            
        </div>
        <div>
            
        </div>
    </div>
</div>

            
                <div class="ps-1 py-2 my-1"><div class="row border-bottom border-1"data-bs-toggle="collapse" data-bs-target="#id-770842adb143129b6a1f39a5"role="button" aria-expanded="false" aria-controls="id-770842adb143129b6a1f39a5">
        
            <div class="col-12 col-sm-9 text-start"><h3>API testvector fix</h3></div>
        
        <div class="col-12 col-sm-3 ms-auto mt-2">
            <div class="row line-stat">
                <div class="text-end"><span class="text-success">+1</span></div>
                <div class="text-start"><span class="text-danger">-1</span></div>
            </div>
        </div>
    </div>

    <div class="row forkdef-content collapse  border-1 ps-3 my-3" id="id-770842adb143129b6a1f39a5">
        <div><p>Upstream test of broken behavior; in Optimism, a zero signature is valid (pre-bedrock for deposit-txs),
and the chain ID formula on signature data must not be used, or an underflow happens.</p>
</div>
        <div>
            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-8640ccf40b0943e890c4a0c4" role="button"
                   aria-expanded="false" aria-controls="id-8640ccf40b0943e890c4a0c4">
                    <code>internal/ethapi/testdata/eth_getBlockByNumber-tag-pending-fullTx.json</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/3f40e65c484486dea6cff80b7db178985d21a2c6/internal/ethapi/testdata/eth_getBlockByNumber-tag-pending-fullTx.json" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/650bb2f2b1dcfe30d9b1fa6f7dc9608055ed60e1/internal/ethapi/testdata/eth_getBlockByNumber-tag-pending-fullTx.json" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+1</span></div>
                        <div class="text-start"><span class="text-danger">-1</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-8640ccf40b0943e890c4a0c4"><span class="term-fg1">diff --git go-ethereum&#47;internal&#47;ethapi&#47;testdata&#47;eth_getBlockByNumber-tag-pending-fullTx.json op-geth&#47;internal&#47;ethapi&#47;testdata&#47;eth_getBlockByNumber-tag-pending-fullTx.json</span>
<span class="term-fg1">index 1d524d6eced19249ab7f1d7beeb04863087e81c1..7087932286ea7facdae1e56caf15e618b5307e71 100644</span>
<span class="term-fg1">--- go-ethereum&#47;internal&#47;ethapi&#47;testdata&#47;eth_getBlockByNumber-tag-pending-fullTx.json</span>
<span class="term-fg1">+++ op-geth&#47;internal&#47;ethapi&#47;testdata&#47;eth_getBlockByNumber-tag-pending-fullTx.json</span>
<span class="term-fg36">@@ -30,7 +30,7 @@</span>       &quot;to&quot;: &quot;0x0d3ab14bbad3d99f4203bd7a11acb94882050e7e&quot;,
       &quot;transactionIndex&quot;: &quot;0x0&quot;,
       &quot;value&quot;: &quot;0x6f&quot;,
       &quot;type&quot;: &quot;0x0&quot;,
<span class="term-fg31">-      &quot;chainId&quot;: &quot;0x7fffffffffffffee&quot;,</span>
<span class="term-fg32">+      &quot;chainId&quot;: &quot;0x1&quot;,</span>
       &quot;v&quot;: &quot;0x0&quot;,
       &quot;r&quot;: &quot;0x0&quot;,
       &quot;s&quot;: &quot;0x0&quot;</div>
    </div>

            
        </div>
        <div>
            
        </div>
    </div>
</div>

            
        </div>
    </div>
</div>

            
                <div class="ps-1 py-2 my-1"><div class="row border-bottom border-1"data-bs-toggle="collapse" data-bs-target="#id-8db853ab8891cfa3a2e7baec"role="button" aria-expanded="false" aria-controls="id-8db853ab8891cfa3a2e7baec">
        
            <div class="col-12 col-sm-9 text-start"><h2>Geth extras</h2></div>
        
        <div class="col-12 col-sm-3 ms-auto mt-2">
            <div class="row line-stat">
                <div class="text-end"><span class="text-success">+102</span></div>
                <div class="text-start"><span class="text-danger">-32</span></div>
            </div>
        </div>
    </div>

    <div class="row forkdef-content collapse  border-1 ps-3 my-3" id="id-8db853ab8891cfa3a2e7baec">
        <div><p>Extend the tools available in geth to improve external testing and tooling.</p>
</div>
        <div>
            
        </div>
        <div>
            
                <div class="ps-1 py-2 my-1"><div class="row border-bottom border-1"data-bs-toggle="collapse" data-bs-target="#id-7c7d5acd4d884a96ade75529"role="button" aria-expanded="false" aria-controls="id-7c7d5acd4d884a96ade75529">
        
            <div class="col-12 col-sm-9 text-start"><h3>Simulated Backend</h3></div>
        
        <div class="col-12 col-sm-3 ms-auto mt-2">
            <div class="row line-stat">
                <div class="text-end"><span class="text-success">+102</span></div>
                <div class="text-start"><span class="text-danger">-32</span></div>
            </div>
        </div>
    </div>

    <div class="row forkdef-content collapse  border-1 ps-3 my-3" id="id-7c7d5acd4d884a96ade75529">
        <div></div>
        <div>
            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-7ae283d1ba2261c852da308d" role="button"
                   aria-expanded="false" aria-controls="id-7ae283d1ba2261c852da308d">
                    <code>accounts/abi/bind/backends/simulated.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/3f40e65c484486dea6cff80b7db178985d21a2c6/accounts/abi/bind/backends/simulated.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/650bb2f2b1dcfe30d9b1fa6f7dc9608055ed60e1/accounts/abi/bind/backends/simulated.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+102</span></div>
                        <div class="text-start"><span class="text-danger">-32</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-7ae283d1ba2261c852da308d"><span class="term-fg1">diff --git go-ethereum&#47;accounts&#47;abi&#47;bind&#47;backends&#47;simulated.go op-geth&#47;accounts&#47;abi&#47;bind&#47;backends&#47;simulated.go</span>
<span class="term-fg1">index 0c4342c4944b7243dc2784acef63b608e6890417..e9b753b6b2be4b5df3221f1ebaa76e33c6ce81dc 100644</span>
<span class="term-fg1">--- go-ethereum&#47;accounts&#47;abi&#47;bind&#47;backends&#47;simulated.go</span>
<span class="term-fg1">+++ op-geth&#47;accounts&#47;abi&#47;bind&#47;backends&#47;simulated.go</span>
<span class="term-fg36">@@ -30,6 +30,7 @@</span> 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;accounts&#47;abi&#47;bind&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;common&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;common&#47;hexutil&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;common&#47;math&quot;
<span class="term-fg32">+	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;consensus&quot;</span>
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;consensus&#47;ethash&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;core&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;core&#47;bloombits&quot;
<span class="term-fg36">@@ -43,6 +44,7 @@</span> 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;event&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;log&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;params&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;rpc&quot;
<span class="term-fg32">+	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;trie&quot;</span>
 )
&nbsp;
 &#47;&#47; This nil assignment ensures at compile time that SimulatedBackend implements bind.ContractBackend.
<span class="term-fg36">@@ -63,6 +65,8 @@</span> type SimulatedBackend struct {
 	database   ethdb.Database   &#47;&#47; In memory database to store our testing data
 	blockchain *core.BlockChain &#47;&#47; Ethereum blockchain to handle the consensus
&nbsp;
<span class="term-fg32">+	consensus consensus.Engine</span>
<span class="term-fg32">+</span>
 	mu              sync.Mutex
 	pendingBlock    *types.Block   &#47;&#47; Currently pending block that will be imported on request
 	pendingState    *state.StateDB &#47;&#47; Currently pending state that will be the active on request
<span class="term-fg36">@@ -78,20 +82,93 @@</span> &#47;&#47; NewSimulatedBackendWithDatabase creates a new binding backend based on the given database
 &#47;&#47; and uses a simulated blockchain for testing purposes.
 &#47;&#47; A simulated backend always uses chainID 1337.
 func NewSimulatedBackendWithDatabase(database ethdb.Database, alloc core.GenesisAlloc, gasLimit uint64) *SimulatedBackend {
<span class="term-fg31">-	genesis := core.Genesis{</span>
<span class="term-fg31">-		Config:   params.AllEthashProtocolChanges,</span>
<span class="term-fg31">-		GasLimit: gasLimit,</span>
<span class="term-fg31">-		Alloc:    alloc,</span>
<span class="term-fg32">+	return NewSimulatedBackendWithOpts(WithDatabase(database), WithAlloc(alloc), WithGasLimit(gasLimit))</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+&#47;&#47; NewSimulatedBackend creates a new binding backend using a simulated blockchain</span>
<span class="term-fg32">+&#47;&#47; for testing purposes.</span>
<span class="term-fg32">+&#47;&#47; A simulated backend always uses chainID 1337.</span>
<span class="term-fg32">+func NewSimulatedBackend(alloc core.GenesisAlloc, gasLimit uint64) *SimulatedBackend {</span>
<span class="term-fg32">+	return NewSimulatedBackendWithOpts(WithGasLimit(gasLimit), WithAlloc(alloc))</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+type simulatedBackendConfig struct {</span>
<span class="term-fg32">+	genesis     core.Genesis</span>
<span class="term-fg32">+	cacheConfig *core.CacheConfig</span>
<span class="term-fg32">+	database    ethdb.Database</span>
<span class="term-fg32">+	vmConfig    vm.Config</span>
<span class="term-fg32">+	consensus   consensus.Engine</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+type SimulatedBackendOpt func(s *simulatedBackendConfig)</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func WithDatabase(database ethdb.Database) SimulatedBackendOpt {</span>
<span class="term-fg32">+	return func(s *simulatedBackendConfig) {</span>
<span class="term-fg32">+		s.database = database</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func WithGasLimit(gasLimit uint64) SimulatedBackendOpt {</span>
<span class="term-fg32">+	return func(s *simulatedBackendConfig) {</span>
<span class="term-fg32">+		s.genesis.GasLimit = gasLimit</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func WithAlloc(alloc core.GenesisAlloc) SimulatedBackendOpt {</span>
<span class="term-fg32">+	return func(s *simulatedBackendConfig) {</span>
<span class="term-fg32">+		s.genesis.Alloc = alloc</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func WithCacheConfig(cacheConfig *core.CacheConfig) SimulatedBackendOpt {</span>
<span class="term-fg32">+	return func(s *simulatedBackendConfig) {</span>
<span class="term-fg32">+		s.cacheConfig = cacheConfig</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func WithGenesis(genesis core.Genesis) SimulatedBackendOpt {</span>
<span class="term-fg32">+	return func(s *simulatedBackendConfig) {</span>
<span class="term-fg32">+		s.genesis = genesis</span>
 	}
<span class="term-fg31">-	blockchain, _ := core.NewBlockChain(database, nil, &amp;genesis, nil, ethash.NewFaker(), vm.Config{}, nil, nil)</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func WithVMConfig(vmConfig vm.Config) SimulatedBackendOpt {</span>
<span class="term-fg32">+	return func(s *simulatedBackendConfig) {</span>
<span class="term-fg32">+		s.vmConfig = vmConfig</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func WithConsensus(consensus consensus.Engine) SimulatedBackendOpt {</span>
<span class="term-fg32">+	return func(s *simulatedBackendConfig) {</span>
<span class="term-fg32">+		s.consensus = consensus</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+&#47;&#47; NewSimulatedBackendWithOpts creates a new binding backend based on the given database</span>
<span class="term-fg32">+&#47;&#47; and uses a simulated blockchain for testing purposes. It exposes additional configuration</span>
<span class="term-fg32">+&#47;&#47; options that are useful to</span>
<span class="term-fg32">+func NewSimulatedBackendWithOpts(opts ...SimulatedBackendOpt) *SimulatedBackend {</span>
<span class="term-fg32">+	config := &amp;simulatedBackendConfig{</span>
<span class="term-fg32">+		genesis:   core.Genesis{Config: params.AllEthashProtocolChanges, GasLimit: 100000000, Alloc: make(core.GenesisAlloc)},</span>
<span class="term-fg32">+		database:  rawdb.NewMemoryDatabase(),</span>
<span class="term-fg32">+		consensus: ethash.NewFaker(),</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	for _, opt := range opts {</span>
<span class="term-fg32">+		opt(config)</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	config.genesis.MustCommit(config.database, trie.NewDatabase(config.database, trie.HashDefaults))</span>
<span class="term-fg32">+	blockchain, _ := core.NewBlockChain(config.database, config.cacheConfig, &amp;config.genesis, nil, config.consensus, config.vmConfig, nil, nil)</span>
&nbsp;
 	backend := &amp;SimulatedBackend{
<span class="term-fg31">-		database:   database,</span>
<span class="term-fg32">+		database:   config.database,</span>
 		blockchain: blockchain,
<span class="term-fg31">-		config:     genesis.Config,</span>
<span class="term-fg32">+		config:     config.genesis.Config,</span>
<span class="term-fg32">+		consensus:  config.consensus,</span>
 	}
&nbsp;
<span class="term-fg31">-	filterBackend := &amp;filterBackend{database, blockchain, backend}</span>
<span class="term-fg32">+	filterBackend := &amp;filterBackend{config.database, blockchain, backend}</span>
 	backend.filterSystem = filters.NewFilterSystem(filterBackend, filters.Config{})
 	backend.events = filters.NewEventSystem(backend.filterSystem, false)
&nbsp;
<span class="term-fg36">@@ -102,13 +179,6 @@</span> 	backend.rollback(block)
 	return backend
 }
&nbsp;
<span class="term-fg31">-&#47;&#47; NewSimulatedBackend creates a new binding backend using a simulated blockchain</span>
<span class="term-fg31">-&#47;&#47; for testing purposes.</span>
<span class="term-fg31">-&#47;&#47; A simulated backend always uses chainID 1337.</span>
<span class="term-fg31">-func NewSimulatedBackend(alloc core.GenesisAlloc, gasLimit uint64) *SimulatedBackend {</span>
<span class="term-fg31">-	return NewSimulatedBackendWithDatabase(rawdb.NewMemoryDatabase(), alloc, gasLimit)</span>
<span class="term-fg31">-}</span>
<span class="term-fg31">-</span>
 &#47;&#47; Close terminates the underlying blockchain&#39;s update loop.
 func (b *SimulatedBackend) Close() error {
 	b.blockchain.Stop()
<span class="term-fg36">@@ -124,6 +194,8 @@</span>
 	if _, err := b.blockchain.InsertChain([]*types.Block{b.pendingBlock}); err != nil {
 		panic(err) &#47;&#47; This cannot happen unless the simulator is wrong, fail in that case
 	}
<span class="term-fg32">+	&#47;&#47; Don&#39;t wait for the async tx indexing</span>
<span class="term-fg32">+	rawdb.WriteTxLookupEntriesByBlock(b.database, b.pendingBlock)</span>
 	blockHash := b.pendingBlock.Hash()
&nbsp;
 	&#47;&#47; Using the last inserted block here makes it possible to build on a side
<span class="term-fg36">@@ -145,7 +217,7 @@</span> 	b.rollback(block)
 }
&nbsp;
 func (b *SimulatedBackend) rollback(parent *types.Block) {
<span class="term-fg31">-	blocks, _ := core.GenerateChain(b.config, parent, ethash.NewFaker(), b.database, 1, func(int, *core.BlockGen) {})</span>
<span class="term-fg32">+	blocks, _ := core.GenerateChain(b.config, parent, b.consensus, b.database, 1, func(int, *core.BlockGen) {})</span>
&nbsp;
 	b.pendingBlock = blocks[0]
 	b.pendingState, _ = state.New(b.pendingBlock.Root(), b.blockchain.StateCache(), nil)
<span class="term-fg36">@@ -199,7 +271,6 @@</span> 	stateDB, err := b.stateByBlockNumber(ctx, blockNumber)
 	if err != nil {
 		return nil, err
 	}
<span class="term-fg31">-</span>
 	return stateDB.GetCode(contract), nil
 }
&nbsp;
<span class="term-fg36">@@ -212,7 +283,6 @@</span> 	stateDB, err := b.stateByBlockNumber(ctx, blockNumber)
 	if err != nil {
 		return nil, err
 	}
<span class="term-fg31">-</span>
 	return stateDB.GetBalance(contract), nil
 }
&nbsp;
<span class="term-fg36">@@ -225,7 +295,6 @@</span> 	stateDB, err := b.stateByBlockNumber(ctx, blockNumber)
 	if err != nil {
 		return 0, err
 	}
<span class="term-fg31">-</span>
 	return stateDB.GetNonce(contract), nil
 }
&nbsp;
<span class="term-fg36">@@ -238,7 +307,6 @@</span> 	stateDB, err := b.stateByBlockNumber(ctx, blockNumber)
 	if err != nil {
 		return nil, err
 	}
<span class="term-fg31">-</span>
 	val := stateDB.GetState(contract, key)
 	return val[:], nil
 }
<span class="term-fg36">@@ -610,8 +678,7 @@</span> 	&#47;&#47; Gas prices post 1559 need to be initialized
 	if call.GasPrice != nil &amp;&amp; (call.GasFeeCap != nil || call.GasTipCap != nil) {
 		return nil, errors.New(&quot;both gasPrice and (maxFeePerGas or maxPriorityFeePerGas) specified&quot;)
 	}
<span class="term-fg31">-	head := b.blockchain.CurrentHeader()</span>
<span class="term-fg31">-	if !b.blockchain.Config().IsLondon(head.Number) {</span>
<span class="term-fg32">+	if !b.blockchain.Config().IsLondon(header.Number) {</span>
 		&#47;&#47; If there&#39;s no basefee, then it must be a non-1559 execution
 		if call.GasPrice == nil {
 			call.GasPrice = new(big.Int)
<span class="term-fg36">@@ -633,13 +700,13 @@</span> 			}
 			&#47;&#47; Backfill the legacy gasPrice for EVM execution, unless we&#39;re all zeroes
 			call.GasPrice = new(big.Int)
 			if call.GasFeeCap.BitLen() &gt; 0 || call.GasTipCap.BitLen() &gt; 0 {
<span class="term-fg31">-				call.GasPrice = math.BigMin(new(big.Int).Add(call.GasTipCap, head.BaseFee), call.GasFeeCap)</span>
<span class="term-fg32">+				call.GasPrice = math.BigMin(new(big.Int).Add(call.GasTipCap, header.BaseFee), call.GasFeeCap)</span>
 			}
 		}
 	}
 	&#47;&#47; Ensure message is initialized properly.
 	if call.Gas == 0 {
<span class="term-fg31">-		call.Gas = 50000000</span>
<span class="term-fg32">+		call.Gas = 10 * header.GasLimit</span>
 	}
 	if call.Value == nil {
 		call.Value = new(big.Int)
<span class="term-fg36">@@ -666,7 +733,7 @@</span>
 	&#47;&#47; Create a new environment which holds all relevant information
 	&#47;&#47; about the transaction and calling mechanisms.
 	txContext := core.NewEVMTxContext(msg)
<span class="term-fg31">-	evmContext := core.NewEVMBlockContext(header, b.blockchain, nil)</span>
<span class="term-fg32">+	evmContext := core.NewEVMBlockContext(header, b.blockchain, nil, b.config, stateDB)</span>
 	vmEnv := vm.NewEVM(evmContext, txContext, stateDB, b.config, vm.Config{NoBaseFee: true})
 	gasPool := new(core.GasPool).AddGas(math.MaxUint64)
&nbsp;
<span class="term-fg36">@@ -694,14 +761,16 @@</span> 	if tx.Nonce() != nonce {
 		return fmt.Errorf(&quot;invalid transaction nonce: got %d, want %d&quot;, tx.Nonce(), nonce)
 	}
 	&#47;&#47; Include tx in chain
<span class="term-fg31">-	blocks, receipts := core.GenerateChain(b.config, block, ethash.NewFaker(), b.database, 1, func(number int, block *core.BlockGen) {</span>
<span class="term-fg32">+	blocks, receipts := core.GenerateChain(b.config, block, b.consensus, b.database, 1, func(number int, block *core.BlockGen) {</span>
 		for _, tx := range b.pendingBlock.Transactions() {
 			block.AddTxWithChain(b.blockchain, tx)
 		}
 		block.AddTxWithChain(b.blockchain, tx)
 	})
<span class="term-fg31">-	stateDB, _ := b.blockchain.State()</span>
<span class="term-fg31">-</span>
<span class="term-fg32">+	stateDB, err := b.blockchain.State()</span>
<span class="term-fg32">+	if err != nil {</span>
<span class="term-fg32">+		return err</span>
<span class="term-fg32">+	}</span>
 	b.pendingBlock = blocks[0]
 	b.pendingState, _ = state.New(b.pendingBlock.Root(), stateDB.Database(), nil)
 	b.pendingReceipts = receipts[0]
<span class="term-fg36">@@ -818,14 +887,15 @@</span> 	if block == nil {
 		return errors.New(&quot;could not find parent&quot;)
 	}
&nbsp;
<span class="term-fg31">-	blocks, _ := core.GenerateChain(b.config, block, ethash.NewFaker(), b.database, 1, func(number int, block *core.BlockGen) {</span>
<span class="term-fg32">+	blocks, _ := core.GenerateChain(b.config, block, b.consensus, b.database, 1, func(number int, block *core.BlockGen) {</span>
 		block.OffsetTime(int64(adjustment.Seconds()))
 	})
<span class="term-fg31">-	stateDB, _ := b.blockchain.State()</span>
<span class="term-fg31">-</span>
<span class="term-fg32">+	stateDB, err := b.blockchain.State()</span>
<span class="term-fg32">+	if err != nil {</span>
<span class="term-fg32">+		return err</span>
<span class="term-fg32">+	}</span>
 	b.pendingBlock = blocks[0]
 	b.pendingState, _ = state.New(b.pendingBlock.Root(), stateDB.Database(), nil)
<span class="term-fg31">-</span>
 	return nil
 }
</div>
    </div>

            
        </div>
        <div>
            
        </div>
    </div>
</div>

            
        </div>
    </div>
</div>

            
                <div class="ps-1 py-2 my-1"><div class="row border-bottom border-1"data-bs-toggle="collapse" data-bs-target="#id-78795910f604fe35f19e03ca"role="button" aria-expanded="false" aria-controls="id-78795910f604fe35f19e03ca">
        
            <div class="col-12 col-sm-9 text-start"><h2>Other changes</h2></div>
        
        <div class="col-12 col-sm-3 ms-auto mt-2">
            <div class="row line-stat">
                <div class="text-end"><span class="text-success">+4235</span></div>
                <div class="text-start"><span class="text-danger">-2056</span></div>
            </div>
        </div>
    </div>

    <div class="row forkdef-content collapse  border-1 ps-3 my-3" id="id-78795910f604fe35f19e03ca">
        <div></div>
        <div>
            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-994373330325f87058f5a222" role="button"
                   aria-expanded="false" aria-controls="id-994373330325f87058f5a222">
                    <code>.gitignore</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/3f40e65c484486dea6cff80b7db178985d21a2c6/.gitignore" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/650bb2f2b1dcfe30d9b1fa6f7dc9608055ed60e1/.gitignore" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+3</span></div>
                        <div class="text-start"><span class="text-danger">-0</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-994373330325f87058f5a222"><span class="term-fg1">diff --git go-ethereum&#47;.gitignore op-geth&#47;.gitignore</span>
<span class="term-fg1">index e24e1d1677098fe7310f7adad5ecc8500236b44f..3f27cdc00f0746c28f7e79285a50425f435bd0ef 100644</span>
<span class="term-fg1">--- go-ethereum&#47;.gitignore</span>
<span class="term-fg1">+++ op-geth&#47;.gitignore</span>
<span class="term-fg36">@@ -47,4 +47,6 @@</span> &#47;dashboard&#47;assets&#47;bundle.js.map
 &#47;dashboard&#47;assets&#47;package-lock.json
&nbsp;
 **&#47;yarn-error.log
<span class="term-fg31">-logs&#47;</span>
<span class="term-fg31">\ No newline at end of file</span>
<span class="term-fg32">+logs&#47;</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+tests&#47;spec-tests&#47;</span></div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-4234cf9cadac75d006ace1ae" role="button"
                   aria-expanded="false" aria-controls="id-4234cf9cadac75d006ace1ae">
                    <code>Makefile</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/3f40e65c484486dea6cff80b7db178985d21a2c6/Makefile" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/650bb2f2b1dcfe30d9b1fa6f7dc9608055ed60e1/Makefile" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+6</span></div>
                        <div class="text-start"><span class="text-danger">-0</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-4234cf9cadac75d006ace1ae"><span class="term-fg1">diff --git go-ethereum&#47;Makefile op-geth&#47;Makefile</span>
<span class="term-fg1">index d736ef61c001ec02581a6867982291cdf684b3ab..226bac2d1e1b87b26dd70989b37e32117a1837fe 100644</span>
<span class="term-fg1">--- go-ethereum&#47;Makefile</span>
<span class="term-fg1">+++ op-geth&#47;Makefile</span>
<span class="term-fg36">@@ -36,3 +36,9 @@</span> 	env GOBIN= go install github.com&#47;golang&#47;protobuf&#47;protoc-gen-go@latest
 	env GOBIN= go install .&#47;cmd&#47;abigen
 	@type &quot;solc&quot; 2&gt; &#47;dev&#47;null || echo &#39;Please install solc&#39;
 	@type &quot;protoc&quot; 2&gt; &#47;dev&#47;null || echo &#39;Please install protoc&#39;
<span class="term-fg32">+</span>
<span class="term-fg32">+forkdiff:</span>
<span class="term-fg32">+	docker run --rm \</span>
<span class="term-fg32">+		--mount src=$(shell pwd),target=&#47;host-pwd,type=bind \</span>
<span class="term-fg32">+		protolambda&#47;forkdiff:latest \</span>
<span class="term-fg32">+		-repo &#47;host-pwd&#47; -fork &#47;host-pwd&#47;fork.yaml -out &#47;host-pwd&#47;forkdiff.html</span></div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-bde17d275bf97c7af4958dab" role="button"
                   aria-expanded="false" aria-controls="id-bde17d275bf97c7af4958dab">
                    <code>accounts/keystore/watch.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/3f40e65c484486dea6cff80b7db178985d21a2c6/accounts/keystore/watch.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/650bb2f2b1dcfe30d9b1fa6f7dc9608055ed60e1/accounts/keystore/watch.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+4</span></div>
                        <div class="text-start"><span class="text-danger">-1</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-bde17d275bf97c7af4958dab"><span class="term-fg1">diff --git go-ethereum&#47;accounts&#47;keystore&#47;watch.go op-geth&#47;accounts&#47;keystore&#47;watch.go</span>
<span class="term-fg1">index 3f64b89c585e57135b71d1f4cfaddb79124b8ad2..a9f87e7c323e11ed47b603776f737d756400aae2 100644</span>
<span class="term-fg1">--- go-ethereum&#47;accounts&#47;keystore&#47;watch.go</span>
<span class="term-fg1">+++ op-geth&#47;accounts&#47;keystore&#47;watch.go</span>
<span class="term-fg36">@@ -20,6 +20,7 @@</span>
 package keystore
&nbsp;
 import (
<span class="term-fg32">+	&quot;os&quot;</span>
 	&quot;time&quot;
&nbsp;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;log&quot;
<span class="term-fg36">@@ -77,7 +78,9 @@</span> 		return
 	}
 	defer watcher.Close()
 	if err := watcher.Add(w.ac.keydir); err != nil {
<span class="term-fg31">-		logger.Warn(&quot;Failed to watch keystore folder&quot;, &quot;err&quot;, err)</span>
<span class="term-fg32">+		if !os.IsNotExist(err) {</span>
<span class="term-fg32">+			logger.Warn(&quot;Failed to watch keystore folder&quot;, &quot;err&quot;, err)</span>
<span class="term-fg32">+		}</span>
 		return
 	}
</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-2d7805417c149bf24adc736a" role="button"
                   aria-expanded="false" aria-controls="id-2d7805417c149bf24adc736a">
                    <code>accounts/scwallet/README.md</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/3f40e65c484486dea6cff80b7db178985d21a2c6/accounts/scwallet/README.md" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/650bb2f2b1dcfe30d9b1fa6f7dc9608055ed60e1/accounts/scwallet/README.md" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+1</span></div>
                        <div class="text-start"><span class="text-danger">-1</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-2d7805417c149bf24adc736a"><span class="term-fg1">diff --git go-ethereum&#47;accounts&#47;scwallet&#47;README.md op-geth&#47;accounts&#47;scwallet&#47;README.md</span>
<span class="term-fg1">index 4313d9c6b2f8ecacf53657409572f53e482bbbe4..28079c47435cffb174136638572c225c19a8d840 100644</span>
<span class="term-fg1">--- go-ethereum&#47;accounts&#47;scwallet&#47;README.md</span>
<span class="term-fg1">+++ op-geth&#47;accounts&#47;scwallet&#47;README.md</span>
<span class="term-fg36">@@ -8,7 +8,7 @@</span>   * PCSCD version 4.3 running on your system **Only version 4.3 is currently supported**
&nbsp;
 ## Preparing the smartcard
&nbsp;
<span class="term-fg31">-  **WARNING: FOILLOWING THESE INSTRUCTIONS WILL DESTROY THE MASTER KEY ON YOUR CARD. ONLY PROCEED IF NO FUNDS ARE ASSOCIATED WITH THESE ACCOUNTS**</span>
<span class="term-fg32">+  **WARNING: FOLLOWING THESE INSTRUCTIONS WILL DESTROY THE MASTER KEY ON YOUR CARD. ONLY PROCEED IF NO FUNDS ARE ASSOCIATED WITH THESE ACCOUNTS**</span>
&nbsp;
   You can use status&#39; [keycard-cli](https:&#47;&#47;github.com&#47;status-im&#47;keycard-cli) and you should get _at least_ version 2.1.1 of their [smartcard application](https:&#47;&#47;github.com&#47;status-im&#47;status-keycard&#47;releases&#47;download&#47;2.2.1&#47;keycard_v2.2.1.cap)
</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-4582c4b8c0e7da8c72888a01" role="button"
                   aria-expanded="false" aria-controls="id-4582c4b8c0e7da8c72888a01">
                    <code>cmd/devp2p/crawl.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/3f40e65c484486dea6cff80b7db178985d21a2c6/cmd/devp2p/crawl.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/650bb2f2b1dcfe30d9b1fa6f7dc9608055ed60e1/cmd/devp2p/crawl.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+10</span></div>
                        <div class="text-start"><span class="text-danger">-2</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-4582c4b8c0e7da8c72888a01"><span class="term-fg1">diff --git go-ethereum&#47;cmd&#47;devp2p&#47;crawl.go op-geth&#47;cmd&#47;devp2p&#47;crawl.go</span>
<span class="term-fg1">index 8c0defff6d544e022ad168b5d9dad4b960871f13..4288a5feb897ba725fac3d1789f4ce2b1c92d319 100644</span>
<span class="term-fg1">--- go-ethereum&#47;cmd&#47;devp2p&#47;crawl.go</span>
<span class="term-fg1">+++ op-geth&#47;cmd&#47;devp2p&#47;crawl.go</span>
<span class="term-fg36">@@ -17,6 +17,7 @@</span>
 package main
&nbsp;
 import (
<span class="term-fg32">+	&quot;errors&quot;</span>
 	&quot;sync&quot;
 	&quot;sync&#47;atomic&quot;
 	&quot;time&quot;
<span class="term-fg36">@@ -51,7 +52,14 @@</span> type resolver interface {
 	RequestENR(*enode.Node) (*enode.Node, error)
 }
&nbsp;
<span class="term-fg31">-func newCrawler(input nodeSet, disc resolver, iters ...enode.Iterator) *crawler {</span>
<span class="term-fg32">+func newCrawler(input nodeSet, bootnodes []*enode.Node, disc resolver, iters ...enode.Iterator) (*crawler, error) {</span>
<span class="term-fg32">+	if len(input) == 0 {</span>
<span class="term-fg32">+		input.add(bootnodes...)</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	if len(input) == 0 {</span>
<span class="term-fg32">+		return nil, errors.New(&quot;no input nodes to start crawling&quot;)</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+</span>
 	c := &amp;crawler{
 		input:     input,
 		output:    make(nodeSet, len(input)),
<span class="term-fg36">@@ -67,7 +75,7 @@</span> 	&#47;&#47; will be dropped from output during the run.
 	for id, n := range input {
 		c.output[id] = n
 	}
<span class="term-fg31">-	return c</span>
<span class="term-fg32">+	return c, nil</span>
 }
&nbsp;
 func (c *crawler) run(timeout time.Duration, nthreads int) nodeSet {</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-eccc1214b82a81048a9a13b9" role="button"
                   aria-expanded="false" aria-controls="id-eccc1214b82a81048a9a13b9">
                    <code>cmd/devp2p/discv4cmd.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/3f40e65c484486dea6cff80b7db178985d21a2c6/cmd/devp2p/discv4cmd.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/650bb2f2b1dcfe30d9b1fa6f7dc9608055ed60e1/cmd/devp2p/discv4cmd.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+18</span></div>
                        <div class="text-start"><span class="text-danger">-11</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-eccc1214b82a81048a9a13b9"><span class="term-fg1">diff --git go-ethereum&#47;cmd&#47;devp2p&#47;discv4cmd.go op-geth&#47;cmd&#47;devp2p&#47;discv4cmd.go</span>
<span class="term-fg1">index 0117c7eb827f4c825555785bf08529ef3d8156cb..37b139dea2927aca353d9cc39b71f1cedfc39e7c 100644</span>
<span class="term-fg1">--- go-ethereum&#47;cmd&#47;devp2p&#47;discv4cmd.go</span>
<span class="term-fg1">+++ op-geth&#47;cmd&#47;devp2p&#47;discv4cmd.go</span>
<span class="term-fg36">@@ -143,7 +143,7 @@</span> }
&nbsp;
 func discv4Ping(ctx *cli.Context) error {
 	n := getNodeArg(ctx)
<span class="term-fg31">-	disc := startV4(ctx)</span>
<span class="term-fg32">+	disc, _ := startV4(ctx)</span>
 	defer disc.Close()
&nbsp;
 	start := time.Now()
<span class="term-fg36">@@ -156,7 +156,7 @@</span> }
&nbsp;
 func discv4RequestRecord(ctx *cli.Context) error {
 	n := getNodeArg(ctx)
<span class="term-fg31">-	disc := startV4(ctx)</span>
<span class="term-fg32">+	disc, _ := startV4(ctx)</span>
 	defer disc.Close()
&nbsp;
 	respN, err := disc.RequestENR(n)
<span class="term-fg36">@@ -169,7 +169,7 @@</span> }
&nbsp;
 func discv4Resolve(ctx *cli.Context) error {
 	n := getNodeArg(ctx)
<span class="term-fg31">-	disc := startV4(ctx)</span>
<span class="term-fg32">+	disc, _ := startV4(ctx)</span>
 	defer disc.Close()
&nbsp;
 	fmt.Println(disc.Resolve(n).String())
<span class="term-fg36">@@ -196,10 +196,13 @@</span> 		}
 		nodeargs = append(nodeargs, n)
 	}
&nbsp;
<span class="term-fg31">-	&#47;&#47; Run the crawler.</span>
<span class="term-fg31">-	disc := startV4(ctx)</span>
<span class="term-fg32">+	disc, config := startV4(ctx)</span>
 	defer disc.Close()
<span class="term-fg31">-	c := newCrawler(inputSet, disc, enode.IterNodes(nodeargs))</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	c, err := newCrawler(inputSet, config.Bootnodes, disc, enode.IterNodes(nodeargs))</span>
<span class="term-fg32">+	if err != nil {</span>
<span class="term-fg32">+		return err</span>
<span class="term-fg32">+	}</span>
 	c.revalidateInterval = 0
 	output := c.run(0, 1)
 	writeNodesJSON(nodesFile, output)
<span class="term-fg36">@@ -211,14 +214,18 @@</span> 	if ctx.NArg() &lt; 1 {
 		return errors.New(&quot;need nodes file as argument&quot;)
 	}
 	nodesFile := ctx.Args().First()
<span class="term-fg31">-	var inputSet nodeSet</span>
<span class="term-fg32">+	inputSet := make(nodeSet)</span>
 	if common.FileExist(nodesFile) {
 		inputSet = loadNodesJSON(nodesFile)
 	}
&nbsp;
<span class="term-fg31">-	disc := startV4(ctx)</span>
<span class="term-fg32">+	disc, config := startV4(ctx)</span>
 	defer disc.Close()
<span class="term-fg31">-	c := newCrawler(inputSet, disc, disc.RandomNodes())</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	c, err := newCrawler(inputSet, config.Bootnodes, disc, disc.RandomNodes())</span>
<span class="term-fg32">+	if err != nil {</span>
<span class="term-fg32">+		return err</span>
<span class="term-fg32">+	}</span>
 	c.revalidateInterval = 10 * time.Minute
 	output := c.run(ctx.Duration(crawlTimeoutFlag.Name), ctx.Int(crawlParallelismFlag.Name))
 	writeNodesJSON(nodesFile, output)
<span class="term-fg36">@@ -238,14 +245,14 @@</span> 	return runTests(ctx, v4test.AllTests)
 }
&nbsp;
 &#47;&#47; startV4 starts an ephemeral discovery V4 node.
<span class="term-fg31">-func startV4(ctx *cli.Context) *discover.UDPv4 {</span>
<span class="term-fg32">+func startV4(ctx *cli.Context) (*discover.UDPv4, discover.Config) {</span>
 	ln, config := makeDiscoveryConfig(ctx)
 	socket := listen(ctx, ln)
 	disc, err := discover.ListenV4(socket, ln, config)
 	if err != nil {
 		exit(err)
 	}
<span class="term-fg31">-	return disc</span>
<span class="term-fg32">+	return disc, config</span>
 }
&nbsp;
 func makeDiscoveryConfig(ctx *cli.Context) (*enode.LocalNode, discover.Config) {</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-a5c4a3af59a4a64cdf732fc2" role="button"
                   aria-expanded="false" aria-controls="id-a5c4a3af59a4a64cdf732fc2">
                    <code>cmd/devp2p/discv5cmd.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/3f40e65c484486dea6cff80b7db178985d21a2c6/cmd/devp2p/discv5cmd.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/650bb2f2b1dcfe30d9b1fa6f7dc9608055ed60e1/cmd/devp2p/discv5cmd.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+12</span></div>
                        <div class="text-start"><span class="text-danger">-8</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-a5c4a3af59a4a64cdf732fc2"><span class="term-fg1">diff --git go-ethereum&#47;cmd&#47;devp2p&#47;discv5cmd.go op-geth&#47;cmd&#47;devp2p&#47;discv5cmd.go</span>
<span class="term-fg1">index c5e226f0d1fa5ee543d39475a7d41f7479d25f32..0dac94526971f9e230fb7a909a1418667a3e200b 100644</span>
<span class="term-fg1">--- go-ethereum&#47;cmd&#47;devp2p&#47;discv5cmd.go</span>
<span class="term-fg1">+++ op-geth&#47;cmd&#47;devp2p&#47;discv5cmd.go</span>
<span class="term-fg36">@@ -81,7 +81,7 @@</span> )
&nbsp;
 func discv5Ping(ctx *cli.Context) error {
 	n := getNodeArg(ctx)
<span class="term-fg31">-	disc := startV5(ctx)</span>
<span class="term-fg32">+	disc, _ := startV5(ctx)</span>
 	defer disc.Close()
&nbsp;
 	fmt.Println(disc.Ping(n))
<span class="term-fg36">@@ -90,7 +90,7 @@</span> }
&nbsp;
 func discv5Resolve(ctx *cli.Context) error {
 	n := getNodeArg(ctx)
<span class="term-fg31">-	disc := startV5(ctx)</span>
<span class="term-fg32">+	disc, _ := startV5(ctx)</span>
 	defer disc.Close()
&nbsp;
 	fmt.Println(disc.Resolve(n))
<span class="term-fg36">@@ -102,14 +102,18 @@</span> 	if ctx.NArg() &lt; 1 {
 		return errors.New(&quot;need nodes file as argument&quot;)
 	}
 	nodesFile := ctx.Args().First()
<span class="term-fg31">-	var inputSet nodeSet</span>
<span class="term-fg32">+	inputSet := make(nodeSet)</span>
 	if common.FileExist(nodesFile) {
 		inputSet = loadNodesJSON(nodesFile)
 	}
&nbsp;
<span class="term-fg31">-	disc := startV5(ctx)</span>
<span class="term-fg32">+	disc, config := startV5(ctx)</span>
 	defer disc.Close()
<span class="term-fg31">-	c := newCrawler(inputSet, disc, disc.RandomNodes())</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	c, err := newCrawler(inputSet, config.Bootnodes, disc, disc.RandomNodes())</span>
<span class="term-fg32">+	if err != nil {</span>
<span class="term-fg32">+		return err</span>
<span class="term-fg32">+	}</span>
 	c.revalidateInterval = 10 * time.Minute
 	output := c.run(ctx.Duration(crawlTimeoutFlag.Name), ctx.Int(crawlParallelismFlag.Name))
 	writeNodesJSON(nodesFile, output)
<span class="term-fg36">@@ -127,7 +131,7 @@</span> 	return runTests(ctx, suite.AllTests())
 }
&nbsp;
 func discv5Listen(ctx *cli.Context) error {
<span class="term-fg31">-	disc := startV5(ctx)</span>
<span class="term-fg32">+	disc, _ := startV5(ctx)</span>
 	defer disc.Close()
&nbsp;
 	fmt.Println(disc.Self())
<span class="term-fg36">@@ -135,12 +139,12 @@</span> 	select {}
 }
&nbsp;
 &#47;&#47; startV5 starts an ephemeral discovery v5 node.
<span class="term-fg31">-func startV5(ctx *cli.Context) *discover.UDPv5 {</span>
<span class="term-fg32">+func startV5(ctx *cli.Context) (*discover.UDPv5, discover.Config) {</span>
 	ln, config := makeDiscoveryConfig(ctx)
 	socket := listen(ctx, ln)
 	disc, err := discover.ListenV5(socket, ln, config)
 	if err != nil {
 		exit(err)
 	}
<span class="term-fg31">-	return disc</span>
<span class="term-fg32">+	return disc, config</span>
 }</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-cf7f01605acfcec3705345a4" role="button"
                   aria-expanded="false" aria-controls="id-cf7f01605acfcec3705345a4">
                    <code>cmd/devp2p/internal/ethtest/chain_test.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/3f40e65c484486dea6cff80b7db178985d21a2c6/cmd/devp2p/internal/ethtest/chain_test.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/650bb2f2b1dcfe30d9b1fa6f7dc9608055ed60e1/cmd/devp2p/internal/ethtest/chain_test.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+3</span></div>
                        <div class="text-start"><span class="text-danger">-3</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-cf7f01605acfcec3705345a4"><span class="term-fg1">diff --git go-ethereum&#47;cmd&#47;devp2p&#47;internal&#47;ethtest&#47;chain_test.go op-geth&#47;cmd&#47;devp2p&#47;internal&#47;ethtest&#47;chain_test.go</span>
<span class="term-fg1">index 67221923a684441973f2926301e570871136f542..de6acfdcda676c4b1d16b87d889cdfac3665b024 100644</span>
<span class="term-fg1">--- go-ethereum&#47;cmd&#47;devp2p&#47;internal&#47;ethtest&#47;chain_test.go</span>
<span class="term-fg1">+++ op-geth&#47;cmd&#47;devp2p&#47;internal&#47;ethtest&#47;chain_test.go</span>
<span class="term-fg36">@@ -145,7 +145,7 @@</span> 		expected []*types.Header
 	}{
 		{
 			req: GetBlockHeaders{
<span class="term-fg31">-				GetBlockHeadersPacket: &amp;eth.GetBlockHeadersPacket{</span>
<span class="term-fg32">+				GetBlockHeadersRequest: &amp;eth.GetBlockHeadersRequest{</span>
 					Origin:  eth.HashOrNumber{Number: uint64(2)},
 					Amount:  uint64(5),
 					Skip:    1,
<span class="term-fg36">@@ -162,7 +162,7 @@</span> 			},
 		},
 		{
 			req: GetBlockHeaders{
<span class="term-fg31">-				GetBlockHeadersPacket: &amp;eth.GetBlockHeadersPacket{</span>
<span class="term-fg32">+				GetBlockHeadersRequest: &amp;eth.GetBlockHeadersRequest{</span>
 					Origin:  eth.HashOrNumber{Number: uint64(chain.Len() - 1)},
 					Amount:  uint64(3),
 					Skip:    0,
<span class="term-fg36">@@ -177,7 +177,7 @@</span> 			},
 		},
 		{
 			req: GetBlockHeaders{
<span class="term-fg31">-				GetBlockHeadersPacket: &amp;eth.GetBlockHeadersPacket{</span>
<span class="term-fg32">+				GetBlockHeadersRequest: &amp;eth.GetBlockHeadersRequest{</span>
 					Origin:  eth.HashOrNumber{Hash: chain.Head().Hash()},
 					Amount:  uint64(1),
 					Skip:    0,</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-5c3808f023ef15842e2c0aba" role="button"
                   aria-expanded="false" aria-controls="id-5c3808f023ef15842e2c0aba">
                    <code>cmd/devp2p/internal/ethtest/helpers.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/3f40e65c484486dea6cff80b7db178985d21a2c6/cmd/devp2p/internal/ethtest/helpers.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/650bb2f2b1dcfe30d9b1fa6f7dc9608055ed60e1/cmd/devp2p/internal/ethtest/helpers.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+6</span></div>
                        <div class="text-start"><span class="text-danger">-7</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-5c3808f023ef15842e2c0aba"><span class="term-fg1">diff --git go-ethereum&#47;cmd&#47;devp2p&#47;internal&#47;ethtest&#47;helpers.go op-geth&#47;cmd&#47;devp2p&#47;internal&#47;ethtest&#47;helpers.go</span>
<span class="term-fg1">index bc901bdeb01392410dc99c824023f4be80318279..a0339b88cbe4ebcc161fc94b8e2bb889e2e80f19 100644</span>
<span class="term-fg1">--- go-ethereum&#47;cmd&#47;devp2p&#47;internal&#47;ethtest&#47;helpers.go</span>
<span class="term-fg1">+++ op-geth&#47;cmd&#47;devp2p&#47;internal&#47;ethtest&#47;helpers.go</span>
<span class="term-fg36">@@ -62,7 +62,6 @@</span> 		return nil, err
 	}
 	&#47;&#47; set default p2p capabilities
 	conn.caps = []p2p.Cap{
<span class="term-fg31">-		{Name: &quot;eth&quot;, Version: 66},</span>
 		{Name: &quot;eth&quot;, Version: 67},
 		{Name: &quot;eth&quot;, Version: 68},
 	}
<span class="term-fg36">@@ -237,8 +236,8 @@</span> 			if err != nil {
 				return errorf(&quot;could not get headers for inbound header request: %v&quot;, err)
 			}
 			resp := &amp;BlockHeaders{
<span class="term-fg31">-				RequestId:          msg.ReqID(),</span>
<span class="term-fg31">-				BlockHeadersPacket: eth.BlockHeadersPacket(headers),</span>
<span class="term-fg32">+				RequestId:           msg.ReqID(),</span>
<span class="term-fg32">+				BlockHeadersRequest: eth.BlockHeadersRequest(headers),</span>
 			}
 			if err := c.Write(resp); err != nil {
 				return errorf(&quot;could not write to connection: %v&quot;, err)
<span class="term-fg36">@@ -267,7 +266,7 @@</span> 	resp, ok := msg.(*BlockHeaders)
 	if !ok {
 		return nil, fmt.Errorf(&quot;unexpected message received: %s&quot;, pretty.Sdump(msg))
 	}
<span class="term-fg31">-	headers := []*types.Header(resp.BlockHeadersPacket)</span>
<span class="term-fg32">+	headers := []*types.Header(resp.BlockHeadersRequest)</span>
 	return headers, nil
 }
&nbsp;
<span class="term-fg36">@@ -379,7 +378,7 @@</span> 	defer conn.SetReadDeadline(time.Time{})
 	conn.SetReadDeadline(time.Now().Add(20 * time.Second))
 	&#47;&#47; create request
 	req := &amp;GetBlockHeaders{
<span class="term-fg31">-		GetBlockHeadersPacket: &amp;eth.GetBlockHeadersPacket{</span>
<span class="term-fg32">+		GetBlockHeadersRequest: &amp;eth.GetBlockHeadersRequest{</span>
 			Origin: eth.HashOrNumber{Hash: block.Hash()},
 			Amount: 1,
 		},
<span class="term-fg36">@@ -604,8 +603,8 @@</span> 			pretty.Sdump(announcement),
 			pretty.Sdump(blockHeaderReq))
 	}
 	err = sendConn.Write(&amp;BlockHeaders{
<span class="term-fg31">-		RequestId:          blockHeaderReq.ReqID(),</span>
<span class="term-fg31">-		BlockHeadersPacket: eth.BlockHeadersPacket{nextBlock.Header()},</span>
<span class="term-fg32">+		RequestId:           blockHeaderReq.ReqID(),</span>
<span class="term-fg32">+		BlockHeadersRequest: eth.BlockHeadersRequest{nextBlock.Header()},</span>
 	})
 	if err != nil {
 		return fmt.Errorf(&quot;failed to write to connection: %v&quot;, err)</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-e61058754710b75b1c63e226" role="button"
                   aria-expanded="false" aria-controls="id-e61058754710b75b1c63e226">
                    <code>cmd/devp2p/internal/ethtest/snap.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/3f40e65c484486dea6cff80b7db178985d21a2c6/cmd/devp2p/internal/ethtest/snap.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/650bb2f2b1dcfe30d9b1fa6f7dc9608055ed60e1/cmd/devp2p/internal/ethtest/snap.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+5</span></div>
                        <div class="text-start"><span class="text-danger">-5</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-e61058754710b75b1c63e226"><span class="term-fg1">diff --git go-ethereum&#47;cmd&#47;devp2p&#47;internal&#47;ethtest&#47;snap.go op-geth&#47;cmd&#47;devp2p&#47;internal&#47;ethtest&#47;snap.go</span>
<span class="term-fg1">index f947e4bc9bae791bc1a0058fcadf7fae094632b8..cadcad905e3028f48b79c344105c1d5535e8f39c 100644</span>
<span class="term-fg1">--- go-ethereum&#47;cmd&#47;devp2p&#47;internal&#47;ethtest&#47;snap.go</span>
<span class="term-fg1">+++ op-geth&#47;cmd&#47;devp2p&#47;internal&#47;ethtest&#47;snap.go</span>
<span class="term-fg36">@@ -27,8 +27,8 @@</span> 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;core&#47;types&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;crypto&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;eth&#47;protocols&#47;snap&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;internal&#47;utesting&quot;
<span class="term-fg31">-	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;light&quot;</span>
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;trie&quot;
<span class="term-fg32">+	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;trie&#47;trienode&quot;</span>
 	&quot;golang.org&#47;x&#47;crypto&#47;sha3&quot;
 )
&nbsp;
<span class="term-fg36">@@ -249,11 +249,11 @@</span> 	for i, tc := range []byteCodesTest{
 		&#47;&#47; A few stateroots
 		{
 			nBytes: 10000, hashes: []common.Hash{s.chain.RootAt(0), s.chain.RootAt(999)},
<span class="term-fg31">-			expHashes: 0,</span>
<span class="term-fg32">+			expHashes: 1, &#47;&#47; 32-byte keys are detected as code, even if not code (like genesis hash), in legacy lookups.</span>
 		},
 		{
 			nBytes: 10000, hashes: []common.Hash{s.chain.RootAt(0), s.chain.RootAt(0)},
<span class="term-fg31">-			expHashes: 0,</span>
<span class="term-fg32">+			expHashes: 2, &#47;&#47; 32-byte keys are detected as code, even if not code (like genesis hash), in legacy lookups.</span>
 		},
 		&#47;&#47; Empties
 		{
<span class="term-fg36">@@ -530,11 +530,11 @@</span> 	keys := make([][]byte, len(hashes))
 	for i, key := range hashes {
 		keys[i] = common.CopyBytes(key[:])
 	}
<span class="term-fg31">-	nodes := make(light.NodeList, len(proof))</span>
<span class="term-fg32">+	nodes := make(trienode.ProofList, len(proof))</span>
 	for i, node := range proof {
 		nodes[i] = node
 	}
<span class="term-fg31">-	proofdb := nodes.NodeSet()</span>
<span class="term-fg32">+	proofdb := nodes.Set()</span>
&nbsp;
 	var end []byte
 	if len(keys) &gt; 0 {</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-0d171c58abffd1bd6c3f91c4" role="button"
                   aria-expanded="false" aria-controls="id-0d171c58abffd1bd6c3f91c4">
                    <code>cmd/devp2p/internal/ethtest/suite.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/3f40e65c484486dea6cff80b7db178985d21a2c6/cmd/devp2p/internal/ethtest/suite.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/650bb2f2b1dcfe30d9b1fa6f7dc9608055ed60e1/cmd/devp2p/internal/ethtest/suite.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+19</span></div>
                        <div class="text-start"><span class="text-danger">-19</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-0d171c58abffd1bd6c3f91c4"><span class="term-fg1">diff --git go-ethereum&#47;cmd&#47;devp2p&#47;internal&#47;ethtest&#47;suite.go op-geth&#47;cmd&#47;devp2p&#47;internal&#47;ethtest&#47;suite.go</span>
<span class="term-fg1">index 815353be72650c6aa871f80db76536eb60507ad6..0b56c8cf4b6f7be5fd6fec788c85705aefe04c8f 100644</span>
<span class="term-fg1">--- go-ethereum&#47;cmd&#47;devp2p&#47;internal&#47;ethtest&#47;suite.go</span>
<span class="term-fg1">+++ op-geth&#47;cmd&#47;devp2p&#47;internal&#47;ethtest&#47;suite.go</span>
<span class="term-fg36">@@ -112,7 +112,7 @@</span> 		t.Fatalf(&quot;peering failed: %v&quot;, err)
 	}
 	&#47;&#47; write request
 	req := &amp;GetBlockHeaders{
<span class="term-fg31">-		GetBlockHeadersPacket: &amp;eth.GetBlockHeadersPacket{</span>
<span class="term-fg32">+		GetBlockHeadersRequest: &amp;eth.GetBlockHeadersRequest{</span>
 			Origin:  eth.HashOrNumber{Hash: s.chain.blocks[1].Hash()},
 			Amount:  2,
 			Skip:    1,
<span class="term-fg36">@@ -150,7 +150,7 @@</span>
 	&#47;&#47; create two requests
 	req1 := &amp;GetBlockHeaders{
 		RequestId: uint64(111),
<span class="term-fg31">-		GetBlockHeadersPacket: &amp;eth.GetBlockHeadersPacket{</span>
<span class="term-fg32">+		GetBlockHeadersRequest: &amp;eth.GetBlockHeadersRequest{</span>
 			Origin: eth.HashOrNumber{
 				Hash: s.chain.blocks[1].Hash(),
 			},
<span class="term-fg36">@@ -161,7 +161,7 @@</span> 		},
 	}
 	req2 := &amp;GetBlockHeaders{
 		RequestId: uint64(222),
<span class="term-fg31">-		GetBlockHeadersPacket: &amp;eth.GetBlockHeadersPacket{</span>
<span class="term-fg32">+		GetBlockHeadersRequest: &amp;eth.GetBlockHeadersRequest{</span>
 			Origin: eth.HashOrNumber{
 				Hash: s.chain.blocks[1].Hash(),
 			},
<span class="term-fg36">@@ -201,10 +201,10 @@</span> 	expected2, err := s.chain.GetHeaders(req2)
 	if err != nil {
 		t.Fatalf(&quot;failed to get expected headers for request 2: %v&quot;, err)
 	}
<span class="term-fg31">-	if !headersMatch(expected1, headers1.BlockHeadersPacket) {</span>
<span class="term-fg32">+	if !headersMatch(expected1, headers1.BlockHeadersRequest) {</span>
 		t.Fatalf(&quot;header mismatch: \nexpected %v \ngot %v&quot;, expected1, headers1)
 	}
<span class="term-fg31">-	if !headersMatch(expected2, headers2.BlockHeadersPacket) {</span>
<span class="term-fg32">+	if !headersMatch(expected2, headers2.BlockHeadersRequest) {</span>
 		t.Fatalf(&quot;header mismatch: \nexpected %v \ngot %v&quot;, expected2, headers2)
 	}
 }
<span class="term-fg36">@@ -224,7 +224,7 @@</span> 	&#47;&#47; create requests
 	reqID := uint64(1234)
 	request1 := &amp;GetBlockHeaders{
 		RequestId: reqID,
<span class="term-fg31">-		GetBlockHeadersPacket: &amp;eth.GetBlockHeadersPacket{</span>
<span class="term-fg32">+		GetBlockHeadersRequest: &amp;eth.GetBlockHeadersRequest{</span>
 			Origin: eth.HashOrNumber{
 				Number: 1,
 			},
<span class="term-fg36">@@ -233,7 +233,7 @@</span> 		},
 	}
 	request2 := &amp;GetBlockHeaders{
 		RequestId: reqID,
<span class="term-fg31">-		GetBlockHeadersPacket: &amp;eth.GetBlockHeadersPacket{</span>
<span class="term-fg32">+		GetBlockHeadersRequest: &amp;eth.GetBlockHeadersRequest{</span>
 			Origin: eth.HashOrNumber{
 				Number: 33,
 			},
<span class="term-fg36">@@ -270,10 +270,10 @@</span> 	expected2, err := s.chain.GetHeaders(request2)
 	if err != nil {
 		t.Fatalf(&quot;failed to get expected block headers: %v&quot;, err)
 	}
<span class="term-fg31">-	if !headersMatch(expected1, headers1.BlockHeadersPacket) {</span>
<span class="term-fg32">+	if !headersMatch(expected1, headers1.BlockHeadersRequest) {</span>
 		t.Fatalf(&quot;header mismatch: \nexpected %v \ngot %v&quot;, expected1, headers1)
 	}
<span class="term-fg31">-	if !headersMatch(expected2, headers2.BlockHeadersPacket) {</span>
<span class="term-fg32">+	if !headersMatch(expected2, headers2.BlockHeadersRequest) {</span>
 		t.Fatalf(&quot;header mismatch: \nexpected %v \ngot %v&quot;, expected2, headers2)
 	}
 }
<span class="term-fg36">@@ -290,7 +290,7 @@</span> 	if err := conn.peer(s.chain, nil); err != nil {
 		t.Fatalf(&quot;peering failed: %v&quot;, err)
 	}
 	req := &amp;GetBlockHeaders{
<span class="term-fg31">-		GetBlockHeadersPacket: &amp;eth.GetBlockHeadersPacket{</span>
<span class="term-fg32">+		GetBlockHeadersRequest: &amp;eth.GetBlockHeadersRequest{</span>
 			Origin: eth.HashOrNumber{Number: 0},
 			Amount: 2,
 		},
<span class="term-fg36">@@ -322,7 +322,7 @@</span> 	}
 	&#47;&#47; create block bodies request
 	req := &amp;GetBlockBodies{
 		RequestId: uint64(55),
<span class="term-fg31">-		GetBlockBodiesPacket: eth.GetBlockBodiesPacket{</span>
<span class="term-fg32">+		GetBlockBodiesRequest: eth.GetBlockBodiesRequest{</span>
 			s.chain.blocks[54].Hash(),
 			s.chain.blocks[75].Hash(),
 		},
<span class="term-fg36">@@ -336,11 +336,11 @@</span> 	resp, ok := msg.(*BlockBodies)
 	if !ok {
 		t.Fatalf(&quot;unexpected: %s&quot;, pretty.Sdump(msg))
 	}
<span class="term-fg31">-	bodies := resp.BlockBodiesPacket</span>
<span class="term-fg32">+	bodies := resp.BlockBodiesResponse</span>
 	t.Logf(&quot;received %d block bodies&quot;, len(bodies))
<span class="term-fg31">-	if len(bodies) != len(req.GetBlockBodiesPacket) {</span>
<span class="term-fg32">+	if len(bodies) != len(req.GetBlockBodiesRequest) {</span>
 		t.Fatalf(&quot;wrong bodies in response: expected %d bodies, &quot;+
<span class="term-fg31">-			&quot;got %d&quot;, len(req.GetBlockBodiesPacket), len(bodies))</span>
<span class="term-fg32">+			&quot;got %d&quot;, len(req.GetBlockBodiesRequest), len(bodies))</span>
 	}
 }
&nbsp;
<span class="term-fg36">@@ -481,8 +481,8 @@</span> 	for _, hash := range hashMap {
 		hashes = append(hashes, hash)
 	}
 	getTxReq := &amp;GetPooledTransactions{
<span class="term-fg31">-		RequestId:                   1234,</span>
<span class="term-fg31">-		GetPooledTransactionsPacket: hashes,</span>
<span class="term-fg32">+		RequestId:                    1234,</span>
<span class="term-fg32">+		GetPooledTransactionsRequest: hashes,</span>
 	}
 	if err = conn.Write(getTxReq); err != nil {
 		t.Fatalf(&quot;could not write to conn: %v&quot;, err)
<span class="term-fg36">@@ -490,7 +490,7 @@</span> 	}
 	&#47;&#47; check that all received transactions match those that were sent to node
 	switch msg := conn.waitForResponse(s.chain, timeout, getTxReq.RequestId).(type) {
 	case *PooledTransactions:
<span class="term-fg31">-		for _, gotTx := range msg.PooledTransactionsPacket {</span>
<span class="term-fg32">+		for _, gotTx := range msg.PooledTransactionsResponse {</span>
 			if _, exists := hashMap[gotTx.Hash()]; !exists {
 				t.Fatalf(&quot;unexpected tx received: %v&quot;, gotTx.Hash())
 			}
<span class="term-fg36">@@ -547,8 +547,8 @@</span> 	for {
 		msg := conn.readAndServe(s.chain, timeout)
 		switch msg := msg.(type) {
 		case *GetPooledTransactions:
<span class="term-fg31">-			if len(msg.GetPooledTransactionsPacket) != len(hashes) {</span>
<span class="term-fg31">-				t.Fatalf(&quot;unexpected number of txs requested: wanted %d, got %d&quot;, len(hashes), len(msg.GetPooledTransactionsPacket))</span>
<span class="term-fg32">+			if len(msg.GetPooledTransactionsRequest) != len(hashes) {</span>
<span class="term-fg32">+				t.Fatalf(&quot;unexpected number of txs requested: wanted %d, got %d&quot;, len(hashes), len(msg.GetPooledTransactionsRequest))</span>
 			}
 			return
</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-0c8c3f1677fe57bec4873a5b" role="button"
                   aria-expanded="false" aria-controls="id-0c8c3f1677fe57bec4873a5b">
                    <code>cmd/devp2p/internal/ethtest/suite_test.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/3f40e65c484486dea6cff80b7db178985d21a2c6/cmd/devp2p/internal/ethtest/suite_test.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/650bb2f2b1dcfe30d9b1fa6f7dc9608055ed60e1/cmd/devp2p/internal/ethtest/suite_test.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+1</span></div>
                        <div class="text-start"><span class="text-danger">-0</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-0c8c3f1677fe57bec4873a5b"><span class="term-fg1">diff --git go-ethereum&#47;cmd&#47;devp2p&#47;internal&#47;ethtest&#47;suite_test.go op-geth&#47;cmd&#47;devp2p&#47;internal&#47;ethtest&#47;suite_test.go</span>
<span class="term-fg1">index c5bcc3db1da494d03dc8ad458aa6afa88847fae4..7890c3134811accd6a78ec1554638e8a97e74780 100644</span>
<span class="term-fg1">--- go-ethereum&#47;cmd&#47;devp2p&#47;internal&#47;ethtest&#47;suite_test.go</span>
<span class="term-fg1">+++ op-geth&#47;cmd&#47;devp2p&#47;internal&#47;ethtest&#47;suite_test.go</span>
<span class="term-fg36">@@ -120,6 +120,7 @@</span> 	})
 	if err != nil {
 		return err
 	}
<span class="term-fg32">+	backend.SetSynced()</span>
&nbsp;
 	_, err = backend.BlockChain().InsertChain(chain.blocks[1:])
 	return err</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-7c15b5d528ffe50fabc92a8f" role="button"
                   aria-expanded="false" aria-controls="id-7c15b5d528ffe50fabc92a8f">
                    <code>cmd/devp2p/internal/ethtest/types.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/3f40e65c484486dea6cff80b7db178985d21a2c6/cmd/devp2p/internal/ethtest/types.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/650bb2f2b1dcfe30d9b1fa6f7dc9608055ed60e1/cmd/devp2p/internal/ethtest/types.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+13</span></div>
                        <div class="text-start"><span class="text-danger">-13</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-7c15b5d528ffe50fabc92a8f"><span class="term-fg1">diff --git go-ethereum&#47;cmd&#47;devp2p&#47;internal&#47;ethtest&#47;types.go op-geth&#47;cmd&#47;devp2p&#47;internal&#47;ethtest&#47;types.go</span>
<span class="term-fg1">index afa9a9c8c68586bfc23685fa7b67bfc42b0578f6..805d7a81b99af47e7fdc8d2ad09c688fdac953da 100644</span>
<span class="term-fg1">--- go-ethereum&#47;cmd&#47;devp2p&#47;internal&#47;ethtest&#47;types.go</span>
<span class="term-fg1">+++ op-geth&#47;cmd&#47;devp2p&#47;internal&#47;ethtest&#47;types.go</span>
<span class="term-fg36">@@ -99,24 +99,24 @@</span> func (msg Transactions) Code() int     { return 18 }
 func (msg Transactions) ReqID() uint64 { return 18 }
&nbsp;
 &#47;&#47; GetBlockHeaders represents a block header query.
<span class="term-fg31">-type GetBlockHeaders eth.GetBlockHeadersPacket66</span>
<span class="term-fg32">+type GetBlockHeaders eth.GetBlockHeadersPacket</span>
&nbsp;
 func (msg GetBlockHeaders) Code() int     { return 19 }
 func (msg GetBlockHeaders) ReqID() uint64 { return msg.RequestId }
&nbsp;
<span class="term-fg31">-type BlockHeaders eth.BlockHeadersPacket66</span>
<span class="term-fg32">+type BlockHeaders eth.BlockHeadersPacket</span>
&nbsp;
 func (msg BlockHeaders) Code() int     { return 20 }
 func (msg BlockHeaders) ReqID() uint64 { return msg.RequestId }
&nbsp;
 &#47;&#47; GetBlockBodies represents a GetBlockBodies request
<span class="term-fg31">-type GetBlockBodies eth.GetBlockBodiesPacket66</span>
<span class="term-fg32">+type GetBlockBodies eth.GetBlockBodiesPacket</span>
&nbsp;
 func (msg GetBlockBodies) Code() int     { return 21 }
 func (msg GetBlockBodies) ReqID() uint64 { return msg.RequestId }
&nbsp;
 &#47;&#47; BlockBodies is the network packet for block content distribution.
<span class="term-fg31">-type BlockBodies eth.BlockBodiesPacket66</span>
<span class="term-fg32">+type BlockBodies eth.BlockBodiesPacket</span>
&nbsp;
 func (msg BlockBodies) Code() int     { return 22 }
 func (msg BlockBodies) ReqID() uint64 { return msg.RequestId }
<span class="term-fg36">@@ -128,7 +128,7 @@</span> func (msg NewBlock) Code() int     { return 23 }
 func (msg NewBlock) ReqID() uint64 { return 0 }
&nbsp;
 &#47;&#47; NewPooledTransactionHashes66 is the network packet for the tx hash propagation message.
<span class="term-fg31">-type NewPooledTransactionHashes66 eth.NewPooledTransactionHashesPacket66</span>
<span class="term-fg32">+type NewPooledTransactionHashes66 eth.NewPooledTransactionHashesPacket67</span>
&nbsp;
 func (msg NewPooledTransactionHashes66) Code() int     { return 24 }
 func (msg NewPooledTransactionHashes66) ReqID() uint64 { return 0 }
<span class="term-fg36">@@ -139,12 +139,12 @@</span>
 func (msg NewPooledTransactionHashes) Code() int     { return 24 }
 func (msg NewPooledTransactionHashes) ReqID() uint64 { return 0 }
&nbsp;
<span class="term-fg31">-type GetPooledTransactions eth.GetPooledTransactionsPacket66</span>
<span class="term-fg32">+type GetPooledTransactions eth.GetPooledTransactionsPacket</span>
&nbsp;
 func (msg GetPooledTransactions) Code() int     { return 25 }
 func (msg GetPooledTransactions) ReqID() uint64 { return msg.RequestId }
&nbsp;
<span class="term-fg31">-type PooledTransactions eth.PooledTransactionsPacket66</span>
<span class="term-fg32">+type PooledTransactions eth.PooledTransactionsPacket</span>
&nbsp;
 func (msg PooledTransactions) Code() int     { return 26 }
 func (msg PooledTransactions) ReqID() uint64 { return msg.RequestId }
<span class="term-fg36">@@ -180,25 +180,25 @@</span> 		msg = new(Disconnect)
 	case (Status{}).Code():
 		msg = new(Status)
 	case (GetBlockHeaders{}).Code():
<span class="term-fg31">-		ethMsg := new(eth.GetBlockHeadersPacket66)</span>
<span class="term-fg32">+		ethMsg := new(eth.GetBlockHeadersPacket)</span>
 		if err := rlp.DecodeBytes(rawData, ethMsg); err != nil {
 			return errorf(&quot;could not rlp decode message: %v&quot;, err)
 		}
 		return (*GetBlockHeaders)(ethMsg)
 	case (BlockHeaders{}).Code():
<span class="term-fg31">-		ethMsg := new(eth.BlockHeadersPacket66)</span>
<span class="term-fg32">+		ethMsg := new(eth.BlockHeadersPacket)</span>
 		if err := rlp.DecodeBytes(rawData, ethMsg); err != nil {
 			return errorf(&quot;could not rlp decode message: %v&quot;, err)
 		}
 		return (*BlockHeaders)(ethMsg)
 	case (GetBlockBodies{}).Code():
<span class="term-fg31">-		ethMsg := new(eth.GetBlockBodiesPacket66)</span>
<span class="term-fg32">+		ethMsg := new(eth.GetBlockBodiesPacket)</span>
 		if err := rlp.DecodeBytes(rawData, ethMsg); err != nil {
 			return errorf(&quot;could not rlp decode message: %v&quot;, err)
 		}
 		return (*GetBlockBodies)(ethMsg)
 	case (BlockBodies{}).Code():
<span class="term-fg31">-		ethMsg := new(eth.BlockBodiesPacket66)</span>
<span class="term-fg32">+		ethMsg := new(eth.BlockBodiesPacket)</span>
 		if err := rlp.DecodeBytes(rawData, ethMsg); err != nil {
 			return errorf(&quot;could not rlp decode message: %v&quot;, err)
 		}
<span class="term-fg36">@@ -217,13 +217,13 @@</span> 			return ethMsg
 		}
 		msg = new(NewPooledTransactionHashes66)
 	case (GetPooledTransactions{}.Code()):
<span class="term-fg31">-		ethMsg := new(eth.GetPooledTransactionsPacket66)</span>
<span class="term-fg32">+		ethMsg := new(eth.GetPooledTransactionsPacket)</span>
 		if err := rlp.DecodeBytes(rawData, ethMsg); err != nil {
 			return errorf(&quot;could not rlp decode message: %v&quot;, err)
 		}
 		return (*GetPooledTransactions)(ethMsg)
 	case (PooledTransactions{}.Code()):
<span class="term-fg31">-		ethMsg := new(eth.PooledTransactionsPacket66)</span>
<span class="term-fg32">+		ethMsg := new(eth.PooledTransactionsPacket)</span>
 		if err := rlp.DecodeBytes(rawData, ethMsg); err != nil {
 			return errorf(&quot;could not rlp decode message: %v&quot;, err)
 		}</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-fe211d624d85d4628413b723" role="button"
                   aria-expanded="false" aria-controls="id-fe211d624d85d4628413b723">
                    <code>cmd/evm/blockrunner.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/3f40e65c484486dea6cff80b7db178985d21a2c6/cmd/evm/blockrunner.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/650bb2f2b1dcfe30d9b1fa6f7dc9608055ed60e1/cmd/evm/blockrunner.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+1</span></div>
                        <div class="text-start"><span class="text-danger">-5</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-fe211d624d85d4628413b723"><span class="term-fg1">diff --git go-ethereum&#47;cmd&#47;evm&#47;blockrunner.go op-geth&#47;cmd&#47;evm&#47;blockrunner.go</span>
<span class="term-fg1">index 0be5f697113841cde5fe4b1f9f63a1a7c6539ff6..6612680dc40b71039221395f83a9ff275c2e3885 100644</span>
<span class="term-fg1">--- go-ethereum&#47;cmd&#47;evm&#47;blockrunner.go</span>
<span class="term-fg1">+++ op-geth&#47;cmd&#47;evm&#47;blockrunner.go</span>
<span class="term-fg36">@@ -25,7 +25,6 @@</span>
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;core&#47;rawdb&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;core&#47;vm&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;eth&#47;tracers&#47;logger&quot;
<span class="term-fg31">-	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;log&quot;</span>
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;tests&quot;
 	&quot;github.com&#47;urfave&#47;cli&#47;v2&quot;
 )
<span class="term-fg36">@@ -41,10 +40,7 @@</span> func blockTestCmd(ctx *cli.Context) error {
 	if len(ctx.Args().First()) == 0 {
 		return errors.New(&quot;path-to-test argument required&quot;)
 	}
<span class="term-fg31">-	&#47;&#47; Configure the go-ethereum logger</span>
<span class="term-fg31">-	glogger := log.NewGlogHandler(log.StreamHandler(os.Stderr, log.TerminalFormat(false)))</span>
<span class="term-fg31">-	glogger.Verbosity(log.Lvl(ctx.Int(VerbosityFlag.Name)))</span>
<span class="term-fg31">-	log.Root().SetHandler(glogger)</span>
<span class="term-fg32">+</span>
 	var tracer vm.EVMLogger
 	&#47;&#47; Configure the EVM logger
 	if ctx.Bool(MachineFlag.Name) {</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-4abf61ba78d15125b0d3a065" role="button"
                   aria-expanded="false" aria-controls="id-4abf61ba78d15125b0d3a065">
                    <code>cmd/evm/internal/t8ntool/block.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/3f40e65c484486dea6cff80b7db178985d21a2c6/cmd/evm/internal/t8ntool/block.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/650bb2f2b1dcfe30d9b1fa6f7dc9608055ed60e1/cmd/evm/internal/t8ntool/block.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+49</span></div>
                        <div class="text-start"><span class="text-danger">-41</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-4abf61ba78d15125b0d3a065"><span class="term-fg1">diff --git go-ethereum&#47;cmd&#47;evm&#47;internal&#47;t8ntool&#47;block.go op-geth&#47;cmd&#47;evm&#47;internal&#47;t8ntool&#47;block.go</span>
<span class="term-fg1">index 09dca8984e9c89c8132fd6e1b6caf00b3f7600d2..5c0e28e284c0c3090eb0f971310707456c1cf1b2 100644</span>
<span class="term-fg1">--- go-ethereum&#47;cmd&#47;evm&#47;internal&#47;t8ntool&#47;block.go</span>
<span class="term-fg1">+++ op-geth&#47;cmd&#47;evm&#47;internal&#47;t8ntool&#47;block.go</span>
<span class="term-fg36">@@ -37,33 +37,38 @@</span> )
&nbsp;
 &#47;&#47;go:generate go run github.com&#47;fjl&#47;gencodec -type header -field-override headerMarshaling -out gen_header.go
 type header struct {
<span class="term-fg31">-	ParentHash      common.Hash       `json:&quot;parentHash&quot;`</span>
<span class="term-fg31">-	OmmerHash       *common.Hash      `json:&quot;sha3Uncles&quot;`</span>
<span class="term-fg31">-	Coinbase        *common.Address   `json:&quot;miner&quot;`</span>
<span class="term-fg31">-	Root            common.Hash       `json:&quot;stateRoot&quot;        gencodec:&quot;required&quot;`</span>
<span class="term-fg31">-	TxHash          *common.Hash      `json:&quot;transactionsRoot&quot;`</span>
<span class="term-fg31">-	ReceiptHash     *common.Hash      `json:&quot;receiptsRoot&quot;`</span>
<span class="term-fg31">-	Bloom           types.Bloom       `json:&quot;logsBloom&quot;`</span>
<span class="term-fg31">-	Difficulty      *big.Int          `json:&quot;difficulty&quot;`</span>
<span class="term-fg31">-	Number          *big.Int          `json:&quot;number&quot;           gencodec:&quot;required&quot;`</span>
<span class="term-fg31">-	GasLimit        uint64            `json:&quot;gasLimit&quot;         gencodec:&quot;required&quot;`</span>
<span class="term-fg31">-	GasUsed         uint64            `json:&quot;gasUsed&quot;`</span>
<span class="term-fg31">-	Time            uint64            `json:&quot;timestamp&quot;        gencodec:&quot;required&quot;`</span>
<span class="term-fg31">-	Extra           []byte            `json:&quot;extraData&quot;`</span>
<span class="term-fg31">-	MixDigest       common.Hash       `json:&quot;mixHash&quot;`</span>
<span class="term-fg31">-	Nonce           *types.BlockNonce `json:&quot;nonce&quot;`</span>
<span class="term-fg31">-	BaseFee         *big.Int          `json:&quot;baseFeePerGas&quot; rlp:&quot;optional&quot;`</span>
<span class="term-fg31">-	WithdrawalsHash *common.Hash      `json:&quot;withdrawalsRoot&quot; rlp:&quot;optional&quot;`</span>
<span class="term-fg32">+	ParentHash            common.Hash       `json:&quot;parentHash&quot;`</span>
<span class="term-fg32">+	OmmerHash             *common.Hash      `json:&quot;sha3Uncles&quot;`</span>
<span class="term-fg32">+	Coinbase              *common.Address   `json:&quot;miner&quot;`</span>
<span class="term-fg32">+	Root                  common.Hash       `json:&quot;stateRoot&quot;        gencodec:&quot;required&quot;`</span>
<span class="term-fg32">+	TxHash                *common.Hash      `json:&quot;transactionsRoot&quot;`</span>
<span class="term-fg32">+	ReceiptHash           *common.Hash      `json:&quot;receiptsRoot&quot;`</span>
<span class="term-fg32">+	Bloom                 types.Bloom       `json:&quot;logsBloom&quot;`</span>
<span class="term-fg32">+	Difficulty            *big.Int          `json:&quot;difficulty&quot;`</span>
<span class="term-fg32">+	Number                *big.Int          `json:&quot;number&quot;           gencodec:&quot;required&quot;`</span>
<span class="term-fg32">+	GasLimit              uint64            `json:&quot;gasLimit&quot;         gencodec:&quot;required&quot;`</span>
<span class="term-fg32">+	GasUsed               uint64            `json:&quot;gasUsed&quot;`</span>
<span class="term-fg32">+	Time                  uint64            `json:&quot;timestamp&quot;        gencodec:&quot;required&quot;`</span>
<span class="term-fg32">+	Extra                 []byte            `json:&quot;extraData&quot;`</span>
<span class="term-fg32">+	MixDigest             common.Hash       `json:&quot;mixHash&quot;`</span>
<span class="term-fg32">+	Nonce                 *types.BlockNonce `json:&quot;nonce&quot;`</span>
<span class="term-fg32">+	BaseFee               *big.Int          `json:&quot;baseFeePerGas&quot; rlp:&quot;optional&quot;`</span>
<span class="term-fg32">+	WithdrawalsHash       *common.Hash      `json:&quot;withdrawalsRoot&quot; rlp:&quot;optional&quot;`</span>
<span class="term-fg32">+	BlobGasUsed           *uint64           `json:&quot;blobGasUsed&quot;   rlp:&quot;optional&quot;`</span>
<span class="term-fg32">+	ExcessBlobGas         *uint64           `json:&quot;excessBlobGas&quot;   rlp:&quot;optional&quot;`</span>
<span class="term-fg32">+	ParentBeaconBlockRoot *common.Hash      `json:&quot;parentBeaconBlockRoot&quot; rlp:&quot;optional&quot;`</span>
 }
&nbsp;
 type headerMarshaling struct {
<span class="term-fg31">-	Difficulty *math.HexOrDecimal256</span>
<span class="term-fg31">-	Number     *math.HexOrDecimal256</span>
<span class="term-fg31">-	GasLimit   math.HexOrDecimal64</span>
<span class="term-fg31">-	GasUsed    math.HexOrDecimal64</span>
<span class="term-fg31">-	Time       math.HexOrDecimal64</span>
<span class="term-fg31">-	Extra      hexutil.Bytes</span>
<span class="term-fg31">-	BaseFee    *math.HexOrDecimal256</span>
<span class="term-fg32">+	Difficulty    *math.HexOrDecimal256</span>
<span class="term-fg32">+	Number        *math.HexOrDecimal256</span>
<span class="term-fg32">+	GasLimit      math.HexOrDecimal64</span>
<span class="term-fg32">+	GasUsed       math.HexOrDecimal64</span>
<span class="term-fg32">+	Time          math.HexOrDecimal64</span>
<span class="term-fg32">+	Extra         hexutil.Bytes</span>
<span class="term-fg32">+	BaseFee       *math.HexOrDecimal256</span>
<span class="term-fg32">+	BlobGasUsed   *math.HexOrDecimal64</span>
<span class="term-fg32">+	ExcessBlobGas *math.HexOrDecimal64</span>
 }
&nbsp;
 type bbInput struct {
<span class="term-fg36">@@ -113,22 +118,25 @@</span>
 &#47;&#47; ToBlock converts i into a *types.Block
 func (i *bbInput) ToBlock() *types.Block {
 	header := &amp;types.Header{
<span class="term-fg31">-		ParentHash:      i.Header.ParentHash,</span>
<span class="term-fg31">-		UncleHash:       types.EmptyUncleHash,</span>
<span class="term-fg31">-		Coinbase:        common.Address{},</span>
<span class="term-fg31">-		Root:            i.Header.Root,</span>
<span class="term-fg31">-		TxHash:          types.EmptyTxsHash,</span>
<span class="term-fg31">-		ReceiptHash:     types.EmptyReceiptsHash,</span>
<span class="term-fg31">-		Bloom:           i.Header.Bloom,</span>
<span class="term-fg31">-		Difficulty:      common.Big0,</span>
<span class="term-fg31">-		Number:          i.Header.Number,</span>
<span class="term-fg31">-		GasLimit:        i.Header.GasLimit,</span>
<span class="term-fg31">-		GasUsed:         i.Header.GasUsed,</span>
<span class="term-fg31">-		Time:            i.Header.Time,</span>
<span class="term-fg31">-		Extra:           i.Header.Extra,</span>
<span class="term-fg31">-		MixDigest:       i.Header.MixDigest,</span>
<span class="term-fg31">-		BaseFee:         i.Header.BaseFee,</span>
<span class="term-fg31">-		WithdrawalsHash: i.Header.WithdrawalsHash,</span>
<span class="term-fg32">+		ParentHash:       i.Header.ParentHash,</span>
<span class="term-fg32">+		UncleHash:        types.EmptyUncleHash,</span>
<span class="term-fg32">+		Coinbase:         common.Address{},</span>
<span class="term-fg32">+		Root:             i.Header.Root,</span>
<span class="term-fg32">+		TxHash:           types.EmptyTxsHash,</span>
<span class="term-fg32">+		ReceiptHash:      types.EmptyReceiptsHash,</span>
<span class="term-fg32">+		Bloom:            i.Header.Bloom,</span>
<span class="term-fg32">+		Difficulty:       common.Big0,</span>
<span class="term-fg32">+		Number:           i.Header.Number,</span>
<span class="term-fg32">+		GasLimit:         i.Header.GasLimit,</span>
<span class="term-fg32">+		GasUsed:          i.Header.GasUsed,</span>
<span class="term-fg32">+		Time:             i.Header.Time,</span>
<span class="term-fg32">+		Extra:            i.Header.Extra,</span>
<span class="term-fg32">+		MixDigest:        i.Header.MixDigest,</span>
<span class="term-fg32">+		BaseFee:          i.Header.BaseFee,</span>
<span class="term-fg32">+		WithdrawalsHash:  i.Header.WithdrawalsHash,</span>
<span class="term-fg32">+		BlobGasUsed:      i.Header.BlobGasUsed,</span>
<span class="term-fg32">+		ExcessBlobGas:    i.Header.ExcessBlobGas,</span>
<span class="term-fg32">+		ParentBeaconRoot: i.Header.ParentBeaconBlockRoot,</span>
 	}
&nbsp;
 	&#47;&#47; Fill optional values.
<span class="term-fg36">@@ -150,7 +158,7 @@</span> 	}
 	if i.Header.Nonce != nil {
 		header.Nonce = *i.Header.Nonce
 	}
<span class="term-fg31">-	if header.Difficulty != nil {</span>
<span class="term-fg32">+	if i.Header.Difficulty != nil {</span>
 		header.Difficulty = i.Header.Difficulty
 	}
 	return types.NewBlockWithHeader(header).WithBody(i.Txs, i.Ommers).WithWithdrawals(i.Withdrawals)</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-0421953e7dbe24540c5a838c" role="button"
                   aria-expanded="false" aria-controls="id-0421953e7dbe24540c5a838c">
                    <code>cmd/evm/internal/t8ntool/execution.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/3f40e65c484486dea6cff80b7db178985d21a2c6/cmd/evm/internal/t8ntool/execution.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/650bb2f2b1dcfe30d9b1fa6f7dc9608055ed60e1/cmd/evm/internal/t8ntool/execution.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+14</span></div>
                        <div class="text-start"><span class="text-danger">-12</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-0421953e7dbe24540c5a838c"><span class="term-fg1">diff --git go-ethereum&#47;cmd&#47;evm&#47;internal&#47;t8ntool&#47;execution.go op-geth&#47;cmd&#47;evm&#47;internal&#47;t8ntool&#47;execution.go</span>
<span class="term-fg1">index bb14ac63cac4275956ced6daff5a1fc2e2ae3623..312f427d4c6b98b4b86edef7ac23e4af2598be4b 100644</span>
<span class="term-fg1">--- go-ethereum&#47;cmd&#47;evm&#47;internal&#47;t8ntool&#47;execution.go</span>
<span class="term-fg1">+++ op-geth&#47;cmd&#47;evm&#47;internal&#47;t8ntool&#47;execution.go</span>
<span class="term-fg36">@@ -59,7 +59,7 @@</span> 	GasUsed              math.HexOrDecimal64   `json:&quot;gasUsed&quot;`
 	BaseFee              *math.HexOrDecimal256 `json:&quot;currentBaseFee,omitempty&quot;`
 	WithdrawalsRoot      *common.Hash          `json:&quot;withdrawalsRoot,omitempty&quot;`
 	CurrentExcessBlobGas *math.HexOrDecimal64  `json:&quot;currentExcessBlobGas,omitempty&quot;`
<span class="term-fg31">-	CurrentBlobGasUsed   *math.HexOrDecimal64  `json:&quot;currentBlobGasUsed,omitempty&quot;`</span>
<span class="term-fg32">+	CurrentBlobGasUsed   *math.HexOrDecimal64  `json:&quot;blobGasUsed,omitempty&quot;`</span>
 }
&nbsp;
 type ommer struct {
<span class="term-fg36">@@ -85,7 +85,7 @@</span> 	Ommers                []ommer                             `json:&quot;ommers,omitempty&quot;`
 	Withdrawals           []*types.Withdrawal                 `json:&quot;withdrawals,omitempty&quot;`
 	BaseFee               *big.Int                            `json:&quot;currentBaseFee,omitempty&quot;`
 	ParentUncleHash       common.Hash                         `json:&quot;parentUncleHash&quot;`
<span class="term-fg31">-	ExcessBlobGas         *uint64                             `json:&quot;excessBlobGas,omitempty&quot;`</span>
<span class="term-fg32">+	ExcessBlobGas         *uint64                             `json:&quot;currentExcessBlobGas,omitempty&quot;`</span>
 	ParentExcessBlobGas   *uint64                             `json:&quot;parentExcessBlobGas,omitempty&quot;`
 	ParentBlobGasUsed     *uint64                             `json:&quot;parentBlobGasUsed,omitempty&quot;`
 	ParentBeaconBlockRoot *common.Hash                        `json:&quot;parentBeaconBlockRoot&quot;`
<span class="term-fg36">@@ -163,17 +163,19 @@</span> 	if pre.Env.Random != nil {
 		rnd := common.BigToHash(pre.Env.Random)
 		vmContext.Random = &amp;rnd
 	}
<span class="term-fg31">-	&#47;&#47; If excessBlobGas is defined, add it to the vmContext.</span>
<span class="term-fg32">+	&#47;&#47; Calculate the BlobBaseFee</span>
<span class="term-fg32">+	var excessBlobGas uint64</span>
 	if pre.Env.ExcessBlobGas != nil {
<span class="term-fg31">-		vmContext.ExcessBlobGas = pre.Env.ExcessBlobGas</span>
<span class="term-fg32">+		excessBlobGas := *pre.Env.ExcessBlobGas</span>
<span class="term-fg32">+		vmContext.BlobBaseFee = eip4844.CalcBlobFee(excessBlobGas)</span>
 	} else {
 		&#47;&#47; If it is not explicitly defined, but we have the parent values, we try
 		&#47;&#47; to calculate it ourselves.
 		parentExcessBlobGas := pre.Env.ParentExcessBlobGas
 		parentBlobGasUsed := pre.Env.ParentBlobGasUsed
 		if parentExcessBlobGas != nil &amp;&amp; parentBlobGasUsed != nil {
<span class="term-fg31">-			excessBlobGas := eip4844.CalcExcessBlobGas(*parentExcessBlobGas, *parentBlobGasUsed)</span>
<span class="term-fg31">-			vmContext.ExcessBlobGas = &amp;excessBlobGas</span>
<span class="term-fg32">+			excessBlobGas = eip4844.CalcExcessBlobGas(*parentExcessBlobGas, *parentBlobGasUsed)</span>
<span class="term-fg32">+			vmContext.BlobBaseFee = eip4844.CalcBlobFee(excessBlobGas)</span>
 		}
 	}
 	&#47;&#47; If DAO is supported&#47;enabled, we need to handle it here. In geth &#39;proper&#39;, it&#39;s
<span class="term-fg36">@@ -189,11 +191,14 @@</span> 		core.ProcessBeaconBlockRoot(*beaconRoot, evm, statedb)
 	}
 	var blobGasUsed uint64
 	for i, tx := range txs {
<span class="term-fg31">-		if tx.Type() == types.BlobTxType &amp;&amp; vmContext.ExcessBlobGas == nil {</span>
<span class="term-fg32">+		if tx.Type() == types.BlobTxType &amp;&amp; vmContext.BlobBaseFee == nil {</span>
 			errMsg := &quot;blob tx used but field env.ExcessBlobGas missing&quot;
 			log.Warn(&quot;rejected tx&quot;, &quot;index&quot;, i, &quot;hash&quot;, tx.Hash(), &quot;error&quot;, errMsg)
 			rejectedTxs = append(rejectedTxs, &amp;rejectedTx{i, errMsg})
 			continue
<span class="term-fg32">+		}</span>
<span class="term-fg32">+		if tx.Type() == types.BlobTxType {</span>
<span class="term-fg32">+			blobGasUsed += uint64(params.BlobTxBlobGasPerBlob * len(tx.BlobHashes()))</span>
 		}
 		msg, err := core.TransactionToMessage(tx, signer, pre.Env.BaseFee)
 		if err != nil {
<span class="term-fg36">@@ -223,9 +228,6 @@</span> 			log.Info(&quot;rejected tx&quot;, &quot;index&quot;, i, &quot;hash&quot;, tx.Hash(), &quot;from&quot;, msg.From, &quot;error&quot;, err)
 			rejectedTxs = append(rejectedTxs, &amp;rejectedTx{i, err.Error()})
 			gaspool.SetGas(prevGas)
 			continue
<span class="term-fg31">-		}</span>
<span class="term-fg31">-		if tx.Type() == types.BlobTxType {</span>
<span class="term-fg31">-			blobGasUsed += params.BlobTxBlobGasPerBlob</span>
 		}
 		includedTxs = append(includedTxs, tx)
 		if hashError != nil {
<span class="term-fg36">@@ -322,8 +324,8 @@</span> 	if pre.Env.Withdrawals != nil {
 		h := types.DeriveSha(types.Withdrawals(pre.Env.Withdrawals), trie.NewStackTrie(nil))
 		execRs.WithdrawalsRoot = &amp;h
 	}
<span class="term-fg31">-	if vmContext.ExcessBlobGas != nil {</span>
<span class="term-fg31">-		execRs.CurrentExcessBlobGas = (*math.HexOrDecimal64)(vmContext.ExcessBlobGas)</span>
<span class="term-fg32">+	if vmContext.BlobBaseFee != nil {</span>
<span class="term-fg32">+		execRs.CurrentExcessBlobGas = (*math.HexOrDecimal64)(&amp;excessBlobGas)</span>
 		execRs.CurrentBlobGasUsed = (*math.HexOrDecimal64)(&amp;blobGasUsed)
 	}
 	&#47;&#47; Re-create statedb instance with new root upon the updated database</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-351d637b958bcff85e3b6bde" role="button"
                   aria-expanded="false" aria-controls="id-351d637b958bcff85e3b6bde">
                    <code>cmd/evm/internal/t8ntool/gen_header.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/3f40e65c484486dea6cff80b7db178985d21a2c6/cmd/evm/internal/t8ntool/gen_header.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/650bb2f2b1dcfe30d9b1fa6f7dc9608055ed60e1/cmd/evm/internal/t8ntool/gen_header.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+52</span></div>
                        <div class="text-start"><span class="text-danger">-34</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-351d637b958bcff85e3b6bde"><span class="term-fg1">diff --git go-ethereum&#47;cmd&#47;evm&#47;internal&#47;t8ntool&#47;gen_header.go op-geth&#47;cmd&#47;evm&#47;internal&#47;t8ntool&#47;gen_header.go</span>
<span class="term-fg1">index 76228394dc1df033183f9de9ddd35095761140f4..a8c8668978ed9cdc1e120dece0f0b2dd72058d0a 100644</span>
<span class="term-fg1">--- go-ethereum&#47;cmd&#47;evm&#47;internal&#47;t8ntool&#47;gen_header.go</span>
<span class="term-fg1">+++ op-geth&#47;cmd&#47;evm&#47;internal&#47;t8ntool&#47;gen_header.go</span>
<span class="term-fg36">@@ -18,23 +18,26 @@</span>
 &#47;&#47; MarshalJSON marshals as JSON.
 func (h header) MarshalJSON() ([]byte, error) {
 	type header struct {
<span class="term-fg31">-		ParentHash      common.Hash           `json:&quot;parentHash&quot;`</span>
<span class="term-fg31">-		OmmerHash       *common.Hash          `json:&quot;sha3Uncles&quot;`</span>
<span class="term-fg31">-		Coinbase        *common.Address       `json:&quot;miner&quot;`</span>
<span class="term-fg31">-		Root            common.Hash           `json:&quot;stateRoot&quot;        gencodec:&quot;required&quot;`</span>
<span class="term-fg31">-		TxHash          *common.Hash          `json:&quot;transactionsRoot&quot;`</span>
<span class="term-fg31">-		ReceiptHash     *common.Hash          `json:&quot;receiptsRoot&quot;`</span>
<span class="term-fg31">-		Bloom           types.Bloom           `json:&quot;logsBloom&quot;`</span>
<span class="term-fg31">-		Difficulty      *math.HexOrDecimal256 `json:&quot;difficulty&quot;`</span>
<span class="term-fg31">-		Number          *math.HexOrDecimal256 `json:&quot;number&quot;           gencodec:&quot;required&quot;`</span>
<span class="term-fg31">-		GasLimit        math.HexOrDecimal64   `json:&quot;gasLimit&quot;         gencodec:&quot;required&quot;`</span>
<span class="term-fg31">-		GasUsed         math.HexOrDecimal64   `json:&quot;gasUsed&quot;`</span>
<span class="term-fg31">-		Time            math.HexOrDecimal64   `json:&quot;timestamp&quot;        gencodec:&quot;required&quot;`</span>
<span class="term-fg31">-		Extra           hexutil.Bytes         `json:&quot;extraData&quot;`</span>
<span class="term-fg31">-		MixDigest       common.Hash           `json:&quot;mixHash&quot;`</span>
<span class="term-fg31">-		Nonce           *types.BlockNonce     `json:&quot;nonce&quot;`</span>
<span class="term-fg31">-		BaseFee         *math.HexOrDecimal256 `json:&quot;baseFeePerGas&quot; rlp:&quot;optional&quot;`</span>
<span class="term-fg31">-		WithdrawalsHash *common.Hash          `json:&quot;withdrawalsRoot&quot; rlp:&quot;optional&quot;`</span>
<span class="term-fg32">+		ParentHash            common.Hash           `json:&quot;parentHash&quot;`</span>
<span class="term-fg32">+		OmmerHash             *common.Hash          `json:&quot;sha3Uncles&quot;`</span>
<span class="term-fg32">+		Coinbase              *common.Address       `json:&quot;miner&quot;`</span>
<span class="term-fg32">+		Root                  common.Hash           `json:&quot;stateRoot&quot;        gencodec:&quot;required&quot;`</span>
<span class="term-fg32">+		TxHash                *common.Hash          `json:&quot;transactionsRoot&quot;`</span>
<span class="term-fg32">+		ReceiptHash           *common.Hash          `json:&quot;receiptsRoot&quot;`</span>
<span class="term-fg32">+		Bloom                 types.Bloom           `json:&quot;logsBloom&quot;`</span>
<span class="term-fg32">+		Difficulty            *math.HexOrDecimal256 `json:&quot;difficulty&quot;`</span>
<span class="term-fg32">+		Number                *math.HexOrDecimal256 `json:&quot;number&quot;           gencodec:&quot;required&quot;`</span>
<span class="term-fg32">+		GasLimit              math.HexOrDecimal64   `json:&quot;gasLimit&quot;         gencodec:&quot;required&quot;`</span>
<span class="term-fg32">+		GasUsed               math.HexOrDecimal64   `json:&quot;gasUsed&quot;`</span>
<span class="term-fg32">+		Time                  math.HexOrDecimal64   `json:&quot;timestamp&quot;        gencodec:&quot;required&quot;`</span>
<span class="term-fg32">+		Extra                 hexutil.Bytes         `json:&quot;extraData&quot;`</span>
<span class="term-fg32">+		MixDigest             common.Hash           `json:&quot;mixHash&quot;`</span>
<span class="term-fg32">+		Nonce                 *types.BlockNonce     `json:&quot;nonce&quot;`</span>
<span class="term-fg32">+		BaseFee               *math.HexOrDecimal256 `json:&quot;baseFeePerGas&quot; rlp:&quot;optional&quot;`</span>
<span class="term-fg32">+		WithdrawalsHash       *common.Hash          `json:&quot;withdrawalsRoot&quot; rlp:&quot;optional&quot;`</span>
<span class="term-fg32">+		BlobGasUsed           *math.HexOrDecimal64  `json:&quot;blobGasUsed&quot;   rlp:&quot;optional&quot;`</span>
<span class="term-fg32">+		ExcessBlobGas         *math.HexOrDecimal64  `json:&quot;excessBlobGas&quot;   rlp:&quot;optional&quot;`</span>
<span class="term-fg32">+		ParentBeaconBlockRoot *common.Hash          `json:&quot;parentBeaconBlockRoot&quot; rlp:&quot;optional&quot;`</span>
 	}
 	var enc header
 	enc.ParentHash = h.ParentHash
<span class="term-fg36">@@ -54,29 +57,35 @@</span> 	enc.MixDigest = h.MixDigest
 	enc.Nonce = h.Nonce
 	enc.BaseFee = (*math.HexOrDecimal256)(h.BaseFee)
 	enc.WithdrawalsHash = h.WithdrawalsHash
<span class="term-fg32">+	enc.BlobGasUsed = (*math.HexOrDecimal64)(h.BlobGasUsed)</span>
<span class="term-fg32">+	enc.ExcessBlobGas = (*math.HexOrDecimal64)(h.ExcessBlobGas)</span>
<span class="term-fg32">+	enc.ParentBeaconBlockRoot = h.ParentBeaconBlockRoot</span>
 	return json.Marshal(&amp;enc)
 }
&nbsp;
 &#47;&#47; UnmarshalJSON unmarshals from JSON.
 func (h *header) UnmarshalJSON(input []byte) error {
 	type header struct {
<span class="term-fg31">-		ParentHash      *common.Hash          `json:&quot;parentHash&quot;`</span>
<span class="term-fg31">-		OmmerHash       *common.Hash          `json:&quot;sha3Uncles&quot;`</span>
<span class="term-fg31">-		Coinbase        *common.Address       `json:&quot;miner&quot;`</span>
<span class="term-fg31">-		Root            *common.Hash          `json:&quot;stateRoot&quot;        gencodec:&quot;required&quot;`</span>
<span class="term-fg31">-		TxHash          *common.Hash          `json:&quot;transactionsRoot&quot;`</span>
<span class="term-fg31">-		ReceiptHash     *common.Hash          `json:&quot;receiptsRoot&quot;`</span>
<span class="term-fg31">-		Bloom           *types.Bloom          `json:&quot;logsBloom&quot;`</span>
<span class="term-fg31">-		Difficulty      *math.HexOrDecimal256 `json:&quot;difficulty&quot;`</span>
<span class="term-fg31">-		Number          *math.HexOrDecimal256 `json:&quot;number&quot;           gencodec:&quot;required&quot;`</span>
<span class="term-fg31">-		GasLimit        *math.HexOrDecimal64  `json:&quot;gasLimit&quot;         gencodec:&quot;required&quot;`</span>
<span class="term-fg31">-		GasUsed         *math.HexOrDecimal64  `json:&quot;gasUsed&quot;`</span>
<span class="term-fg31">-		Time            *math.HexOrDecimal64  `json:&quot;timestamp&quot;        gencodec:&quot;required&quot;`</span>
<span class="term-fg31">-		Extra           *hexutil.Bytes        `json:&quot;extraData&quot;`</span>
<span class="term-fg31">-		MixDigest       *common.Hash          `json:&quot;mixHash&quot;`</span>
<span class="term-fg31">-		Nonce           *types.BlockNonce     `json:&quot;nonce&quot;`</span>
<span class="term-fg31">-		BaseFee         *math.HexOrDecimal256 `json:&quot;baseFeePerGas&quot; rlp:&quot;optional&quot;`</span>
<span class="term-fg31">-		WithdrawalsHash *common.Hash          `json:&quot;withdrawalsRoot&quot; rlp:&quot;optional&quot;`</span>
<span class="term-fg32">+		ParentHash            *common.Hash          `json:&quot;parentHash&quot;`</span>
<span class="term-fg32">+		OmmerHash             *common.Hash          `json:&quot;sha3Uncles&quot;`</span>
<span class="term-fg32">+		Coinbase              *common.Address       `json:&quot;miner&quot;`</span>
<span class="term-fg32">+		Root                  *common.Hash          `json:&quot;stateRoot&quot;        gencodec:&quot;required&quot;`</span>
<span class="term-fg32">+		TxHash                *common.Hash          `json:&quot;transactionsRoot&quot;`</span>
<span class="term-fg32">+		ReceiptHash           *common.Hash          `json:&quot;receiptsRoot&quot;`</span>
<span class="term-fg32">+		Bloom                 *types.Bloom          `json:&quot;logsBloom&quot;`</span>
<span class="term-fg32">+		Difficulty            *math.HexOrDecimal256 `json:&quot;difficulty&quot;`</span>
<span class="term-fg32">+		Number                *math.HexOrDecimal256 `json:&quot;number&quot;           gencodec:&quot;required&quot;`</span>
<span class="term-fg32">+		GasLimit              *math.HexOrDecimal64  `json:&quot;gasLimit&quot;         gencodec:&quot;required&quot;`</span>
<span class="term-fg32">+		GasUsed               *math.HexOrDecimal64  `json:&quot;gasUsed&quot;`</span>
<span class="term-fg32">+		Time                  *math.HexOrDecimal64  `json:&quot;timestamp&quot;        gencodec:&quot;required&quot;`</span>
<span class="term-fg32">+		Extra                 *hexutil.Bytes        `json:&quot;extraData&quot;`</span>
<span class="term-fg32">+		MixDigest             *common.Hash          `json:&quot;mixHash&quot;`</span>
<span class="term-fg32">+		Nonce                 *types.BlockNonce     `json:&quot;nonce&quot;`</span>
<span class="term-fg32">+		BaseFee               *math.HexOrDecimal256 `json:&quot;baseFeePerGas&quot; rlp:&quot;optional&quot;`</span>
<span class="term-fg32">+		WithdrawalsHash       *common.Hash          `json:&quot;withdrawalsRoot&quot; rlp:&quot;optional&quot;`</span>
<span class="term-fg32">+		BlobGasUsed           *math.HexOrDecimal64  `json:&quot;blobGasUsed&quot;   rlp:&quot;optional&quot;`</span>
<span class="term-fg32">+		ExcessBlobGas         *math.HexOrDecimal64  `json:&quot;excessBlobGas&quot;   rlp:&quot;optional&quot;`</span>
<span class="term-fg32">+		ParentBeaconBlockRoot *common.Hash          `json:&quot;parentBeaconBlockRoot&quot; rlp:&quot;optional&quot;`</span>
 	}
 	var dec header
 	if err := json.Unmarshal(input, &amp;dec); err != nil {
<span class="term-fg36">@@ -136,6 +145,15 @@</span> 		h.BaseFee = (*big.Int)(dec.BaseFee)
 	}
 	if dec.WithdrawalsHash != nil {
 		h.WithdrawalsHash = dec.WithdrawalsHash
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	if dec.BlobGasUsed != nil {</span>
<span class="term-fg32">+		h.BlobGasUsed = (*uint64)(dec.BlobGasUsed)</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	if dec.ExcessBlobGas != nil {</span>
<span class="term-fg32">+		h.ExcessBlobGas = (*uint64)(dec.ExcessBlobGas)</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	if dec.ParentBeaconBlockRoot != nil {</span>
<span class="term-fg32">+		h.ParentBeaconBlockRoot = dec.ParentBeaconBlockRoot</span>
 	}
 	return nil
 }</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-48ef06fd5573f162cf07fc9f" role="button"
                   aria-expanded="false" aria-controls="id-48ef06fd5573f162cf07fc9f">
                    <code>cmd/evm/internal/t8ntool/gen_stenv.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/3f40e65c484486dea6cff80b7db178985d21a2c6/cmd/evm/internal/t8ntool/gen_stenv.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/650bb2f2b1dcfe30d9b1fa6f7dc9608055ed60e1/cmd/evm/internal/t8ntool/gen_stenv.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+2</span></div>
                        <div class="text-start"><span class="text-danger">-2</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-48ef06fd5573f162cf07fc9f"><span class="term-fg1">diff --git go-ethereum&#47;cmd&#47;evm&#47;internal&#47;t8ntool&#47;gen_stenv.go op-geth&#47;cmd&#47;evm&#47;internal&#47;t8ntool&#47;gen_stenv.go</span>
<span class="term-fg1">index bb195ef64bec0fd999a261ef0d9766314eeab678..d47db4a8765ee3b14ba478506b79bf0a4ff9ecc0 100644</span>
<span class="term-fg1">--- go-ethereum&#47;cmd&#47;evm&#47;internal&#47;t8ntool&#47;gen_stenv.go</span>
<span class="term-fg1">+++ op-geth&#47;cmd&#47;evm&#47;internal&#47;t8ntool&#47;gen_stenv.go</span>
<span class="term-fg36">@@ -33,7 +33,7 @@</span> 		Ommers                []ommer                             `json:&quot;ommers,omitempty&quot;`
 		Withdrawals           []*types.Withdrawal                 `json:&quot;withdrawals,omitempty&quot;`
 		BaseFee               *math.HexOrDecimal256               `json:&quot;currentBaseFee,omitempty&quot;`
 		ParentUncleHash       common.Hash                         `json:&quot;parentUncleHash&quot;`
<span class="term-fg31">-		ExcessBlobGas         *math.HexOrDecimal64                `json:&quot;excessBlobGas,omitempty&quot;`</span>
<span class="term-fg32">+		ExcessBlobGas         *math.HexOrDecimal64                `json:&quot;currentExcessBlobGas,omitempty&quot;`</span>
 		ParentExcessBlobGas   *math.HexOrDecimal64                `json:&quot;parentExcessBlobGas,omitempty&quot;`
 		ParentBlobGasUsed     *math.HexOrDecimal64                `json:&quot;parentBlobGasUsed,omitempty&quot;`
 		ParentBeaconBlockRoot *common.Hash                        `json:&quot;parentBeaconBlockRoot&quot;`
<span class="term-fg36">@@ -81,7 +81,7 @@</span> 		Ommers                []ommer                             `json:&quot;ommers,omitempty&quot;`
 		Withdrawals           []*types.Withdrawal                 `json:&quot;withdrawals,omitempty&quot;`
 		BaseFee               *math.HexOrDecimal256               `json:&quot;currentBaseFee,omitempty&quot;`
 		ParentUncleHash       *common.Hash                        `json:&quot;parentUncleHash&quot;`
<span class="term-fg31">-		ExcessBlobGas         *math.HexOrDecimal64                `json:&quot;excessBlobGas,omitempty&quot;`</span>
<span class="term-fg32">+		ExcessBlobGas         *math.HexOrDecimal64                `json:&quot;currentExcessBlobGas,omitempty&quot;`</span>
 		ParentExcessBlobGas   *math.HexOrDecimal64                `json:&quot;parentExcessBlobGas,omitempty&quot;`
 		ParentBlobGasUsed     *math.HexOrDecimal64                `json:&quot;parentBlobGasUsed,omitempty&quot;`
 		ParentBeaconBlockRoot *common.Hash                        `json:&quot;parentBeaconBlockRoot&quot;`</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-0efd85298a38a375ab7cbb85" role="button"
                   aria-expanded="false" aria-controls="id-0efd85298a38a375ab7cbb85">
                    <code>cmd/evm/internal/t8ntool/transition.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/3f40e65c484486dea6cff80b7db178985d21a2c6/cmd/evm/internal/t8ntool/transition.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/650bb2f2b1dcfe30d9b1fa6f7dc9608055ed60e1/cmd/evm/internal/t8ntool/transition.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+1</span></div>
                        <div class="text-start"><span class="text-danger">-1</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-0efd85298a38a375ab7cbb85"><span class="term-fg1">diff --git go-ethereum&#47;cmd&#47;evm&#47;internal&#47;t8ntool&#47;transition.go op-geth&#47;cmd&#47;evm&#47;internal&#47;t8ntool&#47;transition.go</span>
<span class="term-fg1">index 396b341d2ef1040da4cf73e3f78154880da1a210..600bc460f726c4344e8611e2c023bda53ad6c4fd 100644</span>
<span class="term-fg1">--- go-ethereum&#47;cmd&#47;evm&#47;internal&#47;t8ntool&#47;transition.go</span>
<span class="term-fg1">+++ op-geth&#47;cmd&#47;evm&#47;internal&#47;t8ntool&#47;transition.go</span>
<span class="term-fg36">@@ -334,7 +334,7 @@</span> 		&#47;&#47; JSON encoded transactions
 		txsWithKeys = inputData.Txs
 	}
 	&#47;&#47; We may have to sign the transactions.
<span class="term-fg31">-	signer := types.MakeSigner(chainConfig, big.NewInt(int64(env.Number)), env.Timestamp)</span>
<span class="term-fg32">+	signer := types.LatestSignerForChainID(chainConfig.ChainID)</span>
 	return signUnsignedTransactions(txsWithKeys, signer)
 }
</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-7216b1759ee2cb9a4d8349f9" role="button"
                   aria-expanded="false" aria-controls="id-7216b1759ee2cb9a4d8349f9">
                    <code>cmd/evm/main.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/3f40e65c484486dea6cff80b7db178985d21a2c6/cmd/evm/main.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/650bb2f2b1dcfe30d9b1fa6f7dc9608055ed60e1/cmd/evm/main.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+103</span></div>
                        <div class="text-start"><span class="text-danger">-82</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-7216b1759ee2cb9a4d8349f9"><span class="term-fg1">diff --git go-ethereum&#47;cmd&#47;evm&#47;main.go op-geth&#47;cmd&#47;evm&#47;main.go</span>
<span class="term-fg1">index 024be62b9c5419db53e0f20c0ad333c6c252ba54..1f6500b78c6cfd73f29a2984eedc97bef0820e0d 100644</span>
<span class="term-fg1">--- go-ethereum&#47;cmd&#47;evm&#47;main.go</span>
<span class="term-fg1">+++ op-geth&#47;cmd&#47;evm&#47;main.go</span>
<span class="term-fg36">@@ -23,107 +23,116 @@</span> 	&quot;math&#47;big&quot;
 	&quot;os&quot;
&nbsp;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;cmd&#47;evm&#47;internal&#47;t8ntool&quot;
<span class="term-fg32">+	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;internal&#47;debug&quot;</span>
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;internal&#47;flags&quot;
 	&quot;github.com&#47;urfave&#47;cli&#47;v2&quot;
 )
&nbsp;
 var (
 	DebugFlag = &amp;cli.BoolFlag{
<span class="term-fg31">-		Name:  &quot;debug&quot;,</span>
<span class="term-fg31">-		Usage: &quot;output full trace logs&quot;,</span>
<span class="term-fg31">-	}</span>
<span class="term-fg31">-	MemProfileFlag = &amp;cli.StringFlag{</span>
<span class="term-fg31">-		Name:  &quot;memprofile&quot;,</span>
<span class="term-fg31">-		Usage: &quot;creates a memory profile at the given path&quot;,</span>
<span class="term-fg31">-	}</span>
<span class="term-fg31">-	CPUProfileFlag = &amp;cli.StringFlag{</span>
<span class="term-fg31">-		Name:  &quot;cpuprofile&quot;,</span>
<span class="term-fg31">-		Usage: &quot;creates a CPU profile at the given path&quot;,</span>
<span class="term-fg32">+		Name:     &quot;debug&quot;,</span>
<span class="term-fg32">+		Usage:    &quot;output full trace logs&quot;,</span>
<span class="term-fg32">+		Category: flags.VMCategory,</span>
 	}
 	StatDumpFlag = &amp;cli.BoolFlag{
<span class="term-fg31">-		Name:  &quot;statdump&quot;,</span>
<span class="term-fg31">-		Usage: &quot;displays stack and heap memory information&quot;,</span>
<span class="term-fg32">+		Name:     &quot;statdump&quot;,</span>
<span class="term-fg32">+		Usage:    &quot;displays stack and heap memory information&quot;,</span>
<span class="term-fg32">+		Category: flags.VMCategory,</span>
 	}
 	CodeFlag = &amp;cli.StringFlag{
<span class="term-fg31">-		Name:  &quot;code&quot;,</span>
<span class="term-fg31">-		Usage: &quot;EVM code&quot;,</span>
<span class="term-fg32">+		Name:     &quot;code&quot;,</span>
<span class="term-fg32">+		Usage:    &quot;EVM code&quot;,</span>
<span class="term-fg32">+		Category: flags.VMCategory,</span>
 	}
 	CodeFileFlag = &amp;cli.StringFlag{
<span class="term-fg31">-		Name:  &quot;codefile&quot;,</span>
<span class="term-fg31">-		Usage: &quot;File containing EVM code. If &#39;-&#39; is specified, code is read from stdin &quot;,</span>
<span class="term-fg32">+		Name:     &quot;codefile&quot;,</span>
<span class="term-fg32">+		Usage:    &quot;File containing EVM code. If &#39;-&#39; is specified, code is read from stdin &quot;,</span>
<span class="term-fg32">+		Category: flags.VMCategory,</span>
 	}
 	GasFlag = &amp;cli.Uint64Flag{
<span class="term-fg31">-		Name:  &quot;gas&quot;,</span>
<span class="term-fg31">-		Usage: &quot;gas limit for the evm&quot;,</span>
<span class="term-fg31">-		Value: 10000000000,</span>
<span class="term-fg32">+		Name:     &quot;gas&quot;,</span>
<span class="term-fg32">+		Usage:    &quot;gas limit for the evm&quot;,</span>
<span class="term-fg32">+		Value:    10000000000,</span>
<span class="term-fg32">+		Category: flags.VMCategory,</span>
 	}
 	PriceFlag = &amp;flags.BigFlag{
<span class="term-fg31">-		Name:  &quot;price&quot;,</span>
<span class="term-fg31">-		Usage: &quot;price set for the evm&quot;,</span>
<span class="term-fg31">-		Value: new(big.Int),</span>
<span class="term-fg32">+		Name:     &quot;price&quot;,</span>
<span class="term-fg32">+		Usage:    &quot;price set for the evm&quot;,</span>
<span class="term-fg32">+		Value:    new(big.Int),</span>
<span class="term-fg32">+		Category: flags.VMCategory,</span>
 	}
 	ValueFlag = &amp;flags.BigFlag{
<span class="term-fg31">-		Name:  &quot;value&quot;,</span>
<span class="term-fg31">-		Usage: &quot;value set for the evm&quot;,</span>
<span class="term-fg31">-		Value: new(big.Int),</span>
<span class="term-fg32">+		Name:     &quot;value&quot;,</span>
<span class="term-fg32">+		Usage:    &quot;value set for the evm&quot;,</span>
<span class="term-fg32">+		Value:    new(big.Int),</span>
<span class="term-fg32">+		Category: flags.VMCategory,</span>
 	}
 	DumpFlag = &amp;cli.BoolFlag{
<span class="term-fg31">-		Name:  &quot;dump&quot;,</span>
<span class="term-fg31">-		Usage: &quot;dumps the state after the run&quot;,</span>
<span class="term-fg32">+		Name:     &quot;dump&quot;,</span>
<span class="term-fg32">+		Usage:    &quot;dumps the state after the run&quot;,</span>
<span class="term-fg32">+		Category: flags.VMCategory,</span>
 	}
 	InputFlag = &amp;cli.StringFlag{
<span class="term-fg31">-		Name:  &quot;input&quot;,</span>
<span class="term-fg31">-		Usage: &quot;input for the EVM&quot;,</span>
<span class="term-fg32">+		Name:     &quot;input&quot;,</span>
<span class="term-fg32">+		Usage:    &quot;input for the EVM&quot;,</span>
<span class="term-fg32">+		Category: flags.VMCategory,</span>
 	}
 	InputFileFlag = &amp;cli.StringFlag{
<span class="term-fg31">-		Name:  &quot;inputfile&quot;,</span>
<span class="term-fg31">-		Usage: &quot;file containing input for the EVM&quot;,</span>
<span class="term-fg31">-	}</span>
<span class="term-fg31">-	VerbosityFlag = &amp;cli.IntFlag{</span>
<span class="term-fg31">-		Name:  &quot;verbosity&quot;,</span>
<span class="term-fg31">-		Usage: &quot;sets the verbosity level&quot;,</span>
<span class="term-fg32">+		Name:     &quot;inputfile&quot;,</span>
<span class="term-fg32">+		Usage:    &quot;file containing input for the EVM&quot;,</span>
<span class="term-fg32">+		Category: flags.VMCategory,</span>
 	}
 	BenchFlag = &amp;cli.BoolFlag{
<span class="term-fg31">-		Name:  &quot;bench&quot;,</span>
<span class="term-fg31">-		Usage: &quot;benchmark the execution&quot;,</span>
<span class="term-fg32">+		Name:     &quot;bench&quot;,</span>
<span class="term-fg32">+		Usage:    &quot;benchmark the execution&quot;,</span>
<span class="term-fg32">+		Category: flags.VMCategory,</span>
 	}
 	CreateFlag = &amp;cli.BoolFlag{
<span class="term-fg31">-		Name:  &quot;create&quot;,</span>
<span class="term-fg31">-		Usage: &quot;indicates the action should be create rather than call&quot;,</span>
<span class="term-fg32">+		Name:     &quot;create&quot;,</span>
<span class="term-fg32">+		Usage:    &quot;indicates the action should be create rather than call&quot;,</span>
<span class="term-fg32">+		Category: flags.VMCategory,</span>
 	}
 	GenesisFlag = &amp;cli.StringFlag{
<span class="term-fg31">-		Name:  &quot;prestate&quot;,</span>
<span class="term-fg31">-		Usage: &quot;JSON file with prestate (genesis) config&quot;,</span>
<span class="term-fg32">+		Name:     &quot;prestate&quot;,</span>
<span class="term-fg32">+		Usage:    &quot;JSON file with prestate (genesis) config&quot;,</span>
<span class="term-fg32">+		Category: flags.VMCategory,</span>
 	}
 	MachineFlag = &amp;cli.BoolFlag{
<span class="term-fg31">-		Name:  &quot;json&quot;,</span>
<span class="term-fg31">-		Usage: &quot;output trace logs in machine readable format (json)&quot;,</span>
<span class="term-fg32">+		Name:     &quot;json&quot;,</span>
<span class="term-fg32">+		Usage:    &quot;output trace logs in machine readable format (json)&quot;,</span>
<span class="term-fg32">+		Category: flags.VMCategory,</span>
 	}
 	SenderFlag = &amp;cli.StringFlag{
<span class="term-fg31">-		Name:  &quot;sender&quot;,</span>
<span class="term-fg31">-		Usage: &quot;The transaction origin&quot;,</span>
<span class="term-fg32">+		Name:     &quot;sender&quot;,</span>
<span class="term-fg32">+		Usage:    &quot;The transaction origin&quot;,</span>
<span class="term-fg32">+		Category: flags.VMCategory,</span>
 	}
 	ReceiverFlag = &amp;cli.StringFlag{
<span class="term-fg31">-		Name:  &quot;receiver&quot;,</span>
<span class="term-fg31">-		Usage: &quot;The transaction receiver (execution context)&quot;,</span>
<span class="term-fg32">+		Name:     &quot;receiver&quot;,</span>
<span class="term-fg32">+		Usage:    &quot;The transaction receiver (execution context)&quot;,</span>
<span class="term-fg32">+		Category: flags.VMCategory,</span>
 	}
 	DisableMemoryFlag = &amp;cli.BoolFlag{
<span class="term-fg31">-		Name:  &quot;nomemory&quot;,</span>
<span class="term-fg31">-		Value: true,</span>
<span class="term-fg31">-		Usage: &quot;disable memory output&quot;,</span>
<span class="term-fg32">+		Name:     &quot;nomemory&quot;,</span>
<span class="term-fg32">+		Value:    true,</span>
<span class="term-fg32">+		Usage:    &quot;disable memory output&quot;,</span>
<span class="term-fg32">+		Category: flags.VMCategory,</span>
 	}
 	DisableStackFlag = &amp;cli.BoolFlag{
<span class="term-fg31">-		Name:  &quot;nostack&quot;,</span>
<span class="term-fg31">-		Usage: &quot;disable stack output&quot;,</span>
<span class="term-fg32">+		Name:     &quot;nostack&quot;,</span>
<span class="term-fg32">+		Usage:    &quot;disable stack output&quot;,</span>
<span class="term-fg32">+		Category: flags.VMCategory,</span>
 	}
 	DisableStorageFlag = &amp;cli.BoolFlag{
<span class="term-fg31">-		Name:  &quot;nostorage&quot;,</span>
<span class="term-fg31">-		Usage: &quot;disable storage output&quot;,</span>
<span class="term-fg32">+		Name:     &quot;nostorage&quot;,</span>
<span class="term-fg32">+		Usage:    &quot;disable storage output&quot;,</span>
<span class="term-fg32">+		Category: flags.VMCategory,</span>
 	}
 	DisableReturnDataFlag = &amp;cli.BoolFlag{
<span class="term-fg31">-		Name:  &quot;noreturndata&quot;,</span>
<span class="term-fg31">-		Value: true,</span>
<span class="term-fg31">-		Usage: &quot;enable return data output&quot;,</span>
<span class="term-fg32">+		Name:     &quot;noreturndata&quot;,</span>
<span class="term-fg32">+		Value:    true,</span>
<span class="term-fg32">+		Usage:    &quot;enable return data output&quot;,</span>
<span class="term-fg32">+		Category: flags.VMCategory,</span>
 	}
 )
&nbsp;
<span class="term-fg36">@@ -183,34 +192,38 @@</span> 		t8ntool.VerbosityFlag,
 	},
 }
&nbsp;
<span class="term-fg32">+&#47;&#47; vmFlags contains flags related to running the EVM.</span>
<span class="term-fg32">+var vmFlags = []cli.Flag{</span>
<span class="term-fg32">+	CodeFlag,</span>
<span class="term-fg32">+	CodeFileFlag,</span>
<span class="term-fg32">+	CreateFlag,</span>
<span class="term-fg32">+	GasFlag,</span>
<span class="term-fg32">+	PriceFlag,</span>
<span class="term-fg32">+	ValueFlag,</span>
<span class="term-fg32">+	InputFlag,</span>
<span class="term-fg32">+	InputFileFlag,</span>
<span class="term-fg32">+	GenesisFlag,</span>
<span class="term-fg32">+	SenderFlag,</span>
<span class="term-fg32">+	ReceiverFlag,</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+&#47;&#47; traceFlags contains flags that configure tracing output.</span>
<span class="term-fg32">+var traceFlags = []cli.Flag{</span>
<span class="term-fg32">+	BenchFlag,</span>
<span class="term-fg32">+	DebugFlag,</span>
<span class="term-fg32">+	DumpFlag,</span>
<span class="term-fg32">+	MachineFlag,</span>
<span class="term-fg32">+	StatDumpFlag,</span>
<span class="term-fg32">+	DisableMemoryFlag,</span>
<span class="term-fg32">+	DisableStackFlag,</span>
<span class="term-fg32">+	DisableStorageFlag,</span>
<span class="term-fg32">+	DisableReturnDataFlag,</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
 var app = flags.NewApp(&quot;the evm command line interface&quot;)
&nbsp;
 func init() {
<span class="term-fg31">-	app.Flags = []cli.Flag{</span>
<span class="term-fg31">-		BenchFlag,</span>
<span class="term-fg31">-		CreateFlag,</span>
<span class="term-fg31">-		DebugFlag,</span>
<span class="term-fg31">-		VerbosityFlag,</span>
<span class="term-fg31">-		CodeFlag,</span>
<span class="term-fg31">-		CodeFileFlag,</span>
<span class="term-fg31">-		GasFlag,</span>
<span class="term-fg31">-		PriceFlag,</span>
<span class="term-fg31">-		ValueFlag,</span>
<span class="term-fg31">-		DumpFlag,</span>
<span class="term-fg31">-		InputFlag,</span>
<span class="term-fg31">-		InputFileFlag,</span>
<span class="term-fg31">-		MemProfileFlag,</span>
<span class="term-fg31">-		CPUProfileFlag,</span>
<span class="term-fg31">-		StatDumpFlag,</span>
<span class="term-fg31">-		GenesisFlag,</span>
<span class="term-fg31">-		MachineFlag,</span>
<span class="term-fg31">-		SenderFlag,</span>
<span class="term-fg31">-		ReceiverFlag,</span>
<span class="term-fg31">-		DisableMemoryFlag,</span>
<span class="term-fg31">-		DisableStackFlag,</span>
<span class="term-fg31">-		DisableStorageFlag,</span>
<span class="term-fg31">-		DisableReturnDataFlag,</span>
<span class="term-fg31">-	}</span>
<span class="term-fg32">+	app.Flags = flags.Merge(vmFlags, traceFlags, debug.Flags)</span>
 	app.Commands = []*cli.Command{
 		compileCommand,
 		disasmCommand,
<span class="term-fg36">@@ -220,6 +233,14 @@</span> 		stateTestCommand,
 		stateTransitionCommand,
 		transactionCommand,
 		blockBuilderCommand,
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	app.Before = func(ctx *cli.Context) error {</span>
<span class="term-fg32">+		flags.MigrateGlobalFlags(ctx)</span>
<span class="term-fg32">+		return debug.Setup(ctx)</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	app.After = func(ctx *cli.Context) error {</span>
<span class="term-fg32">+		debug.Exit()</span>
<span class="term-fg32">+		return nil</span>
 	}
 }
</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-7df3417c56340b95986e5c3e" role="button"
                   aria-expanded="false" aria-controls="id-7df3417c56340b95986e5c3e">
                    <code>cmd/evm/runner.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/3f40e65c484486dea6cff80b7db178985d21a2c6/cmd/evm/runner.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/650bb2f2b1dcfe30d9b1fa6f7dc9608055ed60e1/cmd/evm/runner.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+32</span></div>
                        <div class="text-start"><span class="text-danger">-66</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-7df3417c56340b95986e5c3e"><span class="term-fg1">diff --git go-ethereum&#47;cmd&#47;evm&#47;runner.go op-geth&#47;cmd&#47;evm&#47;runner.go</span>
<span class="term-fg1">index ac8432badb19a49ca3d0899daba91b4c282b285a..45fc9853519f6d9531a031f9610d79110c1ca910 100644</span>
<span class="term-fg1">--- go-ethereum&#47;cmd&#47;evm&#47;runner.go</span>
<span class="term-fg1">+++ op-geth&#47;cmd&#47;evm&#47;runner.go</span>
<span class="term-fg36">@@ -24,7 +24,6 @@</span> 	&quot;io&quot;
 	&quot;math&#47;big&quot;
 	&quot;os&quot;
 	goruntime &quot;runtime&quot;
<span class="term-fg31">-	&quot;runtime&#47;pprof&quot;</span>
 	&quot;testing&quot;
 	&quot;time&quot;
&nbsp;
<span class="term-fg36">@@ -34,12 +33,10 @@</span> 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;common&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;core&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;core&#47;rawdb&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;core&#47;state&quot;
<span class="term-fg31">-	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;core&#47;types&quot;</span>
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;core&#47;vm&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;core&#47;vm&#47;runtime&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;eth&#47;tracers&#47;logger&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;internal&#47;flags&quot;
<span class="term-fg31">-	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;log&quot;</span>
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;params&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;trie&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;trie&#47;triedb&#47;hashdb&quot;
<span class="term-fg36">@@ -52,6 +49,7 @@</span> 	Name:        &quot;run&quot;,
 	Usage:       &quot;run arbitrary evm binary&quot;,
 	ArgsUsage:   &quot;&lt;code&gt;&quot;,
 	Description: `The run command runs arbitrary EVM code.`,
<span class="term-fg32">+	Flags:       flags.Merge(vmFlags, traceFlags),</span>
 }
&nbsp;
 &#47;&#47; readGenesis will read the given JSON format genesis file and return
<span class="term-fg36">@@ -109,9 +107,6 @@</span> 	return output, gasLeft, stats, err
 }
&nbsp;
 func runCmd(ctx *cli.Context) error {
<span class="term-fg31">-	glogger := log.NewGlogHandler(log.StreamHandler(os.Stderr, log.TerminalFormat(false)))</span>
<span class="term-fg31">-	glogger.Verbosity(log.Lvl(ctx.Int(VerbosityFlag.Name)))</span>
<span class="term-fg31">-	log.Root().SetHandler(glogger)</span>
 	logconfig := &amp;logger.Config{
 		EnableMemory:     !ctx.Bool(DisableMemoryFlag.Name),
 		DisableStack:     ctx.Bool(DisableStackFlag.Name),
<span class="term-fg36">@@ -121,15 +116,15 @@</span> 		Debug:            ctx.Bool(DebugFlag.Name),
 	}
&nbsp;
 	var (
<span class="term-fg31">-		tracer        vm.EVMLogger</span>
<span class="term-fg31">-		debugLogger   *logger.StructLogger</span>
<span class="term-fg31">-		statedb       *state.StateDB</span>
<span class="term-fg31">-		chainConfig   *params.ChainConfig</span>
<span class="term-fg31">-		sender        = common.BytesToAddress([]byte(&quot;sender&quot;))</span>
<span class="term-fg31">-		receiver      = common.BytesToAddress([]byte(&quot;receiver&quot;))</span>
<span class="term-fg31">-		genesisConfig *core.Genesis</span>
<span class="term-fg31">-		preimages     = ctx.Bool(DumpFlag.Name)</span>
<span class="term-fg31">-		blobHashes    []common.Hash &#47;&#47; TODO (MariusVanDerWijden) implement blob hashes in state tests</span>
<span class="term-fg32">+		tracer      vm.EVMLogger</span>
<span class="term-fg32">+		debugLogger *logger.StructLogger</span>
<span class="term-fg32">+		statedb     *state.StateDB</span>
<span class="term-fg32">+		chainConfig *params.ChainConfig</span>
<span class="term-fg32">+		sender      = common.BytesToAddress([]byte(&quot;sender&quot;))</span>
<span class="term-fg32">+		receiver    = common.BytesToAddress([]byte(&quot;receiver&quot;))</span>
<span class="term-fg32">+		preimages   = ctx.Bool(DumpFlag.Name)</span>
<span class="term-fg32">+		blobHashes  []common.Hash  &#47;&#47; TODO (MariusVanDerWijden) implement blob hashes in state tests</span>
<span class="term-fg32">+		blobBaseFee = new(big.Int) &#47;&#47; TODO (MariusVanDerWijden) implement blob fee in state tests</span>
 	)
 	if ctx.Bool(MachineFlag.Name) {
 		tracer = logger.NewJSONLogger(logconfig, os.Stdout)
<span class="term-fg36">@@ -139,30 +134,30 @@</span> 		tracer = debugLogger
 	} else {
 		debugLogger = logger.NewStructLogger(logconfig)
 	}
<span class="term-fg32">+</span>
<span class="term-fg32">+	initialGas := ctx.Uint64(GasFlag.Name)</span>
<span class="term-fg32">+	genesisConfig := new(core.Genesis)</span>
<span class="term-fg32">+	genesisConfig.GasLimit = initialGas</span>
 	if ctx.String(GenesisFlag.Name) != &quot;&quot; {
<span class="term-fg31">-		gen := readGenesis(ctx.String(GenesisFlag.Name))</span>
<span class="term-fg31">-		genesisConfig = gen</span>
<span class="term-fg31">-		db := rawdb.NewMemoryDatabase()</span>
<span class="term-fg31">-		triedb := trie.NewDatabase(db, &amp;trie.Config{</span>
<span class="term-fg31">-			Preimages: preimages,</span>
<span class="term-fg31">-			HashDB:    hashdb.Defaults,</span>
<span class="term-fg31">-		})</span>
<span class="term-fg31">-		defer triedb.Close()</span>
<span class="term-fg31">-		genesis := gen.MustCommit(db, triedb)</span>
<span class="term-fg31">-		sdb := state.NewDatabaseWithNodeDB(db, triedb)</span>
<span class="term-fg31">-		statedb, _ = state.New(genesis.Root(), sdb, nil)</span>
<span class="term-fg31">-		chainConfig = gen.Config</span>
<span class="term-fg32">+		genesisConfig = readGenesis(ctx.String(GenesisFlag.Name))</span>
<span class="term-fg32">+		if genesisConfig.GasLimit != 0 {</span>
<span class="term-fg32">+			initialGas = genesisConfig.GasLimit</span>
<span class="term-fg32">+		}</span>
 	} else {
<span class="term-fg31">-		db := rawdb.NewMemoryDatabase()</span>
<span class="term-fg31">-		triedb := trie.NewDatabase(db, &amp;trie.Config{</span>
<span class="term-fg31">-			Preimages: preimages,</span>
<span class="term-fg31">-			HashDB:    hashdb.Defaults,</span>
<span class="term-fg31">-		})</span>
<span class="term-fg31">-		defer triedb.Close()</span>
<span class="term-fg31">-		sdb := state.NewDatabaseWithNodeDB(db, triedb)</span>
<span class="term-fg31">-		statedb, _ = state.New(types.EmptyRootHash, sdb, nil)</span>
<span class="term-fg31">-		genesisConfig = new(core.Genesis)</span>
<span class="term-fg32">+		genesisConfig.Config = params.AllEthashProtocolChanges</span>
 	}
<span class="term-fg32">+</span>
<span class="term-fg32">+	db := rawdb.NewMemoryDatabase()</span>
<span class="term-fg32">+	triedb := trie.NewDatabase(db, &amp;trie.Config{</span>
<span class="term-fg32">+		Preimages: preimages,</span>
<span class="term-fg32">+		HashDB:    hashdb.Defaults,</span>
<span class="term-fg32">+	})</span>
<span class="term-fg32">+	defer triedb.Close()</span>
<span class="term-fg32">+	genesis := genesisConfig.MustCommit(db, triedb)</span>
<span class="term-fg32">+	sdb := state.NewDatabaseWithNodeDB(db, triedb)</span>
<span class="term-fg32">+	statedb, _ = state.New(genesis.Root(), sdb, nil)</span>
<span class="term-fg32">+	chainConfig = genesisConfig.Config</span>
<span class="term-fg32">+</span>
 	if ctx.String(SenderFlag.Name) != &quot;&quot; {
 		sender = common.HexToAddress(ctx.String(SenderFlag.Name))
 	}
<span class="term-fg36">@@ -216,10 +211,6 @@</span> 			return err
 		}
 		code = common.Hex2Bytes(bin)
 	}
<span class="term-fg31">-	initialGas := ctx.Uint64(GasFlag.Name)</span>
<span class="term-fg31">-	if genesisConfig.GasLimit != 0 {</span>
<span class="term-fg31">-		initialGas = genesisConfig.GasLimit</span>
<span class="term-fg31">-	}</span>
 	runtimeConfig := runtime.Config{
 		Origin:      sender,
 		State:       statedb,
<span class="term-fg36">@@ -231,24 +222,12 @@</span> 		Time:        genesisConfig.Timestamp,
 		Coinbase:    genesisConfig.Coinbase,
 		BlockNumber: new(big.Int).SetUint64(genesisConfig.Number),
 		BlobHashes:  blobHashes,
<span class="term-fg32">+		BlobBaseFee: blobBaseFee,</span>
 		EVMConfig: vm.Config{
 			Tracer: tracer,
 		},
 	}
&nbsp;
<span class="term-fg31">-	if cpuProfilePath := ctx.String(CPUProfileFlag.Name); cpuProfilePath != &quot;&quot; {</span>
<span class="term-fg31">-		f, err := os.Create(cpuProfilePath)</span>
<span class="term-fg31">-		if err != nil {</span>
<span class="term-fg31">-			fmt.Println(&quot;could not create CPU profile: &quot;, err)</span>
<span class="term-fg31">-			os.Exit(1)</span>
<span class="term-fg31">-		}</span>
<span class="term-fg31">-		if err := pprof.StartCPUProfile(f); err != nil {</span>
<span class="term-fg31">-			fmt.Println(&quot;could not start CPU profile: &quot;, err)</span>
<span class="term-fg31">-			os.Exit(1)</span>
<span class="term-fg31">-		}</span>
<span class="term-fg31">-		defer pprof.StopCPUProfile()</span>
<span class="term-fg31">-	}</span>
<span class="term-fg31">-</span>
 	if chainConfig != nil {
 		runtimeConfig.ChainConfig = chainConfig
 	} else {
<span class="term-fg36">@@ -294,19 +273,6 @@</span>
 	if ctx.Bool(DumpFlag.Name) {
 		statedb.Commit(genesisConfig.Number, true)
 		fmt.Println(string(statedb.Dump(nil)))
<span class="term-fg31">-	}</span>
<span class="term-fg31">-</span>
<span class="term-fg31">-	if memProfilePath := ctx.String(MemProfileFlag.Name); memProfilePath != &quot;&quot; {</span>
<span class="term-fg31">-		f, err := os.Create(memProfilePath)</span>
<span class="term-fg31">-		if err != nil {</span>
<span class="term-fg31">-			fmt.Println(&quot;could not create memory profile: &quot;, err)</span>
<span class="term-fg31">-			os.Exit(1)</span>
<span class="term-fg31">-		}</span>
<span class="term-fg31">-		if err := pprof.WriteHeapProfile(f); err != nil {</span>
<span class="term-fg31">-			fmt.Println(&quot;could not write memory profile: &quot;, err)</span>
<span class="term-fg31">-			os.Exit(1)</span>
<span class="term-fg31">-		}</span>
<span class="term-fg31">-		f.Close()</span>
 	}
&nbsp;
 	if ctx.Bool(DebugFlag.Name) {</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-6f8d4027d49d79ae3b2ab3f8" role="button"
                   aria-expanded="false" aria-controls="id-6f8d4027d49d79ae3b2ab3f8">
                    <code>cmd/evm/staterunner.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/3f40e65c484486dea6cff80b7db178985d21a2c6/cmd/evm/staterunner.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/650bb2f2b1dcfe30d9b1fa6f7dc9608055ed60e1/cmd/evm/staterunner.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+0</span></div>
                        <div class="text-start"><span class="text-danger">-6</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-6f8d4027d49d79ae3b2ab3f8"><span class="term-fg1">diff --git go-ethereum&#47;cmd&#47;evm&#47;staterunner.go op-geth&#47;cmd&#47;evm&#47;staterunner.go</span>
<span class="term-fg1">index 85931f0406830413dc67a71c4c8b8a0060b36b4c..8a07fccdf88669592f7cbc79a6ecccff4729edc3 100644</span>
<span class="term-fg1">--- go-ethereum&#47;cmd&#47;evm&#47;staterunner.go</span>
<span class="term-fg1">+++ op-geth&#47;cmd&#47;evm&#47;staterunner.go</span>
<span class="term-fg36">@@ -28,7 +28,6 @@</span> 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;core&#47;state&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;core&#47;state&#47;snapshot&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;core&#47;vm&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;eth&#47;tracers&#47;logger&quot;
<span class="term-fg31">-	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;log&quot;</span>
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;tests&quot;
 	&quot;github.com&#47;urfave&#47;cli&#47;v2&quot;
 )
<span class="term-fg36">@@ -52,11 +51,6 @@</span> 	State *state.Dump  `json:&quot;state,omitempty&quot;`
 }
&nbsp;
 func stateTestCmd(ctx *cli.Context) error {
<span class="term-fg31">-	&#47;&#47; Configure the go-ethereum logger</span>
<span class="term-fg31">-	glogger := log.NewGlogHandler(log.StreamHandler(os.Stderr, log.TerminalFormat(false)))</span>
<span class="term-fg31">-	glogger.Verbosity(log.Lvl(ctx.Int(VerbosityFlag.Name)))</span>
<span class="term-fg31">-	log.Root().SetHandler(glogger)</span>
<span class="term-fg31">-</span>
 	&#47;&#47; Configure the EVM logger
 	config := &amp;logger.Config{
 		EnableMemory:     !ctx.Bool(DisableMemoryFlag.Name),</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-3ea4323c28a6c36877a155fe" role="button"
                   aria-expanded="false" aria-controls="id-3ea4323c28a6c36877a155fe">
                    <code>cmd/evm/testdata/28/env.json</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/3f40e65c484486dea6cff80b7db178985d21a2c6/cmd/evm/testdata/28/env.json" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/650bb2f2b1dcfe30d9b1fa6f7dc9608055ed60e1/cmd/evm/testdata/28/env.json" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+2</span></div>
                        <div class="text-start"><span class="text-danger">-2</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-3ea4323c28a6c36877a155fe"><span class="term-fg1">diff --git go-ethereum&#47;cmd&#47;evm&#47;testdata&#47;28&#47;env.json op-geth&#47;cmd&#47;evm&#47;testdata&#47;28&#47;env.json</span>
<span class="term-fg1">index 5056fe29a45c576273d93c60e42e695c1f2494b8..82f22ac62f4c42f6439c670a64385299c894b194 100644</span>
<span class="term-fg1">--- go-ethereum&#47;cmd&#47;evm&#47;testdata&#47;28&#47;env.json</span>
<span class="term-fg1">+++ op-geth&#47;cmd&#47;evm&#47;testdata&#47;28&#47;env.json</span>
<span class="term-fg36">@@ -9,8 +9,7 @@</span>     &quot;parentTimestamp&quot; : &quot;0x03b6&quot;,
     &quot;parentDifficulty&quot; : &quot;0x00&quot;,
     &quot;parentUncleHash&quot; : &quot;0x1dcc4de8dec75d7aab85b567b6ccd41ad312451b948a7413f0a142fd40d49347&quot;,
     &quot;currentRandom&quot; : &quot;0x56e81f171bcc55a6ff8345e692c0f86e5b48e01b996cadc001622fb5e363b421&quot;,
<span class="term-fg31">-    &quot;withdrawals&quot; : [</span>
<span class="term-fg31">-    ],</span>
<span class="term-fg32">+    &quot;withdrawals&quot; : [],</span>
     &quot;parentBaseFee&quot; : &quot;0x0a&quot;,
     &quot;parentGasUsed&quot; : &quot;0x00&quot;,
     &quot;parentGasLimit&quot; : &quot;0x7fffffffffffffff&quot;,
<span class="term-fg36">@@ -20,4 +19,4 @@</span>     &quot;blockHashes&quot; : {
         &quot;0&quot; : &quot;0x3a9b485972e7353edd9152712492f0c58d89ef80623686b6bf947a4a6dce6cb6&quot;
     },
     &quot;parentBeaconBlockRoot&quot;: &quot;0x0000beac00beac00beac00beac00beac00beac00beac00beac00beac00beac00&quot;
<span class="term-fg31">-}</span>
<span class="term-fg31">\ No newline at end of file</span>
<span class="term-fg32">+}</span></div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-98f0a18f9c72c5583c609fb4" role="button"
                   aria-expanded="false" aria-controls="id-98f0a18f9c72c5583c609fb4">
                    <code>cmd/evm/testdata/28/exp.json</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/3f40e65c484486dea6cff80b7db178985d21a2c6/cmd/evm/testdata/28/exp.json" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/650bb2f2b1dcfe30d9b1fa6f7dc9608055ed60e1/cmd/evm/testdata/28/exp.json" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+2</span></div>
                        <div class="text-start"><span class="text-danger">-1</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-98f0a18f9c72c5583c609fb4"><span class="term-fg1">diff --git go-ethereum&#47;cmd&#47;evm&#47;testdata&#47;28&#47;exp.json op-geth&#47;cmd&#47;evm&#47;testdata&#47;28&#47;exp.json</span>
<span class="term-fg1">index a55ce0aec431d18ab5d42c413a7696ed4e089b2e..75c715e9722319c7d7cedf9cf24e6c41fe883ba6 100644</span>
<span class="term-fg1">--- go-ethereum&#47;cmd&#47;evm&#47;testdata&#47;28&#47;exp.json</span>
<span class="term-fg1">+++ op-geth&#47;cmd&#47;evm&#47;testdata&#47;28&#47;exp.json</span>
<span class="term-fg36">@@ -42,6 +42,6 @@</span>     &quot;gasUsed&quot;: &quot;0xa865&quot;,
     &quot;currentBaseFee&quot;: &quot;0x9&quot;,
     &quot;withdrawalsRoot&quot;: &quot;0x56e81f171bcc55a6ff8345e692c0f86e5b48e01b996cadc001622fb5e363b421&quot;,
     &quot;currentExcessBlobGas&quot;: &quot;0x0&quot;,
<span class="term-fg31">-    &quot;currentBlobGasUsed&quot;: &quot;0x20000&quot;</span>
<span class="term-fg32">+    &quot;blobGasUsed&quot;: &quot;0x20000&quot;</span>
   }
<span class="term-fg31">-}</span>
<span class="term-fg31">\ No newline at end of file</span>
<span class="term-fg32">+}</span></div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-74b717262c5dae96e5f036b5" role="button"
                   aria-expanded="false" aria-controls="id-74b717262c5dae96e5f036b5">
                    <code>cmd/evm/testdata/29/alloc.json</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/3f40e65c484486dea6cff80b7db178985d21a2c6/cmd/evm/testdata/29/alloc.json" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/650bb2f2b1dcfe30d9b1fa6f7dc9608055ed60e1/cmd/evm/testdata/29/alloc.json" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+1</span></div>
                        <div class="text-start"><span class="text-danger">-1</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-74b717262c5dae96e5f036b5"><span class="term-fg1">diff --git go-ethereum&#47;cmd&#47;evm&#47;testdata&#47;29&#47;alloc.json op-geth&#47;cmd&#47;evm&#47;testdata&#47;29&#47;alloc.json</span>
<span class="term-fg1">index 70d47862a0fd87a8ab697634f606502e95124ec5..d2c879a45c87f88d6edda3f35050adfeba718756 100644</span>
<span class="term-fg1">--- go-ethereum&#47;cmd&#47;evm&#47;testdata&#47;29&#47;alloc.json</span>
<span class="term-fg1">+++ op-geth&#47;cmd&#47;evm&#47;testdata&#47;29&#47;alloc.json</span>
<span class="term-fg36">@@ -6,7 +6,7 @@</span>     &quot;nonce&quot; : &quot;0x00&quot;,
     &quot;storage&quot; : {
     }
   },
<span class="term-fg31">-  &quot;0xbEac00dDB15f3B6d645C48263dC93862413A222D&quot; : {</span>
<span class="term-fg32">+  &quot;0x000F3df6D732807Ef1319fB7B8bB8522d0Beac02&quot; : {</span>
     &quot;balance&quot; : &quot;0x1&quot;,
     &quot;code&quot; : &quot;0x3373fffffffffffffffffffffffffffffffffffffffe14604457602036146024575f5ffd5b620180005f350680545f35146037575f5ffd5b6201800001545f5260205ff35b6201800042064281555f359062018000015500&quot;,
     &quot;nonce&quot; : &quot;0x00&quot;,</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-0afecc76ca93c28a3bb68ce8" role="button"
                   aria-expanded="false" aria-controls="id-0afecc76ca93c28a3bb68ce8">
                    <code>cmd/evm/testdata/29/exp.json</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/3f40e65c484486dea6cff80b7db178985d21a2c6/cmd/evm/testdata/29/exp.json" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/650bb2f2b1dcfe30d9b1fa6f7dc9608055ed60e1/cmd/evm/testdata/29/exp.json" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+4</span></div>
                        <div class="text-start"><span class="text-danger">-3</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-0afecc76ca93c28a3bb68ce8"><span class="term-fg1">diff --git go-ethereum&#47;cmd&#47;evm&#47;testdata&#47;29&#47;exp.json op-geth&#47;cmd&#47;evm&#47;testdata&#47;29&#47;exp.json</span>
<span class="term-fg1">index 16a88177749ca931168727079898ee97c062287b..c4c001ec14e3d090bf3650d82cf98bbc5b2de078 100644</span>
<span class="term-fg1">--- go-ethereum&#47;cmd&#47;evm&#47;testdata&#47;29&#47;exp.json</span>
<span class="term-fg1">+++ op-geth&#47;cmd&#47;evm&#47;testdata&#47;29&#47;exp.json</span>
<span class="term-fg36">@@ -1,6 +1,6 @@</span>
 {
   &quot;alloc&quot;: {
<span class="term-fg31">-    &quot;0xbeac00ddb15f3b6d645c48263dc93862413a222d&quot;: {</span>
<span class="term-fg32">+    &quot;0x000f3df6d732807ef1319fb7b8bb8522d0beac02&quot;: {</span>
       &quot;code&quot;: &quot;0x3373fffffffffffffffffffffffffffffffffffffffe14604457602036146024575f5ffd5b620180005f350680545f35146037575f5ffd5b6201800001545f5260205ff35b6201800042064281555f359062018000015500&quot;,
       &quot;storage&quot;: {
         &quot;0x000000000000000000000000000000000000000000000000000000000000079e&quot;: &quot;0x000000000000000000000000000000000000000000000000000000000000079e&quot;,
<span class="term-fg36">@@ -14,7 +14,7 @@</span>       &quot;nonce&quot;: &quot;0x1&quot;
     }
   },
   &quot;result&quot;: {
<span class="term-fg31">-    &quot;stateRoot&quot;: &quot;0x2db9f6bc233e8fd0af2d8023404493a19b37d9d69ace71f4e73158851fced574&quot;,</span>
<span class="term-fg32">+    &quot;stateRoot&quot;: &quot;0x19a4f821a7c0a6f4c934f9acb0fe9ce5417b68086e12513ecbc3e3f57e01573c&quot;,</span>
     &quot;txRoot&quot;: &quot;0x248074fabe112f7d93917f292b64932394f835bb98da91f21501574d58ec92ab&quot;,
     &quot;receiptsRoot&quot;: &quot;0xf78dfb743fbd92ade140711c8bbc542b5e307f0ab7984eff35d751969fe57efa&quot;,
     &quot;logsHash&quot;: &quot;0x1dcc4de8dec75d7aab85b567b6ccd41ad312451b948a7413f0a142fd40d49347&quot;,
<span class="term-fg36">@@ -40,6 +40,6 @@</span>     &quot;gasUsed&quot;: &quot;0x5208&quot;,
     &quot;currentBaseFee&quot;: &quot;0x9&quot;,
     &quot;withdrawalsRoot&quot;: &quot;0x56e81f171bcc55a6ff8345e692c0f86e5b48e01b996cadc001622fb5e363b421&quot;,
     &quot;currentExcessBlobGas&quot;: &quot;0x0&quot;,
<span class="term-fg31">-    &quot;currentBlobGasUsed&quot;: &quot;0x0&quot;</span>
<span class="term-fg32">+    &quot;blobGasUsed&quot;: &quot;0x0&quot;</span>
   }
<span class="term-fg31">-}</span>
<span class="term-fg31">\ No newline at end of file</span>
<span class="term-fg32">+}</span></div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-30b963364b7bf108e289b31b" role="button"
                   aria-expanded="false" aria-controls="id-30b963364b7bf108e289b31b">
                    <code>cmd/evm/testdata/29/readme.md</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/3f40e65c484486dea6cff80b7db178985d21a2c6/cmd/evm/testdata/29/readme.md" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/650bb2f2b1dcfe30d9b1fa6f7dc9608055ed60e1/cmd/evm/testdata/29/readme.md" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+11</span></div>
                        <div class="text-start"><span class="text-danger">-11</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-30b963364b7bf108e289b31b"><span class="term-fg1">diff --git go-ethereum&#47;cmd&#47;evm&#47;testdata&#47;29&#47;readme.md op-geth&#47;cmd&#47;evm&#47;testdata&#47;29&#47;readme.md</span>
<span class="term-fg1">index 4383e328edefb39277a3738522108a8fc1924186..ab02ce9cf8d1bf675ac13125137ecf8b6c0a8a97 100644</span>
<span class="term-fg1">--- go-ethereum&#47;cmd&#47;evm&#47;testdata&#47;29&#47;readme.md</span>
<span class="term-fg1">+++ op-geth&#47;cmd&#47;evm&#47;testdata&#47;29&#47;readme.md</span>
<span class="term-fg36">@@ -1,29 +1,29 @@</span>
 ## EIP 4788
&nbsp;
 This test contains testcases for EIP-4788. The 4788-contract is
<span class="term-fg31">-located at address `0xbeac00ddb15f3b6d645c48263dc93862413a222d`, and this test executes a simple transaction. It also</span>
<span class="term-fg32">+located at address `0x000F3df6D732807Ef1319fB7B8bB8522d0Beac02`, and this test executes a simple transaction. It also</span>
 implicitly invokes the system tx, which sets calls the contract and sets the
 storage values
<span class="term-fg32">+</span>
 ```
 $ dir=.&#47;testdata&#47;29&#47; &amp;&amp; go run . t8n --state.fork=Cancun  --input.alloc=$dir&#47;alloc.json --input.txs=$dir&#47;txs.json --input.env=$dir&#47;env.json --output.alloc=stdout
<span class="term-fg31">-INFO [08-15|20:07:56.335] Trie dumping started                     root=ecde45..2af8a7</span>
<span class="term-fg31">-INFO [08-15|20:07:56.335] Trie dumping complete                    accounts=2 elapsed=&quot;225.848µs&quot;</span>
<span class="term-fg31">-INFO [08-15|20:07:56.335] Wrote file                               file=result.json</span>
<span class="term-fg32">+INFO [09-27|15:34:53.049] Trie dumping started                     root=19a4f8..01573c</span>
<span class="term-fg32">+INFO [09-27|15:34:53.049] Trie dumping complete                    accounts=2 elapsed=&quot;192.759µs&quot;</span>
<span class="term-fg32">+INFO [09-27|15:34:53.050] Wrote file                               file=result.json</span>
 {
   &quot;alloc&quot;: {
<span class="term-fg31">-    &quot;0xa94f5374fce5edbc8e2a8697c15331677e6ebf0b&quot;: {</span>
<span class="term-fg31">-      &quot;balance&quot;: &quot;0x16345785d871db8&quot;,</span>
<span class="term-fg31">-      &quot;nonce&quot;: &quot;0x1&quot;</span>
<span class="term-fg31">-    },</span>
<span class="term-fg31">-    &quot;0xbeac00541d49391ed88abf392bfc1f4dea8c4143&quot;: {</span>
<span class="term-fg32">+    &quot;0x000f3df6d732807ef1319fb7b8bb8522d0beac02&quot;: {</span>
       &quot;code&quot;: &quot;0x3373fffffffffffffffffffffffffffffffffffffffe14604457602036146024575f5ffd5b620180005f350680545f35146037575f5ffd5b6201800001545f5260205ff35b6201800042064281555f359062018000015500&quot;,
       &quot;storage&quot;: {
         &quot;0x000000000000000000000000000000000000000000000000000000000000079e&quot;: &quot;0x000000000000000000000000000000000000000000000000000000000000079e&quot;,
         &quot;0x000000000000000000000000000000000000000000000000000000000001879e&quot;: &quot;0x0000beac00beac00beac00beac00beac00beac00beac00beac00beac00beac00&quot;
       },
<span class="term-fg31">-      &quot;balance&quot;: &quot;0x</span>
<span class="term-fg32">+      &quot;balance&quot;: &quot;0x1&quot;</span>
<span class="term-fg32">+    },</span>
<span class="term-fg32">+    &quot;0xa94f5374fce5edbc8e2a8697c15331677e6ebf0b&quot;: {</span>
<span class="term-fg32">+      &quot;balance&quot;: &quot;0x16345785d871db8&quot;,</span>
<span class="term-fg32">+      &quot;nonce&quot;: &quot;0x1&quot;</span>
     }
   }
 }
<span class="term-fg31">-</span>
 ```</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-dadfabe5d2715ac51320bffa" role="button"
                   aria-expanded="false" aria-controls="id-dadfabe5d2715ac51320bffa">
                    <code>cmd/evm/testdata/9/readme.md</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/3f40e65c484486dea6cff80b7db178985d21a2c6/cmd/evm/testdata/9/readme.md" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/650bb2f2b1dcfe30d9b1fa6f7dc9608055ed60e1/cmd/evm/testdata/9/readme.md" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+1</span></div>
                        <div class="text-start"><span class="text-danger">-1</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-dadfabe5d2715ac51320bffa"><span class="term-fg1">diff --git go-ethereum&#47;cmd&#47;evm&#47;testdata&#47;9&#47;readme.md op-geth&#47;cmd&#47;evm&#47;testdata&#47;9&#47;readme.md</span>
<span class="term-fg1">index 539478028869519dda38ceb4907831f52ea4897f..357e200682f6cd3e59a644c1c6083fc8bc54521d 100644</span>
<span class="term-fg1">--- go-ethereum&#47;cmd&#47;evm&#47;testdata&#47;9&#47;readme.md</span>
<span class="term-fg1">+++ op-geth&#47;cmd&#47;evm&#47;testdata&#47;9&#47;readme.md</span>
<span class="term-fg36">@@ -1,6 +1,6 @@</span>
 ## EIP-1559 testing
&nbsp;
<span class="term-fg31">-This test contains testcases for EIP-1559, which uses an new transaction type and has a new block parameter. </span>
<span class="term-fg32">+This test contains testcases for EIP-1559, which uses a new transaction type and has a new block parameter.</span>
&nbsp;
 ### Prestate
</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-2ea3bfd1daa0155789e0ba19" role="button"
                   aria-expanded="false" aria-controls="id-2ea3bfd1daa0155789e0ba19">
                    <code>cmd/geth/chaincmd.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/3f40e65c484486dea6cff80b7db178985d21a2c6/cmd/geth/chaincmd.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/650bb2f2b1dcfe30d9b1fa6f7dc9608055ed60e1/cmd/geth/chaincmd.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+13</span></div>
                        <div class="text-start"><span class="text-danger">-12</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-2ea3bfd1daa0155789e0ba19"><span class="term-fg1">diff --git go-ethereum&#47;cmd&#47;geth&#47;chaincmd.go op-geth&#47;cmd&#47;geth&#47;chaincmd.go</span>
<span class="term-fg1">index fad2c71e68891ce8ac1b0cd08184a1f76ad1759a..a6bb2c2d2c411c3e3f4440a5af2ab545f4cec891 100644</span>
<span class="term-fg1">--- go-ethereum&#47;cmd&#47;geth&#47;chaincmd.go</span>
<span class="term-fg1">+++ op-geth&#47;cmd&#47;geth&#47;chaincmd.go</span>
<span class="term-fg36">@@ -50,8 +50,7 @@</span> 		Usage:     &quot;Bootstrap and initialize a new genesis block&quot;,
 		ArgsUsage: &quot;&lt;genesisPath&gt;&quot;,
 		Flags: flags.Merge([]cli.Flag{
 			utils.CachePreimagesFlag,
<span class="term-fg31">-			utils.StateSchemeFlag,</span>
<span class="term-fg31">-		}, utils.DatabasePathFlags),</span>
<span class="term-fg32">+		}, utils.DatabaseFlags),</span>
 		Description: `
 The init command initializes a new genesis block and definition for the network.
 This is a destructive action and changes the network in which you will be
<span class="term-fg36">@@ -97,9 +96,8 @@</span> 			utils.MetricsInfluxDBBucketFlag,
 			utils.MetricsInfluxDBOrganizationFlag,
 			utils.TxLookupLimitFlag,
 			utils.TransactionHistoryFlag,
<span class="term-fg31">-			utils.StateSchemeFlag,</span>
 			utils.StateHistoryFlag,
<span class="term-fg31">-		}, utils.DatabasePathFlags),</span>
<span class="term-fg32">+		}, utils.DatabaseFlags),</span>
 		Description: `
 The import command imports blocks from an RLP-encoded form. The form can be one file
 with several RLP-encoded blocks, or several files can be used.
<span class="term-fg36">@@ -115,8 +113,7 @@</span> 		ArgsUsage: &quot;&lt;filename&gt; [&lt;blockNumFirst&gt; &lt;blockNumLast&gt;]&quot;,
 		Flags: flags.Merge([]cli.Flag{
 			utils.CacheFlag,
 			utils.SyncModeFlag,
<span class="term-fg31">-			utils.StateSchemeFlag,</span>
<span class="term-fg31">-		}, utils.DatabasePathFlags),</span>
<span class="term-fg32">+		}, utils.DatabaseFlags),</span>
 		Description: `
 Requires a first argument of the file to write to.
 Optional second and third arguments control the first and
<span class="term-fg36">@@ -132,7 +129,7 @@</span> 		ArgsUsage: &quot;&lt;datafile&gt;&quot;,
 		Flags: flags.Merge([]cli.Flag{
 			utils.CacheFlag,
 			utils.SyncModeFlag,
<span class="term-fg31">-		}, utils.DatabasePathFlags),</span>
<span class="term-fg32">+		}, utils.DatabaseFlags),</span>
 		Description: `
 The import-preimages command imports hash preimages from an RLP encoded stream.
 It&#39;s deprecated, please use &quot;geth db import&quot; instead.
<span class="term-fg36">@@ -146,7 +143,7 @@</span> 		ArgsUsage: &quot;&lt;dumpfile&gt;&quot;,
 		Flags: flags.Merge([]cli.Flag{
 			utils.CacheFlag,
 			utils.SyncModeFlag,
<span class="term-fg31">-		}, utils.DatabasePathFlags),</span>
<span class="term-fg32">+		}, utils.DatabaseFlags),</span>
 		Description: `
 The export-preimages command exports hash preimages to an RLP encoded stream.
 It&#39;s deprecated, please use &quot;geth db export&quot; instead.
<span class="term-fg36">@@ -165,8 +162,7 @@</span> 			utils.ExcludeStorageFlag,
 			utils.IncludeIncompletesFlag,
 			utils.StartKeyFlag,
 			utils.DumpLimitFlag,
<span class="term-fg31">-			utils.StateSchemeFlag,</span>
<span class="term-fg31">-		}, utils.DatabasePathFlags),</span>
<span class="term-fg32">+		}, utils.DatabaseFlags),</span>
 		Description: `
 This command dumps out the state for a given block (or latest, if none provided).
 `,
<span class="term-fg36">@@ -340,7 +336,8 @@</span>
 	stack, _ := makeConfigNode(ctx)
 	defer stack.Close()
&nbsp;
<span class="term-fg31">-	chain, _ := utils.MakeChain(ctx, stack, true)</span>
<span class="term-fg32">+	chain, db := utils.MakeChain(ctx, stack, true)</span>
<span class="term-fg32">+	defer db.Close()</span>
 	start := time.Now()
&nbsp;
 	var err error
<span class="term-fg36">@@ -380,6 +377,7 @@</span> 	stack, _ := makeConfigNode(ctx)
 	defer stack.Close()
&nbsp;
 	db := utils.MakeChainDatabase(ctx, stack, false)
<span class="term-fg32">+	defer db.Close()</span>
 	start := time.Now()
&nbsp;
 	if err := utils.ImportPreimages(db, ctx.Args().First()); err != nil {
<span class="term-fg36">@@ -398,6 +396,7 @@</span> 	stack, _ := makeConfigNode(ctx)
 	defer stack.Close()
&nbsp;
 	db := utils.MakeChainDatabase(ctx, stack, true)
<span class="term-fg32">+	defer db.Close()</span>
 	start := time.Now()
&nbsp;
 	if err := utils.ExportPreimages(db, ctx.Args().First()); err != nil {
<span class="term-fg36">@@ -409,6 +408,8 @@</span> }
&nbsp;
 func parseDumpConfig(ctx *cli.Context, stack *node.Node) (*state.DumpConfig, ethdb.Database, common.Hash, error) {
 	db := utils.MakeChainDatabase(ctx, stack, true)
<span class="term-fg32">+	defer db.Close()</span>
<span class="term-fg32">+</span>
 	var header *types.Header
 	if ctx.NArg() &gt; 1 {
 		return nil, nil, common.Hash{}, fmt.Errorf(&quot;expected 1 argument (number or hash), got %d&quot;, ctx.NArg())
<span class="term-fg36">@@ -473,7 +474,7 @@</span> 	conf, db, root, err := parseDumpConfig(ctx, stack)
 	if err != nil {
 		return err
 	}
<span class="term-fg31">-	triedb := utils.MakeTrieDatabase(ctx, db, true, false) &#47;&#47; always enable preimage lookup</span>
<span class="term-fg32">+	triedb := utils.MakeTrieDatabase(ctx, db, true, true) &#47;&#47; always enable preimage lookup</span>
 	defer triedb.Close()
&nbsp;
 	state, err := state.New(root, state.NewDatabaseWithNodeDB(db, triedb), nil)</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-db88417ab254cf5498a4c992" role="button"
                   aria-expanded="false" aria-controls="id-db88417ab254cf5498a4c992">
                    <code>cmd/geth/dbcmd.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/3f40e65c484486dea6cff80b7db178985d21a2c6/cmd/geth/dbcmd.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/650bb2f2b1dcfe30d9b1fa6f7dc9608055ed60e1/cmd/geth/dbcmd.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+17</span></div>
                        <div class="text-start"><span class="text-danger">-14</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-db88417ab254cf5498a4c992"><span class="term-fg1">diff --git go-ethereum&#47;cmd&#47;geth&#47;dbcmd.go op-geth&#47;cmd&#47;geth&#47;dbcmd.go</span>
<span class="term-fg1">index a1868eb8c330b168baeec31fbd9f733e965991d4..6f802716c5e8740164906af8e93d884dde6f7027 100644</span>
<span class="term-fg1">--- go-ethereum&#47;cmd&#47;geth&#47;dbcmd.go</span>
<span class="term-fg1">+++ op-geth&#47;cmd&#47;geth&#47;dbcmd.go</span>
<span class="term-fg36">@@ -48,7 +48,7 @@</span> 		Action:    removeDB,
 		Name:      &quot;removedb&quot;,
 		Usage:     &quot;Remove blockchain and state databases&quot;,
 		ArgsUsage: &quot;&quot;,
<span class="term-fg31">-		Flags:     utils.DatabasePathFlags,</span>
<span class="term-fg32">+		Flags:     utils.DatabaseFlags,</span>
 		Description: `
 Remove blockchain and state databases`,
 	}
<span class="term-fg36">@@ -77,7 +77,7 @@</span> 		Name:      &quot;inspect&quot;,
 		ArgsUsage: &quot;&lt;prefix&gt; &lt;start&gt;&quot;,
 		Flags: flags.Merge([]cli.Flag{
 			utils.SyncModeFlag,
<span class="term-fg31">-		}, utils.NetworkFlags, utils.DatabasePathFlags),</span>
<span class="term-fg32">+		}, utils.NetworkFlags, utils.DatabaseFlags),</span>
 		Usage:       &quot;Inspect the storage size for each type of data in the database&quot;,
 		Description: `This commands iterates the entire database. If the optional &#39;prefix&#39; and &#39;start&#39; arguments are provided, then the iteration is limited to the given subset of data.`,
 	}
<span class="term-fg36">@@ -85,7 +85,7 @@</span> 	dbCheckStateContentCmd = &amp;cli.Command{
 		Action:    checkStateContent,
 		Name:      &quot;check-state-content&quot;,
 		ArgsUsage: &quot;&lt;start (optional)&gt;&quot;,
<span class="term-fg31">-		Flags:     flags.Merge(utils.NetworkFlags, utils.DatabasePathFlags),</span>
<span class="term-fg32">+		Flags:     flags.Merge(utils.NetworkFlags, utils.DatabaseFlags),</span>
 		Usage:     &quot;Verify that state data is cryptographically correct&quot;,
 		Description: `This command iterates the entire database for 32-byte keys, looking for rlp-encoded trie nodes.
 For each trie node encountered, it checks that the key corresponds to the keccak256(value). If this is not true, this indicates
<span class="term-fg36">@@ -97,7 +97,7 @@</span> 		Name:   &quot;stats&quot;,
 		Usage:  &quot;Print leveldb statistics&quot;,
 		Flags: flags.Merge([]cli.Flag{
 			utils.SyncModeFlag,
<span class="term-fg31">-		}, utils.NetworkFlags, utils.DatabasePathFlags),</span>
<span class="term-fg32">+		}, utils.NetworkFlags, utils.DatabaseFlags),</span>
 	}
 	dbCompactCmd = &amp;cli.Command{
 		Action: dbCompact,
<span class="term-fg36">@@ -107,7 +107,7 @@</span> 		Flags: flags.Merge([]cli.Flag{
 			utils.SyncModeFlag,
 			utils.CacheFlag,
 			utils.CacheDatabaseFlag,
<span class="term-fg31">-		}, utils.NetworkFlags, utils.DatabasePathFlags),</span>
<span class="term-fg32">+		}, utils.NetworkFlags, utils.DatabaseFlags),</span>
 		Description: `This command performs a database compaction.
 WARNING: This operation may take a very long time to finish, and may cause database
 corruption if it is aborted during execution&#39;!`,
<span class="term-fg36">@@ -119,7 +119,7 @@</span> 		Usage:     &quot;Show the value of a database key&quot;,
 		ArgsUsage: &quot;&lt;hex-encoded key&gt;&quot;,
 		Flags: flags.Merge([]cli.Flag{
 			utils.SyncModeFlag,
<span class="term-fg31">-		}, utils.NetworkFlags, utils.DatabasePathFlags),</span>
<span class="term-fg32">+		}, utils.NetworkFlags, utils.DatabaseFlags),</span>
 		Description: &quot;This command looks up the specified database key from the database.&quot;,
 	}
 	dbDeleteCmd = &amp;cli.Command{
<span class="term-fg36">@@ -129,7 +129,7 @@</span> 		Usage:     &quot;Delete a database key (WARNING: may corrupt your database)&quot;,
 		ArgsUsage: &quot;&lt;hex-encoded key&gt;&quot;,
 		Flags: flags.Merge([]cli.Flag{
 			utils.SyncModeFlag,
<span class="term-fg31">-		}, utils.NetworkFlags, utils.DatabasePathFlags),</span>
<span class="term-fg32">+		}, utils.NetworkFlags, utils.DatabaseFlags),</span>
 		Description: `This command deletes the specified database key from the database.
 WARNING: This is a low-level operation which may cause database corruption!`,
 	}
<span class="term-fg36">@@ -140,7 +140,7 @@</span> 		Usage:     &quot;Set the value of a database key (WARNING: may corrupt your database)&quot;,
 		ArgsUsage: &quot;&lt;hex-encoded key&gt; &lt;hex-encoded value&gt;&quot;,
 		Flags: flags.Merge([]cli.Flag{
 			utils.SyncModeFlag,
<span class="term-fg31">-		}, utils.NetworkFlags, utils.DatabasePathFlags),</span>
<span class="term-fg32">+		}, utils.NetworkFlags, utils.DatabaseFlags),</span>
 		Description: `This command sets a given database key to the given value.
 WARNING: This is a low-level operation which may cause database corruption!`,
 	}
<span class="term-fg36">@@ -151,8 +151,7 @@</span> 		Usage:     &quot;Show the storage key&#47;values of a given storage trie&quot;,
 		ArgsUsage: &quot;&lt;hex-encoded state root&gt; &lt;hex-encoded account hash&gt; &lt;hex-encoded storage trie root&gt; &lt;hex-encoded start (optional)&gt; &lt;int max elements (optional)&gt;&quot;,
 		Flags: flags.Merge([]cli.Flag{
 			utils.SyncModeFlag,
<span class="term-fg31">-			utils.StateSchemeFlag,</span>
<span class="term-fg31">-		}, utils.NetworkFlags, utils.DatabasePathFlags),</span>
<span class="term-fg32">+		}, utils.NetworkFlags, utils.DatabaseFlags),</span>
 		Description: &quot;This command looks up the specified database key from the database.&quot;,
 	}
 	dbDumpFreezerIndex = &amp;cli.Command{
<span class="term-fg36">@@ -162,7 +161,7 @@</span> 		Usage:     &quot;Dump out the index of a specific freezer table&quot;,
 		ArgsUsage: &quot;&lt;freezer-type&gt; &lt;table-type&gt; &lt;start (int)&gt; &lt;end (int)&gt;&quot;,
 		Flags: flags.Merge([]cli.Flag{
 			utils.SyncModeFlag,
<span class="term-fg31">-		}, utils.NetworkFlags, utils.DatabasePathFlags),</span>
<span class="term-fg32">+		}, utils.NetworkFlags, utils.DatabaseFlags),</span>
 		Description: &quot;This command displays information about the freezer index.&quot;,
 	}
 	dbImportCmd = &amp;cli.Command{
<span class="term-fg36">@@ -172,7 +171,7 @@</span> 		Usage:     &quot;Imports leveldb-data from an exported RLP dump.&quot;,
 		ArgsUsage: &quot;&lt;dumpfile&gt; &lt;start (optional)&quot;,
 		Flags: flags.Merge([]cli.Flag{
 			utils.SyncModeFlag,
<span class="term-fg31">-		}, utils.NetworkFlags, utils.DatabasePathFlags),</span>
<span class="term-fg32">+		}, utils.NetworkFlags, utils.DatabaseFlags),</span>
 		Description: &quot;The import command imports the specific chain data from an RLP encoded stream.&quot;,
 	}
 	dbExportCmd = &amp;cli.Command{
<span class="term-fg36">@@ -182,7 +181,7 @@</span> 		Usage:     &quot;Exports the chain data into an RLP dump. If the &lt;dumpfile&gt; has .gz suffix, gzip compression will be used.&quot;,
 		ArgsUsage: &quot;&lt;type&gt; &lt;dumpfile&gt;&quot;,
 		Flags: flags.Merge([]cli.Flag{
 			utils.SyncModeFlag,
<span class="term-fg31">-		}, utils.NetworkFlags, utils.DatabasePathFlags),</span>
<span class="term-fg32">+		}, utils.NetworkFlags, utils.DatabaseFlags),</span>
 		Description: &quot;Exports the specified chain data to an RLP encoded stream, optionally gzip-compressed.&quot;,
 	}
 	dbMetadataCmd = &amp;cli.Command{
<span class="term-fg36">@@ -191,7 +190,7 @@</span> 		Name:   &quot;metadata&quot;,
 		Usage:  &quot;Shows metadata about the chain status.&quot;,
 		Flags: flags.Merge([]cli.Flag{
 			utils.SyncModeFlag,
<span class="term-fg31">-		}, utils.NetworkFlags, utils.DatabasePathFlags),</span>
<span class="term-fg32">+		}, utils.NetworkFlags, utils.DatabaseFlags),</span>
 		Description: &quot;Shows metadata about the chain status.&quot;,
 	}
 )
<span class="term-fg36">@@ -595,6 +594,7 @@</span> 		}
 		close(stop)
 	}()
 	db := utils.MakeChainDatabase(ctx, stack, false)
<span class="term-fg32">+	defer db.Close()</span>
 	return utils.ImportLDBData(db, fName, int64(start), stop)
 }
&nbsp;
<span class="term-fg36">@@ -691,6 +691,7 @@</span> 		}
 		close(stop)
 	}()
 	db := utils.MakeChainDatabase(ctx, stack, true)
<span class="term-fg32">+	defer db.Close()</span>
 	return utils.ExportChaindata(ctx.Args().Get(1), kind, exporter(db), stop)
 }
&nbsp;
<span class="term-fg36">@@ -698,6 +699,8 @@</span> func showMetaData(ctx *cli.Context) error {
 	stack, _ := makeConfigNode(ctx)
 	defer stack.Close()
 	db := utils.MakeChainDatabase(ctx, stack, true)
<span class="term-fg32">+	defer db.Close()</span>
<span class="term-fg32">+</span>
 	ancients, err := db.Ancients()
 	if err != nil {
 		fmt.Fprintf(os.Stderr, &quot;Error accessing ancients: %v&quot;, err)</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-49e51f5a8c00aa10d6c74b2c" role="button"
                   aria-expanded="false" aria-controls="id-49e51f5a8c00aa10d6c74b2c">
                    <code>cmd/geth/genesis_test.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/3f40e65c484486dea6cff80b7db178985d21a2c6/cmd/geth/genesis_test.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/650bb2f2b1dcfe30d9b1fa6f7dc9608055ed60e1/cmd/geth/genesis_test.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+2</span></div>
                        <div class="text-start"><span class="text-danger">-2</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-49e51f5a8c00aa10d6c74b2c"><span class="term-fg1">diff --git go-ethereum&#47;cmd&#47;geth&#47;genesis_test.go op-geth&#47;cmd&#47;geth&#47;genesis_test.go</span>
<span class="term-fg1">index 2506b42d1e26fa335dc1e88b9c75435f9dce799b..ffe8176b0138a480d95e3cfaa2cda692567745c7 100644</span>
<span class="term-fg1">--- go-ethereum&#47;cmd&#47;geth&#47;genesis_test.go</span>
<span class="term-fg1">+++ op-geth&#47;cmd&#47;geth&#47;genesis_test.go</span>
<span class="term-fg36">@@ -176,12 +176,12 @@</span> 		},
 		{ &#47;&#47; Can&#39;t start pebble on top of leveldb
 			initArgs:   []string{&quot;--db.engine&quot;, &quot;leveldb&quot;},
 			execArgs:   []string{&quot;--db.engine&quot;, &quot;pebble&quot;},
<span class="term-fg31">-			execExpect: `Fatal: Could not open database: db.engine choice was pebble but found pre-existing leveldb database in specified data directory`,</span>
<span class="term-fg32">+			execExpect: `Fatal: Failed to register the Ethereum service: db.engine choice was pebble but found pre-existing leveldb database in specified data directory`,</span>
 		},
 		{ &#47;&#47; Can&#39;t start leveldb on top of pebble
 			initArgs:   []string{&quot;--db.engine&quot;, &quot;pebble&quot;},
 			execArgs:   []string{&quot;--db.engine&quot;, &quot;leveldb&quot;},
<span class="term-fg31">-			execExpect: `Fatal: Could not open database: db.engine choice was leveldb but found pre-existing pebble database in specified data directory`,</span>
<span class="term-fg32">+			execExpect: `Fatal: Failed to register the Ethereum service: db.engine choice was leveldb but found pre-existing pebble database in specified data directory`,</span>
 		},
 		{ &#47;&#47; Reject invalid backend choice
 			initArgs:   []string{&quot;--db.engine&quot;, &quot;mssql&quot;},</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-8e59f1706ca9f0febed64598" role="button"
                   aria-expanded="false" aria-controls="id-8e59f1706ca9f0febed64598">
                    <code>cmd/geth/snapshot.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/3f40e65c484486dea6cff80b7db178985d21a2c6/cmd/geth/snapshot.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/650bb2f2b1dcfe30d9b1fa6f7dc9608055ed60e1/cmd/geth/snapshot.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+19</span></div>
                        <div class="text-start"><span class="text-danger">-15</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-8e59f1706ca9f0febed64598"><span class="term-fg1">diff --git go-ethereum&#47;cmd&#47;geth&#47;snapshot.go op-geth&#47;cmd&#47;geth&#47;snapshot.go</span>
<span class="term-fg1">index 5e1c7847305fdcec50659f8a57a2511c940a922a..64134825116aa491defbd25b616d9d0b67f00c60 100644</span>
<span class="term-fg1">--- go-ethereum&#47;cmd&#47;geth&#47;snapshot.go</span>
<span class="term-fg1">+++ op-geth&#47;cmd&#47;geth&#47;snapshot.go</span>
<span class="term-fg36">@@ -51,7 +51,7 @@</span> 				ArgsUsage: &quot;&lt;root&gt;&quot;,
 				Action:    pruneState,
 				Flags: flags.Merge([]cli.Flag{
 					utils.BloomFilterSizeFlag,
<span class="term-fg31">-				}, utils.NetworkFlags, utils.DatabasePathFlags),</span>
<span class="term-fg32">+				}, utils.NetworkFlags, utils.DatabaseFlags),</span>
 				Description: `
 geth snapshot prune-state &lt;state-root&gt;
 will prune historical state data with the help of the state snapshot.
<span class="term-fg36">@@ -69,9 +69,7 @@</span> 				Name:      &quot;verify-state&quot;,
 				Usage:     &quot;Recalculate state hash based on the snapshot for verification&quot;,
 				ArgsUsage: &quot;&lt;root&gt;&quot;,
 				Action:    verifyState,
<span class="term-fg31">-				Flags: flags.Merge([]cli.Flag{</span>
<span class="term-fg31">-					utils.StateSchemeFlag,</span>
<span class="term-fg31">-				}, utils.NetworkFlags, utils.DatabasePathFlags),</span>
<span class="term-fg32">+				Flags:     flags.Merge(utils.NetworkFlags, utils.DatabaseFlags),</span>
 				Description: `
 geth snapshot verify-state &lt;state-root&gt;
 will traverse the whole accounts and storages set based on the specified
<span class="term-fg36">@@ -84,7 +82,7 @@</span> 				Name:      &quot;check-dangling-storage&quot;,
 				Usage:     &quot;Check that there is no &#39;dangling&#39; snap storage&quot;,
 				ArgsUsage: &quot;&lt;root&gt;&quot;,
 				Action:    checkDanglingStorage,
<span class="term-fg31">-				Flags:     flags.Merge(utils.NetworkFlags, utils.DatabasePathFlags),</span>
<span class="term-fg32">+				Flags:     flags.Merge(utils.NetworkFlags, utils.DatabaseFlags),</span>
 				Description: `
 geth snapshot check-dangling-storage &lt;state-root&gt; traverses the snap storage
 data, and verifies that all snapshot storage data has a corresponding account.
<span class="term-fg36">@@ -95,7 +93,7 @@</span> 				Name:      &quot;inspect-account&quot;,
 				Usage:     &quot;Check all snapshot layers for the a specific account&quot;,
 				ArgsUsage: &quot;&lt;address | hash&gt;&quot;,
 				Action:    checkAccount,
<span class="term-fg31">-				Flags:     flags.Merge(utils.NetworkFlags, utils.DatabasePathFlags),</span>
<span class="term-fg32">+				Flags:     flags.Merge(utils.NetworkFlags, utils.DatabaseFlags),</span>
 				Description: `
 geth snapshot inspect-account &lt;address | hash&gt; checks all snapshot layers and prints out
 information about the specified address.
<span class="term-fg36">@@ -106,9 +104,7 @@</span> 				Name:      &quot;traverse-state&quot;,
 				Usage:     &quot;Traverse the state with given root hash and perform quick verification&quot;,
 				ArgsUsage: &quot;&lt;root&gt;&quot;,
 				Action:    traverseState,
<span class="term-fg31">-				Flags: flags.Merge([]cli.Flag{</span>
<span class="term-fg31">-					utils.StateSchemeFlag,</span>
<span class="term-fg31">-				}, utils.NetworkFlags, utils.DatabasePathFlags),</span>
<span class="term-fg32">+				Flags:     flags.Merge(utils.NetworkFlags, utils.DatabaseFlags),</span>
 				Description: `
 geth snapshot traverse-state &lt;state-root&gt;
 will traverse the whole state from the given state root and will abort if any
<span class="term-fg36">@@ -123,9 +119,7 @@</span> 				Name:      &quot;traverse-rawstate&quot;,
 				Usage:     &quot;Traverse the state with given root hash and perform detailed verification&quot;,
 				ArgsUsage: &quot;&lt;root&gt;&quot;,
 				Action:    traverseRawState,
<span class="term-fg31">-				Flags: flags.Merge([]cli.Flag{</span>
<span class="term-fg31">-					utils.StateSchemeFlag,</span>
<span class="term-fg31">-				}, utils.NetworkFlags, utils.DatabasePathFlags),</span>
<span class="term-fg32">+				Flags:     flags.Merge(utils.NetworkFlags, utils.DatabaseFlags),</span>
 				Description: `
 geth snapshot traverse-rawstate &lt;state-root&gt;
 will traverse the whole state from the given root and will abort if any referenced
<span class="term-fg36">@@ -146,8 +140,7 @@</span> 					utils.ExcludeCodeFlag,
 					utils.ExcludeStorageFlag,
 					utils.StartKeyFlag,
 					utils.DumpLimitFlag,
<span class="term-fg31">-					utils.StateSchemeFlag,</span>
<span class="term-fg31">-				}, utils.NetworkFlags, utils.DatabasePathFlags),</span>
<span class="term-fg32">+				}, utils.NetworkFlags, utils.DatabaseFlags),</span>
 				Description: `
 This command is semantically equivalent to &#39;geth dump&#39;, but uses the snapshots
 as the backend data source, making this command a lot faster.
<span class="term-fg36">@@ -252,7 +245,9 @@</span> func checkDanglingStorage(ctx *cli.Context) error {
 	stack, _ := makeConfigNode(ctx)
 	defer stack.Close()
&nbsp;
<span class="term-fg31">-	return snapshot.CheckDanglingStorage(utils.MakeChainDatabase(ctx, stack, true))</span>
<span class="term-fg32">+	db := utils.MakeChainDatabase(ctx, stack, true)</span>
<span class="term-fg32">+	defer db.Close()</span>
<span class="term-fg32">+	return snapshot.CheckDanglingStorage(db)</span>
 }
&nbsp;
 &#47;&#47; traverseState is a helper function used for pruning verification.
<span class="term-fg36">@@ -332,6 +327,11 @@</span> 			}
 			storageIter := trie.NewIterator(storageIt)
 			for storageIter.Next() {
 				slots += 1
<span class="term-fg32">+</span>
<span class="term-fg32">+				if time.Since(lastReport) &gt; time.Second*8 {</span>
<span class="term-fg32">+					log.Info(&quot;Traversing state&quot;, &quot;accounts&quot;, accounts, &quot;slots&quot;, slots, &quot;codes&quot;, codes, &quot;elapsed&quot;, common.PrettyDuration(time.Since(start)))</span>
<span class="term-fg32">+					lastReport = time.Now()</span>
<span class="term-fg32">+				}</span>
 			}
 			if storageIter.Err != nil {
 				log.Error(&quot;Failed to traverse storage trie&quot;, &quot;root&quot;, acc.Root, &quot;err&quot;, storageIter.Err)
<span class="term-fg36">@@ -485,6 +485,10 @@</span> 					}
 					&#47;&#47; Bump the counter if it&#39;s leaf node.
 					if storageIter.Leaf() {
 						slots += 1
<span class="term-fg32">+					}</span>
<span class="term-fg32">+					if time.Since(lastReport) &gt; time.Second*8 {</span>
<span class="term-fg32">+						log.Info(&quot;Traversing state&quot;, &quot;nodes&quot;, nodes, &quot;accounts&quot;, accounts, &quot;slots&quot;, slots, &quot;codes&quot;, codes, &quot;elapsed&quot;, common.PrettyDuration(time.Since(start)))</span>
<span class="term-fg32">+						lastReport = time.Now()</span>
 					}
 				}
 				if storageIter.Error() != nil {</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-9bd093954ad6e521c18c9544" role="button"
                   aria-expanded="false" aria-controls="id-9bd093954ad6e521c18c9544">
                    <code>cmd/geth/verkle.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/3f40e65c484486dea6cff80b7db178985d21a2c6/cmd/geth/verkle.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/650bb2f2b1dcfe30d9b1fa6f7dc9608055ed60e1/cmd/geth/verkle.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+4</span></div>
                        <div class="text-start"><span class="text-danger">-2</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-9bd093954ad6e521c18c9544"><span class="term-fg1">diff --git go-ethereum&#47;cmd&#47;geth&#47;verkle.go op-geth&#47;cmd&#47;geth&#47;verkle.go</span>
<span class="term-fg1">index 9ba2b4167164c99cccf02760b721ebd95665644c..aa79889e8c18ee1f9d9d1d4f3416280a4d30ce46 100644</span>
<span class="term-fg1">--- go-ethereum&#47;cmd&#47;geth&#47;verkle.go</span>
<span class="term-fg1">+++ op-geth&#47;cmd&#47;geth&#47;verkle.go</span>
<span class="term-fg36">@@ -45,7 +45,7 @@</span> 				Name:      &quot;verify&quot;,
 				Usage:     &quot;verify the conversion of a MPT into a verkle tree&quot;,
 				ArgsUsage: &quot;&lt;root&gt;&quot;,
 				Action:    verifyVerkle,
<span class="term-fg31">-				Flags:     flags.Merge(utils.NetworkFlags, utils.DatabasePathFlags),</span>
<span class="term-fg32">+				Flags:     flags.Merge(utils.NetworkFlags, utils.DatabaseFlags),</span>
 				Description: `
 geth verkle verify &lt;state-root&gt;
 This command takes a root commitment and attempts to rebuild the tree.
<span class="term-fg36">@@ -56,7 +56,7 @@</span> 				Name:      &quot;dump&quot;,
 				Usage:     &quot;Dump a verkle tree to a DOT file&quot;,
 				ArgsUsage: &quot;&lt;root&gt; &lt;key1&gt; [&lt;key 2&gt; ...]&quot;,
 				Action:    expandVerkle,
<span class="term-fg31">-				Flags:     flags.Merge(utils.NetworkFlags, utils.DatabasePathFlags),</span>
<span class="term-fg32">+				Flags:     flags.Merge(utils.NetworkFlags, utils.DatabaseFlags),</span>
 				Description: `
 geth verkle dump &lt;state-root&gt; &lt;key 1&gt; [&lt;key 2&gt; ...]
 This command will produce a dot file representing the tree, rooted at &lt;root&gt;.
<span class="term-fg36">@@ -115,6 +115,7 @@</span> 	stack, _ := makeConfigNode(ctx)
 	defer stack.Close()
&nbsp;
 	chaindb := utils.MakeChainDatabase(ctx, stack, true)
<span class="term-fg32">+	defer chaindb.Close()</span>
 	headBlock := rawdb.ReadHeadBlock(chaindb)
 	if headBlock == nil {
 		log.Error(&quot;Failed to load head block&quot;)
<span class="term-fg36">@@ -163,6 +164,7 @@</span> 	stack, _ := makeConfigNode(ctx)
 	defer stack.Close()
&nbsp;
 	chaindb := utils.MakeChainDatabase(ctx, stack, true)
<span class="term-fg32">+	defer chaindb.Close()</span>
 	var (
 		rootC   common.Hash
 		keylist [][]byte</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-444b8440089383008d33442a" role="button"
                   aria-expanded="false" aria-controls="id-444b8440089383008d33442a">
                    <code>common/types.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/3f40e65c484486dea6cff80b7db178985d21a2c6/common/types.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/650bb2f2b1dcfe30d9b1fa6f7dc9608055ed60e1/common/types.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+0</span></div>
                        <div class="text-start"><span class="text-danger">-3</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-444b8440089383008d33442a"><span class="term-fg1">diff --git go-ethereum&#47;common&#47;types.go op-geth&#47;common&#47;types.go</span>
<span class="term-fg1">index bf74e43716a1afe6d844ee48120dc7347f303817..7184b2b112204be541e249a473a0602548bd7a08 100644</span>
<span class="term-fg1">--- go-ethereum&#47;common&#47;types.go</span>
<span class="term-fg1">+++ op-geth&#47;common&#47;types.go</span>
<span class="term-fg36">@@ -239,9 +239,6 @@</span>
 &#47;&#47; Bytes gets the string representation of the underlying address.
 func (a Address) Bytes() []byte { return a[:] }
&nbsp;
<span class="term-fg31">-&#47;&#47; Hash converts an address to a hash by left-padding it with zeros.</span>
<span class="term-fg31">-func (a Address) Hash() Hash { return BytesToHash(a[:]) }</span>
<span class="term-fg31">-</span>
 &#47;&#47; Big converts an address to a big integer.
 func (a Address) Big() *big.Int { return new(big.Int).SetBytes(a[:]) }
</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-4b2680ae11cd65beab6195f1" role="button"
                   aria-expanded="false" aria-controls="id-4b2680ae11cd65beab6195f1">
                    <code>consensus/misc/create2deployer.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <span class="text-muted">(new)</span>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/650bb2f2b1dcfe30d9b1fa6f7dc9608055ed60e1/consensus/misc/create2deployer.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+49</span></div>
                        <div class="text-start"><span class="text-danger">-0</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-4b2680ae11cd65beab6195f1"><span class="term-fg1">diff --git go-ethereum&#47;consensus&#47;misc&#47;create2deployer.go op-geth&#47;consensus&#47;misc&#47;create2deployer.go</span>
<span class="term-fg1">new file mode 100644</span>
<span class="term-fg1">index 0000000000000000000000000000000000000000..47e0554faa22181972735e02e91806e22830656b</span>
<span class="term-fg1">--- &#47;dev&#47;null</span>
<span class="term-fg1">+++ op-geth&#47;consensus&#47;misc&#47;create2deployer.go</span>
<span class="term-fg36">@@ -0,0 +1,49 @@</span>
<span class="term-fg32">+package misc</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+import (</span>
<span class="term-fg32">+	&quot;github.com&#47;ethereum-optimism&#47;superchain-registry&#47;superchain&quot;</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;common&quot;</span>
<span class="term-fg32">+	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;core&#47;vm&quot;</span>
<span class="term-fg32">+	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;log&quot;</span>
<span class="term-fg32">+	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;params&quot;</span>
<span class="term-fg32">+)</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+&#47;&#47; The original create2deployer contract could not be deployed to Base mainnet at</span>
<span class="term-fg32">+&#47;&#47; the canonical address of 0x13b0D85CcB8bf860b6b79AF3029fCA081AE9beF2 due to</span>
<span class="term-fg32">+&#47;&#47; an accidental nonce increment from a deposit transaction. See</span>
<span class="term-fg32">+&#47;&#47; https:&#47;&#47;github.com&#47;pcaversaccio&#47;create2deployer&#47;issues&#47;128 for context. This</span>
<span class="term-fg32">+&#47;&#47; file applies the contract code to the canonical address manually in the Canyon</span>
<span class="term-fg32">+&#47;&#47; hardfork.</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+&#47;&#47; create2deployer is already deployed to Base testnets at 0x13b0D85CcB8bf860b6b79AF3029fCA081AE9beF2,</span>
<span class="term-fg32">+&#47;&#47; so we deploy it to 0x13b0D85CcB8bf860b6b79AF3029fCA081AE9beF1 for hardfork testing purposes</span>
<span class="term-fg32">+var create2DeployerAddresses = map[uint64]common.Address{</span>
<span class="term-fg32">+	11763071:                  common.HexToAddress(&quot;0x13b0D85CcB8bf860b6b79AF3029fCA081AE9beF1&quot;), &#47;&#47; Base Goerli devnet</span>
<span class="term-fg32">+	params.BaseGoerliChainID:  common.HexToAddress(&quot;0x13b0D85CcB8bf860b6b79AF3029fCA081AE9beF1&quot;), &#47;&#47; Base Goerli testnet</span>
<span class="term-fg32">+	11763072:                  common.HexToAddress(&quot;0x13b0D85CcB8bf860b6b79AF3029fCA081AE9beF1&quot;), &#47;&#47; Base Sepolia devnet</span>
<span class="term-fg32">+	84532:                     common.HexToAddress(&quot;0x13b0D85CcB8bf860b6b79AF3029fCA081AE9beF1&quot;), &#47;&#47; Base Sepolia testnet</span>
<span class="term-fg32">+	params.BaseMainnetChainID: common.HexToAddress(&quot;0x13b0D85CcB8bf860b6b79AF3029fCA081AE9beF2&quot;), &#47;&#47; Base mainnet</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+var create2DeployerCodeHash = common.HexToHash(&quot;0xb0550b5b431e30d38000efb7107aaa0ade03d48a7198a140edda9d27134468b2&quot;)</span>
<span class="term-fg32">+var create2DeployerCode []byte</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func init() {</span>
<span class="term-fg32">+	code, err := superchain.LoadContractBytecode(superchain.Hash(create2DeployerCodeHash))</span>
<span class="term-fg32">+	if err != nil {</span>
<span class="term-fg32">+		panic(err)</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	create2DeployerCode = code</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func EnsureCreate2Deployer(c *params.ChainConfig, timestamp uint64, db vm.StateDB) {</span>
<span class="term-fg32">+	if !c.IsOptimism() || c.CanyonTime == nil || *c.CanyonTime != timestamp {</span>
<span class="term-fg32">+		return</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	address, ok := create2DeployerAddresses[c.ChainID.Uint64()]</span>
<span class="term-fg32">+	if !ok || db.GetCodeSize(address) &gt; 0 {</span>
<span class="term-fg32">+		return</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	log.Info(&quot;Setting Create2Deployer code&quot;, &quot;address&quot;, address, &quot;codeHash&quot;, create2DeployerCodeHash)</span>
<span class="term-fg32">+	db.SetCode(address, create2DeployerCode)</span>
<span class="term-fg32">+}</span></div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-638162f4dfc822d9b753f4d4" role="button"
                   aria-expanded="false" aria-controls="id-638162f4dfc822d9b753f4d4">
                    <code>consensus/misc/create2deployer_test.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <span class="text-muted">(new)</span>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/650bb2f2b1dcfe30d9b1fa6f7dc9608055ed60e1/consensus/misc/create2deployer_test.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+103</span></div>
                        <div class="text-start"><span class="text-danger">-0</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-638162f4dfc822d9b753f4d4"><span class="term-fg1">diff --git go-ethereum&#47;consensus&#47;misc&#47;create2deployer_test.go op-geth&#47;consensus&#47;misc&#47;create2deployer_test.go</span>
<span class="term-fg1">new file mode 100644</span>
<span class="term-fg1">index 0000000000000000000000000000000000000000..3e588569890f881fdff4af7493ca0226e9d38726</span>
<span class="term-fg1">--- &#47;dev&#47;null</span>
<span class="term-fg1">+++ op-geth&#47;consensus&#47;misc&#47;create2deployer_test.go</span>
<span class="term-fg36">@@ -0,0 +1,103 @@</span>
<span class="term-fg32">+package misc</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+import (</span>
<span class="term-fg32">+	&quot;math&#47;big&quot;</span>
<span class="term-fg32">+	&quot;testing&quot;</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	&quot;github.com&#47;stretchr&#47;testify&#47;assert&quot;</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;common&quot;</span>
<span class="term-fg32">+	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;core&#47;vm&quot;</span>
<span class="term-fg32">+	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;params&quot;</span>
<span class="term-fg32">+)</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func TestEnsureCreate2Deployer(t *testing.T) {</span>
<span class="term-fg32">+	canyonTime := uint64(1000)</span>
<span class="term-fg32">+	var tests = []struct {</span>
<span class="term-fg32">+		name       string</span>
<span class="term-fg32">+		override   func(cfg *params.ChainConfig)</span>
<span class="term-fg32">+		timestamp  uint64</span>
<span class="term-fg32">+		codeExists bool</span>
<span class="term-fg32">+		applied    bool</span>
<span class="term-fg32">+	}{</span>
<span class="term-fg32">+		{</span>
<span class="term-fg32">+			name:      &quot;at hardfork&quot;,</span>
<span class="term-fg32">+			timestamp: canyonTime,</span>
<span class="term-fg32">+			applied:   true,</span>
<span class="term-fg32">+		},</span>
<span class="term-fg32">+		{</span>
<span class="term-fg32">+			name: &quot;non-optimism chain&quot;,</span>
<span class="term-fg32">+			override: func(cfg *params.ChainConfig) {</span>
<span class="term-fg32">+				cfg.Optimism = nil</span>
<span class="term-fg32">+			},</span>
<span class="term-fg32">+			timestamp: canyonTime,</span>
<span class="term-fg32">+			applied:   false,</span>
<span class="term-fg32">+		},</span>
<span class="term-fg32">+		{</span>
<span class="term-fg32">+			name: &quot;non-base chain&quot;,</span>
<span class="term-fg32">+			override: func(cfg *params.ChainConfig) {</span>
<span class="term-fg32">+				cfg.ChainID = big.NewInt(params.OPMainnetChainID)</span>
<span class="term-fg32">+			},</span>
<span class="term-fg32">+			timestamp: canyonTime,</span>
<span class="term-fg32">+			applied:   false,</span>
<span class="term-fg32">+		},</span>
<span class="term-fg32">+		{</span>
<span class="term-fg32">+			name:      &quot;pre canyon&quot;,</span>
<span class="term-fg32">+			timestamp: canyonTime - 1,</span>
<span class="term-fg32">+			applied:   false,</span>
<span class="term-fg32">+		},</span>
<span class="term-fg32">+		{</span>
<span class="term-fg32">+			name:      &quot;post hardfork&quot;,</span>
<span class="term-fg32">+			timestamp: canyonTime + 1,</span>
<span class="term-fg32">+			applied:   false,</span>
<span class="term-fg32">+		},</span>
<span class="term-fg32">+		{</span>
<span class="term-fg32">+			name: &quot;canyon not configured&quot;,</span>
<span class="term-fg32">+			override: func(cfg *params.ChainConfig) {</span>
<span class="term-fg32">+				cfg.CanyonTime = nil</span>
<span class="term-fg32">+			},</span>
<span class="term-fg32">+			timestamp: canyonTime,</span>
<span class="term-fg32">+			applied:   false,</span>
<span class="term-fg32">+		},</span>
<span class="term-fg32">+		{</span>
<span class="term-fg32">+			name:       &quot;code already exists&quot;,</span>
<span class="term-fg32">+			timestamp:  canyonTime,</span>
<span class="term-fg32">+			codeExists: true,</span>
<span class="term-fg32">+			applied:    false,</span>
<span class="term-fg32">+		},</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	for _, tt := range tests {</span>
<span class="term-fg32">+		t.Run(tt.name, func(t *testing.T) {</span>
<span class="term-fg32">+			cfg := params.ChainConfig{</span>
<span class="term-fg32">+				ChainID:    big.NewInt(params.BaseMainnetChainID),</span>
<span class="term-fg32">+				Optimism:   &amp;params.OptimismConfig{},</span>
<span class="term-fg32">+				CanyonTime: &amp;canyonTime,</span>
<span class="term-fg32">+			}</span>
<span class="term-fg32">+			if tt.override != nil {</span>
<span class="term-fg32">+				tt.override(&amp;cfg)</span>
<span class="term-fg32">+			}</span>
<span class="term-fg32">+			state := &amp;stateDb{</span>
<span class="term-fg32">+				codeExists: tt.codeExists,</span>
<span class="term-fg32">+			}</span>
<span class="term-fg32">+			EnsureCreate2Deployer(&amp;cfg, tt.timestamp, state)</span>
<span class="term-fg32">+			assert.Equal(t, tt.applied, state.codeSet)</span>
<span class="term-fg32">+		})</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+type stateDb struct {</span>
<span class="term-fg32">+	vm.StateDB</span>
<span class="term-fg32">+	codeExists bool</span>
<span class="term-fg32">+	codeSet    bool</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func (s *stateDb) GetCodeSize(_ common.Address) int {</span>
<span class="term-fg32">+	if s.codeExists {</span>
<span class="term-fg32">+		return 1</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	return 0</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func (s *stateDb) SetCode(_ common.Address, _ []byte) {</span>
<span class="term-fg32">+	s.codeSet = true</span>
<span class="term-fg32">+}</span></div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-506ba433fb19cc2f34d7adb1" role="button"
                   aria-expanded="false" aria-controls="id-506ba433fb19cc2f34d7adb1">
                    <code>core/asm/asm.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/3f40e65c484486dea6cff80b7db178985d21a2c6/core/asm/asm.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/650bb2f2b1dcfe30d9b1fa6f7dc9608055ed60e1/core/asm/asm.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+1</span></div>
                        <div class="text-start"><span class="text-danger">-1</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-506ba433fb19cc2f34d7adb1"><span class="term-fg1">diff --git go-ethereum&#47;core&#47;asm&#47;asm.go op-geth&#47;core&#47;asm&#47;asm.go</span>
<span class="term-fg1">index 7c1e14ec01eadac24d539834545fecd206a748ac..294eb6ffaad7cad2873e36fb715d90a2ab5967fb 100644</span>
<span class="term-fg1">--- go-ethereum&#47;core&#47;asm&#47;asm.go</span>
<span class="term-fg1">+++ op-geth&#47;core&#47;asm&#47;asm.go</span>
<span class="term-fg36">@@ -34,7 +34,7 @@</span> 	error   error
 	started bool
 }
&nbsp;
<span class="term-fg31">-&#47;&#47; NewInstructionIterator create a new instruction iterator.</span>
<span class="term-fg32">+&#47;&#47; NewInstructionIterator creates a new instruction iterator.</span>
 func NewInstructionIterator(code []byte) *instructionIterator {
 	it := new(instructionIterator)
 	it.code = code</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-a3ca03b8cba599906300dd36" role="button"
                   aria-expanded="false" aria-controls="id-a3ca03b8cba599906300dd36">
                    <code>core/asm/compiler.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/3f40e65c484486dea6cff80b7db178985d21a2c6/core/asm/compiler.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/650bb2f2b1dcfe30d9b1fa6f7dc9608055ed60e1/core/asm/compiler.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+101</span></div>
                        <div class="text-start"><span class="text-danger">-84</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-a3ca03b8cba599906300dd36"><span class="term-fg1">diff --git go-ethereum&#47;core&#47;asm&#47;compiler.go op-geth&#47;core&#47;asm&#47;compiler.go</span>
<span class="term-fg1">index 4b1d379206f61d66ca8e75db33173483fa71905a..02c589b2c1a90a49fbe1bc1dbbabeecf7e15037a 100644</span>
<span class="term-fg1">--- go-ethereum&#47;core&#47;asm&#47;compiler.go</span>
<span class="term-fg1">+++ op-geth&#47;core&#47;asm&#47;compiler.go</span>
<span class="term-fg36">@@ -17,6 +17,8 @@</span>
 package asm
&nbsp;
 import (
<span class="term-fg32">+	&quot;encoding&#47;hex&quot;</span>
<span class="term-fg32">+	&quot;errors&quot;</span>
 	&quot;fmt&quot;
 	&quot;math&#47;big&quot;
 	&quot;os&quot;
<span class="term-fg36">@@ -30,7 +32,7 @@</span> &#47;&#47; Compiler contains information about the parsed source
 &#47;&#47; and holds the tokens for the program.
 type Compiler struct {
 	tokens []token
<span class="term-fg31">-	binary []interface{}</span>
<span class="term-fg32">+	out    []byte</span>
&nbsp;
 	labels map[string]int
&nbsp;
<span class="term-fg36">@@ -47,15 +49,13 @@</span> 		debug:  debug,
 	}
 }
&nbsp;
<span class="term-fg31">-&#47;&#47; Feed feeds tokens in to ch and are interpreted by</span>
<span class="term-fg32">+&#47;&#47; Feed feeds tokens into ch and are interpreted by</span>
 &#47;&#47; the compiler.
 &#47;&#47;
<span class="term-fg31">-&#47;&#47; feed is the first pass in the compile stage as it</span>
<span class="term-fg31">-&#47;&#47; collects the used labels in the program and keeps a</span>
<span class="term-fg31">-&#47;&#47; program counter which is used to determine the locations</span>
<span class="term-fg31">-&#47;&#47; of the jump dests. The labels can than be used in the</span>
<span class="term-fg31">-&#47;&#47; second stage to push labels and determine the right</span>
<span class="term-fg31">-&#47;&#47; position.</span>
<span class="term-fg32">+&#47;&#47; feed is the first pass in the compile stage as it collects the used labels in the</span>
<span class="term-fg32">+&#47;&#47; program and keeps a program counter which is used to determine the locations of the</span>
<span class="term-fg32">+&#47;&#47; jump dests. The labels can than be used in the second stage to push labels and</span>
<span class="term-fg32">+&#47;&#47; determine the right position.</span>
 func (c *Compiler) Feed(ch &lt;-chan token) {
 	var prev token
 	for i := range ch {
<span class="term-fg36">@@ -79,7 +79,6 @@</span> 			if prev.typ == element &amp;&amp; isJump(prev.text) {
 				c.pc++
 			}
 		}
<span class="term-fg31">-</span>
 		c.tokens = append(c.tokens, i)
 		prev = i
 	}
<span class="term-fg36">@@ -88,12 +87,11 @@</span> 		fmt.Fprintln(os.Stderr, &quot;found&quot;, len(c.labels), &quot;labels&quot;)
 	}
 }
&nbsp;
<span class="term-fg31">-&#47;&#47; Compile compiles the current tokens and returns a</span>
<span class="term-fg31">-&#47;&#47; binary string that can be interpreted by the EVM</span>
<span class="term-fg31">-&#47;&#47; and an error if it failed.</span>
<span class="term-fg32">+&#47;&#47; Compile compiles the current tokens and returns a binary string that can be interpreted</span>
<span class="term-fg32">+&#47;&#47; by the EVM and an error if it failed.</span>
 &#47;&#47;
<span class="term-fg31">-&#47;&#47; compile is the second stage in the compile phase</span>
<span class="term-fg31">-&#47;&#47; which compiles the tokens to EVM instructions.</span>
<span class="term-fg32">+&#47;&#47; compile is the second stage in the compile phase which compiles the tokens to EVM</span>
<span class="term-fg32">+&#47;&#47; instructions.</span>
 func (c *Compiler) Compile() (string, []error) {
 	var errors []error
 	&#47;&#47; continue looping over the tokens until
<span class="term-fg36">@@ -105,16 +103,8 @@</span> 		}
 	}
&nbsp;
 	&#47;&#47; turn the binary to hex
<span class="term-fg31">-	var bin strings.Builder</span>
<span class="term-fg31">-	for _, v := range c.binary {</span>
<span class="term-fg31">-		switch v := v.(type) {</span>
<span class="term-fg31">-		case vm.OpCode:</span>
<span class="term-fg31">-			bin.WriteString(fmt.Sprintf(&quot;%x&quot;, []byte{byte(v)}))</span>
<span class="term-fg31">-		case []byte:</span>
<span class="term-fg31">-			bin.WriteString(fmt.Sprintf(&quot;%x&quot;, v))</span>
<span class="term-fg31">-		}</span>
<span class="term-fg31">-	}</span>
<span class="term-fg31">-	return bin.String(), errors</span>
<span class="term-fg32">+	h := hex.EncodeToString(c.out)</span>
<span class="term-fg32">+	return h, errors</span>
 }
&nbsp;
 &#47;&#47; next returns the next token and increments the
<span class="term-fg36">@@ -156,87 +146,114 @@</span>
 	return nil
 }
&nbsp;
<span class="term-fg31">-&#47;&#47; compileNumber compiles the number to bytes</span>
<span class="term-fg31">-func (c *Compiler) compileNumber(element token) {</span>
<span class="term-fg31">-	num := math.MustParseBig256(element.text).Bytes()</span>
<span class="term-fg31">-	if len(num) == 0 {</span>
<span class="term-fg31">-		num = []byte{0}</span>
<span class="term-fg32">+&#47;&#47; parseNumber compiles the number to bytes</span>
<span class="term-fg32">+func parseNumber(tok token) ([]byte, error) {</span>
<span class="term-fg32">+	if tok.typ != number {</span>
<span class="term-fg32">+		panic(&quot;parseNumber of non-number token&quot;)</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	num, ok := math.ParseBig256(tok.text)</span>
<span class="term-fg32">+	if !ok {</span>
<span class="term-fg32">+		return nil, errors.New(&quot;invalid number&quot;)</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	bytes := num.Bytes()</span>
<span class="term-fg32">+	if len(bytes) == 0 {</span>
<span class="term-fg32">+		bytes = []byte{0}</span>
 	}
<span class="term-fg31">-	c.pushBin(num)</span>
<span class="term-fg32">+	return bytes, nil</span>
 }
&nbsp;
 &#47;&#47; compileElement compiles the element (push &amp; label or both)
 &#47;&#47; to a binary representation and may error if incorrect statements
 &#47;&#47; where fed.
 func (c *Compiler) compileElement(element token) error {
<span class="term-fg31">-	&#47;&#47; check for a jump. jumps must be read and compiled</span>
<span class="term-fg31">-	&#47;&#47; from right to left.</span>
<span class="term-fg31">-	if isJump(element.text) {</span>
<span class="term-fg31">-		rvalue := c.next()</span>
<span class="term-fg31">-		switch rvalue.typ {</span>
<span class="term-fg31">-		case number:</span>
<span class="term-fg31">-			&#47;&#47; TODO figure out how to return the error properly</span>
<span class="term-fg31">-			c.compileNumber(rvalue)</span>
<span class="term-fg31">-		case stringValue:</span>
<span class="term-fg31">-			&#47;&#47; strings are quoted, remove them.</span>
<span class="term-fg31">-			c.pushBin(rvalue.text[1 : len(rvalue.text)-2])</span>
<span class="term-fg31">-		case label:</span>
<span class="term-fg31">-			c.pushBin(vm.PUSH4)</span>
<span class="term-fg31">-			pos := big.NewInt(int64(c.labels[rvalue.text])).Bytes()</span>
<span class="term-fg31">-			pos = append(make([]byte, 4-len(pos)), pos...)</span>
<span class="term-fg31">-			c.pushBin(pos)</span>
<span class="term-fg31">-		case lineEnd:</span>
<span class="term-fg31">-			c.pos--</span>
<span class="term-fg31">-		default:</span>
<span class="term-fg31">-			return compileErr(rvalue, rvalue.text, &quot;number, string or label&quot;)</span>
<span class="term-fg31">-		}</span>
<span class="term-fg31">-		&#47;&#47; push the operation</span>
<span class="term-fg31">-		c.pushBin(toBinary(element.text))</span>
<span class="term-fg32">+	switch {</span>
<span class="term-fg32">+	case isJump(element.text):</span>
<span class="term-fg32">+		return c.compileJump(element.text)</span>
<span class="term-fg32">+	case isPush(element.text):</span>
<span class="term-fg32">+		return c.compilePush()</span>
<span class="term-fg32">+	default:</span>
<span class="term-fg32">+		c.outputOpcode(toBinary(element.text))</span>
 		return nil
<span class="term-fg31">-	} else if isPush(element.text) {</span>
<span class="term-fg31">-		&#47;&#47; handle pushes. pushes are read from left to right.</span>
<span class="term-fg31">-		var value []byte</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+}</span>
&nbsp;
<span class="term-fg31">-		rvalue := c.next()</span>
<span class="term-fg31">-		switch rvalue.typ {</span>
<span class="term-fg31">-		case number:</span>
<span class="term-fg31">-			value = math.MustParseBig256(rvalue.text).Bytes()</span>
<span class="term-fg31">-			if len(value) == 0 {</span>
<span class="term-fg31">-				value = []byte{0}</span>
<span class="term-fg31">-			}</span>
<span class="term-fg31">-		case stringValue:</span>
<span class="term-fg31">-			value = []byte(rvalue.text[1 : len(rvalue.text)-1])</span>
<span class="term-fg31">-		case label:</span>
<span class="term-fg31">-			value = big.NewInt(int64(c.labels[rvalue.text])).Bytes()</span>
<span class="term-fg31">-			value = append(make([]byte, 4-len(value)), value...)</span>
<span class="term-fg31">-		default:</span>
<span class="term-fg31">-			return compileErr(rvalue, rvalue.text, &quot;number, string or label&quot;)</span>
<span class="term-fg32">+func (c *Compiler) compileJump(jumpType string) error {</span>
<span class="term-fg32">+	rvalue := c.next()</span>
<span class="term-fg32">+	switch rvalue.typ {</span>
<span class="term-fg32">+	case number:</span>
<span class="term-fg32">+		numBytes, err := parseNumber(rvalue)</span>
<span class="term-fg32">+		if err != nil {</span>
<span class="term-fg32">+			return err</span>
 		}
<span class="term-fg32">+		c.outputBytes(numBytes)</span>
&nbsp;
<span class="term-fg31">-		if len(value) &gt; 32 {</span>
<span class="term-fg31">-			return fmt.Errorf(&quot;%d type error: unsupported string or number with size &gt; 32&quot;, rvalue.lineno)</span>
<span class="term-fg31">-		}</span>
<span class="term-fg32">+	case stringValue:</span>
<span class="term-fg32">+		&#47;&#47; strings are quoted, remove them.</span>
<span class="term-fg32">+		str := rvalue.text[1 : len(rvalue.text)-2]</span>
<span class="term-fg32">+		c.outputBytes([]byte(str))</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	case label:</span>
<span class="term-fg32">+		c.outputOpcode(vm.PUSH4)</span>
<span class="term-fg32">+		pos := big.NewInt(int64(c.labels[rvalue.text])).Bytes()</span>
<span class="term-fg32">+		pos = append(make([]byte, 4-len(pos)), pos...)</span>
<span class="term-fg32">+		c.outputBytes(pos)</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	case lineEnd:</span>
<span class="term-fg32">+		&#47;&#47; push without argument is supported, it just takes the destination from the stack.</span>
<span class="term-fg32">+		c.pos--</span>
&nbsp;
<span class="term-fg31">-		c.pushBin(vm.OpCode(int(vm.PUSH1) - 1 + len(value)))</span>
<span class="term-fg31">-		c.pushBin(value)</span>
<span class="term-fg31">-	} else {</span>
<span class="term-fg31">-		c.pushBin(toBinary(element.text))</span>
<span class="term-fg32">+	default:</span>
<span class="term-fg32">+		return compileErr(rvalue, rvalue.text, &quot;number, string or label&quot;)</span>
 	}
<span class="term-fg32">+	&#47;&#47; push the operation</span>
<span class="term-fg32">+	c.outputOpcode(toBinary(jumpType))</span>
<span class="term-fg32">+	return nil</span>
<span class="term-fg32">+}</span>
&nbsp;
<span class="term-fg32">+func (c *Compiler) compilePush() error {</span>
<span class="term-fg32">+	&#47;&#47; handle pushes. pushes are read from left to right.</span>
<span class="term-fg32">+	var value []byte</span>
<span class="term-fg32">+	rvalue := c.next()</span>
<span class="term-fg32">+	switch rvalue.typ {</span>
<span class="term-fg32">+	case number:</span>
<span class="term-fg32">+		value = math.MustParseBig256(rvalue.text).Bytes()</span>
<span class="term-fg32">+		if len(value) == 0 {</span>
<span class="term-fg32">+			value = []byte{0}</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+	case stringValue:</span>
<span class="term-fg32">+		value = []byte(rvalue.text[1 : len(rvalue.text)-1])</span>
<span class="term-fg32">+	case label:</span>
<span class="term-fg32">+		value = big.NewInt(int64(c.labels[rvalue.text])).Bytes()</span>
<span class="term-fg32">+		value = append(make([]byte, 4-len(value)), value...)</span>
<span class="term-fg32">+	default:</span>
<span class="term-fg32">+		return compileErr(rvalue, rvalue.text, &quot;number, string or label&quot;)</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	if len(value) &gt; 32 {</span>
<span class="term-fg32">+		return fmt.Errorf(&quot;%d: string or number size &gt; 32 bytes&quot;, rvalue.lineno+1)</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	c.outputOpcode(vm.OpCode(int(vm.PUSH1) - 1 + len(value)))</span>
<span class="term-fg32">+	c.outputBytes(value)</span>
 	return nil
 }
&nbsp;
 &#47;&#47; compileLabel pushes a jumpdest to the binary slice.
 func (c *Compiler) compileLabel() {
<span class="term-fg31">-	c.pushBin(vm.JUMPDEST)</span>
<span class="term-fg32">+	c.outputOpcode(vm.JUMPDEST)</span>
 }
&nbsp;
<span class="term-fg31">-&#47;&#47; pushBin pushes the value v to the binary stack.</span>
<span class="term-fg31">-func (c *Compiler) pushBin(v interface{}) {</span>
<span class="term-fg32">+func (c *Compiler) outputOpcode(op vm.OpCode) {</span>
<span class="term-fg32">+	if c.debug {</span>
<span class="term-fg32">+		fmt.Printf(&quot;%d: %v\n&quot;, len(c.out), op)</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	c.out = append(c.out, byte(op))</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+&#47;&#47; output pushes the value v to the binary stack.</span>
<span class="term-fg32">+func (c *Compiler) outputBytes(b []byte) {</span>
 	if c.debug {
<span class="term-fg31">-		fmt.Printf(&quot;%d: %v\n&quot;, len(c.binary), v)</span>
<span class="term-fg32">+		fmt.Printf(&quot;%d: %x\n&quot;, len(c.out), b)</span>
 	}
<span class="term-fg31">-	c.binary = append(c.binary, v)</span>
<span class="term-fg32">+	c.out = append(c.out, b...)</span>
 }
&nbsp;
 &#47;&#47; isPush returns whether the string op is either any of
<span class="term-fg36">@@ -263,13 +280,13 @@</span> 	lineno int
 }
&nbsp;
 func (err compileError) Error() string {
<span class="term-fg31">-	return fmt.Sprintf(&quot;%d syntax error: unexpected %v, expected %v&quot;, err.lineno, err.got, err.want)</span>
<span class="term-fg32">+	return fmt.Sprintf(&quot;%d: syntax error: unexpected %v, expected %v&quot;, err.lineno, err.got, err.want)</span>
 }
&nbsp;
 func compileErr(c token, got, want string) error {
 	return compileError{
 		got:    got,
 		want:   want,
<span class="term-fg31">-		lineno: c.lineno,</span>
<span class="term-fg32">+		lineno: c.lineno + 1,</span>
 	}
 }</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-191ef98bad3fc2dbc3ebae88" role="button"
                   aria-expanded="false" aria-controls="id-191ef98bad3fc2dbc3ebae88">
                    <code>core/asm/compiler_test.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/3f40e65c484486dea6cff80b7db178985d21a2c6/core/asm/compiler_test.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/650bb2f2b1dcfe30d9b1fa6f7dc9608055ed60e1/core/asm/compiler_test.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+8</span></div>
                        <div class="text-start"><span class="text-danger">-0</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-191ef98bad3fc2dbc3ebae88"><span class="term-fg1">diff --git go-ethereum&#47;core&#47;asm&#47;compiler_test.go op-geth&#47;core&#47;asm&#47;compiler_test.go</span>
<span class="term-fg1">index ce9df436bd404c47bbf8c87be95a6aa63c992d94..3d64c96bc80b41f73b8f04c4df6fe839857e89bb 100644</span>
<span class="term-fg1">--- go-ethereum&#47;core&#47;asm&#47;compiler_test.go</span>
<span class="term-fg1">+++ op-geth&#47;core&#47;asm&#47;compiler_test.go</span>
<span class="term-fg36">@@ -54,6 +54,14 @@</span> 	label:
 `,
 			output: &quot;6300000006565b&quot;,
 		},
<span class="term-fg32">+		{</span>
<span class="term-fg32">+			input: `</span>
<span class="term-fg32">+	JUMP @label</span>
<span class="term-fg32">+label: ;; comment</span>
<span class="term-fg32">+	ADD ;; comment</span>
<span class="term-fg32">+`,</span>
<span class="term-fg32">+			output: &quot;6300000006565b01&quot;,</span>
<span class="term-fg32">+		},</span>
 	}
 	for _, test := range tests {
 		ch := Lex([]byte(test.input), false)</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-9ccf147e4f388af59fed7365" role="button"
                   aria-expanded="false" aria-controls="id-9ccf147e4f388af59fed7365">
                    <code>core/asm/lex_test.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/3f40e65c484486dea6cff80b7db178985d21a2c6/core/asm/lex_test.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/650bb2f2b1dcfe30d9b1fa6f7dc9608055ed60e1/core/asm/lex_test.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+10</span></div>
                        <div class="text-start"><span class="text-danger">-0</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-9ccf147e4f388af59fed7365"><span class="term-fg1">diff --git go-ethereum&#47;core&#47;asm&#47;lex_test.go op-geth&#47;core&#47;asm&#47;lex_test.go</span>
<span class="term-fg1">index 53e05fbbba0ccee827499830f4e145d5b9525fc7..1e62d776d4016cfe914d4ed9bd0a0661fa43928b 100644</span>
<span class="term-fg1">--- go-ethereum&#47;core&#47;asm&#47;lex_test.go</span>
<span class="term-fg1">+++ op-geth&#47;core&#47;asm&#47;lex_test.go</span>
<span class="term-fg36">@@ -72,6 +72,16 @@</span> 		{
 			input:  &quot;@label123&quot;,
 			tokens: []token{{typ: lineStart}, {typ: label, text: &quot;label123&quot;}, {typ: eof}},
 		},
<span class="term-fg32">+		&#47;&#47; Comment after label</span>
<span class="term-fg32">+		{</span>
<span class="term-fg32">+			input:  &quot;@label123 ;; comment&quot;,</span>
<span class="term-fg32">+			tokens: []token{{typ: lineStart}, {typ: label, text: &quot;label123&quot;}, {typ: eof}},</span>
<span class="term-fg32">+		},</span>
<span class="term-fg32">+		&#47;&#47; Comment after instruction</span>
<span class="term-fg32">+		{</span>
<span class="term-fg32">+			input:  &quot;push 3 ;; comment\nadd&quot;,</span>
<span class="term-fg32">+			tokens: []token{{typ: lineStart}, {typ: element, text: &quot;push&quot;}, {typ: number, text: &quot;3&quot;}, {typ: lineEnd, text: &quot;\n&quot;}, {typ: lineStart, lineno: 1}, {typ: element, lineno: 1, text: &quot;add&quot;}, {typ: eof, lineno: 1}},</span>
<span class="term-fg32">+		},</span>
 	}
&nbsp;
 	for _, test := range tests {</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-608e0cfb6a71ee5c36df7307" role="button"
                   aria-expanded="false" aria-controls="id-608e0cfb6a71ee5c36df7307">
                    <code>core/asm/lexer.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/3f40e65c484486dea6cff80b7db178985d21a2c6/core/asm/lexer.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/650bb2f2b1dcfe30d9b1fa6f7dc9608055ed60e1/core/asm/lexer.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+12</span></div>
                        <div class="text-start"><span class="text-danger">-28</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-608e0cfb6a71ee5c36df7307"><span class="term-fg1">diff --git go-ethereum&#47;core&#47;asm&#47;lexer.go op-geth&#47;core&#47;asm&#47;lexer.go</span>
<span class="term-fg1">index d1b79a1fb922d5bcf8735a2ec592d42feb5bbd76..e025c6f363c6cd51e3974adafd683992cd541eaf 100644</span>
<span class="term-fg1">--- go-ethereum&#47;core&#47;asm&#47;lexer.go</span>
<span class="term-fg1">+++ op-geth&#47;core&#47;asm&#47;lexer.go</span>
<span class="term-fg36">@@ -42,6 +42,8 @@</span> &#47;&#47; tokenType are the different types the lexer
 &#47;&#47; is able to parse and return.
 type tokenType int
&nbsp;
<span class="term-fg32">+&#47;&#47;go:generate go run golang.org&#47;x&#47;tools&#47;cmd&#47;stringer -type tokenType</span>
<span class="term-fg32">+</span>
 const (
 	eof              tokenType = iota &#47;&#47; end of file
 	lineStart                         &#47;&#47; emitted when a line starts
<span class="term-fg36">@@ -52,31 +54,13 @@</span> 	label                             &#47;&#47; label is emitted when a label is found
 	labelDef                          &#47;&#47; label definition is emitted when a new label is found
 	number                            &#47;&#47; number is emitted when a number is found
 	stringValue                       &#47;&#47; stringValue is emitted when a string has been found
<span class="term-fg31">-</span>
<span class="term-fg31">-	Numbers            = &quot;1234567890&quot;                                           &#47;&#47; characters representing any decimal number</span>
<span class="term-fg31">-	HexadecimalNumbers = Numbers + &quot;aAbBcCdDeEfF&quot;                               &#47;&#47; characters representing any hexadecimal</span>
<span class="term-fg31">-	Alpha              = &quot;abcdefghijklmnopqrstuwvxyzABCDEFGHIJKLMNOPQRSTUWVXYZ&quot; &#47;&#47; characters representing alphanumeric</span>
 )
&nbsp;
<span class="term-fg31">-&#47;&#47; String implements stringer</span>
<span class="term-fg31">-func (it tokenType) String() string {</span>
<span class="term-fg31">-	if int(it) &gt; len(stringtokenTypes) {</span>
<span class="term-fg31">-		return &quot;invalid&quot;</span>
<span class="term-fg31">-	}</span>
<span class="term-fg31">-	return stringtokenTypes[it]</span>
<span class="term-fg31">-}</span>
<span class="term-fg31">-</span>
<span class="term-fg31">-var stringtokenTypes = []string{</span>
<span class="term-fg31">-	eof:              &quot;EOF&quot;,</span>
<span class="term-fg31">-	lineStart:        &quot;new line&quot;,</span>
<span class="term-fg31">-	lineEnd:          &quot;end of line&quot;,</span>
<span class="term-fg31">-	invalidStatement: &quot;invalid statement&quot;,</span>
<span class="term-fg31">-	element:          &quot;element&quot;,</span>
<span class="term-fg31">-	label:            &quot;label&quot;,</span>
<span class="term-fg31">-	labelDef:         &quot;label definition&quot;,</span>
<span class="term-fg31">-	number:           &quot;number&quot;,</span>
<span class="term-fg31">-	stringValue:      &quot;string&quot;,</span>
<span class="term-fg31">-}</span>
<span class="term-fg32">+const (</span>
<span class="term-fg32">+	decimalNumbers = &quot;1234567890&quot;                                           &#47;&#47; characters representing any decimal number</span>
<span class="term-fg32">+	hexNumbers     = decimalNumbers + &quot;aAbBcCdDeEfF&quot;                        &#47;&#47; characters representing any hexadecimal</span>
<span class="term-fg32">+	alpha          = &quot;abcdefghijklmnopqrstuwvxyzABCDEFGHIJKLMNOPQRSTUWVXYZ&quot; &#47;&#47; characters representing alphanumeric</span>
<span class="term-fg32">+)</span>
&nbsp;
 &#47;&#47; lexer is the basic construct for parsing
 &#47;&#47; source code and turning them in to tokens.
<span class="term-fg36">@@ -200,7 +184,6 @@</span> 		case r == &#39;\n&#39;:
 			l.emit(lineEnd)
 			l.ignore()
 			l.lineno++
<span class="term-fg31">-</span>
 			l.emit(lineStart)
 		case r == &#39;;&#39; &amp;&amp; l.peek() == &#39;;&#39;:
 			return lexComment
<span class="term-fg36">@@ -225,6 +208,7 @@</span> &#47;&#47; lexComment parses the current position until the end
 &#47;&#47; of the line and discards the text.
 func lexComment(l *lexer) stateFn {
 	l.acceptRunUntil(&#39;\n&#39;)
<span class="term-fg32">+	l.backup()</span>
 	l.ignore()
&nbsp;
 	return lexLine
<span class="term-fg36">@@ -234,7 +218,7 @@</span> &#47;&#47; lexLabel parses the current label, emits and returns
 &#47;&#47; the lex text state function to advance the parsing
 &#47;&#47; process.
 func lexLabel(l *lexer) stateFn {
<span class="term-fg31">-	l.acceptRun(Alpha + &quot;_&quot; + Numbers)</span>
<span class="term-fg32">+	l.acceptRun(alpha + &quot;_&quot; + decimalNumbers)</span>
&nbsp;
 	l.emit(label)
&nbsp;
<span class="term-fg36">@@ -253,9 +237,9 @@</span> 	return lexLine
 }
&nbsp;
 func lexNumber(l *lexer) stateFn {
<span class="term-fg31">-	acceptance := Numbers</span>
<span class="term-fg32">+	acceptance := decimalNumbers</span>
 	if l.accept(&quot;xX&quot;) {
<span class="term-fg31">-		acceptance = HexadecimalNumbers</span>
<span class="term-fg32">+		acceptance = hexNumbers</span>
 	}
 	l.acceptRun(acceptance)
&nbsp;
<span class="term-fg36">@@ -265,7 +249,7 @@</span> 	return lexLine
 }
&nbsp;
 func lexElement(l *lexer) stateFn {
<span class="term-fg31">-	l.acceptRun(Alpha + &quot;_&quot; + Numbers)</span>
<span class="term-fg32">+	l.acceptRun(alpha + &quot;_&quot; + decimalNumbers)</span>
&nbsp;
 	if l.peek() == &#39;:&#39; {
 		l.emit(labelDef)</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-e4b6d49b12c64b62e0b1ccee" role="button"
                   aria-expanded="false" aria-controls="id-e4b6d49b12c64b62e0b1ccee">
                    <code>core/asm/tokentype_string.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <span class="text-muted">(new)</span>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/650bb2f2b1dcfe30d9b1fa6f7dc9608055ed60e1/core/asm/tokentype_string.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+31</span></div>
                        <div class="text-start"><span class="text-danger">-0</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-e4b6d49b12c64b62e0b1ccee"><span class="term-fg1">diff --git go-ethereum&#47;core&#47;asm&#47;tokentype_string.go op-geth&#47;core&#47;asm&#47;tokentype_string.go</span>
<span class="term-fg1">new file mode 100644</span>
<span class="term-fg1">index 0000000000000000000000000000000000000000..ade76aa360c4840376b239ac9d1317b13dae72fe</span>
<span class="term-fg1">--- &#47;dev&#47;null</span>
<span class="term-fg1">+++ op-geth&#47;core&#47;asm&#47;tokentype_string.go</span>
<span class="term-fg36">@@ -0,0 +1,31 @@</span>
<span class="term-fg32">+&#47;&#47; Code generated by &quot;stringer -type tokenType&quot;; DO NOT EDIT.</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+package asm</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+import &quot;strconv&quot;</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func _() {</span>
<span class="term-fg32">+	&#47;&#47; An &quot;invalid array index&quot; compiler error signifies that the constant values have changed.</span>
<span class="term-fg32">+	&#47;&#47; Re-run the stringer command to generate them again.</span>
<span class="term-fg32">+	var x [1]struct{}</span>
<span class="term-fg32">+	_ = x[eof-0]</span>
<span class="term-fg32">+	_ = x[lineStart-1]</span>
<span class="term-fg32">+	_ = x[lineEnd-2]</span>
<span class="term-fg32">+	_ = x[invalidStatement-3]</span>
<span class="term-fg32">+	_ = x[element-4]</span>
<span class="term-fg32">+	_ = x[label-5]</span>
<span class="term-fg32">+	_ = x[labelDef-6]</span>
<span class="term-fg32">+	_ = x[number-7]</span>
<span class="term-fg32">+	_ = x[stringValue-8]</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+const _tokenType_name = &quot;eoflineStartlineEndinvalidStatementelementlabellabelDefnumberstringValue&quot;</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+var _tokenType_index = [...]uint8{0, 3, 12, 19, 35, 42, 47, 55, 61, 72}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func (i tokenType) String() string {</span>
<span class="term-fg32">+	if i &lt; 0 || i &gt;= tokenType(len(_tokenType_index)-1) {</span>
<span class="term-fg32">+		return &quot;tokenType(&quot; + strconv.FormatInt(int64(i), 10) + &quot;)&quot;</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	return _tokenType_name[_tokenType_index[i]:_tokenType_index[i+1]]</span>
<span class="term-fg32">+}</span></div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-d04c35191af6dd2a96b7c47b" role="button"
                   aria-expanded="false" aria-controls="id-d04c35191af6dd2a96b7c47b">
                    <code>core/bloombits/matcher.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/3f40e65c484486dea6cff80b7db178985d21a2c6/core/bloombits/matcher.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/650bb2f2b1dcfe30d9b1fa6f7dc9608055ed60e1/core/bloombits/matcher.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+6</span></div>
                        <div class="text-start"><span class="text-danger">-3</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-d04c35191af6dd2a96b7c47b"><span class="term-fg1">diff --git go-ethereum&#47;core&#47;bloombits&#47;matcher.go op-geth&#47;core&#47;bloombits&#47;matcher.go</span>
<span class="term-fg1">index d8f932041bc0d28ce2af5428068ca46912269f4f..6a4cfb23db19b1cbf364ded80f11ab3fb5c1f7dd 100644</span>
<span class="term-fg1">--- go-ethereum&#47;core&#47;bloombits&#47;matcher.go</span>
<span class="term-fg1">+++ op-geth&#47;core&#47;bloombits&#47;matcher.go</span>
<span class="term-fg36">@@ -58,7 +58,7 @@</span> &#47;&#47; Retrieval represents a request for retrieval task assignments for a given
 &#47;&#47; bit with the given number of fetch elements, or a response for such a request.
 &#47;&#47; It can also have the actual results set to be used as a delivery data struct.
 &#47;&#47;
<span class="term-fg31">-&#47;&#47; The contest and error fields are used by the light client to terminate matching</span>
<span class="term-fg32">+&#47;&#47; The context and error fields are used by the light client to terminate matching</span>
 &#47;&#47; early if an error is encountered on some path of the pipeline.
 type Retrieval struct {
 	Bit      uint
<span class="term-fg36">@@ -389,7 +389,7 @@</span> 		allocs     int                       &#47;&#47; Number of active allocations to handle graceful shutdown requests
 		shutdown   = session.quit            &#47;&#47; Shutdown request channel, will gracefully wait for pending requests
 	)
&nbsp;
<span class="term-fg31">-	&#47;&#47; assign is a helper method fo try to assign a pending bit an actively</span>
<span class="term-fg32">+	&#47;&#47; assign is a helper method to try to assign a pending bit an actively</span>
 	&#47;&#47; listening servicer, or schedule it up for later when one arrives.
 	assign := func(bit uint) {
 		select {
<span class="term-fg36">@@ -630,13 +630,16 @@</span> 			&#47;&#47; Retrieval accepted, something must arrive before we&#39;re aborting
 			request &lt;- &amp;Retrieval{Bit: bit, Sections: sections, Context: s.ctx}
&nbsp;
 			result := &lt;-request
<span class="term-fg32">+</span>
<span class="term-fg32">+			&#47;&#47; Deliver a result before s.Close() to avoid a deadlock</span>
<span class="term-fg32">+			s.deliverSections(result.Bit, result.Sections, result.Bitsets)</span>
<span class="term-fg32">+</span>
 			if result.Error != nil {
 				s.errLock.Lock()
 				s.err = result.Error
 				s.errLock.Unlock()
 				s.Close()
 			}
<span class="term-fg31">-			s.deliverSections(result.Bit, result.Sections, result.Bitsets)</span>
 		}
 	}
 }</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-54848b19f670219d48047796" role="button"
                   aria-expanded="false" aria-controls="id-54848b19f670219d48047796">
                    <code>core/bloombits/matcher_test.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/3f40e65c484486dea6cff80b7db178985d21a2c6/core/bloombits/matcher_test.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/650bb2f2b1dcfe30d9b1fa6f7dc9608055ed60e1/core/bloombits/matcher_test.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+2</span></div>
                        <div class="text-start"><span class="text-danger">-2</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-54848b19f670219d48047796"><span class="term-fg1">diff --git go-ethereum&#47;core&#47;bloombits&#47;matcher_test.go op-geth&#47;core&#47;bloombits&#47;matcher_test.go</span>
<span class="term-fg1">index 36764c3f174b421cd52a1f0daa15009c1bce31e1..7f3d5f279ca389623e5bbd3933e92c11a1a4803e 100644</span>
<span class="term-fg1">--- go-ethereum&#47;core&#47;bloombits&#47;matcher_test.go</span>
<span class="term-fg1">+++ op-geth&#47;core&#47;bloombits&#47;matcher_test.go</span>
<span class="term-fg36">@@ -85,7 +85,7 @@</span> 	}
 }
&nbsp;
 &#47;&#47; Tests that the matcher can properly find matches if the starting block is
<span class="term-fg31">-&#47;&#47; shifter from a multiple of 8. This is needed to cover an optimisation with</span>
<span class="term-fg32">+&#47;&#47; shifted from a multiple of 8. This is needed to cover an optimisation with</span>
 &#47;&#47; bitset matching https:&#47;&#47;github.com&#47;ethereum&#47;go-ethereum&#47;issues&#47;15309.
 func TestMatcherShifted(t *testing.T) {
 	t.Parallel()
<span class="term-fg36">@@ -106,7 +106,7 @@</span> 	t.Parallel()
 	testMatcherBothModes(t, nil, 0, 10000, 0)
 }
&nbsp;
<span class="term-fg31">-&#47;&#47; makeRandomIndexes generates a random filter system, composed on multiple filter</span>
<span class="term-fg32">+&#47;&#47; makeRandomIndexes generates a random filter system, composed of multiple filter</span>
 &#47;&#47; criteria, each having one bloom list component for the address and arbitrarily
 &#47;&#47; many topic bloom list components.
 func makeRandomIndexes(lengths []int, max int) [][]bloomIndexes {</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-377710be106fc62529bada84" role="button"
                   aria-expanded="false" aria-controls="id-377710be106fc62529bada84">
                    <code>core/chain_makers.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/3f40e65c484486dea6cff80b7db178985d21a2c6/core/chain_makers.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/650bb2f2b1dcfe30d9b1fa6f7dc9608055ed60e1/core/chain_makers.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+3</span></div>
                        <div class="text-start"><span class="text-danger">-5</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-377710be106fc62529bada84"><span class="term-fg1">diff --git go-ethereum&#47;core&#47;chain_makers.go op-geth&#47;core&#47;chain_makers.go</span>
<span class="term-fg1">index c9c880dd694695bd479c69ac0c161683ccb17c0b..3608329a132f9bc8224a38b02c4f48e06a206abd 100644</span>
<span class="term-fg1">--- go-ethereum&#47;core&#47;chain_makers.go</span>
<span class="term-fg1">+++ op-geth&#47;core&#47;chain_makers.go</span>
<span class="term-fg36">@@ -88,11 +88,6 @@</span> func (b *BlockGen) SetPoS() {
 	b.header.Difficulty = new(big.Int)
 }
&nbsp;
<span class="term-fg31">-&#47;&#47; SetBlobGas sets the data gas used by the blob in the generated block.</span>
<span class="term-fg31">-func (b *BlockGen) SetBlobGas(blobGasUsed uint64) {</span>
<span class="term-fg31">-	b.header.BlobGasUsed = &amp;blobGasUsed</span>
<span class="term-fg31">-}</span>
<span class="term-fg31">-</span>
 &#47;&#47; addTx adds a transaction to the generated block. If no coinbase has
 &#47;&#47; been set, the block&#39;s coinbase is set to the zero address.
 &#47;&#47;
<span class="term-fg36">@@ -111,6 +106,9 @@</span> 		panic(err)
 	}
 	b.txs = append(b.txs, tx)
 	b.receipts = append(b.receipts, receipt)
<span class="term-fg32">+	if b.header.BlobGasUsed != nil {</span>
<span class="term-fg32">+		*b.header.BlobGasUsed += receipt.BlobGasUsed</span>
<span class="term-fg32">+	}</span>
 }
&nbsp;
 &#47;&#47; AddTx adds a transaction to the generated block. If no coinbase has</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-1319c9ceef0089f3fdb831e4" role="button"
                   aria-expanded="false" aria-controls="id-1319c9ceef0089f3fdb831e4">
                    <code>core/forkid/forkid_test.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/3f40e65c484486dea6cff80b7db178985d21a2c6/core/forkid/forkid_test.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/650bb2f2b1dcfe30d9b1fa6f7dc9608055ed60e1/core/forkid/forkid_test.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+10</span></div>
                        <div class="text-start"><span class="text-danger">-0</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-1319c9ceef0089f3fdb831e4"><span class="term-fg1">diff --git go-ethereum&#47;core&#47;forkid&#47;forkid_test.go op-geth&#47;core&#47;forkid&#47;forkid_test.go</span>
<span class="term-fg1">index 3d49b2eced8d33560092d602a0df664c36f51ba7..db634bc14b90ded78efc9edbc4e46a5e0737ed53 100644</span>
<span class="term-fg1">--- go-ethereum&#47;core&#47;forkid&#47;forkid_test.go</span>
<span class="term-fg1">+++ op-geth&#47;core&#47;forkid&#47;forkid_test.go</span>
<span class="term-fg36">@@ -107,6 +107,16 @@</span> 				{1735372, 1677557087, ID{Hash: checksumToBytes(0xb96cbd13), Next: 1677557088}}, &#47;&#47; Last MergeNetsplit block
 				{1735372, 1677557088, ID{Hash: checksumToBytes(0xf7f9bc08), Next: 0}},          &#47;&#47; First Shanghai block
 			},
 		},
<span class="term-fg32">+		&#47;&#47; Holesky test cases</span>
<span class="term-fg32">+		{</span>
<span class="term-fg32">+			params.HoleskyChainConfig,</span>
<span class="term-fg32">+			core.DefaultHoleskyGenesisBlock().ToBlock(),</span>
<span class="term-fg32">+			[]testcase{</span>
<span class="term-fg32">+				{0, 0, ID{Hash: checksumToBytes(0xc61a6098), Next: 1696000704}},   &#47;&#47; Unsynced, last Frontier, Homestead, Tangerine, Spurious, Byzantium, Constantinople, Petersburg, Istanbul, Berlin, London, Paris block</span>
<span class="term-fg32">+				{123, 0, ID{Hash: checksumToBytes(0xc61a6098), Next: 1696000704}}, &#47;&#47; First MergeNetsplit block</span>
<span class="term-fg32">+				{123, 1696000704, ID{Hash: checksumToBytes(0xfd4f016b), Next: 0}}, &#47;&#47; Last MergeNetsplit block</span>
<span class="term-fg32">+			},</span>
<span class="term-fg32">+		},</span>
 	}
 	for i, tt := range tests {
 		for j, ttt := range tt.cases {</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-2e2090cc292ed8dcc80e97d3" role="button"
                   aria-expanded="false" aria-controls="id-2e2090cc292ed8dcc80e97d3">
                    <code>core/genesis_test.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/3f40e65c484486dea6cff80b7db178985d21a2c6/core/genesis_test.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/650bb2f2b1dcfe30d9b1fa6f7dc9608055ed60e1/core/genesis_test.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+1</span></div>
                        <div class="text-start"><span class="text-danger">-1</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-2e2090cc292ed8dcc80e97d3"><span class="term-fg1">diff --git go-ethereum&#47;core&#47;genesis_test.go op-geth&#47;core&#47;genesis_test.go</span>
<span class="term-fg1">index 6a0f2df08525f7c5aacd77ea048cc375c0730727..fac88ff373b35d97017009434390d416992d21e9 100644</span>
<span class="term-fg1">--- go-ethereum&#47;core&#47;genesis_test.go</span>
<span class="term-fg1">+++ op-geth&#47;core&#47;genesis_test.go</span>
<span class="term-fg36">@@ -231,7 +231,7 @@</span> 		alloc = &amp;GenesisAlloc{
 			{1}: {Balance: big.NewInt(1), Storage: map[common.Hash]common.Hash{{1}: {1}}},
 			{2}: {Balance: big.NewInt(2), Storage: map[common.Hash]common.Hash{{2}: {2}}},
 		}
<span class="term-fg31">-		hash, _ = alloc.deriveHash()</span>
<span class="term-fg32">+		hash, _ = alloc.hash()</span>
 	)
 	blob, _ := json.Marshal(alloc)
 	rawdb.WriteGenesisStateSpec(db, hash, blob)</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-533de2d9d2c6920245319b71" role="button"
                   aria-expanded="false" aria-controls="id-533de2d9d2c6920245319b71">
                    <code>core/rawdb/accessors_chain_test.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/3f40e65c484486dea6cff80b7db178985d21a2c6/core/rawdb/accessors_chain_test.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/650bb2f2b1dcfe30d9b1fa6f7dc9608055ed60e1/core/rawdb/accessors_chain_test.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+79</span></div>
                        <div class="text-start"><span class="text-danger">-22</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-533de2d9d2c6920245319b71"><span class="term-fg1">diff --git go-ethereum&#47;core&#47;rawdb&#47;accessors_chain_test.go op-geth&#47;core&#47;rawdb&#47;accessors_chain_test.go</span>
<span class="term-fg1">index a7ceb72998a115653130a19932f443dfda3f7cc4..3340c7f15c8200a11b2831abb90dd4a052b2b6f8 100644</span>
<span class="term-fg1">--- go-ethereum&#47;core&#47;rawdb&#47;accessors_chain_test.go</span>
<span class="term-fg1">+++ op-geth&#47;core&#47;rawdb&#47;accessors_chain_test.go</span>
<span class="term-fg36">@@ -27,10 +27,12 @@</span> 	&quot;reflect&quot;
 	&quot;testing&quot;
&nbsp;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;common&quot;
<span class="term-fg32">+	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;common&#47;math&quot;</span>
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;core&#47;types&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;crypto&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;params&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;rlp&quot;
<span class="term-fg32">+	&quot;github.com&#47;stretchr&#47;testify&#47;require&quot;</span>
 	&quot;golang.org&#47;x&#47;crypto&#47;sha3&quot;
 )
&nbsp;
<span class="term-fg36">@@ -347,6 +349,9 @@</span> 	&#47;&#47; Create a live block since we need metadata to reconstruct the receipt
 	tx1 := types.NewTransaction(1, common.HexToAddress(&quot;0x1&quot;), big.NewInt(1), 1, big.NewInt(1), nil)
 	tx2 := types.NewTransaction(2, common.HexToAddress(&quot;0x2&quot;), big.NewInt(2), 2, big.NewInt(2), nil)
&nbsp;
<span class="term-fg32">+	header := &amp;types.Header{</span>
<span class="term-fg32">+		Number: big.NewInt(0),</span>
<span class="term-fg32">+	}</span>
 	body := &amp;types.Body{Transactions: types.Transactions{tx1, tx2}}
&nbsp;
 	&#47;&#47; Create the two receipts to manage afterwards
<span class="term-fg36">@@ -378,13 +383,16 @@</span> 	receipt2.Bloom = types.CreateBloom(types.Receipts{receipt2})
 	receipts := []*types.Receipt{receipt1, receipt2}
&nbsp;
 	&#47;&#47; Check that no receipt entries are in a pristine database
<span class="term-fg31">-	hash := common.BytesToHash([]byte{0x03, 0x14})</span>
<span class="term-fg32">+	hash := header.Hash()</span>
 	if rs := ReadReceipts(db, hash, 0, 0, params.TestChainConfig); len(rs) != 0 {
 		t.Fatalf(&quot;non existent receipts returned: %v&quot;, rs)
 	}
 	&#47;&#47; Insert the body that corresponds to the receipts
 	WriteBody(db, hash, 0, body)
&nbsp;
<span class="term-fg32">+	&#47;&#47; Insert the header that corresponds to the receipts</span>
<span class="term-fg32">+	WriteHeader(db, header)</span>
<span class="term-fg32">+</span>
 	&#47;&#47; Insert the receipt slice into the database and check presence
 	WriteReceipts(db, hash, 0, receipts)
 	if rs := ReadReceipts(db, hash, 0, 0, params.TestChainConfig); len(rs) == 0 {
<span class="term-fg36">@@ -694,36 +702,56 @@</span>
 	&#47;&#47; Create a live block since we need metadata to reconstruct the receipt
 	tx1 := types.NewTransaction(1, common.HexToAddress(&quot;0x1&quot;), big.NewInt(1), 1, big.NewInt(1), nil)
 	tx2 := types.NewTransaction(2, common.HexToAddress(&quot;0x2&quot;), big.NewInt(2), 2, big.NewInt(2), nil)
<span class="term-fg32">+	tx3 := types.NewTransaction(3, common.HexToAddress(&quot;0x3&quot;), big.NewInt(3), 3, big.NewInt(3), nil)</span>
&nbsp;
<span class="term-fg31">-	body := &amp;types.Body{Transactions: types.Transactions{tx1, tx2}}</span>
<span class="term-fg32">+	body := &amp;types.Body{Transactions: types.Transactions{tx1, tx2, tx3}}</span>
&nbsp;
<span class="term-fg31">-	&#47;&#47; Create the two receipts to manage afterwards</span>
<span class="term-fg31">-	receipt1 := &amp;types.Receipt{</span>
<span class="term-fg32">+	&#47;&#47; Create the three receipts to manage afterwards</span>
<span class="term-fg32">+	depositNonce := uint64(math.MaxUint64)</span>
<span class="term-fg32">+	depositReceipt := types.Receipt{</span>
 		Status:            types.ReceiptStatusFailed,
 		CumulativeGasUsed: 1,
 		Logs: []*types.Log{
 			{Address: common.BytesToAddress([]byte{0x11})},
 			{Address: common.BytesToAddress([]byte{0x01, 0x11})},
 		},
<span class="term-fg31">-		TxHash:          tx1.Hash(),</span>
<span class="term-fg31">-		ContractAddress: common.BytesToAddress([]byte{0x01, 0x11, 0x11}),</span>
<span class="term-fg31">-		GasUsed:         111111,</span>
<span class="term-fg32">+		TxHash:                tx1.Hash(),</span>
<span class="term-fg32">+		ContractAddress:       common.BytesToAddress([]byte{0x01, 0x11, 0x11}),</span>
<span class="term-fg32">+		GasUsed:               111111,</span>
<span class="term-fg32">+		DepositNonce:          &amp;depositNonce,</span>
<span class="term-fg32">+		DepositReceiptVersion: nil,</span>
 	}
<span class="term-fg31">-	receipt1.Bloom = types.CreateBloom(types.Receipts{receipt1})</span>
<span class="term-fg32">+	depositReceipt.Bloom = types.CreateBloom(types.Receipts{&amp;depositReceipt})</span>
&nbsp;
<span class="term-fg31">-	receipt2 := &amp;types.Receipt{</span>
<span class="term-fg31">-		PostState:         common.Hash{2}.Bytes(),</span>
<span class="term-fg32">+	receiptVersion := types.CanyonDepositReceiptVersion</span>
<span class="term-fg32">+	versionedDepositReceipt := types.Receipt{</span>
<span class="term-fg32">+		Status:            types.ReceiptStatusFailed,</span>
 		CumulativeGasUsed: 2,
 		Logs: []*types.Log{
 			{Address: common.BytesToAddress([]byte{0x22})},
<span class="term-fg31">-			{Address: common.BytesToAddress([]byte{0x02, 0x22})},</span>
<span class="term-fg32">+			{Address: common.BytesToAddress([]byte{0x01, 0x11})},</span>
<span class="term-fg32">+		},</span>
<span class="term-fg32">+		TxHash:                tx2.Hash(),</span>
<span class="term-fg32">+		ContractAddress:       common.BytesToAddress([]byte{0x02, 0x22, 0x22}),</span>
<span class="term-fg32">+		GasUsed:               222222,</span>
<span class="term-fg32">+		DepositNonce:          &amp;depositNonce,</span>
<span class="term-fg32">+		DepositReceiptVersion: &amp;receiptVersion,</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	versionedDepositReceipt.Bloom = types.CreateBloom(types.Receipts{&amp;versionedDepositReceipt})</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	receipt := types.Receipt{</span>
<span class="term-fg32">+		PostState:         common.Hash{3}.Bytes(),</span>
<span class="term-fg32">+		CumulativeGasUsed: 3,</span>
<span class="term-fg32">+		Logs: []*types.Log{</span>
<span class="term-fg32">+			{Address: common.BytesToAddress([]byte{0x33})},</span>
<span class="term-fg32">+			{Address: common.BytesToAddress([]byte{0x03, 0x33})},</span>
 		},
<span class="term-fg31">-		TxHash:          tx2.Hash(),</span>
<span class="term-fg31">-		ContractAddress: common.BytesToAddress([]byte{0x02, 0x22, 0x22}),</span>
<span class="term-fg31">-		GasUsed:         222222,</span>
<span class="term-fg32">+		TxHash:          tx3.Hash(),</span>
<span class="term-fg32">+		ContractAddress: common.BytesToAddress([]byte{0x03, 0x33, 0x33}),</span>
<span class="term-fg32">+		GasUsed:         333333,</span>
 	}
<span class="term-fg31">-	receipt2.Bloom = types.CreateBloom(types.Receipts{receipt2})</span>
<span class="term-fg31">-	receipts := []*types.Receipt{receipt1, receipt2}</span>
<span class="term-fg32">+	receipt.Bloom = types.CreateBloom(types.Receipts{&amp;receipt})</span>
<span class="term-fg32">+	receipts := []*types.Receipt{&amp;receipt, &amp;depositReceipt, &amp;versionedDepositReceipt}</span>
&nbsp;
 	hash := common.BytesToHash([]byte{0x03, 0x14})
 	&#47;&#47; Check that no receipt entries are in a pristine database
<span class="term-fg36">@@ -740,14 +768,13 @@</span> 	logs := ReadLogs(db, hash, 0)
 	if len(logs) == 0 {
 		t.Fatalf(&quot;no logs returned&quot;)
 	}
<span class="term-fg31">-	if have, want := len(logs), 2; have != want {</span>
<span class="term-fg32">+	if have, want := len(logs), 3; have != want {</span>
 		t.Fatalf(&quot;unexpected number of logs returned, have %d want %d&quot;, have, want)
 	}
<span class="term-fg31">-	if have, want := len(logs[0]), 2; have != want {</span>
<span class="term-fg31">-		t.Fatalf(&quot;unexpected number of logs[0] returned, have %d want %d&quot;, have, want)</span>
<span class="term-fg31">-	}</span>
<span class="term-fg31">-	if have, want := len(logs[1]), 2; have != want {</span>
<span class="term-fg31">-		t.Fatalf(&quot;unexpected number of logs[1] returned, have %d want %d&quot;, have, want)</span>
<span class="term-fg32">+	for i := range logs {</span>
<span class="term-fg32">+		if have, want := len(logs[i]), 2; have != want {</span>
<span class="term-fg32">+			t.Fatalf(&quot;unexpected number of logs[%d] returned, have %d want %d&quot;, i, have, want)</span>
<span class="term-fg32">+		}</span>
 	}
&nbsp;
 	for i, pr := range receipts {
<span class="term-fg36">@@ -765,6 +792,36 @@</span> 				t.Fatalf(&quot;receipt #%d: receipt mismatch: have %s, want %s&quot;, i, hex.EncodeToString(rlpHave), hex.EncodeToString(rlpWant))
 			}
 		}
 	}
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func TestParseLegacyReceiptRLP(t *testing.T) {</span>
<span class="term-fg32">+	&#47;&#47; Create a gasUsed value greater than a uint64 can represent</span>
<span class="term-fg32">+	gasUsed := big.NewInt(0)</span>
<span class="term-fg32">+	gasUsed = gasUsed.SetUint64(math.MaxUint64)</span>
<span class="term-fg32">+	gasUsed = gasUsed.Add(gasUsed, big.NewInt(math.MaxInt64))</span>
<span class="term-fg32">+	sanityCheck := (&amp;big.Int{}).SetUint64(gasUsed.Uint64())</span>
<span class="term-fg32">+	require.NotEqual(t, gasUsed, sanityCheck)</span>
<span class="term-fg32">+	receipt := types.LegacyOptimismStoredReceiptRLP{</span>
<span class="term-fg32">+		CumulativeGasUsed: 1,</span>
<span class="term-fg32">+		Logs: []*types.LogForStorage{</span>
<span class="term-fg32">+			{Address: common.BytesToAddress([]byte{0x11})},</span>
<span class="term-fg32">+			{Address: common.BytesToAddress([]byte{0x01, 0x11})},</span>
<span class="term-fg32">+		},</span>
<span class="term-fg32">+		L1GasUsed:  gasUsed,</span>
<span class="term-fg32">+		L1GasPrice: gasUsed,</span>
<span class="term-fg32">+		L1Fee:      gasUsed,</span>
<span class="term-fg32">+		FeeScalar:  &quot;6&quot;,</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	data, err := rlp.EncodeToBytes(receipt)</span>
<span class="term-fg32">+	require.NoError(t, err)</span>
<span class="term-fg32">+	var result storedReceiptRLP</span>
<span class="term-fg32">+	err = rlp.DecodeBytes(data, &amp;result)</span>
<span class="term-fg32">+	require.NoError(t, err)</span>
<span class="term-fg32">+	require.Equal(t, receipt.L1GasUsed, result.L1GasUsed)</span>
<span class="term-fg32">+	require.Equal(t, receipt.L1GasPrice, result.L1GasPrice)</span>
<span class="term-fg32">+	require.Equal(t, receipt.L1Fee, result.L1Fee)</span>
<span class="term-fg32">+	require.Equal(t, receipt.FeeScalar, result.FeeScalar)</span>
 }
&nbsp;
 func TestDeriveLogFields(t *testing.T) {</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-7c142a8d65422e4c40e384b0" role="button"
                   aria-expanded="false" aria-controls="id-7c142a8d65422e4c40e384b0">
                    <code>core/rawdb/accessors_sync.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/3f40e65c484486dea6cff80b7db178985d21a2c6/core/rawdb/accessors_sync.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/650bb2f2b1dcfe30d9b1fa6f7dc9608055ed60e1/core/rawdb/accessors_sync.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+22</span></div>
                        <div class="text-start"><span class="text-danger">-0</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-7c142a8d65422e4c40e384b0"><span class="term-fg1">diff --git go-ethereum&#47;core&#47;rawdb&#47;accessors_sync.go op-geth&#47;core&#47;rawdb&#47;accessors_sync.go</span>
<span class="term-fg1">index 7a7374e168627475d62e238c7972e6e55f38515f..2dc08b3b72858d84e19e3827ee4d1db183b35f0e 100644</span>
<span class="term-fg1">--- go-ethereum&#47;core&#47;rawdb&#47;accessors_sync.go</span>
<span class="term-fg1">+++ op-geth&#47;core&#47;rawdb&#47;accessors_sync.go</span>
<span class="term-fg36">@@ -76,3 +76,25 @@</span> 	if err := db.Delete(skeletonHeaderKey(number)); err != nil {
 		log.Crit(&quot;Failed to delete skeleton header&quot;, &quot;err&quot;, err)
 	}
 }
<span class="term-fg32">+</span>
<span class="term-fg32">+const (</span>
<span class="term-fg32">+	StateSyncUnknown  = uint8(0) &#47;&#47; flags the state snap sync is unknown</span>
<span class="term-fg32">+	StateSyncRunning  = uint8(1) &#47;&#47; flags the state snap sync is not completed yet</span>
<span class="term-fg32">+	StateSyncFinished = uint8(2) &#47;&#47; flags the state snap sync is completed</span>
<span class="term-fg32">+)</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+&#47;&#47; ReadSnapSyncStatusFlag retrieves the state snap sync status flag.</span>
<span class="term-fg32">+func ReadSnapSyncStatusFlag(db ethdb.KeyValueReader) uint8 {</span>
<span class="term-fg32">+	blob, err := db.Get(snapSyncStatusFlagKey)</span>
<span class="term-fg32">+	if err != nil || len(blob) != 1 {</span>
<span class="term-fg32">+		return StateSyncUnknown</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	return blob[0]</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+&#47;&#47; WriteSnapSyncStatusFlag stores the state snap sync status flag into database.</span>
<span class="term-fg32">+func WriteSnapSyncStatusFlag(db ethdb.KeyValueWriter, flag uint8) {</span>
<span class="term-fg32">+	if err := db.Put(snapSyncStatusFlagKey, []byte{flag}); err != nil {</span>
<span class="term-fg32">+		log.Crit(&quot;Failed to store sync status flag&quot;, &quot;err&quot;, err)</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+}</span></div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-cba5745b5b4e5c68455990e3" role="button"
                   aria-expanded="false" aria-controls="id-cba5745b5b4e5c68455990e3">
                    <code>core/rawdb/accessors_trie.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/3f40e65c484486dea6cff80b7db178985d21a2c6/core/rawdb/accessors_trie.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/650bb2f2b1dcfe30d9b1fa6f7dc9608055ed60e1/core/rawdb/accessors_trie.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+55</span></div>
                        <div class="text-start"><span class="text-danger">-0</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-cba5745b5b4e5c68455990e3"><span class="term-fg1">diff --git go-ethereum&#47;core&#47;rawdb&#47;accessors_trie.go op-geth&#47;core&#47;rawdb&#47;accessors_trie.go</span>
<span class="term-fg1">index f5c2f8899a0282208f15e3ed951d5f3459a4af16..78f1a70b1c04bae371fbe75f6ec1826c618d1d0b 100644</span>
<span class="term-fg1">--- go-ethereum&#47;core&#47;rawdb&#47;accessors_trie.go</span>
<span class="term-fg1">+++ op-geth&#47;core&#47;rawdb&#47;accessors_trie.go</span>
<span class="term-fg36">@@ -89,6 +89,16 @@</span> 	defer h.release()
 	return h.hash(data) == hash
 }
&nbsp;
<span class="term-fg32">+&#47;&#47; ExistsAccountTrieNode checks the presence of the account trie node with the</span>
<span class="term-fg32">+&#47;&#47; specified node path, regardless of the node hash.</span>
<span class="term-fg32">+func ExistsAccountTrieNode(db ethdb.KeyValueReader, path []byte) bool {</span>
<span class="term-fg32">+	has, err := db.Has(accountTrieNodeKey(path))</span>
<span class="term-fg32">+	if err != nil {</span>
<span class="term-fg32">+		return false</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	return has</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
 &#47;&#47; WriteAccountTrieNode writes the provided account trie node into database.
 func WriteAccountTrieNode(db ethdb.KeyValueWriter, path []byte, node []byte) {
 	if err := db.Put(accountTrieNodeKey(path), node); err != nil {
<span class="term-fg36">@@ -125,6 +135,16 @@</span> 	}
 	h := newHasher()
 	defer h.release()
 	return h.hash(data) == hash
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+&#47;&#47; ExistsStorageTrieNode checks the presence of the storage trie node with the</span>
<span class="term-fg32">+&#47;&#47; specified account hash and node path, regardless of the node hash.</span>
<span class="term-fg32">+func ExistsStorageTrieNode(db ethdb.KeyValueReader, accountHash common.Hash, path []byte) bool {</span>
<span class="term-fg32">+	has, err := db.Has(storageTrieNodeKey(accountHash, path))</span>
<span class="term-fg32">+	if err != nil {</span>
<span class="term-fg32">+		return false</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	return has</span>
 }
&nbsp;
 &#47;&#47; WriteStorageTrieNode writes the provided storage trie node into database.
<span class="term-fg36">@@ -285,3 +305,38 @@</span> 		return &quot;&quot; &#47;&#47; no state in disk
 	}
 	return HashScheme
 }
<span class="term-fg32">+</span>
<span class="term-fg32">+&#47;&#47; ParseStateScheme checks if the specified state scheme is compatible with</span>
<span class="term-fg32">+&#47;&#47; the stored state.</span>
<span class="term-fg32">+&#47;&#47;</span>
<span class="term-fg32">+&#47;&#47;   - If the provided scheme is none, use the scheme consistent with persistent</span>
<span class="term-fg32">+&#47;&#47;     state, or fallback to hash-based scheme if state is empty.</span>
<span class="term-fg32">+&#47;&#47;</span>
<span class="term-fg32">+&#47;&#47;   - If the provided scheme is hash, use hash-based scheme or error out if not</span>
<span class="term-fg32">+&#47;&#47;     compatible with persistent state scheme.</span>
<span class="term-fg32">+&#47;&#47;</span>
<span class="term-fg32">+&#47;&#47;   - If the provided scheme is path: use path-based scheme or error out if not</span>
<span class="term-fg32">+&#47;&#47;     compatible with persistent state scheme.</span>
<span class="term-fg32">+func ParseStateScheme(provided string, disk ethdb.Database) (string, error) {</span>
<span class="term-fg32">+	&#47;&#47; If state scheme is not specified, use the scheme consistent</span>
<span class="term-fg32">+	&#47;&#47; with persistent state, or fallback to hash mode if database</span>
<span class="term-fg32">+	&#47;&#47; is empty.</span>
<span class="term-fg32">+	stored := ReadStateScheme(disk)</span>
<span class="term-fg32">+	if provided == &quot;&quot; {</span>
<span class="term-fg32">+		if stored == &quot;&quot; {</span>
<span class="term-fg32">+			&#47;&#47; use default scheme for empty database, flip it when</span>
<span class="term-fg32">+			&#47;&#47; path mode is chosen as default</span>
<span class="term-fg32">+			log.Info(&quot;State schema set to default&quot;, &quot;scheme&quot;, &quot;hash&quot;)</span>
<span class="term-fg32">+			return HashScheme, nil</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+		log.Info(&quot;State scheme set to already existing&quot;, &quot;scheme&quot;, stored)</span>
<span class="term-fg32">+		return stored, nil &#47;&#47; reuse scheme of persistent scheme</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	&#47;&#47; If state scheme is specified, ensure it&#39;s compatible with</span>
<span class="term-fg32">+	&#47;&#47; persistent state.</span>
<span class="term-fg32">+	if stored == &quot;&quot; || provided == stored {</span>
<span class="term-fg32">+		log.Info(&quot;State scheme set by user&quot;, &quot;scheme&quot;, provided)</span>
<span class="term-fg32">+		return provided, nil</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	return &quot;&quot;, fmt.Errorf(&quot;incompatible state scheme, stored: %s, provided: %s&quot;, stored, provided)</span>
<span class="term-fg32">+}</span></div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-e3753b06fe69469a46f080d2" role="button"
                   aria-expanded="false" aria-controls="id-e3753b06fe69469a46f080d2">
                    <code>core/rawdb/chain_freezer.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/3f40e65c484486dea6cff80b7db178985d21a2c6/core/rawdb/chain_freezer.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/650bb2f2b1dcfe30d9b1fa6f7dc9608055ed60e1/core/rawdb/chain_freezer.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+1</span></div>
                        <div class="text-start"><span class="text-danger">-1</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-e3753b06fe69469a46f080d2"><span class="term-fg1">diff --git go-ethereum&#47;core&#47;rawdb&#47;chain_freezer.go op-geth&#47;core&#47;rawdb&#47;chain_freezer.go</span>
<span class="term-fg1">index 22dbda4a2107a7e3376aa450a2579bcdca7d54d3..cbfaf5b9e4e6ad5e775b138827f144ffa30ba870 100644</span>
<span class="term-fg1">--- go-ethereum&#47;core&#47;rawdb&#47;chain_freezer.go</span>
<span class="term-fg1">+++ op-geth&#47;core&#47;rawdb&#47;chain_freezer.go</span>
<span class="term-fg36">@@ -200,7 +200,7 @@</span> 			log.Crit(&quot;Failed to delete frozen side blocks&quot;, &quot;err&quot;, err)
 		}
 		batch.Reset()
&nbsp;
<span class="term-fg31">-		&#47;&#47; Step into the future and delete and dangling side chains</span>
<span class="term-fg32">+		&#47;&#47; Step into the future and delete any dangling side chains</span>
 		if frozen &gt; 0 {
 			tip := frozen
 			for len(dangling) &gt; 0 {</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-d0c69d209658d906d78b157a" role="button"
                   aria-expanded="false" aria-controls="id-d0c69d209658d906d78b157a">
                    <code>core/rawdb/database.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/3f40e65c484486dea6cff80b7db178985d21a2c6/core/rawdb/database.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/650bb2f2b1dcfe30d9b1fa6f7dc9608055ed60e1/core/rawdb/database.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+7</span></div>
                        <div class="text-start"><span class="text-danger">-7</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-d0c69d209658d906d78b157a"><span class="term-fg1">diff --git go-ethereum&#47;core&#47;rawdb&#47;database.go op-geth&#47;core&#47;rawdb&#47;database.go</span>
<span class="term-fg1">index 7a7845638253fca05999d89d633fa7781210a461..0c7cf9f11bd215e8d1791913579b0f89ffa9bc42 100644</span>
<span class="term-fg1">--- go-ethereum&#47;core&#47;rawdb&#47;database.go</span>
<span class="term-fg1">+++ op-geth&#47;core&#47;rawdb&#47;database.go</span>
<span class="term-fg36">@@ -34,7 +34,7 @@</span> 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;log&quot;
 	&quot;github.com&#47;olekukonko&#47;tablewriter&quot;
 )
&nbsp;
<span class="term-fg31">-&#47;&#47; freezerdb is a database wrapper that enabled freezer data retrievals.</span>
<span class="term-fg32">+&#47;&#47; freezerdb is a database wrapper that enables freezer data retrievals.</span>
 type freezerdb struct {
 	ancientRoot string
 	ethdb.KeyValueStore
<span class="term-fg36">@@ -141,7 +141,7 @@</span> func (db *nofreezedb) ReadAncients(fn func(reader ethdb.AncientReaderOp) error) (err error) {
 	&#47;&#47; Unlike other ancient-related methods, this method does not return
 	&#47;&#47; errNotSupported when invoked.
 	&#47;&#47; The reason for this is that the caller might want to do several things:
<span class="term-fg31">-	&#47;&#47; 1. Check if something is in freezer,</span>
<span class="term-fg32">+	&#47;&#47; 1. Check if something is in the freezer,</span>
 	&#47;&#47; 2. If not, check leveldb.
 	&#47;&#47;
 	&#47;&#47; This will work, since the ancient-checks inside &#39;fn&#39; will return errors,
<span class="term-fg36">@@ -209,7 +209,7 @@</span> 	&#47;&#47; there&#39;s a fairly high probability that the user requests invalid combinations
 	&#47;&#47; of the freezer and database. Ensure that we don&#39;t shoot ourselves in the foot
 	&#47;&#47; by serving up conflicting data, leading to both datastores getting corrupted.
 	&#47;&#47;
<span class="term-fg31">-	&#47;&#47;   - If both the freezer and key-value store is empty (no genesis), we just</span>
<span class="term-fg32">+	&#47;&#47;   - If both the freezer and key-value store are empty (no genesis), we just</span>
 	&#47;&#47;     initialized a new empty freezer, so everything&#39;s fine.
 	&#47;&#47;   - If the key-value store is empty, but the freezer is not, we need to make
 	&#47;&#47;     sure the user&#39;s genesis matches the freezer. That will be checked in the
<span class="term-fg36">@@ -218,7 +218,7 @@</span> 	&#47;&#47;     this point care, the key-value&#47;freezer combo is valid).
 	&#47;&#47;   - If neither the key-value store nor the freezer is empty, cross validate
 	&#47;&#47;     the genesis hashes to make sure they are compatible. If they are, also
 	&#47;&#47;     ensure that there&#39;s no gap between the freezer and subsequently leveldb.
<span class="term-fg31">-	&#47;&#47;   - If the key-value store is not empty, but the freezer is we might just be</span>
<span class="term-fg32">+	&#47;&#47;   - If the key-value store is not empty, but the freezer is, we might just be</span>
 	&#47;&#47;     upgrading to the freezer release, or we might have had a small chain and
 	&#47;&#47;     not frozen anything yet. Ensure that no blocks are missing yet from the
 	&#47;&#47;     key-value store, since that would mean we already had an old freezer.
<span class="term-fg36">@@ -253,7 +253,7 @@</span> 						if present, _ := db.Has(headerHashKey(number)); present {
 							break
 						}
 					}
<span class="term-fg31">-					&#47;&#47; We are about to exit on error. Print database metdata beore exiting</span>
<span class="term-fg32">+					&#47;&#47; We are about to exit on error. Print database metadata before exiting</span>
 					printChainMetadata(db)
 					return nil, fmt.Errorf(&quot;gap in the chain between ancients [0 - #%d] and leveldb [#%d - #%d] &quot;,
 						frozen-1, number, head)
<span class="term-fg36">@@ -555,7 +555,7 @@</span> 				databaseVersionKey, headHeaderKey, headBlockKey, headFastBlockKey, headFinalizedBlockKey,
 				lastPivotKey, fastTrieProgressKey, snapshotDisabledKey, SnapshotRootKey, snapshotJournalKey,
 				snapshotGeneratorKey, snapshotRecoveryKey, txIndexTailKey, fastTxLookupLimitKey,
 				uncleanShutdownKey, badBlockKey, transitionStatusKey, skeletonSyncStatusKey,
<span class="term-fg31">-				persistentStateIDKey, trieJournalKey, snapshotSyncStatusKey,</span>
<span class="term-fg32">+				persistentStateIDKey, trieJournalKey, snapshotSyncStatusKey, snapSyncStatusFlagKey,</span>
 			} {
 				if bytes.Equal(key, meta) {
 					metadata.Add(size)
<span class="term-fg36">@@ -634,7 +634,7 @@</span> 	}
 	fmt.Fprintf(os.Stderr, &quot;\n\n&quot;)
 }
&nbsp;
<span class="term-fg31">-&#47;&#47; ReadChainMetadata returns a set of key&#47;value pairs that contains informatin</span>
<span class="term-fg32">+&#47;&#47; ReadChainMetadata returns a set of key&#47;value pairs that contains information</span>
 &#47;&#47; about the database chain status. This can be used for diagnostic purposes
 &#47;&#47; when investigating the state of the node.
 func ReadChainMetadata(db ethdb.KeyValueStore) [][]string {</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-fbe771b2e8fdc39c324f809e" role="button"
                   aria-expanded="false" aria-controls="id-fbe771b2e8fdc39c324f809e">
                    <code>core/rawdb/databases_64bit.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/3f40e65c484486dea6cff80b7db178985d21a2c6/core/rawdb/databases_64bit.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/650bb2f2b1dcfe30d9b1fa6f7dc9608055ed60e1/core/rawdb/databases_64bit.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+1</span></div>
                        <div class="text-start"><span class="text-danger">-1</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-fbe771b2e8fdc39c324f809e"><span class="term-fg1">diff --git go-ethereum&#47;core&#47;rawdb&#47;databases_64bit.go op-geth&#47;core&#47;rawdb&#47;databases_64bit.go</span>
<span class="term-fg1">index 1593e89bfe6accd236f573051ad673c72c41941f..e9f9332ad01cbec1742c268ef1687fef074ed40d 100644</span>
<span class="term-fg1">--- go-ethereum&#47;core&#47;rawdb&#47;databases_64bit.go</span>
<span class="term-fg1">+++ op-geth&#47;core&#47;rawdb&#47;databases_64bit.go</span>
<span class="term-fg36">@@ -23,7 +23,7 @@</span> 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;ethdb&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;ethdb&#47;pebble&quot;
 )
&nbsp;
<span class="term-fg31">-&#47;&#47; Pebble is unsuported on 32bit architecture</span>
<span class="term-fg32">+&#47;&#47; Pebble is unsupported on 32bit architecture</span>
 const PebbleEnabled = true
&nbsp;
 &#47;&#47; NewPebbleDBDatabase creates a persistent key-value database without a freezer</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-894ef2dedf9e6d9ef0bbfdb0" role="button"
                   aria-expanded="false" aria-controls="id-894ef2dedf9e6d9ef0bbfdb0">
                    <code>core/rawdb/freezer.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/3f40e65c484486dea6cff80b7db178985d21a2c6/core/rawdb/freezer.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/650bb2f2b1dcfe30d9b1fa6f7dc9608055ed60e1/core/rawdb/freezer.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+5</span></div>
                        <div class="text-start"><span class="text-danger">-1</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-894ef2dedf9e6d9ef0bbfdb0"><span class="term-fg1">diff --git go-ethereum&#47;core&#47;rawdb&#47;freezer.go op-geth&#47;core&#47;rawdb&#47;freezer.go</span>
<span class="term-fg1">index a9fe2343215a095cee658d85f11f1c591af88b5c..b7824ddc0d2c29aafe2a653442608ccfddfcc2f2 100644</span>
<span class="term-fg1">--- go-ethereum&#47;core&#47;rawdb&#47;freezer.go</span>
<span class="term-fg1">+++ op-geth&#47;core&#47;rawdb&#47;freezer.go</span>
<span class="term-fg36">@@ -108,7 +108,11 @@</span> 	}
 	&#47;&#47; Leveldb uses LOCK as the filelock filename. To prevent the
 	&#47;&#47; name collision, we use FLOCK as the lock name.
 	lock := flock.New(flockFile)
<span class="term-fg31">-	if locked, err := lock.TryLock(); err != nil {</span>
<span class="term-fg32">+	tryLock := lock.TryLock</span>
<span class="term-fg32">+	if readonly {</span>
<span class="term-fg32">+		tryLock = lock.TryRLock</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	if locked, err := tryLock(); err != nil {</span>
 		return nil, err
 	} else if !locked {
 		return nil, errors.New(&quot;locking failed&quot;)</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-bb625da5dee3556e9b45849c" role="button"
                   aria-expanded="false" aria-controls="id-bb625da5dee3556e9b45849c">
                    <code>core/rawdb/freezer_table.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/3f40e65c484486dea6cff80b7db178985d21a2c6/core/rawdb/freezer_table.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/650bb2f2b1dcfe30d9b1fa6f7dc9608055ed60e1/core/rawdb/freezer_table.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+6</span></div>
                        <div class="text-start"><span class="text-danger">-0</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-bb625da5dee3556e9b45849c"><span class="term-fg1">diff --git go-ethereum&#47;core&#47;rawdb&#47;freezer_table.go op-geth&#47;core&#47;rawdb&#47;freezer_table.go</span>
<span class="term-fg1">index fc6316c95395c0f1c7fc1fc43aa75e6ee02c8b38..cb32d61ae8a90ecc2e1f8bd0ac346c69214cad84 100644</span>
<span class="term-fg1">--- go-ethereum&#47;core&#47;rawdb&#47;freezer_table.go</span>
<span class="term-fg1">+++ op-geth&#47;core&#47;rawdb&#47;freezer_table.go</span>
<span class="term-fg36">@@ -212,6 +212,9 @@</span> 		}
 	}
 	&#47;&#47; Ensure the index is a multiple of indexEntrySize bytes
 	if overflow := stat.Size() % indexEntrySize; overflow != 0 {
<span class="term-fg32">+		if t.readonly {</span>
<span class="term-fg32">+			return fmt.Errorf(&quot;index file(path: %s, name: %s) size is not a multiple of %d&quot;, t.path, t.name, indexEntrySize)</span>
<span class="term-fg32">+		}</span>
 		truncateFreezerFile(t.index, stat.Size()-overflow) &#47;&#47; New file can&#39;t trigger this path
 	}
 	&#47;&#47; Retrieve the file sizes and prepare for truncation
<span class="term-fg36">@@ -270,6 +273,9 @@</span>
 	&#47;&#47; Keep truncating both files until they come in sync
 	contentExp = int64(lastIndex.offset)
 	for contentExp != contentSize {
<span class="term-fg32">+		if t.readonly {</span>
<span class="term-fg32">+			return fmt.Errorf(&quot;freezer table(path: %s, name: %s, num: %d) is corrupted&quot;, t.path, t.name, lastIndex.filenum)</span>
<span class="term-fg32">+		}</span>
 		verbose = true
 		&#47;&#47; Truncate the head file to the last offset pointer
 		if contentExp &lt; contentSize {</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-96e07c6f14c2b5de6e6d6fe1" role="button"
                   aria-expanded="false" aria-controls="id-96e07c6f14c2b5de6e6d6fe1">
                    <code>core/rawdb/freezer_test.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/3f40e65c484486dea6cff80b7db178985d21a2c6/core/rawdb/freezer_test.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/650bb2f2b1dcfe30d9b1fa6f7dc9608055ed60e1/core/rawdb/freezer_test.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+51</span></div>
                        <div class="text-start"><span class="text-danger">-0</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-96e07c6f14c2b5de6e6d6fe1"><span class="term-fg1">diff --git go-ethereum&#47;core&#47;rawdb&#47;freezer_test.go op-geth&#47;core&#47;rawdb&#47;freezer_test.go</span>
<span class="term-fg1">index 96d24cc9473b6e110ff55d5b9d133c5ffdc82164..b4bd6a382a867e20470a2aad43bb44129b03e229 100644</span>
<span class="term-fg1">--- go-ethereum&#47;core&#47;rawdb&#47;freezer_test.go</span>
<span class="term-fg1">+++ op-geth&#47;core&#47;rawdb&#47;freezer_test.go</span>
<span class="term-fg36">@@ -283,6 +283,57 @@</span> 		t.Fatal(&quot;readonly freezer should fail with differing table lengths&quot;)
 	}
 }
&nbsp;
<span class="term-fg32">+func TestFreezerConcurrentReadonly(t *testing.T) {</span>
<span class="term-fg32">+	t.Parallel()</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	tables := map[string]bool{&quot;a&quot;: true}</span>
<span class="term-fg32">+	dir := t.TempDir()</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	f, err := NewFreezer(dir, &quot;&quot;, false, 2049, tables)</span>
<span class="term-fg32">+	if err != nil {</span>
<span class="term-fg32">+		t.Fatal(&quot;can&#39;t open freezer&quot;, err)</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	var item = make([]byte, 1024)</span>
<span class="term-fg32">+	batch := f.tables[&quot;a&quot;].newBatch()</span>
<span class="term-fg32">+	items := uint64(10)</span>
<span class="term-fg32">+	for i := uint64(0); i &lt; items; i++ {</span>
<span class="term-fg32">+		require.NoError(t, batch.AppendRaw(i, item))</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	require.NoError(t, batch.commit())</span>
<span class="term-fg32">+	if loaded := f.tables[&quot;a&quot;].items.Load(); loaded != items {</span>
<span class="term-fg32">+		t.Fatalf(&quot;unexpected number of items in table, want: %d, have: %d&quot;, items, loaded)</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	require.NoError(t, f.Close())</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	var (</span>
<span class="term-fg32">+		wg   sync.WaitGroup</span>
<span class="term-fg32">+		fs   = make([]*Freezer, 5)</span>
<span class="term-fg32">+		errs = make([]error, 5)</span>
<span class="term-fg32">+	)</span>
<span class="term-fg32">+	for i := 0; i &lt; 5; i++ {</span>
<span class="term-fg32">+		wg.Add(1)</span>
<span class="term-fg32">+		go func(i int) {</span>
<span class="term-fg32">+			defer wg.Done()</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+			f, err := NewFreezer(dir, &quot;&quot;, true, 2049, tables)</span>
<span class="term-fg32">+			if err == nil {</span>
<span class="term-fg32">+				fs[i] = f</span>
<span class="term-fg32">+			} else {</span>
<span class="term-fg32">+				errs[i] = err</span>
<span class="term-fg32">+			}</span>
<span class="term-fg32">+		}(i)</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	wg.Wait()</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	for i := range fs {</span>
<span class="term-fg32">+		if err := errs[i]; err != nil {</span>
<span class="term-fg32">+			t.Fatal(&quot;failed to open freezer&quot;, err)</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+		require.NoError(t, fs[i].Close())</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
 func newFreezerForTesting(t *testing.T, tables map[string]bool) (*Freezer, string) {
 	t.Helper()
</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-5d2d5a36e9d967347ced8223" role="button"
                   aria-expanded="false" aria-controls="id-5d2d5a36e9d967347ced8223">
                    <code>core/rawdb/schema.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/3f40e65c484486dea6cff80b7db178985d21a2c6/core/rawdb/schema.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/650bb2f2b1dcfe30d9b1fa6f7dc9608055ed60e1/core/rawdb/schema.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+3</span></div>
                        <div class="text-start"><span class="text-danger">-0</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-5d2d5a36e9d967347ced8223"><span class="term-fg1">diff --git go-ethereum&#47;core&#47;rawdb&#47;schema.go op-geth&#47;core&#47;rawdb&#47;schema.go</span>
<span class="term-fg1">index 7269fe5d5653c854f0a88a392ad9b8995268a72d..8e82459e8225598b7a945a9bbeea75a88bd5c028 100644</span>
<span class="term-fg1">--- go-ethereum&#47;core&#47;rawdb&#47;schema.go</span>
<span class="term-fg1">+++ op-geth&#47;core&#47;rawdb&#47;schema.go</span>
<span class="term-fg36">@@ -91,6 +91,9 @@</span>
 	&#47;&#47; transitionStatusKey tracks the eth2 transition status.
 	transitionStatusKey = []byte(&quot;eth2-transition&quot;)
&nbsp;
<span class="term-fg32">+	&#47;&#47; snapSyncStatusFlagKey flags that status of snap sync.</span>
<span class="term-fg32">+	snapSyncStatusFlagKey = []byte(&quot;SnapSyncStatus&quot;)</span>
<span class="term-fg32">+</span>
 	&#47;&#47; Data item prefixes (use single byte to avoid mixing data types, avoid `i`, used for indexes).
 	headerPrefix       = []byte(&quot;h&quot;) &#47;&#47; headerPrefix + num (uint64 big endian) + hash -&gt; header
 	headerTDSuffix     = []byte(&quot;t&quot;) &#47;&#47; headerPrefix + num (uint64 big endian) + hash + headerTDSuffix -&gt; td</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-850bfd109f5195b7cbf62829" role="button"
                   aria-expanded="false" aria-controls="id-850bfd109f5195b7cbf62829">
                    <code>core/rawdb/table.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/3f40e65c484486dea6cff80b7db178985d21a2c6/core/rawdb/table.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/650bb2f2b1dcfe30d9b1fa6f7dc9608055ed60e1/core/rawdb/table.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+1</span></div>
                        <div class="text-start"><span class="text-danger">-1</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-850bfd109f5195b7cbf62829"><span class="term-fg1">diff --git go-ethereum&#47;core&#47;rawdb&#47;table.go op-geth&#47;core&#47;rawdb&#47;table.go</span>
<span class="term-fg1">index 1895f61da200c398d45f9793439196595563564d..19e4ed5b5c4b5deedc12286639e2ff3655782c0d 100644</span>
<span class="term-fg1">--- go-ethereum&#47;core&#47;rawdb&#47;table.go</span>
<span class="term-fg1">+++ op-geth&#47;core&#47;rawdb&#47;table.go</span>
<span class="term-fg36">@@ -219,7 +219,7 @@</span> func (b *tableBatch) Put(key, value []byte) error {
 	return b.batch.Put(append([]byte(b.prefix), key...), value)
 }
&nbsp;
<span class="term-fg31">-&#47;&#47; Delete inserts the a key removal into the batch for later committing.</span>
<span class="term-fg32">+&#47;&#47; Delete inserts a key removal into the batch for later committing.</span>
 func (b *tableBatch) Delete(key []byte) error {
 	return b.batch.Delete(append([]byte(b.prefix), key...))
 }</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-2e006c2a234191bd110e1a7a" role="button"
                   aria-expanded="false" aria-controls="id-2e006c2a234191bd110e1a7a">
                    <code>core/state/snapshot/conversion.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/3f40e65c484486dea6cff80b7db178985d21a2c6/core/state/snapshot/conversion.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/650bb2f2b1dcfe30d9b1fa6f7dc9608055ed60e1/core/state/snapshot/conversion.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+2</span></div>
                        <div class="text-start"><span class="text-danger">-2</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-2e006c2a234191bd110e1a7a"><span class="term-fg1">diff --git go-ethereum&#47;core&#47;state&#47;snapshot&#47;conversion.go op-geth&#47;core&#47;state&#47;snapshot&#47;conversion.go</span>
<span class="term-fg1">index 1e683f76ce04f5359c7022c0edc51349d3ef57f7..321bfbc6a2dc1165aeca05eacf101ae070da9432 100644</span>
<span class="term-fg1">--- go-ethereum&#47;core&#47;state&#47;snapshot&#47;conversion.go</span>
<span class="term-fg1">+++ op-geth&#47;core&#47;state&#47;snapshot&#47;conversion.go</span>
<span class="term-fg36">@@ -364,11 +364,11 @@</span>
 func stackTrieGenerate(db ethdb.KeyValueWriter, scheme string, owner common.Hash, in chan trieKV, out chan common.Hash) {
 	var nodeWriter trie.NodeWriteFunc
 	if db != nil {
<span class="term-fg31">-		nodeWriter = func(owner common.Hash, path []byte, hash common.Hash, blob []byte) {</span>
<span class="term-fg32">+		nodeWriter = func(path []byte, hash common.Hash, blob []byte) {</span>
 			rawdb.WriteTrieNode(db, owner, path, hash, blob, scheme)
 		}
 	}
<span class="term-fg31">-	t := trie.NewStackTrieWithOwner(nodeWriter, owner)</span>
<span class="term-fg32">+	t := trie.NewStackTrie(nodeWriter)</span>
 	for leaf := range in {
 		t.Update(leaf.key[:], leaf.value)
 	}</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-02a57936b79fe6ba01a70d80" role="button"
                   aria-expanded="false" aria-controls="id-02a57936b79fe6ba01a70d80">
                    <code>core/state/snapshot/generate.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/3f40e65c484486dea6cff80b7db178985d21a2c6/core/state/snapshot/generate.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/650bb2f2b1dcfe30d9b1fa6f7dc9608055ed60e1/core/state/snapshot/generate.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+4</span></div>
                        <div class="text-start"><span class="text-danger">-0</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-02a57936b79fe6ba01a70d80"><span class="term-fg1">diff --git go-ethereum&#47;core&#47;state&#47;snapshot&#47;generate.go op-geth&#47;core&#47;state&#47;snapshot&#47;generate.go</span>
<span class="term-fg1">index 40264b092cbb28987b5e491275bc7dfa91ee0dd8..f54debebed83d6f38788bad591f1542ee55eac2c 100644</span>
<span class="term-fg1">--- go-ethereum&#47;core&#47;state&#47;snapshot&#47;generate.go</span>
<span class="term-fg1">+++ op-geth&#47;core&#47;state&#47;snapshot&#47;generate.go</span>
<span class="term-fg36">@@ -446,6 +446,10 @@</span> 		}
 		internal += time.Since(istart)
 	}
 	if iter.Err != nil {
<span class="term-fg32">+		&#47;&#47; Trie errors should never happen. Still, in case of a bug, expose the</span>
<span class="term-fg32">+		&#47;&#47; error here, as the outer code will presume errors are interrupts, not</span>
<span class="term-fg32">+		&#47;&#47; some deeper issues.</span>
<span class="term-fg32">+		log.Error(&quot;State snapshotter failed to iterate trie&quot;, &quot;err&quot;, err)</span>
 		return false, nil, iter.Err
 	}
 	&#47;&#47; Delete all stale snapshot states remaining</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-7b60eea0a1b60ba72e30434b" role="button"
                   aria-expanded="false" aria-controls="id-7b60eea0a1b60ba72e30434b">
                    <code>core/state/statedb.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/3f40e65c484486dea6cff80b7db178985d21a2c6/core/state/statedb.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/650bb2f2b1dcfe30d9b1fa6f7dc9608055ed60e1/core/state/statedb.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+1</span></div>
                        <div class="text-start"><span class="text-danger">-1</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-7b60eea0a1b60ba72e30434b"><span class="term-fg1">diff --git go-ethereum&#47;core&#47;state&#47;statedb.go op-geth&#47;core&#47;state&#47;statedb.go</span>
<span class="term-fg1">index a59de16a70fd0241d479b1fec6cff93edee5a1ed..d28cd29b309a8ba8c404ed1a9eff612cecc36ad5 100644</span>
<span class="term-fg1">--- go-ethereum&#47;core&#47;state&#47;statedb.go</span>
<span class="term-fg1">+++ op-geth&#47;core&#47;state&#47;statedb.go</span>
<span class="term-fg36">@@ -964,7 +964,7 @@</span> 		size  common.StorageSize
 		nodes = trienode.NewNodeSet(addrHash)
 		slots = make(map[common.Hash][]byte)
 	)
<span class="term-fg31">-	stack := trie.NewStackTrie(func(owner common.Hash, path []byte, hash common.Hash, blob []byte) {</span>
<span class="term-fg32">+	stack := trie.NewStackTrie(func(path []byte, hash common.Hash, blob []byte) {</span>
 		nodes.AddNode(path, trienode.NewDeleted())
 		size += common.StorageSize(len(path))
 	})</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-1e10568e1abe8c5dfc3f5e30" role="button"
                   aria-expanded="false" aria-controls="id-1e10568e1abe8c5dfc3f5e30">
                    <code>core/state/trie_prefetcher.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/3f40e65c484486dea6cff80b7db178985d21a2c6/core/state/trie_prefetcher.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/650bb2f2b1dcfe30d9b1fa6f7dc9608055ed60e1/core/state/trie_prefetcher.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+5</span></div>
                        <div class="text-start"><span class="text-danger">-2</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-1e10568e1abe8c5dfc3f5e30"><span class="term-fg1">diff --git go-ethereum&#47;core&#47;state&#47;trie_prefetcher.go op-geth&#47;core&#47;state&#47;trie_prefetcher.go</span>
<span class="term-fg1">index 4e8fd1e10f576bdf3a8c3ea7847661f1cded7ffd..772c698dd0e1ef21370855f68ef16676c60c6786 100644</span>
<span class="term-fg1">--- go-ethereum&#47;core&#47;state&#47;trie_prefetcher.go</span>
<span class="term-fg1">+++ op-geth&#47;core&#47;state&#47;trie_prefetcher.go</span>
<span class="term-fg36">@@ -37,7 +37,7 @@</span> &#47;&#47; Note, the prefetcher&#39;s API is not thread safe.
 type triePrefetcher struct {
 	db       Database               &#47;&#47; Database to fetch trie nodes through
 	root     common.Hash            &#47;&#47; Root hash of the account trie for metrics
<span class="term-fg31">-	fetches  map[string]Trie        &#47;&#47; Partially or fully fetcher tries</span>
<span class="term-fg32">+	fetches  map[string]Trie        &#47;&#47; Partially or fully fetched tries. Only populated for inactive copies.</span>
 	fetchers map[string]*subfetcher &#47;&#47; Subfetchers for each trie
&nbsp;
 	deliveryMissMeter metrics.Meter
<span class="term-fg36">@@ -197,7 +197,10 @@</span> }
&nbsp;
 &#47;&#47; trieID returns an unique trie identifier consists the trie owner and root hash.
 func (p *triePrefetcher) trieID(owner common.Hash, root common.Hash) string {
<span class="term-fg31">-	return string(append(owner.Bytes(), root.Bytes()...))</span>
<span class="term-fg32">+	trieID := make([]byte, common.HashLength*2)</span>
<span class="term-fg32">+	copy(trieID, owner.Bytes())</span>
<span class="term-fg32">+	copy(trieID[common.HashLength:], root.Bytes())</span>
<span class="term-fg32">+	return string(trieID)</span>
 }
&nbsp;
 &#47;&#47; subfetcher is a trie fetcher goroutine responsible for pulling entries for a</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-0b4a2fa9c9bdd10f6fb711bf" role="button"
                   aria-expanded="false" aria-controls="id-0b4a2fa9c9bdd10f6fb711bf">
                    <code>core/superchain_test.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <span class="text-muted">(new)</span>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/650bb2f2b1dcfe30d9b1fa6f7dc9608055ed60e1/core/superchain_test.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+54</span></div>
                        <div class="text-start"><span class="text-danger">-0</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-0b4a2fa9c9bdd10f6fb711bf"><span class="term-fg1">diff --git go-ethereum&#47;core&#47;superchain_test.go op-geth&#47;core&#47;superchain_test.go</span>
<span class="term-fg1">new file mode 100644</span>
<span class="term-fg1">index 0000000000000000000000000000000000000000..9959374bddc1e87dd95e5995811054c581068d71</span>
<span class="term-fg1">--- &#47;dev&#47;null</span>
<span class="term-fg1">+++ op-geth&#47;core&#47;superchain_test.go</span>
<span class="term-fg36">@@ -0,0 +1,54 @@</span>
<span class="term-fg32">+package core</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+import (</span>
<span class="term-fg32">+	&quot;testing&quot;</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	&quot;github.com&#47;ethereum-optimism&#47;superchain-registry&#47;superchain&quot;</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;core&#47;rawdb&quot;</span>
<span class="term-fg32">+	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;trie&quot;</span>
<span class="term-fg32">+)</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func TestOPStackGenesis(t *testing.T) {</span>
<span class="term-fg32">+	for id := range superchain.OPChains {</span>
<span class="term-fg32">+		gen, err := LoadOPStackGenesis(id)</span>
<span class="term-fg32">+		if err != nil {</span>
<span class="term-fg32">+			t.Fatal(err)</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+		t.Logf(&quot;chain: %d, genesis block hash: %s&quot;, id, gen.ToBlock().Hash())</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func TestRegistryChainConfigOverride(t *testing.T) {</span>
<span class="term-fg32">+	db := rawdb.NewMemoryDatabase()</span>
<span class="term-fg32">+	genesis, err := LoadOPStackGenesis(10)</span>
<span class="term-fg32">+	if err != nil {</span>
<span class="term-fg32">+		t.Fatal(err)</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	if genesis.Config.RegolithTime == nil {</span>
<span class="term-fg32">+		t.Fatal(&quot;expected non-nil regolith time&quot;)</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	expectedRegolithTime := *genesis.Config.RegolithTime</span>
<span class="term-fg32">+	genesis.Config.RegolithTime = nil</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	&#47;&#47; initialize the DB</span>
<span class="term-fg32">+	tdb := trie.NewDatabase(db, newDbConfig(rawdb.PathScheme))</span>
<span class="term-fg32">+	genesis.MustCommit(db, tdb)</span>
<span class="term-fg32">+	bl := genesis.ToBlock()</span>
<span class="term-fg32">+	rawdb.WriteCanonicalHash(db, bl.Hash(), 0)</span>
<span class="term-fg32">+	rawdb.WriteBlock(db, bl)</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	&#47;&#47; create chain config, even with incomplete genesis input: the chain config should be corrected</span>
<span class="term-fg32">+	chainConfig, _, err := SetupGenesisBlockWithOverride(db, tdb, genesis, &amp;ChainOverrides{</span>
<span class="term-fg32">+		ApplySuperchainUpgrades: true,</span>
<span class="term-fg32">+	})</span>
<span class="term-fg32">+	if err != nil {</span>
<span class="term-fg32">+		t.Fatal(err)</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	&#47;&#47; check if we have a corrected chain config</span>
<span class="term-fg32">+	if chainConfig.RegolithTime == nil {</span>
<span class="term-fg32">+		t.Fatal(&quot;expected regolith time to be corrected, but time is still nil&quot;)</span>
<span class="term-fg32">+	} else if *chainConfig.RegolithTime != expectedRegolithTime {</span>
<span class="term-fg32">+		t.Fatalf(&quot;expected regolith time to be %d, but got %d&quot;, expectedRegolithTime, *chainConfig.RegolithTime)</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+}</span></div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-c37eefec36e9237a1f005e5c" role="button"
                   aria-expanded="false" aria-controls="id-c37eefec36e9237a1f005e5c">
                    <code>core/txpool/blobpool/blobpool.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/3f40e65c484486dea6cff80b7db178985d21a2c6/core/txpool/blobpool/blobpool.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/650bb2f2b1dcfe30d9b1fa6f7dc9608055ed60e1/core/txpool/blobpool/blobpool.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+46</span></div>
                        <div class="text-start"><span class="text-danger">-15</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-c37eefec36e9237a1f005e5c"><span class="term-fg1">diff --git go-ethereum&#47;core&#47;txpool&#47;blobpool&#47;blobpool.go op-geth&#47;core&#47;txpool&#47;blobpool&#47;blobpool.go</span>
<span class="term-fg1">index 042ff3be20aad21dc5106be5155d879cc59992f1..32c6c0e8feeff9db0bf2ebaedb9869decc82b336 100644</span>
<span class="term-fg1">--- go-ethereum&#47;core&#47;txpool&#47;blobpool&#47;blobpool.go</span>
<span class="term-fg1">+++ op-geth&#47;core&#47;txpool&#47;blobpool&#47;blobpool.go</span>
<span class="term-fg36">@@ -97,6 +97,8 @@</span> 	costCap    *uint256.Int &#47;&#47; Needed to validate cumulative balance sufficiency
 	execTipCap *uint256.Int &#47;&#47; Needed to prioritize inclusion order across accounts and validate replacement price bump
 	execFeeCap *uint256.Int &#47;&#47; Needed to validate replacement price bump
 	blobFeeCap *uint256.Int &#47;&#47; Needed to validate replacement price bump
<span class="term-fg32">+	execGas    uint64       &#47;&#47; Needed to check inclusion validity before reading the blob</span>
<span class="term-fg32">+	blobGas    uint64       &#47;&#47; Needed to check inclusion validity before reading the blob</span>
&nbsp;
 	basefeeJumps float64 &#47;&#47; Absolute number of 1559 fee adjustments needed to reach the tx&#39;s fee cap
 	blobfeeJumps float64 &#47;&#47; Absolute number of 4844 fee adjustments needed to reach the tx&#39;s blob fee cap
<span class="term-fg36">@@ -118,6 +120,8 @@</span> 		costCap:    uint256.MustFromBig(tx.Cost()),
 		execTipCap: uint256.MustFromBig(tx.GasTipCap()),
 		execFeeCap: uint256.MustFromBig(tx.GasFeeCap()),
 		blobFeeCap: uint256.MustFromBig(tx.BlobGasFeeCap()),
<span class="term-fg32">+		execGas:    tx.Gas(),</span>
<span class="term-fg32">+		blobGas:    tx.BlobGas(),</span>
 	}
 	meta.basefeeJumps = dynamicFeeJumps(meta.execFeeCap)
 	meta.blobfeeJumps = dynamicFeeJumps(meta.blobFeeCap)
<span class="term-fg36">@@ -307,8 +311,8 @@</span> 	index  map[common.Address][]*blobTxMeta &#47;&#47; Blob transactions grouped by accounts, sorted by nonce
 	spent  map[common.Address]*uint256.Int  &#47;&#47; Expenditure tracking for individual accounts
 	evict  *evictHeap                       &#47;&#47; Heap of cheapest accounts for eviction when full
&nbsp;
<span class="term-fg31">-	eventFeed  event.Feed              &#47;&#47; Event feed to send out new tx events on pool inclusion</span>
<span class="term-fg31">-	eventScope event.SubscriptionScope &#47;&#47; Event scope to track and mass unsubscribe on termination</span>
<span class="term-fg32">+	discoverFeed event.Feed &#47;&#47; Event feed to send out new tx events on pool discovery (reorg excluded)</span>
<span class="term-fg32">+	insertFeed   event.Feed &#47;&#47; Event feed to send out new tx events on pool inclusion (reorg included)</span>
&nbsp;
 	lock sync.RWMutex &#47;&#47; Mutex protecting the pool during reorg handling
 }
<span class="term-fg36">@@ -355,7 +359,13 @@</span> 		if err := os.MkdirAll(limbodir, 0700); err != nil {
 			return err
 		}
 	}
<span class="term-fg32">+	&#47;&#47; Initialize the state with head block, or fallback to empty one in</span>
<span class="term-fg32">+	&#47;&#47; case the head state is not available(might occur when node is not</span>
<span class="term-fg32">+	&#47;&#47; fully synced).</span>
 	state, err := p.chain.StateAt(head.Root)
<span class="term-fg32">+	if err != nil {</span>
<span class="term-fg32">+		state, err = p.chain.StateAt(types.EmptyRootHash)</span>
<span class="term-fg32">+	}</span>
 	if err != nil {
 		return err
 	}
<span class="term-fg36">@@ -430,8 +440,6 @@</span> 	}
 	if err := p.store.Close(); err != nil {
 		errs = append(errs, err)
 	}
<span class="term-fg31">-	p.eventScope.Close()</span>
<span class="term-fg31">-</span>
 	switch {
 	case errs == nil:
 		return nil
<span class="term-fg36">@@ -752,14 +760,20 @@</span>
 	&#47;&#47; Run the reorg between the old and new head and figure out which accounts
 	&#47;&#47; need to be rechecked and which transactions need to be readded
 	if reinject, inclusions := p.reorg(oldHead, newHead); reinject != nil {
<span class="term-fg32">+		var adds []*types.Transaction</span>
 		for addr, txs := range reinject {
 			&#47;&#47; Blindly push all the lost transactions back into the pool
 			for _, tx := range txs {
<span class="term-fg31">-				p.reinject(addr, tx.Hash())</span>
<span class="term-fg32">+				if err := p.reinject(addr, tx.Hash()); err == nil {</span>
<span class="term-fg32">+					adds = append(adds, tx.WithoutBlobTxSidecar())</span>
<span class="term-fg32">+				}</span>
 			}
 			&#47;&#47; Recheck the account&#39;s pooled transactions to drop included and
 			&#47;&#47; invalidated one
 			p.recheck(addr, inclusions)
<span class="term-fg32">+		}</span>
<span class="term-fg32">+		if len(adds) &gt; 0 {</span>
<span class="term-fg32">+			p.insertFeed.Send(core.NewTxsEvent{Txs: adds})</span>
 		}
 	}
 	&#47;&#47; Flush out any blobs from limbo that are older than the latest finality
<span class="term-fg36">@@ -915,13 +929,13 @@</span> &#47;&#47;
 &#47;&#47; Note, the method will not initialize the eviction cache values as those will
 &#47;&#47; be done once for all transactions belonging to an account after all individual
 &#47;&#47; transactions are injected back into the pool.
<span class="term-fg31">-func (p *BlobPool) reinject(addr common.Address, txhash common.Hash) {</span>
<span class="term-fg32">+func (p *BlobPool) reinject(addr common.Address, txhash common.Hash) error {</span>
 	&#47;&#47; Retrieve the associated blob from the limbo. Without the blobs, we cannot
 	&#47;&#47; add the transaction back into the pool as it is not mineable.
 	tx, err := p.limbo.pull(txhash)
 	if err != nil {
 		log.Error(&quot;Blobs unavailable, dropping reorged tx&quot;, &quot;err&quot;, err)
<span class="term-fg31">-		return</span>
<span class="term-fg32">+		return err</span>
 	}
 	&#47;&#47; TODO: seems like an easy optimization here would be getting the serialized tx
 	&#47;&#47; from limbo instead of re-serializing it here.
<span class="term-fg36">@@ -930,12 +944,12 @@</span> 	&#47;&#47; Serialize the transaction back into the primary datastore.
 	blob, err := rlp.EncodeToBytes(tx)
 	if err != nil {
 		log.Error(&quot;Failed to encode transaction for storage&quot;, &quot;hash&quot;, tx.Hash(), &quot;err&quot;, err)
<span class="term-fg31">-		return</span>
<span class="term-fg32">+		return err</span>
 	}
 	id, err := p.store.Put(blob)
 	if err != nil {
 		log.Error(&quot;Failed to write transaction into storage&quot;, &quot;hash&quot;, tx.Hash(), &quot;err&quot;, err)
<span class="term-fg31">-		return</span>
<span class="term-fg32">+		return err</span>
 	}
&nbsp;
 	&#47;&#47; Update the indixes and metrics
<span class="term-fg36">@@ -943,7 +957,7 @@</span> 	meta := newBlobTxMeta(id, p.store.Size(id), tx)
 	if _, ok := p.index[addr]; !ok {
 		if err := p.reserve(addr, true); err != nil {
 			log.Warn(&quot;Failed to reserve account for blob pool&quot;, &quot;tx&quot;, tx.Hash(), &quot;from&quot;, addr, &quot;err&quot;, err)
<span class="term-fg31">-			return</span>
<span class="term-fg32">+			return err</span>
 		}
 		p.index[addr] = []*blobTxMeta{meta}
 		p.spent[addr] = meta.costCap
<span class="term-fg36">@@ -954,6 +968,7 @@</span> 		p.spent[addr] = new(uint256.Int).Add(p.spent[addr], meta.costCap)
 	}
 	p.lookup[meta.hash] = meta.id
 	p.stored += uint64(meta.size)
<span class="term-fg32">+	return nil</span>
 }
&nbsp;
 &#47;&#47; SetGasTip implements txpool.SubPool, allowing the blob pool&#39;s gas requirements
<span class="term-fg36">@@ -1148,9 +1163,19 @@</span>
 &#47;&#47; Add inserts a set of blob transactions into the pool if they pass validation (both
 &#47;&#47; consensus validity and pool restictions).
 func (p *BlobPool) Add(txs []*types.Transaction, local bool, sync bool) []error {
<span class="term-fg31">-	errs := make([]error, len(txs))</span>
<span class="term-fg32">+	var (</span>
<span class="term-fg32">+		adds = make([]*types.Transaction, 0, len(txs))</span>
<span class="term-fg32">+		errs = make([]error, len(txs))</span>
<span class="term-fg32">+	)</span>
 	for i, tx := range txs {
 		errs[i] = p.add(tx)
<span class="term-fg32">+		if errs[i] == nil {</span>
<span class="term-fg32">+			adds = append(adds, tx.WithoutBlobTxSidecar())</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	if len(adds) &gt; 0 {</span>
<span class="term-fg32">+		p.discoverFeed.Send(core.NewTxsEvent{Txs: adds})</span>
<span class="term-fg32">+		p.insertFeed.Send(core.NewTxsEvent{Txs: adds})</span>
 	}
 	return errs
 }
<span class="term-fg36">@@ -1378,6 +1403,8 @@</span> 				Hash:      tx.hash,
 				Time:      time.Now(), &#47;&#47; TODO(karalabe): Maybe save these and use that?
 				GasFeeCap: tx.execFeeCap.ToBig(),
 				GasTipCap: tx.execTipCap.ToBig(),
<span class="term-fg32">+				Gas:       tx.execGas,</span>
<span class="term-fg32">+				BlobGas:   tx.blobGas,</span>
 			})
 		}
 		if len(lazies) &gt; 0 {
<span class="term-fg36">@@ -1462,10 +1489,14 @@</span> 	limboDatarealGauge.Update(int64(datareal))
 	limboSlotusedGauge.Update(int64(slotused))
 }
&nbsp;
<span class="term-fg31">-&#47;&#47; SubscribeTransactions registers a subscription of NewTxsEvent and</span>
<span class="term-fg31">-&#47;&#47; starts sending event to the given channel.</span>
<span class="term-fg31">-func (p *BlobPool) SubscribeTransactions(ch chan&lt;- core.NewTxsEvent) event.Subscription {</span>
<span class="term-fg31">-	return p.eventScope.Track(p.eventFeed.Subscribe(ch))</span>
<span class="term-fg32">+&#47;&#47; SubscribeTransactions registers a subscription for new transaction events,</span>
<span class="term-fg32">+&#47;&#47; supporting feeding only newly seen or also resurrected transactions.</span>
<span class="term-fg32">+func (p *BlobPool) SubscribeTransactions(ch chan&lt;- core.NewTxsEvent, reorgs bool) event.Subscription {</span>
<span class="term-fg32">+	if reorgs {</span>
<span class="term-fg32">+		return p.insertFeed.Subscribe(ch)</span>
<span class="term-fg32">+	} else {</span>
<span class="term-fg32">+		return p.discoverFeed.Subscribe(ch)</span>
<span class="term-fg32">+	}</span>
 }
&nbsp;
 &#47;&#47; Nonce returns the next nonce of an account, with all transactions executable</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-ed37404e01bf38f77d2a58f2" role="button"
                   aria-expanded="false" aria-controls="id-ed37404e01bf38f77d2a58f2">
                    <code>core/txpool/blobpool/evictheap.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/3f40e65c484486dea6cff80b7db178985d21a2c6/core/txpool/blobpool/evictheap.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/650bb2f2b1dcfe30d9b1fa6f7dc9608055ed60e1/core/txpool/blobpool/evictheap.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+1</span></div>
                        <div class="text-start"><span class="text-danger">-1</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-ed37404e01bf38f77d2a58f2"><span class="term-fg1">diff --git go-ethereum&#47;core&#47;txpool&#47;blobpool&#47;evictheap.go op-geth&#47;core&#47;txpool&#47;blobpool&#47;evictheap.go</span>
<span class="term-fg1">index 7607a911c15bf1540ec4eb0d2f0e49d3175a5d1d..df594099f79b655ac9785f2dac6750d3909f98b1 100644</span>
<span class="term-fg1">--- go-ethereum&#47;core&#47;txpool&#47;blobpool&#47;evictheap.go</span>
<span class="term-fg1">+++ op-geth&#47;core&#47;txpool&#47;blobpool&#47;evictheap.go</span>
<span class="term-fg36">@@ -44,7 +44,7 @@</span> 	addrs []common.Address       &#47;&#47; Heap of addresses to retrieve the cheapest out of
 	index map[common.Address]int &#47;&#47; Indices into the heap for replacements
 }
&nbsp;
<span class="term-fg31">-&#47;&#47; newPriceHeap creates a new heap of cheapets accounts in the blob pool to evict</span>
<span class="term-fg32">+&#47;&#47; newPriceHeap creates a new heap of cheapest accounts in the blob pool to evict</span>
 &#47;&#47; from in case of over saturation.
 func newPriceHeap(basefee *uint256.Int, blobfee *uint256.Int, index *map[common.Address][]*blobTxMeta) *evictHeap {
 	heap := &amp;evictHeap{</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-231d1f048961a2229b49be19" role="button"
                   aria-expanded="false" aria-controls="id-231d1f048961a2229b49be19">
                    <code>core/txpool/blobpool/limbo.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/3f40e65c484486dea6cff80b7db178985d21a2c6/core/txpool/blobpool/limbo.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/650bb2f2b1dcfe30d9b1fa6f7dc9608055ed60e1/core/txpool/blobpool/limbo.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+2</span></div>
                        <div class="text-start"><span class="text-danger">-2</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-231d1f048961a2229b49be19"><span class="term-fg1">diff --git go-ethereum&#47;core&#47;txpool&#47;blobpool&#47;limbo.go op-geth&#47;core&#47;txpool&#47;blobpool&#47;limbo.go</span>
<span class="term-fg1">index 2d62593de6887dff6fe970226dc9f1bf2fe70894..d1fe9c739477bce660141673d86dde1e896ddecc 100644</span>
<span class="term-fg1">--- go-ethereum&#47;core&#47;txpool&#47;blobpool&#47;limbo.go</span>
<span class="term-fg1">+++ op-geth&#47;core&#47;txpool&#47;blobpool&#47;limbo.go</span>
<span class="term-fg36">@@ -143,7 +143,7 @@</span> 		log.Error(&quot;Limbo cannot push already tracked blobs&quot;, &quot;tx&quot;, tx)
 		return errors.New(&quot;already tracked blob transaction&quot;)
 	}
 	if err := l.setAndIndex(tx, block); err != nil {
<span class="term-fg31">-		log.Error(&quot;Failed to set and index liboed blobs&quot;, &quot;tx&quot;, tx, &quot;err&quot;, err)</span>
<span class="term-fg32">+		log.Error(&quot;Failed to set and index limboed blobs&quot;, &quot;tx&quot;, tx, &quot;err&quot;, err)</span>
 		return err
 	}
 	return nil
<span class="term-fg36">@@ -191,7 +191,7 @@</span> 	if _, ok := l.groups[block][id]; ok {
 		log.Trace(&quot;Blob transaction unchanged in limbo&quot;, &quot;tx&quot;, txhash, &quot;block&quot;, block)
 		return
 	}
<span class="term-fg31">-	&#47;&#47; Retrieve the old blobs from the data store and write tehm back with a new</span>
<span class="term-fg32">+	&#47;&#47; Retrieve the old blobs from the data store and write them back with a new</span>
 	&#47;&#47; block number. IF anything fails, there&#39;s not much to do, go on.
 	item, err := l.getAndDrop(id)
 	if err != nil {</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-c771dd3464a7471ccd9d92f2" role="button"
                   aria-expanded="false" aria-controls="id-c771dd3464a7471ccd9d92f2">
                    <code>core/txpool/blobpool/priority.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/3f40e65c484486dea6cff80b7db178985d21a2c6/core/txpool/blobpool/priority.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/650bb2f2b1dcfe30d9b1fa6f7dc9608055ed60e1/core/txpool/blobpool/priority.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+1</span></div>
                        <div class="text-start"><span class="text-danger">-1</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-c771dd3464a7471ccd9d92f2"><span class="term-fg1">diff --git go-ethereum&#47;core&#47;txpool&#47;blobpool&#47;priority.go op-geth&#47;core&#47;txpool&#47;blobpool&#47;priority.go</span>
<span class="term-fg1">index 18e545c2a876156b186089cafc8bab61cf82fa76..a8332bd9b0e6680eb38465b4bec73fe6b4d02303 100644</span>
<span class="term-fg1">--- go-ethereum&#47;core&#47;txpool&#47;blobpool&#47;priority.go</span>
<span class="term-fg1">+++ op-geth&#47;core&#47;txpool&#47;blobpool&#47;priority.go</span>
<span class="term-fg36">@@ -27,7 +27,7 @@</span> &#47;&#47; log2_1_125 is used in the eviction priority calculation.
 var log2_1_125 = math.Log2(1.125)
&nbsp;
 &#47;&#47; evictionPriority calculates the eviction priority based on the algorithm
<span class="term-fg31">-&#47;&#47; described in the BlobPool docs for a both fee components.</span>
<span class="term-fg32">+&#47;&#47; described in the BlobPool docs for both fee components.</span>
 &#47;&#47;
 &#47;&#47; This method takes about 8ns on a very recent laptop CPU, recalculating about
 &#47;&#47; 125 million transaction priority values per second.</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-c9040ccb9863857f3ef3d2bb" role="button"
                   aria-expanded="false" aria-controls="id-c9040ccb9863857f3ef3d2bb">
                    <code>core/types/hashing.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/3f40e65c484486dea6cff80b7db178985d21a2c6/core/types/hashing.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/650bb2f2b1dcfe30d9b1fa6f7dc9608055ed60e1/core/types/hashing.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+1</span></div>
                        <div class="text-start"><span class="text-danger">-1</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-c9040ccb9863857f3ef3d2bb"><span class="term-fg1">diff --git go-ethereum&#47;core&#47;types&#47;hashing.go op-geth&#47;core&#47;types&#47;hashing.go</span>
<span class="term-fg1">index 9a6a80ac527c82814ba4abdd061ecc1b760a6df5..224d7a87eafcb5bd8e45a0bfc4eda07aa997f815 100644</span>
<span class="term-fg1">--- go-ethereum&#47;core&#47;types&#47;hashing.go</span>
<span class="term-fg1">+++ op-geth&#47;core&#47;types&#47;hashing.go</span>
<span class="term-fg36">@@ -95,7 +95,7 @@</span>
 func encodeForDerive(list DerivableList, i int, buf *bytes.Buffer) []byte {
 	buf.Reset()
 	list.EncodeIndex(i, buf)
<span class="term-fg31">-	&#47;&#47; It&#39;s really unfortunate that we need to do perform this copy.</span>
<span class="term-fg32">+	&#47;&#47; It&#39;s really unfortunate that we need to perform this copy.</span>
 	&#47;&#47; StackTrie holds onto the values until Hash is called, so the values
 	&#47;&#47; written to it must not alias.
 	return common.CopyBytes(buf.Bytes())</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-07585bd532fd2d501a66de8d" role="button"
                   aria-expanded="false" aria-controls="id-07585bd532fd2d501a66de8d">
                    <code>core/types/receipt_test.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/3f40e65c484486dea6cff80b7db178985d21a2c6/core/types/receipt_test.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/650bb2f2b1dcfe30d9b1fa6f7dc9608055ed60e1/core/types/receipt_test.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+401</span></div>
                        <div class="text-start"><span class="text-danger">-4</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-07585bd532fd2d501a66de8d"><span class="term-fg1">diff --git go-ethereum&#47;core&#47;types&#47;receipt_test.go op-geth&#47;core&#47;types&#47;receipt_test.go</span>
<span class="term-fg1">index a7b26444712fe8c669ea732fa423588a58497f32..2af06050c4452ac2a16e5e6d340160bfb39c4a12 100644</span>
<span class="term-fg1">--- go-ethereum&#47;core&#47;types&#47;receipt_test.go</span>
<span class="term-fg1">+++ op-geth&#47;core&#47;types&#47;receipt_test.go</span>
<span class="term-fg36">@@ -19,6 +19,7 @@</span>
 import (
 	&quot;bytes&quot;
 	&quot;encoding&#47;json&quot;
<span class="term-fg32">+	&quot;fmt&quot;</span>
 	&quot;math&quot;
 	&quot;math&#47;big&quot;
 	&quot;reflect&quot;
<span class="term-fg36">@@ -29,6 +30,7 @@</span> 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;params&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;rlp&quot;
 	&quot;github.com&#47;holiman&#47;uint256&quot;
 	&quot;github.com&#47;kylelemons&#47;godebug&#47;diff&quot;
<span class="term-fg32">+	&quot;github.com&#47;stretchr&#47;testify&#47;require&quot;</span>
 )
&nbsp;
 var (
<span class="term-fg36">@@ -82,6 +84,63 @@</span> 			},
 		},
 		Type: DynamicFeeTxType,
 	}
<span class="term-fg32">+	depositReceiptNoNonce = &amp;Receipt{</span>
<span class="term-fg32">+		Status:            ReceiptStatusFailed,</span>
<span class="term-fg32">+		CumulativeGasUsed: 1,</span>
<span class="term-fg32">+		Logs: []*Log{</span>
<span class="term-fg32">+			{</span>
<span class="term-fg32">+				Address: common.BytesToAddress([]byte{0x11}),</span>
<span class="term-fg32">+				Topics:  []common.Hash{common.HexToHash(&quot;dead&quot;), common.HexToHash(&quot;beef&quot;)},</span>
<span class="term-fg32">+				Data:    []byte{0x01, 0x00, 0xff},</span>
<span class="term-fg32">+			},</span>
<span class="term-fg32">+			{</span>
<span class="term-fg32">+				Address: common.BytesToAddress([]byte{0x01, 0x11}),</span>
<span class="term-fg32">+				Topics:  []common.Hash{common.HexToHash(&quot;dead&quot;), common.HexToHash(&quot;beef&quot;)},</span>
<span class="term-fg32">+				Data:    []byte{0x01, 0x00, 0xff},</span>
<span class="term-fg32">+			},</span>
<span class="term-fg32">+		},</span>
<span class="term-fg32">+		Type: DepositTxType,</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	nonce                   = uint64(1234)</span>
<span class="term-fg32">+	depositReceiptWithNonce = &amp;Receipt{</span>
<span class="term-fg32">+		Status:                ReceiptStatusFailed,</span>
<span class="term-fg32">+		CumulativeGasUsed:     1,</span>
<span class="term-fg32">+		DepositNonce:          &amp;nonce,</span>
<span class="term-fg32">+		DepositReceiptVersion: nil,</span>
<span class="term-fg32">+		Logs: []*Log{</span>
<span class="term-fg32">+			{</span>
<span class="term-fg32">+				Address: common.BytesToAddress([]byte{0x11}),</span>
<span class="term-fg32">+				Topics:  []common.Hash{common.HexToHash(&quot;dead&quot;), common.HexToHash(&quot;beef&quot;)},</span>
<span class="term-fg32">+				Data:    []byte{0x01, 0x00, 0xff},</span>
<span class="term-fg32">+			},</span>
<span class="term-fg32">+			{</span>
<span class="term-fg32">+				Address: common.BytesToAddress([]byte{0x01, 0x11}),</span>
<span class="term-fg32">+				Topics:  []common.Hash{common.HexToHash(&quot;dead&quot;), common.HexToHash(&quot;beef&quot;)},</span>
<span class="term-fg32">+				Data:    []byte{0x01, 0x00, 0xff},</span>
<span class="term-fg32">+			},</span>
<span class="term-fg32">+		},</span>
<span class="term-fg32">+		Type: DepositTxType,</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	version                           = CanyonDepositReceiptVersion</span>
<span class="term-fg32">+	depositReceiptWithNonceAndVersion = &amp;Receipt{</span>
<span class="term-fg32">+		Status:                ReceiptStatusFailed,</span>
<span class="term-fg32">+		CumulativeGasUsed:     1,</span>
<span class="term-fg32">+		DepositNonce:          &amp;nonce,</span>
<span class="term-fg32">+		DepositReceiptVersion: &amp;version,</span>
<span class="term-fg32">+		Logs: []*Log{</span>
<span class="term-fg32">+			{</span>
<span class="term-fg32">+				Address: common.BytesToAddress([]byte{0x11}),</span>
<span class="term-fg32">+				Topics:  []common.Hash{common.HexToHash(&quot;dead&quot;), common.HexToHash(&quot;beef&quot;)},</span>
<span class="term-fg32">+				Data:    []byte{0x01, 0x00, 0xff},</span>
<span class="term-fg32">+			},</span>
<span class="term-fg32">+			{</span>
<span class="term-fg32">+				Address: common.BytesToAddress([]byte{0x01, 0x11}),</span>
<span class="term-fg32">+				Topics:  []common.Hash{common.HexToHash(&quot;dead&quot;), common.HexToHash(&quot;beef&quot;)},</span>
<span class="term-fg32">+				Data:    []byte{0x01, 0x00, 0xff},</span>
<span class="term-fg32">+			},</span>
<span class="term-fg32">+		},</span>
<span class="term-fg32">+		Type: DepositTxType,</span>
<span class="term-fg32">+	}</span>
&nbsp;
 	&#47;&#47; Create a few transactions to have receipts for
 	to2 = common.HexToAddress(&quot;0x2&quot;)
<span class="term-fg36">@@ -149,11 +208,23 @@</span> 			GasFeeCap:  uint256.NewInt(1077),
 			BlobFeeCap: uint256.NewInt(100077),
 			BlobHashes: []common.Hash{{}, {}, {}},
 		}),
<span class="term-fg32">+		NewTx(&amp;DepositTx{</span>
<span class="term-fg32">+			To:    nil, &#47;&#47; contract creation</span>
<span class="term-fg32">+			Value: big.NewInt(6),</span>
<span class="term-fg32">+			Gas:   50,</span>
<span class="term-fg32">+		}),</span>
<span class="term-fg32">+		NewTx(&amp;DepositTx{</span>
<span class="term-fg32">+			To:    nil, &#47;&#47; contract creation</span>
<span class="term-fg32">+			Value: big.NewInt(6),</span>
<span class="term-fg32">+			Gas:   60,</span>
<span class="term-fg32">+		}),</span>
 	}
<span class="term-fg31">-</span>
<span class="term-fg31">-	blockNumber = big.NewInt(1)</span>
<span class="term-fg31">-	blockTime   = uint64(2)</span>
<span class="term-fg31">-	blockHash   = common.BytesToHash([]byte{0x03, 0x14})</span>
<span class="term-fg32">+	depNonce1                   = uint64(7)</span>
<span class="term-fg32">+	depNonce2                   = uint64(8)</span>
<span class="term-fg32">+	blockNumber                 = big.NewInt(1)</span>
<span class="term-fg32">+	blockTime                   = uint64(2)</span>
<span class="term-fg32">+	blockHash                   = common.BytesToHash([]byte{0x03, 0x14})</span>
<span class="term-fg32">+	canyonDepositReceiptVersion = CanyonDepositReceiptVersion</span>
&nbsp;
 	&#47;&#47; Create the corresponding receipts
 	receipts = Receipts{
<span class="term-fg36">@@ -293,6 +364,78 @@</span> 			BlockHash:         blockHash,
 			BlockNumber:       blockNumber,
 			TransactionIndex:  6,
 		},
<span class="term-fg32">+		&amp;Receipt{</span>
<span class="term-fg32">+			Type:              DepositTxType,</span>
<span class="term-fg32">+			PostState:         common.Hash{5}.Bytes(),</span>
<span class="term-fg32">+			CumulativeGasUsed: 50 + 28,</span>
<span class="term-fg32">+			Logs: []*Log{</span>
<span class="term-fg32">+				{</span>
<span class="term-fg32">+					Address: common.BytesToAddress([]byte{0x33}),</span>
<span class="term-fg32">+					Topics:  []common.Hash{common.HexToHash(&quot;dead&quot;), common.HexToHash(&quot;beef&quot;)},</span>
<span class="term-fg32">+					&#47;&#47; derived fields:</span>
<span class="term-fg32">+					BlockNumber: blockNumber.Uint64(),</span>
<span class="term-fg32">+					TxHash:      txs[7].Hash(),</span>
<span class="term-fg32">+					TxIndex:     7,</span>
<span class="term-fg32">+					BlockHash:   blockHash,</span>
<span class="term-fg32">+					Index:       4,</span>
<span class="term-fg32">+				},</span>
<span class="term-fg32">+				{</span>
<span class="term-fg32">+					Address: common.BytesToAddress([]byte{0x03, 0x33}),</span>
<span class="term-fg32">+					Topics:  []common.Hash{common.HexToHash(&quot;dead&quot;), common.HexToHash(&quot;beef&quot;)},</span>
<span class="term-fg32">+					&#47;&#47; derived fields:</span>
<span class="term-fg32">+					BlockNumber: blockNumber.Uint64(),</span>
<span class="term-fg32">+					TxHash:      txs[7].Hash(),</span>
<span class="term-fg32">+					TxIndex:     7,</span>
<span class="term-fg32">+					BlockHash:   blockHash,</span>
<span class="term-fg32">+					Index:       5,</span>
<span class="term-fg32">+				},</span>
<span class="term-fg32">+			},</span>
<span class="term-fg32">+			TxHash:                txs[7].Hash(),</span>
<span class="term-fg32">+			ContractAddress:       common.HexToAddress(&quot;0x3bb898b4bbe24f68a4e9be46cfe72d1787fd74f4&quot;),</span>
<span class="term-fg32">+			GasUsed:               50,</span>
<span class="term-fg32">+			EffectiveGasPrice:     big.NewInt(0),</span>
<span class="term-fg32">+			BlockHash:             blockHash,</span>
<span class="term-fg32">+			BlockNumber:           blockNumber,</span>
<span class="term-fg32">+			TransactionIndex:      7,</span>
<span class="term-fg32">+			DepositNonce:          &amp;depNonce1,</span>
<span class="term-fg32">+			DepositReceiptVersion: nil,</span>
<span class="term-fg32">+		},</span>
<span class="term-fg32">+		&amp;Receipt{</span>
<span class="term-fg32">+			Type:              DepositTxType,</span>
<span class="term-fg32">+			PostState:         common.Hash{5}.Bytes(),</span>
<span class="term-fg32">+			CumulativeGasUsed: 60 + 50 + 28,</span>
<span class="term-fg32">+			Logs: []*Log{</span>
<span class="term-fg32">+				{</span>
<span class="term-fg32">+					Address: common.BytesToAddress([]byte{0x33}),</span>
<span class="term-fg32">+					Topics:  []common.Hash{common.HexToHash(&quot;dead&quot;), common.HexToHash(&quot;beef&quot;)},</span>
<span class="term-fg32">+					&#47;&#47; derived fields:</span>
<span class="term-fg32">+					BlockNumber: blockNumber.Uint64(),</span>
<span class="term-fg32">+					TxHash:      txs[8].Hash(),</span>
<span class="term-fg32">+					TxIndex:     8,</span>
<span class="term-fg32">+					BlockHash:   blockHash,</span>
<span class="term-fg32">+					Index:       6,</span>
<span class="term-fg32">+				},</span>
<span class="term-fg32">+				{</span>
<span class="term-fg32">+					Address: common.BytesToAddress([]byte{0x03, 0x33}),</span>
<span class="term-fg32">+					Topics:  []common.Hash{common.HexToHash(&quot;dead&quot;), common.HexToHash(&quot;beef&quot;)},</span>
<span class="term-fg32">+					&#47;&#47; derived fields:</span>
<span class="term-fg32">+					BlockNumber: blockNumber.Uint64(),</span>
<span class="term-fg32">+					TxHash:      txs[8].Hash(),</span>
<span class="term-fg32">+					TxIndex:     8,</span>
<span class="term-fg32">+					BlockHash:   blockHash,</span>
<span class="term-fg32">+					Index:       7,</span>
<span class="term-fg32">+				},</span>
<span class="term-fg32">+			},</span>
<span class="term-fg32">+			TxHash:                txs[8].Hash(),</span>
<span class="term-fg32">+			ContractAddress:       common.HexToAddress(&quot;0x117814af22cb83d8ad6e8489e9477d28265bc105&quot;),</span>
<span class="term-fg32">+			GasUsed:               60,</span>
<span class="term-fg32">+			EffectiveGasPrice:     big.NewInt(0),</span>
<span class="term-fg32">+			BlockHash:             blockHash,</span>
<span class="term-fg32">+			BlockNumber:           blockNumber,</span>
<span class="term-fg32">+			TransactionIndex:      8,</span>
<span class="term-fg32">+			DepositNonce:          &amp;depNonce2,</span>
<span class="term-fg32">+			DepositReceiptVersion: &amp;canyonDepositReceiptVersion,</span>
<span class="term-fg32">+		},</span>
 	}
 )
&nbsp;
<span class="term-fg36">@@ -527,3 +670,257 @@</span> 		l[i] = &amp;cpy
 	}
 	return l
 }
<span class="term-fg32">+</span>
<span class="term-fg32">+func TestDeriveOptimismTxReceipt(t *testing.T) {</span>
<span class="term-fg32">+	to4 := common.HexToAddress(&quot;0x4&quot;)</span>
<span class="term-fg32">+	&#47;&#47; Create a few transactions to have receipts for</span>
<span class="term-fg32">+	txs := Transactions{</span>
<span class="term-fg32">+		NewTx(&amp;DepositTx{</span>
<span class="term-fg32">+			To:    nil, &#47;&#47; contract creation</span>
<span class="term-fg32">+			Value: big.NewInt(6),</span>
<span class="term-fg32">+			Gas:   50,</span>
<span class="term-fg32">+			&#47;&#47; System config with L1Scalar=2_000_000 (becomes 2 after division), L1Overhead=2500, L1BaseFee=5000</span>
<span class="term-fg32">+			Data: common.Hex2Bytes(&quot;015d8eb900000000000000000000000000000000000000000000000026b39534042076f70000000000000000000000000000000000000000000000007e33b7c4995967580000000000000000000000000000000000000000000000000000000000001388547dea8ff339566349ed0ef6384876655d1b9b955e36ac165c6b8ab69b9af5cd0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000123400000000000000000000000000000000000000000000000000000000000009c400000000000000000000000000000000000000000000000000000000001e8480&quot;),</span>
<span class="term-fg32">+		}),</span>
<span class="term-fg32">+		NewTx(&amp;DynamicFeeTx{</span>
<span class="term-fg32">+			To:        &amp;to4,</span>
<span class="term-fg32">+			Nonce:     4,</span>
<span class="term-fg32">+			Value:     big.NewInt(4),</span>
<span class="term-fg32">+			Gas:       4,</span>
<span class="term-fg32">+			GasTipCap: big.NewInt(44),</span>
<span class="term-fg32">+			GasFeeCap: big.NewInt(1045),</span>
<span class="term-fg32">+			Data:      []byte{0, 1, 255, 0},</span>
<span class="term-fg32">+		}),</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	depNonce := uint64(7)</span>
<span class="term-fg32">+	blockNumber := big.NewInt(1)</span>
<span class="term-fg32">+	blockHash := common.BytesToHash([]byte{0x03, 0x14})</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	&#47;&#47; Create the corresponding receipts</span>
<span class="term-fg32">+	receipts := Receipts{</span>
<span class="term-fg32">+		&amp;Receipt{</span>
<span class="term-fg32">+			Type:              DepositTxType,</span>
<span class="term-fg32">+			PostState:         common.Hash{5}.Bytes(),</span>
<span class="term-fg32">+			CumulativeGasUsed: 50 + 15,</span>
<span class="term-fg32">+			Logs: []*Log{</span>
<span class="term-fg32">+				{</span>
<span class="term-fg32">+					Address: common.BytesToAddress([]byte{0x33}),</span>
<span class="term-fg32">+					&#47;&#47; derived fields:</span>
<span class="term-fg32">+					BlockNumber: blockNumber.Uint64(),</span>
<span class="term-fg32">+					TxHash:      txs[0].Hash(),</span>
<span class="term-fg32">+					TxIndex:     0,</span>
<span class="term-fg32">+					BlockHash:   blockHash,</span>
<span class="term-fg32">+					Index:       0,</span>
<span class="term-fg32">+				},</span>
<span class="term-fg32">+				{</span>
<span class="term-fg32">+					Address: common.BytesToAddress([]byte{0x03, 0x33}),</span>
<span class="term-fg32">+					&#47;&#47; derived fields:</span>
<span class="term-fg32">+					BlockNumber: blockNumber.Uint64(),</span>
<span class="term-fg32">+					TxHash:      txs[0].Hash(),</span>
<span class="term-fg32">+					TxIndex:     0,</span>
<span class="term-fg32">+					BlockHash:   blockHash,</span>
<span class="term-fg32">+					Index:       1,</span>
<span class="term-fg32">+				},</span>
<span class="term-fg32">+			},</span>
<span class="term-fg32">+			TxHash:            txs[0].Hash(),</span>
<span class="term-fg32">+			ContractAddress:   common.HexToAddress(&quot;0x3bb898b4bbe24f68a4e9be46cfe72d1787fd74f4&quot;),</span>
<span class="term-fg32">+			GasUsed:           65,</span>
<span class="term-fg32">+			EffectiveGasPrice: big.NewInt(0),</span>
<span class="term-fg32">+			BlockHash:         blockHash,</span>
<span class="term-fg32">+			BlockNumber:       blockNumber,</span>
<span class="term-fg32">+			TransactionIndex:  0,</span>
<span class="term-fg32">+			DepositNonce:      &amp;depNonce,</span>
<span class="term-fg32">+		},</span>
<span class="term-fg32">+		&amp;Receipt{</span>
<span class="term-fg32">+			Type:              DynamicFeeTxType,</span>
<span class="term-fg32">+			PostState:         common.Hash{4}.Bytes(),</span>
<span class="term-fg32">+			CumulativeGasUsed: 10,</span>
<span class="term-fg32">+			Logs:              []*Log{},</span>
<span class="term-fg32">+			&#47;&#47; derived fields:</span>
<span class="term-fg32">+			TxHash:            txs[1].Hash(),</span>
<span class="term-fg32">+			GasUsed:           18446744073709551561,</span>
<span class="term-fg32">+			EffectiveGasPrice: big.NewInt(1044),</span>
<span class="term-fg32">+			BlockHash:         blockHash,</span>
<span class="term-fg32">+			BlockNumber:       blockNumber,</span>
<span class="term-fg32">+			TransactionIndex:  1,</span>
<span class="term-fg32">+			L1GasPrice:        big.NewInt(5000),</span>
<span class="term-fg32">+			L1GasUsed:         big.NewInt(3976),</span>
<span class="term-fg32">+			L1Fee:             big.NewInt(39760000),</span>
<span class="term-fg32">+			FeeScalar:         big.NewFloat(2),</span>
<span class="term-fg32">+		},</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	&#47;&#47; Re-derive receipts.</span>
<span class="term-fg32">+	basefee := big.NewInt(1000)</span>
<span class="term-fg32">+	derivedReceipts := clearComputedFieldsOnReceipts(receipts)</span>
<span class="term-fg32">+	err := Receipts(derivedReceipts).DeriveFields(params.OptimismTestConfig, blockHash, blockNumber.Uint64(), 0, basefee, nil, txs)</span>
<span class="term-fg32">+	if err != nil {</span>
<span class="term-fg32">+		t.Fatalf(&quot;DeriveFields(...) = %v, want &lt;nil&gt;&quot;, err)</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	&#47;&#47; Check diff of receipts against derivedReceipts.</span>
<span class="term-fg32">+	r1, err := json.MarshalIndent(receipts, &quot;&quot;, &quot;  &quot;)</span>
<span class="term-fg32">+	if err != nil {</span>
<span class="term-fg32">+		t.Fatal(&quot;error marshaling input receipts:&quot;, err)</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	r2, err := json.MarshalIndent(derivedReceipts, &quot;&quot;, &quot;  &quot;)</span>
<span class="term-fg32">+	if err != nil {</span>
<span class="term-fg32">+		t.Fatal(&quot;error marshaling derived receipts:&quot;, err)</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	d := diff.Diff(string(r1), string(r2))</span>
<span class="term-fg32">+	if d != &quot;&quot; {</span>
<span class="term-fg32">+		t.Fatal(&quot;receipts differ:&quot;, d)</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	&#47;&#47; Check that we preserved the invariant: l1Fee = l1GasPrice * l1GasUsed * l1FeeScalar</span>
<span class="term-fg32">+	&#47;&#47; but with more difficult int math...</span>
<span class="term-fg32">+	l2Rcpt := derivedReceipts[1]</span>
<span class="term-fg32">+	l1GasCost := new(big.Int).Mul(l2Rcpt.L1GasPrice, l2Rcpt.L1GasUsed)</span>
<span class="term-fg32">+	l1Fee := new(big.Float).Mul(new(big.Float).SetInt(l1GasCost), l2Rcpt.FeeScalar)</span>
<span class="term-fg32">+	require.Equal(t, new(big.Float).SetInt(l2Rcpt.L1Fee), l1Fee)</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func TestBedrockDepositReceiptUnchanged(t *testing.T) {</span>
<span class="term-fg32">+	expectedRlp := common.FromHex(&quot;7EF90156A003000000000000000000000000000000000000000000000000000000000000000AB9010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000F0D7940000000000000000000000000000000000000033C001D7940000000000000000000000000000000000000333C002&quot;)</span>
<span class="term-fg32">+	&#47;&#47; Deposit receipt with no nonce</span>
<span class="term-fg32">+	receipt := &amp;Receipt{</span>
<span class="term-fg32">+		Type:              DepositTxType,</span>
<span class="term-fg32">+		PostState:         common.Hash{3}.Bytes(),</span>
<span class="term-fg32">+		CumulativeGasUsed: 10,</span>
<span class="term-fg32">+		Logs: []*Log{</span>
<span class="term-fg32">+			{Address: common.BytesToAddress([]byte{0x33}), Data: []byte{1}, Topics: []common.Hash{}},</span>
<span class="term-fg32">+			{Address: common.BytesToAddress([]byte{0x03, 0x33}), Data: []byte{2}, Topics: []common.Hash{}},</span>
<span class="term-fg32">+		},</span>
<span class="term-fg32">+		TxHash:          common.Hash{},</span>
<span class="term-fg32">+		ContractAddress: common.BytesToAddress([]byte{0x03, 0x33, 0x33}),</span>
<span class="term-fg32">+		GasUsed:         4,</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	rlp, err := receipt.MarshalBinary()</span>
<span class="term-fg32">+	require.NoError(t, err)</span>
<span class="term-fg32">+	require.Equal(t, expectedRlp, rlp)</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	&#47;&#47; Consensus values should be unchanged after reparsing</span>
<span class="term-fg32">+	parsed := new(Receipt)</span>
<span class="term-fg32">+	err = parsed.UnmarshalBinary(rlp)</span>
<span class="term-fg32">+	require.NoError(t, err)</span>
<span class="term-fg32">+	require.Equal(t, receipt.Status, parsed.Status)</span>
<span class="term-fg32">+	require.Equal(t, receipt.CumulativeGasUsed, parsed.CumulativeGasUsed)</span>
<span class="term-fg32">+	require.Equal(t, receipt.Bloom, parsed.Bloom)</span>
<span class="term-fg32">+	require.EqualValues(t, receipt.Logs, parsed.Logs)</span>
<span class="term-fg32">+	&#47;&#47; And still shouldn&#39;t have a nonce</span>
<span class="term-fg32">+	require.Nil(t, parsed.DepositNonce)</span>
<span class="term-fg32">+	&#47;&#47; ..or a deposit nonce</span>
<span class="term-fg32">+	require.Nil(t, parsed.DepositReceiptVersion)</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+&#47;&#47; Regolith introduced an inconsistency in behavior between EncodeIndex and MarshalBinary for a</span>
<span class="term-fg32">+&#47;&#47; deposit transaction receipt. TestReceiptEncodeIndexBugIsEnshrined makes sure this difference is</span>
<span class="term-fg32">+&#47;&#47; preserved for backwards compatibility purposes, but also that there is no discrepancy for the</span>
<span class="term-fg32">+&#47;&#47; post-Canyon encoding.</span>
<span class="term-fg32">+func TestReceiptEncodeIndexBugIsEnshrined(t *testing.T) {</span>
<span class="term-fg32">+	&#47;&#47; Check that a post-Regolith, pre-Canyon receipt produces the expected difference between</span>
<span class="term-fg32">+	&#47;&#47; EncodeIndex and MarshalBinary.</span>
<span class="term-fg32">+	buf := new(bytes.Buffer)</span>
<span class="term-fg32">+	receipts := Receipts{depositReceiptWithNonce}</span>
<span class="term-fg32">+	receipts.EncodeIndex(0, buf)</span>
<span class="term-fg32">+	indexBytes := buf.Bytes()</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	regularBytes, _ := receipts[0].MarshalBinary()</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	require.NotEqual(t, indexBytes, regularBytes)</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	&#47;&#47; Confirm the buggy encoding is as expected, which means it should encode as if it had no</span>
<span class="term-fg32">+	&#47;&#47; nonce specified (like that of a non-deposit receipt, whose encoding would differ only in the</span>
<span class="term-fg32">+	&#47;&#47; type byte).</span>
<span class="term-fg32">+	buf.Reset()</span>
<span class="term-fg32">+	tempReceipt := *depositReceiptWithNonce</span>
<span class="term-fg32">+	tempReceipt.Type = eip1559Receipt.Type</span>
<span class="term-fg32">+	buggyBytes, _ := tempReceipt.MarshalBinary()</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	require.Equal(t, indexBytes[1:], buggyBytes[1:])</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	&#47;&#47; check that the post-Canyon encoding has no differences between EncodeIndex and</span>
<span class="term-fg32">+	&#47;&#47; MarshalBinary.</span>
<span class="term-fg32">+	buf.Reset()</span>
<span class="term-fg32">+	receipts = Receipts{depositReceiptWithNonceAndVersion}</span>
<span class="term-fg32">+	receipts.EncodeIndex(0, buf)</span>
<span class="term-fg32">+	indexBytes = buf.Bytes()</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	regularBytes, _ = receipts[0].MarshalBinary()</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	require.Equal(t, indexBytes, regularBytes)</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	&#47;&#47; Check that bumping the nonce post-canyon changes the hash</span>
<span class="term-fg32">+	bumpedReceipt := *depositReceiptWithNonceAndVersion</span>
<span class="term-fg32">+	bumpedNonce := nonce + 1</span>
<span class="term-fg32">+	bumpedReceipt.DepositNonce = &amp;bumpedNonce</span>
<span class="term-fg32">+	bumpedBytes, _ := bumpedReceipt.MarshalBinary()</span>
<span class="term-fg32">+	require.NotEqual(t, regularBytes, bumpedBytes)</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func TestRoundTripReceipt(t *testing.T) {</span>
<span class="term-fg32">+	tests := []struct {</span>
<span class="term-fg32">+		name string</span>
<span class="term-fg32">+		rcpt *Receipt</span>
<span class="term-fg32">+	}{</span>
<span class="term-fg32">+		{name: &quot;Legacy&quot;, rcpt: legacyReceipt},</span>
<span class="term-fg32">+		{name: &quot;AccessList&quot;, rcpt: accessListReceipt},</span>
<span class="term-fg32">+		{name: &quot;EIP1559&quot;, rcpt: eip1559Receipt},</span>
<span class="term-fg32">+		{name: &quot;DepositNoNonce&quot;, rcpt: depositReceiptNoNonce},</span>
<span class="term-fg32">+		{name: &quot;DepositWithNonce&quot;, rcpt: depositReceiptWithNonce},</span>
<span class="term-fg32">+		{name: &quot;DepositWithNonceAndVersion&quot;, rcpt: depositReceiptWithNonceAndVersion},</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	for _, test := range tests {</span>
<span class="term-fg32">+		t.Run(test.name, func(t *testing.T) {</span>
<span class="term-fg32">+			data, err := test.rcpt.MarshalBinary()</span>
<span class="term-fg32">+			require.NoError(t, err)</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+			d := &amp;Receipt{}</span>
<span class="term-fg32">+			err = d.UnmarshalBinary(data)</span>
<span class="term-fg32">+			require.NoError(t, err)</span>
<span class="term-fg32">+			require.Equal(t, test.rcpt, d)</span>
<span class="term-fg32">+			require.Equal(t, test.rcpt.DepositNonce, d.DepositNonce)</span>
<span class="term-fg32">+			require.Equal(t, test.rcpt.DepositReceiptVersion, d.DepositReceiptVersion)</span>
<span class="term-fg32">+		})</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+		t.Run(fmt.Sprintf(&quot;%sRejectExtraData&quot;, test.name), func(t *testing.T) {</span>
<span class="term-fg32">+			data, err := test.rcpt.MarshalBinary()</span>
<span class="term-fg32">+			require.NoError(t, err)</span>
<span class="term-fg32">+			data = append(data, 1, 2, 3, 4)</span>
<span class="term-fg32">+			d := &amp;Receipt{}</span>
<span class="term-fg32">+			err = d.UnmarshalBinary(data)</span>
<span class="term-fg32">+			require.Error(t, err)</span>
<span class="term-fg32">+		})</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func TestRoundTripReceiptForStorage(t *testing.T) {</span>
<span class="term-fg32">+	tests := []struct {</span>
<span class="term-fg32">+		name string</span>
<span class="term-fg32">+		rcpt *Receipt</span>
<span class="term-fg32">+	}{</span>
<span class="term-fg32">+		{name: &quot;Legacy&quot;, rcpt: legacyReceipt},</span>
<span class="term-fg32">+		{name: &quot;AccessList&quot;, rcpt: accessListReceipt},</span>
<span class="term-fg32">+		{name: &quot;EIP1559&quot;, rcpt: eip1559Receipt},</span>
<span class="term-fg32">+		{name: &quot;DepositNoNonce&quot;, rcpt: depositReceiptNoNonce},</span>
<span class="term-fg32">+		{name: &quot;DepositWithNonce&quot;, rcpt: depositReceiptWithNonce},</span>
<span class="term-fg32">+		{name: &quot;DepositWithNonceAndVersion&quot;, rcpt: depositReceiptWithNonceAndVersion},</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	for _, test := range tests {</span>
<span class="term-fg32">+		t.Run(test.name, func(t *testing.T) {</span>
<span class="term-fg32">+			data, err := rlp.EncodeToBytes((*ReceiptForStorage)(test.rcpt))</span>
<span class="term-fg32">+			require.NoError(t, err)</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+			d := &amp;ReceiptForStorage{}</span>
<span class="term-fg32">+			err = rlp.DecodeBytes(data, d)</span>
<span class="term-fg32">+			require.NoError(t, err)</span>
<span class="term-fg32">+			&#47;&#47; Only check the stored fields - the others are derived later</span>
<span class="term-fg32">+			require.Equal(t, test.rcpt.Status, d.Status)</span>
<span class="term-fg32">+			require.Equal(t, test.rcpt.CumulativeGasUsed, d.CumulativeGasUsed)</span>
<span class="term-fg32">+			require.Equal(t, test.rcpt.Logs, d.Logs)</span>
<span class="term-fg32">+			require.Equal(t, test.rcpt.DepositNonce, d.DepositNonce)</span>
<span class="term-fg32">+			require.Equal(t, test.rcpt.DepositReceiptVersion, d.DepositReceiptVersion)</span>
<span class="term-fg32">+		})</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+}</span></div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-1852d123bbf8b0b2b7591ab8" role="button"
                   aria-expanded="false" aria-controls="id-1852d123bbf8b0b2b7591ab8">
                    <code>core/types/rollup_l1_cost_test.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <span class="text-muted">(new)</span>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/650bb2f2b1dcfe30d9b1fa6f7dc9608055ed60e1/core/types/rollup_l1_cost_test.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+30</span></div>
                        <div class="text-start"><span class="text-danger">-0</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-1852d123bbf8b0b2b7591ab8"><span class="term-fg1">diff --git go-ethereum&#47;core&#47;types&#47;rollup_l1_cost_test.go op-geth&#47;core&#47;types&#47;rollup_l1_cost_test.go</span>
<span class="term-fg1">new file mode 100644</span>
<span class="term-fg1">index 0000000000000000000000000000000000000000..e43ea967ee87a257cfc2afa58396c2eb6685ed76</span>
<span class="term-fg1">--- &#47;dev&#47;null</span>
<span class="term-fg1">+++ op-geth&#47;core&#47;types&#47;rollup_l1_cost_test.go</span>
<span class="term-fg36">@@ -0,0 +1,30 @@</span>
<span class="term-fg32">+package types</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+import (</span>
<span class="term-fg32">+	&quot;math&#47;rand&quot;</span>
<span class="term-fg32">+	&quot;testing&quot;</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;params&quot;</span>
<span class="term-fg32">+	&quot;github.com&#47;stretchr&#47;testify&#47;require&quot;</span>
<span class="term-fg32">+)</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func TestRollupGasData(t *testing.T) {</span>
<span class="term-fg32">+	for i := 0; i &lt; 100; i++ {</span>
<span class="term-fg32">+		zeroes := rand.Uint64()</span>
<span class="term-fg32">+		ones := rand.Uint64()</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+		r := RollupGasData{</span>
<span class="term-fg32">+			Zeroes: zeroes,</span>
<span class="term-fg32">+			Ones:   ones,</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+		time := uint64(1)</span>
<span class="term-fg32">+		cfg := &amp;params.ChainConfig{</span>
<span class="term-fg32">+			RegolithTime: &amp;time,</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+		gasPreRegolith := r.DataGas(0, cfg)</span>
<span class="term-fg32">+		gasPostRegolith := r.DataGas(1, cfg)</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+		require.Equal(t, r.Zeroes*params.TxDataZeroGas+(r.Ones+68)*params.TxDataNonZeroGasEIP2028, gasPreRegolith)</span>
<span class="term-fg32">+		require.Equal(t, r.Zeroes*params.TxDataZeroGas+r.Ones*params.TxDataNonZeroGasEIP2028, gasPostRegolith)</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+}</span></div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-fe9946239259183abd7d9044" role="button"
                   aria-expanded="false" aria-controls="id-fe9946239259183abd7d9044">
                    <code>core/types/state_account.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/3f40e65c484486dea6cff80b7db178985d21a2c6/core/types/state_account.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/650bb2f2b1dcfe30d9b1fa6f7dc9608055ed60e1/core/types/state_account.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+1</span></div>
                        <div class="text-start"><span class="text-danger">-1</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-fe9946239259183abd7d9044"><span class="term-fg1">diff --git go-ethereum&#47;core&#47;types&#47;state_account.go op-geth&#47;core&#47;types&#47;state_account.go</span>
<span class="term-fg1">index 314f4943ecab386a288c7b33cae010f926840561..ad07ca3f3a3d110a588ce7455bbedf1e5aad029f 100644</span>
<span class="term-fg1">--- go-ethereum&#47;core&#47;types&#47;state_account.go</span>
<span class="term-fg1">+++ op-geth&#47;core&#47;types&#47;state_account.go</span>
<span class="term-fg36">@@ -87,7 +87,7 @@</span> 	}
 	return data
 }
&nbsp;
<span class="term-fg31">-&#47;&#47; FullAccount decodes the data on the &#39;slim RLP&#39; format and return</span>
<span class="term-fg32">+&#47;&#47; FullAccount decodes the data on the &#39;slim RLP&#39; format and returns</span>
 &#47;&#47; the consensus format account.
 func FullAccount(data []byte) (*StateAccount, error) {
 	var slim SlimAccount</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-db02ed5341fad79f0235bfd9" role="button"
                   aria-expanded="false" aria-controls="id-db02ed5341fad79f0235bfd9">
                    <code>core/types/transaction_marshalling_test.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <span class="text-muted">(new)</span>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/650bb2f2b1dcfe30d9b1fa6f7dc9608055ed60e1/core/types/transaction_marshalling_test.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+103</span></div>
                        <div class="text-start"><span class="text-danger">-0</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-db02ed5341fad79f0235bfd9"><span class="term-fg1">diff --git go-ethereum&#47;core&#47;types&#47;transaction_marshalling_test.go op-geth&#47;core&#47;types&#47;transaction_marshalling_test.go</span>
<span class="term-fg1">new file mode 100644</span>
<span class="term-fg1">index 0000000000000000000000000000000000000000..4ab93a539d19bbcffa0293738b2e4dcc3ebe7ad2</span>
<span class="term-fg1">--- &#47;dev&#47;null</span>
<span class="term-fg1">+++ op-geth&#47;core&#47;types&#47;transaction_marshalling_test.go</span>
<span class="term-fg36">@@ -0,0 +1,103 @@</span>
<span class="term-fg32">+package types</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+import (</span>
<span class="term-fg32">+	&quot;encoding&#47;json&quot;</span>
<span class="term-fg32">+	&quot;math&#47;big&quot;</span>
<span class="term-fg32">+	&quot;testing&quot;</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;common&quot;</span>
<span class="term-fg32">+	&quot;github.com&#47;stretchr&#47;testify&#47;require&quot;</span>
<span class="term-fg32">+)</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func TestTransactionUnmarshalJsonDeposit(t *testing.T) {</span>
<span class="term-fg32">+	tx := NewTx(&amp;DepositTx{</span>
<span class="term-fg32">+		SourceHash:          common.HexToHash(&quot;0x1234&quot;),</span>
<span class="term-fg32">+		IsSystemTransaction: true,</span>
<span class="term-fg32">+		Mint:                big.NewInt(34),</span>
<span class="term-fg32">+	})</span>
<span class="term-fg32">+	json, err := tx.MarshalJSON()</span>
<span class="term-fg32">+	require.NoError(t, err, &quot;Failed to marshal tx JSON&quot;)</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	got := &amp;Transaction{}</span>
<span class="term-fg32">+	err = got.UnmarshalJSON(json)</span>
<span class="term-fg32">+	require.NoError(t, err, &quot;Failed to unmarshal tx JSON&quot;)</span>
<span class="term-fg32">+	require.Equal(t, tx.Hash(), got.Hash())</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func TestTransactionUnmarshalJSON(t *testing.T) {</span>
<span class="term-fg32">+	tests := []struct {</span>
<span class="term-fg32">+		name          string</span>
<span class="term-fg32">+		json          string</span>
<span class="term-fg32">+		expectedError string</span>
<span class="term-fg32">+	}{</span>
<span class="term-fg32">+		{</span>
<span class="term-fg32">+			name:          &quot;No gas&quot;,</span>
<span class="term-fg32">+			json:          `{&quot;type&quot;:&quot;0x7e&quot;,&quot;nonce&quot;:null,&quot;gasPrice&quot;:null,&quot;maxPriorityFeePerGas&quot;:null,&quot;maxFeePerGas&quot;:null,&quot;value&quot;:&quot;0x1&quot;,&quot;input&quot;:&quot;0x616263646566&quot;,&quot;v&quot;:null,&quot;r&quot;:null,&quot;s&quot;:null,&quot;to&quot;:null,&quot;sourceHash&quot;:&quot;0x0000000000000000000000000000000000000000000000000000000000000000&quot;,&quot;from&quot;:&quot;0x0000000000000000000000000000000000000001&quot;,&quot;isSystemTx&quot;:false,&quot;hash&quot;:&quot;0xa4341f3db4363b7ca269a8538bd027b2f8784f84454ca917668642d5f6dffdf9&quot;}`,</span>
<span class="term-fg32">+			expectedError: &quot;missing required field &#39;gas&#39;&quot;,</span>
<span class="term-fg32">+		},</span>
<span class="term-fg32">+		{</span>
<span class="term-fg32">+			name:          &quot;No value&quot;,</span>
<span class="term-fg32">+			json:          `{&quot;type&quot;:&quot;0x7e&quot;,&quot;nonce&quot;:null,&quot;gas&quot;: &quot;0x1234&quot;, &quot;gasPrice&quot;:null,&quot;maxPriorityFeePerGas&quot;:null,&quot;maxFeePerGas&quot;:null,&quot;input&quot;:&quot;0x616263646566&quot;,&quot;v&quot;:null,&quot;r&quot;:null,&quot;s&quot;:null,&quot;to&quot;:null,&quot;sourceHash&quot;:&quot;0x0000000000000000000000000000000000000000000000000000000000000000&quot;,&quot;from&quot;:&quot;0x0000000000000000000000000000000000000001&quot;,&quot;isSystemTx&quot;:false,&quot;hash&quot;:&quot;0xa4341f3db4363b7ca269a8538bd027b2f8784f84454ca917668642d5f6dffdf9&quot;}`,</span>
<span class="term-fg32">+			expectedError: &quot;missing required field &#39;value&#39;&quot;,</span>
<span class="term-fg32">+		},</span>
<span class="term-fg32">+		{</span>
<span class="term-fg32">+			name:          &quot;No input&quot;,</span>
<span class="term-fg32">+			json:          `{&quot;type&quot;:&quot;0x7e&quot;,&quot;nonce&quot;:null,&quot;gas&quot;: &quot;0x1234&quot;, &quot;gasPrice&quot;:null,&quot;maxPriorityFeePerGas&quot;:null,&quot;maxFeePerGas&quot;:null,&quot;value&quot;:&quot;0x1&quot;,&quot;v&quot;:null,&quot;r&quot;:null,&quot;s&quot;:null,&quot;to&quot;:null,&quot;sourceHash&quot;:&quot;0x0000000000000000000000000000000000000000000000000000000000000000&quot;,&quot;from&quot;:&quot;0x0000000000000000000000000000000000000001&quot;,&quot;isSystemTx&quot;:false,&quot;hash&quot;:&quot;0xa4341f3db4363b7ca269a8538bd027b2f8784f84454ca917668642d5f6dffdf9&quot;}`,</span>
<span class="term-fg32">+			expectedError: &quot;missing required field &#39;input&#39;&quot;,</span>
<span class="term-fg32">+		},</span>
<span class="term-fg32">+		{</span>
<span class="term-fg32">+			name:          &quot;No from&quot;,</span>
<span class="term-fg32">+			json:          `{&quot;type&quot;:&quot;0x7e&quot;,&quot;nonce&quot;:null,&quot;gas&quot;: &quot;0x1234&quot;, &quot;gasPrice&quot;:null,&quot;maxPriorityFeePerGas&quot;:null,&quot;maxFeePerGas&quot;:null,&quot;value&quot;:&quot;0x1&quot;,&quot;input&quot;:&quot;0x616263646566&quot;,&quot;v&quot;:null,&quot;r&quot;:null,&quot;s&quot;:null,&quot;to&quot;:null,&quot;sourceHash&quot;:&quot;0x0000000000000000000000000000000000000000000000000000000000000000&quot;,&quot;isSystemTx&quot;:false,&quot;hash&quot;:&quot;0xa4341f3db4363b7ca269a8538bd027b2f8784f84454ca917668642d5f6dffdf9&quot;}`,</span>
<span class="term-fg32">+			expectedError: &quot;missing required field &#39;from&#39;&quot;,</span>
<span class="term-fg32">+		},</span>
<span class="term-fg32">+		{</span>
<span class="term-fg32">+			name:          &quot;No sourceHash&quot;,</span>
<span class="term-fg32">+			json:          `{&quot;type&quot;:&quot;0x7e&quot;,&quot;nonce&quot;:null,&quot;gas&quot;: &quot;0x1234&quot;, &quot;gasPrice&quot;:null,&quot;maxPriorityFeePerGas&quot;:null,&quot;maxFeePerGas&quot;:null,&quot;value&quot;:&quot;0x1&quot;,&quot;input&quot;:&quot;0x616263646566&quot;,&quot;v&quot;:null,&quot;r&quot;:null,&quot;s&quot;:null,&quot;to&quot;:null,&quot;from&quot;:&quot;0x0000000000000000000000000000000000000001&quot;,&quot;isSystemTx&quot;:false,&quot;hash&quot;:&quot;0xa4341f3db4363b7ca269a8538bd027b2f8784f84454ca917668642d5f6dffdf9&quot;}`,</span>
<span class="term-fg32">+			expectedError: &quot;missing required field &#39;sourceHash&#39;&quot;,</span>
<span class="term-fg32">+		},</span>
<span class="term-fg32">+		{</span>
<span class="term-fg32">+			name: &quot;No mint&quot;,</span>
<span class="term-fg32">+			json: `{&quot;type&quot;:&quot;0x7e&quot;,&quot;nonce&quot;:null,&quot;gas&quot;: &quot;0x1234&quot;, &quot;gasPrice&quot;:null,&quot;maxPriorityFeePerGas&quot;:null,&quot;maxFeePerGas&quot;:null,&quot;value&quot;:&quot;0x1&quot;,&quot;input&quot;:&quot;0x616263646566&quot;,&quot;v&quot;:null,&quot;r&quot;:null,&quot;s&quot;:null,&quot;to&quot;:null,&quot;sourceHash&quot;:&quot;0x0000000000000000000000000000000000000000000000000000000000000000&quot;,&quot;from&quot;:&quot;0x0000000000000000000000000000000000000001&quot;,&quot;isSystemTx&quot;:false,&quot;hash&quot;:&quot;0xa4341f3db4363b7ca269a8538bd027b2f8784f84454ca917668642d5f6dffdf9&quot;}`,</span>
<span class="term-fg32">+			&#47;&#47; Allowed</span>
<span class="term-fg32">+		},</span>
<span class="term-fg32">+		{</span>
<span class="term-fg32">+			name: &quot;No IsSystemTx&quot;,</span>
<span class="term-fg32">+			json: `{&quot;type&quot;:&quot;0x7e&quot;,&quot;nonce&quot;:null,&quot;gas&quot;: &quot;0x1234&quot;, &quot;gasPrice&quot;:null,&quot;maxPriorityFeePerGas&quot;:null,&quot;maxFeePerGas&quot;:null,&quot;value&quot;:&quot;0x1&quot;,&quot;input&quot;:&quot;0x616263646566&quot;,&quot;v&quot;:null,&quot;r&quot;:null,&quot;s&quot;:null,&quot;to&quot;:null,&quot;sourceHash&quot;:&quot;0x0000000000000000000000000000000000000000000000000000000000000000&quot;,&quot;from&quot;:&quot;0x0000000000000000000000000000000000000001&quot;,&quot;hash&quot;:&quot;0xa4341f3db4363b7ca269a8538bd027b2f8784f84454ca917668642d5f6dffdf9&quot;}`,</span>
<span class="term-fg32">+			&#47;&#47; Allowed</span>
<span class="term-fg32">+		},</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	for _, test := range tests {</span>
<span class="term-fg32">+		t.Run(test.name, func(t *testing.T) {</span>
<span class="term-fg32">+			var parsedTx = &amp;Transaction{}</span>
<span class="term-fg32">+			err := json.Unmarshal([]byte(test.json), &amp;parsedTx)</span>
<span class="term-fg32">+			if test.expectedError == &quot;&quot; {</span>
<span class="term-fg32">+				require.NoError(t, err)</span>
<span class="term-fg32">+			} else {</span>
<span class="term-fg32">+				require.ErrorContains(t, err, test.expectedError)</span>
<span class="term-fg32">+			}</span>
<span class="term-fg32">+		})</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	tests = []struct {</span>
<span class="term-fg32">+		name          string</span>
<span class="term-fg32">+		json          string</span>
<span class="term-fg32">+		expectedError string</span>
<span class="term-fg32">+	}{</span>
<span class="term-fg32">+		{</span>
<span class="term-fg32">+			name: &quot;Valid deposit sender&quot;,</span>
<span class="term-fg32">+			json: `{&quot;type&quot;:&quot;0x7e&quot;,&quot;nonce&quot;:&quot;0x1&quot;,&quot;gas&quot;: &quot;0x1234&quot;, &quot;gasPrice&quot;:null,&quot;maxPriorityFeePerGas&quot;:null,&quot;maxFeePerGas&quot;:null,&quot;value&quot;:&quot;0x1&quot;,&quot;input&quot;:&quot;0x616263646566&quot;,&quot;v&quot;:null,&quot;r&quot;:null,&quot;s&quot;:null,&quot;to&quot;:null,&quot;sourceHash&quot;:&quot;0x0000000000000000000000000000000000000000000000000000000000000000&quot;,&quot;from&quot;:&quot;0x0000000000000000000000000000000000000001&quot;,&quot;hash&quot;:&quot;0xa4341f3db4363b7ca269a8538bd027b2f8784f84454ca917668642d5f6dffdf9&quot;}`,</span>
<span class="term-fg32">+		},</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	for _, test := range tests {</span>
<span class="term-fg32">+		t.Run(test.name, func(t *testing.T) {</span>
<span class="term-fg32">+			var parsedTx = &amp;Transaction{}</span>
<span class="term-fg32">+			err := json.Unmarshal([]byte(test.json), &amp;parsedTx)</span>
<span class="term-fg32">+			require.NoError(t, err)</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+			signer := NewLondonSigner(big.NewInt(123))</span>
<span class="term-fg32">+			sender, err := signer.Sender(parsedTx)</span>
<span class="term-fg32">+			require.NoError(t, err)</span>
<span class="term-fg32">+			require.Equal(t, common.HexToAddress(&quot;0x1&quot;), sender)</span>
<span class="term-fg32">+		})</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+}</span></div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-87d628093a7536ab89465a97" role="button"
                   aria-expanded="false" aria-controls="id-87d628093a7536ab89465a97">
                    <code>core/vm/contract.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/3f40e65c484486dea6cff80b7db178985d21a2c6/core/vm/contract.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/650bb2f2b1dcfe30d9b1fa6f7dc9608055ed60e1/core/vm/contract.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+2</span></div>
                        <div class="text-start"><span class="text-danger">-2</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-87d628093a7536ab89465a97"><span class="term-fg1">diff --git go-ethereum&#47;core&#47;vm&#47;contract.go op-geth&#47;core&#47;vm&#47;contract.go</span>
<span class="term-fg1">index bb0902969ec78d4a8392276da5f5cfa37fb3b330..e4b03bd74fecfcd86db78ef794529f8a557c64b4 100644</span>
<span class="term-fg1">--- go-ethereum&#47;core&#47;vm&#47;contract.go</span>
<span class="term-fg1">+++ op-geth&#47;core&#47;vm&#47;contract.go</span>
<span class="term-fg36">@@ -31,13 +31,13 @@</span>
 &#47;&#47; AccountRef implements ContractRef.
 &#47;&#47;
 &#47;&#47; Account references are used during EVM initialisation and
<span class="term-fg31">-&#47;&#47; it&#39;s primary use is to fetch addresses. Removing this object</span>
<span class="term-fg32">+&#47;&#47; its primary use is to fetch addresses. Removing this object</span>
 &#47;&#47; proves difficult because of the cached jump destinations which
 &#47;&#47; are fetched from the parent contract (i.e. the caller), which
 &#47;&#47; is a ContractRef.
 type AccountRef common.Address
&nbsp;
<span class="term-fg31">-&#47;&#47; Address casts AccountRef to a Address</span>
<span class="term-fg32">+&#47;&#47; Address casts AccountRef to an Address</span>
 func (ar AccountRef) Address() common.Address { return (common.Address)(ar) }
&nbsp;
 &#47;&#47; Contract represents an ethereum contract in the state database. It contains</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-375c8bddb18ee70546a6aecb" role="button"
                   aria-expanded="false" aria-controls="id-375c8bddb18ee70546a6aecb">
                    <code>core/vm/eips.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/3f40e65c484486dea6cff80b7db178985d21a2c6/core/vm/eips.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/650bb2f2b1dcfe30d9b1fa6f7dc9608055ed60e1/core/vm/eips.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+18</span></div>
                        <div class="text-start"><span class="text-danger">-2</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-375c8bddb18ee70546a6aecb"><span class="term-fg1">diff --git go-ethereum&#47;core&#47;vm&#47;eips.go op-geth&#47;core&#47;vm&#47;eips.go</span>
<span class="term-fg1">index 704c1ce1274516c8bdef8edcdae4f642c96e626e..35f0a3f7c2831e6f669ad3f718123ff9deeca54e 100644</span>
<span class="term-fg1">--- go-ethereum&#47;core&#47;vm&#47;eips.go</span>
<span class="term-fg1">+++ op-geth&#47;core&#47;vm&#47;eips.go</span>
<span class="term-fg36">@@ -282,14 +282,30 @@</span> 	}
 	return nil, nil
 }
&nbsp;
<span class="term-fg31">-&#47;&#47; enable4844 applies EIP-4844 (DATAHASH opcode)</span>
<span class="term-fg32">+&#47;&#47; opBlobBaseFee implements BLOBBASEFEE opcode</span>
<span class="term-fg32">+func opBlobBaseFee(pc *uint64, interpreter *EVMInterpreter, scope *ScopeContext) ([]byte, error) {</span>
<span class="term-fg32">+	blobBaseFee, _ := uint256.FromBig(interpreter.evm.Context.BlobBaseFee)</span>
<span class="term-fg32">+	scope.Stack.push(blobBaseFee)</span>
<span class="term-fg32">+	return nil, nil</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+&#47;&#47; enable4844 applies EIP-4844 (BLOBHASH opcode)</span>
 func enable4844(jt *JumpTable) {
<span class="term-fg31">-	&#47;&#47; New opcode</span>
 	jt[BLOBHASH] = &amp;operation{
 		execute:     opBlobHash,
 		constantGas: GasFastestStep,
 		minStack:    minStack(1, 1),
 		maxStack:    maxStack(1, 1),
<span class="term-fg32">+	}</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+&#47;&#47; enable7516 applies EIP-7516 (BLOBBASEFEE opcode)</span>
<span class="term-fg32">+func enable7516(jt *JumpTable) {</span>
<span class="term-fg32">+	jt[BLOBBASEFEE] = &amp;operation{</span>
<span class="term-fg32">+		execute:     opBlobBaseFee,</span>
<span class="term-fg32">+		constantGas: GasQuickStep,</span>
<span class="term-fg32">+		minStack:    minStack(0, 1),</span>
<span class="term-fg32">+		maxStack:    maxStack(0, 1),</span>
 	}
 }
</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-969dabb316afeb26e710b0c7" role="button"
                   aria-expanded="false" aria-controls="id-969dabb316afeb26e710b0c7">
                    <code>core/vm/gas_table.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/3f40e65c484486dea6cff80b7db178985d21a2c6/core/vm/gas_table.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/650bb2f2b1dcfe30d9b1fa6f7dc9608055ed60e1/core/vm/gas_table.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+1</span></div>
                        <div class="text-start"><span class="text-danger">-1</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-969dabb316afeb26e710b0c7"><span class="term-fg1">diff --git go-ethereum&#47;core&#47;vm&#47;gas_table.go op-geth&#47;core&#47;vm&#47;gas_table.go</span>
<span class="term-fg1">index 5153c8b7a3de990d4b5bc4caae40645663236b38..4b141d8f9a5d81df32b09095c9d121c3ad7750a5 100644</span>
<span class="term-fg1">--- go-ethereum&#47;core&#47;vm&#47;gas_table.go</span>
<span class="term-fg1">+++ op-geth&#47;core&#47;vm&#47;gas_table.go</span>
<span class="term-fg36">@@ -104,7 +104,7 @@</span> 	&#47;&#47; The legacy gas metering only takes into consideration the current state
 	&#47;&#47; Legacy rules should be applied if we are in Petersburg (removal of EIP-1283)
 	&#47;&#47; OR Constantinople is not active
 	if evm.chainRules.IsPetersburg || !evm.chainRules.IsConstantinople {
<span class="term-fg31">-		&#47;&#47; This checks for 3 scenario&#39;s and calculates gas accordingly:</span>
<span class="term-fg32">+		&#47;&#47; This checks for 3 scenarios and calculates gas accordingly:</span>
 		&#47;&#47;
 		&#47;&#47; 1. From a zero-value address to a non-zero value         (NEW VALUE)
 		&#47;&#47; 2. From a non-zero value address to a zero-value address (DELETE)</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-c852c8fd54691c003f6a9758" role="button"
                   aria-expanded="false" aria-controls="id-c852c8fd54691c003f6a9758">
                    <code>core/vm/instructions.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/3f40e65c484486dea6cff80b7db178985d21a2c6/core/vm/instructions.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/650bb2f2b1dcfe30d9b1fa6f7dc9608055ed60e1/core/vm/instructions.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+2</span></div>
                        <div class="text-start"><span class="text-danger">-0</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-c852c8fd54691c003f6a9758"><span class="term-fg1">diff --git go-ethereum&#47;core&#47;vm&#47;instructions.go op-geth&#47;core&#47;vm&#47;instructions.go</span>
<span class="term-fg1">index 2105201fce42875995250c29df5060e35d080558..56ff3502011c9e7f855a9821baaba0b3fc4de73a 100644</span>
<span class="term-fg1">--- go-ethereum&#47;core&#47;vm&#47;instructions.go</span>
<span class="term-fg1">+++ op-geth&#47;core&#47;vm&#47;instructions.go</span>
<span class="term-fg36">@@ -251,6 +251,7 @@</span>
 	size.SetBytes(interpreter.hasherBuf[:])
 	return nil, nil
 }
<span class="term-fg32">+</span>
 func opAddress(pc *uint64, interpreter *EVMInterpreter, scope *ScopeContext) ([]byte, error) {
 	scope.Stack.push(new(uint256.Int).SetBytes(scope.Contract.Address().Bytes()))
 	return nil, nil
<span class="term-fg36">@@ -267,6 +268,7 @@</span> func opOrigin(pc *uint64, interpreter *EVMInterpreter, scope *ScopeContext) ([]byte, error) {
 	scope.Stack.push(new(uint256.Int).SetBytes(interpreter.evm.Origin.Bytes()))
 	return nil, nil
 }
<span class="term-fg32">+</span>
 func opCaller(pc *uint64, interpreter *EVMInterpreter, scope *ScopeContext) ([]byte, error) {
 	scope.Stack.push(new(uint256.Int).SetBytes(scope.Contract.Caller().Bytes()))
 	return nil, nil</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-fce1ba6243cc75201b0a1cf4" role="button"
                   aria-expanded="false" aria-controls="id-fce1ba6243cc75201b0a1cf4">
                    <code>core/vm/interpreter.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/3f40e65c484486dea6cff80b7db178985d21a2c6/core/vm/interpreter.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/650bb2f2b1dcfe30d9b1fa6f7dc9608055ed60e1/core/vm/interpreter.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+1</span></div>
                        <div class="text-start"><span class="text-danger">-1</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-fce1ba6243cc75201b0a1cf4"><span class="term-fg1">diff --git go-ethereum&#47;core&#47;vm&#47;interpreter.go op-geth&#47;core&#47;vm&#47;interpreter.go</span>
<span class="term-fg1">index 873337850e6f3fb787a71bd0ffca8a334ec4f6e5..28da2e80e60eca0aaec4d7e8199297e35044ba38 100644</span>
<span class="term-fg1">--- go-ethereum&#47;core&#47;vm&#47;interpreter.go</span>
<span class="term-fg1">+++ op-geth&#47;core&#47;vm&#47;interpreter.go</span>
<span class="term-fg36">@@ -45,7 +45,7 @@</span> 	evm   *EVM
 	table *JumpTable
&nbsp;
 	hasher    crypto.KeccakState &#47;&#47; Keccak256 hasher instance shared across opcodes
<span class="term-fg31">-	hasherBuf common.Hash        &#47;&#47; Keccak256 hasher result array shared aross opcodes</span>
<span class="term-fg32">+	hasherBuf common.Hash        &#47;&#47; Keccak256 hasher result array shared across opcodes</span>
&nbsp;
 	readOnly   bool   &#47;&#47; Whether to throw on stateful modifications
 	returnData []byte &#47;&#47; Last CALL&#39;s return data for subsequent reuse</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-9f4d489119c1d071cec09093" role="button"
                   aria-expanded="false" aria-controls="id-9f4d489119c1d071cec09093">
                    <code>core/vm/jump_table.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/3f40e65c484486dea6cff80b7db178985d21a2c6/core/vm/jump_table.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/650bb2f2b1dcfe30d9b1fa6f7dc9608055ed60e1/core/vm/jump_table.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+2</span></div>
                        <div class="text-start"><span class="text-danger">-1</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-9f4d489119c1d071cec09093"><span class="term-fg1">diff --git go-ethereum&#47;core&#47;vm&#47;jump_table.go op-geth&#47;core&#47;vm&#47;jump_table.go</span>
<span class="term-fg1">index 702b18661545b3adb2c5da7720bd823eb3326f9b..fb87258326bd3699cca7a88a032285e8abd7686e 100644</span>
<span class="term-fg1">--- go-ethereum&#47;core&#47;vm&#47;jump_table.go</span>
<span class="term-fg1">+++ op-geth&#47;core&#47;vm&#47;jump_table.go</span>
<span class="term-fg36">@@ -82,7 +82,8 @@</span> }
&nbsp;
 func newCancunInstructionSet() JumpTable {
 	instructionSet := newShanghaiInstructionSet()
<span class="term-fg31">-	enable4844(&amp;instructionSet) &#47;&#47; EIP-4844 (DATAHASH opcode)</span>
<span class="term-fg32">+	enable4844(&amp;instructionSet) &#47;&#47; EIP-4844 (BLOBHASH opcode)</span>
<span class="term-fg32">+	enable7516(&amp;instructionSet) &#47;&#47; EIP-7516 (BLOBBASEFEE opcode)</span>
 	enable1153(&amp;instructionSet) &#47;&#47; EIP-1153 &quot;Transient Storage&quot;
 	enable5656(&amp;instructionSet) &#47;&#47; EIP-5656 (MCOPY opcode)
 	enable6780(&amp;instructionSet) &#47;&#47; EIP-6780 SELFDESTRUCT only in same transaction</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-ab2b4145bec11eb509a2d069" role="button"
                   aria-expanded="false" aria-controls="id-ab2b4145bec11eb509a2d069">
                    <code>core/vm/jump_table_export.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/3f40e65c484486dea6cff80b7db178985d21a2c6/core/vm/jump_table_export.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/650bb2f2b1dcfe30d9b1fa6f7dc9608055ed60e1/core/vm/jump_table_export.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+2</span></div>
                        <div class="text-start"><span class="text-danger">-2</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-ab2b4145bec11eb509a2d069"><span class="term-fg1">diff --git go-ethereum&#47;core&#47;vm&#47;jump_table_export.go op-geth&#47;core&#47;vm&#47;jump_table_export.go</span>
<span class="term-fg1">index 6ea47d63a281eacba893e15c869dc48ffc1281dd..b74109da0ad14b02ec33e3dfa3e969ecb25ad850 100644</span>
<span class="term-fg1">--- go-ethereum&#47;core&#47;vm&#47;jump_table_export.go</span>
<span class="term-fg1">+++ op-geth&#47;core&#47;vm&#47;jump_table_export.go</span>
<span class="term-fg36">@@ -22,7 +22,7 @@</span>
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;params&quot;
 )
&nbsp;
<span class="term-fg31">-&#47;&#47; LookupInstructionSet returns the instructionset for the fork configured by</span>
<span class="term-fg32">+&#47;&#47; LookupInstructionSet returns the instruction set for the fork configured by</span>
 &#47;&#47; the rules.
 func LookupInstructionSet(rules params.Rules) (JumpTable, error) {
 	switch {
<span class="term-fg36">@@ -56,7 +56,7 @@</span> 	}
 	return newFrontierInstructionSet(), nil
 }
&nbsp;
<span class="term-fg31">-&#47;&#47; Stack returns the mininum and maximum stack requirements.</span>
<span class="term-fg32">+&#47;&#47; Stack returns the minimum and maximum stack requirements.</span>
 func (op *operation) Stack() (int, int) {
 	return op.minStack, op.maxStack
 }</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-f6265e2f1e89acfb860e2494" role="button"
                   aria-expanded="false" aria-controls="id-f6265e2f1e89acfb860e2494">
                    <code>core/vm/opcodes.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/3f40e65c484486dea6cff80b7db178985d21a2c6/core/vm/opcodes.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/650bb2f2b1dcfe30d9b1fa6f7dc9608055ed60e1/core/vm/opcodes.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+3</span></div>
                        <div class="text-start"><span class="text-danger">-0</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-f6265e2f1e89acfb860e2494"><span class="term-fg1">diff --git go-ethereum&#47;core&#47;vm&#47;opcodes.go op-geth&#47;core&#47;vm&#47;opcodes.go</span>
<span class="term-fg1">index 2929b8ce920ccf0a7df8d01b2829477332e616c7..a11cf05a1578935a7a97f411fcc8d678a017364f 100644</span>
<span class="term-fg1">--- go-ethereum&#47;core&#47;vm&#47;opcodes.go</span>
<span class="term-fg1">+++ op-geth&#47;core&#47;vm&#47;opcodes.go</span>
<span class="term-fg36">@@ -101,6 +101,7 @@</span> 	CHAINID     OpCode = 0x46
 	SELFBALANCE OpCode = 0x47
 	BASEFEE     OpCode = 0x48
 	BLOBHASH    OpCode = 0x49
<span class="term-fg32">+	BLOBBASEFEE OpCode = 0x4a</span>
 )
&nbsp;
 &#47;&#47; 0x50 range - &#39;storage&#39; and execution.
<span class="term-fg36">@@ -287,6 +288,7 @@</span> 	CHAINID:     &quot;CHAINID&quot;,
 	SELFBALANCE: &quot;SELFBALANCE&quot;,
 	BASEFEE:     &quot;BASEFEE&quot;,
 	BLOBHASH:    &quot;BLOBHASH&quot;,
<span class="term-fg32">+	BLOBBASEFEE: &quot;BLOBBASEFEE&quot;,</span>
&nbsp;
 	&#47;&#47; 0x50 range - &#39;storage&#39; and execution.
 	POP:      &quot;POP&quot;,
<span class="term-fg36">@@ -444,6 +446,7 @@</span> 	&quot;CALLDATACOPY&quot;:   CALLDATACOPY,
 	&quot;CHAINID&quot;:        CHAINID,
 	&quot;BASEFEE&quot;:        BASEFEE,
 	&quot;BLOBHASH&quot;:       BLOBHASH,
<span class="term-fg32">+	&quot;BLOBBASEFEE&quot;:    BLOBBASEFEE,</span>
 	&quot;DELEGATECALL&quot;:   DELEGATECALL,
 	&quot;STATICCALL&quot;:     STATICCALL,
 	&quot;CODESIZE&quot;:       CODESIZE,</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-7510bdc18de256e92452e01f" role="button"
                   aria-expanded="false" aria-controls="id-7510bdc18de256e92452e01f">
                    <code>core/vm/runtime/env.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/3f40e65c484486dea6cff80b7db178985d21a2c6/core/vm/runtime/env.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/650bb2f2b1dcfe30d9b1fa6f7dc9608055ed60e1/core/vm/runtime/env.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+1</span></div>
                        <div class="text-start"><span class="text-danger">-0</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-7510bdc18de256e92452e01f"><span class="term-fg1">diff --git go-ethereum&#47;core&#47;vm&#47;runtime&#47;env.go op-geth&#47;core&#47;vm&#47;runtime&#47;env.go</span>
<span class="term-fg1">index 7e330e0732a8df425707c247d1f2a8c9663e67bb..64aa550a25032526287f6f8c1ca63989eae5ba61 100644</span>
<span class="term-fg1">--- go-ethereum&#47;core&#47;vm&#47;runtime&#47;env.go</span>
<span class="term-fg1">+++ op-geth&#47;core&#47;vm&#47;runtime&#47;env.go</span>
<span class="term-fg36">@@ -37,6 +37,7 @@</span> 		Time:        cfg.Time,
 		Difficulty:  cfg.Difficulty,
 		GasLimit:    cfg.GasLimit,
 		BaseFee:     cfg.BaseFee,
<span class="term-fg32">+		BlobBaseFee: cfg.BlobBaseFee,</span>
 		Random:      cfg.Random,
 	}
</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-b1bdfffa7d5c3b65373e672d" role="button"
                   aria-expanded="false" aria-controls="id-b1bdfffa7d5c3b65373e672d">
                    <code>core/vm/runtime/runtime.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/3f40e65c484486dea6cff80b7db178985d21a2c6/core/vm/runtime/runtime.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/650bb2f2b1dcfe30d9b1fa6f7dc9608055ed60e1/core/vm/runtime/runtime.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+4</span></div>
                        <div class="text-start"><span class="text-danger">-0</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-b1bdfffa7d5c3b65373e672d"><span class="term-fg1">diff --git go-ethereum&#47;core&#47;vm&#47;runtime&#47;runtime.go op-geth&#47;core&#47;vm&#47;runtime&#47;runtime.go</span>
<span class="term-fg1">index 480e5cec67970704e032a2ff52f13178792cb829..cfd7e4dbc4ee3b8b3a47436c2bfa188f1abc9174 100644</span>
<span class="term-fg1">--- go-ethereum&#47;core&#47;vm&#47;runtime&#47;runtime.go</span>
<span class="term-fg1">+++ op-geth&#47;core&#47;vm&#47;runtime&#47;runtime.go</span>
<span class="term-fg36">@@ -44,6 +44,7 @@</span> 	Value       *big.Int
 	Debug       bool
 	EVMConfig   vm.Config
 	BaseFee     *big.Int
<span class="term-fg32">+	BlobBaseFee *big.Int</span>
 	BlobHashes  []common.Hash
 	Random      *common.Hash
&nbsp;
<span class="term-fg36">@@ -94,6 +95,9 @@</span> 		}
 	}
 	if cfg.BaseFee == nil {
 		cfg.BaseFee = big.NewInt(params.InitialBaseFee)
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	if cfg.BlobBaseFee == nil {</span>
<span class="term-fg32">+		cfg.BlobBaseFee = new(big.Int)</span>
 	}
 }
</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-d3498cf718c8fd1d16323297" role="button"
                   aria-expanded="false" aria-controls="id-d3498cf718c8fd1d16323297">
                    <code>eth/catalyst/api_test.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/3f40e65c484486dea6cff80b7db178985d21a2c6/eth/catalyst/api_test.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/650bb2f2b1dcfe30d9b1fa6f7dc9608055ed60e1/eth/catalyst/api_test.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+6</span></div>
                        <div class="text-start"><span class="text-danger">-1</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-d3498cf718c8fd1d16323297"><span class="term-fg1">diff --git go-ethereum&#47;eth&#47;catalyst&#47;api_test.go op-geth&#47;eth&#47;catalyst&#47;api_test.go</span>
<span class="term-fg1">index 59f44fafea4e0273b5db5b81b1609526e77c9d05..116bca1af9e14a40ab0031fd1b88161e8316360e 100644</span>
<span class="term-fg1">--- go-ethereum&#47;eth&#47;catalyst&#47;api_test.go</span>
<span class="term-fg1">+++ op-geth&#47;eth&#47;catalyst&#47;api_test.go</span>
<span class="term-fg36">@@ -437,6 +437,11 @@</span> }
&nbsp;
 &#47;&#47; startEthService creates a full node instance for testing.
 func startEthService(t *testing.T, genesis *core.Genesis, blocks []*types.Block) (*node.Node, *eth.Ethereum) {
<span class="term-fg32">+	ethcfg := &amp;ethconfig.Config{Genesis: genesis, SyncMode: downloader.FullSync, TrieTimeout: time.Minute, TrieDirtyCache: 256, TrieCleanCache: 256}</span>
<span class="term-fg32">+	return startEthServiceWithConfigFn(t, blocks, ethcfg)</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func startEthServiceWithConfigFn(t *testing.T, blocks []*types.Block, ethcfg *ethconfig.Config) (*node.Node, *eth.Ethereum) {</span>
 	t.Helper()
&nbsp;
 	n, err := node.New(&amp;node.Config{
<span class="term-fg36">@@ -449,7 +454,7 @@</span> 	if err != nil {
 		t.Fatal(&quot;can&#39;t create node:&quot;, err)
 	}
&nbsp;
<span class="term-fg31">-	ethcfg := &amp;ethconfig.Config{Genesis: genesis, SyncMode: downloader.FullSync, TrieTimeout: time.Minute, TrieDirtyCache: 256, TrieCleanCache: 256}</span>
<span class="term-fg32">+	&#47;&#47; default eth config is moved to startEthService</span>
 	ethservice, err := eth.New(n, ethcfg)
 	if err != nil {
 		t.Fatal(&quot;can&#39;t create eth service:&quot;, err)</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-f2d7698c5d979712f8cf6556" role="button"
                   aria-expanded="false" aria-controls="id-f2d7698c5d979712f8cf6556">
                    <code>eth/catalyst/simulated_beacon.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/3f40e65c484486dea6cff80b7db178985d21a2c6/eth/catalyst/simulated_beacon.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/650bb2f2b1dcfe30d9b1fa6f7dc9608055ed60e1/eth/catalyst/simulated_beacon.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+1</span></div>
                        <div class="text-start"><span class="text-danger">-1</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-f2d7698c5d979712f8cf6556"><span class="term-fg1">diff --git go-ethereum&#47;eth&#47;catalyst&#47;simulated_beacon.go op-geth&#47;eth&#47;catalyst&#47;simulated_beacon.go</span>
<span class="term-fg1">index 1f7a3266cd1a8315d739f76c2c8ebb270be6c4a1..a9a2bb4a9a7b8c6be89efe077c68e11b15e916ab 100644</span>
<span class="term-fg1">--- go-ethereum&#47;eth&#47;catalyst&#47;simulated_beacon.go</span>
<span class="term-fg1">+++ op-geth&#47;eth&#47;catalyst&#47;simulated_beacon.go</span>
<span class="term-fg36">@@ -199,7 +199,7 @@</span> &#47;&#47; loopOnDemand runs the block production loop for &quot;on-demand&quot; configuration (period = 0)
 func (c *SimulatedBeacon) loopOnDemand() {
 	var (
 		newTxs = make(chan core.NewTxsEvent)
<span class="term-fg31">-		sub    = c.eth.TxPool().SubscribeNewTxsEvent(newTxs)</span>
<span class="term-fg32">+		sub    = c.eth.TxPool().SubscribeTransactions(newTxs, true)</span>
 	)
 	defer sub.Unsubscribe()
</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-9e089d3ec842907c3464341c" role="button"
                   aria-expanded="false" aria-controls="id-9e089d3ec842907c3464341c">
                    <code>eth/catalyst/superchain_test.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <span class="text-muted">(new)</span>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/650bb2f2b1dcfe30d9b1fa6f7dc9608055ed60e1/eth/catalyst/superchain_test.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+120</span></div>
                        <div class="text-start"><span class="text-danger">-0</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-9e089d3ec842907c3464341c"><span class="term-fg1">diff --git go-ethereum&#47;eth&#47;catalyst&#47;superchain_test.go op-geth&#47;eth&#47;catalyst&#47;superchain_test.go</span>
<span class="term-fg1">new file mode 100644</span>
<span class="term-fg1">index 0000000000000000000000000000000000000000..4fd46a4c1257c38998878071ef618a71849e6d6e</span>
<span class="term-fg1">--- &#47;dev&#47;null</span>
<span class="term-fg1">+++ op-geth&#47;eth&#47;catalyst&#47;superchain_test.go</span>
<span class="term-fg36">@@ -0,0 +1,120 @@</span>
<span class="term-fg32">+package catalyst</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+import (</span>
<span class="term-fg32">+	&quot;testing&quot;</span>
<span class="term-fg32">+	&quot;time&quot;</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;eth&#47;downloader&quot;</span>
<span class="term-fg32">+	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;eth&#47;ethconfig&quot;</span>
<span class="term-fg32">+	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;node&quot;</span>
<span class="term-fg32">+	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;params&quot;</span>
<span class="term-fg32">+)</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func TestSignalSuperchainV1(t *testing.T) {</span>
<span class="term-fg32">+	genesis, preMergeBlocks := generateMergeChain(2, false)</span>
<span class="term-fg32">+	n, ethservice := startEthService(t, genesis, preMergeBlocks)</span>
<span class="term-fg32">+	defer n.Close()</span>
<span class="term-fg32">+	api := NewConsensusAPI(ethservice)</span>
<span class="term-fg32">+	t.Run(&quot;matching&quot;, func(t *testing.T) {</span>
<span class="term-fg32">+		out, err := api.SignalSuperchainV1(&amp;SuperchainSignal{</span>
<span class="term-fg32">+			Recommended: params.OPStackSupport,</span>
<span class="term-fg32">+			Required:    params.OPStackSupport,</span>
<span class="term-fg32">+		})</span>
<span class="term-fg32">+		if err != nil {</span>
<span class="term-fg32">+			t.Fatalf(&quot;failed to process signal: %v&quot;, err)</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+		if out != params.OPStackSupport {</span>
<span class="term-fg32">+			t.Fatalf(&quot;expected %s but got %s&quot;, params.OPStackSupport, out)</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+	})</span>
<span class="term-fg32">+	t.Run(&quot;null_arg&quot;, func(t *testing.T) {</span>
<span class="term-fg32">+		out, err := api.SignalSuperchainV1(nil)</span>
<span class="term-fg32">+		if err != nil {</span>
<span class="term-fg32">+			t.Fatalf(&quot;failed to process signal: %v&quot;, err)</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+		if out != params.OPStackSupport {</span>
<span class="term-fg32">+			t.Fatalf(&quot;expected %s but got %s&quot;, params.OPStackSupport, out)</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+	})</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func TestSignalSuperchainV1Halt(t *testing.T) {</span>
<span class="term-fg32">+	&#47;&#47; Note: depending on the params.OPStackSupport some types of bumps are not possible with active prerelease</span>
<span class="term-fg32">+	testCases := []struct {</span>
<span class="term-fg32">+		cfg  string</span>
<span class="term-fg32">+		bump string</span>
<span class="term-fg32">+		halt bool</span>
<span class="term-fg32">+	}{</span>
<span class="term-fg32">+		{&quot;none&quot;, &quot;major&quot;, false},</span>
<span class="term-fg32">+		{&quot;major&quot;, &quot;major&quot;, true},</span>
<span class="term-fg32">+		{&quot;minor&quot;, &quot;major&quot;, true},</span>
<span class="term-fg32">+		{&quot;patch&quot;, &quot;major&quot;, true},</span>
<span class="term-fg32">+		{&quot;major&quot;, &quot;minor&quot;, false},</span>
<span class="term-fg32">+		{&quot;minor&quot;, &quot;minor&quot;, true},</span>
<span class="term-fg32">+		{&quot;patch&quot;, &quot;minor&quot;, true},</span>
<span class="term-fg32">+		{&quot;major&quot;, &quot;patch&quot;, false},</span>
<span class="term-fg32">+		{&quot;minor&quot;, &quot;patch&quot;, false},</span>
<span class="term-fg32">+		{&quot;patch&quot;, &quot;patch&quot;, true},</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	for _, tc := range testCases {</span>
<span class="term-fg32">+		tc := tc</span>
<span class="term-fg32">+		t.Run(tc.cfg+&quot;_&quot;+tc.bump, func(t *testing.T) {</span>
<span class="term-fg32">+			genesis, preMergeBlocks := generateMergeChain(2, false)</span>
<span class="term-fg32">+			ethcfg := &amp;ethconfig.Config{Genesis: genesis, SyncMode: downloader.FullSync, TrieTimeout: time.Minute, TrieDirtyCache: 256, TrieCleanCache: 256}</span>
<span class="term-fg32">+			ethcfg.RollupHaltOnIncompatibleProtocolVersion = tc.cfg &#47;&#47; opt-in to halting (or not)</span>
<span class="term-fg32">+			n, ethservice := startEthServiceWithConfigFn(t, preMergeBlocks, ethcfg)</span>
<span class="term-fg32">+			defer n.Close() &#47;&#47; close at the end, regardless of any prior (failed) closing</span>
<span class="term-fg32">+			api := NewConsensusAPI(ethservice)</span>
<span class="term-fg32">+			_, build, major, minor, patch, preRelease := params.OPStackSupport.Parse()</span>
<span class="term-fg32">+			if preRelease != 0 { &#47;&#47; transform back from prerelease, so we can do a clean version bump</span>
<span class="term-fg32">+				if patch != 0 {</span>
<span class="term-fg32">+					patch -= 1</span>
<span class="term-fg32">+				} else if minor != 0 {</span>
<span class="term-fg32">+					&#47;&#47; can&#39;t patch-bump e.g. v3.1.0-1, the prerelease forces a minor bump:</span>
<span class="term-fg32">+					&#47;&#47; v3.0.999 is lower than the prerelease, v3.1.1-1 is a prerelease of v3.1.1.</span>
<span class="term-fg32">+					if tc.bump == &quot;patch&quot; {</span>
<span class="term-fg32">+						t.Skip()</span>
<span class="term-fg32">+					}</span>
<span class="term-fg32">+					minor -= 1</span>
<span class="term-fg32">+				} else if major != 0 {</span>
<span class="term-fg32">+					if tc.bump == &quot;minor&quot; || tc.bump == &quot;patch&quot; { &#47;&#47; can&#39;t minor-bump or patch-bump</span>
<span class="term-fg32">+						t.Skip()</span>
<span class="term-fg32">+					}</span>
<span class="term-fg32">+					major -= 1</span>
<span class="term-fg32">+				}</span>
<span class="term-fg32">+				preRelease = 0</span>
<span class="term-fg32">+			}</span>
<span class="term-fg32">+			majorSignal, minorSignal, patchSignal := major, minor, patch</span>
<span class="term-fg32">+			switch tc.bump {</span>
<span class="term-fg32">+			case &quot;major&quot;:</span>
<span class="term-fg32">+				majorSignal += 1</span>
<span class="term-fg32">+			case &quot;minor&quot;:</span>
<span class="term-fg32">+				minorSignal += 1</span>
<span class="term-fg32">+			case &quot;patch&quot;:</span>
<span class="term-fg32">+				patchSignal += 1</span>
<span class="term-fg32">+			}</span>
<span class="term-fg32">+			out, err := api.SignalSuperchainV1(&amp;SuperchainSignal{</span>
<span class="term-fg32">+				Recommended: params.OPStackSupport, &#47;&#47; required version change should be enough</span>
<span class="term-fg32">+				Required:    params.ProtocolVersionV0{Build: build, Major: majorSignal, Minor: minorSignal, Patch: patchSignal, PreRelease: preRelease}.Encode(),</span>
<span class="term-fg32">+			})</span>
<span class="term-fg32">+			if err != nil {</span>
<span class="term-fg32">+				t.Fatalf(&quot;failed to process signal: %v&quot;, err)</span>
<span class="term-fg32">+			}</span>
<span class="term-fg32">+			if out != params.OPStackSupport {</span>
<span class="term-fg32">+				t.Fatalf(&quot;expected %s but got %s&quot;, params.OPStackSupport, out)</span>
<span class="term-fg32">+			}</span>
<span class="term-fg32">+			closeErr := n.Close()</span>
<span class="term-fg32">+			if !tc.halt {</span>
<span class="term-fg32">+				&#47;&#47; assert no halt by closing, and not getting any error</span>
<span class="term-fg32">+				if closeErr != nil {</span>
<span class="term-fg32">+					t.Fatalf(&quot;expected not to have closed already, but just closed without error&quot;)</span>
<span class="term-fg32">+				}</span>
<span class="term-fg32">+			} else {</span>
<span class="term-fg32">+				&#47;&#47; assert halt by closing again, and seeing if we are not stopped already</span>
<span class="term-fg32">+				if closeErr != node.ErrNodeStopped {</span>
<span class="term-fg32">+					t.Fatalf(&quot;expected to have already closed and get a ErrNodeStopped error, but got %v&quot;, closeErr)</span>
<span class="term-fg32">+				}</span>
<span class="term-fg32">+			}</span>
<span class="term-fg32">+		})</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+}</span></div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-a22b1a3fa70bdec7a321b8bc" role="button"
                   aria-expanded="false" aria-controls="id-a22b1a3fa70bdec7a321b8bc">
                    <code>eth/catalyst/tester.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/3f40e65c484486dea6cff80b7db178985d21a2c6/eth/catalyst/tester.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/650bb2f2b1dcfe30d9b1fa6f7dc9608055ed60e1/eth/catalyst/tester.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+27</span></div>
                        <div class="text-start"><span class="text-danger">-27</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-a22b1a3fa70bdec7a321b8bc"><span class="term-fg1">diff --git go-ethereum&#47;eth&#47;catalyst&#47;tester.go op-geth&#47;eth&#47;catalyst&#47;tester.go</span>
<span class="term-fg1">index 3e9159a175348fe6738a18467eaa30117db9ed04..0922ac0ba654541a62c3d2d4b13cb0fc3efb0b3f 100644</span>
<span class="term-fg1">--- go-ethereum&#47;eth&#47;catalyst&#47;tester.go</span>
<span class="term-fg1">+++ op-geth&#47;eth&#47;catalyst&#47;tester.go</span>
<span class="term-fg36">@@ -20,7 +20,7 @@</span> import (
 	&quot;sync&quot;
 	&quot;time&quot;
&nbsp;
<span class="term-fg31">-	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;core&#47;types&quot;</span>
<span class="term-fg32">+	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;common&quot;</span>
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;eth&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;eth&#47;downloader&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;log&quot;
<span class="term-fg36">@@ -28,23 +28,27 @@</span> 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;node&quot;
 )
&nbsp;
 &#47;&#47; FullSyncTester is an auxiliary service that allows Geth to perform full sync
<span class="term-fg31">-&#47;&#47; alone without consensus-layer attached. Users must specify a valid block as</span>
<span class="term-fg31">-&#47;&#47; the sync target. This tester can be applied to different networks, no matter</span>
<span class="term-fg31">-&#47;&#47; it&#39;s pre-merge or post-merge, but only for full-sync.</span>
<span class="term-fg32">+&#47;&#47; alone without consensus-layer attached. Users must specify a valid block hash</span>
<span class="term-fg32">+&#47;&#47; as the sync target.</span>
<span class="term-fg32">+&#47;&#47;</span>
<span class="term-fg32">+&#47;&#47; This tester can be applied to different networks, no matter it&#39;s pre-merge or</span>
<span class="term-fg32">+&#47;&#47; post-merge, but only for full-sync.</span>
 type FullSyncTester struct {
<span class="term-fg31">-	api    *ConsensusAPI</span>
<span class="term-fg31">-	block  *types.Block</span>
<span class="term-fg31">-	closed chan struct{}</span>
<span class="term-fg31">-	wg     sync.WaitGroup</span>
<span class="term-fg32">+	stack   *node.Node</span>
<span class="term-fg32">+	backend *eth.Ethereum</span>
<span class="term-fg32">+	target  common.Hash</span>
<span class="term-fg32">+	closed  chan struct{}</span>
<span class="term-fg32">+	wg      sync.WaitGroup</span>
 }
&nbsp;
 &#47;&#47; RegisterFullSyncTester registers the full-sync tester service into the node
 &#47;&#47; stack for launching and stopping the service controlled by node.
<span class="term-fg31">-func RegisterFullSyncTester(stack *node.Node, backend *eth.Ethereum, block *types.Block) (*FullSyncTester, error) {</span>
<span class="term-fg32">+func RegisterFullSyncTester(stack *node.Node, backend *eth.Ethereum, target common.Hash) (*FullSyncTester, error) {</span>
 	cl := &amp;FullSyncTester{
<span class="term-fg31">-		api:    newConsensusAPIWithoutHeartbeat(backend),</span>
<span class="term-fg31">-		block:  block,</span>
<span class="term-fg31">-		closed: make(chan struct{}),</span>
<span class="term-fg32">+		stack:   stack,</span>
<span class="term-fg32">+		backend: backend,</span>
<span class="term-fg32">+		target:  target,</span>
<span class="term-fg32">+		closed:  make(chan struct{}),</span>
 	}
 	stack.RegisterLifecycle(cl)
 	return cl, nil
<span class="term-fg36">@@ -56,28 +60,24 @@</span> 	tester.wg.Add(1)
 	go func() {
 		defer tester.wg.Done()
&nbsp;
<span class="term-fg32">+		&#47;&#47; Trigger beacon sync with the provided block hash as trusted</span>
<span class="term-fg32">+		&#47;&#47; chain head.</span>
<span class="term-fg32">+		err := tester.backend.Downloader().BeaconDevSync(downloader.FullSync, tester.target, tester.closed)</span>
<span class="term-fg32">+		if err != nil {</span>
<span class="term-fg32">+			log.Info(&quot;Failed to trigger beacon sync&quot;, &quot;err&quot;, err)</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+</span>
 		ticker := time.NewTicker(time.Second * 5)
 		defer ticker.Stop()
&nbsp;
 		for {
 			select {
 			case &lt;-ticker.C:
<span class="term-fg31">-				&#47;&#47; Don&#39;t bother downloader in case it&#39;s already syncing.</span>
<span class="term-fg31">-				if tester.api.eth.Downloader().Synchronising() {</span>
<span class="term-fg31">-					continue</span>
<span class="term-fg31">-				}</span>
<span class="term-fg31">-				&#47;&#47; Short circuit in case the target block is already stored</span>
<span class="term-fg31">-				&#47;&#47; locally. TODO(somehow terminate the node stack if target</span>
<span class="term-fg31">-				&#47;&#47; is reached).</span>
<span class="term-fg31">-				if tester.api.eth.BlockChain().HasBlock(tester.block.Hash(), tester.block.NumberU64()) {</span>
<span class="term-fg31">-					log.Info(&quot;Full-sync target reached&quot;, &quot;number&quot;, tester.block.NumberU64(), &quot;hash&quot;, tester.block.Hash())</span>
<span class="term-fg32">+				&#47;&#47; Stop in case the target block is already stored locally.</span>
<span class="term-fg32">+				if block := tester.backend.BlockChain().GetBlockByHash(tester.target); block != nil {</span>
<span class="term-fg32">+					log.Info(&quot;Full-sync target reached&quot;, &quot;number&quot;, block.NumberU64(), &quot;hash&quot;, block.Hash())</span>
<span class="term-fg32">+					go tester.stack.Close() &#47;&#47; async since we need to close ourselves</span>
 					return
<span class="term-fg31">-				}</span>
<span class="term-fg31">-				&#47;&#47; Trigger beacon sync with the provided block header as</span>
<span class="term-fg31">-				&#47;&#47; trusted chain head.</span>
<span class="term-fg31">-				err := tester.api.eth.Downloader().BeaconSync(downloader.FullSync, tester.block.Header(), tester.block.Header())</span>
<span class="term-fg31">-				if err != nil {</span>
<span class="term-fg31">-					log.Info(&quot;Failed to beacon sync&quot;, &quot;err&quot;, err)</span>
 				}
&nbsp;
 			case &lt;-tester.closed:</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-dfe03dcb985a7d7cf11652d4" role="button"
                   aria-expanded="false" aria-controls="id-dfe03dcb985a7d7cf11652d4">
                    <code>eth/downloader/beacondevsync.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <span class="text-muted">(new)</span>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/650bb2f2b1dcfe30d9b1fa6f7dc9608055ed60e1/eth/downloader/beacondevsync.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+81</span></div>
                        <div class="text-start"><span class="text-danger">-0</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-dfe03dcb985a7d7cf11652d4"><span class="term-fg1">diff --git go-ethereum&#47;eth&#47;downloader&#47;beacondevsync.go op-geth&#47;eth&#47;downloader&#47;beacondevsync.go</span>
<span class="term-fg1">new file mode 100644</span>
<span class="term-fg1">index 0000000000000000000000000000000000000000..9a38fedd463e0ea8f5505992ae547105aa3b11ef</span>
<span class="term-fg1">--- &#47;dev&#47;null</span>
<span class="term-fg1">+++ op-geth&#47;eth&#47;downloader&#47;beacondevsync.go</span>
<span class="term-fg36">@@ -0,0 +1,81 @@</span>
<span class="term-fg32">+&#47;&#47; Copyright 2023 The go-ethereum Authors</span>
<span class="term-fg32">+&#47;&#47; This file is part of the go-ethereum library.</span>
<span class="term-fg32">+&#47;&#47;</span>
<span class="term-fg32">+&#47;&#47; The go-ethereum library is free software: you can redistribute it and&#47;or modify</span>
<span class="term-fg32">+&#47;&#47; it under the terms of the GNU Lesser General Public License as published by</span>
<span class="term-fg32">+&#47;&#47; the Free Software Foundation, either version 3 of the License, or</span>
<span class="term-fg32">+&#47;&#47; (at your option) any later version.</span>
<span class="term-fg32">+&#47;&#47;</span>
<span class="term-fg32">+&#47;&#47; The go-ethereum library is distributed in the hope that it will be useful,</span>
<span class="term-fg32">+&#47;&#47; but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="term-fg32">+&#47;&#47; MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the</span>
<span class="term-fg32">+&#47;&#47; GNU Lesser General Public License for more details.</span>
<span class="term-fg32">+&#47;&#47;</span>
<span class="term-fg32">+&#47;&#47; You should have received a copy of the GNU Lesser General Public License</span>
<span class="term-fg32">+&#47;&#47; along with the go-ethereum library. If not, see &lt;http:&#47;&#47;www.gnu.org&#47;licenses&#47;&gt;.</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+package downloader</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+import (</span>
<span class="term-fg32">+	&quot;errors&quot;</span>
<span class="term-fg32">+	&quot;time&quot;</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;common&quot;</span>
<span class="term-fg32">+	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;log&quot;</span>
<span class="term-fg32">+)</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+&#47;&#47; BeaconDevSync is a development helper to test synchronization by providing</span>
<span class="term-fg32">+&#47;&#47; a block hash instead of header to run the beacon sync against.</span>
<span class="term-fg32">+&#47;&#47;</span>
<span class="term-fg32">+&#47;&#47; The method will reach out to the network to retrieve the header of the sync</span>
<span class="term-fg32">+&#47;&#47; target instead of receiving it from the consensus node.</span>
<span class="term-fg32">+&#47;&#47;</span>
<span class="term-fg32">+&#47;&#47; Note, this must not be used in live code. If the forkchcoice endpoint where</span>
<span class="term-fg32">+&#47;&#47; to use this instead of giving us the payload first, then essentially nobody</span>
<span class="term-fg32">+&#47;&#47; in the network would have the block yet that we&#39;d attempt to retrieve.</span>
<span class="term-fg32">+func (d *Downloader) BeaconDevSync(mode SyncMode, hash common.Hash, stop chan struct{}) error {</span>
<span class="term-fg32">+	&#47;&#47; Be very loud that this code should not be used in a live node</span>
<span class="term-fg32">+	log.Warn(&quot;----------------------------------&quot;)</span>
<span class="term-fg32">+	log.Warn(&quot;Beacon syncing with hash as target&quot;, &quot;hash&quot;, hash)</span>
<span class="term-fg32">+	log.Warn(&quot;This is unhealthy for a live node!&quot;)</span>
<span class="term-fg32">+	log.Warn(&quot;----------------------------------&quot;)</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	log.Info(&quot;Waiting for peers to retrieve sync target&quot;)</span>
<span class="term-fg32">+	for {</span>
<span class="term-fg32">+		&#47;&#47; If the node is going down, unblock</span>
<span class="term-fg32">+		select {</span>
<span class="term-fg32">+		case &lt;-stop:</span>
<span class="term-fg32">+			return errors.New(&quot;stop requested&quot;)</span>
<span class="term-fg32">+		default:</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+		&#47;&#47; Pick a random peer to sync from and keep retrying if none are yet</span>
<span class="term-fg32">+		&#47;&#47; available due to fresh startup</span>
<span class="term-fg32">+		d.peers.lock.RLock()</span>
<span class="term-fg32">+		var peer *peerConnection</span>
<span class="term-fg32">+		for _, peer = range d.peers.peers {</span>
<span class="term-fg32">+			break</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+		d.peers.lock.RUnlock()</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+		if peer == nil {</span>
<span class="term-fg32">+			time.Sleep(time.Second)</span>
<span class="term-fg32">+			continue</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+		&#47;&#47; Found a peer, attempt to retrieve the header whilst blocking and</span>
<span class="term-fg32">+		&#47;&#47; retry if it fails for whatever reason</span>
<span class="term-fg32">+		log.Info(&quot;Attempting to retrieve sync target&quot;, &quot;peer&quot;, peer.id)</span>
<span class="term-fg32">+		headers, metas, err := d.fetchHeadersByHash(peer, hash, 1, 0, false)</span>
<span class="term-fg32">+		if err != nil || len(headers) != 1 {</span>
<span class="term-fg32">+			log.Warn(&quot;Failed to fetch sync target&quot;, &quot;headers&quot;, len(headers), &quot;err&quot;, err)</span>
<span class="term-fg32">+			time.Sleep(time.Second)</span>
<span class="term-fg32">+			continue</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+		&#47;&#47; Head header retrieved, if the hash matches, start the actual sync</span>
<span class="term-fg32">+		if metas[0] != hash {</span>
<span class="term-fg32">+			log.Error(&quot;Received invalid sync target&quot;, &quot;want&quot;, hash, &quot;have&quot;, metas[0])</span>
<span class="term-fg32">+			time.Sleep(time.Second)</span>
<span class="term-fg32">+			continue</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+		return d.BeaconSync(mode, headers[0], headers[0])</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+}</span></div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-38b8ae7d3828a03bf62deaa4" role="button"
                   aria-expanded="false" aria-controls="id-38b8ae7d3828a03bf62deaa4">
                    <code>eth/downloader/downloader.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/3f40e65c484486dea6cff80b7db178985d21a2c6/eth/downloader/downloader.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/650bb2f2b1dcfe30d9b1fa6f7dc9608055ed60e1/eth/downloader/downloader.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+5</span></div>
                        <div class="text-start"><span class="text-danger">-64</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-38b8ae7d3828a03bf62deaa4"><span class="term-fg1">diff --git go-ethereum&#47;eth&#47;downloader&#47;downloader.go op-geth&#47;eth&#47;downloader&#47;downloader.go</span>
<span class="term-fg1">index 1e4f35ccd1987fdacef7447dd57109f039de64a7..2ca7e328c6c47646e752538551d61b62ed2cd8f0 100644</span>
<span class="term-fg1">--- go-ethereum&#47;eth&#47;downloader&#47;downloader.go</span>
<span class="term-fg1">+++ op-geth&#47;eth&#47;downloader&#47;downloader.go</span>
<span class="term-fg36">@@ -286,11 +286,6 @@</span> 		HealingBytecode:     pending.BytecodeHeal,
 	}
 }
&nbsp;
<span class="term-fg31">-&#47;&#47; Synchronising returns whether the downloader is currently retrieving blocks.</span>
<span class="term-fg31">-func (d *Downloader) Synchronising() bool {</span>
<span class="term-fg31">-	return d.synchronising.Load()</span>
<span class="term-fg31">-}</span>
<span class="term-fg31">-</span>
 &#47;&#47; RegisterPeer injects a new download peer into the set of block source to be
 &#47;&#47; used for fetching hashes and blocks from.
 func (d *Downloader) RegisterPeer(id string, version uint, peer Peer) error {
<span class="term-fg36">@@ -307,11 +302,6 @@</span> 		logger.Error(&quot;Failed to register sync peer&quot;, &quot;err&quot;, err)
 		return err
 	}
 	return nil
<span class="term-fg31">-}</span>
<span class="term-fg31">-</span>
<span class="term-fg31">-&#47;&#47; RegisterLightPeer injects a light client peer, wrapping it so it appears as a regular peer.</span>
<span class="term-fg31">-func (d *Downloader) RegisterLightPeer(id string, version uint, peer LightPeer) error {</span>
<span class="term-fg31">-	return d.RegisterPeer(id, version, &amp;lightPeerWrapper{peer})</span>
 }
&nbsp;
 &#47;&#47; UnregisterPeer remove a peer from the known list, preventing any action from
<span class="term-fg36">@@ -403,7 +393,9 @@</span> 		&#47;&#47; trie database unusable until the state is fully synced. To prevent any
 		&#47;&#47; subsequent state reads, explicitly disable the trie database and state
 		&#47;&#47; syncer is responsible to address and correct any state missing.
 		if d.blockchain.TrieDB().Scheme() == rawdb.PathScheme {
<span class="term-fg31">-			d.blockchain.TrieDB().Reset(types.EmptyRootHash)</span>
<span class="term-fg32">+			if err := d.blockchain.TrieDB().Disable(); err != nil {</span>
<span class="term-fg32">+				return err</span>
<span class="term-fg32">+			}</span>
 		}
 		&#47;&#47; Snap sync uses the snapshot namespace to store potentially flaky data until
 		&#47;&#47; sync completely heals and finishes. Pause snapshot maintenance in the mean-
<span class="term-fg36">@@ -1280,41 +1272,13 @@</span> &#47;&#47; processHeaders takes batches of retrieved headers from an input channel and
 &#47;&#47; keeps processing and scheduling them into the header chain and downloader&#39;s
 &#47;&#47; queue until the stream ends or a failure occurs.
 func (d *Downloader) processHeaders(origin uint64, td, ttd *big.Int, beaconMode bool) error {
<span class="term-fg31">-	&#47;&#47; Keep a count of uncertain headers to roll back</span>
 	var (
<span class="term-fg31">-		rollback    uint64 &#47;&#47; Zero means no rollback (fine as you can&#39;t unroll the genesis)</span>
<span class="term-fg31">-		rollbackErr error</span>
<span class="term-fg31">-		mode        = d.getMode()</span>
<span class="term-fg32">+		mode       = d.getMode()</span>
<span class="term-fg32">+		gotHeaders = false &#47;&#47; Wait for batches of headers to process</span>
 	)
<span class="term-fg31">-	defer func() {</span>
<span class="term-fg31">-		if rollback &gt; 0 {</span>
<span class="term-fg31">-			lastHeader, lastFastBlock, lastBlock := d.lightchain.CurrentHeader().Number, common.Big0, common.Big0</span>
<span class="term-fg31">-			if mode != LightSync {</span>
<span class="term-fg31">-				lastFastBlock = d.blockchain.CurrentSnapBlock().Number</span>
<span class="term-fg31">-				lastBlock = d.blockchain.CurrentBlock().Number</span>
<span class="term-fg31">-			}</span>
<span class="term-fg31">-			if err := d.lightchain.SetHead(rollback - 1); err != nil { &#47;&#47; -1 to target the parent of the first uncertain block</span>
<span class="term-fg31">-				&#47;&#47; We&#39;re already unwinding the stack, only print the error to make it more visible</span>
<span class="term-fg31">-				log.Error(&quot;Failed to roll back chain segment&quot;, &quot;head&quot;, rollback-1, &quot;err&quot;, err)</span>
<span class="term-fg31">-			}</span>
<span class="term-fg31">-			curFastBlock, curBlock := common.Big0, common.Big0</span>
<span class="term-fg31">-			if mode != LightSync {</span>
<span class="term-fg31">-				curFastBlock = d.blockchain.CurrentSnapBlock().Number</span>
<span class="term-fg31">-				curBlock = d.blockchain.CurrentBlock().Number</span>
<span class="term-fg31">-			}</span>
<span class="term-fg31">-			log.Warn(&quot;Rolled back chain segment&quot;,</span>
<span class="term-fg31">-				&quot;header&quot;, fmt.Sprintf(&quot;%d-&gt;%d&quot;, lastHeader, d.lightchain.CurrentHeader().Number),</span>
<span class="term-fg31">-				&quot;snap&quot;, fmt.Sprintf(&quot;%d-&gt;%d&quot;, lastFastBlock, curFastBlock),</span>
<span class="term-fg31">-				&quot;block&quot;, fmt.Sprintf(&quot;%d-&gt;%d&quot;, lastBlock, curBlock), &quot;reason&quot;, rollbackErr)</span>
<span class="term-fg31">-		}</span>
<span class="term-fg31">-	}()</span>
<span class="term-fg31">-	&#47;&#47; Wait for batches of headers to process</span>
<span class="term-fg31">-	gotHeaders := false</span>
<span class="term-fg31">-</span>
 	for {
 		select {
 		case &lt;-d.cancelCh:
<span class="term-fg31">-			rollbackErr = errCanceled</span>
 			return errCanceled
&nbsp;
 		case task := &lt;-d.headerProcCh:
<span class="term-fg36">@@ -1363,8 +1327,6 @@</span> 							return errStallingPeer
 						}
 					}
 				}
<span class="term-fg31">-				&#47;&#47; Disable any rollback and return</span>
<span class="term-fg31">-				rollback = 0</span>
 				return nil
 			}
 			&#47;&#47; Otherwise split the chunk of headers into batches and process them
<span class="term-fg36">@@ -1375,7 +1337,6 @@</span> 			for len(headers) &gt; 0 {
 				&#47;&#47; Terminate if something failed in between processing chunks
 				select {
 				case &lt;-d.cancelCh:
<span class="term-fg31">-					rollbackErr = errCanceled</span>
 					return errCanceled
 				default:
 				}
<span class="term-fg36">@@ -1422,29 +1383,11 @@</span> 						}
 					}
 					if len(chunkHeaders) &gt; 0 {
 						if n, err := d.lightchain.InsertHeaderChain(chunkHeaders); err != nil {
<span class="term-fg31">-							rollbackErr = err</span>
<span class="term-fg31">-</span>
<span class="term-fg31">-							&#47;&#47; If some headers were inserted, track them as uncertain</span>
<span class="term-fg31">-							if mode == SnapSync &amp;&amp; n &gt; 0 &amp;&amp; rollback == 0 {</span>
<span class="term-fg31">-								rollback = chunkHeaders[0].Number.Uint64()</span>
<span class="term-fg31">-							}</span>
 							log.Warn(&quot;Invalid header encountered&quot;, &quot;number&quot;, chunkHeaders[n].Number, &quot;hash&quot;, chunkHashes[n], &quot;parent&quot;, chunkHeaders[n].ParentHash, &quot;err&quot;, err)
 							return fmt.Errorf(&quot;%w: %v&quot;, errInvalidChain, err)
 						}
<span class="term-fg31">-						&#47;&#47; All verifications passed, track all headers within the allowed limits</span>
<span class="term-fg31">-						if mode == SnapSync {</span>
<span class="term-fg31">-							head := chunkHeaders[len(chunkHeaders)-1].Number.Uint64()</span>
<span class="term-fg31">-							if head-rollback &gt; uint64(fsHeaderSafetyNet) {</span>
<span class="term-fg31">-								rollback = head - uint64(fsHeaderSafetyNet)</span>
<span class="term-fg31">-							} else {</span>
<span class="term-fg31">-								rollback = 1</span>
<span class="term-fg31">-							}</span>
<span class="term-fg31">-						}</span>
 					}
 					if len(rejected) != 0 {
<span class="term-fg31">-						&#47;&#47; Merge threshold reached, stop importing, but don&#39;t roll back</span>
<span class="term-fg31">-						rollback = 0</span>
<span class="term-fg31">-</span>
 						log.Info(&quot;Legacy sync reached merge threshold&quot;, &quot;number&quot;, rejected[0].Number, &quot;hash&quot;, rejected[0].Hash(), &quot;td&quot;, td, &quot;ttd&quot;, ttd)
 						return ErrMergeTransition
 					}
<span class="term-fg36">@@ -1455,7 +1398,6 @@</span> 					&#47;&#47; If we&#39;ve reached the allowed number of pending headers, stall a bit
 					for d.queue.PendingBodies() &gt;= maxQueuedHeaders || d.queue.PendingReceipts() &gt;= maxQueuedHeaders {
 						select {
 						case &lt;-d.cancelCh:
<span class="term-fg31">-							rollbackErr = errCanceled</span>
 							return errCanceled
 						case &lt;-time.After(time.Second):
 						}
<span class="term-fg36">@@ -1463,7 +1405,6 @@</span> 					}
 					&#47;&#47; Otherwise insert the headers for content retrieval
 					inserts := d.queue.Schedule(chunkHeaders, chunkHashes, origin)
 					if len(inserts) != len(chunkHeaders) {
<span class="term-fg31">-						rollbackErr = fmt.Errorf(&quot;stale headers: len inserts %v len(chunk) %v&quot;, len(inserts), len(chunkHeaders))</span>
 						return fmt.Errorf(&quot;%w: stale headers&quot;, errBadPeer)
 					}
 				}</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-636d132cf965c85961a33df6" role="button"
                   aria-expanded="false" aria-controls="id-636d132cf965c85961a33df6">
                    <code>eth/downloader/downloader_test.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/3f40e65c484486dea6cff80b7db178985d21a2c6/eth/downloader/downloader_test.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/650bb2f2b1dcfe30d9b1fa6f7dc9608055ed60e1/eth/downloader/downloader_test.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+69</span></div>
                        <div class="text-start"><span class="text-danger">-147</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-636d132cf965c85961a33df6"><span class="term-fg1">diff --git go-ethereum&#47;eth&#47;downloader&#47;downloader_test.go op-geth&#47;eth&#47;downloader&#47;downloader_test.go</span>
<span class="term-fg1">index 06c22afff092cd5148ea57d17df918fd6b9eba20..e4875b959a37707579f0cc78dbf62029e87ecbe0 100644</span>
<span class="term-fg1">--- go-ethereum&#47;eth&#47;downloader&#47;downloader_test.go</span>
<span class="term-fg1">+++ op-geth&#47;eth&#47;downloader&#47;downloader_test.go</span>
<span class="term-fg36">@@ -177,7 +177,7 @@</span> &#47;&#47; origin; associated with a particular peer in the download tester. The returned
 &#47;&#47; function can be used to retrieve batches of headers from the particular peer.
 func (dlp *downloadTesterPeer) RequestHeadersByHash(origin common.Hash, amount int, skip int, reverse bool, sink chan *eth.Response) (*eth.Request, error) {
 	&#47;&#47; Service the header query via the live handler code
<span class="term-fg31">-	rlpHeaders := eth.ServiceGetBlockHeadersQuery(dlp.chain, &amp;eth.GetBlockHeadersPacket{</span>
<span class="term-fg32">+	rlpHeaders := eth.ServiceGetBlockHeadersQuery(dlp.chain, &amp;eth.GetBlockHeadersRequest{</span>
 		Origin: eth.HashOrNumber{
 			Hash: origin,
 		},
<span class="term-fg36">@@ -205,7 +205,7 @@</span> 		Peer: dlp.id,
 	}
 	res := &amp;eth.Response{
 		Req:  req,
<span class="term-fg31">-		Res:  (*eth.BlockHeadersPacket)(&amp;headers),</span>
<span class="term-fg32">+		Res:  (*eth.BlockHeadersRequest)(&amp;headers),</span>
 		Meta: hashes,
 		Time: 1,
 		Done: make(chan error, 1), &#47;&#47; Ignore the returned status
<span class="term-fg36">@@ -221,7 +221,7 @@</span> &#47;&#47; origin; associated with a particular peer in the download tester. The returned
 &#47;&#47; function can be used to retrieve batches of headers from the particular peer.
 func (dlp *downloadTesterPeer) RequestHeadersByNumber(origin uint64, amount int, skip int, reverse bool, sink chan *eth.Response) (*eth.Request, error) {
 	&#47;&#47; Service the header query via the live handler code
<span class="term-fg31">-	rlpHeaders := eth.ServiceGetBlockHeadersQuery(dlp.chain, &amp;eth.GetBlockHeadersPacket{</span>
<span class="term-fg32">+	rlpHeaders := eth.ServiceGetBlockHeadersQuery(dlp.chain, &amp;eth.GetBlockHeadersRequest{</span>
 		Origin: eth.HashOrNumber{
 			Number: origin,
 		},
<span class="term-fg36">@@ -249,7 +249,7 @@</span> 		Peer: dlp.id,
 	}
 	res := &amp;eth.Response{
 		Req:  req,
<span class="term-fg31">-		Res:  (*eth.BlockHeadersPacket)(&amp;headers),</span>
<span class="term-fg32">+		Res:  (*eth.BlockHeadersRequest)(&amp;headers),</span>
 		Meta: hashes,
 		Time: 1,
 		Done: make(chan error, 1), &#47;&#47; Ignore the returned status
<span class="term-fg36">@@ -286,7 +286,7 @@</span> 		Peer: dlp.id,
 	}
 	res := &amp;eth.Response{
 		Req:  req,
<span class="term-fg31">-		Res:  (*eth.BlockBodiesPacket)(&amp;bodies),</span>
<span class="term-fg32">+		Res:  (*eth.BlockBodiesResponse)(&amp;bodies),</span>
 		Meta: [][]common.Hash{txsHashes, uncleHashes, withdrawalHashes},
 		Time: 1,
 		Done: make(chan error, 1), &#47;&#47; Ignore the returned status
<span class="term-fg36">@@ -317,7 +317,7 @@</span> 		Peer: dlp.id,
 	}
 	res := &amp;eth.Response{
 		Req:  req,
<span class="term-fg31">-		Res:  (*eth.ReceiptsPacket)(&amp;receipts),</span>
<span class="term-fg32">+		Res:  (*eth.ReceiptsResponse)(&amp;receipts),</span>
 		Meta: hashes,
 		Time: 1,
 		Done: make(chan error, 1), &#47;&#47; Ignore the returned status
<span class="term-fg36">@@ -437,9 +437,9 @@</span> 		t.Fatalf(&quot;synchronised receipts mismatch: have %v, want %v&quot;, rs, receipts)
 	}
 }
&nbsp;
<span class="term-fg31">-func TestCanonicalSynchronisation66Full(t *testing.T)  { testCanonSync(t, eth.ETH66, FullSync) }</span>
<span class="term-fg31">-func TestCanonicalSynchronisation66Snap(t *testing.T)  { testCanonSync(t, eth.ETH66, SnapSync) }</span>
<span class="term-fg31">-func TestCanonicalSynchronisation66Light(t *testing.T) { testCanonSync(t, eth.ETH66, LightSync) }</span>
<span class="term-fg32">+func TestCanonicalSynchronisation68Full(t *testing.T)  { testCanonSync(t, eth.ETH68, FullSync) }</span>
<span class="term-fg32">+func TestCanonicalSynchronisation68Snap(t *testing.T)  { testCanonSync(t, eth.ETH68, SnapSync) }</span>
<span class="term-fg32">+func TestCanonicalSynchronisation68Light(t *testing.T) { testCanonSync(t, eth.ETH68, LightSync) }</span>
 func TestCanonicalSynchronisation67Full(t *testing.T)  { testCanonSync(t, eth.ETH67, FullSync) }
 func TestCanonicalSynchronisation67Snap(t *testing.T)  { testCanonSync(t, eth.ETH67, SnapSync) }
 func TestCanonicalSynchronisation67Light(t *testing.T) { testCanonSync(t, eth.ETH67, LightSync) }
<span class="term-fg36">@@ -461,8 +461,8 @@</span> }
&nbsp;
 &#47;&#47; Tests that if a large batch of blocks are being downloaded, it is throttled
 &#47;&#47; until the cached blocks are retrieved.
<span class="term-fg31">-func TestThrottling66Full(t *testing.T) { testThrottling(t, eth.ETH66, FullSync) }</span>
<span class="term-fg31">-func TestThrottling66Snap(t *testing.T) { testThrottling(t, eth.ETH66, SnapSync) }</span>
<span class="term-fg32">+func TestThrottling68Full(t *testing.T) { testThrottling(t, eth.ETH68, FullSync) }</span>
<span class="term-fg32">+func TestThrottling68Snap(t *testing.T) { testThrottling(t, eth.ETH68, SnapSync) }</span>
 func TestThrottling67Full(t *testing.T) { testThrottling(t, eth.ETH67, FullSync) }
 func TestThrottling67Snap(t *testing.T) { testThrottling(t, eth.ETH67, SnapSync) }
&nbsp;
<span class="term-fg36">@@ -543,9 +543,9 @@</span>
 &#47;&#47; Tests that simple synchronization against a forked chain works correctly. In
 &#47;&#47; this test common ancestor lookup should *not* be short circuited, and a full
 &#47;&#47; binary search should be executed.
<span class="term-fg31">-func TestForkedSync66Full(t *testing.T)  { testForkedSync(t, eth.ETH66, FullSync) }</span>
<span class="term-fg31">-func TestForkedSync66Snap(t *testing.T)  { testForkedSync(t, eth.ETH66, SnapSync) }</span>
<span class="term-fg31">-func TestForkedSync66Light(t *testing.T) { testForkedSync(t, eth.ETH66, LightSync) }</span>
<span class="term-fg32">+func TestForkedSync68Full(t *testing.T)  { testForkedSync(t, eth.ETH68, FullSync) }</span>
<span class="term-fg32">+func TestForkedSync68Snap(t *testing.T)  { testForkedSync(t, eth.ETH68, SnapSync) }</span>
<span class="term-fg32">+func TestForkedSync68Light(t *testing.T) { testForkedSync(t, eth.ETH68, LightSync) }</span>
 func TestForkedSync67Full(t *testing.T)  { testForkedSync(t, eth.ETH67, FullSync) }
 func TestForkedSync67Snap(t *testing.T)  { testForkedSync(t, eth.ETH67, SnapSync) }
 func TestForkedSync67Light(t *testing.T) { testForkedSync(t, eth.ETH67, LightSync) }
<span class="term-fg36">@@ -573,9 +573,9 @@</span> }
&nbsp;
 &#47;&#47; Tests that synchronising against a much shorter but much heavier fork works
 &#47;&#47; currently and is not dropped.
<span class="term-fg31">-func TestHeavyForkedSync66Full(t *testing.T)  { testHeavyForkedSync(t, eth.ETH66, FullSync) }</span>
<span class="term-fg31">-func TestHeavyForkedSync66Snap(t *testing.T)  { testHeavyForkedSync(t, eth.ETH66, SnapSync) }</span>
<span class="term-fg31">-func TestHeavyForkedSync66Light(t *testing.T) { testHeavyForkedSync(t, eth.ETH66, LightSync) }</span>
<span class="term-fg32">+func TestHeavyForkedSync68Full(t *testing.T)  { testHeavyForkedSync(t, eth.ETH68, FullSync) }</span>
<span class="term-fg32">+func TestHeavyForkedSync68Snap(t *testing.T)  { testHeavyForkedSync(t, eth.ETH68, SnapSync) }</span>
<span class="term-fg32">+func TestHeavyForkedSync68Light(t *testing.T) { testHeavyForkedSync(t, eth.ETH68, LightSync) }</span>
 func TestHeavyForkedSync67Full(t *testing.T)  { testHeavyForkedSync(t, eth.ETH67, FullSync) }
 func TestHeavyForkedSync67Snap(t *testing.T)  { testHeavyForkedSync(t, eth.ETH67, SnapSync) }
 func TestHeavyForkedSync67Light(t *testing.T) { testHeavyForkedSync(t, eth.ETH67, LightSync) }
<span class="term-fg36">@@ -605,9 +605,9 @@</span>
 &#47;&#47; Tests that chain forks are contained within a certain interval of the current
 &#47;&#47; chain head, ensuring that malicious peers cannot waste resources by feeding
 &#47;&#47; long dead chains.
<span class="term-fg31">-func TestBoundedForkedSync66Full(t *testing.T)  { testBoundedForkedSync(t, eth.ETH66, FullSync) }</span>
<span class="term-fg31">-func TestBoundedForkedSync66Snap(t *testing.T)  { testBoundedForkedSync(t, eth.ETH66, SnapSync) }</span>
<span class="term-fg31">-func TestBoundedForkedSync66Light(t *testing.T) { testBoundedForkedSync(t, eth.ETH66, LightSync) }</span>
<span class="term-fg32">+func TestBoundedForkedSync68Full(t *testing.T)  { testBoundedForkedSync(t, eth.ETH68, FullSync) }</span>
<span class="term-fg32">+func TestBoundedForkedSync68Snap(t *testing.T)  { testBoundedForkedSync(t, eth.ETH68, SnapSync) }</span>
<span class="term-fg32">+func TestBoundedForkedSync68Light(t *testing.T) { testBoundedForkedSync(t, eth.ETH68, LightSync) }</span>
 func TestBoundedForkedSync67Full(t *testing.T)  { testBoundedForkedSync(t, eth.ETH67, FullSync) }
 func TestBoundedForkedSync67Snap(t *testing.T)  { testBoundedForkedSync(t, eth.ETH67, SnapSync) }
 func TestBoundedForkedSync67Light(t *testing.T) { testBoundedForkedSync(t, eth.ETH67, LightSync) }
<span class="term-fg36">@@ -636,14 +636,14 @@</span>
 &#47;&#47; Tests that chain forks are contained within a certain interval of the current
 &#47;&#47; chain head for short but heavy forks too. These are a bit special because they
 &#47;&#47; take different ancestor lookup paths.
<span class="term-fg31">-func TestBoundedHeavyForkedSync66Full(t *testing.T) {</span>
<span class="term-fg31">-	testBoundedHeavyForkedSync(t, eth.ETH66, FullSync)</span>
<span class="term-fg32">+func TestBoundedHeavyForkedSync68Full(t *testing.T) {</span>
<span class="term-fg32">+	testBoundedHeavyForkedSync(t, eth.ETH68, FullSync)</span>
 }
<span class="term-fg31">-func TestBoundedHeavyForkedSync66Snap(t *testing.T) {</span>
<span class="term-fg31">-	testBoundedHeavyForkedSync(t, eth.ETH66, SnapSync)</span>
<span class="term-fg32">+func TestBoundedHeavyForkedSync68Snap(t *testing.T) {</span>
<span class="term-fg32">+	testBoundedHeavyForkedSync(t, eth.ETH68, SnapSync)</span>
 }
<span class="term-fg31">-func TestBoundedHeavyForkedSync66Light(t *testing.T) {</span>
<span class="term-fg31">-	testBoundedHeavyForkedSync(t, eth.ETH66, LightSync)</span>
<span class="term-fg32">+func TestBoundedHeavyForkedSync68Light(t *testing.T) {</span>
<span class="term-fg32">+	testBoundedHeavyForkedSync(t, eth.ETH68, LightSync)</span>
 }
 func TestBoundedHeavyForkedSync67Full(t *testing.T) {
 	testBoundedHeavyForkedSync(t, eth.ETH67, FullSync)
<span class="term-fg36">@@ -678,9 +678,9 @@</span> 	}
 }
&nbsp;
 &#47;&#47; Tests that a canceled download wipes all previously accumulated state.
<span class="term-fg31">-func TestCancel66Full(t *testing.T)  { testCancel(t, eth.ETH66, FullSync) }</span>
<span class="term-fg31">-func TestCancel66Snap(t *testing.T)  { testCancel(t, eth.ETH66, SnapSync) }</span>
<span class="term-fg31">-func TestCancel66Light(t *testing.T) { testCancel(t, eth.ETH66, LightSync) }</span>
<span class="term-fg32">+func TestCancel68Full(t *testing.T)  { testCancel(t, eth.ETH68, FullSync) }</span>
<span class="term-fg32">+func TestCancel68Snap(t *testing.T)  { testCancel(t, eth.ETH68, SnapSync) }</span>
<span class="term-fg32">+func TestCancel68Light(t *testing.T) { testCancel(t, eth.ETH68, LightSync) }</span>
 func TestCancel67Full(t *testing.T)  { testCancel(t, eth.ETH67, FullSync) }
 func TestCancel67Snap(t *testing.T)  { testCancel(t, eth.ETH67, SnapSync) }
 func TestCancel67Light(t *testing.T) { testCancel(t, eth.ETH67, LightSync) }
<span class="term-fg36">@@ -708,9 +708,9 @@</span> 	}
 }
&nbsp;
 &#47;&#47; Tests that synchronisation from multiple peers works as intended (multi thread sanity test).
<span class="term-fg31">-func TestMultiSynchronisation66Full(t *testing.T)  { testMultiSynchronisation(t, eth.ETH66, FullSync) }</span>
<span class="term-fg31">-func TestMultiSynchronisation66Snap(t *testing.T)  { testMultiSynchronisation(t, eth.ETH66, SnapSync) }</span>
<span class="term-fg31">-func TestMultiSynchronisation66Light(t *testing.T) { testMultiSynchronisation(t, eth.ETH66, LightSync) }</span>
<span class="term-fg32">+func TestMultiSynchronisation68Full(t *testing.T)  { testMultiSynchronisation(t, eth.ETH68, FullSync) }</span>
<span class="term-fg32">+func TestMultiSynchronisation68Snap(t *testing.T)  { testMultiSynchronisation(t, eth.ETH68, SnapSync) }</span>
<span class="term-fg32">+func TestMultiSynchronisation68Light(t *testing.T) { testMultiSynchronisation(t, eth.ETH68, LightSync) }</span>
 func TestMultiSynchronisation67Full(t *testing.T)  { testMultiSynchronisation(t, eth.ETH67, FullSync) }
 func TestMultiSynchronisation67Snap(t *testing.T)  { testMultiSynchronisation(t, eth.ETH67, SnapSync) }
 func TestMultiSynchronisation67Light(t *testing.T) { testMultiSynchronisation(t, eth.ETH67, LightSync) }
<span class="term-fg36">@@ -735,9 +735,9 @@</span> }
&nbsp;
 &#47;&#47; Tests that synchronisations behave well in multi-version protocol environments
 &#47;&#47; and not wreak havoc on other nodes in the network.
<span class="term-fg31">-func TestMultiProtoSynchronisation66Full(t *testing.T)  { testMultiProtoSync(t, eth.ETH66, FullSync) }</span>
<span class="term-fg31">-func TestMultiProtoSynchronisation66Snap(t *testing.T)  { testMultiProtoSync(t, eth.ETH66, SnapSync) }</span>
<span class="term-fg31">-func TestMultiProtoSynchronisation66Light(t *testing.T) { testMultiProtoSync(t, eth.ETH66, LightSync) }</span>
<span class="term-fg32">+func TestMultiProtoSynchronisation68Full(t *testing.T)  { testMultiProtoSync(t, eth.ETH68, FullSync) }</span>
<span class="term-fg32">+func TestMultiProtoSynchronisation68Snap(t *testing.T)  { testMultiProtoSync(t, eth.ETH68, SnapSync) }</span>
<span class="term-fg32">+func TestMultiProtoSynchronisation68Light(t *testing.T) { testMultiProtoSync(t, eth.ETH68, LightSync) }</span>
 func TestMultiProtoSynchronisation67Full(t *testing.T)  { testMultiProtoSync(t, eth.ETH67, FullSync) }
 func TestMultiProtoSynchronisation67Snap(t *testing.T)  { testMultiProtoSync(t, eth.ETH67, SnapSync) }
 func TestMultiProtoSynchronisation67Light(t *testing.T) { testMultiProtoSync(t, eth.ETH67, LightSync) }
<span class="term-fg36">@@ -750,7 +750,7 @@</span> 	&#47;&#47; Create a small enough block chain to download
 	chain := testChainBase.shorten(blockCacheMaxItems - 15)
&nbsp;
 	&#47;&#47; Create peers of every type
<span class="term-fg31">-	tester.newPeer(&quot;peer 66&quot;, eth.ETH66, chain.blocks[1:])</span>
<span class="term-fg32">+	tester.newPeer(&quot;peer 68&quot;, eth.ETH68, chain.blocks[1:])</span>
 	tester.newPeer(&quot;peer 67&quot;, eth.ETH67, chain.blocks[1:])
&nbsp;
 	&#47;&#47; Synchronise with the requested peer and make sure all blocks were retrieved
<span class="term-fg36">@@ -760,7 +760,7 @@</span> 	}
 	assertOwnChain(t, tester, len(chain.blocks))
&nbsp;
 	&#47;&#47; Check that no peers have been dropped off
<span class="term-fg31">-	for _, version := range []int{66, 67} {</span>
<span class="term-fg32">+	for _, version := range []int{68, 67} {</span>
 		peer := fmt.Sprintf(&quot;peer %d&quot;, version)
 		if _, ok := tester.peers[peer]; !ok {
 			t.Errorf(&quot;%s dropped&quot;, peer)
<span class="term-fg36">@@ -770,9 +770,9 @@</span> }
&nbsp;
 &#47;&#47; Tests that if a block is empty (e.g. header only), no body request should be
 &#47;&#47; made, and instead the header should be assembled into a whole block in itself.
<span class="term-fg31">-func TestEmptyShortCircuit66Full(t *testing.T)  { testEmptyShortCircuit(t, eth.ETH66, FullSync) }</span>
<span class="term-fg31">-func TestEmptyShortCircuit66Snap(t *testing.T)  { testEmptyShortCircuit(t, eth.ETH66, SnapSync) }</span>
<span class="term-fg31">-func TestEmptyShortCircuit66Light(t *testing.T) { testEmptyShortCircuit(t, eth.ETH66, LightSync) }</span>
<span class="term-fg32">+func TestEmptyShortCircuit68Full(t *testing.T)  { testEmptyShortCircuit(t, eth.ETH68, FullSync) }</span>
<span class="term-fg32">+func TestEmptyShortCircuit68Snap(t *testing.T)  { testEmptyShortCircuit(t, eth.ETH68, SnapSync) }</span>
<span class="term-fg32">+func TestEmptyShortCircuit68Light(t *testing.T) { testEmptyShortCircuit(t, eth.ETH68, LightSync) }</span>
 func TestEmptyShortCircuit67Full(t *testing.T)  { testEmptyShortCircuit(t, eth.ETH67, FullSync) }
 func TestEmptyShortCircuit67Snap(t *testing.T)  { testEmptyShortCircuit(t, eth.ETH67, SnapSync) }
 func TestEmptyShortCircuit67Light(t *testing.T) { testEmptyShortCircuit(t, eth.ETH67, LightSync) }
<span class="term-fg36">@@ -821,9 +821,9 @@</span> }
&nbsp;
 &#47;&#47; Tests that headers are enqueued continuously, preventing malicious nodes from
 &#47;&#47; stalling the downloader by feeding gapped header chains.
<span class="term-fg31">-func TestMissingHeaderAttack66Full(t *testing.T)  { testMissingHeaderAttack(t, eth.ETH66, FullSync) }</span>
<span class="term-fg31">-func TestMissingHeaderAttack66Snap(t *testing.T)  { testMissingHeaderAttack(t, eth.ETH66, SnapSync) }</span>
<span class="term-fg31">-func TestMissingHeaderAttack66Light(t *testing.T) { testMissingHeaderAttack(t, eth.ETH66, LightSync) }</span>
<span class="term-fg32">+func TestMissingHeaderAttack68Full(t *testing.T)  { testMissingHeaderAttack(t, eth.ETH68, FullSync) }</span>
<span class="term-fg32">+func TestMissingHeaderAttack68Snap(t *testing.T)  { testMissingHeaderAttack(t, eth.ETH68, SnapSync) }</span>
<span class="term-fg32">+func TestMissingHeaderAttack68Light(t *testing.T) { testMissingHeaderAttack(t, eth.ETH68, LightSync) }</span>
 func TestMissingHeaderAttack67Full(t *testing.T)  { testMissingHeaderAttack(t, eth.ETH67, FullSync) }
 func TestMissingHeaderAttack67Snap(t *testing.T)  { testMissingHeaderAttack(t, eth.ETH67, SnapSync) }
 func TestMissingHeaderAttack67Light(t *testing.T) { testMissingHeaderAttack(t, eth.ETH67, LightSync) }
<span class="term-fg36">@@ -850,9 +850,9 @@</span> }
&nbsp;
 &#47;&#47; Tests that if requested headers are shifted (i.e. first is missing), the queue
 &#47;&#47; detects the invalid numbering.
<span class="term-fg31">-func TestShiftedHeaderAttack66Full(t *testing.T)  { testShiftedHeaderAttack(t, eth.ETH66, FullSync) }</span>
<span class="term-fg31">-func TestShiftedHeaderAttack66Snap(t *testing.T)  { testShiftedHeaderAttack(t, eth.ETH66, SnapSync) }</span>
<span class="term-fg31">-func TestShiftedHeaderAttack66Light(t *testing.T) { testShiftedHeaderAttack(t, eth.ETH66, LightSync) }</span>
<span class="term-fg32">+func TestShiftedHeaderAttack68Full(t *testing.T)  { testShiftedHeaderAttack(t, eth.ETH68, FullSync) }</span>
<span class="term-fg32">+func TestShiftedHeaderAttack68Snap(t *testing.T)  { testShiftedHeaderAttack(t, eth.ETH68, SnapSync) }</span>
<span class="term-fg32">+func TestShiftedHeaderAttack68Light(t *testing.T) { testShiftedHeaderAttack(t, eth.ETH68, LightSync) }</span>
 func TestShiftedHeaderAttack67Full(t *testing.T)  { testShiftedHeaderAttack(t, eth.ETH67, FullSync) }
 func TestShiftedHeaderAttack67Snap(t *testing.T)  { testShiftedHeaderAttack(t, eth.ETH67, SnapSync) }
 func TestShiftedHeaderAttack67Light(t *testing.T) { testShiftedHeaderAttack(t, eth.ETH67, LightSync) }
<span class="term-fg36">@@ -878,96 +878,16 @@</span> 	}
 	assertOwnChain(t, tester, len(chain.blocks))
 }
&nbsp;
<span class="term-fg31">-&#47;&#47; Tests that upon detecting an invalid header, the recent ones are rolled back</span>
<span class="term-fg31">-&#47;&#47; for various failure scenarios. Afterwards a full sync is attempted to make</span>
<span class="term-fg31">-&#47;&#47; sure no state was corrupted.</span>
<span class="term-fg31">-func TestInvalidHeaderRollback66Snap(t *testing.T) { testInvalidHeaderRollback(t, eth.ETH66, SnapSync) }</span>
<span class="term-fg31">-func TestInvalidHeaderRollback67Snap(t *testing.T) { testInvalidHeaderRollback(t, eth.ETH67, SnapSync) }</span>
<span class="term-fg31">-</span>
<span class="term-fg31">-func testInvalidHeaderRollback(t *testing.T, protocol uint, mode SyncMode) {</span>
<span class="term-fg31">-	tester := newTester(t)</span>
<span class="term-fg31">-	defer tester.terminate()</span>
<span class="term-fg31">-</span>
<span class="term-fg31">-	&#47;&#47; Create a small enough block chain to download</span>
<span class="term-fg31">-	targetBlocks := 3*fsHeaderSafetyNet + 256 + fsMinFullBlocks</span>
<span class="term-fg31">-	chain := testChainBase.shorten(targetBlocks)</span>
<span class="term-fg31">-</span>
<span class="term-fg31">-	&#47;&#47; Attempt to sync with an attacker that feeds junk during the fast sync phase.</span>
<span class="term-fg31">-	&#47;&#47; This should result in the last fsHeaderSafetyNet headers being rolled back.</span>
<span class="term-fg31">-	missing := fsHeaderSafetyNet + MaxHeaderFetch + 1</span>
<span class="term-fg31">-</span>
<span class="term-fg31">-	fastAttacker := tester.newPeer(&quot;fast-attack&quot;, protocol, chain.blocks[1:])</span>
<span class="term-fg31">-	fastAttacker.withholdHeaders[chain.blocks[missing].Hash()] = struct{}{}</span>
<span class="term-fg31">-</span>
<span class="term-fg31">-	if err := tester.sync(&quot;fast-attack&quot;, nil, mode); err == nil {</span>
<span class="term-fg31">-		t.Fatalf(&quot;succeeded fast attacker synchronisation&quot;)</span>
<span class="term-fg31">-	}</span>
<span class="term-fg31">-	if head := tester.chain.CurrentHeader().Number.Int64(); int(head) &gt; MaxHeaderFetch {</span>
<span class="term-fg31">-		t.Errorf(&quot;rollback head mismatch: have %v, want at most %v&quot;, head, MaxHeaderFetch)</span>
<span class="term-fg31">-	}</span>
<span class="term-fg31">-	&#47;&#47; Attempt to sync with an attacker that feeds junk during the block import phase.</span>
<span class="term-fg31">-	&#47;&#47; This should result in both the last fsHeaderSafetyNet number of headers being</span>
<span class="term-fg31">-	&#47;&#47; rolled back, and also the pivot point being reverted to a non-block status.</span>
<span class="term-fg31">-	missing = 3*fsHeaderSafetyNet + MaxHeaderFetch + 1</span>
<span class="term-fg31">-</span>
<span class="term-fg31">-	blockAttacker := tester.newPeer(&quot;block-attack&quot;, protocol, chain.blocks[1:])</span>
<span class="term-fg31">-	fastAttacker.withholdHeaders[chain.blocks[missing].Hash()] = struct{}{} &#47;&#47; Make sure the fast-attacker doesn&#39;t fill in</span>
<span class="term-fg31">-	blockAttacker.withholdHeaders[chain.blocks[missing].Hash()] = struct{}{}</span>
<span class="term-fg31">-</span>
<span class="term-fg31">-	if err := tester.sync(&quot;block-attack&quot;, nil, mode); err == nil {</span>
<span class="term-fg31">-		t.Fatalf(&quot;succeeded block attacker synchronisation&quot;)</span>
<span class="term-fg31">-	}</span>
<span class="term-fg31">-	if head := tester.chain.CurrentHeader().Number.Int64(); int(head) &gt; 2*fsHeaderSafetyNet+MaxHeaderFetch {</span>
<span class="term-fg31">-		t.Errorf(&quot;rollback head mismatch: have %v, want at most %v&quot;, head, 2*fsHeaderSafetyNet+MaxHeaderFetch)</span>
<span class="term-fg31">-	}</span>
<span class="term-fg31">-	if mode == SnapSync {</span>
<span class="term-fg31">-		if head := tester.chain.CurrentBlock().Number.Uint64(); head != 0 {</span>
<span class="term-fg31">-			t.Errorf(&quot;fast sync pivot block #%d not rolled back&quot;, head)</span>
<span class="term-fg31">-		}</span>
<span class="term-fg31">-	}</span>
<span class="term-fg31">-	&#47;&#47; Attempt to sync with an attacker that withholds promised blocks after the</span>
<span class="term-fg31">-	&#47;&#47; fast sync pivot point. This could be a trial to leave the node with a bad</span>
<span class="term-fg31">-	&#47;&#47; but already imported pivot block.</span>
<span class="term-fg31">-	withholdAttacker := tester.newPeer(&quot;withhold-attack&quot;, protocol, chain.blocks[1:])</span>
<span class="term-fg31">-</span>
<span class="term-fg31">-	tester.downloader.syncInitHook = func(uint64, uint64) {</span>
<span class="term-fg31">-		for i := missing; i &lt; len(chain.blocks); i++ {</span>
<span class="term-fg31">-			withholdAttacker.withholdHeaders[chain.blocks[i].Hash()] = struct{}{}</span>
<span class="term-fg31">-		}</span>
<span class="term-fg31">-		tester.downloader.syncInitHook = nil</span>
<span class="term-fg31">-	}</span>
<span class="term-fg31">-	if err := tester.sync(&quot;withhold-attack&quot;, nil, mode); err == nil {</span>
<span class="term-fg31">-		t.Fatalf(&quot;succeeded withholding attacker synchronisation&quot;)</span>
<span class="term-fg31">-	}</span>
<span class="term-fg31">-	if head := tester.chain.CurrentHeader().Number.Int64(); int(head) &gt; 2*fsHeaderSafetyNet+MaxHeaderFetch {</span>
<span class="term-fg31">-		t.Errorf(&quot;rollback head mismatch: have %v, want at most %v&quot;, head, 2*fsHeaderSafetyNet+MaxHeaderFetch)</span>
<span class="term-fg31">-	}</span>
<span class="term-fg31">-	if mode == SnapSync {</span>
<span class="term-fg31">-		if head := tester.chain.CurrentBlock().Number.Uint64(); head != 0 {</span>
<span class="term-fg31">-			t.Errorf(&quot;fast sync pivot block #%d not rolled back&quot;, head)</span>
<span class="term-fg31">-		}</span>
<span class="term-fg31">-	}</span>
<span class="term-fg31">-	&#47;&#47; Synchronise with the valid peer and make sure sync succeeds. Since the last rollback</span>
<span class="term-fg31">-	&#47;&#47; should also disable fast syncing for this process, verify that we did a fresh full</span>
<span class="term-fg31">-	&#47;&#47; sync. Note, we can&#39;t assert anything about the receipts since we won&#39;t purge the</span>
<span class="term-fg31">-	&#47;&#47; database of them, hence we can&#39;t use assertOwnChain.</span>
<span class="term-fg31">-	tester.newPeer(&quot;valid&quot;, protocol, chain.blocks[1:])</span>
<span class="term-fg31">-	if err := tester.sync(&quot;valid&quot;, nil, mode); err != nil {</span>
<span class="term-fg31">-		t.Fatalf(&quot;failed to synchronise blocks: %v&quot;, err)</span>
<span class="term-fg31">-	}</span>
<span class="term-fg31">-	assertOwnChain(t, tester, len(chain.blocks))</span>
<span class="term-fg31">-}</span>
<span class="term-fg31">-</span>
 &#47;&#47; Tests that a peer advertising a high TD doesn&#39;t get to stall the downloader
 &#47;&#47; afterwards by not sending any useful hashes.
<span class="term-fg31">-func TestHighTDStarvationAttack66Full(t *testing.T) {</span>
<span class="term-fg31">-	testHighTDStarvationAttack(t, eth.ETH66, FullSync)</span>
<span class="term-fg32">+func TestHighTDStarvationAttack68Full(t *testing.T) {</span>
<span class="term-fg32">+	testHighTDStarvationAttack(t, eth.ETH68, FullSync)</span>
 }
<span class="term-fg31">-func TestHighTDStarvationAttack66Snap(t *testing.T) {</span>
<span class="term-fg31">-	testHighTDStarvationAttack(t, eth.ETH66, SnapSync)</span>
<span class="term-fg32">+func TestHighTDStarvationAttack68Snap(t *testing.T) {</span>
<span class="term-fg32">+	testHighTDStarvationAttack(t, eth.ETH68, SnapSync)</span>
 }
<span class="term-fg31">-func TestHighTDStarvationAttack66Light(t *testing.T) {</span>
<span class="term-fg31">-	testHighTDStarvationAttack(t, eth.ETH66, LightSync)</span>
<span class="term-fg32">+func TestHighTDStarvationAttack68Light(t *testing.T) {</span>
<span class="term-fg32">+	testHighTDStarvationAttack(t, eth.ETH68, LightSync)</span>
 }
 func TestHighTDStarvationAttack67Full(t *testing.T) {
 	testHighTDStarvationAttack(t, eth.ETH67, FullSync)
<span class="term-fg36">@@ -991,7 +911,7 @@</span> 	}
 }
&nbsp;
 &#47;&#47; Tests that misbehaving peers are disconnected, whilst behaving ones are not.
<span class="term-fg31">-func TestBlockHeaderAttackerDropping66(t *testing.T) { testBlockHeaderAttackerDropping(t, eth.ETH66) }</span>
<span class="term-fg32">+func TestBlockHeaderAttackerDropping68(t *testing.T) { testBlockHeaderAttackerDropping(t, eth.ETH68) }</span>
 func TestBlockHeaderAttackerDropping67(t *testing.T) { testBlockHeaderAttackerDropping(t, eth.ETH67) }
&nbsp;
 func testBlockHeaderAttackerDropping(t *testing.T, protocol uint) {
<span class="term-fg36">@@ -1040,9 +960,9 @@</span> }
&nbsp;
 &#47;&#47; Tests that synchronisation progress (origin block number, current block number
 &#47;&#47; and highest block number) is tracked and updated correctly.
<span class="term-fg31">-func TestSyncProgress66Full(t *testing.T)  { testSyncProgress(t, eth.ETH66, FullSync) }</span>
<span class="term-fg31">-func TestSyncProgress66Snap(t *testing.T)  { testSyncProgress(t, eth.ETH66, SnapSync) }</span>
<span class="term-fg31">-func TestSyncProgress66Light(t *testing.T) { testSyncProgress(t, eth.ETH66, LightSync) }</span>
<span class="term-fg32">+func TestSyncProgress68Full(t *testing.T)  { testSyncProgress(t, eth.ETH68, FullSync) }</span>
<span class="term-fg32">+func TestSyncProgress68Snap(t *testing.T)  { testSyncProgress(t, eth.ETH68, SnapSync) }</span>
<span class="term-fg32">+func TestSyncProgress68Light(t *testing.T) { testSyncProgress(t, eth.ETH68, LightSync) }</span>
 func TestSyncProgress67Full(t *testing.T)  { testSyncProgress(t, eth.ETH67, FullSync) }
 func TestSyncProgress67Snap(t *testing.T)  { testSyncProgress(t, eth.ETH67, SnapSync) }
 func TestSyncProgress67Light(t *testing.T) { testSyncProgress(t, eth.ETH67, LightSync) }
<span class="term-fg36">@@ -1120,9 +1040,9 @@</span>
 &#47;&#47; Tests that synchronisation progress (origin block number and highest block
 &#47;&#47; number) is tracked and updated correctly in case of a fork (or manual head
 &#47;&#47; revertal).
<span class="term-fg31">-func TestForkedSyncProgress66Full(t *testing.T)  { testForkedSyncProgress(t, eth.ETH66, FullSync) }</span>
<span class="term-fg31">-func TestForkedSyncProgress66Snap(t *testing.T)  { testForkedSyncProgress(t, eth.ETH66, SnapSync) }</span>
<span class="term-fg31">-func TestForkedSyncProgress66Light(t *testing.T) { testForkedSyncProgress(t, eth.ETH66, LightSync) }</span>
<span class="term-fg32">+func TestForkedSyncProgress68Full(t *testing.T)  { testForkedSyncProgress(t, eth.ETH68, FullSync) }</span>
<span class="term-fg32">+func TestForkedSyncProgress68Snap(t *testing.T)  { testForkedSyncProgress(t, eth.ETH68, SnapSync) }</span>
<span class="term-fg32">+func TestForkedSyncProgress68Light(t *testing.T) { testForkedSyncProgress(t, eth.ETH68, LightSync) }</span>
 func TestForkedSyncProgress67Full(t *testing.T)  { testForkedSyncProgress(t, eth.ETH67, FullSync) }
 func TestForkedSyncProgress67Snap(t *testing.T)  { testForkedSyncProgress(t, eth.ETH67, SnapSync) }
 func TestForkedSyncProgress67Light(t *testing.T) { testForkedSyncProgress(t, eth.ETH67, LightSync) }
<span class="term-fg36">@@ -1194,9 +1114,9 @@</span>
 &#47;&#47; Tests that if synchronisation is aborted due to some failure, then the progress
 &#47;&#47; origin is not updated in the next sync cycle, as it should be considered the
 &#47;&#47; continuation of the previous sync and not a new instance.
<span class="term-fg31">-func TestFailedSyncProgress66Full(t *testing.T)  { testFailedSyncProgress(t, eth.ETH66, FullSync) }</span>
<span class="term-fg31">-func TestFailedSyncProgress66Snap(t *testing.T)  { testFailedSyncProgress(t, eth.ETH66, SnapSync) }</span>
<span class="term-fg31">-func TestFailedSyncProgress66Light(t *testing.T) { testFailedSyncProgress(t, eth.ETH66, LightSync) }</span>
<span class="term-fg32">+func TestFailedSyncProgress68Full(t *testing.T)  { testFailedSyncProgress(t, eth.ETH68, FullSync) }</span>
<span class="term-fg32">+func TestFailedSyncProgress68Snap(t *testing.T)  { testFailedSyncProgress(t, eth.ETH68, SnapSync) }</span>
<span class="term-fg32">+func TestFailedSyncProgress68Light(t *testing.T) { testFailedSyncProgress(t, eth.ETH68, LightSync) }</span>
 func TestFailedSyncProgress67Full(t *testing.T)  { testFailedSyncProgress(t, eth.ETH67, FullSync) }
 func TestFailedSyncProgress67Snap(t *testing.T)  { testFailedSyncProgress(t, eth.ETH67, SnapSync) }
 func TestFailedSyncProgress67Light(t *testing.T) { testFailedSyncProgress(t, eth.ETH67, LightSync) }
<span class="term-fg36">@@ -1263,9 +1183,9 @@</span> }
&nbsp;
 &#47;&#47; Tests that if an attacker fakes a chain height, after the attack is detected,
 &#47;&#47; the progress height is successfully reduced at the next sync invocation.
<span class="term-fg31">-func TestFakedSyncProgress66Full(t *testing.T)  { testFakedSyncProgress(t, eth.ETH66, FullSync) }</span>
<span class="term-fg31">-func TestFakedSyncProgress66Snap(t *testing.T)  { testFakedSyncProgress(t, eth.ETH66, SnapSync) }</span>
<span class="term-fg31">-func TestFakedSyncProgress66Light(t *testing.T) { testFakedSyncProgress(t, eth.ETH66, LightSync) }</span>
<span class="term-fg32">+func TestFakedSyncProgress68Full(t *testing.T)  { testFakedSyncProgress(t, eth.ETH68, FullSync) }</span>
<span class="term-fg32">+func TestFakedSyncProgress68Snap(t *testing.T)  { testFakedSyncProgress(t, eth.ETH68, SnapSync) }</span>
<span class="term-fg32">+func TestFakedSyncProgress68Light(t *testing.T) { testFakedSyncProgress(t, eth.ETH68, LightSync) }</span>
 func TestFakedSyncProgress67Full(t *testing.T)  { testFakedSyncProgress(t, eth.ETH67, FullSync) }
 func TestFakedSyncProgress67Snap(t *testing.T)  { testFakedSyncProgress(t, eth.ETH67, SnapSync) }
 func TestFakedSyncProgress67Light(t *testing.T) { testFakedSyncProgress(t, eth.ETH67, LightSync) }
<span class="term-fg36">@@ -1410,8 +1330,10 @@</span> }
&nbsp;
 &#47;&#47; Tests that peers below a pre-configured checkpoint block are prevented from
 &#47;&#47; being fast-synced from, avoiding potential cheap eclipse attacks.
<span class="term-fg31">-func TestBeaconSync66Full(t *testing.T) { testBeaconSync(t, eth.ETH66, FullSync) }</span>
<span class="term-fg31">-func TestBeaconSync66Snap(t *testing.T) { testBeaconSync(t, eth.ETH66, SnapSync) }</span>
<span class="term-fg32">+func TestBeaconSync68Full(t *testing.T) { testBeaconSync(t, eth.ETH68, FullSync) }</span>
<span class="term-fg32">+func TestBeaconSync68Snap(t *testing.T) { testBeaconSync(t, eth.ETH68, SnapSync) }</span>
<span class="term-fg32">+func TestBeaconSync67Full(t *testing.T) { testBeaconSync(t, eth.ETH67, FullSync) }</span>
<span class="term-fg32">+func TestBeaconSync67Snap(t *testing.T) { testBeaconSync(t, eth.ETH67, SnapSync) }</span>
&nbsp;
 func testBeaconSync(t *testing.T, protocol uint, mode SyncMode) {
 	&#47;&#47;log.Root().SetHandler(log.LvlFilterHandler(log.LvlInfo, log.StreamHandler(os.Stderr, log.TerminalFormat(true))))</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-75bd613867b276374fce15d1" role="button"
                   aria-expanded="false" aria-controls="id-75bd613867b276374fce15d1">
                    <code>eth/downloader/fetchers.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/3f40e65c484486dea6cff80b7db178985d21a2c6/eth/downloader/fetchers.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/650bb2f2b1dcfe30d9b1fa6f7dc9608055ed60e1/eth/downloader/fetchers.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+4</span></div>
                        <div class="text-start"><span class="text-danger">-4</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-75bd613867b276374fce15d1"><span class="term-fg1">diff --git go-ethereum&#47;eth&#47;downloader&#47;fetchers.go op-geth&#47;eth&#47;downloader&#47;fetchers.go</span>
<span class="term-fg1">index 021e8c4f9bf334898ca60ef587f13bdabed34adb..cc4279b0da7a1d24b6a9f84d94864984fefc400a 100644</span>
<span class="term-fg1">--- go-ethereum&#47;eth&#47;downloader&#47;fetchers.go</span>
<span class="term-fg1">+++ op-geth&#47;eth&#47;downloader&#47;fetchers.go</span>
<span class="term-fg36">@@ -58,14 +58,14 @@</span>
 	case res := &lt;-resCh:
 		&#47;&#47; Headers successfully retrieved, update the metrics
 		headerReqTimer.Update(time.Since(start))
<span class="term-fg31">-		headerInMeter.Mark(int64(len(*res.Res.(*eth.BlockHeadersPacket))))</span>
<span class="term-fg32">+		headerInMeter.Mark(int64(len(*res.Res.(*eth.BlockHeadersRequest))))</span>
&nbsp;
 		&#47;&#47; Don&#39;t reject the packet even if it turns out to be bad, downloader will
 		&#47;&#47; disconnect the peer on its own terms. Simply delivery the headers to
 		&#47;&#47; be processed by the caller
 		res.Done &lt;- nil
&nbsp;
<span class="term-fg31">-		return *res.Res.(*eth.BlockHeadersPacket), res.Meta.([]common.Hash), nil</span>
<span class="term-fg32">+		return *res.Res.(*eth.BlockHeadersRequest), res.Meta.([]common.Hash), nil</span>
 	}
 }
&nbsp;
<span class="term-fg36">@@ -103,13 +103,13 @@</span>
 	case res := &lt;-resCh:
 		&#47;&#47; Headers successfully retrieved, update the metrics
 		headerReqTimer.Update(time.Since(start))
<span class="term-fg31">-		headerInMeter.Mark(int64(len(*res.Res.(*eth.BlockHeadersPacket))))</span>
<span class="term-fg32">+		headerInMeter.Mark(int64(len(*res.Res.(*eth.BlockHeadersRequest))))</span>
&nbsp;
 		&#47;&#47; Don&#39;t reject the packet even if it turns out to be bad, downloader will
 		&#47;&#47; disconnect the peer on its own terms. Simply delivery the headers to
 		&#47;&#47; be processed by the caller
 		res.Done &lt;- nil
&nbsp;
<span class="term-fg31">-		return *res.Res.(*eth.BlockHeadersPacket), res.Meta.([]common.Hash), nil</span>
<span class="term-fg32">+		return *res.Res.(*eth.BlockHeadersRequest), res.Meta.([]common.Hash), nil</span>
 	}
 }</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-446416e3dc5fa35d3b612518" role="button"
                   aria-expanded="false" aria-controls="id-446416e3dc5fa35d3b612518">
                    <code>eth/downloader/fetchers_concurrent_bodies.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/3f40e65c484486dea6cff80b7db178985d21a2c6/eth/downloader/fetchers_concurrent_bodies.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/650bb2f2b1dcfe30d9b1fa6f7dc9608055ed60e1/eth/downloader/fetchers_concurrent_bodies.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+1</span></div>
                        <div class="text-start"><span class="text-danger">-1</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-446416e3dc5fa35d3b612518"><span class="term-fg1">diff --git go-ethereum&#47;eth&#47;downloader&#47;fetchers_concurrent_bodies.go op-geth&#47;eth&#47;downloader&#47;fetchers_concurrent_bodies.go</span>
<span class="term-fg1">index 9440972c6d70c9e9292615d38ec64936e63c3840..5105fda66b3a8752ed512532c8c8770956f1989d 100644</span>
<span class="term-fg1">--- go-ethereum&#47;eth&#47;downloader&#47;fetchers_concurrent_bodies.go</span>
<span class="term-fg1">+++ op-geth&#47;eth&#47;downloader&#47;fetchers_concurrent_bodies.go</span>
<span class="term-fg36">@@ -89,7 +89,7 @@</span>
 &#47;&#47; deliver is responsible for taking a generic response packet from the concurrent
 &#47;&#47; fetcher, unpacking the body data and delivering it to the downloader&#39;s queue.
 func (q *bodyQueue) deliver(peer *peerConnection, packet *eth.Response) (int, error) {
<span class="term-fg31">-	txs, uncles, withdrawals := packet.Res.(*eth.BlockBodiesPacket).Unpack()</span>
<span class="term-fg32">+	txs, uncles, withdrawals := packet.Res.(*eth.BlockBodiesResponse).Unpack()</span>
 	hashsets := packet.Meta.([][]common.Hash) &#47;&#47; {txs hashes, uncle hashes, withdrawal hashes}
&nbsp;
 	accepted, err := q.queue.DeliverBodies(peer.id, txs, hashsets[0], uncles, hashsets[1], withdrawals, hashsets[2])</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-3744077b419b9908412c08b2" role="button"
                   aria-expanded="false" aria-controls="id-3744077b419b9908412c08b2">
                    <code>eth/downloader/fetchers_concurrent_headers.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/3f40e65c484486dea6cff80b7db178985d21a2c6/eth/downloader/fetchers_concurrent_headers.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/650bb2f2b1dcfe30d9b1fa6f7dc9608055ed60e1/eth/downloader/fetchers_concurrent_headers.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+1</span></div>
                        <div class="text-start"><span class="text-danger">-1</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-3744077b419b9908412c08b2"><span class="term-fg1">diff --git go-ethereum&#47;eth&#47;downloader&#47;fetchers_concurrent_headers.go op-geth&#47;eth&#47;downloader&#47;fetchers_concurrent_headers.go</span>
<span class="term-fg1">index 84c7f209865a9e2aad029c7689422fafc6b883a9..8201f4ca74232e8e726b98557e453cd70e4166b5 100644</span>
<span class="term-fg1">--- go-ethereum&#47;eth&#47;downloader&#47;fetchers_concurrent_headers.go</span>
<span class="term-fg1">+++ op-geth&#47;eth&#47;downloader&#47;fetchers_concurrent_headers.go</span>
<span class="term-fg36">@@ -81,7 +81,7 @@</span>
 &#47;&#47; deliver is responsible for taking a generic response packet from the concurrent
 &#47;&#47; fetcher, unpacking the header data and delivering it to the downloader&#39;s queue.
 func (q *headerQueue) deliver(peer *peerConnection, packet *eth.Response) (int, error) {
<span class="term-fg31">-	headers := *packet.Res.(*eth.BlockHeadersPacket)</span>
<span class="term-fg32">+	headers := *packet.Res.(*eth.BlockHeadersRequest)</span>
 	hashes := packet.Meta.([]common.Hash)
&nbsp;
 	accepted, err := q.queue.DeliverHeaders(peer.id, headers, hashes, q.headerProcCh)</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-bfbcc03ac38380dc6cc57f21" role="button"
                   aria-expanded="false" aria-controls="id-bfbcc03ac38380dc6cc57f21">
                    <code>eth/downloader/fetchers_concurrent_receipts.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/3f40e65c484486dea6cff80b7db178985d21a2c6/eth/downloader/fetchers_concurrent_receipts.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/650bb2f2b1dcfe30d9b1fa6f7dc9608055ed60e1/eth/downloader/fetchers_concurrent_receipts.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+1</span></div>
                        <div class="text-start"><span class="text-danger">-1</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-bfbcc03ac38380dc6cc57f21"><span class="term-fg1">diff --git go-ethereum&#47;eth&#47;downloader&#47;fetchers_concurrent_receipts.go op-geth&#47;eth&#47;downloader&#47;fetchers_concurrent_receipts.go</span>
<span class="term-fg1">index 1c853c21844325459d796342e5ee28b45ff2cace..3169f030ba1035a029911ed938cbbceb2fc015cd 100644</span>
<span class="term-fg1">--- go-ethereum&#47;eth&#47;downloader&#47;fetchers_concurrent_receipts.go</span>
<span class="term-fg1">+++ op-geth&#47;eth&#47;downloader&#47;fetchers_concurrent_receipts.go</span>
<span class="term-fg36">@@ -88,7 +88,7 @@</span>
 &#47;&#47; deliver is responsible for taking a generic response packet from the concurrent
 &#47;&#47; fetcher, unpacking the receipt data and delivering it to the downloader&#39;s queue.
 func (q *receiptQueue) deliver(peer *peerConnection, packet *eth.Response) (int, error) {
<span class="term-fg31">-	receipts := *packet.Res.(*eth.ReceiptsPacket)</span>
<span class="term-fg32">+	receipts := *packet.Res.(*eth.ReceiptsResponse)</span>
 	hashes := packet.Meta.([]common.Hash) &#47;&#47; {receipt hashes}
&nbsp;
 	accepted, err := q.queue.DeliverReceipts(peer.id, receipts, hashes)</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-41dea5de11cf48d485598423" role="button"
                   aria-expanded="false" aria-controls="id-41dea5de11cf48d485598423">
                    <code>eth/downloader/peer.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/3f40e65c484486dea6cff80b7db178985d21a2c6/eth/downloader/peer.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/650bb2f2b1dcfe30d9b1fa6f7dc9608055ed60e1/eth/downloader/peer.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+2</span></div>
                        <div class="text-start"><span class="text-danger">-25</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-41dea5de11cf48d485598423"><span class="term-fg1">diff --git go-ethereum&#47;eth&#47;downloader&#47;peer.go op-geth&#47;eth&#47;downloader&#47;peer.go</span>
<span class="term-fg1">index 6b8269495948e8fdae2ccab5bdb3906d4cd593a2..4c43af5270ca88485a96962e7ce0d8b46665619b 100644</span>
<span class="term-fg1">--- go-ethereum&#47;eth&#47;downloader&#47;peer.go</span>
<span class="term-fg1">+++ op-geth&#47;eth&#47;downloader&#47;peer.go</span>
<span class="term-fg36">@@ -55,37 +55,14 @@</span> 	log     log.Logger &#47;&#47; Contextual logger to add extra infos to peer logs
 	lock    sync.RWMutex
 }
&nbsp;
<span class="term-fg31">-&#47;&#47; LightPeer encapsulates the methods required to synchronise with a remote light peer.</span>
<span class="term-fg31">-type LightPeer interface {</span>
<span class="term-fg32">+&#47;&#47; Peer encapsulates the methods required to synchronise with a remote full peer.</span>
<span class="term-fg32">+type Peer interface {</span>
 	Head() (common.Hash, *big.Int)
 	RequestHeadersByHash(common.Hash, int, int, bool, chan *eth.Response) (*eth.Request, error)
 	RequestHeadersByNumber(uint64, int, int, bool, chan *eth.Response) (*eth.Request, error)
<span class="term-fg31">-}</span>
&nbsp;
<span class="term-fg31">-&#47;&#47; Peer encapsulates the methods required to synchronise with a remote full peer.</span>
<span class="term-fg31">-type Peer interface {</span>
<span class="term-fg31">-	LightPeer</span>
 	RequestBodies([]common.Hash, chan *eth.Response) (*eth.Request, error)
 	RequestReceipts([]common.Hash, chan *eth.Response) (*eth.Request, error)
<span class="term-fg31">-}</span>
<span class="term-fg31">-</span>
<span class="term-fg31">-&#47;&#47; lightPeerWrapper wraps a LightPeer struct, stubbing out the Peer-only methods.</span>
<span class="term-fg31">-type lightPeerWrapper struct {</span>
<span class="term-fg31">-	peer LightPeer</span>
<span class="term-fg31">-}</span>
<span class="term-fg31">-</span>
<span class="term-fg31">-func (w *lightPeerWrapper) Head() (common.Hash, *big.Int) { return w.peer.Head() }</span>
<span class="term-fg31">-func (w *lightPeerWrapper) RequestHeadersByHash(h common.Hash, amount int, skip int, reverse bool, sink chan *eth.Response) (*eth.Request, error) {</span>
<span class="term-fg31">-	return w.peer.RequestHeadersByHash(h, amount, skip, reverse, sink)</span>
<span class="term-fg31">-}</span>
<span class="term-fg31">-func (w *lightPeerWrapper) RequestHeadersByNumber(i uint64, amount int, skip int, reverse bool, sink chan *eth.Response) (*eth.Request, error) {</span>
<span class="term-fg31">-	return w.peer.RequestHeadersByNumber(i, amount, skip, reverse, sink)</span>
<span class="term-fg31">-}</span>
<span class="term-fg31">-func (w *lightPeerWrapper) RequestBodies([]common.Hash, chan *eth.Response) (*eth.Request, error) {</span>
<span class="term-fg31">-	panic(&quot;RequestBodies not supported in light client mode sync&quot;)</span>
<span class="term-fg31">-}</span>
<span class="term-fg31">-func (w *lightPeerWrapper) RequestReceipts([]common.Hash, chan *eth.Response) (*eth.Request, error) {</span>
<span class="term-fg31">-	panic(&quot;RequestReceipts not supported in light client mode sync&quot;)</span>
 }
&nbsp;
 &#47;&#47; newPeerConnection creates a new downloader peer.</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-9324ec2574eed0c6ab49a527" role="button"
                   aria-expanded="false" aria-controls="id-9324ec2574eed0c6ab49a527">
                    <code>eth/downloader/skeleton.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/3f40e65c484486dea6cff80b7db178985d21a2c6/eth/downloader/skeleton.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/650bb2f2b1dcfe30d9b1fa6f7dc9608055ed60e1/eth/downloader/skeleton.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+2</span></div>
                        <div class="text-start"><span class="text-danger">-2</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-9324ec2574eed0c6ab49a527"><span class="term-fg1">diff --git go-ethereum&#47;eth&#47;downloader&#47;skeleton.go op-geth&#47;eth&#47;downloader&#47;skeleton.go</span>
<span class="term-fg1">index 59df82bd9eab8d1f24bab309b1b79a31af020a87..4f1f4620481dd1f9da07a4eaa17a99ca98bbe7c3 100644</span>
<span class="term-fg1">--- go-ethereum&#47;eth&#47;downloader&#47;skeleton.go</span>
<span class="term-fg1">+++ op-geth&#47;eth&#47;downloader&#47;skeleton.go</span>
<span class="term-fg36">@@ -423,7 +423,7 @@</span> 	s.idles = make(map[string]*peerConnection)
 	for _, peer := range s.peers.AllPeers() {
 		s.idles[peer.id] = peer
 	}
<span class="term-fg31">-	&#47;&#47; Nofity any tester listening for startup events</span>
<span class="term-fg32">+	&#47;&#47; Notify any tester listening for startup events</span>
 	if s.syncStarting != nil {
 		s.syncStarting()
 	}
<span class="term-fg36">@@ -794,7 +794,7 @@</span> 		s.drop(peer.id)
&nbsp;
 	case res := &lt;-resCh:
 		&#47;&#47; Headers successfully retrieved, update the metrics
<span class="term-fg31">-		headers := *res.Res.(*eth.BlockHeadersPacket)</span>
<span class="term-fg32">+		headers := *res.Res.(*eth.BlockHeadersRequest)</span>
&nbsp;
 		headerReqTimer.Update(time.Since(start))
 		s.peers.rates.Update(peer.id, eth.BlockHeadersMsg, res.Time, len(headers))</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-3d8bebed7649076daf807e1c" role="button"
                   aria-expanded="false" aria-controls="id-3d8bebed7649076daf807e1c">
                    <code>eth/downloader/skeleton_test.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/3f40e65c484486dea6cff80b7db178985d21a2c6/eth/downloader/skeleton_test.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/650bb2f2b1dcfe30d9b1fa6f7dc9608055ed60e1/eth/downloader/skeleton_test.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+3</span></div>
                        <div class="text-start"><span class="text-danger">-3</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-3d8bebed7649076daf807e1c"><span class="term-fg1">diff --git go-ethereum&#47;eth&#47;downloader&#47;skeleton_test.go op-geth&#47;eth&#47;downloader&#47;skeleton_test.go</span>
<span class="term-fg1">index 6a76d78ac817fe6a5f30b6e32ff93e5fe5f65fb8..c31007765a8b722761852a64fee246daf5f8a414 100644</span>
<span class="term-fg1">--- go-ethereum&#47;eth&#47;downloader&#47;skeleton_test.go</span>
<span class="term-fg1">+++ op-geth&#47;eth&#47;downloader&#47;skeleton_test.go</span>
<span class="term-fg36">@@ -173,7 +173,7 @@</span> 		Peer: p.id,
 	}
 	res := &amp;eth.Response{
 		Req:  req,
<span class="term-fg31">-		Res:  (*eth.BlockHeadersPacket)(&amp;headers),</span>
<span class="term-fg32">+		Res:  (*eth.BlockHeadersRequest)(&amp;headers),</span>
 		Meta: hashes,
 		Time: 1,
 		Done: make(chan error),
<span class="term-fg36">@@ -811,7 +811,7 @@</span>
 		&#47;&#47; Create a peer set to feed headers through
 		peerset := newPeerSet()
 		for _, peer := range tt.peers {
<span class="term-fg31">-			peerset.Register(newPeerConnection(peer.id, eth.ETH66, peer, log.New(&quot;id&quot;, peer.id)))</span>
<span class="term-fg32">+			peerset.Register(newPeerConnection(peer.id, eth.ETH67, peer, log.New(&quot;id&quot;, peer.id)))</span>
 		}
 		&#47;&#47; Create a peer dropper to track malicious peers
 		dropped := make(map[string]int)
<span class="term-fg36">@@ -913,7 +913,7 @@</span> 		if tt.newHead != nil {
 			skeleton.Sync(tt.newHead, nil, true)
 		}
 		if tt.newPeer != nil {
<span class="term-fg31">-			if err := peerset.Register(newPeerConnection(tt.newPeer.id, eth.ETH66, tt.newPeer, log.New(&quot;id&quot;, tt.newPeer.id))); err != nil {</span>
<span class="term-fg32">+			if err := peerset.Register(newPeerConnection(tt.newPeer.id, eth.ETH67, tt.newPeer, log.New(&quot;id&quot;, tt.newPeer.id))); err != nil {</span>
 				t.Errorf(&quot;test %d: failed to register new peer: %v&quot;, i, err)
 			}
 		}</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-3c87a42fa4d8b2e9f7175f0d" role="button"
                   aria-expanded="false" aria-controls="id-3c87a42fa4d8b2e9f7175f0d">
                    <code>eth/fetcher/block_fetcher.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/3f40e65c484486dea6cff80b7db178985d21a2c6/eth/fetcher/block_fetcher.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/650bb2f2b1dcfe30d9b1fa6f7dc9608055ed60e1/eth/fetcher/block_fetcher.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+2</span></div>
                        <div class="text-start"><span class="text-danger">-2</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-3c87a42fa4d8b2e9f7175f0d"><span class="term-fg1">diff --git go-ethereum&#47;eth&#47;fetcher&#47;block_fetcher.go op-geth&#47;eth&#47;fetcher&#47;block_fetcher.go</span>
<span class="term-fg1">index 35608031d97926f9131993461e1cf94ae51c8632..8751c4e3ea13c4af35219510eb05893e8ab26a95 100644</span>
<span class="term-fg1">--- go-ethereum&#47;eth&#47;fetcher&#47;block_fetcher.go</span>
<span class="term-fg1">+++ op-geth&#47;eth&#47;fetcher&#47;block_fetcher.go</span>
<span class="term-fg36">@@ -483,7 +483,7 @@</span>
 							select {
 							case res := &lt;-resCh:
 								res.Done &lt;- nil
<span class="term-fg31">-								f.FilterHeaders(peer, *res.Res.(*eth.BlockHeadersPacket), time.Now().Add(res.Time))</span>
<span class="term-fg32">+								f.FilterHeaders(peer, *res.Res.(*eth.BlockHeadersRequest), time.Now().Add(res.Time))</span>
&nbsp;
 							case &lt;-timeout.C:
 								&#47;&#47; The peer didn&#39;t respond in time. The request
<span class="term-fg36">@@ -541,7 +541,7 @@</span> 					select {
 					case res := &lt;-resCh:
 						res.Done &lt;- nil
 						&#47;&#47; Ignoring withdrawals here, since the block fetcher is not used post-merge.
<span class="term-fg31">-						txs, uncles, _ := res.Res.(*eth.BlockBodiesPacket).Unpack()</span>
<span class="term-fg32">+						txs, uncles, _ := res.Res.(*eth.BlockBodiesResponse).Unpack()</span>
 						f.FilterBodies(peer, txs, uncles, time.Now())
&nbsp;
 					case &lt;-timeout.C:</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-7264c2fe6400ab2fe58c8702" role="button"
                   aria-expanded="false" aria-controls="id-7264c2fe6400ab2fe58c8702">
                    <code>eth/fetcher/block_fetcher_test.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/3f40e65c484486dea6cff80b7db178985d21a2c6/eth/fetcher/block_fetcher_test.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/650bb2f2b1dcfe30d9b1fa6f7dc9608055ed60e1/eth/fetcher/block_fetcher_test.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+2</span></div>
                        <div class="text-start"><span class="text-danger">-2</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-7264c2fe6400ab2fe58c8702"><span class="term-fg1">diff --git go-ethereum&#47;eth&#47;fetcher&#47;block_fetcher_test.go op-geth&#47;eth&#47;fetcher&#47;block_fetcher_test.go</span>
<span class="term-fg1">index 7c490df3f7a29e88dc8742d6bb93e3515a60a870..6927300b1d3406d6ee543740f908649318305675 100644</span>
<span class="term-fg1">--- go-ethereum&#47;eth&#47;fetcher&#47;block_fetcher_test.go</span>
<span class="term-fg1">+++ op-geth&#47;eth&#47;fetcher&#47;block_fetcher_test.go</span>
<span class="term-fg36">@@ -213,7 +213,7 @@</span> 			Peer: peer,
 		}
 		res := &amp;eth.Response{
 			Req:  req,
<span class="term-fg31">-			Res:  (*eth.BlockHeadersPacket)(&amp;headers),</span>
<span class="term-fg32">+			Res:  (*eth.BlockHeadersRequest)(&amp;headers),</span>
 			Time: drift,
 			Done: make(chan error, 1), &#47;&#47; Ignore the returned status
 		}
<span class="term-fg36">@@ -255,7 +255,7 @@</span> 			Peer: peer,
 		}
 		res := &amp;eth.Response{
 			Req:  req,
<span class="term-fg31">-			Res:  (*eth.BlockBodiesPacket)(&amp;bodies),</span>
<span class="term-fg32">+			Res:  (*eth.BlockBodiesResponse)(&amp;bodies),</span>
 			Time: drift,
 			Done: make(chan error, 1), &#47;&#47; Ignore the returned status
 		}</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-b59563a0f5bbcde38886fb51" role="button"
                   aria-expanded="false" aria-controls="id-b59563a0f5bbcde38886fb51">
                    <code>eth/fetcher/tx_fetcher.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/3f40e65c484486dea6cff80b7db178985d21a2c6/eth/fetcher/tx_fetcher.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/650bb2f2b1dcfe30d9b1fa6f7dc9608055ed60e1/eth/fetcher/tx_fetcher.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+164</span></div>
                        <div class="text-start"><span class="text-danger">-75</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-b59563a0f5bbcde38886fb51"><span class="term-fg1">diff --git go-ethereum&#47;eth&#47;fetcher&#47;tx_fetcher.go op-geth&#47;eth&#47;fetcher&#47;tx_fetcher.go</span>
<span class="term-fg1">index 95fef0cdeee570ea99d879db43a7019ce57e6767..06e01e1205bdc318c338587c3e9d8208e08006dc 100644</span>
<span class="term-fg1">--- go-ethereum&#47;eth&#47;fetcher&#47;tx_fetcher.go</span>
<span class="term-fg1">+++ op-geth&#47;eth&#47;fetcher&#47;tx_fetcher.go</span>
<span class="term-fg36">@@ -20,12 +20,13 @@</span> import (
 	&quot;bytes&quot;
 	&quot;errors&quot;
 	&quot;fmt&quot;
<span class="term-fg32">+	&quot;math&quot;</span>
 	mrand &quot;math&#47;rand&quot;
 	&quot;sort&quot;
 	&quot;time&quot;
&nbsp;
<span class="term-fg31">-	mapset &quot;github.com&#47;deckarep&#47;golang-set&#47;v2&quot;</span>
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;common&quot;
<span class="term-fg32">+	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;common&#47;lru&quot;</span>
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;common&#47;mclock&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;core&#47;txpool&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;core&#47;types&quot;
<span class="term-fg36">@@ -38,20 +39,29 @@</span> 	&#47;&#47; maxTxAnnounces is the maximum number of unique transaction a peer
 	&#47;&#47; can announce in a short time.
 	maxTxAnnounces = 4096
&nbsp;
<span class="term-fg31">-	&#47;&#47; maxTxRetrievals is the maximum transaction number can be fetched in one</span>
<span class="term-fg31">-	&#47;&#47; request. The rationale to pick 256 is:</span>
<span class="term-fg31">-	&#47;&#47;   - In eth protocol, the softResponseLimit is 2MB. Nowadays according to</span>
<span class="term-fg31">-	&#47;&#47;     Etherscan the average transaction size is around 200B, so in theory</span>
<span class="term-fg31">-	&#47;&#47;     we can include lots of transaction in a single protocol packet.</span>
<span class="term-fg31">-	&#47;&#47;   - However the maximum size of a single transaction is raised to 128KB,</span>
<span class="term-fg31">-	&#47;&#47;     so pick a middle value here to ensure we can maximize the efficiency</span>
<span class="term-fg31">-	&#47;&#47;     of the retrieval and response size overflow won&#39;t happen in most cases.</span>
<span class="term-fg32">+	&#47;&#47; maxTxRetrievals is the maximum number of transactions that can be fetched</span>
<span class="term-fg32">+	&#47;&#47; in one request. The rationale for picking 256 is to have a reasonabe lower</span>
<span class="term-fg32">+	&#47;&#47; bound for the transferred data (don&#39;t waste RTTs, transfer more meaningful</span>
<span class="term-fg32">+	&#47;&#47; batch sizes), but also have an upper bound on the sequentiality to allow</span>
<span class="term-fg32">+	&#47;&#47; using our entire peerset for deliveries.</span>
<span class="term-fg32">+	&#47;&#47;</span>
<span class="term-fg32">+	&#47;&#47; This number also acts as a failsafe against malicious announces which might</span>
<span class="term-fg32">+	&#47;&#47; cause us to request more data than we&#39;d expect.</span>
 	maxTxRetrievals = 256
&nbsp;
<span class="term-fg32">+	&#47;&#47; maxTxRetrievalSize is the max number of bytes that delivered transactions</span>
<span class="term-fg32">+	&#47;&#47; should weigh according to the announcements. The 128KB was chosen to limit</span>
<span class="term-fg32">+	&#47;&#47; retrieving a maximum of one blob transaction at a time to minimize hogging</span>
<span class="term-fg32">+	&#47;&#47; a connection between two peers.</span>
<span class="term-fg32">+	maxTxRetrievalSize = 128 * 1024</span>
<span class="term-fg32">+</span>
 	&#47;&#47; maxTxUnderpricedSetSize is the size of the underpriced transaction set that
 	&#47;&#47; is used to track recent transactions that have been dropped so we don&#39;t
 	&#47;&#47; re-request them.
 	maxTxUnderpricedSetSize = 32768
<span class="term-fg32">+</span>
<span class="term-fg32">+	&#47;&#47; maxTxUnderpricedTimeout is the max time a transaction should be stuck in the underpriced set.</span>
<span class="term-fg32">+	maxTxUnderpricedTimeout = 5 * time.Minute</span>
&nbsp;
 	&#47;&#47; txArriveTimeout is the time allowance before an announced transaction is
 	&#47;&#47; explicitly requested.
<span class="term-fg36">@@ -102,6 +112,14 @@</span> &#47;&#47; of new transactions in the network.
 type txAnnounce struct {
 	origin string        &#47;&#47; Identifier of the peer originating the notification
 	hashes []common.Hash &#47;&#47; Batch of transaction hashes being announced
<span class="term-fg32">+	metas  []*txMetadata &#47;&#47; Batch of metadatas associated with the hashes (nil before eth&#47;68)</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+&#47;&#47; txMetadata is a set of extra data transmitted along the announcement for better</span>
<span class="term-fg32">+&#47;&#47; fetch scheduling.</span>
<span class="term-fg32">+type txMetadata struct {</span>
<span class="term-fg32">+	kind byte   &#47;&#47; Transaction consensus type</span>
<span class="term-fg32">+	size uint32 &#47;&#47; Transaction size in bytes</span>
 }
&nbsp;
 &#47;&#47; txRequest represents an in-flight transaction retrieval request destined to
<span class="term-fg36">@@ -117,6 +135,7 @@</span> &#47;&#47; to the pool and should be untracked.
 type txDelivery struct {
 	origin string        &#47;&#47; Identifier of the peer originating the notification
 	hashes []common.Hash &#47;&#47; Batch of transaction hashes having been delivered
<span class="term-fg32">+	metas  []txMetadata  &#47;&#47; Batch of metadatas associated with the delivered hashes</span>
 	direct bool          &#47;&#47; Whether this is a direct reply or a broadcast
 }
&nbsp;
<span class="term-fg36">@@ -148,18 +167,18 @@</span> 	cleanup chan *txDelivery
 	drop    chan *txDrop
 	quit    chan struct{}
&nbsp;
<span class="term-fg31">-	underpriced mapset.Set[common.Hash] &#47;&#47; Transactions discarded as too cheap (don&#39;t re-fetch)</span>
<span class="term-fg32">+	underpriced *lru.Cache[common.Hash, time.Time] &#47;&#47; Transactions discarded as too cheap (don&#39;t re-fetch)</span>
&nbsp;
 	&#47;&#47; Stage 1: Waiting lists for newly discovered transactions that might be
 	&#47;&#47; broadcast without needing explicit request&#47;reply round trips.
<span class="term-fg31">-	waitlist  map[common.Hash]map[string]struct{} &#47;&#47; Transactions waiting for an potential broadcast</span>
<span class="term-fg31">-	waittime  map[common.Hash]mclock.AbsTime      &#47;&#47; Timestamps when transactions were added to the waitlist</span>
<span class="term-fg31">-	waitslots map[string]map[common.Hash]struct{} &#47;&#47; Waiting announcements grouped by peer (DoS protection)</span>
<span class="term-fg32">+	waitlist  map[common.Hash]map[string]struct{}    &#47;&#47; Transactions waiting for an potential broadcast</span>
<span class="term-fg32">+	waittime  map[common.Hash]mclock.AbsTime         &#47;&#47; Timestamps when transactions were added to the waitlist</span>
<span class="term-fg32">+	waitslots map[string]map[common.Hash]*txMetadata &#47;&#47; Waiting announcements grouped by peer (DoS protection)</span>
&nbsp;
 	&#47;&#47; Stage 2: Queue of transactions that waiting to be allocated to some peer
 	&#47;&#47; to be retrieved directly.
<span class="term-fg31">-	announces map[string]map[common.Hash]struct{} &#47;&#47; Set of announced transactions, grouped by origin peer</span>
<span class="term-fg31">-	announced map[common.Hash]map[string]struct{} &#47;&#47; Set of download locations, grouped by transaction hash</span>
<span class="term-fg32">+	announces map[string]map[common.Hash]*txMetadata &#47;&#47; Set of announced transactions, grouped by origin peer</span>
<span class="term-fg32">+	announced map[common.Hash]map[string]struct{}    &#47;&#47; Set of download locations, grouped by transaction hash</span>
&nbsp;
 	&#47;&#47; Stage 3: Set of transactions currently being retrieved, some which may be
 	&#47;&#47; fulfilled and some rescheduled. Note, this step shares &#39;announces&#39; from the
<span class="term-fg36">@@ -172,6 +191,7 @@</span> 	&#47;&#47; Callbacks
 	hasTx    func(common.Hash) bool             &#47;&#47; Retrieves a tx from the local txpool
 	addTxs   func([]*types.Transaction) []error &#47;&#47; Insert a batch of transactions into local txpool
 	fetchTxs func(string, []common.Hash) error  &#47;&#47; Retrieves a set of txs from a remote peer
<span class="term-fg32">+	dropPeer func(string)                       &#47;&#47; Drops a peer in case of announcement violation</span>
&nbsp;
 	step  chan struct{} &#47;&#47; Notification channel when the fetcher loop iterates
 	clock mclock.Clock  &#47;&#47; Time wrapper to simulate in tests
<span class="term-fg36">@@ -180,14 +200,14 @@</span> }
&nbsp;
 &#47;&#47; NewTxFetcher creates a transaction fetcher to retrieve transaction
 &#47;&#47; based on hash announcements.
<span class="term-fg31">-func NewTxFetcher(hasTx func(common.Hash) bool, addTxs func([]*types.Transaction) []error, fetchTxs func(string, []common.Hash) error) *TxFetcher {</span>
<span class="term-fg31">-	return NewTxFetcherForTests(hasTx, addTxs, fetchTxs, mclock.System{}, nil)</span>
<span class="term-fg32">+func NewTxFetcher(hasTx func(common.Hash) bool, addTxs func([]*types.Transaction) []error, fetchTxs func(string, []common.Hash) error, dropPeer func(string)) *TxFetcher {</span>
<span class="term-fg32">+	return NewTxFetcherForTests(hasTx, addTxs, fetchTxs, dropPeer, mclock.System{}, nil)</span>
 }
&nbsp;
 &#47;&#47; NewTxFetcherForTests is a testing method to mock out the realtime clock with
 &#47;&#47; a simulated version and the internal randomness with a deterministic one.
 func NewTxFetcherForTests(
<span class="term-fg31">-	hasTx func(common.Hash) bool, addTxs func([]*types.Transaction) []error, fetchTxs func(string, []common.Hash) error,</span>
<span class="term-fg32">+	hasTx func(common.Hash) bool, addTxs func([]*types.Transaction) []error, fetchTxs func(string, []common.Hash) error, dropPeer func(string),</span>
 	clock mclock.Clock, rand *mrand.Rand) *TxFetcher {
 	return &amp;TxFetcher{
 		notify:      make(chan *txAnnounce),
<span class="term-fg36">@@ -196,16 +216,17 @@</span> 		drop:        make(chan *txDrop),
 		quit:        make(chan struct{}),
 		waitlist:    make(map[common.Hash]map[string]struct{}),
 		waittime:    make(map[common.Hash]mclock.AbsTime),
<span class="term-fg31">-		waitslots:   make(map[string]map[common.Hash]struct{}),</span>
<span class="term-fg31">-		announces:   make(map[string]map[common.Hash]struct{}),</span>
<span class="term-fg32">+		waitslots:   make(map[string]map[common.Hash]*txMetadata),</span>
<span class="term-fg32">+		announces:   make(map[string]map[common.Hash]*txMetadata),</span>
 		announced:   make(map[common.Hash]map[string]struct{}),
 		fetching:    make(map[common.Hash]string),
 		requests:    make(map[string]*txRequest),
 		alternates:  make(map[common.Hash]map[string]struct{}),
<span class="term-fg31">-		underpriced: mapset.NewSet[common.Hash](),</span>
<span class="term-fg32">+		underpriced: lru.NewCache[common.Hash, time.Time](maxTxUnderpricedSetSize),</span>
 		hasTx:       hasTx,
 		addTxs:      addTxs,
 		fetchTxs:    fetchTxs,
<span class="term-fg32">+		dropPeer:    dropPeer,</span>
 		clock:       clock,
 		rand:        rand,
 	}
<span class="term-fg36">@@ -213,7 +234,7 @@</span> }
&nbsp;
 &#47;&#47; Notify announces the fetcher of the potential availability of a new batch of
 &#47;&#47; transactions in the network.
<span class="term-fg31">-func (f *TxFetcher) Notify(peer string, hashes []common.Hash) error {</span>
<span class="term-fg32">+func (f *TxFetcher) Notify(peer string, types []byte, sizes []uint32, hashes []common.Hash) error {</span>
 	&#47;&#47; Keep track of all the announced transactions
 	txAnnounceInMeter.Mark(int64(len(hashes)))
&nbsp;
<span class="term-fg36">@@ -223,32 +244,35 @@</span> 	&#47;&#47; because multiple concurrent notifies will still manage to pass it, but it&#39;s
 	&#47;&#47; still valuable to check here because it runs concurrent  to the internal
 	&#47;&#47; loop, so anything caught here is time saved internally.
 	var (
<span class="term-fg31">-		unknowns               = make([]common.Hash, 0, len(hashes))</span>
<span class="term-fg31">-		duplicate, underpriced int64</span>
<span class="term-fg32">+		unknownHashes = make([]common.Hash, 0, len(hashes))</span>
<span class="term-fg32">+		unknownMetas  = make([]*txMetadata, 0, len(hashes))</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+		duplicate   int64</span>
<span class="term-fg32">+		underpriced int64</span>
 	)
<span class="term-fg31">-	for _, hash := range hashes {</span>
<span class="term-fg32">+	for i, hash := range hashes {</span>
 		switch {
 		case f.hasTx(hash):
 			duplicate++
<span class="term-fg31">-</span>
<span class="term-fg31">-		case f.underpriced.Contains(hash):</span>
<span class="term-fg32">+		case f.isKnownUnderpriced(hash):</span>
 			underpriced++
<span class="term-fg31">-</span>
 		default:
<span class="term-fg31">-			unknowns = append(unknowns, hash)</span>
<span class="term-fg32">+			unknownHashes = append(unknownHashes, hash)</span>
<span class="term-fg32">+			if types == nil {</span>
<span class="term-fg32">+				unknownMetas = append(unknownMetas, nil)</span>
<span class="term-fg32">+			} else {</span>
<span class="term-fg32">+				unknownMetas = append(unknownMetas, &amp;txMetadata{kind: types[i], size: sizes[i]})</span>
<span class="term-fg32">+			}</span>
 		}
 	}
 	txAnnounceKnownMeter.Mark(duplicate)
 	txAnnounceUnderpricedMeter.Mark(underpriced)
&nbsp;
 	&#47;&#47; If anything&#39;s left to announce, push it into the internal loop
<span class="term-fg31">-	if len(unknowns) == 0 {</span>
<span class="term-fg32">+	if len(unknownHashes) == 0 {</span>
 		return nil
 	}
<span class="term-fg31">-	announce := &amp;txAnnounce{</span>
<span class="term-fg31">-		origin: peer,</span>
<span class="term-fg31">-		hashes: unknowns,</span>
<span class="term-fg31">-	}</span>
<span class="term-fg32">+	announce := &amp;txAnnounce{origin: peer, hashes: unknownHashes, metas: unknownMetas}</span>
 	select {
 	case f.notify &lt;- announce:
 		return nil
<span class="term-fg36">@@ -257,6 +281,16 @@</span> 		return errTerminated
 	}
 }
&nbsp;
<span class="term-fg32">+&#47;&#47; isKnownUnderpriced reports whether a transaction hash was recently found to be underpriced.</span>
<span class="term-fg32">+func (f *TxFetcher) isKnownUnderpriced(hash common.Hash) bool {</span>
<span class="term-fg32">+	prevTime, ok := f.underpriced.Peek(hash)</span>
<span class="term-fg32">+	if ok &amp;&amp; prevTime.Before(time.Now().Add(-maxTxUnderpricedTimeout)) {</span>
<span class="term-fg32">+		f.underpriced.Remove(hash)</span>
<span class="term-fg32">+		return false</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	return ok</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
 &#47;&#47; Enqueue imports a batch of received transaction into the transaction pool
 &#47;&#47; and the fetcher. This method may be called by both transaction broadcasts and
 &#47;&#47; direct request replies. The differentiation is important so the fetcher can
<span class="term-fg36">@@ -281,6 +315,7 @@</span> 	&#47;&#47; Push all the transactions into the pool, tracking underpriced ones to avoid
 	&#47;&#47; re-requesting them and dropping the peer in case of malicious transfers.
 	var (
 		added = make([]common.Hash, 0, len(txs))
<span class="term-fg32">+		metas = make([]txMetadata, 0, len(txs))</span>
 	)
 	&#47;&#47; proceed in batches
 	for i := 0; i &lt; len(txs); i += 128 {
<span class="term-fg36">@@ -300,10 +335,7 @@</span> 			&#47;&#47; Track the transaction hash if the price is too low for us.
 			&#47;&#47; Avoid re-request this transaction when we receive another
 			&#47;&#47; announcement.
 			if errors.Is(err, txpool.ErrUnderpriced) || errors.Is(err, txpool.ErrReplaceUnderpriced) {
<span class="term-fg31">-				for f.underpriced.Cardinality() &gt;= maxTxUnderpricedSetSize {</span>
<span class="term-fg31">-					f.underpriced.Pop()</span>
<span class="term-fg31">-				}</span>
<span class="term-fg31">-				f.underpriced.Add(batch[j].Hash())</span>
<span class="term-fg32">+				f.underpriced.Add(batch[j].Hash(), batch[j].Time())</span>
 			}
 			&#47;&#47; Track a few interesting failure types
 			switch {
<span class="term-fg36">@@ -319,6 +351,10 @@</span> 			default:
 				otherreject++
 			}
 			added = append(added, batch[j].Hash())
<span class="term-fg32">+			metas = append(metas, txMetadata{</span>
<span class="term-fg32">+				kind: batch[j].Type(),</span>
<span class="term-fg32">+				size: uint32(batch[j].Size()),</span>
<span class="term-fg32">+			})</span>
 		}
 		knownMeter.Mark(duplicate)
 		underpricedMeter.Mark(underpriced)
<span class="term-fg36">@@ -331,7 +367,7 @@</span> 			log.Warn(&quot;Peer delivering stale transactions&quot;, &quot;peer&quot;, peer, &quot;rejected&quot;, otherreject)
 		}
 	}
 	select {
<span class="term-fg31">-	case f.cleanup &lt;- &amp;txDelivery{origin: peer, hashes: added, direct: direct}:</span>
<span class="term-fg32">+	case f.cleanup &lt;- &amp;txDelivery{origin: peer, hashes: added, metas: metas, direct: direct}:</span>
 		return nil
 	case &lt;-f.quit:
 		return errTerminated
<span class="term-fg36">@@ -388,13 +424,15 @@</span> 			}
 			want := used + len(ann.hashes)
 			if want &gt; maxTxAnnounces {
 				txAnnounceDOSMeter.Mark(int64(want - maxTxAnnounces))
<span class="term-fg32">+</span>
 				ann.hashes = ann.hashes[:want-maxTxAnnounces]
<span class="term-fg32">+				ann.metas = ann.metas[:want-maxTxAnnounces]</span>
 			}
 			&#47;&#47; All is well, schedule the remainder of the transactions
 			idleWait := len(f.waittime) == 0
 			_, oldPeer := f.announces[ann.origin]
&nbsp;
<span class="term-fg31">-			for _, hash := range ann.hashes {</span>
<span class="term-fg32">+			for i, hash := range ann.hashes {</span>
 				&#47;&#47; If the transaction is already downloading, add it to the list
 				&#47;&#47; of possible alternates (in case the current retrieval fails) and
 				&#47;&#47; also account it for the peer.
<span class="term-fg36">@@ -403,9 +441,9 @@</span> 					f.alternates[hash][ann.origin] = struct{}{}
&nbsp;
 					&#47;&#47; Stage 2 and 3 share the set of origins per tx
 					if announces := f.announces[ann.origin]; announces != nil {
<span class="term-fg31">-						announces[hash] = struct{}{}</span>
<span class="term-fg32">+						announces[hash] = ann.metas[i]</span>
 					} else {
<span class="term-fg31">-						f.announces[ann.origin] = map[common.Hash]struct{}{hash: {}}</span>
<span class="term-fg32">+						f.announces[ann.origin] = map[common.Hash]*txMetadata{hash: ann.metas[i]}</span>
 					}
 					continue
 				}
<span class="term-fg36">@@ -416,9 +454,9 @@</span> 					f.announced[hash][ann.origin] = struct{}{}
&nbsp;
 					&#47;&#47; Stage 2 and 3 share the set of origins per tx
 					if announces := f.announces[ann.origin]; announces != nil {
<span class="term-fg31">-						announces[hash] = struct{}{}</span>
<span class="term-fg32">+						announces[hash] = ann.metas[i]</span>
 					} else {
<span class="term-fg31">-						f.announces[ann.origin] = map[common.Hash]struct{}{hash: {}}</span>
<span class="term-fg32">+						f.announces[ann.origin] = map[common.Hash]*txMetadata{hash: ann.metas[i]}</span>
 					}
 					continue
 				}
<span class="term-fg36">@@ -426,12 +464,18 @@</span> 				&#47;&#47; If the transaction is already known to the fetcher, but not
 				&#47;&#47; yet downloading, add the peer as an alternate origin in the
 				&#47;&#47; waiting list.
 				if f.waitlist[hash] != nil {
<span class="term-fg32">+					&#47;&#47; Ignore double announcements from the same peer. This is</span>
<span class="term-fg32">+					&#47;&#47; especially important if metadata is also passed along to</span>
<span class="term-fg32">+					&#47;&#47; prevent malicious peers flip-flopping good&#47;bad values.</span>
<span class="term-fg32">+					if _, ok := f.waitlist[hash][ann.origin]; ok {</span>
<span class="term-fg32">+						continue</span>
<span class="term-fg32">+					}</span>
 					f.waitlist[hash][ann.origin] = struct{}{}
&nbsp;
 					if waitslots := f.waitslots[ann.origin]; waitslots != nil {
<span class="term-fg31">-						waitslots[hash] = struct{}{}</span>
<span class="term-fg32">+						waitslots[hash] = ann.metas[i]</span>
 					} else {
<span class="term-fg31">-						f.waitslots[ann.origin] = map[common.Hash]struct{}{hash: {}}</span>
<span class="term-fg32">+						f.waitslots[ann.origin] = map[common.Hash]*txMetadata{hash: ann.metas[i]}</span>
 					}
 					continue
 				}
<span class="term-fg36">@@ -440,9 +484,9 @@</span> 				f.waitlist[hash] = map[string]struct{}{ann.origin: {}}
 				f.waittime[hash] = f.clock.Now()
&nbsp;
 				if waitslots := f.waitslots[ann.origin]; waitslots != nil {
<span class="term-fg31">-					waitslots[hash] = struct{}{}</span>
<span class="term-fg32">+					waitslots[hash] = ann.metas[i]</span>
 				} else {
<span class="term-fg31">-					f.waitslots[ann.origin] = map[common.Hash]struct{}{hash: {}}</span>
<span class="term-fg32">+					f.waitslots[ann.origin] = map[common.Hash]*txMetadata{hash: ann.metas[i]}</span>
 				}
 			}
 			&#47;&#47; If a new item was added to the waitlist, schedule it into the fetcher
<span class="term-fg36">@@ -468,9 +512,9 @@</span> 					}
 					f.announced[hash] = f.waitlist[hash]
 					for peer := range f.waitlist[hash] {
 						if announces := f.announces[peer]; announces != nil {
<span class="term-fg31">-							announces[hash] = struct{}{}</span>
<span class="term-fg32">+							announces[hash] = f.waitslots[peer][hash]</span>
 						} else {
<span class="term-fg31">-							f.announces[peer] = map[common.Hash]struct{}{hash: {}}</span>
<span class="term-fg32">+							f.announces[peer] = map[common.Hash]*txMetadata{hash: f.waitslots[peer][hash]}</span>
 						}
 						delete(f.waitslots[peer], hash)
 						if len(f.waitslots[peer]) == 0 {
<span class="term-fg36">@@ -539,10 +583,27 @@</span> 			f.rescheduleTimeout(timeoutTimer, timeoutTrigger)
&nbsp;
 		case delivery := &lt;-f.cleanup:
 			&#47;&#47; Independent if the delivery was direct or broadcast, remove all
<span class="term-fg31">-			&#47;&#47; traces of the hash from internal trackers</span>
<span class="term-fg31">-			for _, hash := range delivery.hashes {</span>
<span class="term-fg32">+			&#47;&#47; traces of the hash from internal trackers. That said, compare any</span>
<span class="term-fg32">+			&#47;&#47; advertised metadata with the real ones and drop bad peers.</span>
<span class="term-fg32">+			for i, hash := range delivery.hashes {</span>
 				if _, ok := f.waitlist[hash]; ok {
 					for peer, txset := range f.waitslots {
<span class="term-fg32">+						if meta := txset[hash]; meta != nil {</span>
<span class="term-fg32">+							if delivery.metas[i].kind != meta.kind {</span>
<span class="term-fg32">+								log.Warn(&quot;Announced transaction type mismatch&quot;, &quot;peer&quot;, peer, &quot;tx&quot;, hash, &quot;type&quot;, delivery.metas[i].kind, &quot;ann&quot;, meta.kind)</span>
<span class="term-fg32">+								f.dropPeer(peer)</span>
<span class="term-fg32">+							} else if delivery.metas[i].size != meta.size {</span>
<span class="term-fg32">+								log.Warn(&quot;Announced transaction size mismatch&quot;, &quot;peer&quot;, peer, &quot;tx&quot;, hash, &quot;size&quot;, delivery.metas[i].size, &quot;ann&quot;, meta.size)</span>
<span class="term-fg32">+								if math.Abs(float64(delivery.metas[i].size)-float64(meta.size)) &gt; 8 {</span>
<span class="term-fg32">+									&#47;&#47; Normally we should drop a peer considering this is a protocol violation.</span>
<span class="term-fg32">+									&#47;&#47; However, due to the RLP vs consensus format messyness, allow a few bytes</span>
<span class="term-fg32">+									&#47;&#47; wiggle-room where we only warn, but don&#39;t drop.</span>
<span class="term-fg32">+									&#47;&#47;</span>
<span class="term-fg32">+									&#47;&#47; TODO(karalabe): Get rid of this relaxation when clients are proven stable.</span>
<span class="term-fg32">+									f.dropPeer(peer)</span>
<span class="term-fg32">+								}</span>
<span class="term-fg32">+							}</span>
<span class="term-fg32">+						}</span>
 						delete(txset, hash)
 						if len(txset) == 0 {
 							delete(f.waitslots, peer)
<span class="term-fg36">@@ -552,6 +613,22 @@</span> 					delete(f.waitlist, hash)
 					delete(f.waittime, hash)
 				} else {
 					for peer, txset := range f.announces {
<span class="term-fg32">+						if meta := txset[hash]; meta != nil {</span>
<span class="term-fg32">+							if delivery.metas[i].kind != meta.kind {</span>
<span class="term-fg32">+								log.Warn(&quot;Announced transaction type mismatch&quot;, &quot;peer&quot;, peer, &quot;tx&quot;, hash, &quot;type&quot;, delivery.metas[i].kind, &quot;ann&quot;, meta.kind)</span>
<span class="term-fg32">+								f.dropPeer(peer)</span>
<span class="term-fg32">+							} else if delivery.metas[i].size != meta.size {</span>
<span class="term-fg32">+								log.Warn(&quot;Announced transaction size mismatch&quot;, &quot;peer&quot;, peer, &quot;tx&quot;, hash, &quot;size&quot;, delivery.metas[i].size, &quot;ann&quot;, meta.size)</span>
<span class="term-fg32">+								if math.Abs(float64(delivery.metas[i].size)-float64(meta.size)) &gt; 8 {</span>
<span class="term-fg32">+									&#47;&#47; Normally we should drop a peer considering this is a protocol violation.</span>
<span class="term-fg32">+									&#47;&#47; However, due to the RLP vs consensus format messyness, allow a few bytes</span>
<span class="term-fg32">+									&#47;&#47; wiggle-room where we only warn, but don&#39;t drop.</span>
<span class="term-fg32">+									&#47;&#47;</span>
<span class="term-fg32">+									&#47;&#47; TODO(karalabe): Get rid of this relaxation when clients are proven stable.</span>
<span class="term-fg32">+									f.dropPeer(peer)</span>
<span class="term-fg32">+								}</span>
<span class="term-fg32">+							}</span>
<span class="term-fg32">+						}</span>
 						delete(txset, hash)
 						if len(txset) == 0 {
 							delete(f.announces, peer)
<span class="term-fg36">@@ -788,25 +865,36 @@</span> 		}
 		if len(f.announces[peer]) == 0 {
 			return &#47;&#47; continue in the for-each
 		}
<span class="term-fg31">-		hashes := make([]common.Hash, 0, maxTxRetrievals)</span>
<span class="term-fg31">-		f.forEachHash(f.announces[peer], func(hash common.Hash) bool {</span>
<span class="term-fg31">-			if _, ok := f.fetching[hash]; !ok {</span>
<span class="term-fg31">-				&#47;&#47; Mark the hash as fetching and stash away possible alternates</span>
<span class="term-fg31">-				f.fetching[hash] = peer</span>
<span class="term-fg32">+		var (</span>
<span class="term-fg32">+			hashes = make([]common.Hash, 0, maxTxRetrievals)</span>
<span class="term-fg32">+			bytes  uint64</span>
<span class="term-fg32">+		)</span>
<span class="term-fg32">+		f.forEachAnnounce(f.announces[peer], func(hash common.Hash, meta *txMetadata) bool {</span>
<span class="term-fg32">+			&#47;&#47; If the transaction is already fetching, skip to the next one</span>
<span class="term-fg32">+			if _, ok := f.fetching[hash]; ok {</span>
<span class="term-fg32">+				return true</span>
<span class="term-fg32">+			}</span>
<span class="term-fg32">+			&#47;&#47; Mark the hash as fetching and stash away possible alternates</span>
<span class="term-fg32">+			f.fetching[hash] = peer</span>
&nbsp;
<span class="term-fg31">-				if _, ok := f.alternates[hash]; ok {</span>
<span class="term-fg31">-					panic(fmt.Sprintf(&quot;alternate tracker already contains fetching item: %v&quot;, f.alternates[hash]))</span>
<span class="term-fg31">-				}</span>
<span class="term-fg31">-				f.alternates[hash] = f.announced[hash]</span>
<span class="term-fg31">-				delete(f.announced, hash)</span>
<span class="term-fg32">+			if _, ok := f.alternates[hash]; ok {</span>
<span class="term-fg32">+				panic(fmt.Sprintf(&quot;alternate tracker already contains fetching item: %v&quot;, f.alternates[hash]))</span>
<span class="term-fg32">+			}</span>
<span class="term-fg32">+			f.alternates[hash] = f.announced[hash]</span>
<span class="term-fg32">+			delete(f.announced, hash)</span>
&nbsp;
<span class="term-fg31">-				&#47;&#47; Accumulate the hash and stop if the limit was reached</span>
<span class="term-fg31">-				hashes = append(hashes, hash)</span>
<span class="term-fg31">-				if len(hashes) &gt;= maxTxRetrievals {</span>
<span class="term-fg31">-					return false &#47;&#47; break in the for-each</span>
<span class="term-fg32">+			&#47;&#47; Accumulate the hash and stop if the limit was reached</span>
<span class="term-fg32">+			hashes = append(hashes, hash)</span>
<span class="term-fg32">+			if len(hashes) &gt;= maxTxRetrievals {</span>
<span class="term-fg32">+				return false &#47;&#47; break in the for-each</span>
<span class="term-fg32">+			}</span>
<span class="term-fg32">+			if meta != nil { &#47;&#47; Only set eth&#47;68 and upwards</span>
<span class="term-fg32">+				bytes += uint64(meta.size)</span>
<span class="term-fg32">+				if bytes &gt;= maxTxRetrievalSize {</span>
<span class="term-fg32">+					return false</span>
 				}
 			}
<span class="term-fg31">-			return true &#47;&#47; continue in the for-each</span>
<span class="term-fg32">+			return true &#47;&#47; scheduled, try to add more</span>
 		})
 		&#47;&#47; If any hashes were allocated, request them from the peer
 		if len(hashes) &gt; 0 {
<span class="term-fg36">@@ -851,27 +939,28 @@</span> 		do(peer)
 	}
 }
&nbsp;
<span class="term-fg31">-&#47;&#47; forEachHash does a range loop over a map of hashes in production, but during</span>
<span class="term-fg31">-&#47;&#47; testing it does a deterministic sorted random to allow reproducing issues.</span>
<span class="term-fg31">-func (f *TxFetcher) forEachHash(hashes map[common.Hash]struct{}, do func(hash common.Hash) bool) {</span>
<span class="term-fg32">+&#47;&#47; forEachAnnounce does a range loop over a map of announcements in production,</span>
<span class="term-fg32">+&#47;&#47; but during testing it does a deterministic sorted random to allow reproducing</span>
<span class="term-fg32">+&#47;&#47; issues.</span>
<span class="term-fg32">+func (f *TxFetcher) forEachAnnounce(announces map[common.Hash]*txMetadata, do func(hash common.Hash, meta *txMetadata) bool) {</span>
 	&#47;&#47; If we&#39;re running production, use whatever Go&#39;s map gives us
 	if f.rand == nil {
<span class="term-fg31">-		for hash := range hashes {</span>
<span class="term-fg31">-			if !do(hash) {</span>
<span class="term-fg32">+		for hash, meta := range announces {</span>
<span class="term-fg32">+			if !do(hash, meta) {</span>
 				return
 			}
 		}
 		return
 	}
 	&#47;&#47; We&#39;re running the test suite, make iteration deterministic
<span class="term-fg31">-	list := make([]common.Hash, 0, len(hashes))</span>
<span class="term-fg31">-	for hash := range hashes {</span>
<span class="term-fg32">+	list := make([]common.Hash, 0, len(announces))</span>
<span class="term-fg32">+	for hash := range announces {</span>
 		list = append(list, hash)
 	}
 	sortHashes(list)
 	rotateHashes(list, f.rand.Intn(len(list)))
 	for _, hash := range list {
<span class="term-fg31">-		if !do(hash) {</span>
<span class="term-fg32">+		if !do(hash, announces[hash]) {</span>
 			return
 		}
 	}</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-2f2a31bf35d13ea763bf7c77" role="button"
                   aria-expanded="false" aria-controls="id-2f2a31bf35d13ea763bf7c77">
                    <code>eth/fetcher/tx_fetcher_test.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/3f40e65c484486dea6cff80b7db178985d21a2c6/eth/fetcher/tx_fetcher_test.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/650bb2f2b1dcfe30d9b1fa6f7dc9608055ed60e1/eth/fetcher/tx_fetcher_test.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+528</span></div>
                        <div class="text-start"><span class="text-danger">-35</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-2f2a31bf35d13ea763bf7c77"><span class="term-fg1">diff --git go-ethereum&#47;eth&#47;fetcher&#47;tx_fetcher_test.go op-geth&#47;eth&#47;fetcher&#47;tx_fetcher_test.go</span>
<span class="term-fg1">index 1715def99c00ff9cd93d13f338a4f72cc6eb3fd3..77b89085d317c5639f9d8e30f0c2664049b6ec46 100644</span>
<span class="term-fg1">--- go-ethereum&#47;eth&#47;fetcher&#47;tx_fetcher_test.go</span>
<span class="term-fg1">+++ op-geth&#47;eth&#47;fetcher&#47;tx_fetcher_test.go</span>
<span class="term-fg36">@@ -27,6 +27,7 @@</span> 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;common&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;common&#47;mclock&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;core&#47;txpool&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;core&#47;types&quot;
<span class="term-fg32">+	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;params&quot;</span>
 )
&nbsp;
 var (
<span class="term-fg36">@@ -41,9 +42,20 @@</span> 	&#47;&#47; testTxsHashes is the hashes of the test transactions above
 	testTxsHashes = []common.Hash{testTxs[0].Hash(), testTxs[1].Hash(), testTxs[2].Hash(), testTxs[3].Hash()}
 )
&nbsp;
<span class="term-fg32">+type announce struct {</span>
<span class="term-fg32">+	hash common.Hash</span>
<span class="term-fg32">+	kind *byte</span>
<span class="term-fg32">+	size *uint32</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func typeptr(t byte) *byte     { return &amp;t }</span>
<span class="term-fg32">+func sizeptr(n uint32) *uint32 { return &amp;n }</span>
<span class="term-fg32">+</span>
 type doTxNotify struct {
 	peer   string
 	hashes []common.Hash
<span class="term-fg32">+	types  []byte</span>
<span class="term-fg32">+	sizes  []uint32</span>
 }
 type doTxEnqueue struct {
 	peer   string
<span class="term-fg36">@@ -57,7 +69,14 @@</span> }
 type doDrop string
 type doFunc func()
&nbsp;
<span class="term-fg32">+type isWaitingWithMeta map[string][]announce</span>
 type isWaiting map[string][]common.Hash
<span class="term-fg32">+</span>
<span class="term-fg32">+type isScheduledWithMeta struct {</span>
<span class="term-fg32">+	tracking map[string][]announce</span>
<span class="term-fg32">+	fetching map[string][]common.Hash</span>
<span class="term-fg32">+	dangling map[string][]common.Hash</span>
<span class="term-fg32">+}</span>
 type isScheduled struct {
 	tracking map[string][]common.Hash
 	fetching map[string][]common.Hash
<span class="term-fg36">@@ -81,6 +100,7 @@</span> 			return NewTxFetcher(
 				func(common.Hash) bool { return false },
 				nil,
 				func(string, []common.Hash) error { return nil },
<span class="term-fg32">+				nil,</span>
 			)
 		},
 		steps: []interface{}{
<span class="term-fg36">@@ -162,6 +182,212 @@</span> 		},
 	})
 }
&nbsp;
<span class="term-fg32">+&#47;&#47; Tests that transaction announcements with associated metadata are added to a</span>
<span class="term-fg32">+&#47;&#47; waitlist, and none of them are scheduled for retrieval until the wait expires.</span>
<span class="term-fg32">+&#47;&#47;</span>
<span class="term-fg32">+&#47;&#47; This test is an extended version of TestTransactionFetcherWaiting. It&#39;s mostly</span>
<span class="term-fg32">+&#47;&#47; to cover the metadata checkes without bloating up the basic behavioral tests</span>
<span class="term-fg32">+&#47;&#47; with all the useless extra fields.</span>
<span class="term-fg32">+func TestTransactionFetcherWaitingWithMeta(t *testing.T) {</span>
<span class="term-fg32">+	testTransactionFetcherParallel(t, txFetcherTest{</span>
<span class="term-fg32">+		init: func() *TxFetcher {</span>
<span class="term-fg32">+			return NewTxFetcher(</span>
<span class="term-fg32">+				func(common.Hash) bool { return false },</span>
<span class="term-fg32">+				nil,</span>
<span class="term-fg32">+				func(string, []common.Hash) error { return nil },</span>
<span class="term-fg32">+				nil,</span>
<span class="term-fg32">+			)</span>
<span class="term-fg32">+		},</span>
<span class="term-fg32">+		steps: []interface{}{</span>
<span class="term-fg32">+			&#47;&#47; Initial announcement to get something into the waitlist</span>
<span class="term-fg32">+			doTxNotify{peer: &quot;A&quot;, hashes: []common.Hash{{0x01}, {0x02}}, types: []byte{types.LegacyTxType, types.LegacyTxType}, sizes: []uint32{111, 222}},</span>
<span class="term-fg32">+			isWaitingWithMeta(map[string][]announce{</span>
<span class="term-fg32">+				&quot;A&quot;: {</span>
<span class="term-fg32">+					{common.Hash{0x01}, typeptr(types.LegacyTxType), sizeptr(111)},</span>
<span class="term-fg32">+					{common.Hash{0x02}, typeptr(types.LegacyTxType), sizeptr(222)},</span>
<span class="term-fg32">+				},</span>
<span class="term-fg32">+			}),</span>
<span class="term-fg32">+			&#47;&#47; Announce from a new peer to check that no overwrite happens</span>
<span class="term-fg32">+			doTxNotify{peer: &quot;B&quot;, hashes: []common.Hash{{0x03}, {0x04}}, types: []byte{types.LegacyTxType, types.LegacyTxType}, sizes: []uint32{333, 444}},</span>
<span class="term-fg32">+			isWaitingWithMeta(map[string][]announce{</span>
<span class="term-fg32">+				&quot;A&quot;: {</span>
<span class="term-fg32">+					{common.Hash{0x01}, typeptr(types.LegacyTxType), sizeptr(111)},</span>
<span class="term-fg32">+					{common.Hash{0x02}, typeptr(types.LegacyTxType), sizeptr(222)},</span>
<span class="term-fg32">+				},</span>
<span class="term-fg32">+				&quot;B&quot;: {</span>
<span class="term-fg32">+					{common.Hash{0x03}, typeptr(types.LegacyTxType), sizeptr(333)},</span>
<span class="term-fg32">+					{common.Hash{0x04}, typeptr(types.LegacyTxType), sizeptr(444)},</span>
<span class="term-fg32">+				},</span>
<span class="term-fg32">+			}),</span>
<span class="term-fg32">+			&#47;&#47; Announce clashing hashes but unique new peer</span>
<span class="term-fg32">+			doTxNotify{peer: &quot;C&quot;, hashes: []common.Hash{{0x01}, {0x04}}, types: []byte{types.LegacyTxType, types.LegacyTxType}, sizes: []uint32{111, 444}},</span>
<span class="term-fg32">+			isWaitingWithMeta(map[string][]announce{</span>
<span class="term-fg32">+				&quot;A&quot;: {</span>
<span class="term-fg32">+					{common.Hash{0x01}, typeptr(types.LegacyTxType), sizeptr(111)},</span>
<span class="term-fg32">+					{common.Hash{0x02}, typeptr(types.LegacyTxType), sizeptr(222)},</span>
<span class="term-fg32">+				},</span>
<span class="term-fg32">+				&quot;B&quot;: {</span>
<span class="term-fg32">+					{common.Hash{0x03}, typeptr(types.LegacyTxType), sizeptr(333)},</span>
<span class="term-fg32">+					{common.Hash{0x04}, typeptr(types.LegacyTxType), sizeptr(444)},</span>
<span class="term-fg32">+				},</span>
<span class="term-fg32">+				&quot;C&quot;: {</span>
<span class="term-fg32">+					{common.Hash{0x01}, typeptr(types.LegacyTxType), sizeptr(111)},</span>
<span class="term-fg32">+					{common.Hash{0x04}, typeptr(types.LegacyTxType), sizeptr(444)},</span>
<span class="term-fg32">+				},</span>
<span class="term-fg32">+			}),</span>
<span class="term-fg32">+			&#47;&#47; Announce existing and clashing hashes from existing peer. Clashes</span>
<span class="term-fg32">+			&#47;&#47; should not overwrite previous announcements.</span>
<span class="term-fg32">+			doTxNotify{peer: &quot;A&quot;, hashes: []common.Hash{{0x01}, {0x03}, {0x05}}, types: []byte{types.LegacyTxType, types.LegacyTxType, types.LegacyTxType}, sizes: []uint32{999, 333, 555}},</span>
<span class="term-fg32">+			isWaitingWithMeta(map[string][]announce{</span>
<span class="term-fg32">+				&quot;A&quot;: {</span>
<span class="term-fg32">+					{common.Hash{0x01}, typeptr(types.LegacyTxType), sizeptr(111)},</span>
<span class="term-fg32">+					{common.Hash{0x02}, typeptr(types.LegacyTxType), sizeptr(222)},</span>
<span class="term-fg32">+					{common.Hash{0x03}, typeptr(types.LegacyTxType), sizeptr(333)},</span>
<span class="term-fg32">+					{common.Hash{0x05}, typeptr(types.LegacyTxType), sizeptr(555)},</span>
<span class="term-fg32">+				},</span>
<span class="term-fg32">+				&quot;B&quot;: {</span>
<span class="term-fg32">+					{common.Hash{0x03}, typeptr(types.LegacyTxType), sizeptr(333)},</span>
<span class="term-fg32">+					{common.Hash{0x04}, typeptr(types.LegacyTxType), sizeptr(444)},</span>
<span class="term-fg32">+				},</span>
<span class="term-fg32">+				&quot;C&quot;: {</span>
<span class="term-fg32">+					{common.Hash{0x01}, typeptr(types.LegacyTxType), sizeptr(111)},</span>
<span class="term-fg32">+					{common.Hash{0x04}, typeptr(types.LegacyTxType), sizeptr(444)},</span>
<span class="term-fg32">+				},</span>
<span class="term-fg32">+			}),</span>
<span class="term-fg32">+			&#47;&#47; Announce clashing hashes with conflicting metadata. Somebody will</span>
<span class="term-fg32">+			&#47;&#47; be in the wrong, but we don&#39;t know yet who.</span>
<span class="term-fg32">+			doTxNotify{peer: &quot;D&quot;, hashes: []common.Hash{{0x01}, {0x02}}, types: []byte{types.LegacyTxType, types.BlobTxType}, sizes: []uint32{999, 222}},</span>
<span class="term-fg32">+			isWaitingWithMeta(map[string][]announce{</span>
<span class="term-fg32">+				&quot;A&quot;: {</span>
<span class="term-fg32">+					{common.Hash{0x01}, typeptr(types.LegacyTxType), sizeptr(111)},</span>
<span class="term-fg32">+					{common.Hash{0x02}, typeptr(types.LegacyTxType), sizeptr(222)},</span>
<span class="term-fg32">+					{common.Hash{0x03}, typeptr(types.LegacyTxType), sizeptr(333)},</span>
<span class="term-fg32">+					{common.Hash{0x05}, typeptr(types.LegacyTxType), sizeptr(555)},</span>
<span class="term-fg32">+				},</span>
<span class="term-fg32">+				&quot;B&quot;: {</span>
<span class="term-fg32">+					{common.Hash{0x03}, typeptr(types.LegacyTxType), sizeptr(333)},</span>
<span class="term-fg32">+					{common.Hash{0x04}, typeptr(types.LegacyTxType), sizeptr(444)},</span>
<span class="term-fg32">+				},</span>
<span class="term-fg32">+				&quot;C&quot;: {</span>
<span class="term-fg32">+					{common.Hash{0x01}, typeptr(types.LegacyTxType), sizeptr(111)},</span>
<span class="term-fg32">+					{common.Hash{0x04}, typeptr(types.LegacyTxType), sizeptr(444)},</span>
<span class="term-fg32">+				},</span>
<span class="term-fg32">+				&quot;D&quot;: {</span>
<span class="term-fg32">+					{common.Hash{0x01}, typeptr(types.LegacyTxType), sizeptr(999)},</span>
<span class="term-fg32">+					{common.Hash{0x02}, typeptr(types.BlobTxType), sizeptr(222)},</span>
<span class="term-fg32">+				},</span>
<span class="term-fg32">+			}),</span>
<span class="term-fg32">+			isScheduled{tracking: nil, fetching: nil},</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+			&#47;&#47; Wait for the arrival timeout which should move all expired items</span>
<span class="term-fg32">+			&#47;&#47; from the wait list to the scheduler</span>
<span class="term-fg32">+			doWait{time: txArriveTimeout, step: true},</span>
<span class="term-fg32">+			isWaiting(nil),</span>
<span class="term-fg32">+			isScheduledWithMeta{</span>
<span class="term-fg32">+				tracking: map[string][]announce{</span>
<span class="term-fg32">+					&quot;A&quot;: {</span>
<span class="term-fg32">+						{common.Hash{0x01}, typeptr(types.LegacyTxType), sizeptr(111)},</span>
<span class="term-fg32">+						{common.Hash{0x02}, typeptr(types.LegacyTxType), sizeptr(222)},</span>
<span class="term-fg32">+						{common.Hash{0x03}, typeptr(types.LegacyTxType), sizeptr(333)},</span>
<span class="term-fg32">+						{common.Hash{0x05}, typeptr(types.LegacyTxType), sizeptr(555)},</span>
<span class="term-fg32">+					},</span>
<span class="term-fg32">+					&quot;B&quot;: {</span>
<span class="term-fg32">+						{common.Hash{0x03}, typeptr(types.LegacyTxType), sizeptr(333)},</span>
<span class="term-fg32">+						{common.Hash{0x04}, typeptr(types.LegacyTxType), sizeptr(444)},</span>
<span class="term-fg32">+					},</span>
<span class="term-fg32">+					&quot;C&quot;: {</span>
<span class="term-fg32">+						{common.Hash{0x01}, typeptr(types.LegacyTxType), sizeptr(111)},</span>
<span class="term-fg32">+						{common.Hash{0x04}, typeptr(types.LegacyTxType), sizeptr(444)},</span>
<span class="term-fg32">+					},</span>
<span class="term-fg32">+					&quot;D&quot;: {</span>
<span class="term-fg32">+						{common.Hash{0x01}, typeptr(types.LegacyTxType), sizeptr(999)},</span>
<span class="term-fg32">+						{common.Hash{0x02}, typeptr(types.BlobTxType), sizeptr(222)},</span>
<span class="term-fg32">+					},</span>
<span class="term-fg32">+				},</span>
<span class="term-fg32">+				fetching: map[string][]common.Hash{ &#47;&#47; Depends on deterministic test randomizer</span>
<span class="term-fg32">+					&quot;A&quot;: {{0x03}, {0x05}},</span>
<span class="term-fg32">+					&quot;C&quot;: {{0x01}, {0x04}},</span>
<span class="term-fg32">+					&quot;D&quot;: {{0x02}},</span>
<span class="term-fg32">+				},</span>
<span class="term-fg32">+			},</span>
<span class="term-fg32">+			&#47;&#47; Queue up a non-fetchable transaction and then trigger it with a new</span>
<span class="term-fg32">+			&#47;&#47; peer (weird case to test 1 line in the fetcher)</span>
<span class="term-fg32">+			doTxNotify{peer: &quot;C&quot;, hashes: []common.Hash{{0x06}, {0x07}}, types: []byte{types.LegacyTxType, types.LegacyTxType}, sizes: []uint32{666, 777}},</span>
<span class="term-fg32">+			isWaitingWithMeta(map[string][]announce{</span>
<span class="term-fg32">+				&quot;C&quot;: {</span>
<span class="term-fg32">+					{common.Hash{0x06}, typeptr(types.LegacyTxType), sizeptr(666)},</span>
<span class="term-fg32">+					{common.Hash{0x07}, typeptr(types.LegacyTxType), sizeptr(777)},</span>
<span class="term-fg32">+				},</span>
<span class="term-fg32">+			}),</span>
<span class="term-fg32">+			doWait{time: txArriveTimeout, step: true},</span>
<span class="term-fg32">+			isScheduledWithMeta{</span>
<span class="term-fg32">+				tracking: map[string][]announce{</span>
<span class="term-fg32">+					&quot;A&quot;: {</span>
<span class="term-fg32">+						{common.Hash{0x01}, typeptr(types.LegacyTxType), sizeptr(111)},</span>
<span class="term-fg32">+						{common.Hash{0x02}, typeptr(types.LegacyTxType), sizeptr(222)},</span>
<span class="term-fg32">+						{common.Hash{0x03}, typeptr(types.LegacyTxType), sizeptr(333)},</span>
<span class="term-fg32">+						{common.Hash{0x05}, typeptr(types.LegacyTxType), sizeptr(555)},</span>
<span class="term-fg32">+					},</span>
<span class="term-fg32">+					&quot;B&quot;: {</span>
<span class="term-fg32">+						{common.Hash{0x03}, typeptr(types.LegacyTxType), sizeptr(333)},</span>
<span class="term-fg32">+						{common.Hash{0x04}, typeptr(types.LegacyTxType), sizeptr(444)},</span>
<span class="term-fg32">+					},</span>
<span class="term-fg32">+					&quot;C&quot;: {</span>
<span class="term-fg32">+						{common.Hash{0x01}, typeptr(types.LegacyTxType), sizeptr(111)},</span>
<span class="term-fg32">+						{common.Hash{0x04}, typeptr(types.LegacyTxType), sizeptr(444)},</span>
<span class="term-fg32">+						{common.Hash{0x06}, typeptr(types.LegacyTxType), sizeptr(666)},</span>
<span class="term-fg32">+						{common.Hash{0x07}, typeptr(types.LegacyTxType), sizeptr(777)},</span>
<span class="term-fg32">+					},</span>
<span class="term-fg32">+					&quot;D&quot;: {</span>
<span class="term-fg32">+						{common.Hash{0x01}, typeptr(types.LegacyTxType), sizeptr(999)},</span>
<span class="term-fg32">+						{common.Hash{0x02}, typeptr(types.BlobTxType), sizeptr(222)},</span>
<span class="term-fg32">+					},</span>
<span class="term-fg32">+				},</span>
<span class="term-fg32">+				fetching: map[string][]common.Hash{</span>
<span class="term-fg32">+					&quot;A&quot;: {{0x03}, {0x05}},</span>
<span class="term-fg32">+					&quot;C&quot;: {{0x01}, {0x04}},</span>
<span class="term-fg32">+					&quot;D&quot;: {{0x02}},</span>
<span class="term-fg32">+				},</span>
<span class="term-fg32">+			},</span>
<span class="term-fg32">+			doTxNotify{peer: &quot;E&quot;, hashes: []common.Hash{{0x06}, {0x07}}, types: []byte{types.LegacyTxType, types.LegacyTxType}, sizes: []uint32{666, 777}},</span>
<span class="term-fg32">+			isScheduledWithMeta{</span>
<span class="term-fg32">+				tracking: map[string][]announce{</span>
<span class="term-fg32">+					&quot;A&quot;: {</span>
<span class="term-fg32">+						{common.Hash{0x01}, typeptr(types.LegacyTxType), sizeptr(111)},</span>
<span class="term-fg32">+						{common.Hash{0x02}, typeptr(types.LegacyTxType), sizeptr(222)},</span>
<span class="term-fg32">+						{common.Hash{0x03}, typeptr(types.LegacyTxType), sizeptr(333)},</span>
<span class="term-fg32">+						{common.Hash{0x05}, typeptr(types.LegacyTxType), sizeptr(555)},</span>
<span class="term-fg32">+					},</span>
<span class="term-fg32">+					&quot;B&quot;: {</span>
<span class="term-fg32">+						{common.Hash{0x03}, typeptr(types.LegacyTxType), sizeptr(333)},</span>
<span class="term-fg32">+						{common.Hash{0x04}, typeptr(types.LegacyTxType), sizeptr(444)},</span>
<span class="term-fg32">+					},</span>
<span class="term-fg32">+					&quot;C&quot;: {</span>
<span class="term-fg32">+						{common.Hash{0x01}, typeptr(types.LegacyTxType), sizeptr(111)},</span>
<span class="term-fg32">+						{common.Hash{0x04}, typeptr(types.LegacyTxType), sizeptr(444)},</span>
<span class="term-fg32">+						{common.Hash{0x06}, typeptr(types.LegacyTxType), sizeptr(666)},</span>
<span class="term-fg32">+						{common.Hash{0x07}, typeptr(types.LegacyTxType), sizeptr(777)},</span>
<span class="term-fg32">+					},</span>
<span class="term-fg32">+					&quot;D&quot;: {</span>
<span class="term-fg32">+						{common.Hash{0x01}, typeptr(types.LegacyTxType), sizeptr(999)},</span>
<span class="term-fg32">+						{common.Hash{0x02}, typeptr(types.BlobTxType), sizeptr(222)},</span>
<span class="term-fg32">+					},</span>
<span class="term-fg32">+					&quot;E&quot;: {</span>
<span class="term-fg32">+						{common.Hash{0x06}, typeptr(types.LegacyTxType), sizeptr(666)},</span>
<span class="term-fg32">+						{common.Hash{0x07}, typeptr(types.LegacyTxType), sizeptr(777)},</span>
<span class="term-fg32">+					},</span>
<span class="term-fg32">+				},</span>
<span class="term-fg32">+				fetching: map[string][]common.Hash{</span>
<span class="term-fg32">+					&quot;A&quot;: {{0x03}, {0x05}},</span>
<span class="term-fg32">+					&quot;C&quot;: {{0x01}, {0x04}},</span>
<span class="term-fg32">+					&quot;D&quot;: {{0x02}},</span>
<span class="term-fg32">+					&quot;E&quot;: {{0x06}, {0x07}},</span>
<span class="term-fg32">+				},</span>
<span class="term-fg32">+			},</span>
<span class="term-fg32">+		},</span>
<span class="term-fg32">+	})</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
 &#47;&#47; Tests that transaction announcements skip the waiting list if they are
 &#47;&#47; already scheduled.
 func TestTransactionFetcherSkipWaiting(t *testing.T) {
<span class="term-fg36">@@ -171,6 +397,7 @@</span> 			return NewTxFetcher(
 				func(common.Hash) bool { return false },
 				nil,
 				func(string, []common.Hash) error { return nil },
<span class="term-fg32">+				nil,</span>
 			)
 		},
 		steps: []interface{}{
<span class="term-fg36">@@ -234,6 +461,7 @@</span> 			return NewTxFetcher(
 				func(common.Hash) bool { return false },
 				nil,
 				func(string, []common.Hash) error { return nil },
<span class="term-fg32">+				nil,</span>
 			)
 		},
 		steps: []interface{}{
<span class="term-fg36">@@ -313,6 +541,7 @@</span> 				func(origin string, hashes []common.Hash) error {
 					&lt;-proceed
 					return errors.New(&quot;peer disconnected&quot;)
 				},
<span class="term-fg32">+				nil,</span>
 			)
 		},
 		steps: []interface{}{
<span class="term-fg36">@@ -382,6 +611,7 @@</span> 				func(txs []*types.Transaction) []error {
 					return make([]error, len(txs))
 				},
 				func(string, []common.Hash) error { return nil },
<span class="term-fg32">+				nil,</span>
 			)
 		},
 		steps: []interface{}{
<span class="term-fg36">@@ -421,6 +651,7 @@</span> 				func(txs []*types.Transaction) []error {
 					return make([]error, len(txs))
 				},
 				func(string, []common.Hash) error { return nil },
<span class="term-fg32">+				nil,</span>
 			)
 		},
 		steps: []interface{}{
<span class="term-fg36">@@ -459,6 +690,7 @@</span> 				func(txs []*types.Transaction) []error {
 					return make([]error, len(txs))
 				},
 				func(string, []common.Hash) error { return nil },
<span class="term-fg32">+				nil,</span>
 			)
 		},
 		steps: []interface{}{
<span class="term-fg36">@@ -505,6 +737,7 @@</span> 				func(txs []*types.Transaction) []error {
 					return make([]error, len(txs))
 				},
 				func(string, []common.Hash) error { return nil },
<span class="term-fg32">+				nil,</span>
 			)
 		},
 		steps: []interface{}{
<span class="term-fg36">@@ -543,6 +776,7 @@</span> 				func(txs []*types.Transaction) []error {
 					return make([]error, len(txs))
 				},
 				func(string, []common.Hash) error { return nil },
<span class="term-fg32">+				nil,</span>
 			)
 		},
 		steps: []interface{}{
<span class="term-fg36">@@ -591,6 +825,7 @@</span> 			return NewTxFetcher(
 				func(common.Hash) bool { return false },
 				nil,
 				func(string, []common.Hash) error { return nil },
<span class="term-fg32">+				nil,</span>
 			)
 		},
 		steps: []interface{}{
<span class="term-fg36">@@ -648,6 +883,7 @@</span> 				func(txs []*types.Transaction) []error {
 					return make([]error, len(txs))
 				},
 				func(string, []common.Hash) error { return nil },
<span class="term-fg32">+				nil,</span>
 			)
 		},
 		steps: []interface{}{
<span class="term-fg36">@@ -713,6 +949,7 @@</span> 			return NewTxFetcher(
 				func(common.Hash) bool { return false },
 				nil,
 				func(string, []common.Hash) error { return nil },
<span class="term-fg32">+				nil,</span>
 			)
 		},
 		steps: []interface{}{
<span class="term-fg36">@@ -757,21 +994,21 @@</span> 		},
 	})
 }
&nbsp;
<span class="term-fg31">-&#47;&#47; Tests that if thousands of transactions are announces, only a small</span>
<span class="term-fg32">+&#47;&#47; Tests that if thousands of transactions are announced, only a small</span>
 &#47;&#47; number of them will be requested at a time.
 func TestTransactionFetcherRateLimiting(t *testing.T) {
<span class="term-fg31">-	&#47;&#47; Create a slew of transactions and to announce them</span>
<span class="term-fg32">+	&#47;&#47; Create a slew of transactions and announce them</span>
 	var hashes []common.Hash
 	for i := 0; i &lt; maxTxAnnounces; i++ {
 		hashes = append(hashes, common.Hash{byte(i &#47; 256), byte(i % 256)})
 	}
<span class="term-fg31">-</span>
 	testTransactionFetcherParallel(t, txFetcherTest{
 		init: func() *TxFetcher {
 			return NewTxFetcher(
 				func(common.Hash) bool { return false },
 				nil,
 				func(string, []common.Hash) error { return nil },
<span class="term-fg32">+				nil,</span>
 			)
 		},
 		steps: []interface{}{
<span class="term-fg36">@@ -792,6 +1029,68 @@</span> 		},
 	})
 }
&nbsp;
<span class="term-fg32">+&#47;&#47; Tests that if huge transactions are announced, only a small number of them will</span>
<span class="term-fg32">+&#47;&#47; be requested at a time, to keep the responses below a resonable level.</span>
<span class="term-fg32">+func TestTransactionFetcherBandwidthLimiting(t *testing.T) {</span>
<span class="term-fg32">+	testTransactionFetcherParallel(t, txFetcherTest{</span>
<span class="term-fg32">+		init: func() *TxFetcher {</span>
<span class="term-fg32">+			return NewTxFetcher(</span>
<span class="term-fg32">+				func(common.Hash) bool { return false },</span>
<span class="term-fg32">+				nil,</span>
<span class="term-fg32">+				func(string, []common.Hash) error { return nil },</span>
<span class="term-fg32">+				nil,</span>
<span class="term-fg32">+			)</span>
<span class="term-fg32">+		},</span>
<span class="term-fg32">+		steps: []interface{}{</span>
<span class="term-fg32">+			&#47;&#47; Announce mid size transactions from A to verify that multiple</span>
<span class="term-fg32">+			&#47;&#47; ones can be piled into a single request.</span>
<span class="term-fg32">+			doTxNotify{peer: &quot;A&quot;,</span>
<span class="term-fg32">+				hashes: []common.Hash{{0x01}, {0x02}, {0x03}, {0x04}},</span>
<span class="term-fg32">+				types:  []byte{types.LegacyTxType, types.LegacyTxType, types.LegacyTxType, types.LegacyTxType},</span>
<span class="term-fg32">+				sizes:  []uint32{48 * 1024, 48 * 1024, 48 * 1024, 48 * 1024},</span>
<span class="term-fg32">+			},</span>
<span class="term-fg32">+			&#47;&#47; Announce exactly on the limit transactions to see that only one</span>
<span class="term-fg32">+			&#47;&#47; gets requested</span>
<span class="term-fg32">+			doTxNotify{peer: &quot;B&quot;,</span>
<span class="term-fg32">+				hashes: []common.Hash{{0x05}, {0x06}},</span>
<span class="term-fg32">+				types:  []byte{types.LegacyTxType, types.LegacyTxType},</span>
<span class="term-fg32">+				sizes:  []uint32{maxTxRetrievalSize, maxTxRetrievalSize},</span>
<span class="term-fg32">+			},</span>
<span class="term-fg32">+			&#47;&#47; Announce oversized blob transactions to see that overflows are ok</span>
<span class="term-fg32">+			doTxNotify{peer: &quot;C&quot;,</span>
<span class="term-fg32">+				hashes: []common.Hash{{0x07}, {0x08}},</span>
<span class="term-fg32">+				types:  []byte{types.BlobTxType, types.BlobTxType},</span>
<span class="term-fg32">+				sizes:  []uint32{params.MaxBlobGasPerBlock, params.MaxBlobGasPerBlock},</span>
<span class="term-fg32">+			},</span>
<span class="term-fg32">+			doWait{time: txArriveTimeout, step: true},</span>
<span class="term-fg32">+			isWaiting(nil),</span>
<span class="term-fg32">+			isScheduledWithMeta{</span>
<span class="term-fg32">+				tracking: map[string][]announce{</span>
<span class="term-fg32">+					&quot;A&quot;: {</span>
<span class="term-fg32">+						{common.Hash{0x01}, typeptr(types.LegacyTxType), sizeptr(48 * 1024)},</span>
<span class="term-fg32">+						{common.Hash{0x02}, typeptr(types.LegacyTxType), sizeptr(48 * 1024)},</span>
<span class="term-fg32">+						{common.Hash{0x03}, typeptr(types.LegacyTxType), sizeptr(48 * 1024)},</span>
<span class="term-fg32">+						{common.Hash{0x04}, typeptr(types.LegacyTxType), sizeptr(48 * 1024)},</span>
<span class="term-fg32">+					},</span>
<span class="term-fg32">+					&quot;B&quot;: {</span>
<span class="term-fg32">+						{common.Hash{0x05}, typeptr(types.LegacyTxType), sizeptr(maxTxRetrievalSize)},</span>
<span class="term-fg32">+						{common.Hash{0x06}, typeptr(types.LegacyTxType), sizeptr(maxTxRetrievalSize)},</span>
<span class="term-fg32">+					},</span>
<span class="term-fg32">+					&quot;C&quot;: {</span>
<span class="term-fg32">+						{common.Hash{0x07}, typeptr(types.BlobTxType), sizeptr(params.MaxBlobGasPerBlock)},</span>
<span class="term-fg32">+						{common.Hash{0x08}, typeptr(types.BlobTxType), sizeptr(params.MaxBlobGasPerBlock)},</span>
<span class="term-fg32">+					},</span>
<span class="term-fg32">+				},</span>
<span class="term-fg32">+				fetching: map[string][]common.Hash{</span>
<span class="term-fg32">+					&quot;A&quot;: {{0x02}, {0x03}, {0x04}},</span>
<span class="term-fg32">+					&quot;B&quot;: {{0x06}},</span>
<span class="term-fg32">+					&quot;C&quot;: {{0x08}},</span>
<span class="term-fg32">+				},</span>
<span class="term-fg32">+			},</span>
<span class="term-fg32">+		},</span>
<span class="term-fg32">+	})</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
 &#47;&#47; Tests that then number of transactions a peer is allowed to announce and&#47;or
 &#47;&#47; request at the same time is hard capped.
 func TestTransactionFetcherDoSProtection(t *testing.T) {
<span class="term-fg36">@@ -810,6 +1109,7 @@</span> 			return NewTxFetcher(
 				func(common.Hash) bool { return false },
 				nil,
 				func(string, []common.Hash) error { return nil },
<span class="term-fg32">+				nil,</span>
 			)
 		},
 		steps: []interface{}{
<span class="term-fg36">@@ -877,6 +1177,7 @@</span> 					}
 					return errs
 				},
 				func(string, []common.Hash) error { return nil },
<span class="term-fg32">+				nil,</span>
 			)
 		},
 		steps: []interface{}{
<span class="term-fg36">@@ -946,6 +1247,7 @@</span> 					}
 					return errs
 				},
 				func(string, []common.Hash) error { return nil },
<span class="term-fg32">+				nil,</span>
 			)
 		},
 		steps: append(steps, []interface{}{
<span class="term-fg36">@@ -968,6 +1270,7 @@</span> 				func(txs []*types.Transaction) []error {
 					return make([]error, len(txs))
 				},
 				func(string, []common.Hash) error { return nil },
<span class="term-fg32">+				nil,</span>
 			)
 		},
 		steps: []interface{}{
<span class="term-fg36">@@ -1021,6 +1324,7 @@</span> 				func(txs []*types.Transaction) []error {
 					return make([]error, len(txs))
 				},
 				func(string, []common.Hash) error { return nil },
<span class="term-fg32">+				nil,</span>
 			)
 		},
 		steps: []interface{}{
<span class="term-fg36">@@ -1087,6 +1391,7 @@</span> 				func(txs []*types.Transaction) []error {
 					return make([]error, len(txs))
 				},
 				func(string, []common.Hash) error { return nil },
<span class="term-fg32">+				nil,</span>
 			)
 		},
 		steps: []interface{}{
<span class="term-fg36">@@ -1120,6 +1425,74 @@</span> 		},
 	})
 }
&nbsp;
<span class="term-fg32">+&#47;&#47; Tests that announced transactions with the wrong transaction type or size will</span>
<span class="term-fg32">+&#47;&#47; result in a dropped peer.</span>
<span class="term-fg32">+func TestInvalidAnnounceMetadata(t *testing.T) {</span>
<span class="term-fg32">+	drop := make(chan string, 2)</span>
<span class="term-fg32">+	testTransactionFetcherParallel(t, txFetcherTest{</span>
<span class="term-fg32">+		init: func() *TxFetcher {</span>
<span class="term-fg32">+			return NewTxFetcher(</span>
<span class="term-fg32">+				func(common.Hash) bool { return false },</span>
<span class="term-fg32">+				func(txs []*types.Transaction) []error {</span>
<span class="term-fg32">+					return make([]error, len(txs))</span>
<span class="term-fg32">+				},</span>
<span class="term-fg32">+				func(string, []common.Hash) error { return nil },</span>
<span class="term-fg32">+				func(peer string) { drop &lt;- peer },</span>
<span class="term-fg32">+			)</span>
<span class="term-fg32">+		},</span>
<span class="term-fg32">+		steps: []interface{}{</span>
<span class="term-fg32">+			&#47;&#47; Initial announcement to get something into the waitlist</span>
<span class="term-fg32">+			doTxNotify{peer: &quot;A&quot;, hashes: []common.Hash{testTxsHashes[0], testTxsHashes[1]}, types: []byte{testTxs[0].Type(), testTxs[1].Type()}, sizes: []uint32{uint32(testTxs[0].Size()), uint32(testTxs[1].Size())}},</span>
<span class="term-fg32">+			isWaitingWithMeta(map[string][]announce{</span>
<span class="term-fg32">+				&quot;A&quot;: {</span>
<span class="term-fg32">+					{testTxsHashes[0], typeptr(testTxs[0].Type()), sizeptr(uint32(testTxs[0].Size()))},</span>
<span class="term-fg32">+					{testTxsHashes[1], typeptr(testTxs[1].Type()), sizeptr(uint32(testTxs[1].Size()))},</span>
<span class="term-fg32">+				},</span>
<span class="term-fg32">+			}),</span>
<span class="term-fg32">+			&#47;&#47; Announce from new peers conflicting transactions</span>
<span class="term-fg32">+			doTxNotify{peer: &quot;B&quot;, hashes: []common.Hash{testTxsHashes[0]}, types: []byte{testTxs[0].Type()}, sizes: []uint32{1024 + uint32(testTxs[0].Size())}},</span>
<span class="term-fg32">+			doTxNotify{peer: &quot;C&quot;, hashes: []common.Hash{testTxsHashes[1]}, types: []byte{1 + testTxs[1].Type()}, sizes: []uint32{uint32(testTxs[1].Size())}},</span>
<span class="term-fg32">+			isWaitingWithMeta(map[string][]announce{</span>
<span class="term-fg32">+				&quot;A&quot;: {</span>
<span class="term-fg32">+					{testTxsHashes[0], typeptr(testTxs[0].Type()), sizeptr(uint32(testTxs[0].Size()))},</span>
<span class="term-fg32">+					{testTxsHashes[1], typeptr(testTxs[1].Type()), sizeptr(uint32(testTxs[1].Size()))},</span>
<span class="term-fg32">+				},</span>
<span class="term-fg32">+				&quot;B&quot;: {</span>
<span class="term-fg32">+					{testTxsHashes[0], typeptr(testTxs[0].Type()), sizeptr(1024 + uint32(testTxs[0].Size()))},</span>
<span class="term-fg32">+				},</span>
<span class="term-fg32">+				&quot;C&quot;: {</span>
<span class="term-fg32">+					{testTxsHashes[1], typeptr(1 + testTxs[1].Type()), sizeptr(uint32(testTxs[1].Size()))},</span>
<span class="term-fg32">+				},</span>
<span class="term-fg32">+			}),</span>
<span class="term-fg32">+			&#47;&#47; Schedule all the transactions for retrieval</span>
<span class="term-fg32">+			doWait{time: txArriveTimeout, step: true},</span>
<span class="term-fg32">+			isWaitingWithMeta(nil),</span>
<span class="term-fg32">+			isScheduledWithMeta{</span>
<span class="term-fg32">+				tracking: map[string][]announce{</span>
<span class="term-fg32">+					&quot;A&quot;: {</span>
<span class="term-fg32">+						{testTxsHashes[0], typeptr(testTxs[0].Type()), sizeptr(uint32(testTxs[0].Size()))},</span>
<span class="term-fg32">+						{testTxsHashes[1], typeptr(testTxs[1].Type()), sizeptr(uint32(testTxs[1].Size()))},</span>
<span class="term-fg32">+					},</span>
<span class="term-fg32">+					&quot;B&quot;: {</span>
<span class="term-fg32">+						{testTxsHashes[0], typeptr(testTxs[0].Type()), sizeptr(1024 + uint32(testTxs[0].Size()))},</span>
<span class="term-fg32">+					},</span>
<span class="term-fg32">+					&quot;C&quot;: {</span>
<span class="term-fg32">+						{testTxsHashes[1], typeptr(1 + testTxs[1].Type()), sizeptr(uint32(testTxs[1].Size()))},</span>
<span class="term-fg32">+					},</span>
<span class="term-fg32">+				},</span>
<span class="term-fg32">+				fetching: map[string][]common.Hash{</span>
<span class="term-fg32">+					&quot;A&quot;: {testTxsHashes[0]},</span>
<span class="term-fg32">+					&quot;C&quot;: {testTxsHashes[1]},</span>
<span class="term-fg32">+				},</span>
<span class="term-fg32">+			},</span>
<span class="term-fg32">+			&#47;&#47; Deliver the transactions and wait for B to be dropped</span>
<span class="term-fg32">+			doTxEnqueue{peer: &quot;A&quot;, txs: []*types.Transaction{testTxs[0], testTxs[1]}},</span>
<span class="term-fg32">+			doFunc(func() { &lt;-drop }),</span>
<span class="term-fg32">+			doFunc(func() { &lt;-drop }),</span>
<span class="term-fg32">+		},</span>
<span class="term-fg32">+	})</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
 &#47;&#47; This test reproduces a crash caught by the fuzzer. The root cause was a
 &#47;&#47; dangling transaction timing out and clashing on re-add with a concurrently
 &#47;&#47; announced one.
<span class="term-fg36">@@ -1132,6 +1505,7 @@</span> 				func(txs []*types.Transaction) []error {
 					return make([]error, len(txs))
 				},
 				func(string, []common.Hash) error { return nil },
<span class="term-fg32">+				nil,</span>
 			)
 		},
 		steps: []interface{}{
<span class="term-fg36">@@ -1159,6 +1533,7 @@</span> 				func(txs []*types.Transaction) []error {
 					return make([]error, len(txs))
 				},
 				func(string, []common.Hash) error { return nil },
<span class="term-fg32">+				nil,</span>
 			)
 		},
 		steps: []interface{}{
<span class="term-fg36">@@ -1188,6 +1563,7 @@</span> 				func(txs []*types.Transaction) []error {
 					return make([]error, len(txs))
 				},
 				func(string, []common.Hash) error { return nil },
<span class="term-fg32">+				nil,</span>
 			)
 		},
 		steps: []interface{}{
<span class="term-fg36">@@ -1224,6 +1600,7 @@</span> 				func(string, []common.Hash) error {
 					&lt;-proceed
 					return errors.New(&quot;peer disconnected&quot;)
 				},
<span class="term-fg32">+				nil,</span>
 			)
 		},
 		steps: []interface{}{
<span class="term-fg36">@@ -1274,9 +1651,34 @@</span> 	}()
&nbsp;
 	&#47;&#47; Crunch through all the test steps and execute them
 	for i, step := range tt.steps {
<span class="term-fg32">+		&#47;&#47; Auto-expand certain steps to ones with metadata</span>
<span class="term-fg32">+		switch old := step.(type) {</span>
<span class="term-fg32">+		case isWaiting:</span>
<span class="term-fg32">+			new := make(isWaitingWithMeta)</span>
<span class="term-fg32">+			for peer, hashes := range old {</span>
<span class="term-fg32">+				for _, hash := range hashes {</span>
<span class="term-fg32">+					new[peer] = append(new[peer], announce{hash, nil, nil})</span>
<span class="term-fg32">+				}</span>
<span class="term-fg32">+			}</span>
<span class="term-fg32">+			step = new</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+		case isScheduled:</span>
<span class="term-fg32">+			new := isScheduledWithMeta{</span>
<span class="term-fg32">+				tracking: make(map[string][]announce),</span>
<span class="term-fg32">+				fetching: old.fetching,</span>
<span class="term-fg32">+				dangling: old.dangling,</span>
<span class="term-fg32">+			}</span>
<span class="term-fg32">+			for peer, hashes := range old.tracking {</span>
<span class="term-fg32">+				for _, hash := range hashes {</span>
<span class="term-fg32">+					new.tracking[peer] = append(new.tracking[peer], announce{hash, nil, nil})</span>
<span class="term-fg32">+				}</span>
<span class="term-fg32">+			}</span>
<span class="term-fg32">+			step = new</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+		&#47;&#47; Process the original or expanded steps</span>
 		switch step := step.(type) {
 		case doTxNotify:
<span class="term-fg31">-			if err := fetcher.Notify(step.peer, step.hashes); err != nil {</span>
<span class="term-fg32">+			if err := fetcher.Notify(step.peer, step.types, step.sizes, step.hashes); err != nil {</span>
 				t.Errorf(&quot;step %d: %v&quot;, i, err)
 			}
 			&lt;-wait &#47;&#47; Fetcher needs to process this, wait until it&#39;s done
<span class="term-fg36">@@ -1307,24 +1709,34 @@</span>
 		case doFunc:
 			step()
&nbsp;
<span class="term-fg31">-		case isWaiting:</span>
<span class="term-fg32">+		case isWaitingWithMeta:</span>
 			&#47;&#47; We need to check that the waiting list (stage 1) internals
 			&#47;&#47; match with the expected set. Check the peer-&gt;hash mappings
 			&#47;&#47; first.
<span class="term-fg31">-			for peer, hashes := range step {</span>
<span class="term-fg32">+			for peer, announces := range step {</span>
 				waiting := fetcher.waitslots[peer]
 				if waiting == nil {
 					t.Errorf(&quot;step %d: peer %s missing from waitslots&quot;, i, peer)
 					continue
 				}
<span class="term-fg31">-				for _, hash := range hashes {</span>
<span class="term-fg31">-					if _, ok := waiting[hash]; !ok {</span>
<span class="term-fg31">-						t.Errorf(&quot;step %d, peer %s: hash %x missing from waitslots&quot;, i, peer, hash)</span>
<span class="term-fg32">+				for _, ann := range announces {</span>
<span class="term-fg32">+					if meta, ok := waiting[ann.hash]; !ok {</span>
<span class="term-fg32">+						t.Errorf(&quot;step %d, peer %s: hash %x missing from waitslots&quot;, i, peer, ann.hash)</span>
<span class="term-fg32">+					} else {</span>
<span class="term-fg32">+						if (meta == nil &amp;&amp; (ann.kind != nil || ann.size != nil)) ||</span>
<span class="term-fg32">+							(meta != nil &amp;&amp; (ann.kind == nil || ann.size == nil)) ||</span>
<span class="term-fg32">+							(meta != nil &amp;&amp; (meta.kind != *ann.kind || meta.size != *ann.size)) {</span>
<span class="term-fg32">+							t.Errorf(&quot;step %d, peer %s, hash %x: waitslot metadata mismatch: want %v, have %v&#47;%v&quot;, i, peer, ann.hash, meta, *ann.kind, *ann.size)</span>
<span class="term-fg32">+						}</span>
 					}
 				}
<span class="term-fg31">-				for hash := range waiting {</span>
<span class="term-fg31">-					if !containsHash(hashes, hash) {</span>
<span class="term-fg31">-						t.Errorf(&quot;step %d, peer %s: hash %x extra in waitslots&quot;, i, peer, hash)</span>
<span class="term-fg32">+				for hash, meta := range waiting {</span>
<span class="term-fg32">+					ann := announce{hash: hash}</span>
<span class="term-fg32">+					if meta != nil {</span>
<span class="term-fg32">+						ann.kind, ann.size = &amp;meta.kind, &amp;meta.size</span>
<span class="term-fg32">+					}</span>
<span class="term-fg32">+					if !containsAnnounce(announces, ann) {</span>
<span class="term-fg32">+						t.Errorf(&quot;step %d, peer %s: announce %v extra in waitslots&quot;, i, peer, ann)</span>
 					}
 				}
 			}
<span class="term-fg36">@@ -1334,13 +1746,13 @@</span> 					t.Errorf(&quot;step %d: peer %s extra in waitslots&quot;, i, peer)
 				}
 			}
 			&#47;&#47; Peer-&gt;hash sets correct, check the hash-&gt;peer and timeout sets
<span class="term-fg31">-			for peer, hashes := range step {</span>
<span class="term-fg31">-				for _, hash := range hashes {</span>
<span class="term-fg31">-					if _, ok := fetcher.waitlist[hash][peer]; !ok {</span>
<span class="term-fg31">-						t.Errorf(&quot;step %d, hash %x: peer %s missing from waitlist&quot;, i, hash, peer)</span>
<span class="term-fg32">+			for peer, announces := range step {</span>
<span class="term-fg32">+				for _, ann := range announces {</span>
<span class="term-fg32">+					if _, ok := fetcher.waitlist[ann.hash][peer]; !ok {</span>
<span class="term-fg32">+						t.Errorf(&quot;step %d, hash %x: peer %s missing from waitlist&quot;, i, ann.hash, peer)</span>
 					}
<span class="term-fg31">-					if _, ok := fetcher.waittime[hash]; !ok {</span>
<span class="term-fg31">-						t.Errorf(&quot;step %d: hash %x missing from waittime&quot;, i, hash)</span>
<span class="term-fg32">+					if _, ok := fetcher.waittime[ann.hash]; !ok {</span>
<span class="term-fg32">+						t.Errorf(&quot;step %d: hash %x missing from waittime&quot;, i, ann.hash)</span>
 					}
 				}
 			}
<span class="term-fg36">@@ -1349,15 +1761,15 @@</span> 				if len(peers) == 0 {
 					t.Errorf(&quot;step %d, hash %x: empty peerset in waitlist&quot;, i, hash)
 				}
 				for peer := range peers {
<span class="term-fg31">-					if !containsHash(step[peer], hash) {</span>
<span class="term-fg32">+					if !containsHashInAnnounces(step[peer], hash) {</span>
 						t.Errorf(&quot;step %d, hash %x: peer %s extra in waitlist&quot;, i, hash, peer)
 					}
 				}
 			}
 			for hash := range fetcher.waittime {
 				var found bool
<span class="term-fg31">-				for _, hashes := range step {</span>
<span class="term-fg31">-					if containsHash(hashes, hash) {</span>
<span class="term-fg32">+				for _, announces := range step {</span>
<span class="term-fg32">+					if containsHashInAnnounces(announces, hash) {</span>
 						found = true
 						break
 					}
<span class="term-fg36">@@ -1367,23 +1779,33 @@</span> 					t.Errorf(&quot;step %d,: hash %x extra in waittime&quot;, i, hash)
 				}
 			}
&nbsp;
<span class="term-fg31">-		case isScheduled:</span>
<span class="term-fg32">+		case isScheduledWithMeta:</span>
 			&#47;&#47; Check that all scheduled announces are accounted for and no
 			&#47;&#47; extra ones are present.
<span class="term-fg31">-			for peer, hashes := range step.tracking {</span>
<span class="term-fg32">+			for peer, announces := range step.tracking {</span>
 				scheduled := fetcher.announces[peer]
 				if scheduled == nil {
 					t.Errorf(&quot;step %d: peer %s missing from announces&quot;, i, peer)
 					continue
 				}
<span class="term-fg31">-				for _, hash := range hashes {</span>
<span class="term-fg31">-					if _, ok := scheduled[hash]; !ok {</span>
<span class="term-fg31">-						t.Errorf(&quot;step %d, peer %s: hash %x missing from announces&quot;, i, peer, hash)</span>
<span class="term-fg32">+				for _, ann := range announces {</span>
<span class="term-fg32">+					if meta, ok := scheduled[ann.hash]; !ok {</span>
<span class="term-fg32">+						t.Errorf(&quot;step %d, peer %s: hash %x missing from announces&quot;, i, peer, ann.hash)</span>
<span class="term-fg32">+					} else {</span>
<span class="term-fg32">+						if (meta == nil &amp;&amp; (ann.kind != nil || ann.size != nil)) ||</span>
<span class="term-fg32">+							(meta != nil &amp;&amp; (ann.kind == nil || ann.size == nil)) ||</span>
<span class="term-fg32">+							(meta != nil &amp;&amp; (meta.kind != *ann.kind || meta.size != *ann.size)) {</span>
<span class="term-fg32">+							t.Errorf(&quot;step %d, peer %s, hash %x: announce metadata mismatch: want %v, have %v&#47;%v&quot;, i, peer, ann.hash, meta, *ann.kind, *ann.size)</span>
<span class="term-fg32">+						}</span>
 					}
 				}
<span class="term-fg31">-				for hash := range scheduled {</span>
<span class="term-fg31">-					if !containsHash(hashes, hash) {</span>
<span class="term-fg31">-						t.Errorf(&quot;step %d, peer %s: hash %x extra in announces&quot;, i, peer, hash)</span>
<span class="term-fg32">+				for hash, meta := range scheduled {</span>
<span class="term-fg32">+					ann := announce{hash: hash}</span>
<span class="term-fg32">+					if meta != nil {</span>
<span class="term-fg32">+						ann.kind, ann.size = &amp;meta.kind, &amp;meta.size</span>
<span class="term-fg32">+					}</span>
<span class="term-fg32">+					if !containsAnnounce(announces, ann) {</span>
<span class="term-fg32">+						t.Errorf(&quot;step %d, peer %s: announce %x extra in announces&quot;, i, peer, hash)</span>
 					}
 				}
 			}
<span class="term-fg36">@@ -1483,17 +1905,17 @@</span> 			&#47;&#47; Check that all transaction announces that are scheduled for
 			&#47;&#47; retrieval but not actively being downloaded are tracked only
 			&#47;&#47; in the stage 2 `announced` map.
 			var queued []common.Hash
<span class="term-fg31">-			for _, hashes := range step.tracking {</span>
<span class="term-fg31">-				for _, hash := range hashes {</span>
<span class="term-fg32">+			for _, announces := range step.tracking {</span>
<span class="term-fg32">+				for _, ann := range announces {</span>
 					var found bool
 					for _, hs := range step.fetching {
<span class="term-fg31">-						if containsHash(hs, hash) {</span>
<span class="term-fg32">+						if containsHash(hs, ann.hash) {</span>
 							found = true
 							break
 						}
 					}
 					if !found {
<span class="term-fg31">-						queued = append(queued, hash)</span>
<span class="term-fg32">+						queued = append(queued, ann.hash)</span>
 					}
 				}
 			}
<span class="term-fg36">@@ -1509,8 +1931,8 @@</span> 				}
 			}
&nbsp;
 		case isUnderpriced:
<span class="term-fg31">-			if fetcher.underpriced.Cardinality() != int(step) {</span>
<span class="term-fg31">-				t.Errorf(&quot;step %d: underpriced set size mismatch: have %d, want %d&quot;, i, fetcher.underpriced.Cardinality(), step)</span>
<span class="term-fg32">+			if fetcher.underpriced.Len() != int(step) {</span>
<span class="term-fg32">+				t.Errorf(&quot;step %d: underpriced set size mismatch: have %d, want %d&quot;, i, fetcher.underpriced.Len(), step)</span>
 			}
&nbsp;
 		default:
<span class="term-fg36">@@ -1526,6 +1948,42 @@</span> 		}
 	}
 }
&nbsp;
<span class="term-fg32">+&#47;&#47; containsAnnounce returns whether an announcement is contained within a slice</span>
<span class="term-fg32">+&#47;&#47; of announcements.</span>
<span class="term-fg32">+func containsAnnounce(slice []announce, ann announce) bool {</span>
<span class="term-fg32">+	for _, have := range slice {</span>
<span class="term-fg32">+		if have.hash == ann.hash {</span>
<span class="term-fg32">+			if have.kind == nil || ann.kind == nil {</span>
<span class="term-fg32">+				if have.kind != ann.kind {</span>
<span class="term-fg32">+					return false</span>
<span class="term-fg32">+				}</span>
<span class="term-fg32">+			} else if *have.kind != *ann.kind {</span>
<span class="term-fg32">+				return false</span>
<span class="term-fg32">+			}</span>
<span class="term-fg32">+			if have.size == nil || ann.size == nil {</span>
<span class="term-fg32">+				if have.size != ann.size {</span>
<span class="term-fg32">+					return false</span>
<span class="term-fg32">+				}</span>
<span class="term-fg32">+			} else if *have.size != *ann.size {</span>
<span class="term-fg32">+				return false</span>
<span class="term-fg32">+			}</span>
<span class="term-fg32">+			return true</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	return false</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+&#47;&#47; containsHashInAnnounces returns whether a hash is contained within a slice</span>
<span class="term-fg32">+&#47;&#47; of announcements.</span>
<span class="term-fg32">+func containsHashInAnnounces(slice []announce, hash common.Hash) bool {</span>
<span class="term-fg32">+	for _, have := range slice {</span>
<span class="term-fg32">+		if have.hash == hash {</span>
<span class="term-fg32">+			return true</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	return false</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
 &#47;&#47; containsHash returns whether a hash is contained within a hash slice.
 func containsHash(slice []common.Hash, hash common.Hash) bool {
 	for _, have := range slice {
<span class="term-fg36">@@ -1535,3 +1993,38 @@</span> 		}
 	}
 	return false
 }
<span class="term-fg32">+</span>
<span class="term-fg32">+&#47;&#47; Tests that a transaction is forgotten after the timeout.</span>
<span class="term-fg32">+func TestTransactionForgotten(t *testing.T) {</span>
<span class="term-fg32">+	fetcher := NewTxFetcher(</span>
<span class="term-fg32">+		func(common.Hash) bool { return false },</span>
<span class="term-fg32">+		func(txs []*types.Transaction) []error {</span>
<span class="term-fg32">+			errs := make([]error, len(txs))</span>
<span class="term-fg32">+			for i := 0; i &lt; len(errs); i++ {</span>
<span class="term-fg32">+				errs[i] = txpool.ErrUnderpriced</span>
<span class="term-fg32">+			}</span>
<span class="term-fg32">+			return errs</span>
<span class="term-fg32">+		},</span>
<span class="term-fg32">+		func(string, []common.Hash) error { return nil },</span>
<span class="term-fg32">+		func(string) {},</span>
<span class="term-fg32">+	)</span>
<span class="term-fg32">+	fetcher.Start()</span>
<span class="term-fg32">+	defer fetcher.Stop()</span>
<span class="term-fg32">+	&#47;&#47; Create one TX which is 5 minutes old, and one which is recent</span>
<span class="term-fg32">+	tx1 := types.NewTx(&amp;types.LegacyTx{Nonce: 0})</span>
<span class="term-fg32">+	tx1.SetTime(time.Now().Add(-maxTxUnderpricedTimeout - 1*time.Second))</span>
<span class="term-fg32">+	tx2 := types.NewTx(&amp;types.LegacyTx{Nonce: 1})</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	&#47;&#47; Enqueue both in the fetcher. They will be immediately tagged as underpriced</span>
<span class="term-fg32">+	if err := fetcher.Enqueue(&quot;asdf&quot;, []*types.Transaction{tx1, tx2}, false); err != nil {</span>
<span class="term-fg32">+		t.Fatal(err)</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	&#47;&#47; isKnownUnderpriced should trigger removal of the first tx (no longer be known underpriced)</span>
<span class="term-fg32">+	if fetcher.isKnownUnderpriced(tx1.Hash()) {</span>
<span class="term-fg32">+		t.Fatal(&quot;transaction should be forgotten by now&quot;)</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	&#47;&#47; isKnownUnderpriced should not trigger removal of the second</span>
<span class="term-fg32">+	if !fetcher.isKnownUnderpriced(tx2.Hash()) {</span>
<span class="term-fg32">+		t.Fatal(&quot;transaction should be known underpriced&quot;)</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+}</span></div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-1bdc22d2bc5f167be1e48d8c" role="button"
                   aria-expanded="false" aria-controls="id-1bdc22d2bc5f167be1e48d8c">
                    <code>eth/gasprice/optimism-gasprice_test.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <span class="text-muted">(new)</span>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/650bb2f2b1dcfe30d9b1fa6f7dc9608055ed60e1/eth/gasprice/optimism-gasprice_test.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+142</span></div>
                        <div class="text-start"><span class="text-danger">-0</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-1bdc22d2bc5f167be1e48d8c"><span class="term-fg1">diff --git go-ethereum&#47;eth&#47;gasprice&#47;optimism-gasprice_test.go op-geth&#47;eth&#47;gasprice&#47;optimism-gasprice_test.go</span>
<span class="term-fg1">new file mode 100644</span>
<span class="term-fg1">index 0000000000000000000000000000000000000000..dd0140839d91e45be16d06faae9b714ad53265fa</span>
<span class="term-fg1">--- &#47;dev&#47;null</span>
<span class="term-fg1">+++ op-geth&#47;eth&#47;gasprice&#47;optimism-gasprice_test.go</span>
<span class="term-fg36">@@ -0,0 +1,142 @@</span>
<span class="term-fg32">+&#47;&#47; Copyright 2020 The go-ethereum Authors</span>
<span class="term-fg32">+&#47;&#47; This file is part of the go-ethereum library.</span>
<span class="term-fg32">+&#47;&#47;</span>
<span class="term-fg32">+&#47;&#47; The go-ethereum library is free software: you can redistribute it and&#47;or modify</span>
<span class="term-fg32">+&#47;&#47; it under the terms of the GNU Lesser General Public License as published by</span>
<span class="term-fg32">+&#47;&#47; the Free Software Foundation, either version 3 of the License, or</span>
<span class="term-fg32">+&#47;&#47; (at your option) any later version.</span>
<span class="term-fg32">+&#47;&#47;</span>
<span class="term-fg32">+&#47;&#47; The go-ethereum library is distributed in the hope that it will be useful,</span>
<span class="term-fg32">+&#47;&#47; but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="term-fg32">+&#47;&#47; MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the</span>
<span class="term-fg32">+&#47;&#47; GNU Lesser General Public License for more details.</span>
<span class="term-fg32">+&#47;&#47;</span>
<span class="term-fg32">+&#47;&#47; You should have received a copy of the GNU Lesser General Public License</span>
<span class="term-fg32">+&#47;&#47; along with the go-ethereum library. If not, see &lt;http:&#47;&#47;www.gnu.org&#47;licenses&#47;&gt;.</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+package gasprice</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+import (</span>
<span class="term-fg32">+	&quot;context&quot;</span>
<span class="term-fg32">+	&quot;math&#47;big&quot;</span>
<span class="term-fg32">+	&quot;testing&quot;</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;common&quot;</span>
<span class="term-fg32">+	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;core&quot;</span>
<span class="term-fg32">+	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;core&#47;types&quot;</span>
<span class="term-fg32">+	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;crypto&quot;</span>
<span class="term-fg32">+	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;event&quot;</span>
<span class="term-fg32">+	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;params&quot;</span>
<span class="term-fg32">+	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;rpc&quot;</span>
<span class="term-fg32">+	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;trie&quot;</span>
<span class="term-fg32">+)</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+const (</span>
<span class="term-fg32">+	blockGasLimit = params.TxGas * 3</span>
<span class="term-fg32">+)</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+type testTxData struct {</span>
<span class="term-fg32">+	priorityFee int64</span>
<span class="term-fg32">+	gasLimit    uint64</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+type opTestBackend struct {</span>
<span class="term-fg32">+	block    *types.Block</span>
<span class="term-fg32">+	receipts []*types.Receipt</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func (b *opTestBackend) HeaderByNumber(ctx context.Context, number rpc.BlockNumber) (*types.Header, error) {</span>
<span class="term-fg32">+	panic(&quot;not implemented&quot;)</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func (b *opTestBackend) BlockByNumber(ctx context.Context, number rpc.BlockNumber) (*types.Block, error) {</span>
<span class="term-fg32">+	return b.block, nil</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func (b *opTestBackend) GetReceipts(ctx context.Context, hash common.Hash) (types.Receipts, error) {</span>
<span class="term-fg32">+	return b.receipts, nil</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func (b *opTestBackend) PendingBlockAndReceipts() (*types.Block, types.Receipts) {</span>
<span class="term-fg32">+	panic(&quot;not implemented&quot;)</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func (b *opTestBackend) ChainConfig() *params.ChainConfig {</span>
<span class="term-fg32">+	return params.OptimismTestConfig</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func (b *opTestBackend) SubscribeChainHeadEvent(ch chan&lt;- core.ChainHeadEvent) event.Subscription {</span>
<span class="term-fg32">+	return nil</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func newOpTestBackend(t *testing.T, txs []testTxData) *opTestBackend {</span>
<span class="term-fg32">+	var (</span>
<span class="term-fg32">+		key, _ = crypto.HexToECDSA(&quot;b71c71a67e1177ad4e901695e1b4b9ee17ae16c6668d313eac2f96dbcda3f291&quot;)</span>
<span class="term-fg32">+		signer = types.LatestSigner(params.TestChainConfig)</span>
<span class="term-fg32">+	)</span>
<span class="term-fg32">+	&#47;&#47; only the most recent block is considered for optimism priority fee suggestions, so this is</span>
<span class="term-fg32">+	&#47;&#47; where we add the test transactions</span>
<span class="term-fg32">+	ts := []*types.Transaction{}</span>
<span class="term-fg32">+	rs := []*types.Receipt{}</span>
<span class="term-fg32">+	header := types.Header{}</span>
<span class="term-fg32">+	header.GasLimit = blockGasLimit</span>
<span class="term-fg32">+	var nonce uint64</span>
<span class="term-fg32">+	for _, tx := range txs {</span>
<span class="term-fg32">+		txdata := &amp;types.DynamicFeeTx{</span>
<span class="term-fg32">+			ChainID:   params.TestChainConfig.ChainID,</span>
<span class="term-fg32">+			Nonce:     nonce,</span>
<span class="term-fg32">+			To:        &amp;common.Address{},</span>
<span class="term-fg32">+			Gas:       params.TxGas,</span>
<span class="term-fg32">+			GasFeeCap: big.NewInt(100 * params.GWei),</span>
<span class="term-fg32">+			GasTipCap: big.NewInt(tx.priorityFee),</span>
<span class="term-fg32">+			Data:      []byte{},</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+		t := types.MustSignNewTx(key, signer, txdata)</span>
<span class="term-fg32">+		ts = append(ts, t)</span>
<span class="term-fg32">+		r := types.Receipt{}</span>
<span class="term-fg32">+		r.GasUsed = tx.gasLimit</span>
<span class="term-fg32">+		header.GasUsed += r.GasUsed</span>
<span class="term-fg32">+		rs = append(rs, &amp;r)</span>
<span class="term-fg32">+		nonce++</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	hasher := trie.NewStackTrie(nil)</span>
<span class="term-fg32">+	b := types.NewBlock(&amp;header, ts, nil, nil, hasher)</span>
<span class="term-fg32">+	return &amp;opTestBackend{block: b, receipts: rs}</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func TestSuggestOptimismPriorityFee(t *testing.T) {</span>
<span class="term-fg32">+	minSuggestion := new(big.Int).SetUint64(1e8 * params.Wei)</span>
<span class="term-fg32">+	var cases = []struct {</span>
<span class="term-fg32">+		txdata []testTxData</span>
<span class="term-fg32">+		want   *big.Int</span>
<span class="term-fg32">+	}{</span>
<span class="term-fg32">+		{</span>
<span class="term-fg32">+			&#47;&#47; block well under capacity, expect min priority fee suggestion</span>
<span class="term-fg32">+			txdata: []testTxData{testTxData{params.GWei, 21000}},</span>
<span class="term-fg32">+			want:   minSuggestion,</span>
<span class="term-fg32">+		},</span>
<span class="term-fg32">+		{</span>
<span class="term-fg32">+			&#47;&#47; 2 txs, still under capacity, expect min priority fee suggestion</span>
<span class="term-fg32">+			txdata: []testTxData{testTxData{params.GWei, 21000}, testTxData{params.GWei, 21000}},</span>
<span class="term-fg32">+			want:   minSuggestion,</span>
<span class="term-fg32">+		},</span>
<span class="term-fg32">+		{</span>
<span class="term-fg32">+			&#47;&#47; 2 txs w same priority fee (1 gwei), but second tx puts it right over capacity</span>
<span class="term-fg32">+			txdata: []testTxData{testTxData{params.GWei, 21000}, testTxData{params.GWei, 21001}},</span>
<span class="term-fg32">+			want:   big.NewInt(1100000000), &#47;&#47; 10 percent over 1 gwei, the median</span>
<span class="term-fg32">+		},</span>
<span class="term-fg32">+		{</span>
<span class="term-fg32">+			&#47;&#47; 3 txs, full block. return 10% over the median tx (10 gwei * 10% == 11 gwei)</span>
<span class="term-fg32">+			txdata: []testTxData{testTxData{10 * params.GWei, 21000}, testTxData{1 * params.GWei, 21000}, testTxData{100 * params.GWei, 21000}},</span>
<span class="term-fg32">+			want:   big.NewInt(11 * params.GWei),</span>
<span class="term-fg32">+		},</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	for i, c := range cases {</span>
<span class="term-fg32">+		backend := newOpTestBackend(t, c.txdata)</span>
<span class="term-fg32">+		oracle := NewOracle(backend, Config{MinSuggestedPriorityFee: minSuggestion})</span>
<span class="term-fg32">+		got := oracle.SuggestOptimismPriorityFee(context.Background(), backend.block.Header(), backend.block.Hash())</span>
<span class="term-fg32">+		if got.Cmp(c.want) != 0 {</span>
<span class="term-fg32">+			t.Errorf(&quot;Gas price mismatch for test case %d: want %d, got %d&quot;, i, c.want, got)</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+}</span></div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-bb5f72d0f0fd35fd52e71c67" role="button"
                   aria-expanded="false" aria-controls="id-bb5f72d0f0fd35fd52e71c67">
                    <code>eth/handler_eth_test.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/3f40e65c484486dea6cff80b7db178985d21a2c6/eth/handler_eth_test.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/650bb2f2b1dcfe30d9b1fa6f7dc9608055ed60e1/eth/handler_eth_test.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+9</span></div>
                        <div class="text-start"><span class="text-danger">-14</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-bb5f72d0f0fd35fd52e71c67"><span class="term-fg1">diff --git go-ethereum&#47;eth&#47;handler_eth_test.go op-geth&#47;eth&#47;handler_eth_test.go</span>
<span class="term-fg1">index 41619fe3000c52c14ac3f4db556b238cc9408bfc..bb342acc18f7a34dca1408ec22e407c51d56336c 100644</span>
<span class="term-fg1">--- go-ethereum&#47;eth&#47;handler_eth_test.go</span>
<span class="term-fg1">+++ op-geth&#47;eth&#47;handler_eth_test.go</span>
<span class="term-fg36">@@ -58,7 +58,7 @@</span> 	case *eth.NewBlockPacket:
 		h.blockBroadcasts.Send(packet.Block)
 		return nil
&nbsp;
<span class="term-fg31">-	case *eth.NewPooledTransactionHashesPacket66:</span>
<span class="term-fg32">+	case *eth.NewPooledTransactionHashesPacket67:</span>
 		h.txAnnounces.Send(([]common.Hash)(*packet))
 		return nil
&nbsp;
<span class="term-fg36">@@ -70,7 +70,7 @@</span> 	case *eth.TransactionsPacket:
 		h.txBroadcasts.Send(([]*types.Transaction)(*packet))
 		return nil
&nbsp;
<span class="term-fg31">-	case *eth.PooledTransactionsPacket:</span>
<span class="term-fg32">+	case *eth.PooledTransactionsResponse:</span>
 		h.txBroadcasts.Send(([]*types.Transaction)(*packet))
 		return nil
&nbsp;
<span class="term-fg36">@@ -81,7 +81,6 @@</span> }
&nbsp;
 &#47;&#47; Tests that peers are correctly accepted (or rejected) based on the advertised
 &#47;&#47; fork IDs in the protocol handshake.
<span class="term-fg31">-func TestForkIDSplit66(t *testing.T) { testForkIDSplit(t, eth.ETH66) }</span>
 func TestForkIDSplit67(t *testing.T) { testForkIDSplit(t, eth.ETH67) }
 func TestForkIDSplit68(t *testing.T) { testForkIDSplit(t, eth.ETH68) }
&nbsp;
<span class="term-fg36">@@ -237,7 +236,6 @@</span> 	}
 }
&nbsp;
 &#47;&#47; Tests that received transactions are added to the local pool.
<span class="term-fg31">-func TestRecvTransactions66(t *testing.T) { testRecvTransactions(t, eth.ETH66) }</span>
 func TestRecvTransactions67(t *testing.T) { testRecvTransactions(t, eth.ETH67) }
 func TestRecvTransactions68(t *testing.T) { testRecvTransactions(t, eth.ETH68) }
&nbsp;
<span class="term-fg36">@@ -248,10 +246,10 @@</span> 	&#47;&#47; Create a message handler, configure it to accept transactions and watch them
 	handler := newTestHandler()
 	defer handler.close()
&nbsp;
<span class="term-fg31">-	handler.handler.acceptTxs.Store(true) &#47;&#47; mark synced to accept transactions</span>
<span class="term-fg32">+	handler.handler.synced.Store(true) &#47;&#47; mark synced to accept transactions</span>
&nbsp;
 	txs := make(chan core.NewTxsEvent)
<span class="term-fg31">-	sub := handler.txpool.SubscribeNewTxsEvent(txs)</span>
<span class="term-fg32">+	sub := handler.txpool.SubscribeTransactions(txs, false)</span>
 	defer sub.Unsubscribe()
&nbsp;
 	&#47;&#47; Create a source peer to send messages through and a sink handler to receive them
<span class="term-fg36">@@ -296,7 +294,6 @@</span> 	}
 }
&nbsp;
 &#47;&#47; This test checks that pending transactions are sent.
<span class="term-fg31">-func TestSendTransactions66(t *testing.T) { testSendTransactions(t, eth.ETH66) }</span>
 func TestSendTransactions67(t *testing.T) { testSendTransactions(t, eth.ETH67) }
 func TestSendTransactions68(t *testing.T) { testSendTransactions(t, eth.ETH68) }
&nbsp;
<span class="term-fg36">@@ -356,7 +353,7 @@</span> 	&#47;&#47; Make sure we get all the transactions on the correct channels
 	seen := make(map[common.Hash]struct{})
 	for len(seen) &lt; len(insert) {
 		switch protocol {
<span class="term-fg31">-		case 66, 67, 68:</span>
<span class="term-fg32">+		case 67, 68:</span>
 			select {
 			case hashes := &lt;-anns:
 				for _, hash := range hashes {
<span class="term-fg36">@@ -382,7 +379,6 @@</span> }
&nbsp;
 &#47;&#47; Tests that transactions get propagated to all attached peers, either via direct
 &#47;&#47; broadcasts or via announcements&#47;retrievals.
<span class="term-fg31">-func TestTransactionPropagation66(t *testing.T) { testTransactionPropagation(t, eth.ETH66) }</span>
 func TestTransactionPropagation67(t *testing.T) { testTransactionPropagation(t, eth.ETH67) }
 func TestTransactionPropagation68(t *testing.T) { testTransactionPropagation(t, eth.ETH68) }
&nbsp;
<span class="term-fg36">@@ -401,7 +397,7 @@</span> 	for i := 0; i &lt; len(sinks); i++ {
 		sinks[i] = newTestHandler()
 		defer sinks[i].close()
&nbsp;
<span class="term-fg31">-		sinks[i].handler.acceptTxs.Store(true) &#47;&#47; mark synced to accept transactions</span>
<span class="term-fg32">+		sinks[i].handler.synced.Store(true) &#47;&#47; mark synced to accept transactions</span>
 	}
 	&#47;&#47; Interconnect all the sink handlers with the source handler
 	for i, sink := range sinks {
<span class="term-fg36">@@ -428,7 +424,7 @@</span> 	txChs := make([]chan core.NewTxsEvent, len(sinks))
 	for i := 0; i &lt; len(sinks); i++ {
 		txChs[i] = make(chan core.NewTxsEvent, 1024)
&nbsp;
<span class="term-fg31">-		sub := sinks[i].txpool.SubscribeNewTxsEvent(txChs[i])</span>
<span class="term-fg32">+		sub := sinks[i].txpool.SubscribeTransactions(txChs[i], false)</span>
 		defer sub.Unsubscribe()
 	}
 	&#47;&#47; Fill the source pool with transactions and wait for them at the sinks
<span class="term-fg36">@@ -490,8 +486,8 @@</span> 		sourcePipe, sinkPipe := p2p.MsgPipe()
 		defer sourcePipe.Close()
 		defer sinkPipe.Close()
&nbsp;
<span class="term-fg31">-		sourcePeer := eth.NewPeer(eth.ETH66, p2p.NewPeerPipe(enode.ID{byte(i)}, &quot;&quot;, nil, sourcePipe), sourcePipe, nil)</span>
<span class="term-fg31">-		sinkPeer := eth.NewPeer(eth.ETH66, p2p.NewPeerPipe(enode.ID{0}, &quot;&quot;, nil, sinkPipe), sinkPipe, nil)</span>
<span class="term-fg32">+		sourcePeer := eth.NewPeer(eth.ETH67, p2p.NewPeerPipe(enode.ID{byte(i)}, &quot;&quot;, nil, sourcePipe), sourcePipe, nil)</span>
<span class="term-fg32">+		sinkPeer := eth.NewPeer(eth.ETH67, p2p.NewPeerPipe(enode.ID{0}, &quot;&quot;, nil, sinkPipe), sinkPipe, nil)</span>
 		defer sourcePeer.Close()
 		defer sinkPeer.Close()
&nbsp;
<span class="term-fg36">@@ -543,7 +539,6 @@</span> }
&nbsp;
 &#47;&#47; Tests that a propagated malformed block (uncles or transactions don&#39;t match
 &#47;&#47; with the hashes in the header) gets discarded and not broadcast forward.
<span class="term-fg31">-func TestBroadcastMalformedBlock66(t *testing.T) { testBroadcastMalformedBlock(t, eth.ETH66) }</span>
 func TestBroadcastMalformedBlock67(t *testing.T) { testBroadcastMalformedBlock(t, eth.ETH67) }
 func TestBroadcastMalformedBlock68(t *testing.T) { testBroadcastMalformedBlock(t, eth.ETH68) }
</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-e8c56276eabff4c0efdef52a" role="button"
                   aria-expanded="false" aria-controls="id-e8c56276eabff4c0efdef52a">
                    <code>eth/handler_test.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/3f40e65c484486dea6cff80b7db178985d21a2c6/eth/handler_test.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/650bb2f2b1dcfe30d9b1fa6f7dc9608055ed60e1/eth/handler_test.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+4</span></div>
                        <div class="text-start"><span class="text-danger">-2</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-e8c56276eabff4c0efdef52a"><span class="term-fg1">diff --git go-ethereum&#47;eth&#47;handler_test.go op-geth&#47;eth&#47;handler_test.go</span>
<span class="term-fg1">index 2e0a988452b7e74bdadb4af9b1056863ba4105d7..6d6132ee4ce893e29a378fb4f07bcc11bbd3c7d7 100644</span>
<span class="term-fg1">--- go-ethereum&#47;eth&#47;handler_test.go</span>
<span class="term-fg1">+++ op-geth&#47;eth&#47;handler_test.go</span>
<span class="term-fg36">@@ -113,15 +113,17 @@</span> 				Tx:        tx,
 				Time:      tx.Time(),
 				GasFeeCap: tx.GasFeeCap(),
 				GasTipCap: tx.GasTipCap(),
<span class="term-fg32">+				Gas:       tx.Gas(),</span>
<span class="term-fg32">+				BlobGas:   tx.BlobGas(),</span>
 			})
 		}
 	}
 	return pending
 }
&nbsp;
<span class="term-fg31">-&#47;&#47; SubscribeNewTxsEvent should return an event subscription of NewTxsEvent and</span>
<span class="term-fg32">+&#47;&#47; SubscribeTransactions should return an event subscription of NewTxsEvent and</span>
 &#47;&#47; send events to the given channel.
<span class="term-fg31">-func (p *testTxPool) SubscribeNewTxsEvent(ch chan&lt;- core.NewTxsEvent) event.Subscription {</span>
<span class="term-fg32">+func (p *testTxPool) SubscribeTransactions(ch chan&lt;- core.NewTxsEvent, reorgs bool) event.Subscription {</span>
 	return p.txFeed.Subscribe(ch)
 }
</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-db671419ac07794fe0be2a2c" role="button"
                   aria-expanded="false" aria-controls="id-db671419ac07794fe0be2a2c">
                    <code>eth/peerset.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/3f40e65c484486dea6cff80b7db178985d21a2c6/eth/peerset.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/650bb2f2b1dcfe30d9b1fa6f7dc9608055ed60e1/eth/peerset.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+2</span></div>
                        <div class="text-start"><span class="text-danger">-1</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-db671419ac07794fe0be2a2c"><span class="term-fg1">diff --git go-ethereum&#47;eth&#47;peerset.go op-geth&#47;eth&#47;peerset.go</span>
<span class="term-fg1">index b9cc1e03aca3d02289d5467092afcdf2b0c3ee62..b27d3964a119e2c6a1e86bb4d251f75779ffc1cb 100644</span>
<span class="term-fg1">--- go-ethereum&#47;eth&#47;peerset.go</span>
<span class="term-fg1">+++ op-geth&#47;eth&#47;peerset.go</span>
<span class="term-fg36">@@ -18,6 +18,7 @@</span> package eth
&nbsp;
 import (
 	&quot;errors&quot;
<span class="term-fg32">+	&quot;fmt&quot;</span>
 	&quot;math&#47;big&quot;
 	&quot;sync&quot;
&nbsp;
<span class="term-fg36">@@ -74,7 +75,7 @@</span> func (ps *peerSet) registerSnapExtension(peer *snap.Peer) error {
 	&#47;&#47; Reject the peer if it advertises `snap` without `eth` as `snap` is only a
 	&#47;&#47; satellite protocol meaningful with the chain selection of `eth`
 	if !peer.RunningCap(eth.ProtocolName, eth.ProtocolVersions) {
<span class="term-fg31">-		return errSnapWithoutEth</span>
<span class="term-fg32">+		return fmt.Errorf(&quot;%w: have %v&quot;, errSnapWithoutEth, peer.Caps())</span>
 	}
 	&#47;&#47; Ensure nobody can double connect
 	ps.lock.Lock()</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-5121d58d3e969c13040932dd" role="button"
                   aria-expanded="false" aria-controls="id-5121d58d3e969c13040932dd">
                    <code>eth/protocols/eth/handler.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/3f40e65c484486dea6cff80b7db178985d21a2c6/eth/protocols/eth/handler.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/650bb2f2b1dcfe30d9b1fa6f7dc9608055ed60e1/eth/protocols/eth/handler.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+22</span></div>
                        <div class="text-start"><span class="text-danger">-48</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-5121d58d3e969c13040932dd"><span class="term-fg1">diff --git go-ethereum&#47;eth&#47;protocols&#47;eth&#47;handler.go op-geth&#47;eth&#47;protocols&#47;eth&#47;handler.go</span>
<span class="term-fg1">index b2ce883bc501c94b5aec9845a04a2f4eb6cffce8..42d0412a127c8b62ba0a5693cf98dde6652122ed 100644</span>
<span class="term-fg1">--- go-ethereum&#47;eth&#47;protocols&#47;eth&#47;handler.go</span>
<span class="term-fg1">+++ op-geth&#47;eth&#47;protocols&#47;eth&#47;handler.go</span>
<span class="term-fg36">@@ -23,7 +23,6 @@</span> 	&quot;time&quot;
&nbsp;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;common&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;core&quot;
<span class="term-fg31">-	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;core&#47;rawdb&quot;</span>
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;core&#47;types&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;metrics&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;p2p&quot;
<span class="term-fg36">@@ -44,10 +43,6 @@</span> 	&#47;&#47; maxBodiesServe is the maximum number of block bodies to serve. This number
 	&#47;&#47; is mostly there to limit the number of disk lookups. With 24KB block sizes
 	&#47;&#47; nowadays, the practical limit will always be softResponseLimit.
 	maxBodiesServe = 1024
<span class="term-fg31">-</span>
<span class="term-fg31">-	&#47;&#47; maxNodeDataServe is the maximum number of state trie nodes to serve. This</span>
<span class="term-fg31">-	&#47;&#47; number is there to limit the number of disk lookups.</span>
<span class="term-fg31">-	maxNodeDataServe = 1024</span>
&nbsp;
 	&#47;&#47; maxReceiptsServe is the maximum number of block receipts to serve. This
 	&#47;&#47; number is mostly there to limit the number of disk lookups. With block
<span class="term-fg36">@@ -98,12 +93,12 @@</span> &#47;&#47; MakeProtocols constructs the P2P protocol definitions for `eth`.
 func MakeProtocols(backend Backend, network uint64, dnsdisc enode.Iterator) []p2p.Protocol {
 	protocols := make([]p2p.Protocol, 0, len(ProtocolVersions))
 	for _, version := range ProtocolVersions {
<span class="term-fg31">-		version := version &#47;&#47; Closure</span>
<span class="term-fg31">-</span>
<span class="term-fg31">-		&#47;&#47; Path scheme does not support GetNodeData, don&#39;t advertise eth66 on it</span>
<span class="term-fg31">-		if version &lt;= ETH66 &amp;&amp; backend.Chain().TrieDB().Scheme() == rawdb.PathScheme {</span>
<span class="term-fg32">+		&#47;&#47; Blob transactions require eth&#47;68 announcements, disable everything else</span>
<span class="term-fg32">+		if version &lt;= ETH67 &amp;&amp; backend.Chain().Config().CancunTime != nil {</span>
 			continue
 		}
<span class="term-fg32">+		version := version &#47;&#47; Closure</span>
<span class="term-fg32">+</span>
 		protocols = append(protocols, p2p.Protocol{
 			Name:    ProtocolName,
 			Version: version,
<span class="term-fg36">@@ -171,36 +166,19 @@</span> 	Decode(val interface{}) error
 	Time() time.Time
 }
&nbsp;
<span class="term-fg31">-var eth66 = map[uint64]msgHandler{</span>
<span class="term-fg31">-	NewBlockHashesMsg:             handleNewBlockhashes,</span>
<span class="term-fg31">-	NewBlockMsg:                   handleNewBlock,</span>
<span class="term-fg31">-	TransactionsMsg:               handleTransactions,</span>
<span class="term-fg31">-	NewPooledTransactionHashesMsg: handleNewPooledTransactionHashes66,</span>
<span class="term-fg31">-	GetBlockHeadersMsg:            handleGetBlockHeaders66,</span>
<span class="term-fg31">-	BlockHeadersMsg:               handleBlockHeaders66,</span>
<span class="term-fg31">-	GetBlockBodiesMsg:             handleGetBlockBodies66,</span>
<span class="term-fg31">-	BlockBodiesMsg:                handleBlockBodies66,</span>
<span class="term-fg31">-	GetNodeDataMsg:                handleGetNodeData66,</span>
<span class="term-fg31">-	NodeDataMsg:                   handleNodeData66,</span>
<span class="term-fg31">-	GetReceiptsMsg:                handleGetReceipts66,</span>
<span class="term-fg31">-	ReceiptsMsg:                   handleReceipts66,</span>
<span class="term-fg31">-	GetPooledTransactionsMsg:      handleGetPooledTransactions66,</span>
<span class="term-fg31">-	PooledTransactionsMsg:         handlePooledTransactions66,</span>
<span class="term-fg31">-}</span>
<span class="term-fg31">-</span>
 var eth67 = map[uint64]msgHandler{
 	NewBlockHashesMsg:             handleNewBlockhashes,
 	NewBlockMsg:                   handleNewBlock,
 	TransactionsMsg:               handleTransactions,
<span class="term-fg31">-	NewPooledTransactionHashesMsg: handleNewPooledTransactionHashes66,</span>
<span class="term-fg31">-	GetBlockHeadersMsg:            handleGetBlockHeaders66,</span>
<span class="term-fg31">-	BlockHeadersMsg:               handleBlockHeaders66,</span>
<span class="term-fg31">-	GetBlockBodiesMsg:             handleGetBlockBodies66,</span>
<span class="term-fg31">-	BlockBodiesMsg:                handleBlockBodies66,</span>
<span class="term-fg31">-	GetReceiptsMsg:                handleGetReceipts66,</span>
<span class="term-fg31">-	ReceiptsMsg:                   handleReceipts66,</span>
<span class="term-fg31">-	GetPooledTransactionsMsg:      handleGetPooledTransactions66,</span>
<span class="term-fg31">-	PooledTransactionsMsg:         handlePooledTransactions66,</span>
<span class="term-fg32">+	NewPooledTransactionHashesMsg: handleNewPooledTransactionHashes67,</span>
<span class="term-fg32">+	GetBlockHeadersMsg:            handleGetBlockHeaders,</span>
<span class="term-fg32">+	BlockHeadersMsg:               handleBlockHeaders,</span>
<span class="term-fg32">+	GetBlockBodiesMsg:             handleGetBlockBodies,</span>
<span class="term-fg32">+	BlockBodiesMsg:                handleBlockBodies,</span>
<span class="term-fg32">+	GetReceiptsMsg:                handleGetReceipts,</span>
<span class="term-fg32">+	ReceiptsMsg:                   handleReceipts,</span>
<span class="term-fg32">+	GetPooledTransactionsMsg:      handleGetPooledTransactions,</span>
<span class="term-fg32">+	PooledTransactionsMsg:         handlePooledTransactions,</span>
 }
&nbsp;
 var eth68 = map[uint64]msgHandler{
<span class="term-fg36">@@ -208,14 +186,14 @@</span> 	NewBlockHashesMsg:             handleNewBlockhashes,
 	NewBlockMsg:                   handleNewBlock,
 	TransactionsMsg:               handleTransactions,
 	NewPooledTransactionHashesMsg: handleNewPooledTransactionHashes68,
<span class="term-fg31">-	GetBlockHeadersMsg:            handleGetBlockHeaders66,</span>
<span class="term-fg31">-	BlockHeadersMsg:               handleBlockHeaders66,</span>
<span class="term-fg31">-	GetBlockBodiesMsg:             handleGetBlockBodies66,</span>
<span class="term-fg31">-	BlockBodiesMsg:                handleBlockBodies66,</span>
<span class="term-fg31">-	GetReceiptsMsg:                handleGetReceipts66,</span>
<span class="term-fg31">-	ReceiptsMsg:                   handleReceipts66,</span>
<span class="term-fg31">-	GetPooledTransactionsMsg:      handleGetPooledTransactions66,</span>
<span class="term-fg31">-	PooledTransactionsMsg:         handlePooledTransactions66,</span>
<span class="term-fg32">+	GetBlockHeadersMsg:            handleGetBlockHeaders,</span>
<span class="term-fg32">+	BlockHeadersMsg:               handleBlockHeaders,</span>
<span class="term-fg32">+	GetBlockBodiesMsg:             handleGetBlockBodies,</span>
<span class="term-fg32">+	BlockBodiesMsg:                handleBlockBodies,</span>
<span class="term-fg32">+	GetReceiptsMsg:                handleGetReceipts,</span>
<span class="term-fg32">+	ReceiptsMsg:                   handleReceipts,</span>
<span class="term-fg32">+	GetPooledTransactionsMsg:      handleGetPooledTransactions,</span>
<span class="term-fg32">+	PooledTransactionsMsg:         handlePooledTransactions,</span>
 }
&nbsp;
 &#47;&#47; handleMessage is invoked whenever an inbound message is received from a remote
<span class="term-fg36">@@ -231,14 +209,10 @@</span> 		return fmt.Errorf(&quot;%w: %v &gt; %v&quot;, errMsgTooLarge, msg.Size, maxMessageSize)
 	}
 	defer msg.Discard()
&nbsp;
<span class="term-fg31">-	var handlers = eth66</span>
<span class="term-fg31">-	if peer.Version() == ETH67 {</span>
<span class="term-fg31">-		handlers = eth67</span>
<span class="term-fg31">-	}</span>
<span class="term-fg32">+	var handlers = eth67</span>
 	if peer.Version() &gt;= ETH68 {
 		handlers = eth68
 	}
<span class="term-fg31">-</span>
 	&#47;&#47; Track the amount of time it takes to serve the request and run the handler
 	if metrics.Enabled {
 		h := fmt.Sprintf(&quot;%s&#47;%s&#47;%d&#47;%#02x&quot;, p2p.HandleHistName, ProtocolName, peer.Version(), msg.Code)</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-d1859976f6ae44510fbda6c0" role="button"
                   aria-expanded="false" aria-controls="id-d1859976f6ae44510fbda6c0">
                    <code>eth/protocols/eth/handler_test.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/3f40e65c484486dea6cff80b7db178985d21a2c6/eth/protocols/eth/handler_test.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/650bb2f2b1dcfe30d9b1fa6f7dc9608055ed60e1/eth/protocols/eth/handler_test.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+43</span></div>
                        <div class="text-start"><span class="text-danger">-165</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-d1859976f6ae44510fbda6c0"><span class="term-fg1">diff --git go-ethereum&#47;eth&#47;protocols&#47;eth&#47;handler_test.go op-geth&#47;eth&#47;protocols&#47;eth&#47;handler_test.go</span>
<span class="term-fg1">index bf2874721afe1588055c36922d494ec8679788bf..41e18bfb3e01b7f32d7b29cca720fda9de26a4cb 100644</span>
<span class="term-fg1">--- go-ethereum&#47;eth&#47;protocols&#47;eth&#47;handler_test.go</span>
<span class="term-fg1">+++ op-geth&#47;eth&#47;protocols&#47;eth&#47;handler_test.go</span>
<span class="term-fg36">@@ -28,7 +28,6 @@</span> 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;consensus&#47;beacon&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;consensus&#47;ethash&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;core&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;core&#47;rawdb&quot;
<span class="term-fg31">-	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;core&#47;state&quot;</span>
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;core&#47;txpool&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;core&#47;txpool&#47;legacypool&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;core&#47;types&quot;
<span class="term-fg36">@@ -151,7 +150,6 @@</span> 	panic(&quot;data processing tests should be done in the handler package&quot;)
 }
&nbsp;
 &#47;&#47; Tests that block headers can be retrieved from a remote chain based on user queries.
<span class="term-fg31">-func TestGetBlockHeaders66(t *testing.T) { testGetBlockHeaders(t, ETH66) }</span>
 func TestGetBlockHeaders67(t *testing.T) { testGetBlockHeaders(t, ETH67) }
 func TestGetBlockHeaders68(t *testing.T) { testGetBlockHeaders(t, ETH68) }
&nbsp;
<span class="term-fg36">@@ -178,29 +176,29 @@</span> 	}
 	&#47;&#47; Create a batch of tests for various scenarios
 	limit := uint64(maxHeadersServe)
 	tests := []struct {
<span class="term-fg31">-		query  *GetBlockHeadersPacket &#47;&#47; The query to execute for header retrieval</span>
<span class="term-fg31">-		expect []common.Hash          &#47;&#47; The hashes of the block whose headers are expected</span>
<span class="term-fg32">+		query  *GetBlockHeadersRequest &#47;&#47; The query to execute for header retrieval</span>
<span class="term-fg32">+		expect []common.Hash           &#47;&#47; The hashes of the block whose headers are expected</span>
 	}{
 		&#47;&#47; A single random block should be retrievable by hash
 		{
<span class="term-fg31">-			&amp;GetBlockHeadersPacket{Origin: HashOrNumber{Hash: backend.chain.GetBlockByNumber(limit &#47; 2).Hash()}, Amount: 1},</span>
<span class="term-fg32">+			&amp;GetBlockHeadersRequest{Origin: HashOrNumber{Hash: backend.chain.GetBlockByNumber(limit &#47; 2).Hash()}, Amount: 1},</span>
 			[]common.Hash{backend.chain.GetBlockByNumber(limit &#47; 2).Hash()},
 		},
 		&#47;&#47; A single random block should be retrievable by number
 		{
<span class="term-fg31">-			&amp;GetBlockHeadersPacket{Origin: HashOrNumber{Number: limit &#47; 2}, Amount: 1},</span>
<span class="term-fg32">+			&amp;GetBlockHeadersRequest{Origin: HashOrNumber{Number: limit &#47; 2}, Amount: 1},</span>
 			[]common.Hash{backend.chain.GetBlockByNumber(limit &#47; 2).Hash()},
 		},
 		&#47;&#47; Multiple headers should be retrievable in both directions
 		{
<span class="term-fg31">-			&amp;GetBlockHeadersPacket{Origin: HashOrNumber{Number: limit &#47; 2}, Amount: 3},</span>
<span class="term-fg32">+			&amp;GetBlockHeadersRequest{Origin: HashOrNumber{Number: limit &#47; 2}, Amount: 3},</span>
 			[]common.Hash{
 				backend.chain.GetBlockByNumber(limit &#47; 2).Hash(),
 				backend.chain.GetBlockByNumber(limit&#47;2 + 1).Hash(),
 				backend.chain.GetBlockByNumber(limit&#47;2 + 2).Hash(),
 			},
 		}, {
<span class="term-fg31">-			&amp;GetBlockHeadersPacket{Origin: HashOrNumber{Number: limit &#47; 2}, Amount: 3, Reverse: true},</span>
<span class="term-fg32">+			&amp;GetBlockHeadersRequest{Origin: HashOrNumber{Number: limit &#47; 2}, Amount: 3, Reverse: true},</span>
 			[]common.Hash{
 				backend.chain.GetBlockByNumber(limit &#47; 2).Hash(),
 				backend.chain.GetBlockByNumber(limit&#47;2 - 1).Hash(),
<span class="term-fg36">@@ -209,14 +207,14 @@</span> 			},
 		},
 		&#47;&#47; Multiple headers with skip lists should be retrievable
 		{
<span class="term-fg31">-			&amp;GetBlockHeadersPacket{Origin: HashOrNumber{Number: limit &#47; 2}, Skip: 3, Amount: 3},</span>
<span class="term-fg32">+			&amp;GetBlockHeadersRequest{Origin: HashOrNumber{Number: limit &#47; 2}, Skip: 3, Amount: 3},</span>
 			[]common.Hash{
 				backend.chain.GetBlockByNumber(limit &#47; 2).Hash(),
 				backend.chain.GetBlockByNumber(limit&#47;2 + 4).Hash(),
 				backend.chain.GetBlockByNumber(limit&#47;2 + 8).Hash(),
 			},
 		}, {
<span class="term-fg31">-			&amp;GetBlockHeadersPacket{Origin: HashOrNumber{Number: limit &#47; 2}, Skip: 3, Amount: 3, Reverse: true},</span>
<span class="term-fg32">+			&amp;GetBlockHeadersRequest{Origin: HashOrNumber{Number: limit &#47; 2}, Skip: 3, Amount: 3, Reverse: true},</span>
 			[]common.Hash{
 				backend.chain.GetBlockByNumber(limit &#47; 2).Hash(),
 				backend.chain.GetBlockByNumber(limit&#47;2 - 4).Hash(),
<span class="term-fg36">@@ -225,31 +223,31 @@</span> 			},
 		},
 		&#47;&#47; The chain endpoints should be retrievable
 		{
<span class="term-fg31">-			&amp;GetBlockHeadersPacket{Origin: HashOrNumber{Number: 0}, Amount: 1},</span>
<span class="term-fg32">+			&amp;GetBlockHeadersRequest{Origin: HashOrNumber{Number: 0}, Amount: 1},</span>
 			[]common.Hash{backend.chain.GetBlockByNumber(0).Hash()},
 		},
 		{
<span class="term-fg31">-			&amp;GetBlockHeadersPacket{Origin: HashOrNumber{Number: backend.chain.CurrentBlock().Number.Uint64()}, Amount: 1},</span>
<span class="term-fg32">+			&amp;GetBlockHeadersRequest{Origin: HashOrNumber{Number: backend.chain.CurrentBlock().Number.Uint64()}, Amount: 1},</span>
 			[]common.Hash{backend.chain.CurrentBlock().Hash()},
 		},
 		{ &#47;&#47; If the peer requests a bit into the future, we deliver what we have
<span class="term-fg31">-			&amp;GetBlockHeadersPacket{Origin: HashOrNumber{Number: backend.chain.CurrentBlock().Number.Uint64()}, Amount: 10},</span>
<span class="term-fg32">+			&amp;GetBlockHeadersRequest{Origin: HashOrNumber{Number: backend.chain.CurrentBlock().Number.Uint64()}, Amount: 10},</span>
 			[]common.Hash{backend.chain.CurrentBlock().Hash()},
 		},
 		&#47;&#47; Ensure protocol limits are honored
 		{
<span class="term-fg31">-			&amp;GetBlockHeadersPacket{Origin: HashOrNumber{Number: backend.chain.CurrentBlock().Number.Uint64() - 1}, Amount: limit + 10, Reverse: true},</span>
<span class="term-fg32">+			&amp;GetBlockHeadersRequest{Origin: HashOrNumber{Number: backend.chain.CurrentBlock().Number.Uint64() - 1}, Amount: limit + 10, Reverse: true},</span>
 			getHashes(backend.chain.CurrentBlock().Number.Uint64(), limit),
 		},
 		&#47;&#47; Check that requesting more than available is handled gracefully
 		{
<span class="term-fg31">-			&amp;GetBlockHeadersPacket{Origin: HashOrNumber{Number: backend.chain.CurrentBlock().Number.Uint64() - 4}, Skip: 3, Amount: 3},</span>
<span class="term-fg32">+			&amp;GetBlockHeadersRequest{Origin: HashOrNumber{Number: backend.chain.CurrentBlock().Number.Uint64() - 4}, Skip: 3, Amount: 3},</span>
 			[]common.Hash{
 				backend.chain.GetBlockByNumber(backend.chain.CurrentBlock().Number.Uint64() - 4).Hash(),
 				backend.chain.GetBlockByNumber(backend.chain.CurrentBlock().Number.Uint64()).Hash(),
 			},
 		}, {
<span class="term-fg31">-			&amp;GetBlockHeadersPacket{Origin: HashOrNumber{Number: 4}, Skip: 3, Amount: 3, Reverse: true},</span>
<span class="term-fg32">+			&amp;GetBlockHeadersRequest{Origin: HashOrNumber{Number: 4}, Skip: 3, Amount: 3, Reverse: true},</span>
 			[]common.Hash{
 				backend.chain.GetBlockByNumber(4).Hash(),
 				backend.chain.GetBlockByNumber(0).Hash(),
<span class="term-fg36">@@ -257,13 +255,13 @@</span> 			},
 		},
 		&#47;&#47; Check that requesting more than available is handled gracefully, even if mid skip
 		{
<span class="term-fg31">-			&amp;GetBlockHeadersPacket{Origin: HashOrNumber{Number: backend.chain.CurrentBlock().Number.Uint64() - 4}, Skip: 2, Amount: 3},</span>
<span class="term-fg32">+			&amp;GetBlockHeadersRequest{Origin: HashOrNumber{Number: backend.chain.CurrentBlock().Number.Uint64() - 4}, Skip: 2, Amount: 3},</span>
 			[]common.Hash{
 				backend.chain.GetBlockByNumber(backend.chain.CurrentBlock().Number.Uint64() - 4).Hash(),
 				backend.chain.GetBlockByNumber(backend.chain.CurrentBlock().Number.Uint64() - 1).Hash(),
 			},
 		}, {
<span class="term-fg31">-			&amp;GetBlockHeadersPacket{Origin: HashOrNumber{Number: 4}, Skip: 2, Amount: 3, Reverse: true},</span>
<span class="term-fg32">+			&amp;GetBlockHeadersRequest{Origin: HashOrNumber{Number: 4}, Skip: 2, Amount: 3, Reverse: true},</span>
 			[]common.Hash{
 				backend.chain.GetBlockByNumber(4).Hash(),
 				backend.chain.GetBlockByNumber(1).Hash(),
<span class="term-fg36">@@ -271,7 +269,7 @@</span> 			},
 		},
 		&#47;&#47; Check a corner case where requesting more can iterate past the endpoints
 		{
<span class="term-fg31">-			&amp;GetBlockHeadersPacket{Origin: HashOrNumber{Number: 2}, Amount: 5, Reverse: true},</span>
<span class="term-fg32">+			&amp;GetBlockHeadersRequest{Origin: HashOrNumber{Number: 2}, Amount: 5, Reverse: true},</span>
 			[]common.Hash{
 				backend.chain.GetBlockByNumber(2).Hash(),
 				backend.chain.GetBlockByNumber(1).Hash(),
<span class="term-fg36">@@ -280,24 +278,24 @@</span> 			},
 		},
 		&#47;&#47; Check a corner case where skipping overflow loops back into the chain start
 		{
<span class="term-fg31">-			&amp;GetBlockHeadersPacket{Origin: HashOrNumber{Hash: backend.chain.GetBlockByNumber(3).Hash()}, Amount: 2, Reverse: false, Skip: math.MaxUint64 - 1},</span>
<span class="term-fg32">+			&amp;GetBlockHeadersRequest{Origin: HashOrNumber{Hash: backend.chain.GetBlockByNumber(3).Hash()}, Amount: 2, Reverse: false, Skip: math.MaxUint64 - 1},</span>
 			[]common.Hash{
 				backend.chain.GetBlockByNumber(3).Hash(),
 			},
 		},
 		&#47;&#47; Check a corner case where skipping overflow loops back to the same header
 		{
<span class="term-fg31">-			&amp;GetBlockHeadersPacket{Origin: HashOrNumber{Hash: backend.chain.GetBlockByNumber(1).Hash()}, Amount: 2, Reverse: false, Skip: math.MaxUint64},</span>
<span class="term-fg32">+			&amp;GetBlockHeadersRequest{Origin: HashOrNumber{Hash: backend.chain.GetBlockByNumber(1).Hash()}, Amount: 2, Reverse: false, Skip: math.MaxUint64},</span>
 			[]common.Hash{
 				backend.chain.GetBlockByNumber(1).Hash(),
 			},
 		},
 		&#47;&#47; Check that non existing headers aren&#39;t returned
 		{
<span class="term-fg31">-			&amp;GetBlockHeadersPacket{Origin: HashOrNumber{Hash: unknown}, Amount: 1},</span>
<span class="term-fg32">+			&amp;GetBlockHeadersRequest{Origin: HashOrNumber{Hash: unknown}, Amount: 1},</span>
 			[]common.Hash{},
 		}, {
<span class="term-fg31">-			&amp;GetBlockHeadersPacket{Origin: HashOrNumber{Number: backend.chain.CurrentBlock().Number.Uint64() + 1}, Amount: 1},</span>
<span class="term-fg32">+			&amp;GetBlockHeadersRequest{Origin: HashOrNumber{Number: backend.chain.CurrentBlock().Number.Uint64() + 1}, Amount: 1},</span>
 			[]common.Hash{},
 		},
 	}
<span class="term-fg36">@@ -309,13 +307,13 @@</span> 		for _, hash := range tt.expect {
 			headers = append(headers, backend.chain.GetBlockByHash(hash).Header())
 		}
 		&#47;&#47; Send the hash request and verify the response
<span class="term-fg31">-		p2p.Send(peer.app, GetBlockHeadersMsg, &amp;GetBlockHeadersPacket66{</span>
<span class="term-fg31">-			RequestId:             123,</span>
<span class="term-fg31">-			GetBlockHeadersPacket: tt.query,</span>
<span class="term-fg32">+		p2p.Send(peer.app, GetBlockHeadersMsg, &amp;GetBlockHeadersPacket{</span>
<span class="term-fg32">+			RequestId:              123,</span>
<span class="term-fg32">+			GetBlockHeadersRequest: tt.query,</span>
 		})
<span class="term-fg31">-		if err := p2p.ExpectMsg(peer.app, BlockHeadersMsg, &amp;BlockHeadersPacket66{</span>
<span class="term-fg31">-			RequestId:          123,</span>
<span class="term-fg31">-			BlockHeadersPacket: headers,</span>
<span class="term-fg32">+		if err := p2p.ExpectMsg(peer.app, BlockHeadersMsg, &amp;BlockHeadersPacket{</span>
<span class="term-fg32">+			RequestId:           123,</span>
<span class="term-fg32">+			BlockHeadersRequest: headers,</span>
 		}); err != nil {
 			t.Errorf(&quot;test %d: headers mismatch: %v&quot;, i, err)
 		}
<span class="term-fg36">@@ -324,11 +322,11 @@</span> 		if tt.query.Origin.Hash == (common.Hash{}) {
 			if origin := backend.chain.GetBlockByNumber(tt.query.Origin.Number); origin != nil {
 				tt.query.Origin.Hash, tt.query.Origin.Number = origin.Hash(), 0
&nbsp;
<span class="term-fg31">-				p2p.Send(peer.app, GetBlockHeadersMsg, &amp;GetBlockHeadersPacket66{</span>
<span class="term-fg31">-					RequestId:             456,</span>
<span class="term-fg31">-					GetBlockHeadersPacket: tt.query,</span>
<span class="term-fg32">+				p2p.Send(peer.app, GetBlockHeadersMsg, &amp;GetBlockHeadersPacket{</span>
<span class="term-fg32">+					RequestId:              456,</span>
<span class="term-fg32">+					GetBlockHeadersRequest: tt.query,</span>
 				})
<span class="term-fg31">-				expected := &amp;BlockHeadersPacket66{RequestId: 456, BlockHeadersPacket: headers}</span>
<span class="term-fg32">+				expected := &amp;BlockHeadersPacket{RequestId: 456, BlockHeadersRequest: headers}</span>
 				if err := p2p.ExpectMsg(peer.app, BlockHeadersMsg, expected); err != nil {
 					t.Errorf(&quot;test %d by hash: headers mismatch: %v&quot;, i, err)
 				}
<span class="term-fg36">@@ -338,7 +336,6 @@</span> 	}
 }
&nbsp;
 &#47;&#47; Tests that block contents can be retrieved from a remote chain based on their hashes.
<span class="term-fg31">-func TestGetBlockBodies66(t *testing.T) { testGetBlockBodies(t, ETH66) }</span>
 func TestGetBlockBodies67(t *testing.T) { testGetBlockBodies(t, ETH67) }
 func TestGetBlockBodies68(t *testing.T) { testGetBlockBodies(t, ETH68) }
&nbsp;
<span class="term-fg36">@@ -420,139 +417,20 @@</span> 			}
 		}
&nbsp;
 		&#47;&#47; Send the hash request and verify the response
<span class="term-fg31">-		p2p.Send(peer.app, GetBlockBodiesMsg, &amp;GetBlockBodiesPacket66{</span>
<span class="term-fg31">-			RequestId:            123,</span>
<span class="term-fg31">-			GetBlockBodiesPacket: hashes,</span>
<span class="term-fg32">+		p2p.Send(peer.app, GetBlockBodiesMsg, &amp;GetBlockBodiesPacket{</span>
<span class="term-fg32">+			RequestId:             123,</span>
<span class="term-fg32">+			GetBlockBodiesRequest: hashes,</span>
 		})
<span class="term-fg31">-		if err := p2p.ExpectMsg(peer.app, BlockBodiesMsg, &amp;BlockBodiesPacket66{</span>
<span class="term-fg31">-			RequestId:         123,</span>
<span class="term-fg31">-			BlockBodiesPacket: bodies,</span>
<span class="term-fg32">+		if err := p2p.ExpectMsg(peer.app, BlockBodiesMsg, &amp;BlockBodiesPacket{</span>
<span class="term-fg32">+			RequestId:           123,</span>
<span class="term-fg32">+			BlockBodiesResponse: bodies,</span>
 		}); err != nil {
 			t.Fatalf(&quot;test %d: bodies mismatch: %v&quot;, i, err)
 		}
 	}
 }
&nbsp;
<span class="term-fg31">-&#47;&#47; Tests that the state trie nodes can be retrieved based on hashes.</span>
<span class="term-fg31">-func TestGetNodeData66(t *testing.T) { testGetNodeData(t, ETH66, false) }</span>
<span class="term-fg31">-func TestGetNodeData67(t *testing.T) { testGetNodeData(t, ETH67, true) }</span>
<span class="term-fg31">-func TestGetNodeData68(t *testing.T) { testGetNodeData(t, ETH68, true) }</span>
<span class="term-fg31">-</span>
<span class="term-fg31">-func testGetNodeData(t *testing.T, protocol uint, drop bool) {</span>
<span class="term-fg31">-	t.Parallel()</span>
<span class="term-fg31">-</span>
<span class="term-fg31">-	&#47;&#47; Define three accounts to simulate transactions with</span>
<span class="term-fg31">-	acc1Key, _ := crypto.HexToECDSA(&quot;8a1f9a8f95be41cd7ccb6168179afb4504aefe388d1e14474d32c45c72ce7b7a&quot;)</span>
<span class="term-fg31">-	acc2Key, _ := crypto.HexToECDSA(&quot;49a7b37aa6f6645917e7b807e9d1c00d4fa71f18343b0d4122a4d2df64dd6fee&quot;)</span>
<span class="term-fg31">-	acc1Addr := crypto.PubkeyToAddress(acc1Key.PublicKey)</span>
<span class="term-fg31">-	acc2Addr := crypto.PubkeyToAddress(acc2Key.PublicKey)</span>
<span class="term-fg31">-</span>
<span class="term-fg31">-	signer := types.HomesteadSigner{}</span>
<span class="term-fg31">-	&#47;&#47; Create a chain generator with some simple transactions (blatantly stolen from @fjl&#47;chain_makers_test)</span>
<span class="term-fg31">-	generator := func(i int, block *core.BlockGen) {</span>
<span class="term-fg31">-		switch i {</span>
<span class="term-fg31">-		case 0:</span>
<span class="term-fg31">-			&#47;&#47; In block 1, the test bank sends account #1 some ether.</span>
<span class="term-fg31">-			tx, _ := types.SignTx(types.NewTransaction(block.TxNonce(testAddr), acc1Addr, big.NewInt(10_000_000_000_000_000), params.TxGas, block.BaseFee(), nil), signer, testKey)</span>
<span class="term-fg31">-			block.AddTx(tx)</span>
<span class="term-fg31">-		case 1:</span>
<span class="term-fg31">-			&#47;&#47; In block 2, the test bank sends some more ether to account #1.</span>
<span class="term-fg31">-			&#47;&#47; acc1Addr passes it on to account #2.</span>
<span class="term-fg31">-			tx1, _ := types.SignTx(types.NewTransaction(block.TxNonce(testAddr), acc1Addr, big.NewInt(1_000_000_000_000_000), params.TxGas, block.BaseFee(), nil), signer, testKey)</span>
<span class="term-fg31">-			tx2, _ := types.SignTx(types.NewTransaction(block.TxNonce(acc1Addr), acc2Addr, big.NewInt(1_000_000_000_000_000), params.TxGas, block.BaseFee(), nil), signer, acc1Key)</span>
<span class="term-fg31">-			block.AddTx(tx1)</span>
<span class="term-fg31">-			block.AddTx(tx2)</span>
<span class="term-fg31">-		case 2:</span>
<span class="term-fg31">-			&#47;&#47; Block 3 is empty but was mined by account #2.</span>
<span class="term-fg31">-			block.SetCoinbase(acc2Addr)</span>
<span class="term-fg31">-			block.SetExtra([]byte(&quot;yeehaw&quot;))</span>
<span class="term-fg31">-		case 3:</span>
<span class="term-fg31">-			&#47;&#47; Block 4 includes blocks 2 and 3 as uncle headers (with modified extra data).</span>
<span class="term-fg31">-			b2 := block.PrevBlock(1).Header()</span>
<span class="term-fg31">-			b2.Extra = []byte(&quot;foo&quot;)</span>
<span class="term-fg31">-			block.AddUncle(b2)</span>
<span class="term-fg31">-			b3 := block.PrevBlock(2).Header()</span>
<span class="term-fg31">-			b3.Extra = []byte(&quot;foo&quot;)</span>
<span class="term-fg31">-			block.AddUncle(b3)</span>
<span class="term-fg31">-		}</span>
<span class="term-fg31">-	}</span>
<span class="term-fg31">-	&#47;&#47; Assemble the test environment</span>
<span class="term-fg31">-	backend := newTestBackendWithGenerator(4, false, generator)</span>
<span class="term-fg31">-	defer backend.close()</span>
<span class="term-fg31">-</span>
<span class="term-fg31">-	peer, _ := newTestPeer(&quot;peer&quot;, protocol, backend)</span>
<span class="term-fg31">-	defer peer.close()</span>
<span class="term-fg31">-</span>
<span class="term-fg31">-	&#47;&#47; Collect all state tree hashes.</span>
<span class="term-fg31">-	var hashes []common.Hash</span>
<span class="term-fg31">-	it := backend.db.NewIterator(nil, nil)</span>
<span class="term-fg31">-	for it.Next() {</span>
<span class="term-fg31">-		if key := it.Key(); len(key) == common.HashLength {</span>
<span class="term-fg31">-			hashes = append(hashes, common.BytesToHash(key))</span>
<span class="term-fg31">-		}</span>
<span class="term-fg31">-	}</span>
<span class="term-fg31">-	it.Release()</span>
<span class="term-fg31">-</span>
<span class="term-fg31">-	&#47;&#47; Request all hashes.</span>
<span class="term-fg31">-	p2p.Send(peer.app, GetNodeDataMsg, &amp;GetNodeDataPacket66{</span>
<span class="term-fg31">-		RequestId:         123,</span>
<span class="term-fg31">-		GetNodeDataPacket: hashes,</span>
<span class="term-fg31">-	})</span>
<span class="term-fg31">-	msg, err := peer.app.ReadMsg()</span>
<span class="term-fg31">-	if !drop {</span>
<span class="term-fg31">-		if err != nil {</span>
<span class="term-fg31">-			t.Fatalf(&quot;failed to read node data response: %v&quot;, err)</span>
<span class="term-fg31">-		}</span>
<span class="term-fg31">-	} else {</span>
<span class="term-fg31">-		if err != nil {</span>
<span class="term-fg31">-			return</span>
<span class="term-fg31">-		}</span>
<span class="term-fg31">-		t.Fatalf(&quot;succeeded to read node data response on non-supporting protocol: %v&quot;, msg)</span>
<span class="term-fg31">-	}</span>
<span class="term-fg31">-	if msg.Code != NodeDataMsg {</span>
<span class="term-fg31">-		t.Fatalf(&quot;response packet code mismatch: have %x, want %x&quot;, msg.Code, NodeDataMsg)</span>
<span class="term-fg31">-	}</span>
<span class="term-fg31">-	var res NodeDataPacket66</span>
<span class="term-fg31">-	if err := msg.Decode(&amp;res); err != nil {</span>
<span class="term-fg31">-		t.Fatalf(&quot;failed to decode response node data: %v&quot;, err)</span>
<span class="term-fg31">-	}</span>
<span class="term-fg31">-</span>
<span class="term-fg31">-	&#47;&#47; Verify that all hashes correspond to the requested data.</span>
<span class="term-fg31">-	data := res.NodeDataPacket</span>
<span class="term-fg31">-	for i, want := range hashes {</span>
<span class="term-fg31">-		if hash := crypto.Keccak256Hash(data[i]); hash != want {</span>
<span class="term-fg31">-			t.Errorf(&quot;data hash mismatch: have %x, want %x&quot;, hash, want)</span>
<span class="term-fg31">-		}</span>
<span class="term-fg31">-	}</span>
<span class="term-fg31">-</span>
<span class="term-fg31">-	&#47;&#47; Reconstruct state tree from the received data.</span>
<span class="term-fg31">-	reconstructDB := rawdb.NewMemoryDatabase()</span>
<span class="term-fg31">-	for i := 0; i &lt; len(data); i++ {</span>
<span class="term-fg31">-		rawdb.WriteLegacyTrieNode(reconstructDB, hashes[i], data[i])</span>
<span class="term-fg31">-	}</span>
<span class="term-fg31">-</span>
<span class="term-fg31">-	&#47;&#47; Sanity check whether all state matches.</span>
<span class="term-fg31">-	accounts := []common.Address{testAddr, acc1Addr, acc2Addr}</span>
<span class="term-fg31">-	for i := uint64(0); i &lt;= backend.chain.CurrentBlock().Number.Uint64(); i++ {</span>
<span class="term-fg31">-		root := backend.chain.GetBlockByNumber(i).Root()</span>
<span class="term-fg31">-		reconstructed, _ := state.New(root, state.NewDatabase(reconstructDB), nil)</span>
<span class="term-fg31">-		for j, acc := range accounts {</span>
<span class="term-fg31">-			state, _ := backend.chain.StateAt(root)</span>
<span class="term-fg31">-			bw := state.GetBalance(acc)</span>
<span class="term-fg31">-			bh := reconstructed.GetBalance(acc)</span>
<span class="term-fg31">-</span>
<span class="term-fg31">-			if (bw == nil) != (bh == nil) {</span>
<span class="term-fg31">-				t.Errorf(&quot;block %d, account %d: balance mismatch: have %v, want %v&quot;, i, j, bh, bw)</span>
<span class="term-fg31">-			}</span>
<span class="term-fg31">-			if bw != nil &amp;&amp; bh != nil &amp;&amp; bw.Cmp(bh) != 0 {</span>
<span class="term-fg31">-				t.Errorf(&quot;block %d, account %d: balance mismatch: have %v, want %v&quot;, i, j, bh, bw)</span>
<span class="term-fg31">-			}</span>
<span class="term-fg31">-		}</span>
<span class="term-fg31">-	}</span>
<span class="term-fg31">-}</span>
<span class="term-fg31">-</span>
 &#47;&#47; Tests that the transaction receipts can be retrieved based on hashes.
<span class="term-fg31">-func TestGetBlockReceipts66(t *testing.T) { testGetBlockReceipts(t, ETH66) }</span>
 func TestGetBlockReceipts67(t *testing.T) { testGetBlockReceipts(t, ETH67) }
 func TestGetBlockReceipts68(t *testing.T) { testGetBlockReceipts(t, ETH68) }
&nbsp;
<span class="term-fg36">@@ -613,13 +491,13 @@</span> 		hashes = append(hashes, block.Hash())
 		receipts = append(receipts, backend.chain.GetReceiptsByHash(block.Hash()))
 	}
 	&#47;&#47; Send the hash request and verify the response
<span class="term-fg31">-	p2p.Send(peer.app, GetReceiptsMsg, &amp;GetReceiptsPacket66{</span>
<span class="term-fg31">-		RequestId:         123,</span>
<span class="term-fg31">-		GetReceiptsPacket: hashes,</span>
<span class="term-fg32">+	p2p.Send(peer.app, GetReceiptsMsg, &amp;GetReceiptsPacket{</span>
<span class="term-fg32">+		RequestId:          123,</span>
<span class="term-fg32">+		GetReceiptsRequest: hashes,</span>
 	})
<span class="term-fg31">-	if err := p2p.ExpectMsg(peer.app, ReceiptsMsg, &amp;ReceiptsPacket66{</span>
<span class="term-fg31">-		RequestId:      123,</span>
<span class="term-fg31">-		ReceiptsPacket: receipts,</span>
<span class="term-fg32">+	if err := p2p.ExpectMsg(peer.app, ReceiptsMsg, &amp;ReceiptsPacket{</span>
<span class="term-fg32">+		RequestId:        123,</span>
<span class="term-fg32">+		ReceiptsResponse: receipts,</span>
 	}); err != nil {
 		t.Errorf(&quot;receipts mismatch: %v&quot;, err)
 	}</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-738edca8a32961bc0d936bc3" role="button"
                   aria-expanded="false" aria-controls="id-738edca8a32961bc0d936bc3">
                    <code>eth/protocols/eth/handlers.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/3f40e65c484486dea6cff80b7db178985d21a2c6/eth/protocols/eth/handlers.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/650bb2f2b1dcfe30d9b1fa6f7dc9608055ed60e1/eth/protocols/eth/handlers.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+41</span></div>
                        <div class="text-start"><span class="text-danger">-97</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-738edca8a32961bc0d936bc3"><span class="term-fg1">diff --git go-ethereum&#47;eth&#47;protocols&#47;eth&#47;handlers.go op-geth&#47;eth&#47;protocols&#47;eth&#47;handlers.go</span>
<span class="term-fg1">index da741791bc1c39c102fb26e5dd070a86b244e652..069e92dadf90f1c64a26846620b4682271390aec 100644</span>
<span class="term-fg1">--- go-ethereum&#47;eth&#47;protocols&#47;eth&#47;handlers.go</span>
<span class="term-fg1">+++ op-geth&#47;eth&#47;protocols&#47;eth&#47;handlers.go</span>
<span class="term-fg36">@@ -22,27 +22,25 @@</span> 	&quot;fmt&quot;
&nbsp;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;common&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;core&quot;
<span class="term-fg31">-	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;core&#47;rawdb&quot;</span>
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;core&#47;types&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;log&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;rlp&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;trie&quot;
 )
&nbsp;
<span class="term-fg31">-&#47;&#47; handleGetBlockHeaders66 is the eth&#47;66 version of handleGetBlockHeaders</span>
<span class="term-fg31">-func handleGetBlockHeaders66(backend Backend, msg Decoder, peer *Peer) error {</span>
<span class="term-fg32">+func handleGetBlockHeaders(backend Backend, msg Decoder, peer *Peer) error {</span>
 	&#47;&#47; Decode the complex header query
<span class="term-fg31">-	var query GetBlockHeadersPacket66</span>
<span class="term-fg32">+	var query GetBlockHeadersPacket</span>
 	if err := msg.Decode(&amp;query); err != nil {
 		return fmt.Errorf(&quot;%w: message %v: %v&quot;, errDecode, msg, err)
 	}
<span class="term-fg31">-	response := ServiceGetBlockHeadersQuery(backend.Chain(), query.GetBlockHeadersPacket, peer)</span>
<span class="term-fg32">+	response := ServiceGetBlockHeadersQuery(backend.Chain(), query.GetBlockHeadersRequest, peer)</span>
 	return peer.ReplyBlockHeadersRLP(query.RequestId, response)
 }
&nbsp;
 &#47;&#47; ServiceGetBlockHeadersQuery assembles the response to a header query. It is
 &#47;&#47; exposed to allow external packages to test protocol behavior.
<span class="term-fg31">-func ServiceGetBlockHeadersQuery(chain *core.BlockChain, query *GetBlockHeadersPacket, peer *Peer) []rlp.RawValue {</span>
<span class="term-fg32">+func ServiceGetBlockHeadersQuery(chain *core.BlockChain, query *GetBlockHeadersRequest, peer *Peer) []rlp.RawValue {</span>
 	if query.Skip == 0 {
 		&#47;&#47; The fast path: when the request is for a contiguous segment of headers.
 		return serviceContiguousBlockHeaderQuery(chain, query)
<span class="term-fg36">@@ -51,7 +49,7 @@</span> 		return serviceNonContiguousBlockHeaderQuery(chain, query, peer)
 	}
 }
&nbsp;
<span class="term-fg31">-func serviceNonContiguousBlockHeaderQuery(chain *core.BlockChain, query *GetBlockHeadersPacket, peer *Peer) []rlp.RawValue {</span>
<span class="term-fg32">+func serviceNonContiguousBlockHeaderQuery(chain *core.BlockChain, query *GetBlockHeadersRequest, peer *Peer) []rlp.RawValue {</span>
 	hashMode := query.Origin.Hash != (common.Hash{})
 	first := true
 	maxNonCanonical := uint64(100)
<span class="term-fg36">@@ -140,7 +138,7 @@</span> 	}
 	return headers
 }
&nbsp;
<span class="term-fg31">-func serviceContiguousBlockHeaderQuery(chain *core.BlockChain, query *GetBlockHeadersPacket) []rlp.RawValue {</span>
<span class="term-fg32">+func serviceContiguousBlockHeaderQuery(chain *core.BlockChain, query *GetBlockHeadersRequest) []rlp.RawValue {</span>
 	count := query.Amount
 	if count &gt; maxHeadersServe {
 		count = maxHeadersServe
<span class="term-fg36">@@ -203,19 +201,19 @@</span> 		return headers
 	}
 }
&nbsp;
<span class="term-fg31">-func handleGetBlockBodies66(backend Backend, msg Decoder, peer *Peer) error {</span>
<span class="term-fg32">+func handleGetBlockBodies(backend Backend, msg Decoder, peer *Peer) error {</span>
 	&#47;&#47; Decode the block body retrieval message
<span class="term-fg31">-	var query GetBlockBodiesPacket66</span>
<span class="term-fg32">+	var query GetBlockBodiesPacket</span>
 	if err := msg.Decode(&amp;query); err != nil {
 		return fmt.Errorf(&quot;%w: message %v: %v&quot;, errDecode, msg, err)
 	}
<span class="term-fg31">-	response := ServiceGetBlockBodiesQuery(backend.Chain(), query.GetBlockBodiesPacket)</span>
<span class="term-fg32">+	response := ServiceGetBlockBodiesQuery(backend.Chain(), query.GetBlockBodiesRequest)</span>
 	return peer.ReplyBlockBodiesRLP(query.RequestId, response)
 }
&nbsp;
 &#47;&#47; ServiceGetBlockBodiesQuery assembles the response to a body query. It is
 &#47;&#47; exposed to allow external packages to test protocol behavior.
<span class="term-fg31">-func ServiceGetBlockBodiesQuery(chain *core.BlockChain, query GetBlockBodiesPacket) []rlp.RawValue {</span>
<span class="term-fg32">+func ServiceGetBlockBodiesQuery(chain *core.BlockChain, query GetBlockBodiesRequest) []rlp.RawValue {</span>
 	&#47;&#47; Gather blocks until the fetch or network limits is reached
 	var (
 		bytes  int
<span class="term-fg36">@@ -234,60 +232,19 @@</span> 	}
 	return bodies
 }
&nbsp;
<span class="term-fg31">-func handleGetNodeData66(backend Backend, msg Decoder, peer *Peer) error {</span>
<span class="term-fg31">-	&#47;&#47; Decode the trie node data retrieval message</span>
<span class="term-fg31">-	var query GetNodeDataPacket66</span>
<span class="term-fg31">-	if err := msg.Decode(&amp;query); err != nil {</span>
<span class="term-fg31">-		return fmt.Errorf(&quot;%w: message %v: %v&quot;, errDecode, msg, err)</span>
<span class="term-fg31">-	}</span>
<span class="term-fg31">-	response := ServiceGetNodeDataQuery(backend.Chain(), query.GetNodeDataPacket)</span>
<span class="term-fg31">-	return peer.ReplyNodeData(query.RequestId, response)</span>
<span class="term-fg31">-}</span>
<span class="term-fg31">-</span>
<span class="term-fg31">-&#47;&#47; ServiceGetNodeDataQuery assembles the response to a node data query. It is</span>
<span class="term-fg31">-&#47;&#47; exposed to allow external packages to test protocol behavior.</span>
<span class="term-fg31">-func ServiceGetNodeDataQuery(chain *core.BlockChain, query GetNodeDataPacket) [][]byte {</span>
<span class="term-fg31">-	&#47;&#47; Request nodes by hash is not supported in path-based scheme.</span>
<span class="term-fg31">-	if chain.TrieDB().Scheme() == rawdb.PathScheme {</span>
<span class="term-fg31">-		return nil</span>
<span class="term-fg31">-	}</span>
<span class="term-fg31">-	&#47;&#47; Gather state data until the fetch or network limits is reached</span>
<span class="term-fg31">-	var (</span>
<span class="term-fg31">-		bytes int</span>
<span class="term-fg31">-		nodes [][]byte</span>
<span class="term-fg31">-	)</span>
<span class="term-fg31">-	for lookups, hash := range query {</span>
<span class="term-fg31">-		if bytes &gt;= softResponseLimit || len(nodes) &gt;= maxNodeDataServe ||</span>
<span class="term-fg31">-			lookups &gt;= 2*maxNodeDataServe {</span>
<span class="term-fg31">-			break</span>
<span class="term-fg31">-		}</span>
<span class="term-fg31">-		&#47;&#47; Retrieve the requested state entry</span>
<span class="term-fg31">-		entry, err := chain.TrieDB().Node(hash)</span>
<span class="term-fg31">-		if len(entry) == 0 || err != nil {</span>
<span class="term-fg31">-			&#47;&#47; Read the contract code with prefix only to save unnecessary lookups.</span>
<span class="term-fg31">-			entry, err = chain.ContractCodeWithPrefix(hash)</span>
<span class="term-fg31">-		}</span>
<span class="term-fg31">-		if err == nil &amp;&amp; len(entry) &gt; 0 {</span>
<span class="term-fg31">-			nodes = append(nodes, entry)</span>
<span class="term-fg31">-			bytes += len(entry)</span>
<span class="term-fg31">-		}</span>
<span class="term-fg31">-	}</span>
<span class="term-fg31">-	return nodes</span>
<span class="term-fg31">-}</span>
<span class="term-fg31">-</span>
<span class="term-fg31">-func handleGetReceipts66(backend Backend, msg Decoder, peer *Peer) error {</span>
<span class="term-fg32">+func handleGetReceipts(backend Backend, msg Decoder, peer *Peer) error {</span>
 	&#47;&#47; Decode the block receipts retrieval message
<span class="term-fg31">-	var query GetReceiptsPacket66</span>
<span class="term-fg32">+	var query GetReceiptsPacket</span>
 	if err := msg.Decode(&amp;query); err != nil {
 		return fmt.Errorf(&quot;%w: message %v: %v&quot;, errDecode, msg, err)
 	}
<span class="term-fg31">-	response := ServiceGetReceiptsQuery(backend.Chain(), query.GetReceiptsPacket)</span>
<span class="term-fg32">+	response := ServiceGetReceiptsQuery(backend.Chain(), query.GetReceiptsRequest)</span>
 	return peer.ReplyReceiptsRLP(query.RequestId, response)
 }
&nbsp;
 &#47;&#47; ServiceGetReceiptsQuery assembles the response to a receipt query. It is
 &#47;&#47; exposed to allow external packages to test protocol behavior.
<span class="term-fg31">-func ServiceGetReceiptsQuery(chain *core.BlockChain, query GetReceiptsPacket) []rlp.RawValue {</span>
<span class="term-fg32">+func ServiceGetReceiptsQuery(chain *core.BlockChain, query GetReceiptsRequest) []rlp.RawValue {</span>
 	&#47;&#47; Gather state data until the fetch or network limits is reached
 	var (
 		bytes    int
<span class="term-fg36">@@ -356,15 +313,15 @@</span>
 	return backend.Handle(peer, ann)
 }
&nbsp;
<span class="term-fg31">-func handleBlockHeaders66(backend Backend, msg Decoder, peer *Peer) error {</span>
<span class="term-fg32">+func handleBlockHeaders(backend Backend, msg Decoder, peer *Peer) error {</span>
 	&#47;&#47; A batch of headers arrived to one of our previous requests
<span class="term-fg31">-	res := new(BlockHeadersPacket66)</span>
<span class="term-fg32">+	res := new(BlockHeadersPacket)</span>
 	if err := msg.Decode(res); err != nil {
 		return fmt.Errorf(&quot;%w: message %v: %v&quot;, errDecode, msg, err)
 	}
 	metadata := func() interface{} {
<span class="term-fg31">-		hashes := make([]common.Hash, len(res.BlockHeadersPacket))</span>
<span class="term-fg31">-		for i, header := range res.BlockHeadersPacket {</span>
<span class="term-fg32">+		hashes := make([]common.Hash, len(res.BlockHeadersRequest))</span>
<span class="term-fg32">+		for i, header := range res.BlockHeadersRequest {</span>
 			hashes[i] = header.Hash()
 		}
 		return hashes
<span class="term-fg36">@@ -372,24 +329,24 @@</span> 	}
 	return peer.dispatchResponse(&amp;Response{
 		id:   res.RequestId,
 		code: BlockHeadersMsg,
<span class="term-fg31">-		Res:  &amp;res.BlockHeadersPacket,</span>
<span class="term-fg32">+		Res:  &amp;res.BlockHeadersRequest,</span>
 	}, metadata)
 }
&nbsp;
<span class="term-fg31">-func handleBlockBodies66(backend Backend, msg Decoder, peer *Peer) error {</span>
<span class="term-fg32">+func handleBlockBodies(backend Backend, msg Decoder, peer *Peer) error {</span>
 	&#47;&#47; A batch of block bodies arrived to one of our previous requests
<span class="term-fg31">-	res := new(BlockBodiesPacket66)</span>
<span class="term-fg32">+	res := new(BlockBodiesPacket)</span>
 	if err := msg.Decode(res); err != nil {
 		return fmt.Errorf(&quot;%w: message %v: %v&quot;, errDecode, msg, err)
 	}
 	metadata := func() interface{} {
 		var (
<span class="term-fg31">-			txsHashes        = make([]common.Hash, len(res.BlockBodiesPacket))</span>
<span class="term-fg31">-			uncleHashes      = make([]common.Hash, len(res.BlockBodiesPacket))</span>
<span class="term-fg31">-			withdrawalHashes = make([]common.Hash, len(res.BlockBodiesPacket))</span>
<span class="term-fg32">+			txsHashes        = make([]common.Hash, len(res.BlockBodiesResponse))</span>
<span class="term-fg32">+			uncleHashes      = make([]common.Hash, len(res.BlockBodiesResponse))</span>
<span class="term-fg32">+			withdrawalHashes = make([]common.Hash, len(res.BlockBodiesResponse))</span>
 		)
 		hasher := trie.NewStackTrie(nil)
<span class="term-fg31">-		for i, body := range res.BlockBodiesPacket {</span>
<span class="term-fg32">+		for i, body := range res.BlockBodiesResponse {</span>
 			txsHashes[i] = types.DeriveSha(types.Transactions(body.Transactions), hasher)
 			uncleHashes[i] = types.CalcUncleHash(body.Uncles)
 			if body.Withdrawals != nil {
<span class="term-fg36">@@ -401,33 +358,20 @@</span> 	}
 	return peer.dispatchResponse(&amp;Response{
 		id:   res.RequestId,
 		code: BlockBodiesMsg,
<span class="term-fg31">-		Res:  &amp;res.BlockBodiesPacket,</span>
<span class="term-fg32">+		Res:  &amp;res.BlockBodiesResponse,</span>
 	}, metadata)
 }
&nbsp;
<span class="term-fg31">-func handleNodeData66(backend Backend, msg Decoder, peer *Peer) error {</span>
<span class="term-fg31">-	&#47;&#47; A batch of node state data arrived to one of our previous requests</span>
<span class="term-fg31">-	res := new(NodeDataPacket66)</span>
<span class="term-fg31">-	if err := msg.Decode(res); err != nil {</span>
<span class="term-fg31">-		return fmt.Errorf(&quot;%w: message %v: %v&quot;, errDecode, msg, err)</span>
<span class="term-fg31">-	}</span>
<span class="term-fg31">-	return peer.dispatchResponse(&amp;Response{</span>
<span class="term-fg31">-		id:   res.RequestId,</span>
<span class="term-fg31">-		code: NodeDataMsg,</span>
<span class="term-fg31">-		Res:  &amp;res.NodeDataPacket,</span>
<span class="term-fg31">-	}, nil) &#47;&#47; No post-processing, we&#39;re not using this packet anymore</span>
<span class="term-fg31">-}</span>
<span class="term-fg31">-</span>
<span class="term-fg31">-func handleReceipts66(backend Backend, msg Decoder, peer *Peer) error {</span>
<span class="term-fg32">+func handleReceipts(backend Backend, msg Decoder, peer *Peer) error {</span>
 	&#47;&#47; A batch of receipts arrived to one of our previous requests
<span class="term-fg31">-	res := new(ReceiptsPacket66)</span>
<span class="term-fg32">+	res := new(ReceiptsPacket)</span>
 	if err := msg.Decode(res); err != nil {
 		return fmt.Errorf(&quot;%w: message %v: %v&quot;, errDecode, msg, err)
 	}
 	metadata := func() interface{} {
 		hasher := trie.NewStackTrie(nil)
<span class="term-fg31">-		hashes := make([]common.Hash, len(res.ReceiptsPacket))</span>
<span class="term-fg31">-		for i, receipt := range res.ReceiptsPacket {</span>
<span class="term-fg32">+		hashes := make([]common.Hash, len(res.ReceiptsResponse))</span>
<span class="term-fg32">+		for i, receipt := range res.ReceiptsResponse {</span>
 			hashes[i] = types.DeriveSha(types.Receipts(receipt), hasher)
 		}
 		return hashes
<span class="term-fg36">@@ -435,17 +379,17 @@</span> 	}
 	return peer.dispatchResponse(&amp;Response{
 		id:   res.RequestId,
 		code: ReceiptsMsg,
<span class="term-fg31">-		Res:  &amp;res.ReceiptsPacket,</span>
<span class="term-fg32">+		Res:  &amp;res.ReceiptsResponse,</span>
 	}, metadata)
 }
&nbsp;
<span class="term-fg31">-func handleNewPooledTransactionHashes66(backend Backend, msg Decoder, peer *Peer) error {</span>
<span class="term-fg32">+func handleNewPooledTransactionHashes67(backend Backend, msg Decoder, peer *Peer) error {</span>
 	&#47;&#47; New transaction announcement arrived, make sure we have
 	&#47;&#47; a valid and fresh chain to handle them
 	if !backend.AcceptTxs() {
 		return nil
 	}
<span class="term-fg31">-	ann := new(NewPooledTransactionHashesPacket66)</span>
<span class="term-fg32">+	ann := new(NewPooledTransactionHashesPacket67)</span>
 	if err := msg.Decode(ann); err != nil {
 		return fmt.Errorf(&quot;%w: message %v: %v&quot;, errDecode, msg, err)
 	}
<span class="term-fg36">@@ -476,17 +420,17 @@</span> 	}
 	return backend.Handle(peer, ann)
 }
&nbsp;
<span class="term-fg31">-func handleGetPooledTransactions66(backend Backend, msg Decoder, peer *Peer) error {</span>
<span class="term-fg32">+func handleGetPooledTransactions(backend Backend, msg Decoder, peer *Peer) error {</span>
 	&#47;&#47; Decode the pooled transactions retrieval message
<span class="term-fg31">-	var query GetPooledTransactionsPacket66</span>
<span class="term-fg32">+	var query GetPooledTransactionsPacket</span>
 	if err := msg.Decode(&amp;query); err != nil {
 		return fmt.Errorf(&quot;%w: message %v: %v&quot;, errDecode, msg, err)
 	}
<span class="term-fg31">-	hashes, txs := answerGetPooledTransactions(backend, query.GetPooledTransactionsPacket, peer)</span>
<span class="term-fg32">+	hashes, txs := answerGetPooledTransactions(backend, query.GetPooledTransactionsRequest)</span>
 	return peer.ReplyPooledTransactionsRLP(query.RequestId, hashes, txs)
 }
&nbsp;
<span class="term-fg31">-func answerGetPooledTransactions(backend Backend, query GetPooledTransactionsPacket, peer *Peer) ([]common.Hash, []rlp.RawValue) {</span>
<span class="term-fg32">+func answerGetPooledTransactions(backend Backend, query GetPooledTransactionsRequest) ([]common.Hash, []rlp.RawValue) {</span>
 	&#47;&#47; Gather transactions until the fetch or network limits is reached
 	var (
 		bytes  int
<span class="term-fg36">@@ -534,17 +478,17 @@</span> 	}
 	return backend.Handle(peer, &amp;txs)
 }
&nbsp;
<span class="term-fg31">-func handlePooledTransactions66(backend Backend, msg Decoder, peer *Peer) error {</span>
<span class="term-fg32">+func handlePooledTransactions(backend Backend, msg Decoder, peer *Peer) error {</span>
 	&#47;&#47; Transactions arrived, make sure we have a valid and fresh chain to handle them
 	if !backend.AcceptTxs() {
 		return nil
 	}
 	&#47;&#47; Transactions can be processed, parse all of them and deliver to the pool
<span class="term-fg31">-	var txs PooledTransactionsPacket66</span>
<span class="term-fg32">+	var txs PooledTransactionsPacket</span>
 	if err := msg.Decode(&amp;txs); err != nil {
 		return fmt.Errorf(&quot;%w: message %v: %v&quot;, errDecode, msg, err)
 	}
<span class="term-fg31">-	for i, tx := range txs.PooledTransactionsPacket {</span>
<span class="term-fg32">+	for i, tx := range txs.PooledTransactionsResponse {</span>
 		&#47;&#47; Validate and mark the remote transaction
 		if tx == nil {
 			return fmt.Errorf(&quot;%w: transaction %d is nil&quot;, errDecode, i)
<span class="term-fg36">@@ -553,5 +497,5 @@</span> 		peer.markTransaction(tx.Hash())
 	}
 	requestTracker.Fulfil(peer.id, peer.version, PooledTransactionsMsg, txs.RequestId)
&nbsp;
<span class="term-fg31">-	return backend.Handle(peer, &amp;txs.PooledTransactionsPacket)</span>
<span class="term-fg32">+	return backend.Handle(peer, &amp;txs.PooledTransactionsResponse)</span>
 }</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-91012469aa1a886c5cf469ff" role="button"
                   aria-expanded="false" aria-controls="id-91012469aa1a886c5cf469ff">
                    <code>eth/protocols/eth/handshake_test.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/3f40e65c484486dea6cff80b7db178985d21a2c6/eth/protocols/eth/handshake_test.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/650bb2f2b1dcfe30d9b1fa6f7dc9608055ed60e1/eth/protocols/eth/handshake_test.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+2</span></div>
                        <div class="text-start"><span class="text-danger">-1</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-91012469aa1a886c5cf469ff"><span class="term-fg1">diff --git go-ethereum&#47;eth&#47;protocols&#47;eth&#47;handshake_test.go op-geth&#47;eth&#47;protocols&#47;eth&#47;handshake_test.go</span>
<span class="term-fg1">index dca66e0c57733cbdf6f50110ed59f754ea331e60..d96cfc8165b5075d1a1b16c36a9e574197683067 100644</span>
<span class="term-fg1">--- go-ethereum&#47;eth&#47;protocols&#47;eth&#47;handshake_test.go</span>
<span class="term-fg1">+++ op-geth&#47;eth&#47;protocols&#47;eth&#47;handshake_test.go</span>
<span class="term-fg36">@@ -27,7 +27,8 @@</span> 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;p2p&#47;enode&quot;
 )
&nbsp;
 &#47;&#47; Tests that handshake failures are detected and reported correctly.
<span class="term-fg31">-func TestHandshake66(t *testing.T) { testHandshake(t, ETH66) }</span>
<span class="term-fg32">+func TestHandshake67(t *testing.T) { testHandshake(t, ETH67) }</span>
<span class="term-fg32">+func TestHandshake68(t *testing.T) { testHandshake(t, ETH68) }</span>
&nbsp;
 func testHandshake(t *testing.T, protocol uint) {
 	t.Parallel()</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-bc77a147b2d6367febb7694e" role="button"
                   aria-expanded="false" aria-controls="id-bc77a147b2d6367febb7694e">
                    <code>eth/protocols/eth/peer.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/3f40e65c484486dea6cff80b7db178985d21a2c6/eth/protocols/eth/peer.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/650bb2f2b1dcfe30d9b1fa6f7dc9608055ed60e1/eth/protocols/eth/peer.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+34</span></div>
                        <div class="text-start"><span class="text-danger">-64</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-bc77a147b2d6367febb7694e"><span class="term-fg1">diff --git go-ethereum&#47;eth&#47;protocols&#47;eth&#47;peer.go op-geth&#47;eth&#47;protocols&#47;eth&#47;peer.go</span>
<span class="term-fg1">index 219f486c8e6f2df2ab321042d48be02dfce090cf..938af0cab0df294ec354883a4daab515c6051de7 100644</span>
<span class="term-fg1">--- go-ethereum&#47;eth&#47;protocols&#47;eth&#47;peer.go</span>
<span class="term-fg1">+++ op-geth&#47;eth&#47;protocols&#47;eth&#47;peer.go</span>
<span class="term-fg36">@@ -219,7 +219,7 @@</span> &#47;&#47; not be managed directly.
 func (p *Peer) sendPooledTransactionHashes66(hashes []common.Hash) error {
 	&#47;&#47; Mark all the transactions as known, but ensure we don&#39;t overflow our limits
 	p.knownTxs.Add(hashes...)
<span class="term-fg31">-	return p2p.Send(p.rw, NewPooledTransactionHashesMsg, NewPooledTransactionHashesPacket66(hashes))</span>
<span class="term-fg32">+	return p2p.Send(p.rw, NewPooledTransactionHashesMsg, NewPooledTransactionHashesPacket67(hashes))</span>
 }
&nbsp;
 &#47;&#47; sendPooledTransactionHashes68 sends transaction hashes (tagged with their type
<span class="term-fg36">@@ -248,15 +248,15 @@</span> 		p.Log().Debug(&quot;Dropping transaction announcement&quot;, &quot;count&quot;, len(hashes))
 	}
 }
&nbsp;
<span class="term-fg31">-&#47;&#47; ReplyPooledTransactionsRLP is the eth&#47;66 version of SendPooledTransactionsRLP.</span>
<span class="term-fg32">+&#47;&#47; ReplyPooledTransactionsRLP is the response to RequestTxs.</span>
 func (p *Peer) ReplyPooledTransactionsRLP(id uint64, hashes []common.Hash, txs []rlp.RawValue) error {
 	&#47;&#47; Mark all the transactions as known, but ensure we don&#39;t overflow our limits
 	p.knownTxs.Add(hashes...)
&nbsp;
<span class="term-fg31">-	&#47;&#47; Not packed into PooledTransactionsPacket to avoid RLP decoding</span>
<span class="term-fg31">-	return p2p.Send(p.rw, PooledTransactionsMsg, &amp;PooledTransactionsRLPPacket66{</span>
<span class="term-fg31">-		RequestId:                   id,</span>
<span class="term-fg31">-		PooledTransactionsRLPPacket: txs,</span>
<span class="term-fg32">+	&#47;&#47; Not packed into PooledTransactionsResponse to avoid RLP decoding</span>
<span class="term-fg32">+	return p2p.Send(p.rw, PooledTransactionsMsg, &amp;PooledTransactionsRLPPacket{</span>
<span class="term-fg32">+		RequestId:                     id,</span>
<span class="term-fg32">+		PooledTransactionsRLPResponse: txs,</span>
 	})
 }
&nbsp;
<span class="term-fg36">@@ -309,36 +309,28 @@</span> 		p.Log().Debug(&quot;Dropping block propagation&quot;, &quot;number&quot;, block.NumberU64(), &quot;hash&quot;, block.Hash())
 	}
 }
&nbsp;
<span class="term-fg31">-&#47;&#47; ReplyBlockHeadersRLP is the eth&#47;66 response to GetBlockHeaders.</span>
<span class="term-fg32">+&#47;&#47; ReplyBlockHeadersRLP is the response to GetBlockHeaders.</span>
 func (p *Peer) ReplyBlockHeadersRLP(id uint64, headers []rlp.RawValue) error {
<span class="term-fg31">-	return p2p.Send(p.rw, BlockHeadersMsg, &amp;BlockHeadersRLPPacket66{</span>
<span class="term-fg31">-		RequestId:             id,</span>
<span class="term-fg31">-		BlockHeadersRLPPacket: headers,</span>
<span class="term-fg32">+	return p2p.Send(p.rw, BlockHeadersMsg, &amp;BlockHeadersRLPPacket{</span>
<span class="term-fg32">+		RequestId:               id,</span>
<span class="term-fg32">+		BlockHeadersRLPResponse: headers,</span>
 	})
 }
&nbsp;
<span class="term-fg31">-&#47;&#47; ReplyBlockBodiesRLP is the eth&#47;66 response to GetBlockBodies.</span>
<span class="term-fg32">+&#47;&#47; ReplyBlockBodiesRLP is the response to GetBlockBodies.</span>
 func (p *Peer) ReplyBlockBodiesRLP(id uint64, bodies []rlp.RawValue) error {
<span class="term-fg31">-	&#47;&#47; Not packed into BlockBodiesPacket to avoid RLP decoding</span>
<span class="term-fg31">-	return p2p.Send(p.rw, BlockBodiesMsg, &amp;BlockBodiesRLPPacket66{</span>
<span class="term-fg31">-		RequestId:            id,</span>
<span class="term-fg31">-		BlockBodiesRLPPacket: bodies,</span>
<span class="term-fg31">-	})</span>
<span class="term-fg31">-}</span>
<span class="term-fg31">-</span>
<span class="term-fg31">-&#47;&#47; ReplyNodeData is the eth&#47;66 response to GetNodeData.</span>
<span class="term-fg31">-func (p *Peer) ReplyNodeData(id uint64, data [][]byte) error {</span>
<span class="term-fg31">-	return p2p.Send(p.rw, NodeDataMsg, &amp;NodeDataPacket66{</span>
<span class="term-fg31">-		RequestId:      id,</span>
<span class="term-fg31">-		NodeDataPacket: data,</span>
<span class="term-fg32">+	&#47;&#47; Not packed into BlockBodiesResponse to avoid RLP decoding</span>
<span class="term-fg32">+	return p2p.Send(p.rw, BlockBodiesMsg, &amp;BlockBodiesRLPPacket{</span>
<span class="term-fg32">+		RequestId:              id,</span>
<span class="term-fg32">+		BlockBodiesRLPResponse: bodies,</span>
 	})
 }
&nbsp;
<span class="term-fg31">-&#47;&#47; ReplyReceiptsRLP is the eth&#47;66 response to GetReceipts.</span>
<span class="term-fg32">+&#47;&#47; ReplyReceiptsRLP is the response to GetReceipts.</span>
 func (p *Peer) ReplyReceiptsRLP(id uint64, receipts []rlp.RawValue) error {
<span class="term-fg31">-	return p2p.Send(p.rw, ReceiptsMsg, &amp;ReceiptsRLPPacket66{</span>
<span class="term-fg31">-		RequestId:         id,</span>
<span class="term-fg31">-		ReceiptsRLPPacket: receipts,</span>
<span class="term-fg32">+	return p2p.Send(p.rw, ReceiptsMsg, &amp;ReceiptsRLPPacket{</span>
<span class="term-fg32">+		RequestId:           id,</span>
<span class="term-fg32">+		ReceiptsRLPResponse: receipts,</span>
 	})
 }
&nbsp;
<span class="term-fg36">@@ -353,9 +345,9 @@</span> 		id:   id,
 		sink: sink,
 		code: GetBlockHeadersMsg,
 		want: BlockHeadersMsg,
<span class="term-fg31">-		data: &amp;GetBlockHeadersPacket66{</span>
<span class="term-fg32">+		data: &amp;GetBlockHeadersPacket{</span>
 			RequestId: id,
<span class="term-fg31">-			GetBlockHeadersPacket: &amp;GetBlockHeadersPacket{</span>
<span class="term-fg32">+			GetBlockHeadersRequest: &amp;GetBlockHeadersRequest{</span>
 				Origin:  HashOrNumber{Hash: hash},
 				Amount:  uint64(1),
 				Skip:    uint64(0),
<span class="term-fg36">@@ -380,9 +372,9 @@</span> 		id:   id,
 		sink: sink,
 		code: GetBlockHeadersMsg,
 		want: BlockHeadersMsg,
<span class="term-fg31">-		data: &amp;GetBlockHeadersPacket66{</span>
<span class="term-fg32">+		data: &amp;GetBlockHeadersPacket{</span>
 			RequestId: id,
<span class="term-fg31">-			GetBlockHeadersPacket: &amp;GetBlockHeadersPacket{</span>
<span class="term-fg32">+			GetBlockHeadersRequest: &amp;GetBlockHeadersRequest{</span>
 				Origin:  HashOrNumber{Hash: origin},
 				Amount:  uint64(amount),
 				Skip:    uint64(skip),
<span class="term-fg36">@@ -407,9 +399,9 @@</span> 		id:   id,
 		sink: sink,
 		code: GetBlockHeadersMsg,
 		want: BlockHeadersMsg,
<span class="term-fg31">-		data: &amp;GetBlockHeadersPacket66{</span>
<span class="term-fg32">+		data: &amp;GetBlockHeadersPacket{</span>
 			RequestId: id,
<span class="term-fg31">-			GetBlockHeadersPacket: &amp;GetBlockHeadersPacket{</span>
<span class="term-fg32">+			GetBlockHeadersRequest: &amp;GetBlockHeadersRequest{</span>
 				Origin:  HashOrNumber{Number: origin},
 				Amount:  uint64(amount),
 				Skip:    uint64(skip),
<span class="term-fg36">@@ -434,31 +426,9 @@</span> 		id:   id,
 		sink: sink,
 		code: GetBlockBodiesMsg,
 		want: BlockBodiesMsg,
<span class="term-fg31">-		data: &amp;GetBlockBodiesPacket66{</span>
<span class="term-fg31">-			RequestId:            id,</span>
<span class="term-fg31">-			GetBlockBodiesPacket: hashes,</span>
<span class="term-fg31">-		},</span>
<span class="term-fg31">-	}</span>
<span class="term-fg31">-	if err := p.dispatchRequest(req); err != nil {</span>
<span class="term-fg31">-		return nil, err</span>
<span class="term-fg31">-	}</span>
<span class="term-fg31">-	return req, nil</span>
<span class="term-fg31">-}</span>
<span class="term-fg31">-</span>
<span class="term-fg31">-&#47;&#47; RequestNodeData fetches a batch of arbitrary data from a node&#39;s known state</span>
<span class="term-fg31">-&#47;&#47; data, corresponding to the specified hashes.</span>
<span class="term-fg31">-func (p *Peer) RequestNodeData(hashes []common.Hash, sink chan *Response) (*Request, error) {</span>
<span class="term-fg31">-	p.Log().Debug(&quot;Fetching batch of state data&quot;, &quot;count&quot;, len(hashes))</span>
<span class="term-fg31">-	id := rand.Uint64()</span>
<span class="term-fg31">-</span>
<span class="term-fg31">-	req := &amp;Request{</span>
<span class="term-fg31">-		id:   id,</span>
<span class="term-fg31">-		sink: sink,</span>
<span class="term-fg31">-		code: GetNodeDataMsg,</span>
<span class="term-fg31">-		want: NodeDataMsg,</span>
<span class="term-fg31">-		data: &amp;GetNodeDataPacket66{</span>
<span class="term-fg31">-			RequestId:         id,</span>
<span class="term-fg31">-			GetNodeDataPacket: hashes,</span>
<span class="term-fg32">+		data: &amp;GetBlockBodiesPacket{</span>
<span class="term-fg32">+			RequestId:             id,</span>
<span class="term-fg32">+			GetBlockBodiesRequest: hashes,</span>
 		},
 	}
 	if err := p.dispatchRequest(req); err != nil {
<span class="term-fg36">@@ -477,9 +447,9 @@</span> 		id:   id,
 		sink: sink,
 		code: GetReceiptsMsg,
 		want: ReceiptsMsg,
<span class="term-fg31">-		data: &amp;GetReceiptsPacket66{</span>
<span class="term-fg31">-			RequestId:         id,</span>
<span class="term-fg31">-			GetReceiptsPacket: hashes,</span>
<span class="term-fg32">+		data: &amp;GetReceiptsPacket{</span>
<span class="term-fg32">+			RequestId:          id,</span>
<span class="term-fg32">+			GetReceiptsRequest: hashes,</span>
 		},
 	}
 	if err := p.dispatchRequest(req); err != nil {
<span class="term-fg36">@@ -494,9 +464,9 @@</span> 	p.Log().Debug(&quot;Fetching batch of transactions&quot;, &quot;count&quot;, len(hashes))
 	id := rand.Uint64()
&nbsp;
 	requestTracker.Track(p.id, p.version, GetPooledTransactionsMsg, PooledTransactionsMsg, id)
<span class="term-fg31">-	return p2p.Send(p.rw, GetPooledTransactionsMsg, &amp;GetPooledTransactionsPacket66{</span>
<span class="term-fg31">-		RequestId:                   id,</span>
<span class="term-fg31">-		GetPooledTransactionsPacket: hashes,</span>
<span class="term-fg32">+	return p2p.Send(p.rw, GetPooledTransactionsMsg, &amp;GetPooledTransactionsPacket{</span>
<span class="term-fg32">+		RequestId:                    id,</span>
<span class="term-fg32">+		GetPooledTransactionsRequest: hashes,</span>
 	})
 }
</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-a40de44107ca62ca68d43bf2" role="button"
                   aria-expanded="false" aria-controls="id-a40de44107ca62ca68d43bf2">
                    <code>eth/protocols/eth/protocol.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/3f40e65c484486dea6cff80b7db178985d21a2c6/eth/protocols/eth/protocol.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/650bb2f2b1dcfe30d9b1fa6f7dc9608055ed60e1/eth/protocols/eth/protocol.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+87</span></div>
                        <div class="text-start"><span class="text-danger">-110</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-a40de44107ca62ca68d43bf2"><span class="term-fg1">diff --git go-ethereum&#47;eth&#47;protocols&#47;eth&#47;protocol.go op-geth&#47;eth&#47;protocols&#47;eth&#47;protocol.go</span>
<span class="term-fg1">index 4b9f5ad6ba5286963f7bd12a91475c5a940248e4..0f44f83de159cb38c430b9f0a0a37b70a02f33f6 100644</span>
<span class="term-fg1">--- go-ethereum&#47;eth&#47;protocols&#47;eth&#47;protocol.go</span>
<span class="term-fg1">+++ op-geth&#47;eth&#47;protocols&#47;eth&#47;protocol.go</span>
<span class="term-fg36">@@ -30,7 +30,6 @@</span> )
&nbsp;
 &#47;&#47; Constants to match up protocol versions and messages
 const (
<span class="term-fg31">-	ETH66 = 66</span>
 	ETH67 = 67
 	ETH68 = 68
 )
<span class="term-fg36">@@ -41,11 +40,11 @@</span> const ProtocolName = &quot;eth&quot;
&nbsp;
 &#47;&#47; ProtocolVersions are the supported versions of the `eth` protocol (first
 &#47;&#47; is primary).
<span class="term-fg31">-var ProtocolVersions = []uint{ETH68, ETH67, ETH66}</span>
<span class="term-fg32">+var ProtocolVersions = []uint{ETH68, ETH67}</span>
&nbsp;
 &#47;&#47; protocolLengths are the number of implemented message corresponding to
 &#47;&#47; different protocol versions.
<span class="term-fg31">-var protocolLengths = map[uint]uint64{ETH68: 17, ETH67: 17, ETH66: 17}</span>
<span class="term-fg32">+var protocolLengths = map[uint]uint64{ETH68: 17, ETH67: 17}</span>
&nbsp;
 &#47;&#47; maxMessageSize is the maximum cap on the size of a protocol message.
 const maxMessageSize = 10 * 1024 * 1024
<span class="term-fg36">@@ -62,8 +61,6 @@</span> 	NewBlockMsg                   = 0x07
 	NewPooledTransactionHashesMsg = 0x08
 	GetPooledTransactionsMsg      = 0x09
 	PooledTransactionsMsg         = 0x0a
<span class="term-fg31">-	GetNodeDataMsg                = 0x0d</span>
<span class="term-fg31">-	NodeDataMsg                   = 0x0e</span>
 	GetReceiptsMsg                = 0x0f
 	ReceiptsMsg                   = 0x10
 )
<span class="term-fg36">@@ -85,7 +82,7 @@</span> 	Name() string &#47;&#47; Name returns a string corresponding to the message type.
 	Kind() byte   &#47;&#47; Kind returns the message type.
 }
&nbsp;
<span class="term-fg31">-&#47;&#47; StatusPacket is the network packet for the status message for eth&#47;64 and later.</span>
<span class="term-fg32">+&#47;&#47; StatusPacket is the network packet for the status message.</span>
 type StatusPacket struct {
 	ProtocolVersion uint32
 	NetworkID       uint64
<span class="term-fg36">@@ -118,18 +115,18 @@</span>
 &#47;&#47; TransactionsPacket is the network packet for broadcasting new transactions.
 type TransactionsPacket []*types.Transaction
&nbsp;
<span class="term-fg31">-&#47;&#47; GetBlockHeadersPacket represents a block header query.</span>
<span class="term-fg31">-type GetBlockHeadersPacket struct {</span>
<span class="term-fg32">+&#47;&#47; GetBlockHeadersRequest represents a block header query.</span>
<span class="term-fg32">+type GetBlockHeadersRequest struct {</span>
 	Origin  HashOrNumber &#47;&#47; Block from which to retrieve headers
 	Amount  uint64       &#47;&#47; Maximum number of headers to retrieve
 	Skip    uint64       &#47;&#47; Blocks to skip between consecutive headers
 	Reverse bool         &#47;&#47; Query direction (false = rising towards latest, true = falling towards genesis)
 }
&nbsp;
<span class="term-fg31">-&#47;&#47; GetBlockHeadersPacket66 represents a block header query over eth&#47;66</span>
<span class="term-fg31">-type GetBlockHeadersPacket66 struct {</span>
<span class="term-fg32">+&#47;&#47; GetBlockHeadersPacket represents a block header query with request ID wrapping.</span>
<span class="term-fg32">+type GetBlockHeadersPacket struct {</span>
 	RequestId uint64
<span class="term-fg31">-	*GetBlockHeadersPacket</span>
<span class="term-fg32">+	*GetBlockHeadersRequest</span>
 }
&nbsp;
 &#47;&#47; HashOrNumber is a combined field for specifying an origin block.
<span class="term-fg36">@@ -168,23 +165,23 @@</span> 		return fmt.Errorf(&quot;invalid input size %d for origin&quot;, size)
 	}
 }
&nbsp;
<span class="term-fg31">-&#47;&#47; BlockHeadersPacket represents a block header response.</span>
<span class="term-fg31">-type BlockHeadersPacket []*types.Header</span>
<span class="term-fg32">+&#47;&#47; BlockHeadersRequest represents a block header response.</span>
<span class="term-fg32">+type BlockHeadersRequest []*types.Header</span>
&nbsp;
<span class="term-fg31">-&#47;&#47; BlockHeadersPacket66 represents a block header response over eth&#47;66.</span>
<span class="term-fg31">-type BlockHeadersPacket66 struct {</span>
<span class="term-fg32">+&#47;&#47; BlockHeadersPacket represents a block header response over with request ID wrapping.</span>
<span class="term-fg32">+type BlockHeadersPacket struct {</span>
 	RequestId uint64
<span class="term-fg31">-	BlockHeadersPacket</span>
<span class="term-fg32">+	BlockHeadersRequest</span>
 }
&nbsp;
<span class="term-fg31">-&#47;&#47; BlockHeadersRLPPacket represents a block header response, to use when we already</span>
<span class="term-fg32">+&#47;&#47; BlockHeadersRLPResponse represents a block header response, to use when we already</span>
 &#47;&#47; have the headers rlp encoded.
<span class="term-fg31">-type BlockHeadersRLPPacket []rlp.RawValue</span>
<span class="term-fg32">+type BlockHeadersRLPResponse []rlp.RawValue</span>
&nbsp;
<span class="term-fg31">-&#47;&#47; BlockHeadersRLPPacket66 represents a block header response over eth&#47;66.</span>
<span class="term-fg31">-type BlockHeadersRLPPacket66 struct {</span>
<span class="term-fg32">+&#47;&#47; BlockHeadersRLPPacket represents a block header response with request ID wrapping.</span>
<span class="term-fg32">+type BlockHeadersRLPPacket struct {</span>
 	RequestId uint64
<span class="term-fg31">-	BlockHeadersRLPPacket</span>
<span class="term-fg32">+	BlockHeadersRLPResponse</span>
 }
&nbsp;
 &#47;&#47; NewBlockPacket is the network packet for the block propagation message.
<span class="term-fg36">@@ -206,33 +203,34 @@</span> 	}
 	return nil
 }
&nbsp;
<span class="term-fg31">-&#47;&#47; GetBlockBodiesPacket represents a block body query.</span>
<span class="term-fg31">-type GetBlockBodiesPacket []common.Hash</span>
<span class="term-fg32">+&#47;&#47; GetBlockBodiesRequest represents a block body query.</span>
<span class="term-fg32">+type GetBlockBodiesRequest []common.Hash</span>
&nbsp;
<span class="term-fg31">-&#47;&#47; GetBlockBodiesPacket66 represents a block body query over eth&#47;66.</span>
<span class="term-fg31">-type GetBlockBodiesPacket66 struct {</span>
<span class="term-fg32">+&#47;&#47; GetBlockBodiesPacket represents a block body query with request ID wrapping.</span>
<span class="term-fg32">+type GetBlockBodiesPacket struct {</span>
 	RequestId uint64
<span class="term-fg31">-	GetBlockBodiesPacket</span>
<span class="term-fg32">+	GetBlockBodiesRequest</span>
 }
&nbsp;
<span class="term-fg31">-&#47;&#47; BlockBodiesPacket is the network packet for block content distribution.</span>
<span class="term-fg31">-type BlockBodiesPacket []*BlockBody</span>
<span class="term-fg32">+&#47;&#47; BlockBodiesResponse is the network packet for block content distribution.</span>
<span class="term-fg32">+type BlockBodiesResponse []*BlockBody</span>
&nbsp;
<span class="term-fg31">-&#47;&#47; BlockBodiesPacket66 is the network packet for block content distribution over eth&#47;66.</span>
<span class="term-fg31">-type BlockBodiesPacket66 struct {</span>
<span class="term-fg32">+&#47;&#47; BlockBodiesPacket is the network packet for block content distribution with</span>
<span class="term-fg32">+&#47;&#47; request ID wrapping.</span>
<span class="term-fg32">+type BlockBodiesPacket struct {</span>
 	RequestId uint64
<span class="term-fg31">-	BlockBodiesPacket</span>
<span class="term-fg32">+	BlockBodiesResponse</span>
 }
&nbsp;
<span class="term-fg31">-&#47;&#47; BlockBodiesRLPPacket is used for replying to block body requests, in cases</span>
<span class="term-fg32">+&#47;&#47; BlockBodiesRLPResponse is used for replying to block body requests, in cases</span>
 &#47;&#47; where we already have them RLP-encoded, and thus can avoid the decode-encode
 &#47;&#47; roundtrip.
<span class="term-fg31">-type BlockBodiesRLPPacket []rlp.RawValue</span>
<span class="term-fg32">+type BlockBodiesRLPResponse []rlp.RawValue</span>
&nbsp;
<span class="term-fg31">-&#47;&#47; BlockBodiesRLPPacket66 is the BlockBodiesRLPPacket over eth&#47;66</span>
<span class="term-fg31">-type BlockBodiesRLPPacket66 struct {</span>
<span class="term-fg32">+&#47;&#47; BlockBodiesRLPPacket is the BlockBodiesRLPResponse with request ID wrapping.</span>
<span class="term-fg32">+type BlockBodiesRLPPacket struct {</span>
 	RequestId uint64
<span class="term-fg31">-	BlockBodiesRLPPacket</span>
<span class="term-fg32">+	BlockBodiesRLPResponse</span>
 }
&nbsp;
 &#47;&#47; BlockBody represents the data content of a single block.
<span class="term-fg36">@@ -244,7 +242,7 @@</span> }
&nbsp;
 &#47;&#47; Unpack retrieves the transactions and uncles from the range packet and returns
 &#47;&#47; them in a split flat format that&#39;s more consistent with the internal data structures.
<span class="term-fg31">-func (p *BlockBodiesPacket) Unpack() ([][]*types.Transaction, [][]*types.Header, [][]*types.Withdrawal) {</span>
<span class="term-fg32">+func (p *BlockBodiesResponse) Unpack() ([][]*types.Transaction, [][]*types.Header, [][]*types.Withdrawal) {</span>
 	&#47;&#47; TODO(matt): add support for withdrawals to fetchers
 	var (
 		txset         = make([][]*types.Transaction, len(*p))
<span class="term-fg36">@@ -257,53 +255,36 @@</span> 	}
 	return txset, uncleset, withdrawalset
 }
&nbsp;
<span class="term-fg31">-&#47;&#47; GetNodeDataPacket represents a trie node data query.</span>
<span class="term-fg31">-type GetNodeDataPacket []common.Hash</span>
<span class="term-fg32">+&#47;&#47; GetReceiptsRequest represents a block receipts query.</span>
<span class="term-fg32">+type GetReceiptsRequest []common.Hash</span>
&nbsp;
<span class="term-fg31">-&#47;&#47; GetNodeDataPacket66 represents a trie node data query over eth&#47;66.</span>
<span class="term-fg31">-type GetNodeDataPacket66 struct {</span>
<span class="term-fg32">+&#47;&#47; GetReceiptsPacket represents a block receipts query with request ID wrapping.</span>
<span class="term-fg32">+type GetReceiptsPacket struct {</span>
 	RequestId uint64
<span class="term-fg31">-	GetNodeDataPacket</span>
<span class="term-fg32">+	GetReceiptsRequest</span>
 }
&nbsp;
<span class="term-fg31">-&#47;&#47; NodeDataPacket is the network packet for trie node data distribution.</span>
<span class="term-fg31">-type NodeDataPacket [][]byte</span>
<span class="term-fg32">+&#47;&#47; ReceiptsResponse is the network packet for block receipts distribution.</span>
<span class="term-fg32">+type ReceiptsResponse [][]*types.Receipt</span>
&nbsp;
<span class="term-fg31">-&#47;&#47; NodeDataPacket66 is the network packet for trie node data distribution over eth&#47;66.</span>
<span class="term-fg31">-type NodeDataPacket66 struct {</span>
<span class="term-fg32">+&#47;&#47; ReceiptsPacket is the network packet for block receipts distribution with</span>
<span class="term-fg32">+&#47;&#47; request ID wrapping.</span>
<span class="term-fg32">+type ReceiptsPacket struct {</span>
 	RequestId uint64
<span class="term-fg31">-	NodeDataPacket</span>
<span class="term-fg32">+	ReceiptsResponse</span>
 }
&nbsp;
<span class="term-fg31">-&#47;&#47; GetReceiptsPacket represents a block receipts query.</span>
<span class="term-fg31">-type GetReceiptsPacket []common.Hash</span>
<span class="term-fg32">+&#47;&#47; ReceiptsRLPResponse is used for receipts, when we already have it encoded</span>
<span class="term-fg32">+type ReceiptsRLPResponse []rlp.RawValue</span>
&nbsp;
<span class="term-fg31">-&#47;&#47; GetReceiptsPacket66 represents a block receipts query over eth&#47;66.</span>
<span class="term-fg31">-type GetReceiptsPacket66 struct {</span>
<span class="term-fg32">+&#47;&#47; ReceiptsRLPPacket is ReceiptsRLPResponse with request ID wrapping.</span>
<span class="term-fg32">+type ReceiptsRLPPacket struct {</span>
 	RequestId uint64
<span class="term-fg31">-	GetReceiptsPacket</span>
<span class="term-fg32">+	ReceiptsRLPResponse</span>
 }
&nbsp;
<span class="term-fg31">-&#47;&#47; ReceiptsPacket is the network packet for block receipts distribution.</span>
<span class="term-fg31">-type ReceiptsPacket [][]*types.Receipt</span>
<span class="term-fg31">-</span>
<span class="term-fg31">-&#47;&#47; ReceiptsPacket66 is the network packet for block receipts distribution over eth&#47;66.</span>
<span class="term-fg31">-type ReceiptsPacket66 struct {</span>
<span class="term-fg31">-	RequestId uint64</span>
<span class="term-fg31">-	ReceiptsPacket</span>
<span class="term-fg31">-}</span>
<span class="term-fg31">-</span>
<span class="term-fg31">-&#47;&#47; ReceiptsRLPPacket is used for receipts, when we already have it encoded</span>
<span class="term-fg31">-type ReceiptsRLPPacket []rlp.RawValue</span>
<span class="term-fg31">-</span>
<span class="term-fg31">-&#47;&#47; ReceiptsRLPPacket66 is the eth-66 version of ReceiptsRLPPacket</span>
<span class="term-fg31">-type ReceiptsRLPPacket66 struct {</span>
<span class="term-fg31">-	RequestId uint64</span>
<span class="term-fg31">-	ReceiptsRLPPacket</span>
<span class="term-fg31">-}</span>
<span class="term-fg31">-</span>
<span class="term-fg31">-&#47;&#47; NewPooledTransactionHashesPacket66 represents a transaction announcement packet on eth&#47;66 and eth&#47;67.</span>
<span class="term-fg31">-type NewPooledTransactionHashesPacket66 []common.Hash</span>
<span class="term-fg32">+&#47;&#47; NewPooledTransactionHashesPacket67 represents a transaction announcement packet on eth&#47;67.</span>
<span class="term-fg32">+type NewPooledTransactionHashesPacket67 []common.Hash</span>
&nbsp;
 &#47;&#47; NewPooledTransactionHashesPacket68 represents a transaction announcement packet on eth&#47;68 and newer.
 type NewPooledTransactionHashesPacket68 struct {
<span class="term-fg36">@@ -312,31 +293,33 @@</span> 	Sizes  []uint32
 	Hashes []common.Hash
 }
&nbsp;
<span class="term-fg31">-&#47;&#47; GetPooledTransactionsPacket represents a transaction query.</span>
<span class="term-fg31">-type GetPooledTransactionsPacket []common.Hash</span>
<span class="term-fg32">+&#47;&#47; GetPooledTransactionsRequest represents a transaction query.</span>
<span class="term-fg32">+type GetPooledTransactionsRequest []common.Hash</span>
&nbsp;
<span class="term-fg31">-type GetPooledTransactionsPacket66 struct {</span>
<span class="term-fg32">+&#47;&#47; GetPooledTransactionsPacket represents a transaction query with request ID wrapping.</span>
<span class="term-fg32">+type GetPooledTransactionsPacket struct {</span>
 	RequestId uint64
<span class="term-fg31">-	GetPooledTransactionsPacket</span>
<span class="term-fg32">+	GetPooledTransactionsRequest</span>
 }
&nbsp;
<span class="term-fg31">-&#47;&#47; PooledTransactionsPacket is the network packet for transaction distribution.</span>
<span class="term-fg31">-type PooledTransactionsPacket []*types.Transaction</span>
<span class="term-fg32">+&#47;&#47; PooledTransactionsResponse is the network packet for transaction distribution.</span>
<span class="term-fg32">+type PooledTransactionsResponse []*types.Transaction</span>
&nbsp;
<span class="term-fg31">-&#47;&#47; PooledTransactionsPacket66 is the network packet for transaction distribution over eth&#47;66.</span>
<span class="term-fg31">-type PooledTransactionsPacket66 struct {</span>
<span class="term-fg32">+&#47;&#47; PooledTransactionsPacket is the network packet for transaction distribution</span>
<span class="term-fg32">+&#47;&#47; with request ID wrapping.</span>
<span class="term-fg32">+type PooledTransactionsPacket struct {</span>
 	RequestId uint64
<span class="term-fg31">-	PooledTransactionsPacket</span>
<span class="term-fg32">+	PooledTransactionsResponse</span>
 }
&nbsp;
<span class="term-fg31">-&#47;&#47; PooledTransactionsRLPPacket is the network packet for transaction distribution, used</span>
<span class="term-fg32">+&#47;&#47; PooledTransactionsRLPResponse is the network packet for transaction distribution, used</span>
 &#47;&#47; in the cases we already have them in rlp-encoded form
<span class="term-fg31">-type PooledTransactionsRLPPacket []rlp.RawValue</span>
<span class="term-fg32">+type PooledTransactionsRLPResponse []rlp.RawValue</span>
&nbsp;
<span class="term-fg31">-&#47;&#47; PooledTransactionsRLPPacket66 is the eth&#47;66 form of PooledTransactionsRLPPacket</span>
<span class="term-fg31">-type PooledTransactionsRLPPacket66 struct {</span>
<span class="term-fg32">+&#47;&#47; PooledTransactionsRLPPacket is PooledTransactionsRLPResponse with request ID wrapping.</span>
<span class="term-fg32">+type PooledTransactionsRLPPacket struct {</span>
 	RequestId uint64
<span class="term-fg31">-	PooledTransactionsRLPPacket</span>
<span class="term-fg32">+	PooledTransactionsRLPResponse</span>
 }
&nbsp;
 func (*StatusPacket) Name() string { return &quot;Status&quot; }
<span class="term-fg36">@@ -348,40 +331,34 @@</span>
 func (*TransactionsPacket) Name() string { return &quot;Transactions&quot; }
 func (*TransactionsPacket) Kind() byte   { return TransactionsMsg }
&nbsp;
<span class="term-fg31">-func (*GetBlockHeadersPacket) Name() string { return &quot;GetBlockHeaders&quot; }</span>
<span class="term-fg31">-func (*GetBlockHeadersPacket) Kind() byte   { return GetBlockHeadersMsg }</span>
<span class="term-fg32">+func (*GetBlockHeadersRequest) Name() string { return &quot;GetBlockHeaders&quot; }</span>
<span class="term-fg32">+func (*GetBlockHeadersRequest) Kind() byte   { return GetBlockHeadersMsg }</span>
&nbsp;
<span class="term-fg31">-func (*BlockHeadersPacket) Name() string { return &quot;BlockHeaders&quot; }</span>
<span class="term-fg31">-func (*BlockHeadersPacket) Kind() byte   { return BlockHeadersMsg }</span>
<span class="term-fg32">+func (*BlockHeadersRequest) Name() string { return &quot;BlockHeaders&quot; }</span>
<span class="term-fg32">+func (*BlockHeadersRequest) Kind() byte   { return BlockHeadersMsg }</span>
&nbsp;
<span class="term-fg31">-func (*GetBlockBodiesPacket) Name() string { return &quot;GetBlockBodies&quot; }</span>
<span class="term-fg31">-func (*GetBlockBodiesPacket) Kind() byte   { return GetBlockBodiesMsg }</span>
<span class="term-fg32">+func (*GetBlockBodiesRequest) Name() string { return &quot;GetBlockBodies&quot; }</span>
<span class="term-fg32">+func (*GetBlockBodiesRequest) Kind() byte   { return GetBlockBodiesMsg }</span>
&nbsp;
<span class="term-fg31">-func (*BlockBodiesPacket) Name() string { return &quot;BlockBodies&quot; }</span>
<span class="term-fg31">-func (*BlockBodiesPacket) Kind() byte   { return BlockBodiesMsg }</span>
<span class="term-fg32">+func (*BlockBodiesResponse) Name() string { return &quot;BlockBodies&quot; }</span>
<span class="term-fg32">+func (*BlockBodiesResponse) Kind() byte   { return BlockBodiesMsg }</span>
&nbsp;
 func (*NewBlockPacket) Name() string { return &quot;NewBlock&quot; }
 func (*NewBlockPacket) Kind() byte   { return NewBlockMsg }
&nbsp;
<span class="term-fg31">-func (*NewPooledTransactionHashesPacket66) Name() string { return &quot;NewPooledTransactionHashes&quot; }</span>
<span class="term-fg31">-func (*NewPooledTransactionHashesPacket66) Kind() byte   { return NewPooledTransactionHashesMsg }</span>
<span class="term-fg32">+func (*NewPooledTransactionHashesPacket67) Name() string { return &quot;NewPooledTransactionHashes&quot; }</span>
<span class="term-fg32">+func (*NewPooledTransactionHashesPacket67) Kind() byte   { return NewPooledTransactionHashesMsg }</span>
 func (*NewPooledTransactionHashesPacket68) Name() string { return &quot;NewPooledTransactionHashes&quot; }
 func (*NewPooledTransactionHashesPacket68) Kind() byte   { return NewPooledTransactionHashesMsg }
&nbsp;
<span class="term-fg31">-func (*GetPooledTransactionsPacket) Name() string { return &quot;GetPooledTransactions&quot; }</span>
<span class="term-fg31">-func (*GetPooledTransactionsPacket) Kind() byte   { return GetPooledTransactionsMsg }</span>
<span class="term-fg31">-</span>
<span class="term-fg31">-func (*PooledTransactionsPacket) Name() string { return &quot;PooledTransactions&quot; }</span>
<span class="term-fg31">-func (*PooledTransactionsPacket) Kind() byte   { return PooledTransactionsMsg }</span>
<span class="term-fg31">-</span>
<span class="term-fg31">-func (*GetNodeDataPacket) Name() string { return &quot;GetNodeData&quot; }</span>
<span class="term-fg31">-func (*GetNodeDataPacket) Kind() byte   { return GetNodeDataMsg }</span>
<span class="term-fg32">+func (*GetPooledTransactionsRequest) Name() string { return &quot;GetPooledTransactions&quot; }</span>
<span class="term-fg32">+func (*GetPooledTransactionsRequest) Kind() byte   { return GetPooledTransactionsMsg }</span>
&nbsp;
<span class="term-fg31">-func (*NodeDataPacket) Name() string { return &quot;NodeData&quot; }</span>
<span class="term-fg31">-func (*NodeDataPacket) Kind() byte   { return NodeDataMsg }</span>
<span class="term-fg32">+func (*PooledTransactionsResponse) Name() string { return &quot;PooledTransactions&quot; }</span>
<span class="term-fg32">+func (*PooledTransactionsResponse) Kind() byte   { return PooledTransactionsMsg }</span>
&nbsp;
<span class="term-fg31">-func (*GetReceiptsPacket) Name() string { return &quot;GetReceipts&quot; }</span>
<span class="term-fg31">-func (*GetReceiptsPacket) Kind() byte   { return GetReceiptsMsg }</span>
<span class="term-fg32">+func (*GetReceiptsRequest) Name() string { return &quot;GetReceipts&quot; }</span>
<span class="term-fg32">+func (*GetReceiptsRequest) Kind() byte   { return GetReceiptsMsg }</span>
&nbsp;
<span class="term-fg31">-func (*ReceiptsPacket) Name() string { return &quot;Receipts&quot; }</span>
<span class="term-fg31">-func (*ReceiptsPacket) Kind() byte   { return ReceiptsMsg }</span>
<span class="term-fg32">+func (*ReceiptsResponse) Name() string { return &quot;Receipts&quot; }</span>
<span class="term-fg32">+func (*ReceiptsResponse) Kind() byte   { return ReceiptsMsg }</span></div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-b54f581bfaf2d2039d464039" role="button"
                   aria-expanded="false" aria-controls="id-b54f581bfaf2d2039d464039">
                    <code>eth/protocols/eth/protocol_test.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/3f40e65c484486dea6cff80b7db178985d21a2c6/eth/protocols/eth/protocol_test.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/650bb2f2b1dcfe30d9b1fa6f7dc9608055ed60e1/eth/protocols/eth/protocol_test.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+42</span></div>
                        <div class="text-start"><span class="text-danger">-60</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-b54f581bfaf2d2039d464039"><span class="term-fg1">diff --git go-ethereum&#47;eth&#47;protocols&#47;eth&#47;protocol_test.go op-geth&#47;eth&#47;protocols&#47;eth&#47;protocol_test.go</span>
<span class="term-fg1">index a86fbb0a6906ae9480e6d94c18c541fd79af8cbd..bc2545dea286a6b8cd633dd5dc54866d7175162f 100644</span>
<span class="term-fg1">--- go-ethereum&#47;eth&#47;protocols&#47;eth&#47;protocol_test.go</span>
<span class="term-fg1">+++ op-geth&#47;eth&#47;protocols&#47;eth&#47;protocol_test.go</span>
<span class="term-fg36">@@ -35,19 +35,19 @@</span> 		hash[i] = byte(i)
 	}
 	&#47;&#47; Assemble some table driven tests
 	tests := []struct {
<span class="term-fg31">-		packet *GetBlockHeadersPacket</span>
<span class="term-fg32">+		packet *GetBlockHeadersRequest</span>
 		fail   bool
 	}{
 		&#47;&#47; Providing the origin as either a hash or a number should both work
<span class="term-fg31">-		{fail: false, packet: &amp;GetBlockHeadersPacket{Origin: HashOrNumber{Number: 314}}},</span>
<span class="term-fg31">-		{fail: false, packet: &amp;GetBlockHeadersPacket{Origin: HashOrNumber{Hash: hash}}},</span>
<span class="term-fg32">+		{fail: false, packet: &amp;GetBlockHeadersRequest{Origin: HashOrNumber{Number: 314}}},</span>
<span class="term-fg32">+		{fail: false, packet: &amp;GetBlockHeadersRequest{Origin: HashOrNumber{Hash: hash}}},</span>
&nbsp;
 		&#47;&#47; Providing arbitrary query field should also work
<span class="term-fg31">-		{fail: false, packet: &amp;GetBlockHeadersPacket{Origin: HashOrNumber{Number: 314}, Amount: 314, Skip: 1, Reverse: true}},</span>
<span class="term-fg31">-		{fail: false, packet: &amp;GetBlockHeadersPacket{Origin: HashOrNumber{Hash: hash}, Amount: 314, Skip: 1, Reverse: true}},</span>
<span class="term-fg32">+		{fail: false, packet: &amp;GetBlockHeadersRequest{Origin: HashOrNumber{Number: 314}, Amount: 314, Skip: 1, Reverse: true}},</span>
<span class="term-fg32">+		{fail: false, packet: &amp;GetBlockHeadersRequest{Origin: HashOrNumber{Hash: hash}, Amount: 314, Skip: 1, Reverse: true}},</span>
&nbsp;
 		&#47;&#47; Providing both the origin hash and origin number must fail
<span class="term-fg31">-		{fail: true, packet: &amp;GetBlockHeadersPacket{Origin: HashOrNumber{Hash: hash, Number: 314}}},</span>
<span class="term-fg32">+		{fail: true, packet: &amp;GetBlockHeadersRequest{Origin: HashOrNumber{Hash: hash, Number: 314}}},</span>
 	}
 	&#47;&#47; Iterate over each of the tests and try to encode and then decode
 	for i, tt := range tests {
<span class="term-fg36">@@ -58,7 +58,7 @@</span> 		} else if err == nil &amp;&amp; tt.fail {
 			t.Fatalf(&quot;test %d: encode should have failed&quot;, i)
 		}
 		if !tt.fail {
<span class="term-fg31">-			packet := new(GetBlockHeadersPacket)</span>
<span class="term-fg32">+			packet := new(GetBlockHeadersRequest)</span>
 			if err := rlp.DecodeBytes(bytes, packet); err != nil {
 				t.Fatalf(&quot;test %d: failed to decode packet: %v&quot;, i, err)
 			}
<span class="term-fg36">@@ -70,46 +70,40 @@</span> 		}
 	}
 }
&nbsp;
<span class="term-fg31">-&#47;&#47; TestEth66EmptyMessages tests encoding of empty eth66 messages</span>
<span class="term-fg31">-func TestEth66EmptyMessages(t *testing.T) {</span>
<span class="term-fg32">+&#47;&#47; TestEmptyMessages tests encoding of empty messages.</span>
<span class="term-fg32">+func TestEmptyMessages(t *testing.T) {</span>
 	&#47;&#47; All empty messages encodes to the same format
 	want := common.FromHex(&quot;c4820457c0&quot;)
&nbsp;
 	for i, msg := range []interface{}{
 		&#47;&#47; Headers
<span class="term-fg31">-		GetBlockHeadersPacket66{1111, nil},</span>
<span class="term-fg31">-		BlockHeadersPacket66{1111, nil},</span>
<span class="term-fg32">+		GetBlockHeadersPacket{1111, nil},</span>
<span class="term-fg32">+		BlockHeadersPacket{1111, nil},</span>
 		&#47;&#47; Bodies
<span class="term-fg31">-		GetBlockBodiesPacket66{1111, nil},</span>
<span class="term-fg31">-		BlockBodiesPacket66{1111, nil},</span>
<span class="term-fg31">-		BlockBodiesRLPPacket66{1111, nil},</span>
<span class="term-fg31">-		&#47;&#47; Node data</span>
<span class="term-fg31">-		GetNodeDataPacket66{1111, nil},</span>
<span class="term-fg31">-		NodeDataPacket66{1111, nil},</span>
<span class="term-fg32">+		GetBlockBodiesPacket{1111, nil},</span>
<span class="term-fg32">+		BlockBodiesPacket{1111, nil},</span>
<span class="term-fg32">+		BlockBodiesRLPPacket{1111, nil},</span>
 		&#47;&#47; Receipts
<span class="term-fg31">-		GetReceiptsPacket66{1111, nil},</span>
<span class="term-fg31">-		ReceiptsPacket66{1111, nil},</span>
<span class="term-fg32">+		GetReceiptsPacket{1111, nil},</span>
<span class="term-fg32">+		ReceiptsPacket{1111, nil},</span>
 		&#47;&#47; Transactions
<span class="term-fg31">-		GetPooledTransactionsPacket66{1111, nil},</span>
<span class="term-fg31">-		PooledTransactionsPacket66{1111, nil},</span>
<span class="term-fg31">-		PooledTransactionsRLPPacket66{1111, nil},</span>
<span class="term-fg32">+		GetPooledTransactionsPacket{1111, nil},</span>
<span class="term-fg32">+		PooledTransactionsPacket{1111, nil},</span>
<span class="term-fg32">+		PooledTransactionsRLPPacket{1111, nil},</span>
&nbsp;
 		&#47;&#47; Headers
<span class="term-fg31">-		BlockHeadersPacket66{1111, BlockHeadersPacket([]*types.Header{})},</span>
<span class="term-fg32">+		BlockHeadersPacket{1111, BlockHeadersRequest([]*types.Header{})},</span>
 		&#47;&#47; Bodies
<span class="term-fg31">-		GetBlockBodiesPacket66{1111, GetBlockBodiesPacket([]common.Hash{})},</span>
<span class="term-fg31">-		BlockBodiesPacket66{1111, BlockBodiesPacket([]*BlockBody{})},</span>
<span class="term-fg31">-		BlockBodiesRLPPacket66{1111, BlockBodiesRLPPacket([]rlp.RawValue{})},</span>
<span class="term-fg31">-		&#47;&#47; Node data</span>
<span class="term-fg31">-		GetNodeDataPacket66{1111, GetNodeDataPacket([]common.Hash{})},</span>
<span class="term-fg31">-		NodeDataPacket66{1111, NodeDataPacket([][]byte{})},</span>
<span class="term-fg32">+		GetBlockBodiesPacket{1111, GetBlockBodiesRequest([]common.Hash{})},</span>
<span class="term-fg32">+		BlockBodiesPacket{1111, BlockBodiesResponse([]*BlockBody{})},</span>
<span class="term-fg32">+		BlockBodiesRLPPacket{1111, BlockBodiesRLPResponse([]rlp.RawValue{})},</span>
 		&#47;&#47; Receipts
<span class="term-fg31">-		GetReceiptsPacket66{1111, GetReceiptsPacket([]common.Hash{})},</span>
<span class="term-fg31">-		ReceiptsPacket66{1111, ReceiptsPacket([][]*types.Receipt{})},</span>
<span class="term-fg32">+		GetReceiptsPacket{1111, GetReceiptsRequest([]common.Hash{})},</span>
<span class="term-fg32">+		ReceiptsPacket{1111, ReceiptsResponse([][]*types.Receipt{})},</span>
 		&#47;&#47; Transactions
<span class="term-fg31">-		GetPooledTransactionsPacket66{1111, GetPooledTransactionsPacket([]common.Hash{})},</span>
<span class="term-fg31">-		PooledTransactionsPacket66{1111, PooledTransactionsPacket([]*types.Transaction{})},</span>
<span class="term-fg31">-		PooledTransactionsRLPPacket66{1111, PooledTransactionsRLPPacket([]rlp.RawValue{})},</span>
<span class="term-fg32">+		GetPooledTransactionsPacket{1111, GetPooledTransactionsRequest([]common.Hash{})},</span>
<span class="term-fg32">+		PooledTransactionsPacket{1111, PooledTransactionsResponse([]*types.Transaction{})},</span>
<span class="term-fg32">+		PooledTransactionsRLPPacket{1111, PooledTransactionsRLPResponse([]rlp.RawValue{})},</span>
 	} {
 		if have, _ := rlp.EncodeToBytes(msg); !bytes.Equal(have, want) {
 			t.Errorf(&quot;test %d, type %T, have\n\t%x\nwant\n\t%x&quot;, i, msg, have, want)
<span class="term-fg36">@@ -117,8 +111,8 @@</span> 		}
 	}
 }
&nbsp;
<span class="term-fg31">-&#47;&#47; TestEth66Messages tests the encoding of all redefined eth66 messages</span>
<span class="term-fg31">-func TestEth66Messages(t *testing.T) {</span>
<span class="term-fg32">+&#47;&#47; TestMessages tests the encoding of all messages.</span>
<span class="term-fg32">+func TestMessages(t *testing.T) {</span>
 	&#47;&#47; Some basic structs used during testing
 	var (
 		header       *types.Header
<span class="term-fg36">@@ -169,10 +163,6 @@</span> 	hashes = []common.Hash{
 		common.HexToHash(&quot;deadc0de&quot;),
 		common.HexToHash(&quot;feedbeef&quot;),
 	}
<span class="term-fg31">-	byteSlices := [][]byte{</span>
<span class="term-fg31">-		common.FromHex(&quot;deadc0de&quot;),</span>
<span class="term-fg31">-		common.FromHex(&quot;feedbeef&quot;),</span>
<span class="term-fg31">-	}</span>
 	&#47;&#47; init the receipts
 	{
 		receipts = []*types.Receipt{
<span class="term-fg36">@@ -203,59 +193,51 @@</span> 		message interface{}
 		want    []byte
 	}{
 		{
<span class="term-fg31">-			GetBlockHeadersPacket66{1111, &amp;GetBlockHeadersPacket{HashOrNumber{hashes[0], 0}, 5, 5, false}},</span>
<span class="term-fg32">+			GetBlockHeadersPacket{1111, &amp;GetBlockHeadersRequest{HashOrNumber{hashes[0], 0}, 5, 5, false}},</span>
 			common.FromHex(&quot;e8820457e4a000000000000000000000000000000000000000000000000000000000deadc0de050580&quot;),
 		},
 		{
<span class="term-fg31">-			GetBlockHeadersPacket66{1111, &amp;GetBlockHeadersPacket{HashOrNumber{common.Hash{}, 9999}, 5, 5, false}},</span>
<span class="term-fg32">+			GetBlockHeadersPacket{1111, &amp;GetBlockHeadersRequest{HashOrNumber{common.Hash{}, 9999}, 5, 5, false}},</span>
 			common.FromHex(&quot;ca820457c682270f050580&quot;),
 		},
 		{
<span class="term-fg31">-			BlockHeadersPacket66{1111, BlockHeadersPacket{header}},</span>
<span class="term-fg32">+			BlockHeadersPacket{1111, BlockHeadersRequest{header}},</span>
 			common.FromHex(&quot;f90202820457f901fcf901f9a00000000000000000000000000000000000000000000000000000000000000000a00000000000000000000000000000000000000000000000000000000000000000940000000000000000000000000000000000000000a00000000000000000000000000000000000000000000000000000000000000000a00000000000000000000000000000000000000000000000000000000000000000a00000000000000000000000000000000000000000000000000000000000000000b90100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000008208ae820d0582115c8215b3821a0a827788a00000000000000000000000000000000000000000000000000000000000000000880000000000000000&quot;),
 		},
 		{
<span class="term-fg31">-			GetBlockBodiesPacket66{1111, GetBlockBodiesPacket(hashes)},</span>
<span class="term-fg32">+			GetBlockBodiesPacket{1111, GetBlockBodiesRequest(hashes)},</span>
 			common.FromHex(&quot;f847820457f842a000000000000000000000000000000000000000000000000000000000deadc0dea000000000000000000000000000000000000000000000000000000000feedbeef&quot;),
 		},
 		{
<span class="term-fg31">-			BlockBodiesPacket66{1111, BlockBodiesPacket([]*BlockBody{blockBody})},</span>
<span class="term-fg32">+			BlockBodiesPacket{1111, BlockBodiesResponse([]*BlockBody{blockBody})},</span>
 			common.FromHex(&quot;f902dc820457f902d6f902d3f8d2f867088504a817c8088302e2489435353535353535353535353535353535353535358202008025a064b1702d9298fee62dfeccc57d322a463ad55ca201256d01f62b45b2e1c21c12a064b1702d9298fee62dfeccc57d322a463ad55ca201256d01f62b45b2e1c21c10f867098504a817c809830334509435353535353535353535353535353535353535358202d98025a052f8f61201b2b11a78d6e866abc9c3db2ae8631fa656bfe5cb53668255367afba052f8f61201b2b11a78d6e866abc9c3db2ae8631fa656bfe5cb53668255367afbf901fcf901f9a00000000000000000000000000000000000000000000000000000000000000000a00000000000000000000000000000000000000000000000000000000000000000940000000000000000000000000000000000000000a00000000000000000000000000000000000000000000000000000000000000000a00000000000000000000000000000000000000000000000000000000000000000a00000000000000000000000000000000000000000000000000000000000000000b90100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000008208ae820d0582115c8215b3821a0a827788a00000000000000000000000000000000000000000000000000000000000000000880000000000000000&quot;),
 		},
 		{ &#47;&#47; Identical to non-rlp-shortcut version
<span class="term-fg31">-			BlockBodiesRLPPacket66{1111, BlockBodiesRLPPacket([]rlp.RawValue{blockBodyRlp})},</span>
<span class="term-fg32">+			BlockBodiesRLPPacket{1111, BlockBodiesRLPResponse([]rlp.RawValue{blockBodyRlp})},</span>
 			common.FromHex(&quot;f902dc820457f902d6f902d3f8d2f867088504a817c8088302e2489435353535353535353535353535353535353535358202008025a064b1702d9298fee62dfeccc57d322a463ad55ca201256d01f62b45b2e1c21c12a064b1702d9298fee62dfeccc57d322a463ad55ca201256d01f62b45b2e1c21c10f867098504a817c809830334509435353535353535353535353535353535353535358202d98025a052f8f61201b2b11a78d6e866abc9c3db2ae8631fa656bfe5cb53668255367afba052f8f61201b2b11a78d6e866abc9c3db2ae8631fa656bfe5cb53668255367afbf901fcf901f9a00000000000000000000000000000000000000000000000000000000000000000a00000000000000000000000000000000000000000000000000000000000000000940000000000000000000000000000000000000000a00000000000000000000000000000000000000000000000000000000000000000a00000000000000000000000000000000000000000000000000000000000000000a00000000000000000000000000000000000000000000000000000000000000000b90100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000008208ae820d0582115c8215b3821a0a827788a00000000000000000000000000000000000000000000000000000000000000000880000000000000000&quot;),
 		},
 		{
<span class="term-fg31">-			GetNodeDataPacket66{1111, GetNodeDataPacket(hashes)},</span>
<span class="term-fg32">+			GetReceiptsPacket{1111, GetReceiptsRequest(hashes)},</span>
 			common.FromHex(&quot;f847820457f842a000000000000000000000000000000000000000000000000000000000deadc0dea000000000000000000000000000000000000000000000000000000000feedbeef&quot;),
 		},
 		{
<span class="term-fg31">-			NodeDataPacket66{1111, NodeDataPacket(byteSlices)},</span>
<span class="term-fg31">-			common.FromHex(&quot;ce820457ca84deadc0de84feedbeef&quot;),</span>
<span class="term-fg31">-		},</span>
<span class="term-fg31">-		{</span>
<span class="term-fg31">-			GetReceiptsPacket66{1111, GetReceiptsPacket(hashes)},</span>
<span class="term-fg31">-			common.FromHex(&quot;f847820457f842a000000000000000000000000000000000000000000000000000000000deadc0dea000000000000000000000000000000000000000000000000000000000feedbeef&quot;),</span>
<span class="term-fg31">-		},</span>
<span class="term-fg31">-		{</span>
<span class="term-fg31">-			ReceiptsPacket66{1111, ReceiptsPacket([][]*types.Receipt{receipts})},</span>
<span class="term-fg32">+			ReceiptsPacket{1111, ReceiptsResponse([][]*types.Receipt{receipts})},</span>
 			common.FromHex(&quot;f90172820457f9016cf90169f901668001b9010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000f85ff85d940000000000000000000000000000000000000011f842a0000000000000000000000000000000000000000000000000000000000000deada0000000000000000000000000000000000000000000000000000000000000beef830100ff&quot;),
 		},
 		{
<span class="term-fg31">-			ReceiptsRLPPacket66{1111, ReceiptsRLPPacket([]rlp.RawValue{receiptsRlp})},</span>
<span class="term-fg32">+			ReceiptsRLPPacket{1111, ReceiptsRLPResponse([]rlp.RawValue{receiptsRlp})},</span>
 			common.FromHex(&quot;f90172820457f9016cf90169f901668001b9010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000f85ff85d940000000000000000000000000000000000000011f842a0000000000000000000000000000000000000000000000000000000000000deada0000000000000000000000000000000000000000000000000000000000000beef830100ff&quot;),
 		},
 		{
<span class="term-fg31">-			GetPooledTransactionsPacket66{1111, GetPooledTransactionsPacket(hashes)},</span>
<span class="term-fg32">+			GetPooledTransactionsPacket{1111, GetPooledTransactionsRequest(hashes)},</span>
 			common.FromHex(&quot;f847820457f842a000000000000000000000000000000000000000000000000000000000deadc0dea000000000000000000000000000000000000000000000000000000000feedbeef&quot;),
 		},
 		{
<span class="term-fg31">-			PooledTransactionsPacket66{1111, PooledTransactionsPacket(txs)},</span>
<span class="term-fg32">+			PooledTransactionsPacket{1111, PooledTransactionsResponse(txs)},</span>
 			common.FromHex(&quot;f8d7820457f8d2f867088504a817c8088302e2489435353535353535353535353535353535353535358202008025a064b1702d9298fee62dfeccc57d322a463ad55ca201256d01f62b45b2e1c21c12a064b1702d9298fee62dfeccc57d322a463ad55ca201256d01f62b45b2e1c21c10f867098504a817c809830334509435353535353535353535353535353535353535358202d98025a052f8f61201b2b11a78d6e866abc9c3db2ae8631fa656bfe5cb53668255367afba052f8f61201b2b11a78d6e866abc9c3db2ae8631fa656bfe5cb53668255367afb&quot;),
 		},
 		{
<span class="term-fg31">-			PooledTransactionsRLPPacket66{1111, PooledTransactionsRLPPacket(txRlps)},</span>
<span class="term-fg32">+			PooledTransactionsRLPPacket{1111, PooledTransactionsRLPResponse(txRlps)},</span>
 			common.FromHex(&quot;f8d7820457f8d2f867088504a817c8088302e2489435353535353535353535353535353535353535358202008025a064b1702d9298fee62dfeccc57d322a463ad55ca201256d01f62b45b2e1c21c12a064b1702d9298fee62dfeccc57d322a463ad55ca201256d01f62b45b2e1c21c10f867098504a817c809830334509435353535353535353535353535353535353535358202d98025a052f8f61201b2b11a78d6e866abc9c3db2ae8631fa656bfe5cb53668255367afba052f8f61201b2b11a78d6e866abc9c3db2ae8631fa656bfe5cb53668255367afb&quot;),
 		},
 	} {</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-22d0cd116c785ea1ec51d9c6" role="button"
                   aria-expanded="false" aria-controls="id-22d0cd116c785ea1ec51d9c6">
                    <code>eth/protocols/snap/sync.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/3f40e65c484486dea6cff80b7db178985d21a2c6/eth/protocols/snap/sync.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/650bb2f2b1dcfe30d9b1fa6f7dc9608055ed60e1/eth/protocols/snap/sync.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+21</span></div>
                        <div class="text-start"><span class="text-danger">-18</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-22d0cd116c785ea1ec51d9c6"><span class="term-fg1">diff --git go-ethereum&#47;eth&#47;protocols&#47;snap&#47;sync.go op-geth&#47;eth&#47;protocols&#47;snap&#47;sync.go</span>
<span class="term-fg1">index 0f5f2ccdfeb97d18b6e9bb1c7a2f7584f2db5b6e..df1473e999af92ded4565fa377db2f73ab12dc69 100644</span>
<span class="term-fg1">--- go-ethereum&#47;eth&#47;protocols&#47;snap&#47;sync.go</span>
<span class="term-fg1">+++ op-geth&#47;eth&#47;protocols&#47;snap&#47;sync.go</span>
<span class="term-fg36">@@ -37,11 +37,11 @@</span> 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;core&#47;types&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;crypto&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;ethdb&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;event&quot;
<span class="term-fg31">-	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;light&quot;</span>
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;log&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;p2p&#47;msgrate&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;rlp&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;trie&quot;
<span class="term-fg32">+	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;trie&#47;trienode&quot;</span>
 	&quot;golang.org&#47;x&#47;crypto&#47;sha3&quot;
 )
&nbsp;
<span class="term-fg36">@@ -738,8 +738,8 @@</span> 					OnPut: func(key []byte, value []byte) {
 						s.accountBytes += common.StorageSize(len(key) + len(value))
 					},
 				}
<span class="term-fg31">-				task.genTrie = trie.NewStackTrie(func(owner common.Hash, path []byte, hash common.Hash, val []byte) {</span>
<span class="term-fg31">-					rawdb.WriteTrieNode(task.genBatch, owner, path, hash, val, s.scheme)</span>
<span class="term-fg32">+				task.genTrie = trie.NewStackTrie(func(path []byte, hash common.Hash, val []byte) {</span>
<span class="term-fg32">+					rawdb.WriteTrieNode(task.genBatch, common.Hash{}, path, hash, val, s.scheme)</span>
 				})
 				for accountHash, subtasks := range task.SubTasks {
 					for _, subtask := range subtasks {
<span class="term-fg36">@@ -751,9 +751,10 @@</span> 							OnPut: func(key []byte, value []byte) {
 								s.storageBytes += common.StorageSize(len(key) + len(value))
 							},
 						}
<span class="term-fg31">-						subtask.genTrie = trie.NewStackTrieWithOwner(func(owner common.Hash, path []byte, hash common.Hash, val []byte) {</span>
<span class="term-fg32">+						owner := accountHash &#47;&#47; local assignment for stacktrie writer closure</span>
<span class="term-fg32">+						subtask.genTrie = trie.NewStackTrie(func(path []byte, hash common.Hash, val []byte) {</span>
 							rawdb.WriteTrieNode(subtask.genBatch, owner, path, hash, val, s.scheme)
<span class="term-fg31">-						}, accountHash)</span>
<span class="term-fg32">+						})</span>
 					}
 				}
 			}
<span class="term-fg36">@@ -810,8 +811,8 @@</span> 			Next:     next,
 			Last:     last,
 			SubTasks: make(map[common.Hash][]*storageTask),
 			genBatch: batch,
<span class="term-fg31">-			genTrie: trie.NewStackTrie(func(owner common.Hash, path []byte, hash common.Hash, val []byte) {</span>
<span class="term-fg31">-				rawdb.WriteTrieNode(batch, owner, path, hash, val, s.scheme)</span>
<span class="term-fg32">+			genTrie: trie.NewStackTrie(func(path []byte, hash common.Hash, val []byte) {</span>
<span class="term-fg32">+				rawdb.WriteTrieNode(batch, common.Hash{}, path, hash, val, s.scheme)</span>
 			}),
 		})
 		log.Debug(&quot;Created account sync task&quot;, &quot;from&quot;, next, &quot;last&quot;, last)
<span class="term-fg36">@@ -2004,14 +2005,15 @@</span> 						OnPut: func(key []byte, value []byte) {
 							s.storageBytes += common.StorageSize(len(key) + len(value))
 						},
 					}
<span class="term-fg32">+					owner := account &#47;&#47; local assignment for stacktrie writer closure</span>
 					tasks = append(tasks, &amp;storageTask{
 						Next:     common.Hash{},
 						Last:     r.End(),
 						root:     acc.Root,
 						genBatch: batch,
<span class="term-fg31">-						genTrie: trie.NewStackTrieWithOwner(func(owner common.Hash, path []byte, hash common.Hash, val []byte) {</span>
<span class="term-fg32">+						genTrie: trie.NewStackTrie(func(path []byte, hash common.Hash, val []byte) {</span>
 							rawdb.WriteTrieNode(batch, owner, path, hash, val, s.scheme)
<span class="term-fg31">-						}, account),</span>
<span class="term-fg32">+						}),</span>
 					})
 					for r.Next() {
 						batch := ethdb.HookedBatch{
<span class="term-fg36">@@ -2025,9 +2027,9 @@</span> 							Next:     r.Start(),
 							Last:     r.End(),
 							root:     acc.Root,
 							genBatch: batch,
<span class="term-fg31">-							genTrie: trie.NewStackTrieWithOwner(func(owner common.Hash, path []byte, hash common.Hash, val []byte) {</span>
<span class="term-fg32">+							genTrie: trie.NewStackTrie(func(path []byte, hash common.Hash, val []byte) {</span>
 								rawdb.WriteTrieNode(batch, owner, path, hash, val, s.scheme)
<span class="term-fg31">-							}, account),</span>
<span class="term-fg32">+							}),</span>
 						})
 					}
 					for _, task := range tasks {
<span class="term-fg36">@@ -2072,9 +2074,10 @@</span> 		&#47;&#47; reconstructed later.
 		slots += len(res.hashes[i])
&nbsp;
 		if i &lt; len(res.hashes)-1 || res.subTask == nil {
<span class="term-fg31">-			tr := trie.NewStackTrieWithOwner(func(owner common.Hash, path []byte, hash common.Hash, val []byte) {</span>
<span class="term-fg31">-				rawdb.WriteTrieNode(batch, owner, path, hash, val, s.scheme)</span>
<span class="term-fg31">-			}, account)</span>
<span class="term-fg32">+			&#47;&#47; no need to make local reassignment of account: this closure does not outlive the loop</span>
<span class="term-fg32">+			tr := trie.NewStackTrie(func(path []byte, hash common.Hash, val []byte) {</span>
<span class="term-fg32">+				rawdb.WriteTrieNode(batch, account, path, hash, val, s.scheme)</span>
<span class="term-fg32">+			})</span>
 			for j := 0; j &lt; len(res.hashes[i]); j++ {
 				tr.Update(res.hashes[i][j][:], res.slots[i][j])
 			}
<span class="term-fg36">@@ -2394,11 +2397,11 @@</span> 	keys := make([][]byte, len(hashes))
 	for i, key := range hashes {
 		keys[i] = common.CopyBytes(key[:])
 	}
<span class="term-fg31">-	nodes := make(light.NodeList, len(proof))</span>
<span class="term-fg32">+	nodes := make(trienode.ProofList, len(proof))</span>
 	for i, node := range proof {
 		nodes[i] = node
 	}
<span class="term-fg31">-	proofdb := nodes.NodeSet()</span>
<span class="term-fg32">+	proofdb := nodes.Set()</span>
&nbsp;
 	var end []byte
 	if len(keys) &gt; 0 {
<span class="term-fg36">@@ -2639,7 +2642,7 @@</span> 		keys := make([][]byte, len(hashes[i]))
 		for j, key := range hashes[i] {
 			keys[j] = common.CopyBytes(key[:])
 		}
<span class="term-fg31">-		nodes := make(light.NodeList, 0, len(proof))</span>
<span class="term-fg32">+		nodes := make(trienode.ProofList, 0, len(proof))</span>
 		if i == len(hashes)-1 {
 			for _, node := range proof {
 				nodes = append(nodes, node)
<span class="term-fg36">@@ -2658,7 +2661,7 @@</span> 			}
 		} else {
 			&#47;&#47; A proof was attached, the response is only partial, check that the
 			&#47;&#47; returned data is indeed part of the storage trie
<span class="term-fg31">-			proofdb := nodes.NodeSet()</span>
<span class="term-fg32">+			proofdb := nodes.Set()</span>
&nbsp;
 			var end []byte
 			if len(keys) &gt; 0 {</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-21097772ecc57a04684696f1" role="button"
                   aria-expanded="false" aria-controls="id-21097772ecc57a04684696f1">
                    <code>eth/protocols/snap/sync_test.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/3f40e65c484486dea6cff80b7db178985d21a2c6/eth/protocols/snap/sync_test.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/650bb2f2b1dcfe30d9b1fa6f7dc9608055ed60e1/eth/protocols/snap/sync_test.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+9</span></div>
                        <div class="text-start"><span class="text-danger">-9</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-21097772ecc57a04684696f1"><span class="term-fg1">diff --git go-ethereum&#47;eth&#47;protocols&#47;snap&#47;sync_test.go op-geth&#47;eth&#47;protocols&#47;snap&#47;sync_test.go</span>
<span class="term-fg1">index 1514ad4e13444d2e8e39d1b1e4e8a3838650c8a1..1ee381a6619e20e226d0c6ef8b594edd7a7bdb16 100644</span>
<span class="term-fg1">--- go-ethereum&#47;eth&#47;protocols&#47;snap&#47;sync_test.go</span>
<span class="term-fg1">+++ op-geth&#47;eth&#47;protocols&#47;snap&#47;sync_test.go</span>
<span class="term-fg36">@@ -31,7 +31,6 @@</span> 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;core&#47;rawdb&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;core&#47;types&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;crypto&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;ethdb&quot;
<span class="term-fg31">-	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;light&quot;</span>
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;log&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;rlp&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;trie&quot;
<span class="term-fg36">@@ -273,7 +272,7 @@</span> 	}
 	&#47;&#47; Unless we send the entire trie, we need to supply proofs
 	&#47;&#47; Actually, we need to supply proofs either way! This seems to be an implementation
 	&#47;&#47; quirk in go-ethereum
<span class="term-fg31">-	proof := light.NewNodeSet()</span>
<span class="term-fg32">+	proof := trienode.NewProofSet()</span>
 	if err := t.accountTrie.Prove(origin[:], proof); err != nil {
 		t.logger.Error(&quot;Could not prove inexistence of origin&quot;, &quot;origin&quot;, origin, &quot;error&quot;, err)
 	}
<span class="term-fg36">@@ -283,7 +282,7 @@</span> 		if err := t.accountTrie.Prove(lastK, proof); err != nil {
 			t.logger.Error(&quot;Could not prove last item&quot;, &quot;error&quot;, err)
 		}
 	}
<span class="term-fg31">-	for _, blob := range proof.NodeList() {</span>
<span class="term-fg32">+	for _, blob := range proof.List() {</span>
 		proofs = append(proofs, blob)
 	}
 	return keys, vals, proofs
<span class="term-fg36">@@ -353,7 +352,7 @@</span> 		&#47;&#47; in the response, no need for any proofs.
 		if originHash != (common.Hash{}) || (abort &amp;&amp; len(keys) &gt; 0) {
 			&#47;&#47; If we&#39;re aborting, we need to prove the first and last item
 			&#47;&#47; This terminates the response (and thus the loop)
<span class="term-fg31">-			proof := light.NewNodeSet()</span>
<span class="term-fg32">+			proof := trienode.NewProofSet()</span>
 			stTrie := t.storageTries[account]
&nbsp;
 			&#47;&#47; Here&#39;s a potential gotcha: when constructing the proof, we cannot
<span class="term-fg36">@@ -368,7 +367,7 @@</span> 				if err := stTrie.Prove(lastK, proof); err != nil {
 					t.logger.Error(&quot;Could not prove last item&quot;, &quot;error&quot;, err)
 				}
 			}
<span class="term-fg31">-			for _, blob := range proof.NodeList() {</span>
<span class="term-fg32">+			for _, blob := range proof.List() {</span>
 				proofs = append(proofs, blob)
 			}
 			break
<span class="term-fg36">@@ -411,7 +410,7 @@</span>
 		if exit {
 			&#47;&#47; If we&#39;re aborting, we need to prove the first and last item
 			&#47;&#47; This terminates the response (and thus the loop)
<span class="term-fg31">-			proof := light.NewNodeSet()</span>
<span class="term-fg32">+			proof := trienode.NewProofSet()</span>
 			stTrie := t.storageTries[account]
&nbsp;
 			&#47;&#47; Here&#39;s a potential gotcha: when constructing the proof, we cannot
<span class="term-fg36">@@ -427,7 +426,7 @@</span> 				if err := stTrie.Prove(lastK, proof); err != nil {
 					t.logger.Error(&quot;Could not prove last item&quot;, &quot;error&quot;, err)
 				}
 			}
<span class="term-fg31">-			for _, blob := range proof.NodeList() {</span>
<span class="term-fg32">+			for _, blob := range proof.List() {</span>
 				proofs = append(proofs, blob)
 			}
 			break
<span class="term-fg36">@@ -599,8 +598,9 @@</span> 			keys = append(keys, common.BytesToHash(entry.k))
 			vals = append(vals, entry.v)
 		}
 		&#47;&#47; The proofs
<span class="term-fg31">-		proof := light.NewNodeSet()</span>
<span class="term-fg32">+		proof := trienode.NewProofSet()</span>
 		if err := t.accountTrie.Prove(origin[:], proof); err != nil {
<span class="term-fg32">+			t.logger.Error(&quot;Could not prove origin&quot;, &quot;origin&quot;, origin, &quot;error&quot;, err)</span>
 			t.logger.Error(&quot;Could not prove origin&quot;, &quot;origin&quot;, origin, &quot;error&quot;, err)
 		}
 		&#47;&#47; The bloat: add proof of every single element
<span class="term-fg36">@@ -614,7 +614,7 @@</span> 		if len(keys) &gt; 2 {
 			keys = append(keys[:1], keys[2:]...)
 			vals = append(vals[:1], vals[2:]...)
 		}
<span class="term-fg31">-		for _, blob := range proof.NodeList() {</span>
<span class="term-fg32">+		for _, blob := range proof.List() {</span>
 			proofs = append(proofs, blob)
 		}
 		if err := t.remote.OnAccounts(t, requestId, keys, vals, proofs); err != nil {</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-a86fae0aa3ad9ec6ffd3025f" role="button"
                   aria-expanded="false" aria-controls="id-a86fae0aa3ad9ec6ffd3025f">
                    <code>eth/sync.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/3f40e65c484486dea6cff80b7db178985d21a2c6/eth/sync.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/650bb2f2b1dcfe30d9b1fa6f7dc9608055ed60e1/eth/sync.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+13</span></div>
                        <div class="text-start"><span class="text-danger">-10</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-a86fae0aa3ad9ec6ffd3025f"><span class="term-fg1">diff --git go-ethereum&#47;eth&#47;sync.go op-geth&#47;eth&#47;sync.go</span>
<span class="term-fg1">index ba7a7427a51a99ca226f8c67335df11ae45c4d72..c7ba7c93d6e970b0829db419b8e1940da6eb5afb 100644</span>
<span class="term-fg1">--- go-ethereum&#47;eth&#47;sync.go</span>
<span class="term-fg1">+++ op-geth&#47;eth&#47;sync.go</span>
<span class="term-fg36">@@ -197,16 +197,25 @@</span> 		td := cs.handler.chain.GetTd(block.Hash(), block.Number.Uint64())
 		return downloader.SnapSync, td
 	}
 	&#47;&#47; We are probably in full sync, but we might have rewound to before the
<span class="term-fg31">-	&#47;&#47; snap sync pivot, check if we should reenable</span>
<span class="term-fg32">+	&#47;&#47; snap sync pivot, check if we should re-enable snap sync.</span>
<span class="term-fg32">+	head := cs.handler.chain.CurrentBlock()</span>
 	if pivot := rawdb.ReadLastPivotNumber(cs.handler.database); pivot != nil {
<span class="term-fg31">-		if head := cs.handler.chain.CurrentBlock(); head.Number.Uint64() &lt; *pivot {</span>
<span class="term-fg32">+		if head.Number.Uint64() &lt; *pivot {</span>
 			block := cs.handler.chain.CurrentSnapBlock()
 			td := cs.handler.chain.GetTd(block.Hash(), block.Number.Uint64())
 			return downloader.SnapSync, td
 		}
 	}
<span class="term-fg32">+	&#47;&#47; We are in a full sync, but the associated head state is missing. To complete</span>
<span class="term-fg32">+	&#47;&#47; the head state, forcefully rerun the snap sync. Note it doesn&#39;t mean the</span>
<span class="term-fg32">+	&#47;&#47; persistent state is corrupted, just mismatch with the head block.</span>
<span class="term-fg32">+	if !cs.handler.chain.HasState(head.Root) {</span>
<span class="term-fg32">+		block := cs.handler.chain.CurrentSnapBlock()</span>
<span class="term-fg32">+		td := cs.handler.chain.GetTd(block.Hash(), block.Number.Uint64())</span>
<span class="term-fg32">+		log.Info(&quot;Reenabled snap sync as chain is stateless&quot;)</span>
<span class="term-fg32">+		return downloader.SnapSync, td</span>
<span class="term-fg32">+	}</span>
 	&#47;&#47; Nope, we&#39;re really full syncing
<span class="term-fg31">-	head := cs.handler.chain.CurrentBlock()</span>
 	td := cs.handler.chain.GetTd(head.Hash(), head.Number.Uint64())
 	return downloader.FullSync, td
 }
<span class="term-fg36">@@ -242,13 +251,7 @@</span> 	err := h.downloader.LegacySync(op.peer.ID(), op.head, op.td, h.chain.Config().TerminalTotalDifficulty, op.mode)
 	if err != nil {
 		return err
 	}
<span class="term-fg31">-	if h.snapSync.Load() {</span>
<span class="term-fg31">-		log.Info(&quot;Snap sync complete, auto disabling&quot;)</span>
<span class="term-fg31">-		h.snapSync.Store(false)</span>
<span class="term-fg31">-	}</span>
<span class="term-fg31">-	&#47;&#47; If we&#39;ve successfully finished a sync cycle, enable accepting transactions</span>
<span class="term-fg31">-	&#47;&#47; from the network.</span>
<span class="term-fg31">-	h.acceptTxs.Store(true)</span>
<span class="term-fg32">+	h.enableSyncedFeatures()</span>
&nbsp;
 	head := h.chain.CurrentBlock()
 	if head.Number.Uint64() &gt; 0 {</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-b44ee3d49e6480440b571131" role="button"
                   aria-expanded="false" aria-controls="id-b44ee3d49e6480440b571131">
                    <code>eth/sync_test.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/3f40e65c484486dea6cff80b7db178985d21a2c6/eth/sync_test.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/650bb2f2b1dcfe30d9b1fa6f7dc9608055ed60e1/eth/sync_test.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+1</span></div>
                        <div class="text-start"><span class="text-danger">-1</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-b44ee3d49e6480440b571131"><span class="term-fg1">diff --git go-ethereum&#47;eth&#47;sync_test.go op-geth&#47;eth&#47;sync_test.go</span>
<span class="term-fg1">index b5e00298b9e9fcf7a5291164c1c0c215ec31f9e2..d26cbb66ea6174af8ed8597ef49bf4e2786f4f5a 100644</span>
<span class="term-fg1">--- go-ethereum&#47;eth&#47;sync_test.go</span>
<span class="term-fg1">+++ op-geth&#47;eth&#47;sync_test.go</span>
<span class="term-fg36">@@ -28,8 +28,8 @@</span> 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;p2p&#47;enode&quot;
 )
&nbsp;
 &#47;&#47; Tests that snap sync is disabled after a successful sync cycle.
<span class="term-fg31">-func TestSnapSyncDisabling66(t *testing.T) { testSnapSyncDisabling(t, eth.ETH66, snap.SNAP1) }</span>
 func TestSnapSyncDisabling67(t *testing.T) { testSnapSyncDisabling(t, eth.ETH67, snap.SNAP1) }
<span class="term-fg32">+func TestSnapSyncDisabling68(t *testing.T) { testSnapSyncDisabling(t, eth.ETH68, snap.SNAP1) }</span>
&nbsp;
 &#47;&#47; Tests that snap sync gets disabled as soon as a real block is successfully
 &#47;&#47; imported into the blockchain.</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-e5719691dca30220eeda3189" role="button"
                   aria-expanded="false" aria-controls="id-e5719691dca30220eeda3189">
                    <code>ethclient/ethclient.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/3f40e65c484486dea6cff80b7db178985d21a2c6/ethclient/ethclient.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/650bb2f2b1dcfe30d9b1fa6f7dc9608055ed60e1/ethclient/ethclient.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+2</span></div>
                        <div class="text-start"><span class="text-danger">-2</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-e5719691dca30220eeda3189"><span class="term-fg1">diff --git go-ethereum&#47;ethclient&#47;ethclient.go op-geth&#47;ethclient&#47;ethclient.go</span>
<span class="term-fg1">index a21d8ff67a9fc3b2c7cb92238856056a0baa6c1d..af373b99383d4589d3a451fed73d0eedd1c04568 100644</span>
<span class="term-fg1">--- go-ethereum&#47;ethclient&#47;ethclient.go</span>
<span class="term-fg1">+++ op-geth&#47;ethclient&#47;ethclient.go</span>
<span class="term-fg36">@@ -108,10 +108,10 @@</span> 	err := ec.c.CallContext(ctx, &amp;result, &quot;net_peerCount&quot;)
 	return uint64(result), err
 }
&nbsp;
<span class="term-fg31">-&#47;&#47; BlockReceipts returns the receipts of a given block number or hash</span>
<span class="term-fg32">+&#47;&#47; BlockReceipts returns the receipts of a given block number or hash.</span>
 func (ec *Client) BlockReceipts(ctx context.Context, blockNrOrHash rpc.BlockNumberOrHash) ([]*types.Receipt, error) {
 	var r []*types.Receipt
<span class="term-fg31">-	err := ec.c.CallContext(ctx, &amp;r, &quot;eth_getBlockReceipts&quot;, blockNrOrHash)</span>
<span class="term-fg32">+	err := ec.c.CallContext(ctx, &amp;r, &quot;eth_getBlockReceipts&quot;, blockNrOrHash.String())</span>
 	if err == nil &amp;&amp; r == nil {
 		return nil, ethereum.NotFound
 	}</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-dde88c63a28f15bb7b18d9a9" role="button"
                   aria-expanded="false" aria-controls="id-dde88c63a28f15bb7b18d9a9">
                    <code>ethdb/leveldb/leveldb.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/3f40e65c484486dea6cff80b7db178985d21a2c6/ethdb/leveldb/leveldb.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/650bb2f2b1dcfe30d9b1fa6f7dc9608055ed60e1/ethdb/leveldb/leveldb.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+6</span></div>
                        <div class="text-start"><span class="text-danger">-0</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-dde88c63a28f15bb7b18d9a9"><span class="term-fg1">diff --git go-ethereum&#47;ethdb&#47;leveldb&#47;leveldb.go op-geth&#47;ethdb&#47;leveldb&#47;leveldb.go</span>
<span class="term-fg1">index c0e0eb250a75811dabb804fd5800ce27a7812810..e58efbddbe80eb271c706db78f52672db4411cf8 100644</span>
<span class="term-fg1">--- go-ethereum&#47;ethdb&#47;leveldb&#47;leveldb.go</span>
<span class="term-fg1">+++ op-geth&#47;ethdb&#47;leveldb&#47;leveldb.go</span>
<span class="term-fg36">@@ -22,6 +22,7 @@</span> package leveldb
&nbsp;
 import (
 	&quot;fmt&quot;
<span class="term-fg32">+	&quot;strings&quot;</span>
 	&quot;sync&quot;
 	&quot;time&quot;
&nbsp;
<span class="term-fg36">@@ -245,6 +246,11 @@</span> }
&nbsp;
 &#47;&#47; Stat returns a particular internal stat of the database.
 func (db *Database) Stat(property string) (string, error) {
<span class="term-fg32">+	if property == &quot;&quot; {</span>
<span class="term-fg32">+		property = &quot;leveldb.stats&quot;</span>
<span class="term-fg32">+	} else if !strings.HasPrefix(property, &quot;leveldb.&quot;) {</span>
<span class="term-fg32">+		property = &quot;leveldb.&quot; + property</span>
<span class="term-fg32">+	}</span>
 	return db.db.GetProperty(property)
 }
</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-9d622f5e806594fa499ee0a3" role="button"
                   aria-expanded="false" aria-controls="id-9d622f5e806594fa499ee0a3">
                    <code>ethdb/pebble/pebble.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/3f40e65c484486dea6cff80b7db178985d21a2c6/ethdb/pebble/pebble.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/650bb2f2b1dcfe30d9b1fa6f7dc9608055ed60e1/ethdb/pebble/pebble.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+42</span></div>
                        <div class="text-start"><span class="text-danger">-18</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-9d622f5e806594fa499ee0a3"><span class="term-fg1">diff --git go-ethereum&#47;ethdb&#47;pebble&#47;pebble.go op-geth&#47;ethdb&#47;pebble&#47;pebble.go</span>
<span class="term-fg1">index 12a84cc91a6e439a58d880f5b946b511254fdb37..07dcf5933c7e97d0fb09f0e04747793e47d2cf32 100644</span>
<span class="term-fg1">--- go-ethereum&#47;ethdb&#47;pebble&#47;pebble.go</span>
<span class="term-fg1">+++ op-geth&#47;ethdb&#47;pebble&#47;pebble.go</span>
<span class="term-fg36">@@ -27,6 +27,7 @@</span> 	&quot;sync&quot;
 	&quot;sync&#47;atomic&quot;
 	&quot;time&quot;
&nbsp;
<span class="term-fg32">+	&quot;github.com&#47;cockroachdb&#47;errors&quot;</span>
 	&quot;github.com&#47;cockroachdb&#47;pebble&quot;
 	&quot;github.com&#47;cockroachdb&#47;pebble&#47;bloom&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;common&quot;
<span class="term-fg36">@@ -69,6 +70,8 @@</span> 	level0CompGauge     metrics.Gauge &#47;&#47; Gauge for tracking the number of table compaction in level0
 	nonlevel0CompGauge  metrics.Gauge &#47;&#47; Gauge for tracking the number of table compaction in non0 level
 	seekCompGauge       metrics.Gauge &#47;&#47; Gauge for tracking the number of table compaction caused by read opt
 	manualMemAllocGauge metrics.Gauge &#47;&#47; Gauge for tracking amount of non-managed memory currently allocated
<span class="term-fg32">+</span>
<span class="term-fg32">+	levelsGauge []metrics.Gauge &#47;&#47; Gauge for tracking the number of tables in levels</span>
&nbsp;
 	quitLock sync.RWMutex    &#47;&#47; Mutex protecting the quit channel and the closed flag
 	quitChan chan chan error &#47;&#47; Quit channel to stop the metrics collection before closing the database
<span class="term-fg36">@@ -116,6 +119,18 @@</span> }
&nbsp;
 func (d *Database) onWriteStallEnd() {
 	d.writeDelayTime.Add(int64(time.Since(d.writeDelayStartTime)))
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+&#47;&#47; panicLogger is just a noop logger to disable Pebble&#39;s internal logger.</span>
<span class="term-fg32">+&#47;&#47;</span>
<span class="term-fg32">+&#47;&#47; TODO(karalabe): Remove when Pebble sets this as the default.</span>
<span class="term-fg32">+type panicLogger struct{}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func (l panicLogger) Infof(format string, args ...interface{}) {</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func (l panicLogger) Fatalf(format string, args ...interface{}) {</span>
<span class="term-fg32">+	panic(errors.Errorf(&quot;fatal: &quot;+format, args...))</span>
 }
&nbsp;
 &#47;&#47; New returns a wrapped pebble DB object. The namespace is the prefix that the
<span class="term-fg36">@@ -158,7 +173,7 @@</span> 		MaxOpenFiles: handles,
&nbsp;
 		&#47;&#47; The size of memory table(as well as the write buffer).
 		&#47;&#47; Note, there may have more than two memory tables in the system.
<span class="term-fg31">-		MemTableSize: memTableSize,</span>
<span class="term-fg32">+		MemTableSize: uint64(memTableSize),</span>
&nbsp;
 		&#47;&#47; MemTableStopWritesThreshold places a hard limit on the size
 		&#47;&#47; of the existent MemTables(including the frozen one).
<span class="term-fg36">@@ -189,6 +204,7 @@</span> 			CompactionEnd:   db.onCompactionEnd,
 			WriteStallBegin: db.onWriteStallBegin,
 			WriteStallEnd:   db.onWriteStallEnd,
 		},
<span class="term-fg32">+		Logger: panicLogger{}, &#47;&#47; TODO(karalabe): Delete when this is upstreamed in Pebble</span>
 	}
 	&#47;&#47; Disable seek compaction explicitly. Check https:&#47;&#47;github.com&#47;ethereum&#47;go-ethereum&#47;pull&#47;20130
 	&#47;&#47; for more details.
<span class="term-fg36">@@ -216,7 +232,7 @@</span> 	db.seekCompGauge = metrics.NewRegisteredGauge(namespace+&quot;compact&#47;seek&quot;, nil)
 	db.manualMemAllocGauge = metrics.NewRegisteredGauge(namespace+&quot;memory&#47;manualalloc&quot;, nil)
&nbsp;
 	&#47;&#47; Start up the metrics gathering and return
<span class="term-fg31">-	go db.meter(metricsGatheringInterval)</span>
<span class="term-fg32">+	go db.meter(metricsGatheringInterval, namespace)</span>
 	return db, nil
 }
&nbsp;
<span class="term-fg36">@@ -305,12 +321,9 @@</span> 	}
 }
&nbsp;
 &#47;&#47; NewBatchWithSize creates a write-only database batch with pre-allocated buffer.
<span class="term-fg31">-&#47;&#47; It&#39;s not supported by pebble, but pebble has better memory allocation strategy</span>
<span class="term-fg31">-&#47;&#47; which turns out a lot faster than leveldb. It&#39;s performant enough to construct</span>
<span class="term-fg31">-&#47;&#47; batch object without any pre-allocated space.</span>
<span class="term-fg31">-func (d *Database) NewBatchWithSize(_ int) ethdb.Batch {</span>
<span class="term-fg32">+func (d *Database) NewBatchWithSize(size int) ethdb.Batch {</span>
 	return &amp;batch{
<span class="term-fg31">-		b:  d.db.NewBatch(),</span>
<span class="term-fg32">+		b:  d.db.NewBatchWithSize(size),</span>
 		db: d,
 	}
 }
<span class="term-fg36">@@ -379,9 +392,12 @@</span> 	}
 	return limit
 }
&nbsp;
<span class="term-fg31">-&#47;&#47; Stat returns a particular internal stat of the database.</span>
<span class="term-fg32">+&#47;&#47; Stat returns the internal metrics of Pebble in a text format. It&#39;s a developer</span>
<span class="term-fg32">+&#47;&#47; method to read everything there is to read independent of Pebble version.</span>
<span class="term-fg32">+&#47;&#47;</span>
<span class="term-fg32">+&#47;&#47; The property is unused in Pebble as there&#39;s only one thing to retrieve.</span>
 func (d *Database) Stat(property string) (string, error) {
<span class="term-fg31">-	return &quot;&quot;, nil</span>
<span class="term-fg32">+	return d.db.Metrics().String(), nil</span>
 }
&nbsp;
 &#47;&#47; Compact flattens the underlying data store for the given key range. In essence,
<span class="term-fg36">@@ -413,7 +429,7 @@</span> }
&nbsp;
 &#47;&#47; meter periodically retrieves internal pebble counters and reports them to
 &#47;&#47; the metrics subsystem.
<span class="term-fg31">-func (d *Database) meter(refresh time.Duration) {</span>
<span class="term-fg32">+func (d *Database) meter(refresh time.Duration, namespace string) {</span>
 	var errc chan error
 	timer := time.NewTimer(refresh)
 	defer timer.Stop()
<span class="term-fg36">@@ -436,7 +452,7 @@</span> 			compWrite int64
 			compRead  int64
 			nWrite    int64
&nbsp;
<span class="term-fg31">-			metrics            = d.db.Metrics()</span>
<span class="term-fg32">+			stats              = d.db.Metrics()</span>
 			compTime           = d.compTime.Load()
 			writeDelayCount    = d.writeDelayCount.Load()
 			writeDelayTime     = d.writeDelayTime.Load()
<span class="term-fg36">@@ -447,14 +463,14 @@</span> 		writeDelayTimes[i%2] = writeDelayTime
 		writeDelayCounts[i%2] = writeDelayCount
 		compTimes[i%2] = compTime
&nbsp;
<span class="term-fg31">-		for _, levelMetrics := range metrics.Levels {</span>
<span class="term-fg32">+		for _, levelMetrics := range stats.Levels {</span>
 			nWrite += int64(levelMetrics.BytesCompacted)
 			nWrite += int64(levelMetrics.BytesFlushed)
 			compWrite += int64(levelMetrics.BytesCompacted)
 			compRead += int64(levelMetrics.BytesRead)
 		}
&nbsp;
<span class="term-fg31">-		nWrite += int64(metrics.WAL.BytesWritten)</span>
<span class="term-fg32">+		nWrite += int64(stats.WAL.BytesWritten)</span>
&nbsp;
 		compWrites[i%2] = compWrite
 		compReads[i%2] = compRead
<span class="term-fg36">@@ -476,7 +492,7 @@</span> 		if d.compWriteMeter != nil {
 			d.compWriteMeter.Mark(compWrites[i%2] - compWrites[(i-1)%2])
 		}
 		if d.diskSizeGauge != nil {
<span class="term-fg31">-			d.diskSizeGauge.Update(int64(metrics.DiskSpaceUsage()))</span>
<span class="term-fg32">+			d.diskSizeGauge.Update(int64(stats.DiskSpaceUsage()))</span>
 		}
 		if d.diskReadMeter != nil {
 			d.diskReadMeter.Mark(0) &#47;&#47; pebble doesn&#39;t track non-compaction reads
<span class="term-fg36">@@ -485,12 +501,20 @@</span> 		if d.diskWriteMeter != nil {
 			d.diskWriteMeter.Mark(nWrites[i%2] - nWrites[(i-1)%2])
 		}
 		&#47;&#47; See https:&#47;&#47;github.com&#47;cockroachdb&#47;pebble&#47;pull&#47;1628#pullrequestreview-1026664054
<span class="term-fg31">-		manuallyAllocated := metrics.BlockCache.Size + int64(metrics.MemTable.Size) + int64(metrics.MemTable.ZombieSize)</span>
<span class="term-fg32">+		manuallyAllocated := stats.BlockCache.Size + int64(stats.MemTable.Size) + int64(stats.MemTable.ZombieSize)</span>
 		d.manualMemAllocGauge.Update(manuallyAllocated)
<span class="term-fg31">-		d.memCompGauge.Update(metrics.Flush.Count)</span>
<span class="term-fg32">+		d.memCompGauge.Update(stats.Flush.Count)</span>
 		d.nonlevel0CompGauge.Update(nonLevel0CompCount)
 		d.level0CompGauge.Update(level0CompCount)
<span class="term-fg31">-		d.seekCompGauge.Update(metrics.Compact.ReadCount)</span>
<span class="term-fg32">+		d.seekCompGauge.Update(stats.Compact.ReadCount)</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+		for i, level := range stats.Levels {</span>
<span class="term-fg32">+			&#47;&#47; Append metrics for additional layers</span>
<span class="term-fg32">+			if i &gt;= len(d.levelsGauge) {</span>
<span class="term-fg32">+				d.levelsGauge = append(d.levelsGauge, metrics.NewRegisteredGauge(namespace+fmt.Sprintf(&quot;tables&#47;level%v&quot;, i), nil))</span>
<span class="term-fg32">+			}</span>
<span class="term-fg32">+			d.levelsGauge[i].Update(level.NumFiles)</span>
<span class="term-fg32">+		}</span>
&nbsp;
 		&#47;&#47; Sleep a bit, then repeat the stats collection
 		select {
<span class="term-fg36">@@ -579,7 +603,7 @@</span> &#47;&#47; NewIterator creates a binary-alphabetical iterator over a subset
 &#47;&#47; of database content with a particular key prefix, starting at a particular
 &#47;&#47; initial key (or after, if it does not exist).
 func (d *Database) NewIterator(prefix []byte, start []byte) ethdb.Iterator {
<span class="term-fg31">-	iter := d.db.NewIter(&amp;pebble.IterOptions{</span>
<span class="term-fg32">+	iter, _ := d.db.NewIter(&amp;pebble.IterOptions{</span>
 		LowerBound: append(prefix, start...),
 		UpperBound: upperBound(prefix),
 	})</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-087c1c87d4dffd9b2107ef3a" role="button"
                   aria-expanded="false" aria-controls="id-087c1c87d4dffd9b2107ef3a">
                    <code>internal/debug/flags.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/3f40e65c484486dea6cff80b7db178985d21a2c6/internal/debug/flags.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/650bb2f2b1dcfe30d9b1fa6f7dc9608055ed60e1/internal/debug/flags.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+3</span></div>
                        <div class="text-start"><span class="text-danger">-2</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-087c1c87d4dffd9b2107ef3a"><span class="term-fg1">diff --git go-ethereum&#47;internal&#47;debug&#47;flags.go op-geth&#47;internal&#47;debug&#47;flags.go</span>
<span class="term-fg1">index 52a6342452a17ea09b9311cfd03fa2454b4188cf..736fede9433499a7dc02741a7a28e9aa53aabdc7 100644</span>
<span class="term-fg1">--- go-ethereum&#47;internal&#47;debug&#47;flags.go</span>
<span class="term-fg1">+++ op-geth&#47;internal&#47;debug&#47;flags.go</span>
<span class="term-fg36">@@ -87,8 +87,9 @@</span> 		Usage:    &quot;Prepends log messages with call-site location (file and line number)&quot;,
 		Category: flags.LoggingCategory,
 	}
 	logRotateFlag = &amp;cli.BoolFlag{
<span class="term-fg31">-		Name:  &quot;log.rotate&quot;,</span>
<span class="term-fg31">-		Usage: &quot;Enables log file rotation&quot;,</span>
<span class="term-fg32">+		Name:     &quot;log.rotate&quot;,</span>
<span class="term-fg32">+		Usage:    &quot;Enables log file rotation&quot;,</span>
<span class="term-fg32">+		Category: flags.LoggingCategory,</span>
 	}
 	logMaxSizeMBsFlag = &amp;cli.IntFlag{
 		Name:     &quot;log.maxsize&quot;,</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-2162928f8cd9ca1bfedae653" role="button"
                   aria-expanded="false" aria-controls="id-2162928f8cd9ca1bfedae653">
                    <code>internal/ethapi/api_test.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/3f40e65c484486dea6cff80b7db178985d21a2c6/internal/ethapi/api_test.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/650bb2f2b1dcfe30d9b1fa6f7dc9608055ed60e1/internal/ethapi/api_test.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+179</span></div>
                        <div class="text-start"><span class="text-danger">-13</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-2162928f8cd9ca1bfedae653"><span class="term-fg1">diff --git go-ethereum&#47;internal&#47;ethapi&#47;api_test.go op-geth&#47;internal&#47;ethapi&#47;api_test.go</span>
<span class="term-fg1">index fc135c3779ef63bfc94800c9f19ff5519a73f497..7f7b0f1495abb5f6aaabf9f9e20ea454388cdd5a 100644</span>
<span class="term-fg1">--- go-ethereum&#47;internal&#47;ethapi&#47;api_test.go</span>
<span class="term-fg1">+++ op-geth&#47;internal&#47;ethapi&#47;api_test.go</span>
<span class="term-fg36">@@ -29,6 +29,10 @@</span> 	&quot;reflect&quot;
 	&quot;testing&quot;
 	&quot;time&quot;
&nbsp;
<span class="term-fg32">+	&quot;github.com&#47;holiman&#47;uint256&quot;</span>
<span class="term-fg32">+	&quot;github.com&#47;stretchr&#47;testify&#47;require&quot;</span>
<span class="term-fg32">+	&quot;golang.org&#47;x&#47;exp&#47;slices&quot;</span>
<span class="term-fg32">+</span>
 	&quot;github.com&#47;ethereum&#47;go-ethereum&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;accounts&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;common&quot;
<span class="term-fg36">@@ -48,11 +52,166 @@</span> 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;event&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;internal&#47;blocktest&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;params&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;rpc&quot;
<span class="term-fg31">-	&quot;github.com&#47;holiman&#47;uint256&quot;</span>
<span class="term-fg31">-	&quot;github.com&#47;stretchr&#47;testify&#47;require&quot;</span>
<span class="term-fg31">-	&quot;golang.org&#47;x&#47;exp&#47;slices&quot;</span>
 )
&nbsp;
<span class="term-fg32">+func TestNewRPCTransactionDepositTx(t *testing.T) {</span>
<span class="term-fg32">+	tx := types.NewTx(&amp;types.DepositTx{</span>
<span class="term-fg32">+		SourceHash:          common.HexToHash(&quot;0x1234&quot;),</span>
<span class="term-fg32">+		IsSystemTransaction: true,</span>
<span class="term-fg32">+		Mint:                big.NewInt(34),</span>
<span class="term-fg32">+	})</span>
<span class="term-fg32">+	nonce := uint64(7)</span>
<span class="term-fg32">+	receipt := &amp;types.Receipt{</span>
<span class="term-fg32">+		DepositNonce: &amp;nonce,</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	got := newRPCTransaction(tx, common.Hash{}, uint64(12), uint64(1234), uint64(1), big.NewInt(0), &amp;params.ChainConfig{}, receipt)</span>
<span class="term-fg32">+	&#47;&#47; Should provide zero values for unused fields that are required in other transactions</span>
<span class="term-fg32">+	require.Equal(t, got.GasPrice, (*hexutil.Big)(big.NewInt(0)), &quot;newRPCTransaction().GasPrice = %v, want 0x0&quot;, got.GasPrice)</span>
<span class="term-fg32">+	require.Equal(t, got.V, (*hexutil.Big)(big.NewInt(0)), &quot;newRPCTransaction().V = %v, want 0x0&quot;, got.V)</span>
<span class="term-fg32">+	require.Equal(t, got.R, (*hexutil.Big)(big.NewInt(0)), &quot;newRPCTransaction().R = %v, want 0x0&quot;, got.R)</span>
<span class="term-fg32">+	require.Equal(t, got.S, (*hexutil.Big)(big.NewInt(0)), &quot;newRPCTransaction().S = %v, want 0x0&quot;, got.S)</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	&#47;&#47; Should include deposit tx specific fields</span>
<span class="term-fg32">+	require.Equal(t, *got.SourceHash, tx.SourceHash(), &quot;newRPCTransaction().SourceHash = %v, want %v&quot;, got.SourceHash, tx.SourceHash())</span>
<span class="term-fg32">+	require.Equal(t, *got.IsSystemTx, tx.IsSystemTx(), &quot;newRPCTransaction().IsSystemTx = %v, want %v&quot;, got.IsSystemTx, tx.IsSystemTx())</span>
<span class="term-fg32">+	require.Equal(t, got.Mint, (*hexutil.Big)(tx.Mint()), &quot;newRPCTransaction().Mint = %v, want %v&quot;, got.Mint, tx.Mint())</span>
<span class="term-fg32">+	require.Equal(t, got.Nonce, (hexutil.Uint64)(nonce), &quot;newRPCTransaction().Nonce = %v, want %v&quot;, got.Nonce, nonce)</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func TestRPCTransactionDepositTxWithVersion(t *testing.T) {</span>
<span class="term-fg32">+	tx := types.NewTx(&amp;types.DepositTx{</span>
<span class="term-fg32">+		SourceHash:          common.HexToHash(&quot;0x1234&quot;),</span>
<span class="term-fg32">+		IsSystemTransaction: true,</span>
<span class="term-fg32">+		Mint:                big.NewInt(34),</span>
<span class="term-fg32">+	})</span>
<span class="term-fg32">+	nonce := uint64(7)</span>
<span class="term-fg32">+	version := types.CanyonDepositReceiptVersion</span>
<span class="term-fg32">+	receipt := &amp;types.Receipt{</span>
<span class="term-fg32">+		DepositNonce:          &amp;nonce,</span>
<span class="term-fg32">+		DepositReceiptVersion: &amp;version,</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	got := newRPCTransaction(tx, common.Hash{}, uint64(12), uint64(1234), uint64(1), big.NewInt(0), &amp;params.ChainConfig{}, receipt)</span>
<span class="term-fg32">+	&#47;&#47; Should provide zero values for unused fields that are required in other transactions</span>
<span class="term-fg32">+	require.Equal(t, got.GasPrice, (*hexutil.Big)(big.NewInt(0)), &quot;newRPCTransaction().GasPrice = %v, want 0x0&quot;, got.GasPrice)</span>
<span class="term-fg32">+	require.Equal(t, got.V, (*hexutil.Big)(big.NewInt(0)), &quot;newRPCTransaction().V = %v, want 0x0&quot;, got.V)</span>
<span class="term-fg32">+	require.Equal(t, got.R, (*hexutil.Big)(big.NewInt(0)), &quot;newRPCTransaction().R = %v, want 0x0&quot;, got.R)</span>
<span class="term-fg32">+	require.Equal(t, got.S, (*hexutil.Big)(big.NewInt(0)), &quot;newRPCTransaction().S = %v, want 0x0&quot;, got.S)</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	&#47;&#47; Should include versioned deposit tx specific fields</span>
<span class="term-fg32">+	require.Equal(t, *got.SourceHash, tx.SourceHash(), &quot;newRPCTransaction().SourceHash = %v, want %v&quot;, got.SourceHash, tx.SourceHash())</span>
<span class="term-fg32">+	require.Equal(t, *got.IsSystemTx, tx.IsSystemTx(), &quot;newRPCTransaction().IsSystemTx = %v, want %v&quot;, got.IsSystemTx, tx.IsSystemTx())</span>
<span class="term-fg32">+	require.Equal(t, got.Mint, (*hexutil.Big)(tx.Mint()), &quot;newRPCTransaction().Mint = %v, want %v&quot;, got.Mint, tx.Mint())</span>
<span class="term-fg32">+	require.Equal(t, got.Nonce, (hexutil.Uint64)(nonce), &quot;newRPCTransaction().Nonce = %v, want %v&quot;, got.Nonce, nonce)</span>
<span class="term-fg32">+	require.Equal(t, *got.DepositReceiptVersion, (hexutil.Uint64(version)), &quot;newRPCTransaction().DepositReceiptVersion = %v, want %v&quot;, *got.DepositReceiptVersion, version)</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	&#47;&#47; Make sure json marshal&#47;unmarshal of the rpc tx preserves the receipt version</span>
<span class="term-fg32">+	b, err := json.Marshal(got)</span>
<span class="term-fg32">+	require.NoError(t, err, &quot;marshalling failed: %w&quot;, err)</span>
<span class="term-fg32">+	parsed := make(map[string]interface{})</span>
<span class="term-fg32">+	err = json.Unmarshal(b, &amp;parsed)</span>
<span class="term-fg32">+	require.NoError(t, err, &quot;unmarshalling failed: %w&quot;, err)</span>
<span class="term-fg32">+	require.Equal(t, &quot;0x1&quot;, parsed[&quot;depositReceiptVersion&quot;])</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func TestNewRPCTransactionOmitIsSystemTxFalse(t *testing.T) {</span>
<span class="term-fg32">+	tx := types.NewTx(&amp;types.DepositTx{</span>
<span class="term-fg32">+		IsSystemTransaction: false,</span>
<span class="term-fg32">+	})</span>
<span class="term-fg32">+	got := newRPCTransaction(tx, common.Hash{}, uint64(12), uint64(1234), uint64(1), big.NewInt(0), &amp;params.ChainConfig{}, nil)</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	require.Nil(t, got.IsSystemTx, &quot;should omit IsSystemTx when false&quot;)</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func TestUnmarshalRpcDepositTx(t *testing.T) {</span>
<span class="term-fg32">+	version := hexutil.Uint64(types.CanyonDepositReceiptVersion)</span>
<span class="term-fg32">+	tests := []struct {</span>
<span class="term-fg32">+		name     string</span>
<span class="term-fg32">+		modifier func(tx *RPCTransaction)</span>
<span class="term-fg32">+		valid    bool</span>
<span class="term-fg32">+	}{</span>
<span class="term-fg32">+		{</span>
<span class="term-fg32">+			name:     &quot;Unmodified&quot;,</span>
<span class="term-fg32">+			modifier: func(tx *RPCTransaction) {},</span>
<span class="term-fg32">+			valid:    true,</span>
<span class="term-fg32">+		},</span>
<span class="term-fg32">+		{</span>
<span class="term-fg32">+			name: &quot;Zero Values&quot;,</span>
<span class="term-fg32">+			modifier: func(tx *RPCTransaction) {</span>
<span class="term-fg32">+				tx.V = (*hexutil.Big)(common.Big0)</span>
<span class="term-fg32">+				tx.R = (*hexutil.Big)(common.Big0)</span>
<span class="term-fg32">+				tx.S = (*hexutil.Big)(common.Big0)</span>
<span class="term-fg32">+				tx.GasPrice = (*hexutil.Big)(common.Big0)</span>
<span class="term-fg32">+			},</span>
<span class="term-fg32">+			valid: true,</span>
<span class="term-fg32">+		},</span>
<span class="term-fg32">+		{</span>
<span class="term-fg32">+			name: &quot;Nil Values&quot;,</span>
<span class="term-fg32">+			modifier: func(tx *RPCTransaction) {</span>
<span class="term-fg32">+				tx.V = nil</span>
<span class="term-fg32">+				tx.R = nil</span>
<span class="term-fg32">+				tx.S = nil</span>
<span class="term-fg32">+				tx.GasPrice = nil</span>
<span class="term-fg32">+			},</span>
<span class="term-fg32">+			valid: true,</span>
<span class="term-fg32">+		},</span>
<span class="term-fg32">+		{</span>
<span class="term-fg32">+			name: &quot;Non-Zero GasPrice&quot;,</span>
<span class="term-fg32">+			modifier: func(tx *RPCTransaction) {</span>
<span class="term-fg32">+				tx.GasPrice = (*hexutil.Big)(big.NewInt(43))</span>
<span class="term-fg32">+			},</span>
<span class="term-fg32">+			valid: false,</span>
<span class="term-fg32">+		},</span>
<span class="term-fg32">+		{</span>
<span class="term-fg32">+			name: &quot;Non-Zero V&quot;,</span>
<span class="term-fg32">+			modifier: func(tx *RPCTransaction) {</span>
<span class="term-fg32">+				tx.V = (*hexutil.Big)(big.NewInt(43))</span>
<span class="term-fg32">+			},</span>
<span class="term-fg32">+			valid: false,</span>
<span class="term-fg32">+		},</span>
<span class="term-fg32">+		{</span>
<span class="term-fg32">+			name: &quot;Non-Zero R&quot;,</span>
<span class="term-fg32">+			modifier: func(tx *RPCTransaction) {</span>
<span class="term-fg32">+				tx.R = (*hexutil.Big)(big.NewInt(43))</span>
<span class="term-fg32">+			},</span>
<span class="term-fg32">+			valid: false,</span>
<span class="term-fg32">+		},</span>
<span class="term-fg32">+		{</span>
<span class="term-fg32">+			name: &quot;Non-Zero S&quot;,</span>
<span class="term-fg32">+			modifier: func(tx *RPCTransaction) {</span>
<span class="term-fg32">+				tx.S = (*hexutil.Big)(big.NewInt(43))</span>
<span class="term-fg32">+			},</span>
<span class="term-fg32">+			valid: false,</span>
<span class="term-fg32">+		},</span>
<span class="term-fg32">+		{</span>
<span class="term-fg32">+			name: &quot;Non-nil deposit receipt version&quot;,</span>
<span class="term-fg32">+			modifier: func(tx *RPCTransaction) {</span>
<span class="term-fg32">+				tx.DepositReceiptVersion = &amp;version</span>
<span class="term-fg32">+			},</span>
<span class="term-fg32">+			valid: true,</span>
<span class="term-fg32">+		},</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	for _, test := range tests {</span>
<span class="term-fg32">+		t.Run(test.name, func(t *testing.T) {</span>
<span class="term-fg32">+			tx := types.NewTx(&amp;types.DepositTx{</span>
<span class="term-fg32">+				SourceHash:          common.HexToHash(&quot;0x1234&quot;),</span>
<span class="term-fg32">+				IsSystemTransaction: true,</span>
<span class="term-fg32">+				Mint:                big.NewInt(34),</span>
<span class="term-fg32">+			})</span>
<span class="term-fg32">+			rpcTx := newRPCTransaction(tx, common.Hash{}, uint64(12), uint64(1234), uint64(1), big.NewInt(0), &amp;params.ChainConfig{}, nil)</span>
<span class="term-fg32">+			test.modifier(rpcTx)</span>
<span class="term-fg32">+			json, err := json.Marshal(rpcTx)</span>
<span class="term-fg32">+			require.NoError(t, err, &quot;marshalling failed: %w&quot;, err)</span>
<span class="term-fg32">+			parsed := &amp;types.Transaction{}</span>
<span class="term-fg32">+			err = parsed.UnmarshalJSON(json)</span>
<span class="term-fg32">+			if test.valid {</span>
<span class="term-fg32">+				require.NoError(t, err, &quot;unmarshal failed: %w&quot;, err)</span>
<span class="term-fg32">+			} else {</span>
<span class="term-fg32">+				require.Error(t, err, &quot;unmarshal should have failed but did not&quot;)</span>
<span class="term-fg32">+			}</span>
<span class="term-fg32">+		})</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
 func testTransactionMarshal(t *testing.T, tests []txData, config *params.ChainConfig) {
 	t.Parallel()
 	var (
<span class="term-fg36">@@ -76,7 +235,7 @@</span> 			t.Fatalf(&quot;test %d: stx changed, want %x have %x&quot;, i, want, have)
 		}
&nbsp;
 		&#47;&#47; rpcTransaction
<span class="term-fg31">-		rpcTx := newRPCTransaction(tx, common.Hash{}, 0, 0, 0, nil, config)</span>
<span class="term-fg32">+		rpcTx := newRPCTransaction(tx, common.Hash{}, 0, 0, 0, nil, config, nil)</span>
 		if data, err := json.Marshal(rpcTx); err != nil {
 			t.Fatalf(&quot;test %d: marshalling failed; %v&quot;, i, err)
 		} else if err = tx2.UnmarshalJSON(data); err != nil {
<span class="term-fg36">@@ -542,7 +701,7 @@</span> 	if vmConfig == nil {
 		vmConfig = b.chain.GetVMConfig()
 	}
 	txContext := core.NewEVMTxContext(msg)
<span class="term-fg31">-	context := core.NewEVMBlockContext(header, b.chain, nil)</span>
<span class="term-fg32">+	context := core.NewEVMBlockContext(header, b.chain, nil, b.ChainConfig(), state)</span>
 	if blockContext != nil {
 		context = *blockContext
 	}
<span class="term-fg36">@@ -597,6 +756,12 @@</span> func (b testBackend) BloomStatus() (uint64, uint64) { panic(&quot;implement me&quot;) }
 func (b testBackend) ServiceFilter(ctx context.Context, session *bloombits.MatcherSession) {
 	panic(&quot;implement me&quot;)
 }
<span class="term-fg32">+func (b testBackend) HistoricalRPCService() *rpc.Client {</span>
<span class="term-fg32">+	panic(&quot;implement me&quot;)</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+func (b testBackend) Genesis() *types.Block {</span>
<span class="term-fg32">+	panic(&quot;implement me&quot;)</span>
<span class="term-fg32">+}</span>
&nbsp;
 func TestEstimateGas(t *testing.T) {
 	t.Parallel()
<span class="term-fg36">@@ -763,7 +928,7 @@</span> 				From:  &amp;accounts[0].addr,
 				To:    &amp;accounts[1].addr,
 				Value: (*hexutil.Big)(big.NewInt(1000)),
 			},
<span class="term-fg31">-			expectErr: errors.New(&quot;header not found&quot;),</span>
<span class="term-fg32">+			expectErr: ethereum.NotFound,</span>
 		},
 		&#47;&#47; transfer on the latest block
 		{
<span class="term-fg36">@@ -846,7 +1011,7 @@</span> 			want:           &quot;0x000000000000000000000000000000000000000000000000000000000000000b&quot;,
 		},
 	}
 	for i, tc := range testSuite {
<span class="term-fg31">-		result, err := api.Call(context.Background(), tc.call, rpc.BlockNumberOrHash{BlockNumber: &amp;tc.blockNumber}, &amp;tc.overrides, &amp;tc.blockOverrides)</span>
<span class="term-fg32">+		result, err := api.Call(context.Background(), tc.call, &amp;rpc.BlockNumberOrHash{BlockNumber: &amp;tc.blockNumber}, &amp;tc.overrides, &amp;tc.blockOverrides)</span>
 		if tc.expectErr != nil {
 			if err == nil {
 				t.Errorf(&quot;test %d: want error %v, have nothing&quot;, i, tc.expectErr)
<span class="term-fg36">@@ -1043,7 +1208,7 @@</span> 						&quot;to&quot;: &quot;0x0000000000000000000000000000000000000011&quot;,
 						&quot;transactionIndex&quot;: &quot;0x1&quot;,
 						&quot;value&quot;: &quot;0x6f&quot;,
 						&quot;type&quot;: &quot;0x0&quot;,
<span class="term-fg31">-						&quot;chainId&quot;: &quot;0x7fffffffffffffee&quot;,</span>
<span class="term-fg32">+						&quot;chainId&quot;: &quot;0x1&quot;,</span>
 						&quot;v&quot;: &quot;0x0&quot;,
 						&quot;r&quot;: &quot;0x0&quot;,
 						&quot;s&quot;: &quot;0x0&quot;
<span class="term-fg36">@@ -1081,7 +1246,7 @@</span> 						&quot;to&quot;: &quot;0x0000000000000000000000000000000000000011&quot;,
 						&quot;transactionIndex&quot;: &quot;0x3&quot;,
 						&quot;value&quot;: &quot;0x6f&quot;,
 						&quot;type&quot;: &quot;0x0&quot;,
<span class="term-fg31">-						&quot;chainId&quot;: &quot;0x7fffffffffffffee&quot;,</span>
<span class="term-fg32">+						&quot;chainId&quot;: &quot;0x1&quot;,</span>
 						&quot;v&quot;: &quot;0x0&quot;,
 						&quot;r&quot;: &quot;0x0&quot;,
 						&quot;s&quot;: &quot;0x0&quot;
<span class="term-fg36">@@ -1094,7 +1259,11 @@</span> 		},
 	}
&nbsp;
 	for i, tc := range testSuite {
<span class="term-fg31">-		resp := RPCMarshalBlock(block, tc.inclTx, tc.fullTx, params.MainnetChainConfig)</span>
<span class="term-fg32">+		resp, err := RPCMarshalBlock(context.Background(), block, tc.inclTx, tc.fullTx, params.MainnetChainConfig, testBackend{})</span>
<span class="term-fg32">+		if err != nil {</span>
<span class="term-fg32">+			t.Errorf(&quot;test %d: got error %v&quot;, i, err)</span>
<span class="term-fg32">+			continue</span>
<span class="term-fg32">+		}</span>
 		out, err := json.Marshal(resp)
 		if err != nil {
 			t.Errorf(&quot;test %d: json marshal error: %v&quot;, i, err)
<span class="term-fg36">@@ -1447,9 +1616,6 @@</span> 		}
 		if tx != nil {
 			b.AddTx(tx)
 			txHashes[i] = tx.Hash()
<span class="term-fg31">-		}</span>
<span class="term-fg31">-		if i == 5 {</span>
<span class="term-fg31">-			b.SetBlobGas(params.BlobTxBlobGasPerBlob)</span>
 		}
 		b.SetPoS()
 	})</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-f63b9aa4028b9015d791f637" role="button"
                   aria-expanded="false" aria-controls="id-f63b9aa4028b9015d791f637">
                    <code>light/odr.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/3f40e65c484486dea6cff80b7db178985d21a2c6/light/odr.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/650bb2f2b1dcfe30d9b1fa6f7dc9608055ed60e1/light/odr.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+4</span></div>
                        <div class="text-start"><span class="text-danger">-3</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-f63b9aa4028b9015d791f637"><span class="term-fg1">diff --git go-ethereum&#47;light&#47;odr.go op-geth&#47;light&#47;odr.go</span>
<span class="term-fg1">index 2597027435ba2fdf7e52add58e76015bdd43f125..39f626ee2c5368bf23ee41f21fe66aea1a6616eb 100644</span>
<span class="term-fg1">--- go-ethereum&#47;light&#47;odr.go</span>
<span class="term-fg1">+++ op-geth&#47;light&#47;odr.go</span>
<span class="term-fg36">@@ -27,6 +27,7 @@</span> 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;core&#47;rawdb&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;core&#47;txpool&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;core&#47;types&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;ethdb&quot;
<span class="term-fg32">+	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;trie&#47;trienode&quot;</span>
 )
&nbsp;
 &#47;&#47; NoOdr is the default context passed to an ODR capable function when the ODR
<span class="term-fg36">@@ -90,7 +91,7 @@</span> &#47;&#47; TrieRequest is the ODR request type for state&#47;storage trie entries
 type TrieRequest struct {
 	Id    *TrieID
 	Key   []byte
<span class="term-fg31">-	Proof *NodeSet</span>
<span class="term-fg32">+	Proof *trienode.ProofSet</span>
 }
&nbsp;
 &#47;&#47; StoreResult stores the retrieved data in local database
<span class="term-fg36">@@ -143,7 +144,7 @@</span> 	ChtNum, BlockNum uint64
 	ChtRoot          common.Hash
 	Header           *types.Header
 	Td               *big.Int
<span class="term-fg31">-	Proof            *NodeSet</span>
<span class="term-fg32">+	Proof            *trienode.ProofSet</span>
 }
&nbsp;
 &#47;&#47; StoreResult stores the retrieved data in local database
<span class="term-fg36">@@ -163,7 +164,7 @@</span> 	BitIdx           uint
 	SectionIndexList []uint64
 	BloomTrieRoot    common.Hash
 	BloomBits        [][]byte
<span class="term-fg31">-	Proofs           *NodeSet</span>
<span class="term-fg32">+	Proofs           *trienode.ProofSet</span>
 }
&nbsp;
 &#47;&#47; StoreResult stores the retrieved data in local database</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-257211c7a838eb4b731d3063" role="button"
                   aria-expanded="false" aria-controls="id-257211c7a838eb4b731d3063">
                    <code>light/odr_test.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/3f40e65c484486dea6cff80b7db178985d21a2c6/light/odr_test.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/650bb2f2b1dcfe30d9b1fa6f7dc9608055ed60e1/light/odr_test.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+3</span></div>
                        <div class="text-start"><span class="text-danger">-2</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-257211c7a838eb4b731d3063"><span class="term-fg1">diff --git go-ethereum&#47;light&#47;odr_test.go op-geth&#47;light&#47;odr_test.go</span>
<span class="term-fg1">index d8a7f1067556a15a1cde87b95b72f749325fd8eb..b8fd99b3e1633bdd7faea7191486d8854c88712b 100644</span>
<span class="term-fg1">--- go-ethereum&#47;light&#47;odr_test.go</span>
<span class="term-fg1">+++ op-geth&#47;light&#47;odr_test.go</span>
<span class="term-fg36">@@ -37,6 +37,7 @@</span> 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;ethdb&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;params&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;rlp&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;trie&quot;
<span class="term-fg32">+	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;trie&#47;trienode&quot;</span>
 )
&nbsp;
 var (
<span class="term-fg36">@@ -95,7 +96,7 @@</span> 		}
 		if err != nil {
 			panic(err)
 		}
<span class="term-fg31">-		nodes := NewNodeSet()</span>
<span class="term-fg32">+		nodes := trienode.NewProofSet()</span>
 		t.Prove(req.Key, nodes)
 		req.Proof = nodes
 	case *CodeRequest:
<span class="term-fg36">@@ -213,7 +214,7 @@</span> 			Data:              data,
 			SkipAccountChecks: true,
 		}
 		txContext := core.NewEVMTxContext(msg)
<span class="term-fg31">-		context := core.NewEVMBlockContext(header, chain, nil)</span>
<span class="term-fg32">+		context := core.NewEVMBlockContext(header, chain, nil, config, st)</span>
 		vmenv := vm.NewEVM(context, txContext, st, config, vm.Config{NoBaseFee: true})
 		gp := new(core.GasPool).AddGas(math.MaxUint64)
 		result, _ := core.ApplyMessage(vmenv, msg, gp)</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-c20065111f73e1cb9bbc8469" role="button"
                   aria-expanded="false" aria-controls="id-c20065111f73e1cb9bbc8469">
                    <code>light/postprocess.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/3f40e65c484486dea6cff80b7db178985d21a2c6/light/postprocess.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/650bb2f2b1dcfe30d9b1fa6f7dc9608055ed60e1/light/postprocess.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+1</span></div>
                        <div class="text-start"><span class="text-danger">-1</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-c20065111f73e1cb9bbc8469"><span class="term-fg1">diff --git go-ethereum&#47;light&#47;postprocess.go op-geth&#47;light&#47;postprocess.go</span>
<span class="term-fg1">index 13d75f8617ae6acd0ea092e7680367f9beff8e0b..a317e30b90a45c1dbb15dfb9985a96048f3182aa 100644</span>
<span class="term-fg1">--- go-ethereum&#47;light&#47;postprocess.go</span>
<span class="term-fg1">+++ op-geth&#47;light&#47;postprocess.go</span>
<span class="term-fg36">@@ -363,7 +363,7 @@</span> &#47;&#47; ODR backend in order to be able to add new entries and calculate subsequent root hashes
 func (b *BloomTrieIndexerBackend) fetchMissingNodes(ctx context.Context, section uint64, root common.Hash) error {
 	indexCh := make(chan uint, types.BloomBitLength)
 	type res struct {
<span class="term-fg31">-		nodes *NodeSet</span>
<span class="term-fg32">+		nodes *trienode.ProofSet</span>
 		err   error
 	}
 	resCh := make(chan res, types.BloomBitLength)</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-04ea4352b8b90ad16b97017f" role="button"
                   aria-expanded="false" aria-controls="id-04ea4352b8b90ad16b97017f">
                    <code>params/config_test.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/3f40e65c484486dea6cff80b7db178985d21a2c6/params/config_test.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/650bb2f2b1dcfe30d9b1fa6f7dc9608055ed60e1/params/config_test.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+19</span></div>
                        <div class="text-start"><span class="text-danger">-0</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-04ea4352b8b90ad16b97017f"><span class="term-fg1">diff --git go-ethereum&#47;params&#47;config_test.go op-geth&#47;params&#47;config_test.go</span>
<span class="term-fg1">index bf8ce2fc5e247242615ff478a455785f9f07f88b..14d7f833bb978c2bb7cefc70cff2015079c9a04a 100644</span>
<span class="term-fg1">--- go-ethereum&#47;params&#47;config_test.go</span>
<span class="term-fg1">+++ op-geth&#47;params&#47;config_test.go</span>
<span class="term-fg36">@@ -137,3 +137,22 @@</span> 	if r := c.Rules(big.NewInt(0), true, stamp); !r.IsShanghai {
 		t.Errorf(&quot;expected %v to be shanghai&quot;, stamp)
 	}
 }
<span class="term-fg32">+</span>
<span class="term-fg32">+func TestConfigRulesRegolith(t *testing.T) {</span>
<span class="term-fg32">+	c := &amp;ChainConfig{</span>
<span class="term-fg32">+		RegolithTime: newUint64(500),</span>
<span class="term-fg32">+		Optimism:     &amp;OptimismConfig{},</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	var stamp uint64</span>
<span class="term-fg32">+	if r := c.Rules(big.NewInt(0), true, stamp); r.IsOptimismRegolith {</span>
<span class="term-fg32">+		t.Errorf(&quot;expected %v to not be regolith&quot;, stamp)</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	stamp = 500</span>
<span class="term-fg32">+	if r := c.Rules(big.NewInt(0), true, stamp); !r.IsOptimismRegolith {</span>
<span class="term-fg32">+		t.Errorf(&quot;expected %v to be regolith&quot;, stamp)</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	stamp = math.MaxInt64</span>
<span class="term-fg32">+	if r := c.Rules(big.NewInt(0), true, stamp); !r.IsOptimismRegolith {</span>
<span class="term-fg32">+		t.Errorf(&quot;expected %v to be regolith&quot;, stamp)</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+}</span></div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-fd5a36c3ef315a0bd9a3825a" role="button"
                   aria-expanded="false" aria-controls="id-fd5a36c3ef315a0bd9a3825a">
                    <code>params/superchain_test.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <span class="text-muted">(new)</span>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/650bb2f2b1dcfe30d9b1fa6f7dc9608055ed60e1/params/superchain_test.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+172</span></div>
                        <div class="text-start"><span class="text-danger">-0</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-fd5a36c3ef315a0bd9a3825a"><span class="term-fg1">diff --git go-ethereum&#47;params&#47;superchain_test.go op-geth&#47;params&#47;superchain_test.go</span>
<span class="term-fg1">new file mode 100644</span>
<span class="term-fg1">index 0000000000000000000000000000000000000000..abb72bbd351f4c0a99ea8b78deac222a816a9ccc</span>
<span class="term-fg1">--- &#47;dev&#47;null</span>
<span class="term-fg1">+++ op-geth&#47;params&#47;superchain_test.go</span>
<span class="term-fg36">@@ -0,0 +1,172 @@</span>
<span class="term-fg32">+package params</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+import (</span>
<span class="term-fg32">+	&quot;fmt&quot;</span>
<span class="term-fg32">+	&quot;testing&quot;</span>
<span class="term-fg32">+)</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+type HumanProtocolVersion struct {</span>
<span class="term-fg32">+	VersionType         uint8</span>
<span class="term-fg32">+	Major, Minor, Patch uint32</span>
<span class="term-fg32">+	Prerelease          uint32</span>
<span class="term-fg32">+	Build               [8]byte</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+type ComparisonCase struct {</span>
<span class="term-fg32">+	A, B HumanProtocolVersion</span>
<span class="term-fg32">+	Cmp  ProtocolVersionComparison</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func TestProtocolVersion_Compare(t *testing.T) {</span>
<span class="term-fg32">+	testCases := []ComparisonCase{</span>
<span class="term-fg32">+		{</span>
<span class="term-fg32">+			A:   HumanProtocolVersion{0, 2, 1, 1, 1, [8]byte{}},</span>
<span class="term-fg32">+			B:   HumanProtocolVersion{0, 1, 2, 2, 2, [8]byte{}},</span>
<span class="term-fg32">+			Cmp: AheadMajor,</span>
<span class="term-fg32">+		},</span>
<span class="term-fg32">+		{</span>
<span class="term-fg32">+			A:   HumanProtocolVersion{0, 1, 2, 1, 1, [8]byte{}},</span>
<span class="term-fg32">+			B:   HumanProtocolVersion{0, 1, 1, 2, 2, [8]byte{}},</span>
<span class="term-fg32">+			Cmp: AheadMinor,</span>
<span class="term-fg32">+		},</span>
<span class="term-fg32">+		{</span>
<span class="term-fg32">+			A:   HumanProtocolVersion{0, 1, 1, 2, 1, [8]byte{}},</span>
<span class="term-fg32">+			B:   HumanProtocolVersion{0, 1, 1, 1, 2, [8]byte{}},</span>
<span class="term-fg32">+			Cmp: AheadPatch,</span>
<span class="term-fg32">+		},</span>
<span class="term-fg32">+		{</span>
<span class="term-fg32">+			A:   HumanProtocolVersion{0, 1, 1, 1, 2, [8]byte{}},</span>
<span class="term-fg32">+			B:   HumanProtocolVersion{0, 1, 1, 1, 1, [8]byte{}},</span>
<span class="term-fg32">+			Cmp: AheadPrerelease,</span>
<span class="term-fg32">+		},</span>
<span class="term-fg32">+		{</span>
<span class="term-fg32">+			A:   HumanProtocolVersion{0, 1, 2, 3, 4, [8]byte{}},</span>
<span class="term-fg32">+			B:   HumanProtocolVersion{0, 1, 2, 3, 4, [8]byte{}},</span>
<span class="term-fg32">+			Cmp: Matching,</span>
<span class="term-fg32">+		},</span>
<span class="term-fg32">+		{</span>
<span class="term-fg32">+			A:   HumanProtocolVersion{0, 3, 2, 1, 5, [8]byte{3}},</span>
<span class="term-fg32">+			B:   HumanProtocolVersion{1, 1, 2, 3, 3, [8]byte{6}},</span>
<span class="term-fg32">+			Cmp: DiffVersionType,</span>
<span class="term-fg32">+		},</span>
<span class="term-fg32">+		{</span>
<span class="term-fg32">+			A:   HumanProtocolVersion{0, 3, 2, 1, 5, [8]byte{3}},</span>
<span class="term-fg32">+			B:   HumanProtocolVersion{0, 1, 2, 3, 3, [8]byte{6}},</span>
<span class="term-fg32">+			Cmp: DiffBuild,</span>
<span class="term-fg32">+		},</span>
<span class="term-fg32">+		{</span>
<span class="term-fg32">+			A:   HumanProtocolVersion{0, 0, 0, 0, 0, [8]byte{}},</span>
<span class="term-fg32">+			B:   HumanProtocolVersion{0, 1, 3, 3, 3, [8]byte{3}},</span>
<span class="term-fg32">+			Cmp: EmptyVersion,</span>
<span class="term-fg32">+		},</span>
<span class="term-fg32">+		{</span>
<span class="term-fg32">+			A:   HumanProtocolVersion{0, 4, 0, 0, 0, [8]byte{}},</span>
<span class="term-fg32">+			B:   HumanProtocolVersion{0, 4, 0, 0, 1, [8]byte{}},</span>
<span class="term-fg32">+			Cmp: AheadMajor,</span>
<span class="term-fg32">+		},</span>
<span class="term-fg32">+		{</span>
<span class="term-fg32">+			A:   HumanProtocolVersion{0, 4, 1, 0, 0, [8]byte{}},</span>
<span class="term-fg32">+			B:   HumanProtocolVersion{0, 4, 1, 0, 1, [8]byte{}},</span>
<span class="term-fg32">+			Cmp: AheadMinor,</span>
<span class="term-fg32">+		},</span>
<span class="term-fg32">+		{</span>
<span class="term-fg32">+			A:   HumanProtocolVersion{0, 4, 0, 1, 0, [8]byte{}},</span>
<span class="term-fg32">+			B:   HumanProtocolVersion{0, 4, 0, 1, 1, [8]byte{}},</span>
<span class="term-fg32">+			Cmp: AheadPatch,</span>
<span class="term-fg32">+		},</span>
<span class="term-fg32">+		{</span>
<span class="term-fg32">+			A:   HumanProtocolVersion{0, 4, 0, 0, 2, [8]byte{}},</span>
<span class="term-fg32">+			B:   HumanProtocolVersion{0, 4, 0, 0, 1, [8]byte{}},</span>
<span class="term-fg32">+			Cmp: AheadPrerelease,</span>
<span class="term-fg32">+		},</span>
<span class="term-fg32">+		{</span>
<span class="term-fg32">+			A:   HumanProtocolVersion{0, 4, 1, 0, 1, [8]byte{}},</span>
<span class="term-fg32">+			B:   HumanProtocolVersion{0, 4, 0, 0, 0, [8]byte{}},</span>
<span class="term-fg32">+			Cmp: AheadPatch,</span>
<span class="term-fg32">+		},</span>
<span class="term-fg32">+		{</span>
<span class="term-fg32">+			A:   HumanProtocolVersion{0, 4, 0, 1, 1, [8]byte{}},</span>
<span class="term-fg32">+			B:   HumanProtocolVersion{0, 4, 0, 0, 0, [8]byte{}},</span>
<span class="term-fg32">+			Cmp: AheadPrerelease,</span>
<span class="term-fg32">+		},</span>
<span class="term-fg32">+		{</span>
<span class="term-fg32">+			A:   HumanProtocolVersion{0, 4, 1, 1, 1, [8]byte{}},</span>
<span class="term-fg32">+			B:   HumanProtocolVersion{0, 4, 0, 0, 0, [8]byte{}},</span>
<span class="term-fg32">+			Cmp: AheadMinor,</span>
<span class="term-fg32">+		},</span>
<span class="term-fg32">+		{</span>
<span class="term-fg32">+			A:   HumanProtocolVersion{0, 4, 0, 2, 1, [8]byte{}},</span>
<span class="term-fg32">+			B:   HumanProtocolVersion{0, 4, 0, 0, 0, [8]byte{}},</span>
<span class="term-fg32">+			Cmp: AheadPatch,</span>
<span class="term-fg32">+		},</span>
<span class="term-fg32">+		{</span>
<span class="term-fg32">+			A:   HumanProtocolVersion{0, 5, 0, 1, 1, [8]byte{}},</span>
<span class="term-fg32">+			B:   HumanProtocolVersion{0, 4, 0, 0, 0, [8]byte{}},</span>
<span class="term-fg32">+			Cmp: AheadMajor,</span>
<span class="term-fg32">+		},</span>
<span class="term-fg32">+		{</span>
<span class="term-fg32">+			A:   HumanProtocolVersion{0, 1, 0, 0, 1, [8]byte{}},</span>
<span class="term-fg32">+			B:   HumanProtocolVersion{0, 0, 9, 0, 0, [8]byte{}},</span>
<span class="term-fg32">+			Cmp: AheadMinor,</span>
<span class="term-fg32">+		},</span>
<span class="term-fg32">+		{</span>
<span class="term-fg32">+			A:   HumanProtocolVersion{0, 0, 1, 0, 1, [8]byte{}},</span>
<span class="term-fg32">+			B:   HumanProtocolVersion{0, 0, 0, 9, 0, [8]byte{}},</span>
<span class="term-fg32">+			Cmp: AheadPatch,</span>
<span class="term-fg32">+		},</span>
<span class="term-fg32">+		{</span>
<span class="term-fg32">+			A:   HumanProtocolVersion{0, 1, ^uint32(0), 0, 1, [8]byte{}},</span>
<span class="term-fg32">+			B:   HumanProtocolVersion{0, 0, 1, 0, 0, [8]byte{}},</span>
<span class="term-fg32">+			Cmp: InvalidVersion,</span>
<span class="term-fg32">+		},</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	for i, tc := range testCases {</span>
<span class="term-fg32">+		tc := tc &#47;&#47; not a parallel sub-test, but better than a flake</span>
<span class="term-fg32">+		t.Run(fmt.Sprintf(&quot;case_%d&quot;, i), func(t *testing.T) {</span>
<span class="term-fg32">+			a := ProtocolVersionV0{tc.A.Build, tc.A.Major, tc.A.Minor, tc.A.Patch, tc.A.Prerelease}.Encode()</span>
<span class="term-fg32">+			a[0] = tc.A.VersionType</span>
<span class="term-fg32">+			b := ProtocolVersionV0{tc.B.Build, tc.B.Major, tc.B.Minor, tc.B.Patch, tc.B.Prerelease}.Encode()</span>
<span class="term-fg32">+			b[0] = tc.B.VersionType</span>
<span class="term-fg32">+			cmp := a.Compare(b)</span>
<span class="term-fg32">+			if cmp != tc.Cmp {</span>
<span class="term-fg32">+				t.Fatalf(&quot;expected %d but got %d&quot;, tc.Cmp, cmp)</span>
<span class="term-fg32">+			}</span>
<span class="term-fg32">+			switch tc.Cmp {</span>
<span class="term-fg32">+			case AheadMajor, AheadMinor, AheadPatch, AheadPrerelease:</span>
<span class="term-fg32">+				inv := b.Compare(a)</span>
<span class="term-fg32">+				if inv != -tc.Cmp {</span>
<span class="term-fg32">+					t.Fatalf(&quot;expected inverse when reversing the comparison, %d but got %d&quot;, -tc.Cmp, inv)</span>
<span class="term-fg32">+				}</span>
<span class="term-fg32">+			case DiffVersionType, DiffBuild, EmptyVersion, Matching:</span>
<span class="term-fg32">+				inv := b.Compare(a)</span>
<span class="term-fg32">+				if inv != tc.Cmp {</span>
<span class="term-fg32">+					t.Fatalf(&quot;expected comparison reversed to hold the same, expected %d but got %d&quot;, tc.Cmp, inv)</span>
<span class="term-fg32">+				}</span>
<span class="term-fg32">+			}</span>
<span class="term-fg32">+		})</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+func TestProtocolVersion_String(t *testing.T) {</span>
<span class="term-fg32">+	testCases := []struct {</span>
<span class="term-fg32">+		version  ProtocolVersion</span>
<span class="term-fg32">+		expected string</span>
<span class="term-fg32">+	}{</span>
<span class="term-fg32">+		{ProtocolVersionV0{[8]byte{}, 0, 0, 0, 0}.Encode(), &quot;v0.0.0&quot;},</span>
<span class="term-fg32">+		{ProtocolVersionV0{[8]byte{}, 0, 0, 0, 1}.Encode(), &quot;v0.0.0-1&quot;},</span>
<span class="term-fg32">+		{ProtocolVersionV0{[8]byte{}, 0, 0, 1, 0}.Encode(), &quot;v0.0.1&quot;},</span>
<span class="term-fg32">+		{ProtocolVersionV0{[8]byte{}, 4, 3, 2, 1}.Encode(), &quot;v4.3.2-1&quot;},</span>
<span class="term-fg32">+		{ProtocolVersionV0{[8]byte{}, 0, 100, 2, 0}.Encode(), &quot;v0.100.2&quot;},</span>
<span class="term-fg32">+		{ProtocolVersionV0{[8]byte{&#39;O&#39;, &#39;P&#39;, &#39;-&#39;, &#39;m&#39;, &#39;o&#39;, &#39;d&#39;}, 42, 0, 2, 1}.Encode(), &quot;v42.0.2-1+OP-mod&quot;},</span>
<span class="term-fg32">+		{ProtocolVersionV0{[8]byte{&#39;b&#39;, &#39;e&#39;, &#39;t&#39;, &#39;a&#39;, &#39;.&#39;, &#39;1&#39;, &#39;2&#39;, &#39;3&#39;}, 1, 0, 0, 0}.Encode(), &quot;v1.0.0+beta.123&quot;},</span>
<span class="term-fg32">+		{ProtocolVersionV0{[8]byte{&#39;a&#39;, &#39;b&#39;, 1}, 42, 0, 2, 0}.Encode(), &quot;v42.0.2+0x6162010000000000&quot;}, &#47;&#47; do not render invalid alpha numeric</span>
<span class="term-fg32">+		{ProtocolVersionV0{[8]byte{1, 2, 3, 4, 5, 6, 7, 8}, 42, 0, 2, 0}.Encode(), &quot;v42.0.2+0x0102030405060708&quot;},</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	for _, tc := range testCases {</span>
<span class="term-fg32">+		t.Run(tc.expected, func(t *testing.T) {</span>
<span class="term-fg32">+			got := tc.version.String()</span>
<span class="term-fg32">+			if got != tc.expected {</span>
<span class="term-fg32">+				t.Fatalf(&quot;got %q but expected %q&quot;, got, tc.expected)</span>
<span class="term-fg32">+			}</span>
<span class="term-fg32">+		})</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+}</span></div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-1f3e68dafce030e844dfa9f8" role="button"
                   aria-expanded="false" aria-controls="id-1f3e68dafce030e844dfa9f8">
                    <code>rpc/client_opt.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/3f40e65c484486dea6cff80b7db178985d21a2c6/rpc/client_opt.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/650bb2f2b1dcfe30d9b1fa6f7dc9608055ed60e1/rpc/client_opt.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+10</span></div>
                        <div class="text-start"><span class="text-danger">-1</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-1f3e68dafce030e844dfa9f8"><span class="term-fg1">diff --git go-ethereum&#47;rpc&#47;client_opt.go op-geth&#47;rpc&#47;client_opt.go</span>
<span class="term-fg1">index 5bef08cca8410bf22cf949886b912acf755f6fda..3fa045a9b9f39076d0ed62f845eb0e3864bba241 100644</span>
<span class="term-fg1">--- go-ethereum&#47;rpc&#47;client_opt.go</span>
<span class="term-fg1">+++ op-geth&#47;rpc&#47;client_opt.go</span>
<span class="term-fg36">@@ -34,7 +34,8 @@</span> 	httpHeaders http.Header
 	httpAuth    HTTPAuth
&nbsp;
 	&#47;&#47; WebSocket options
<span class="term-fg31">-	wsDialer *websocket.Dialer</span>
<span class="term-fg32">+	wsDialer           *websocket.Dialer</span>
<span class="term-fg32">+	wsMessageSizeLimit *int64 &#47;&#47; wsMessageSizeLimit nil = default, 0 = no limit</span>
&nbsp;
 	&#47;&#47; RPC handler options
 	idgen              func() ID
<span class="term-fg36">@@ -63,6 +64,14 @@</span> &#47;&#47; WithWebsocketDialer configures the websocket.Dialer used by the RPC client.
 func WithWebsocketDialer(dialer websocket.Dialer) ClientOption {
 	return optionFunc(func(cfg *clientConfig) {
 		cfg.wsDialer = &amp;dialer
<span class="term-fg32">+	})</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+&#47;&#47; WithWebsocketMessageSizeLimit configures the websocket message size limit used by the RPC</span>
<span class="term-fg32">+&#47;&#47; client. Passing a limit of 0 means no limit.</span>
<span class="term-fg32">+func WithWebsocketMessageSizeLimit(messageSizeLimit int64) ClientOption {</span>
<span class="term-fg32">+	return optionFunc(func(cfg *clientConfig) {</span>
<span class="term-fg32">+		cfg.wsMessageSizeLimit = &amp;messageSizeLimit</span>
 	})
 }
</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-8183ff825159e1aa9405757b" role="button"
                   aria-expanded="false" aria-controls="id-8183ff825159e1aa9405757b">
                    <code>rpc/http.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/3f40e65c484486dea6cff80b7db178985d21a2c6/rpc/http.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/650bb2f2b1dcfe30d9b1fa6f7dc9608055ed60e1/rpc/http.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+1</span></div>
                        <div class="text-start"><span class="text-danger">-1</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-8183ff825159e1aa9405757b"><span class="term-fg1">diff --git go-ethereum&#47;rpc&#47;http.go op-geth&#47;rpc&#47;http.go</span>
<span class="term-fg1">index 741fa1c0eb4f63ed864dc406685d91b9707dbfe3..19e44a2e8cd2f433e9e939b953a97c18cf1e1806 100644</span>
<span class="term-fg1">--- go-ethereum&#47;rpc&#47;http.go</span>
<span class="term-fg1">+++ op-geth&#47;rpc&#47;http.go</span>
<span class="term-fg36">@@ -33,7 +33,7 @@</span> 	&quot;time&quot;
 )
&nbsp;
 const (
<span class="term-fg31">-	maxRequestContentLength = 1024 * 1024 * 5</span>
<span class="term-fg32">+	maxRequestContentLength = 1024 * 1024 * 32</span>
 	contentType             = &quot;application&#47;json&quot;
 )
</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-f529f3fdab69b03a3f68121c" role="button"
                   aria-expanded="false" aria-controls="id-f529f3fdab69b03a3f68121c">
                    <code>rpc/server_test.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/3f40e65c484486dea6cff80b7db178985d21a2c6/rpc/server_test.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/650bb2f2b1dcfe30d9b1fa6f7dc9608055ed60e1/rpc/server_test.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+5</span></div>
                        <div class="text-start"><span class="text-danger">-4</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-f529f3fdab69b03a3f68121c"><span class="term-fg1">diff --git go-ethereum&#47;rpc&#47;server_test.go op-geth&#47;rpc&#47;server_test.go</span>
<span class="term-fg1">index 5d3929dfdc692652ea577a5d56e8f8f804967ac8..9d1c7fb5f0fe730ff946698707647913a5ed93ac 100644</span>
<span class="term-fg1">--- go-ethereum&#47;rpc&#47;server_test.go</span>
<span class="term-fg1">+++ op-geth&#47;rpc&#47;server_test.go</span>
<span class="term-fg36">@@ -32,7 +32,8 @@</span> func TestServerRegisterName(t *testing.T) {
 	server := NewServer()
 	service := new(testService)
&nbsp;
<span class="term-fg31">-	if err := server.RegisterName(&quot;test&quot;, service); err != nil {</span>
<span class="term-fg32">+	svcName := &quot;test&quot;</span>
<span class="term-fg32">+	if err := server.RegisterName(svcName, service); err != nil {</span>
 		t.Fatalf(&quot;%v&quot;, err)
 	}
&nbsp;
<span class="term-fg36">@@ -40,12 +41,12 @@</span> 	if len(server.services.services) != 2 {
 		t.Fatalf(&quot;Expected 2 service entries, got %d&quot;, len(server.services.services))
 	}
&nbsp;
<span class="term-fg31">-	svc, ok := server.services.services[&quot;test&quot;]</span>
<span class="term-fg32">+	svc, ok := server.services.services[svcName]</span>
 	if !ok {
<span class="term-fg31">-		t.Fatalf(&quot;Expected service calc to be registered&quot;)</span>
<span class="term-fg32">+		t.Fatalf(&quot;Expected service %s to be registered&quot;, svcName)</span>
 	}
&nbsp;
<span class="term-fg31">-	wantCallbacks := 13</span>
<span class="term-fg32">+	wantCallbacks := 14</span>
 	if len(svc.callbacks) != wantCallbacks {
 		t.Errorf(&quot;Expected %d callbacks for service &#39;service&#39;, got %d&quot;, wantCallbacks, len(svc.callbacks))
 	}</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-2993eb7325984b96659567ef" role="button"
                   aria-expanded="false" aria-controls="id-2993eb7325984b96659567ef">
                    <code>rpc/testservice_test.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/3f40e65c484486dea6cff80b7db178985d21a2c6/rpc/testservice_test.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/650bb2f2b1dcfe30d9b1fa6f7dc9608055ed60e1/rpc/testservice_test.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+4</span></div>
                        <div class="text-start"><span class="text-danger">-0</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-2993eb7325984b96659567ef"><span class="term-fg1">diff --git go-ethereum&#47;rpc&#47;testservice_test.go op-geth&#47;rpc&#47;testservice_test.go</span>
<span class="term-fg1">index eab67f1dd5d8a7eeff07a601c0e8617dcd863d4f..7d873af6670e3e7696394bbeea7c4c8440f44bc0 100644</span>
<span class="term-fg1">--- go-ethereum&#47;rpc&#47;testservice_test.go</span>
<span class="term-fg1">+++ op-geth&#47;rpc&#47;testservice_test.go</span>
<span class="term-fg36">@@ -90,6 +90,10 @@</span> func (s *testService) EchoWithCtx(ctx context.Context, str string, i int, args *echoArgs) echoResult {
 	return echoResult{str, i, args}
 }
&nbsp;
<span class="term-fg32">+func (s *testService) Repeat(msg string, i int) string {</span>
<span class="term-fg32">+	return strings.Repeat(msg, i)</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
 func (s *testService) PeerInfo(ctx context.Context) PeerInfo {
 	return PeerInfoFromContext(ctx)
 }</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-93bcb68bd7e5b9691eba24a5" role="button"
                   aria-expanded="false" aria-controls="id-93bcb68bd7e5b9691eba24a5">
                    <code>rpc/types.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/3f40e65c484486dea6cff80b7db178985d21a2c6/rpc/types.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/650bb2f2b1dcfe30d9b1fa6f7dc9608055ed60e1/rpc/types.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+1</span></div>
                        <div class="text-start"><span class="text-danger">-2</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-93bcb68bd7e5b9691eba24a5"><span class="term-fg1">diff --git go-ethereum&#47;rpc&#47;types.go op-geth&#47;rpc&#47;types.go</span>
<span class="term-fg1">index 34a1451deaa725ab91d0317810d336a7f5014d2c..f88c37c59dadf6559e17d6a39372a8658189da1d 100644</span>
<span class="term-fg1">--- go-ethereum&#47;rpc&#47;types.go</span>
<span class="term-fg1">+++ op-geth&#47;rpc&#47;types.go</span>
<span class="term-fg36">@@ -21,7 +21,6 @@</span> 	&quot;context&quot;
 	&quot;encoding&#47;json&quot;
 	&quot;fmt&quot;
 	&quot;math&quot;
<span class="term-fg31">-	&quot;strconv&quot;</span>
 	&quot;strings&quot;
&nbsp;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;common&quot;
<span class="term-fg36">@@ -221,7 +220,7 @@</span> }
&nbsp;
 func (bnh *BlockNumberOrHash) String() string {
 	if bnh.BlockNumber != nil {
<span class="term-fg31">-		return strconv.Itoa(int(*bnh.BlockNumber))</span>
<span class="term-fg32">+		return bnh.BlockNumber.String()</span>
 	}
 	if bnh.BlockHash != nil {
 		return bnh.BlockHash.String()</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-efdb7e7a5d0cc0a61de5e340" role="button"
                   aria-expanded="false" aria-controls="id-efdb7e7a5d0cc0a61de5e340">
                    <code>rpc/types_test.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/3f40e65c484486dea6cff80b7db178985d21a2c6/rpc/types_test.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/650bb2f2b1dcfe30d9b1fa6f7dc9608055ed60e1/rpc/types_test.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+21</span></div>
                        <div class="text-start"><span class="text-danger">-0</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-efdb7e7a5d0cc0a61de5e340"><span class="term-fg1">diff --git go-ethereum&#47;rpc&#47;types_test.go op-geth&#47;rpc&#47;types_test.go</span>
<span class="term-fg1">index f110dee7c6ffe186161badef79d040b58ffa3ece..617f441d9166b53054108665a567b661c7e8fd8c 100644</span>
<span class="term-fg1">--- go-ethereum&#47;rpc&#47;types_test.go</span>
<span class="term-fg1">+++ op-geth&#47;rpc&#47;types_test.go</span>
<span class="term-fg36">@@ -153,3 +153,24 @@</span> 			}
 		})
 	}
 }
<span class="term-fg32">+</span>
<span class="term-fg32">+func TestBlockNumberOrHash_StringAndUnmarshal(t *testing.T) {</span>
<span class="term-fg32">+	tests := []BlockNumberOrHash{</span>
<span class="term-fg32">+		BlockNumberOrHashWithNumber(math.MaxInt64),</span>
<span class="term-fg32">+		BlockNumberOrHashWithNumber(PendingBlockNumber),</span>
<span class="term-fg32">+		BlockNumberOrHashWithNumber(LatestBlockNumber),</span>
<span class="term-fg32">+		BlockNumberOrHashWithNumber(EarliestBlockNumber),</span>
<span class="term-fg32">+		BlockNumberOrHashWithNumber(32),</span>
<span class="term-fg32">+		BlockNumberOrHashWithHash(common.Hash{0xaa}, false),</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	for _, want := range tests {</span>
<span class="term-fg32">+		marshalled, _ := json.Marshal(want.String())</span>
<span class="term-fg32">+		var have BlockNumberOrHash</span>
<span class="term-fg32">+		if err := json.Unmarshal(marshalled, &amp;have); err != nil {</span>
<span class="term-fg32">+			t.Fatalf(&quot;cannot unmarshal (%v): %v&quot;, string(marshalled), err)</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+		if !reflect.DeepEqual(want, have) {</span>
<span class="term-fg32">+			t.Fatalf(&quot;wrong result: have %v, want %v&quot;, have, want)</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+}</span></div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-beb221dae12e92870253d285" role="button"
                   aria-expanded="false" aria-controls="id-beb221dae12e92870253d285">
                    <code>rpc/websocket.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/3f40e65c484486dea6cff80b7db178985d21a2c6/rpc/websocket.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/650bb2f2b1dcfe30d9b1fa6f7dc9608055ed60e1/rpc/websocket.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+9</span></div>
                        <div class="text-start"><span class="text-danger">-5</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-beb221dae12e92870253d285"><span class="term-fg1">diff --git go-ethereum&#47;rpc&#47;websocket.go op-geth&#47;rpc&#47;websocket.go</span>
<span class="term-fg1">index 86cf50594c67cd46800c1b8e1e14840828beab69..538e53a31b7c363af28b6ec862ed163cbea05ed5 100644</span>
<span class="term-fg1">--- go-ethereum&#47;rpc&#47;websocket.go</span>
<span class="term-fg1">+++ op-geth&#47;rpc&#47;websocket.go</span>
<span class="term-fg36">@@ -38,7 +38,7 @@</span> 	wsWriteBuffer      = 1024
 	wsPingInterval     = 30 * time.Second
 	wsPingWriteTimeout = 5 * time.Second
 	wsPongTimeout      = 30 * time.Second
<span class="term-fg31">-	wsMessageSizeLimit = 32 * 1024 * 1024</span>
<span class="term-fg32">+	wsDefaultReadLimit = 32 * 1024 * 1024</span>
 )
&nbsp;
 var wsBufferPool = new(sync.Pool)
<span class="term-fg36">@@ -60,7 +60,7 @@</span> 		if err != nil {
 			log.Debug(&quot;WebSocket upgrade failed&quot;, &quot;err&quot;, err)
 			return
 		}
<span class="term-fg31">-		codec := newWebsocketCodec(conn, r.Host, r.Header)</span>
<span class="term-fg32">+		codec := newWebsocketCodec(conn, r.Host, r.Header, wsDefaultReadLimit)</span>
 		s.ServeCodec(codec, 0)
 	})
 }
<span class="term-fg36">@@ -251,7 +251,11 @@</span> 				hErr.status = resp.Status
 			}
 			return nil, hErr
 		}
<span class="term-fg31">-		return newWebsocketCodec(conn, dialURL, header), nil</span>
<span class="term-fg32">+		messageSizeLimit := int64(wsDefaultReadLimit)</span>
<span class="term-fg32">+		if cfg.wsMessageSizeLimit != nil &amp;&amp; *cfg.wsMessageSizeLimit &gt;= 0 {</span>
<span class="term-fg32">+			messageSizeLimit = *cfg.wsMessageSizeLimit</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+		return newWebsocketCodec(conn, dialURL, header, messageSizeLimit), nil</span>
 	}
 	return connect, nil
 }
<span class="term-fg36">@@ -283,8 +287,8 @@</span> 	pingReset    chan struct{}
 	pongReceived chan struct{}
 }
&nbsp;
<span class="term-fg31">-func newWebsocketCodec(conn *websocket.Conn, host string, req http.Header) ServerCodec {</span>
<span class="term-fg31">-	conn.SetReadLimit(wsMessageSizeLimit)</span>
<span class="term-fg32">+func newWebsocketCodec(conn *websocket.Conn, host string, req http.Header, readLimit int64) ServerCodec {</span>
<span class="term-fg32">+	conn.SetReadLimit(readLimit)</span>
 	encode := func(v interface{}, isErrorResponse bool) error {
 		return conn.WriteJSON(v)
 	}</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-2ab12acab82fab23e2c40ea6" role="button"
                   aria-expanded="false" aria-controls="id-2ab12acab82fab23e2c40ea6">
                    <code>rpc/websocket_test.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/3f40e65c484486dea6cff80b7db178985d21a2c6/rpc/websocket_test.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/650bb2f2b1dcfe30d9b1fa6f7dc9608055ed60e1/rpc/websocket_test.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+61</span></div>
                        <div class="text-start"><span class="text-danger">-1</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-2ab12acab82fab23e2c40ea6"><span class="term-fg1">diff --git go-ethereum&#47;rpc&#47;websocket_test.go op-geth&#47;rpc&#47;websocket_test.go</span>
<span class="term-fg1">index fb9357605b8b9ad34eae51a8876b7e5b3c6c9214..e4ac5c3fad3f0cfde8b59b261fc842167fcb7a13 100644</span>
<span class="term-fg1">--- go-ethereum&#47;rpc&#47;websocket_test.go</span>
<span class="term-fg1">+++ op-geth&#47;rpc&#47;websocket_test.go</span>
<span class="term-fg36">@@ -113,6 +113,66 @@</span> 		t.Fatal(&quot;no error for too large call&quot;)
 	}
 }
&nbsp;
<span class="term-fg32">+&#47;&#47; This test checks whether the wsMessageSizeLimit option is obeyed.</span>
<span class="term-fg32">+func TestWebsocketLargeRead(t *testing.T) {</span>
<span class="term-fg32">+	t.Parallel()</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	var (</span>
<span class="term-fg32">+		srv     = newTestServer()</span>
<span class="term-fg32">+		httpsrv = httptest.NewServer(srv.WebsocketHandler([]string{&quot;*&quot;}))</span>
<span class="term-fg32">+		wsURL   = &quot;ws:&quot; + strings.TrimPrefix(httpsrv.URL, &quot;http:&quot;)</span>
<span class="term-fg32">+	)</span>
<span class="term-fg32">+	defer srv.Stop()</span>
<span class="term-fg32">+	defer httpsrv.Close()</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	testLimit := func(limit *int64) {</span>
<span class="term-fg32">+		opts := []ClientOption{}</span>
<span class="term-fg32">+		expLimit := int64(wsDefaultReadLimit)</span>
<span class="term-fg32">+		if limit != nil &amp;&amp; *limit &gt;= 0 {</span>
<span class="term-fg32">+			opts = append(opts, WithWebsocketMessageSizeLimit(*limit))</span>
<span class="term-fg32">+			if *limit &gt; 0 {</span>
<span class="term-fg32">+				expLimit = *limit &#47;&#47; 0 means infinite</span>
<span class="term-fg32">+			}</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+		client, err := DialOptions(context.Background(), wsURL, opts...)</span>
<span class="term-fg32">+		if err != nil {</span>
<span class="term-fg32">+			t.Fatalf(&quot;can&#39;t dial: %v&quot;, err)</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+		defer client.Close()</span>
<span class="term-fg32">+		&#47;&#47; Remove some bytes for json encoding overhead.</span>
<span class="term-fg32">+		underLimit := int(expLimit - 128)</span>
<span class="term-fg32">+		overLimit := expLimit + 1</span>
<span class="term-fg32">+		if expLimit == wsDefaultReadLimit {</span>
<span class="term-fg32">+			&#47;&#47; No point trying the full 32MB in tests. Just sanity-check that</span>
<span class="term-fg32">+			&#47;&#47; it&#39;s not obviously limited.</span>
<span class="term-fg32">+			underLimit = 1024</span>
<span class="term-fg32">+			overLimit = -1</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+		var res string</span>
<span class="term-fg32">+		&#47;&#47; Check under limit</span>
<span class="term-fg32">+		if err = client.Call(&amp;res, &quot;test_repeat&quot;, &quot;A&quot;, underLimit); err != nil {</span>
<span class="term-fg32">+			t.Fatalf(&quot;unexpected error with limit %d: %v&quot;, expLimit, err)</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+		if len(res) != underLimit || strings.Count(res, &quot;A&quot;) != underLimit {</span>
<span class="term-fg32">+			t.Fatal(&quot;incorrect data&quot;)</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+		&#47;&#47; Check over limit</span>
<span class="term-fg32">+		if overLimit &gt; 0 {</span>
<span class="term-fg32">+			err = client.Call(&amp;res, &quot;test_repeat&quot;, &quot;A&quot;, expLimit+1)</span>
<span class="term-fg32">+			if err == nil || err != websocket.ErrReadLimit {</span>
<span class="term-fg32">+				t.Fatalf(&quot;wrong error with limit %d: %v expecting %v&quot;, expLimit, err, websocket.ErrReadLimit)</span>
<span class="term-fg32">+			}</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	ptr := func(v int64) *int64 { return &amp;v }</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	testLimit(ptr(-1)) &#47;&#47; Should be ignored (use default)</span>
<span class="term-fg32">+	testLimit(ptr(0))  &#47;&#47; Should be ignored (use default)</span>
<span class="term-fg32">+	testLimit(nil)     &#47;&#47; Should be ignored (use default)</span>
<span class="term-fg32">+	testLimit(ptr(200))</span>
<span class="term-fg32">+	testLimit(ptr(wsDefaultReadLimit * 2))</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
 func TestWebsocketPeerInfo(t *testing.T) {
 	var (
 		s     = newTestServer()
<span class="term-fg36">@@ -206,7 +266,7 @@</span> 	)
 	defer srv.Stop()
 	defer httpsrv.Close()
&nbsp;
<span class="term-fg31">-	respLength := wsMessageSizeLimit - 50</span>
<span class="term-fg32">+	respLength := wsDefaultReadLimit - 50</span>
 	srv.RegisterName(&quot;test&quot;, largeRespService{respLength})
&nbsp;
 	c, err := DialWebsocket(context.Background(), wsURL, &quot;&quot;)</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-d5ef18092d1caf7c3b8a48fb" role="button"
                   aria-expanded="false" aria-controls="id-d5ef18092d1caf7c3b8a48fb">
                    <code>tests/fuzzers/stacktrie/trie_fuzzer.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/3f40e65c484486dea6cff80b7db178985d21a2c6/tests/fuzzers/stacktrie/trie_fuzzer.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/650bb2f2b1dcfe30d9b1fa6f7dc9608055ed60e1/tests/fuzzers/stacktrie/trie_fuzzer.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+3</span></div>
                        <div class="text-start"><span class="text-danger">-6</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-d5ef18092d1caf7c3b8a48fb"><span class="term-fg1">diff --git go-ethereum&#47;tests&#47;fuzzers&#47;stacktrie&#47;trie_fuzzer.go op-geth&#47;tests&#47;fuzzers&#47;stacktrie&#47;trie_fuzzer.go</span>
<span class="term-fg1">index 3d65524095785fce659178a5ed71ad681ec3579c..20b8ca24b3d26294bd657b7f507c99073c2376ae 100644</span>
<span class="term-fg1">--- go-ethereum&#47;tests&#47;fuzzers&#47;stacktrie&#47;trie_fuzzer.go</span>
<span class="term-fg1">+++ op-geth&#47;tests&#47;fuzzers&#47;stacktrie&#47;trie_fuzzer.go</span>
<span class="term-fg36">@@ -140,8 +140,8 @@</span> 		dbA     = trie.NewDatabase(rawdb.NewDatabase(spongeA), nil)
 		trieA   = trie.NewEmpty(dbA)
 		spongeB = &amp;spongeDb{sponge: sha3.NewLegacyKeccak256()}
 		dbB     = trie.NewDatabase(rawdb.NewDatabase(spongeB), nil)
<span class="term-fg31">-		trieB   = trie.NewStackTrie(func(owner common.Hash, path []byte, hash common.Hash, blob []byte) {</span>
<span class="term-fg31">-			rawdb.WriteTrieNode(spongeB, owner, path, hash, blob, dbB.Scheme())</span>
<span class="term-fg32">+		trieB   = trie.NewStackTrie(func(path []byte, hash common.Hash, blob []byte) {</span>
<span class="term-fg32">+			rawdb.WriteTrieNode(spongeB, common.Hash{}, path, hash, blob, dbB.Scheme())</span>
 		})
 		vals        []kv
 		useful      bool
<span class="term-fg36">@@ -205,12 +205,9 @@</span>
 	&#47;&#47; Ensure all the nodes are persisted correctly
 	var (
 		nodeset = make(map[string][]byte) &#47;&#47; path -&gt; blob
<span class="term-fg31">-		trieC   = trie.NewStackTrie(func(owner common.Hash, path []byte, hash common.Hash, blob []byte) {</span>
<span class="term-fg32">+		trieC   = trie.NewStackTrie(func(path []byte, hash common.Hash, blob []byte) {</span>
 			if crypto.Keccak256Hash(blob) != hash {
 				panic(&quot;invalid node blob&quot;)
<span class="term-fg31">-			}</span>
<span class="term-fg31">-			if owner != (common.Hash{}) {</span>
<span class="term-fg31">-				panic(&quot;invalid node owner&quot;)</span>
 			}
 			nodeset[string(path)] = common.CopyBytes(blob)
 		})</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-737dc71c7367a5bf0645f08d" role="button"
                   aria-expanded="false" aria-controls="id-737dc71c7367a5bf0645f08d">
                    <code>tests/fuzzers/txfetcher/txfetcher_fuzzer.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/3f40e65c484486dea6cff80b7db178985d21a2c6/tests/fuzzers/txfetcher/txfetcher_fuzzer.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/650bb2f2b1dcfe30d9b1fa6f7dc9608055ed60e1/tests/fuzzers/txfetcher/txfetcher_fuzzer.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+6</span></div>
                        <div class="text-start"><span class="text-danger">-1</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-737dc71c7367a5bf0645f08d"><span class="term-fg1">diff --git go-ethereum&#47;tests&#47;fuzzers&#47;txfetcher&#47;txfetcher_fuzzer.go op-geth&#47;tests&#47;fuzzers&#47;txfetcher&#47;txfetcher_fuzzer.go</span>
<span class="term-fg1">index d1d6fdc66592963c8b9cf01b45dc81d51a1a48a4..8b501645b6631da52fc851acde8f3d5aa7754866 100644</span>
<span class="term-fg1">--- go-ethereum&#47;tests&#47;fuzzers&#47;txfetcher&#47;txfetcher_fuzzer.go</span>
<span class="term-fg1">+++ op-geth&#47;tests&#47;fuzzers&#47;txfetcher&#47;txfetcher_fuzzer.go</span>
<span class="term-fg36">@@ -83,6 +83,7 @@</span> 		func(txs []*types.Transaction) []error {
 			return make([]error, len(txs))
 		},
 		func(string, []common.Hash) error { return nil },
<span class="term-fg32">+		nil,</span>
 		clock, rand,
 	)
 	f.Start()
<span class="term-fg36">@@ -116,6 +117,8 @@</span>
 			var (
 				announceIdxs = make([]int, announce)
 				announces    = make([]common.Hash, announce)
<span class="term-fg32">+				types        = make([]byte, announce)</span>
<span class="term-fg32">+				sizes        = make([]uint32, announce)</span>
 			)
 			for i := 0; i &lt; len(announces); i++ {
 				annBuf := make([]byte, 2)
<span class="term-fg36">@@ -124,11 +127,13 @@</span> 					return 0
 				}
 				announceIdxs[i] = (int(annBuf[0])*256 + int(annBuf[1])) % len(txs)
 				announces[i] = txs[announceIdxs[i]].Hash()
<span class="term-fg32">+				types[i] = txs[announceIdxs[i]].Type()</span>
<span class="term-fg32">+				sizes[i] = uint32(txs[announceIdxs[i]].Size())</span>
 			}
 			if verbose {
 				fmt.Println(&quot;Notify&quot;, peer, announceIdxs)
 			}
<span class="term-fg31">-			if err := f.Notify(peer, announces); err != nil {</span>
<span class="term-fg32">+			if err := f.Notify(peer, types, sizes, announces); err != nil {</span>
 				panic(err)
 			}
</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-34b83ac25bb791b1633cb722" role="button"
                   aria-expanded="false" aria-controls="id-34b83ac25bb791b1633cb722">
                    <code>tests/state_test.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/3f40e65c484486dea6cff80b7db178985d21a2c6/tests/state_test.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/650bb2f2b1dcfe30d9b1fa6f7dc9608055ed60e1/tests/state_test.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+1</span></div>
                        <div class="text-start"><span class="text-danger">-1</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-34b83ac25bb791b1633cb722"><span class="term-fg1">diff --git go-ethereum&#47;tests&#47;state_test.go op-geth&#47;tests&#47;state_test.go</span>
<span class="term-fg1">index 094dafcafd7a372b7f8331d14fe1b387bc5a7357..42b46e9c40a70e40432268b1351bdf7dbeeb547b 100644</span>
<span class="term-fg1">--- go-ethereum&#47;tests&#47;state_test.go</span>
<span class="term-fg1">+++ op-geth&#47;tests&#47;state_test.go</span>
<span class="term-fg36">@@ -259,7 +259,7 @@</span> 			}
&nbsp;
 			&#47;&#47; Prepare the EVM.
 			txContext := core.NewEVMTxContext(msg)
<span class="term-fg31">-			context := core.NewEVMBlockContext(block.Header(), nil, &amp;t.json.Env.Coinbase)</span>
<span class="term-fg32">+			context := core.NewEVMBlockContext(block.Header(), nil, &amp;t.json.Env.Coinbase, config, statedb)</span>
 			context.GetHash = vmTestBlockHash
 			context.BaseFee = baseFee
 			evm := vm.NewEVM(context, txContext, statedb, config, vmconfig)</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-7cecb04d6b65ab667449b720" role="button"
                   aria-expanded="false" aria-controls="id-7cecb04d6b65ab667449b720">
                    <code>tests/state_test_util.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/3f40e65c484486dea6cff80b7db178985d21a2c6/tests/state_test_util.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/650bb2f2b1dcfe30d9b1fa6f7dc9608055ed60e1/tests/state_test_util.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+1</span></div>
                        <div class="text-start"><span class="text-danger">-1</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-7cecb04d6b65ab667449b720"><span class="term-fg1">diff --git go-ethereum&#47;tests&#47;state_test_util.go op-geth&#47;tests&#47;state_test_util.go</span>
<span class="term-fg1">index 8c255c1b5bd23c1c3fa374fb997d57f596c3a56d..d09b29b762201785d988ae1a9aa79c4f0e684fad 100644</span>
<span class="term-fg1">--- go-ethereum&#47;tests&#47;state_test_util.go</span>
<span class="term-fg1">+++ op-geth&#47;tests&#47;state_test_util.go</span>
<span class="term-fg36">@@ -268,7 +268,7 @@</span> 	}
&nbsp;
 	&#47;&#47; Prepare the EVM.
 	txContext := core.NewEVMTxContext(msg)
<span class="term-fg31">-	context := core.NewEVMBlockContext(block.Header(), nil, &amp;t.json.Env.Coinbase)</span>
<span class="term-fg32">+	context := core.NewEVMBlockContext(block.Header(), nil, &amp;t.json.Env.Coinbase, config, statedb)</span>
 	context.GetHash = vmTestBlockHash
 	context.BaseFee = baseFee
 	context.Random = nil</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-be77956b0e8212ffd09ebd1d" role="button"
                   aria-expanded="false" aria-controls="id-be77956b0e8212ffd09ebd1d">
                    <code>trie/database.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/3f40e65c484486dea6cff80b7db178985d21a2c6/trie/database.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/650bb2f2b1dcfe30d9b1fa6f7dc9608055ed60e1/trie/database.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+25</span></div>
                        <div class="text-start"><span class="text-danger">-4</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-be77956b0e8212ffd09ebd1d"><span class="term-fg1">diff --git go-ethereum&#47;trie&#47;database.go op-geth&#47;trie&#47;database.go</span>
<span class="term-fg1">index 2915ff9484540853f4db5f4a9f7615b28c7e8fc0..1e59f0908f38712d7360534644b0005596948b31 100644</span>
<span class="term-fg1">--- go-ethereum&#47;trie&#47;database.go</span>
<span class="term-fg1">+++ op-geth&#47;trie&#47;database.go</span>
<span class="term-fg36">@@ -189,6 +189,15 @@</span> 		db.preimages.commit(true)
 	}
 }
&nbsp;
<span class="term-fg32">+&#47;&#47; Preimage retrieves a cached trie node pre-image from memory. If it cannot be</span>
<span class="term-fg32">+&#47;&#47; found cached, the method queries the persistent database for the content.</span>
<span class="term-fg32">+func (db *Database) Preimage(hash common.Hash) []byte {</span>
<span class="term-fg32">+	if db.preimages == nil {</span>
<span class="term-fg32">+		return nil</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	return db.preimages.preimage(hash)</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
 &#47;&#47; Cap iteratively flushes old but still referenced trie nodes until the total
 &#47;&#47; memory usage goes below the given threshold. The held pre-images accumulated
 &#47;&#47; up to this point will be flushed in case the size exceeds the threshold.
<span class="term-fg36">@@ -264,15 +273,27 @@</span> 	}
 	return pdb.Recoverable(root), nil
 }
&nbsp;
<span class="term-fg31">-&#47;&#47; Reset wipes all available journal from the persistent database and discard</span>
<span class="term-fg31">-&#47;&#47; all caches and diff layers. Using the given root to create a new disk layer.</span>
<span class="term-fg32">+&#47;&#47; Disable deactivates the database and invalidates all available state layers</span>
<span class="term-fg32">+&#47;&#47; as stale to prevent access to the persistent state, which is in the syncing</span>
<span class="term-fg32">+&#47;&#47; stage.</span>
<span class="term-fg32">+&#47;&#47;</span>
 &#47;&#47; It&#39;s only supported by path-based database and will return an error for others.
<span class="term-fg31">-func (db *Database) Reset(root common.Hash) error {</span>
<span class="term-fg32">+func (db *Database) Disable() error {</span>
 	pdb, ok := db.backend.(*pathdb.Database)
 	if !ok {
 		return errors.New(&quot;not supported&quot;)
 	}
<span class="term-fg31">-	return pdb.Reset(root)</span>
<span class="term-fg32">+	return pdb.Disable()</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+&#47;&#47; Enable activates database and resets the state tree with the provided persistent</span>
<span class="term-fg32">+&#47;&#47; state root once the state sync is finished.</span>
<span class="term-fg32">+func (db *Database) Enable(root common.Hash) error {</span>
<span class="term-fg32">+	pdb, ok := db.backend.(*pathdb.Database)</span>
<span class="term-fg32">+	if !ok {</span>
<span class="term-fg32">+		return errors.New(&quot;not supported&quot;)</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	return pdb.Enable(root)</span>
 }
&nbsp;
 &#47;&#47; Journal commits an entire diff hierarchy to disk into a single journal entry.</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-a8ee6a500a5d3c17a5db4130" role="button"
                   aria-expanded="false" aria-controls="id-a8ee6a500a5d3c17a5db4130">
                    <code>trie/stacktrie.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/3f40e65c484486dea6cff80b7db178985d21a2c6/trie/stacktrie.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/650bb2f2b1dcfe30d9b1fa6f7dc9608055ed60e1/trie/stacktrie.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+112</span></div>
                        <div class="text-start"><span class="text-danger">-234</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-a8ee6a500a5d3c17a5db4130"><span class="term-fg1">diff --git go-ethereum&#47;trie&#47;stacktrie.go op-geth&#47;trie&#47;stacktrie.go</span>
<span class="term-fg1">index 0d65ee75e05da061afa17bcf4ef9670d14e5cbaf..35208e1cb3453c4e2cf60b23d16c680a8884ab74 100644</span>
<span class="term-fg1">--- go-ethereum&#47;trie&#47;stacktrie.go</span>
<span class="term-fg1">+++ op-geth&#47;trie&#47;stacktrie.go</span>
<span class="term-fg36">@@ -17,11 +17,7 @@</span>
 package trie
&nbsp;
 import (
<span class="term-fg31">-	&quot;bufio&quot;</span>
<span class="term-fg31">-	&quot;bytes&quot;</span>
<span class="term-fg31">-	&quot;encoding&#47;gob&quot;</span>
 	&quot;errors&quot;
<span class="term-fg31">-	&quot;io&quot;</span>
 	&quot;sync&quot;
&nbsp;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;common&quot;
<span class="term-fg36">@@ -29,171 +25,87 @@</span> 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;core&#47;types&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;log&quot;
 )
&nbsp;
<span class="term-fg31">-var ErrCommitDisabled = errors.New(&quot;no database for committing&quot;)</span>
<span class="term-fg31">-</span>
<span class="term-fg31">-var stPool = sync.Pool{</span>
<span class="term-fg31">-	New: func() interface{} {</span>
<span class="term-fg31">-		return NewStackTrie(nil)</span>
<span class="term-fg31">-	},</span>
<span class="term-fg31">-}</span>
<span class="term-fg32">+var (</span>
<span class="term-fg32">+	ErrCommitDisabled = errors.New(&quot;no database for committing&quot;)</span>
<span class="term-fg32">+	stPool            = sync.Pool{New: func() any { return new(stNode) }}</span>
<span class="term-fg32">+	_                 = types.TrieHasher((*StackTrie)(nil))</span>
<span class="term-fg32">+)</span>
&nbsp;
 &#47;&#47; NodeWriteFunc is used to provide all information of a dirty node for committing
 &#47;&#47; so that callers can flush nodes into database with desired scheme.
<span class="term-fg31">-type NodeWriteFunc = func(owner common.Hash, path []byte, hash common.Hash, blob []byte)</span>
<span class="term-fg31">-</span>
<span class="term-fg31">-func stackTrieFromPool(writeFn NodeWriteFunc, owner common.Hash) *StackTrie {</span>
<span class="term-fg31">-	st := stPool.Get().(*StackTrie)</span>
<span class="term-fg31">-	st.owner = owner</span>
<span class="term-fg31">-	st.writeFn = writeFn</span>
<span class="term-fg31">-	return st</span>
<span class="term-fg31">-}</span>
<span class="term-fg31">-</span>
<span class="term-fg31">-func returnToPool(st *StackTrie) {</span>
<span class="term-fg31">-	st.Reset()</span>
<span class="term-fg31">-	stPool.Put(st)</span>
<span class="term-fg31">-}</span>
<span class="term-fg32">+type NodeWriteFunc = func(path []byte, hash common.Hash, blob []byte)</span>
&nbsp;
 &#47;&#47; StackTrie is a trie implementation that expects keys to be inserted
 &#47;&#47; in order. Once it determines that a subtree will no longer be inserted
 &#47;&#47; into, it will hash it and free up the memory it uses.
 type StackTrie struct {
<span class="term-fg31">-	owner    common.Hash    &#47;&#47; the owner of the trie</span>
<span class="term-fg31">-	nodeType uint8          &#47;&#47; node type (as in branch, ext, leaf)</span>
<span class="term-fg31">-	val      []byte         &#47;&#47; value contained by this node if it&#39;s a leaf</span>
<span class="term-fg31">-	key      []byte         &#47;&#47; key chunk covered by this (leaf|ext) node</span>
<span class="term-fg31">-	children [16]*StackTrie &#47;&#47; list of children (for branch and exts)</span>
<span class="term-fg31">-	writeFn  NodeWriteFunc  &#47;&#47; function for committing nodes, can be nil</span>
<span class="term-fg32">+	writeFn NodeWriteFunc &#47;&#47; function for committing nodes, can be nil</span>
<span class="term-fg32">+	root    *stNode</span>
<span class="term-fg32">+	h       *hasher</span>
 }
&nbsp;
 &#47;&#47; NewStackTrie allocates and initializes an empty trie.
 func NewStackTrie(writeFn NodeWriteFunc) *StackTrie {
 	return &amp;StackTrie{
<span class="term-fg31">-		nodeType: emptyNode,</span>
<span class="term-fg31">-		writeFn:  writeFn,</span>
<span class="term-fg32">+		writeFn: writeFn,</span>
<span class="term-fg32">+		root:    stPool.Get().(*stNode),</span>
<span class="term-fg32">+		h:       newHasher(false),</span>
 	}
 }
&nbsp;
<span class="term-fg31">-&#47;&#47; NewStackTrieWithOwner allocates and initializes an empty trie, but with</span>
<span class="term-fg31">-&#47;&#47; the additional owner field.</span>
<span class="term-fg31">-func NewStackTrieWithOwner(writeFn NodeWriteFunc, owner common.Hash) *StackTrie {</span>
<span class="term-fg31">-	return &amp;StackTrie{</span>
<span class="term-fg31">-		owner:    owner,</span>
<span class="term-fg31">-		nodeType: emptyNode,</span>
<span class="term-fg31">-		writeFn:  writeFn,</span>
<span class="term-fg32">+&#47;&#47; Update inserts a (key, value) pair into the stack trie.</span>
<span class="term-fg32">+func (t *StackTrie) Update(key, value []byte) error {</span>
<span class="term-fg32">+	k := keybytesToHex(key)</span>
<span class="term-fg32">+	if len(value) == 0 {</span>
<span class="term-fg32">+		panic(&quot;deletion not supported&quot;)</span>
 	}
<span class="term-fg32">+	t.insert(t.root, k[:len(k)-1], value, nil)</span>
<span class="term-fg32">+	return nil</span>
 }
&nbsp;
<span class="term-fg31">-&#47;&#47; NewFromBinary initialises a serialized stacktrie with the given db.</span>
<span class="term-fg31">-func NewFromBinary(data []byte, writeFn NodeWriteFunc) (*StackTrie, error) {</span>
<span class="term-fg31">-	var st StackTrie</span>
<span class="term-fg31">-	if err := st.UnmarshalBinary(data); err != nil {</span>
<span class="term-fg31">-		return nil, err</span>
<span class="term-fg31">-	}</span>
<span class="term-fg31">-	&#47;&#47; If a database is used, we need to recursively add it to every child</span>
<span class="term-fg31">-	if writeFn != nil {</span>
<span class="term-fg31">-		st.setWriter(writeFn)</span>
<span class="term-fg32">+&#47;&#47; MustUpdate is a wrapper of Update and will omit any encountered error but</span>
<span class="term-fg32">+&#47;&#47; just print out an error message.</span>
<span class="term-fg32">+func (t *StackTrie) MustUpdate(key, value []byte) {</span>
<span class="term-fg32">+	if err := t.Update(key, value); err != nil {</span>
<span class="term-fg32">+		log.Error(&quot;Unhandled trie error in StackTrie.Update&quot;, &quot;err&quot;, err)</span>
 	}
<span class="term-fg31">-	return &amp;st, nil</span>
 }
&nbsp;
<span class="term-fg31">-&#47;&#47; MarshalBinary implements encoding.BinaryMarshaler</span>
<span class="term-fg31">-func (st *StackTrie) MarshalBinary() (data []byte, err error) {</span>
<span class="term-fg31">-	var (</span>
<span class="term-fg31">-		b bytes.Buffer</span>
<span class="term-fg31">-		w = bufio.NewWriter(&amp;b)</span>
<span class="term-fg31">-	)</span>
<span class="term-fg31">-	if err := gob.NewEncoder(w).Encode(struct {</span>
<span class="term-fg31">-		Owner    common.Hash</span>
<span class="term-fg31">-		NodeType uint8</span>
<span class="term-fg31">-		Val      []byte</span>
<span class="term-fg31">-		Key      []byte</span>
<span class="term-fg31">-	}{</span>
<span class="term-fg31">-		st.owner,</span>
<span class="term-fg31">-		st.nodeType,</span>
<span class="term-fg31">-		st.val,</span>
<span class="term-fg31">-		st.key,</span>
<span class="term-fg31">-	}); err != nil {</span>
<span class="term-fg31">-		return nil, err</span>
<span class="term-fg31">-	}</span>
<span class="term-fg31">-	for _, child := range st.children {</span>
<span class="term-fg31">-		if child == nil {</span>
<span class="term-fg31">-			w.WriteByte(0)</span>
<span class="term-fg31">-			continue</span>
<span class="term-fg31">-		}</span>
<span class="term-fg31">-		w.WriteByte(1)</span>
<span class="term-fg31">-		if childData, err := child.MarshalBinary(); err != nil {</span>
<span class="term-fg31">-			return nil, err</span>
<span class="term-fg31">-		} else {</span>
<span class="term-fg31">-			w.Write(childData)</span>
<span class="term-fg31">-		}</span>
<span class="term-fg31">-	}</span>
<span class="term-fg31">-	w.Flush()</span>
<span class="term-fg31">-	return b.Bytes(), nil</span>
<span class="term-fg32">+func (t *StackTrie) Reset() {</span>
<span class="term-fg32">+	t.writeFn = nil</span>
<span class="term-fg32">+	t.root = stPool.Get().(*stNode)</span>
 }
&nbsp;
<span class="term-fg31">-&#47;&#47; UnmarshalBinary implements encoding.BinaryUnmarshaler</span>
<span class="term-fg31">-func (st *StackTrie) UnmarshalBinary(data []byte) error {</span>
<span class="term-fg31">-	r := bytes.NewReader(data)</span>
<span class="term-fg31">-	return st.unmarshalBinary(r)</span>
<span class="term-fg31">-}</span>
<span class="term-fg31">-</span>
<span class="term-fg31">-func (st *StackTrie) unmarshalBinary(r io.Reader) error {</span>
<span class="term-fg31">-	var dec struct {</span>
<span class="term-fg31">-		Owner    common.Hash</span>
<span class="term-fg31">-		NodeType uint8</span>
<span class="term-fg31">-		Val      []byte</span>
<span class="term-fg31">-		Key      []byte</span>
<span class="term-fg31">-	}</span>
<span class="term-fg31">-	if err := gob.NewDecoder(r).Decode(&amp;dec); err != nil {</span>
<span class="term-fg31">-		return err</span>
<span class="term-fg31">-	}</span>
<span class="term-fg31">-	st.owner = dec.Owner</span>
<span class="term-fg31">-	st.nodeType = dec.NodeType</span>
<span class="term-fg31">-	st.val = dec.Val</span>
<span class="term-fg31">-	st.key = dec.Key</span>
<span class="term-fg31">-</span>
<span class="term-fg31">-	var hasChild = make([]byte, 1)</span>
<span class="term-fg31">-	for i := range st.children {</span>
<span class="term-fg31">-		if _, err := r.Read(hasChild); err != nil {</span>
<span class="term-fg31">-			return err</span>
<span class="term-fg31">-		} else if hasChild[0] == 0 {</span>
<span class="term-fg31">-			continue</span>
<span class="term-fg31">-		}</span>
<span class="term-fg31">-		var child StackTrie</span>
<span class="term-fg31">-		if err := child.unmarshalBinary(r); err != nil {</span>
<span class="term-fg31">-			return err</span>
<span class="term-fg31">-		}</span>
<span class="term-fg31">-		st.children[i] = &amp;child</span>
<span class="term-fg31">-	}</span>
<span class="term-fg31">-	return nil</span>
<span class="term-fg32">+&#47;&#47; stNode represents a node within a StackTrie</span>
<span class="term-fg32">+type stNode struct {</span>
<span class="term-fg32">+	typ      uint8       &#47;&#47; node type (as in branch, ext, leaf)</span>
<span class="term-fg32">+	key      []byte      &#47;&#47; key chunk covered by this (leaf|ext) node</span>
<span class="term-fg32">+	val      []byte      &#47;&#47; value contained by this node if it&#39;s a leaf</span>
<span class="term-fg32">+	children [16]*stNode &#47;&#47; list of children (for branch and exts)</span>
 }
&nbsp;
<span class="term-fg31">-func (st *StackTrie) setWriter(writeFn NodeWriteFunc) {</span>
<span class="term-fg31">-	st.writeFn = writeFn</span>
<span class="term-fg31">-	for _, child := range st.children {</span>
<span class="term-fg31">-		if child != nil {</span>
<span class="term-fg31">-			child.setWriter(writeFn)</span>
<span class="term-fg31">-		}</span>
<span class="term-fg31">-	}</span>
<span class="term-fg31">-}</span>
<span class="term-fg31">-</span>
<span class="term-fg31">-func newLeaf(owner common.Hash, key, val []byte, writeFn NodeWriteFunc) *StackTrie {</span>
<span class="term-fg31">-	st := stackTrieFromPool(writeFn, owner)</span>
<span class="term-fg31">-	st.nodeType = leafNode</span>
<span class="term-fg32">+&#47;&#47; newLeaf constructs a leaf node with provided node key and value. The key</span>
<span class="term-fg32">+&#47;&#47; will be deep-copied in the function and safe to modify afterwards, but</span>
<span class="term-fg32">+&#47;&#47; value is not.</span>
<span class="term-fg32">+func newLeaf(key, val []byte) *stNode {</span>
<span class="term-fg32">+	st := stPool.Get().(*stNode)</span>
<span class="term-fg32">+	st.typ = leafNode</span>
 	st.key = append(st.key, key...)
 	st.val = val
 	return st
 }
&nbsp;
<span class="term-fg31">-func newExt(owner common.Hash, key []byte, child *StackTrie, writeFn NodeWriteFunc) *StackTrie {</span>
<span class="term-fg31">-	st := stackTrieFromPool(writeFn, owner)</span>
<span class="term-fg31">-	st.nodeType = extNode</span>
<span class="term-fg32">+&#47;&#47; newExt constructs an extension node with provided node key and child. The</span>
<span class="term-fg32">+&#47;&#47; key will be deep-copied in the function and safe to modify afterwards.</span>
<span class="term-fg32">+func newExt(key []byte, child *stNode) *stNode {</span>
<span class="term-fg32">+	st := stPool.Get().(*stNode)</span>
<span class="term-fg32">+	st.typ = extNode</span>
 	st.key = append(st.key, key...)
 	st.children[0] = child
 	return st
 }
&nbsp;
<span class="term-fg31">-&#47;&#47; List all values that StackTrie#nodeType can hold</span>
<span class="term-fg32">+&#47;&#47; List all values that stNode#nodeType can hold</span>
 const (
 	emptyNode = iota
 	branchNode
<span class="term-fg36">@@ -202,59 +114,40 @@</span> 	leafNode
 	hashedNode
 )
&nbsp;
<span class="term-fg31">-&#47;&#47; Update inserts a (key, value) pair into the stack trie.</span>
<span class="term-fg31">-func (st *StackTrie) Update(key, value []byte) error {</span>
<span class="term-fg31">-	k := keybytesToHex(key)</span>
<span class="term-fg31">-	if len(value) == 0 {</span>
<span class="term-fg31">-		panic(&quot;deletion not supported&quot;)</span>
<span class="term-fg31">-	}</span>
<span class="term-fg31">-	st.insert(k[:len(k)-1], value, nil)</span>
<span class="term-fg31">-	return nil</span>
<span class="term-fg31">-}</span>
<span class="term-fg31">-</span>
<span class="term-fg31">-&#47;&#47; MustUpdate is a wrapper of Update and will omit any encountered error but</span>
<span class="term-fg31">-&#47;&#47; just print out an error message.</span>
<span class="term-fg31">-func (st *StackTrie) MustUpdate(key, value []byte) {</span>
<span class="term-fg31">-	if err := st.Update(key, value); err != nil {</span>
<span class="term-fg31">-		log.Error(&quot;Unhandled trie error in StackTrie.Update&quot;, &quot;err&quot;, err)</span>
<span class="term-fg31">-	}</span>
<span class="term-fg31">-}</span>
<span class="term-fg31">-</span>
<span class="term-fg31">-func (st *StackTrie) Reset() {</span>
<span class="term-fg31">-	st.owner = common.Hash{}</span>
<span class="term-fg31">-	st.writeFn = nil</span>
<span class="term-fg31">-	st.key = st.key[:0]</span>
<span class="term-fg31">-	st.val = nil</span>
<span class="term-fg31">-	for i := range st.children {</span>
<span class="term-fg31">-		st.children[i] = nil</span>
<span class="term-fg32">+func (n *stNode) reset() *stNode {</span>
<span class="term-fg32">+	n.key = n.key[:0]</span>
<span class="term-fg32">+	n.val = nil</span>
<span class="term-fg32">+	for i := range n.children {</span>
<span class="term-fg32">+		n.children[i] = nil</span>
 	}
<span class="term-fg31">-	st.nodeType = emptyNode</span>
<span class="term-fg32">+	n.typ = emptyNode</span>
<span class="term-fg32">+	return n</span>
 }
&nbsp;
 &#47;&#47; Helper function that, given a full key, determines the index
 &#47;&#47; at which the chunk pointed by st.keyOffset is different from
 &#47;&#47; the same chunk in the full key.
<span class="term-fg31">-func (st *StackTrie) getDiffIndex(key []byte) int {</span>
<span class="term-fg31">-	for idx, nibble := range st.key {</span>
<span class="term-fg32">+func (n *stNode) getDiffIndex(key []byte) int {</span>
<span class="term-fg32">+	for idx, nibble := range n.key {</span>
 		if nibble != key[idx] {
 			return idx
 		}
 	}
<span class="term-fg31">-	return len(st.key)</span>
<span class="term-fg32">+	return len(n.key)</span>
 }
&nbsp;
 &#47;&#47; Helper function to that inserts a (key, value) pair into
 &#47;&#47; the trie.
<span class="term-fg31">-func (st *StackTrie) insert(key, value []byte, prefix []byte) {</span>
<span class="term-fg31">-	switch st.nodeType {</span>
<span class="term-fg32">+func (t *StackTrie) insert(st *stNode, key, value []byte, prefix []byte) {</span>
<span class="term-fg32">+	switch st.typ {</span>
 	case branchNode: &#47;* Branch *&#47;
 		idx := int(key[0])
&nbsp;
 		&#47;&#47; Unresolve elder siblings
 		for i := idx - 1; i &gt;= 0; i-- {
 			if st.children[i] != nil {
<span class="term-fg31">-				if st.children[i].nodeType != hashedNode {</span>
<span class="term-fg31">-					st.children[i].hash(append(prefix, byte(i)))</span>
<span class="term-fg32">+				if st.children[i].typ != hashedNode {</span>
<span class="term-fg32">+					t.hash(st.children[i], append(prefix, byte(i)))</span>
 				}
 				break
 			}
<span class="term-fg36">@@ -262,9 +155,9 @@</span> 		}
&nbsp;
 		&#47;&#47; Add new child
 		if st.children[idx] == nil {
<span class="term-fg31">-			st.children[idx] = newLeaf(st.owner, key[1:], value, st.writeFn)</span>
<span class="term-fg32">+			st.children[idx] = newLeaf(key[1:], value)</span>
 		} else {
<span class="term-fg31">-			st.children[idx].insert(key[1:], value, append(prefix, key[0]))</span>
<span class="term-fg32">+			t.insert(st.children[idx], key[1:], value, append(prefix, key[0]))</span>
 		}
&nbsp;
 	case extNode: &#47;* Ext *&#47;
<span class="term-fg36">@@ -279,46 +172,46 @@</span> 		&#47;&#47; for each of the differentiated subtrees.
 		if diffidx == len(st.key) {
 			&#47;&#47; Ext key and key segment are identical, recurse into
 			&#47;&#47; the child node.
<span class="term-fg31">-			st.children[0].insert(key[diffidx:], value, append(prefix, key[:diffidx]...))</span>
<span class="term-fg32">+			t.insert(st.children[0], key[diffidx:], value, append(prefix, key[:diffidx]...))</span>
 			return
 		}
 		&#47;&#47; Save the original part. Depending if the break is
 		&#47;&#47; at the extension&#39;s last byte or not, create an
 		&#47;&#47; intermediate extension or use the extension&#39;s child
 		&#47;&#47; node directly.
<span class="term-fg31">-		var n *StackTrie</span>
<span class="term-fg32">+		var n *stNode</span>
 		if diffidx &lt; len(st.key)-1 {
 			&#47;&#47; Break on the non-last byte, insert an intermediate
 			&#47;&#47; extension. The path prefix of the newly-inserted
 			&#47;&#47; extension should also contain the different byte.
<span class="term-fg31">-			n = newExt(st.owner, st.key[diffidx+1:], st.children[0], st.writeFn)</span>
<span class="term-fg31">-			n.hash(append(prefix, st.key[:diffidx+1]...))</span>
<span class="term-fg32">+			n = newExt(st.key[diffidx+1:], st.children[0])</span>
<span class="term-fg32">+			t.hash(n, append(prefix, st.key[:diffidx+1]...))</span>
 		} else {
 			&#47;&#47; Break on the last byte, no need to insert
 			&#47;&#47; an extension node: reuse the current node.
 			&#47;&#47; The path prefix of the original part should
 			&#47;&#47; still be same.
 			n = st.children[0]
<span class="term-fg31">-			n.hash(append(prefix, st.key...))</span>
<span class="term-fg32">+			t.hash(n, append(prefix, st.key...))</span>
 		}
<span class="term-fg31">-		var p *StackTrie</span>
<span class="term-fg32">+		var p *stNode</span>
 		if diffidx == 0 {
 			&#47;&#47; the break is on the first byte, so
 			&#47;&#47; the current node is converted into
 			&#47;&#47; a branch node.
 			st.children[0] = nil
 			p = st
<span class="term-fg31">-			st.nodeType = branchNode</span>
<span class="term-fg32">+			st.typ = branchNode</span>
 		} else {
 			&#47;&#47; the common prefix is at least one byte
 			&#47;&#47; long, insert a new intermediate branch
 			&#47;&#47; node.
<span class="term-fg31">-			st.children[0] = stackTrieFromPool(st.writeFn, st.owner)</span>
<span class="term-fg31">-			st.children[0].nodeType = branchNode</span>
<span class="term-fg32">+			st.children[0] = stPool.Get().(*stNode)</span>
<span class="term-fg32">+			st.children[0].typ = branchNode</span>
 			p = st.children[0]
 		}
 		&#47;&#47; Create a leaf for the inserted part
<span class="term-fg31">-		o := newLeaf(st.owner, key[diffidx+1:], value, st.writeFn)</span>
<span class="term-fg32">+		o := newLeaf(key[diffidx+1:], value)</span>
&nbsp;
 		&#47;&#47; Insert both child leaves where they belong:
 		origIdx := st.key[diffidx]
<span class="term-fg36">@@ -344,18 +237,18 @@</span>
 		&#47;&#47; Check if the split occurs at the first nibble of the
 		&#47;&#47; chunk. In that case, no prefix extnode is necessary.
 		&#47;&#47; Otherwise, create that
<span class="term-fg31">-		var p *StackTrie</span>
<span class="term-fg32">+		var p *stNode</span>
 		if diffidx == 0 {
 			&#47;&#47; Convert current leaf into a branch
<span class="term-fg31">-			st.nodeType = branchNode</span>
<span class="term-fg32">+			st.typ = branchNode</span>
 			p = st
 			st.children[0] = nil
 		} else {
 			&#47;&#47; Convert current node into an ext,
 			&#47;&#47; and insert a child branch node.
<span class="term-fg31">-			st.nodeType = extNode</span>
<span class="term-fg31">-			st.children[0] = NewStackTrieWithOwner(st.writeFn, st.owner)</span>
<span class="term-fg31">-			st.children[0].nodeType = branchNode</span>
<span class="term-fg32">+			st.typ = extNode</span>
<span class="term-fg32">+			st.children[0] = stPool.Get().(*stNode)</span>
<span class="term-fg32">+			st.children[0].typ = branchNode</span>
 			p = st.children[0]
 		}
&nbsp;
<span class="term-fg36">@@ -363,11 +256,11 @@</span> 		&#47;&#47; Create the two child leaves: one containing the original
 		&#47;&#47; value and another containing the new value. The child leaf
 		&#47;&#47; is hashed directly in order to free up some memory.
 		origIdx := st.key[diffidx]
<span class="term-fg31">-		p.children[origIdx] = newLeaf(st.owner, st.key[diffidx+1:], st.val, st.writeFn)</span>
<span class="term-fg31">-		p.children[origIdx].hash(append(prefix, st.key[:diffidx+1]...))</span>
<span class="term-fg32">+		p.children[origIdx] = newLeaf(st.key[diffidx+1:], st.val)</span>
<span class="term-fg32">+		t.hash(p.children[origIdx], append(prefix, st.key[:diffidx+1]...))</span>
&nbsp;
 		newIdx := key[diffidx]
<span class="term-fg31">-		p.children[newIdx] = newLeaf(st.owner, key[diffidx+1:], value, st.writeFn)</span>
<span class="term-fg32">+		p.children[newIdx] = newLeaf(key[diffidx+1:], value)</span>
&nbsp;
 		&#47;&#47; Finally, cut off the key part that has been passed
 		&#47;&#47; over to the children.
<span class="term-fg36">@@ -375,7 +268,7 @@</span> 		st.key = st.key[:diffidx]
 		st.val = nil
&nbsp;
 	case emptyNode: &#47;* Empty *&#47;
<span class="term-fg31">-		st.nodeType = leafNode</span>
<span class="term-fg32">+		st.typ = leafNode</span>
 		st.key = key
 		st.val = value
&nbsp;
<span class="term-fg36">@@ -398,25 +291,18 @@</span> &#47;&#47;   - Then the &lt;32 byte rlp-encoded value will be accessible in &#39;st.val&#39;.
 &#47;&#47;   - And the &#39;st.type&#39; will be &#39;hashedNode&#39; AGAIN
 &#47;&#47;
 &#47;&#47; This method also sets &#39;st.type&#39; to hashedNode, and clears &#39;st.key&#39;.
<span class="term-fg31">-func (st *StackTrie) hash(path []byte) {</span>
<span class="term-fg31">-	h := newHasher(false)</span>
<span class="term-fg31">-	defer returnHasherToPool(h)</span>
<span class="term-fg31">-</span>
<span class="term-fg31">-	st.hashRec(h, path)</span>
<span class="term-fg31">-}</span>
<span class="term-fg31">-</span>
<span class="term-fg31">-func (st *StackTrie) hashRec(hasher *hasher, path []byte) {</span>
<span class="term-fg32">+func (t *StackTrie) hash(st *stNode, path []byte) {</span>
 	&#47;&#47; The switch below sets this to the RLP-encoding of this node.
 	var encodedNode []byte
&nbsp;
<span class="term-fg31">-	switch st.nodeType {</span>
<span class="term-fg32">+	switch st.typ {</span>
 	case hashedNode:
 		return
&nbsp;
 	case emptyNode:
 		st.val = types.EmptyRootHash.Bytes()
 		st.key = st.key[:0]
<span class="term-fg31">-		st.nodeType = hashedNode</span>
<span class="term-fg32">+		st.typ = hashedNode</span>
 		return
&nbsp;
 	case branchNode:
<span class="term-fg36">@@ -426,23 +312,21 @@</span> 			if child == nil {
 				nodes.Children[i] = nilValueNode
 				continue
 			}
<span class="term-fg31">-			child.hashRec(hasher, append(path, byte(i)))</span>
<span class="term-fg32">+			t.hash(child, append(path, byte(i)))</span>
<span class="term-fg32">+</span>
 			if len(child.val) &lt; 32 {
 				nodes.Children[i] = rawNode(child.val)
 			} else {
 				nodes.Children[i] = hashNode(child.val)
 			}
<span class="term-fg31">-</span>
<span class="term-fg31">-			&#47;&#47; Release child back to pool.</span>
 			st.children[i] = nil
<span class="term-fg31">-			returnToPool(child)</span>
<span class="term-fg32">+			stPool.Put(child.reset()) &#47;&#47; Release child back to pool.</span>
 		}
<span class="term-fg31">-</span>
<span class="term-fg31">-		nodes.encode(hasher.encbuf)</span>
<span class="term-fg31">-		encodedNode = hasher.encodedBytes()</span>
<span class="term-fg32">+		nodes.encode(t.h.encbuf)</span>
<span class="term-fg32">+		encodedNode = t.h.encodedBytes()</span>
&nbsp;
 	case extNode:
<span class="term-fg31">-		st.children[0].hashRec(hasher, append(path, st.key...))</span>
<span class="term-fg32">+		t.hash(st.children[0], append(path, st.key...))</span>
&nbsp;
 		n := shortNode{Key: hexToCompactInPlace(st.key)}
 		if len(st.children[0].val) &lt; 32 {
<span class="term-fg36">@@ -450,26 +334,24 @@</span> 			n.Val = rawNode(st.children[0].val)
 		} else {
 			n.Val = hashNode(st.children[0].val)
 		}
<span class="term-fg31">-</span>
<span class="term-fg31">-		n.encode(hasher.encbuf)</span>
<span class="term-fg31">-		encodedNode = hasher.encodedBytes()</span>
<span class="term-fg32">+		n.encode(t.h.encbuf)</span>
<span class="term-fg32">+		encodedNode = t.h.encodedBytes()</span>
&nbsp;
<span class="term-fg31">-		&#47;&#47; Release child back to pool.</span>
<span class="term-fg31">-		returnToPool(st.children[0])</span>
<span class="term-fg32">+		stPool.Put(st.children[0].reset()) &#47;&#47; Release child back to pool.</span>
 		st.children[0] = nil
&nbsp;
 	case leafNode:
 		st.key = append(st.key, byte(16))
 		n := shortNode{Key: hexToCompactInPlace(st.key), Val: valueNode(st.val)}
&nbsp;
<span class="term-fg31">-		n.encode(hasher.encbuf)</span>
<span class="term-fg31">-		encodedNode = hasher.encodedBytes()</span>
<span class="term-fg32">+		n.encode(t.h.encbuf)</span>
<span class="term-fg32">+		encodedNode = t.h.encodedBytes()</span>
&nbsp;
 	default:
 		panic(&quot;invalid node type&quot;)
 	}
&nbsp;
<span class="term-fg31">-	st.nodeType = hashedNode</span>
<span class="term-fg32">+	st.typ = hashedNode</span>
 	st.key = st.key[:0]
 	if len(encodedNode) &lt; 32 {
 		st.val = common.CopyBytes(encodedNode)
<span class="term-fg36">@@ -478,18 +360,16 @@</span> 	}
&nbsp;
 	&#47;&#47; Write the hash to the &#39;val&#39;. We allocate a new val here to not mutate
 	&#47;&#47; input values
<span class="term-fg31">-	st.val = hasher.hashData(encodedNode)</span>
<span class="term-fg31">-	if st.writeFn != nil {</span>
<span class="term-fg31">-		st.writeFn(st.owner, path, common.BytesToHash(st.val), encodedNode)</span>
<span class="term-fg32">+	st.val = t.h.hashData(encodedNode)</span>
<span class="term-fg32">+	if t.writeFn != nil {</span>
<span class="term-fg32">+		t.writeFn(path, common.BytesToHash(st.val), encodedNode)</span>
 	}
 }
&nbsp;
 &#47;&#47; Hash returns the hash of the current node.
<span class="term-fg31">-func (st *StackTrie) Hash() (h common.Hash) {</span>
<span class="term-fg31">-	hasher := newHasher(false)</span>
<span class="term-fg31">-	defer returnHasherToPool(hasher)</span>
<span class="term-fg31">-</span>
<span class="term-fg31">-	st.hashRec(hasher, nil)</span>
<span class="term-fg32">+func (t *StackTrie) Hash() (h common.Hash) {</span>
<span class="term-fg32">+	st := t.root</span>
<span class="term-fg32">+	t.hash(st, nil)</span>
 	if len(st.val) == 32 {
 		copy(h[:], st.val)
 		return h
<span class="term-fg36">@@ -497,9 +377,9 @@</span> 	}
 	&#47;&#47; If the node&#39;s RLP isn&#39;t 32 bytes long, the node will not
 	&#47;&#47; be hashed, and instead contain the  rlp-encoding of the
 	&#47;&#47; node. For the top level node, we need to force the hashing.
<span class="term-fg31">-	hasher.sha.Reset()</span>
<span class="term-fg31">-	hasher.sha.Write(st.val)</span>
<span class="term-fg31">-	hasher.sha.Read(h[:])</span>
<span class="term-fg32">+	t.h.sha.Reset()</span>
<span class="term-fg32">+	t.h.sha.Write(st.val)</span>
<span class="term-fg32">+	t.h.sha.Read(h[:])</span>
 	return h
 }
&nbsp;
<span class="term-fg36">@@ -510,14 +390,12 @@</span> &#47;&#47; here is to commit the root node.
 &#47;&#47;
 &#47;&#47; The associated database is expected, otherwise the whole commit
 &#47;&#47; functionality should be disabled.
<span class="term-fg31">-func (st *StackTrie) Commit() (h common.Hash, err error) {</span>
<span class="term-fg31">-	if st.writeFn == nil {</span>
<span class="term-fg32">+func (t *StackTrie) Commit() (h common.Hash, err error) {</span>
<span class="term-fg32">+	if t.writeFn == nil {</span>
 		return common.Hash{}, ErrCommitDisabled
 	}
<span class="term-fg31">-	hasher := newHasher(false)</span>
<span class="term-fg31">-	defer returnHasherToPool(hasher)</span>
<span class="term-fg31">-</span>
<span class="term-fg31">-	st.hashRec(hasher, nil)</span>
<span class="term-fg32">+	st := t.root</span>
<span class="term-fg32">+	t.hash(st, nil)</span>
 	if len(st.val) == 32 {
 		copy(h[:], st.val)
 		return h, nil
<span class="term-fg36">@@ -525,10 +403,10 @@</span> 	}
 	&#47;&#47; If the node&#39;s RLP isn&#39;t 32 bytes long, the node will not
 	&#47;&#47; be hashed (and committed), and instead contain the rlp-encoding of the
 	&#47;&#47; node. For the top level node, we need to force the hashing+commit.
<span class="term-fg31">-	hasher.sha.Reset()</span>
<span class="term-fg31">-	hasher.sha.Write(st.val)</span>
<span class="term-fg31">-	hasher.sha.Read(h[:])</span>
<span class="term-fg32">+	t.h.sha.Reset()</span>
<span class="term-fg32">+	t.h.sha.Write(st.val)</span>
<span class="term-fg32">+	t.h.sha.Read(h[:])</span>
&nbsp;
<span class="term-fg31">-	st.writeFn(st.owner, nil, h, st.val)</span>
<span class="term-fg32">+	t.writeFn(nil, h, st.val)</span>
 	return h, nil
 }</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-d3b5d90f12ae57ac36424f58" role="button"
                   aria-expanded="false" aria-controls="id-d3b5d90f12ae57ac36424f58">
                    <code>trie/stacktrie_test.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/3f40e65c484486dea6cff80b7db178985d21a2c6/trie/stacktrie_test.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/650bb2f2b1dcfe30d9b1fa6f7dc9608055ed60e1/trie/stacktrie_test.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+1</span></div>
                        <div class="text-start"><span class="text-danger">-47</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-d3b5d90f12ae57ac36424f58"><span class="term-fg1">diff --git go-ethereum&#47;trie&#47;stacktrie_test.go op-geth&#47;trie&#47;stacktrie_test.go</span>
<span class="term-fg1">index 6bd0b83e396c420f73e1986da44fdd3d928cc712..0e52781c62ec789a0545f6c81a08fd16cc3100e0 100644</span>
<span class="term-fg1">--- go-ethereum&#47;trie&#47;stacktrie_test.go</span>
<span class="term-fg1">+++ op-geth&#47;trie&#47;stacktrie_test.go</span>
<span class="term-fg36">@@ -198,12 +198,11 @@</span> 			{&quot;000002&quot;, &quot;Y&quot;, &quot;2130735e600f612f6e657a32bd7be64ddcaec6512c5694844b19de713922895d&quot;},
 			{&quot;000003&quot;, &quot;XXXXXXXXXXXXXXXXXXXXXXXXXXXX&quot;, &quot;962c0fffdeef7612a4f7bff1950d67e3e81c878e48b9ae45b3b374253b050bd8&quot;},
 		},
 	}
<span class="term-fg31">-	st := NewStackTrie(nil)</span>
 	for i, test := range tests {
 		&#47;&#47; The StackTrie does not allow Insert(), Hash(), Insert(), ...
 		&#47;&#47; so we will create new trie for every sequence length of inserts.
 		for l := 1; l &lt;= len(test); l++ {
<span class="term-fg31">-			st.Reset()</span>
<span class="term-fg32">+			st := NewStackTrie(nil)</span>
 			for j := 0; j &lt; l; j++ {
 				kv := &amp;test[j]
 				if err := st.Update(common.FromHex(kv.K), []byte(kv.V)); err != nil {
<span class="term-fg36">@@ -377,48 +376,3 @@</span> 			t.Fatalf(&quot;item %d, have %#x want %#x&quot;, i, have, want)
 		}
 	}
 }
<span class="term-fg31">-</span>
<span class="term-fg31">-&#47;&#47; TestStacktrieSerialization tests that the stacktrie works well if we</span>
<span class="term-fg31">-&#47;&#47; serialize&#47;unserialize it a lot</span>
<span class="term-fg31">-func TestStacktrieSerialization(t *testing.T) {</span>
<span class="term-fg31">-	var (</span>
<span class="term-fg31">-		st       = NewStackTrie(nil)</span>
<span class="term-fg31">-		nt       = NewEmpty(NewDatabase(rawdb.NewMemoryDatabase(), nil))</span>
<span class="term-fg31">-		keyB     = big.NewInt(1)</span>
<span class="term-fg31">-		keyDelta = big.NewInt(1)</span>
<span class="term-fg31">-		vals     [][]byte</span>
<span class="term-fg31">-		keys     [][]byte</span>
<span class="term-fg31">-	)</span>
<span class="term-fg31">-	getValue := func(i int) []byte {</span>
<span class="term-fg31">-		if i%2 == 0 { &#47;&#47; large</span>
<span class="term-fg31">-			return crypto.Keccak256(big.NewInt(int64(i)).Bytes())</span>
<span class="term-fg31">-		} else { &#47;&#47;small</span>
<span class="term-fg31">-			return big.NewInt(int64(i)).Bytes()</span>
<span class="term-fg31">-		}</span>
<span class="term-fg31">-	}</span>
<span class="term-fg31">-	for i := 0; i &lt; 10; i++ {</span>
<span class="term-fg31">-		vals = append(vals, getValue(i))</span>
<span class="term-fg31">-		keys = append(keys, common.BigToHash(keyB).Bytes())</span>
<span class="term-fg31">-		keyB = keyB.Add(keyB, keyDelta)</span>
<span class="term-fg31">-		keyDelta.Add(keyDelta, common.Big1)</span>
<span class="term-fg31">-	}</span>
<span class="term-fg31">-	for i, k := range keys {</span>
<span class="term-fg31">-		nt.Update(k, common.CopyBytes(vals[i]))</span>
<span class="term-fg31">-	}</span>
<span class="term-fg31">-</span>
<span class="term-fg31">-	for i, k := range keys {</span>
<span class="term-fg31">-		blob, err := st.MarshalBinary()</span>
<span class="term-fg31">-		if err != nil {</span>
<span class="term-fg31">-			t.Fatal(err)</span>
<span class="term-fg31">-		}</span>
<span class="term-fg31">-		newSt, err := NewFromBinary(blob, nil)</span>
<span class="term-fg31">-		if err != nil {</span>
<span class="term-fg31">-			t.Fatal(err)</span>
<span class="term-fg31">-		}</span>
<span class="term-fg31">-		st = newSt</span>
<span class="term-fg31">-		st.Update(k, common.CopyBytes(vals[i]))</span>
<span class="term-fg31">-	}</span>
<span class="term-fg31">-	if have, want := st.Hash(), nt.Hash(); have != want {</span>
<span class="term-fg31">-		t.Fatalf(&quot;have %#x want %#x&quot;, have, want)</span>
<span class="term-fg31">-	}</span>
<span class="term-fg31">-}</span></div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-c5dff4dd29da3dac118cb598" role="button"
                   aria-expanded="false" aria-controls="id-c5dff4dd29da3dac118cb598">
                    <code>trie/sync.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/3f40e65c484486dea6cff80b7db178985d21a2c6/trie/sync.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/650bb2f2b1dcfe30d9b1fa6f7dc9608055ed60e1/trie/sync.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+84</span></div>
                        <div class="text-start"><span class="text-danger">-21</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-c5dff4dd29da3dac118cb598"><span class="term-fg1">diff --git go-ethereum&#47;trie&#47;sync.go op-geth&#47;trie&#47;sync.go</span>
<span class="term-fg1">index 4f55845991796307b7b81562fa0d50f57b39c828..6939aed76d4b941695207db20272ee99607aebb0 100644</span>
<span class="term-fg1">--- go-ethereum&#47;trie&#47;sync.go</span>
<span class="term-fg1">+++ op-geth&#47;trie&#47;sync.go</span>
<span class="term-fg36">@@ -27,6 +27,7 @@</span> 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;core&#47;rawdb&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;core&#47;types&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;ethdb&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;log&quot;
<span class="term-fg32">+	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;metrics&quot;</span>
 )
&nbsp;
 &#47;&#47; ErrNotRequested is returned by the trie sync when it&#39;s requested to process a
<span class="term-fg36">@@ -41,6 +42,16 @@</span> &#47;&#47; maxFetchesPerDepth is the maximum number of pending trie nodes per depth. The
 &#47;&#47; role of this value is to limit the number of trie nodes that get expanded in
 &#47;&#47; memory if the node was configured with a significant number of peers.
 const maxFetchesPerDepth = 16384
<span class="term-fg32">+</span>
<span class="term-fg32">+var (</span>
<span class="term-fg32">+	&#47;&#47; deletionGauge is the metric to track how many trie node deletions</span>
<span class="term-fg32">+	&#47;&#47; are performed in total during the sync process.</span>
<span class="term-fg32">+	deletionGauge = metrics.NewRegisteredGauge(&quot;trie&#47;sync&#47;delete&quot;, nil)</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	&#47;&#47; lookupGauge is the metric to track how many trie node lookups are</span>
<span class="term-fg32">+	&#47;&#47; performed to determine if node needs to be deleted.</span>
<span class="term-fg32">+	lookupGauge = metrics.NewRegisteredGauge(&quot;trie&#47;sync&#47;lookup&quot;, nil)</span>
<span class="term-fg32">+)</span>
&nbsp;
 &#47;&#47; SyncPath is a path tuple identifying a particular trie node either in a single
 &#47;&#47; trie (account) or a layered trie (account -&gt; storage).
<span class="term-fg36">@@ -93,9 +104,10 @@</span> type LeafCallback func(keys [][]byte, path []byte, leaf []byte, parent common.Hash, parentPath []byte) error
&nbsp;
 &#47;&#47; nodeRequest represents a scheduled or already in-flight trie node retrieval request.
 type nodeRequest struct {
<span class="term-fg31">-	hash common.Hash &#47;&#47; Hash of the trie node to retrieve</span>
<span class="term-fg31">-	path []byte      &#47;&#47; Merkle path leading to this node for prioritization</span>
<span class="term-fg31">-	data []byte      &#47;&#47; Data content of the node, cached until all subtrees complete</span>
<span class="term-fg32">+	hash    common.Hash &#47;&#47; Hash of the trie node to retrieve</span>
<span class="term-fg32">+	path    []byte      &#47;&#47; Merkle path leading to this node for prioritization</span>
<span class="term-fg32">+	data    []byte      &#47;&#47; Data content of the node, cached until all subtrees complete</span>
<span class="term-fg32">+	deletes [][]byte    &#47;&#47; List of internal path segments for trie nodes to delete</span>
&nbsp;
 	parent   *nodeRequest &#47;&#47; Parent state node referencing this entry
 	deps     int          &#47;&#47; Number of dependencies before allowed to commit this node
<span class="term-fg36">@@ -125,18 +137,20 @@</span>
 &#47;&#47; syncMemBatch is an in-memory buffer of successfully downloaded but not yet
 &#47;&#47; persisted data items.
 type syncMemBatch struct {
<span class="term-fg31">-	nodes  map[string][]byte      &#47;&#47; In-memory membatch of recently completed nodes</span>
<span class="term-fg31">-	hashes map[string]common.Hash &#47;&#47; Hashes of recently completed nodes</span>
<span class="term-fg31">-	codes  map[common.Hash][]byte &#47;&#47; In-memory membatch of recently completed codes</span>
<span class="term-fg31">-	size   uint64                 &#47;&#47; Estimated batch-size of in-memory data.</span>
<span class="term-fg32">+	nodes   map[string][]byte      &#47;&#47; In-memory membatch of recently completed nodes</span>
<span class="term-fg32">+	hashes  map[string]common.Hash &#47;&#47; Hashes of recently completed nodes</span>
<span class="term-fg32">+	deletes map[string]struct{}    &#47;&#47; List of paths for trie node to delete</span>
<span class="term-fg32">+	codes   map[common.Hash][]byte &#47;&#47; In-memory membatch of recently completed codes</span>
<span class="term-fg32">+	size    uint64                 &#47;&#47; Estimated batch-size of in-memory data.</span>
 }
&nbsp;
 &#47;&#47; newSyncMemBatch allocates a new memory-buffer for not-yet persisted trie nodes.
 func newSyncMemBatch() *syncMemBatch {
 	return &amp;syncMemBatch{
<span class="term-fg31">-		nodes:  make(map[string][]byte),</span>
<span class="term-fg31">-		hashes: make(map[string]common.Hash),</span>
<span class="term-fg31">-		codes:  make(map[common.Hash][]byte),</span>
<span class="term-fg32">+		nodes:   make(map[string][]byte),</span>
<span class="term-fg32">+		hashes:  make(map[string]common.Hash),</span>
<span class="term-fg32">+		deletes: make(map[string]struct{}),</span>
<span class="term-fg32">+		codes:   make(map[common.Hash][]byte),</span>
 	}
 }
&nbsp;
<span class="term-fg36">@@ -288,7 +302,7 @@</span> 	return nodePaths, nodeHashes, codeHashes
 }
&nbsp;
 &#47;&#47; ProcessCode injects the received data for requested item. Note it can
<span class="term-fg31">-&#47;&#47; happpen that the single response commits two pending requests(e.g.</span>
<span class="term-fg32">+&#47;&#47; happen that the single response commits two pending requests(e.g.</span>
 &#47;&#47; there are two requests one for code and one for node but the hash
 &#47;&#47; is same). In this case the second response for the same hash will
 &#47;&#47; be treated as &quot;non-requested&quot; item or &quot;already-processed&quot; item but
<span class="term-fg36">@@ -347,16 +361,23 @@</span>
 &#47;&#47; Commit flushes the data stored in the internal membatch out to persistent
 &#47;&#47; storage, returning any occurred error.
 func (s *Sync) Commit(dbw ethdb.Batch) error {
<span class="term-fg31">-	&#47;&#47; Dump the membatch into a database dbw</span>
<span class="term-fg32">+	&#47;&#47; Flush the pending node writes into database batch.</span>
 	for path, value := range s.membatch.nodes {
 		owner, inner := ResolvePath([]byte(path))
 		rawdb.WriteTrieNode(dbw, owner, inner, s.membatch.hashes[path], value, s.scheme)
 	}
<span class="term-fg32">+	&#47;&#47; Flush the pending node deletes into the database batch.</span>
<span class="term-fg32">+	&#47;&#47; Please note that each written and deleted node has a</span>
<span class="term-fg32">+	&#47;&#47; unique path, ensuring no duplication occurs.</span>
<span class="term-fg32">+	for path := range s.membatch.deletes {</span>
<span class="term-fg32">+		owner, inner := ResolvePath([]byte(path))</span>
<span class="term-fg32">+		rawdb.DeleteTrieNode(dbw, owner, inner, common.Hash{} &#47;* unused *&#47;, s.scheme)</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	&#47;&#47; Flush the pending code writes into database batch.</span>
 	for hash, value := range s.membatch.codes {
 		rawdb.WriteCode(dbw, hash, value)
 	}
<span class="term-fg31">-	&#47;&#47; Drop the membatch data and return</span>
<span class="term-fg31">-	s.membatch = newSyncMemBatch()</span>
<span class="term-fg32">+	s.membatch = newSyncMemBatch() &#47;&#47; reset the batch</span>
 	return nil
 }
&nbsp;
<span class="term-fg36">@@ -370,7 +391,7 @@</span> func (s *Sync) Pending() int {
 	return len(s.nodeReqs) + len(s.codeReqs)
 }
&nbsp;
<span class="term-fg31">-&#47;&#47; schedule inserts a new state retrieval request into the fetch queue. If there</span>
<span class="term-fg32">+&#47;&#47; scheduleNodeRequest inserts a new state retrieval request into the fetch queue. If there</span>
 &#47;&#47; is already a pending request for this node, the new request will be discarded
 &#47;&#47; and only a parent reference added to the old one.
 func (s *Sync) scheduleNodeRequest(req *nodeRequest) {
<span class="term-fg36">@@ -385,7 +406,7 @@</span> 	}
 	s.queue.Push(string(req.path), prio)
 }
&nbsp;
<span class="term-fg31">-&#47;&#47; schedule inserts a new state retrieval request into the fetch queue. If there</span>
<span class="term-fg32">+&#47;&#47; scheduleCodeRequest inserts a new state retrieval request into the fetch queue. If there</span>
 &#47;&#47; is already a pending request for this node, the new request will be discarded
 &#47;&#47; and only a parent reference added to the old one.
 func (s *Sync) scheduleCodeRequest(req *codeRequest) {
<span class="term-fg36">@@ -425,6 +446,39 @@</span> 		children = []childNode{{
 			node: node.Val,
 			path: append(append([]byte(nil), req.path...), key...),
 		}}
<span class="term-fg32">+		&#47;&#47; Mark all internal nodes between shortNode and its **in disk**</span>
<span class="term-fg32">+		&#47;&#47; child as invalid. This is essential in the case of path mode</span>
<span class="term-fg32">+		&#47;&#47; scheme; otherwise, state healing might overwrite existing child</span>
<span class="term-fg32">+		&#47;&#47; nodes silently while leaving a dangling parent node within the</span>
<span class="term-fg32">+		&#47;&#47; range of this internal path on disk. This would break the</span>
<span class="term-fg32">+		&#47;&#47; guarantee for state healing.</span>
<span class="term-fg32">+		&#47;&#47;</span>
<span class="term-fg32">+		&#47;&#47; While it&#39;s possible for this shortNode to overwrite a previously</span>
<span class="term-fg32">+		&#47;&#47; existing full node, the other branches of the fullNode can be</span>
<span class="term-fg32">+		&#47;&#47; retained as they remain untouched and complete.</span>
<span class="term-fg32">+		&#47;&#47;</span>
<span class="term-fg32">+		&#47;&#47; This step is only necessary for path mode, as there is no deletion</span>
<span class="term-fg32">+		&#47;&#47; in hash mode at all.</span>
<span class="term-fg32">+		if _, ok := node.Val.(hashNode); ok &amp;&amp; s.scheme == rawdb.PathScheme {</span>
<span class="term-fg32">+			owner, inner := ResolvePath(req.path)</span>
<span class="term-fg32">+			for i := 1; i &lt; len(key); i++ {</span>
<span class="term-fg32">+				&#47;&#47; While checking for a non-existent item in Pebble can be less efficient</span>
<span class="term-fg32">+				&#47;&#47; without a bloom filter, the relatively low frequency of lookups makes</span>
<span class="term-fg32">+				&#47;&#47; the performance impact negligible.</span>
<span class="term-fg32">+				var exists bool</span>
<span class="term-fg32">+				if owner == (common.Hash{}) {</span>
<span class="term-fg32">+					exists = rawdb.ExistsAccountTrieNode(s.database, append(inner, key[:i]...))</span>
<span class="term-fg32">+				} else {</span>
<span class="term-fg32">+					exists = rawdb.ExistsStorageTrieNode(s.database, owner, append(inner, key[:i]...))</span>
<span class="term-fg32">+				}</span>
<span class="term-fg32">+				if exists {</span>
<span class="term-fg32">+					req.deletes = append(req.deletes, key[:i])</span>
<span class="term-fg32">+					deletionGauge.Inc(1)</span>
<span class="term-fg32">+					log.Debug(&quot;Detected dangling node&quot;, &quot;owner&quot;, owner, &quot;path&quot;, append(inner, key[:i]...))</span>
<span class="term-fg32">+				}</span>
<span class="term-fg32">+			}</span>
<span class="term-fg32">+			lookupGauge.Inc(int64(len(key) - 1))</span>
<span class="term-fg32">+		}</span>
 	case *fullNode:
 		for i := 0; i &lt; 17; i++ {
 			if node.Children[i] != nil {
<span class="term-fg36">@@ -502,17 +556,26 @@</span> 	}
 	return requests, nil
 }
&nbsp;
<span class="term-fg31">-&#47;&#47; commit finalizes a retrieval request and stores it into the membatch. If any</span>
<span class="term-fg32">+&#47;&#47; commitNodeRequest finalizes a retrieval request and stores it into the membatch. If any</span>
 &#47;&#47; of the referencing parent requests complete due to this commit, they are also
 &#47;&#47; committed themselves.
 func (s *Sync) commitNodeRequest(req *nodeRequest) error {
 	&#47;&#47; Write the node content to the membatch
 	s.membatch.nodes[string(req.path)] = req.data
 	s.membatch.hashes[string(req.path)] = req.hash
<span class="term-fg32">+</span>
 	&#47;&#47; The size tracking refers to the db-batch, not the in-memory data.
<span class="term-fg31">-	&#47;&#47; Therefore, we ignore the req.path, and account only for the hash+data</span>
<span class="term-fg31">-	&#47;&#47; which eventually is written to db.</span>
<span class="term-fg31">-	s.membatch.size += common.HashLength + uint64(len(req.data))</span>
<span class="term-fg32">+	if s.scheme == rawdb.PathScheme {</span>
<span class="term-fg32">+		s.membatch.size += uint64(len(req.path) + len(req.data))</span>
<span class="term-fg32">+	} else {</span>
<span class="term-fg32">+		s.membatch.size += common.HashLength + uint64(len(req.data))</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	&#47;&#47; Delete the internal nodes which are marked as invalid</span>
<span class="term-fg32">+	for _, segment := range req.deletes {</span>
<span class="term-fg32">+		path := append(req.path, segment...)</span>
<span class="term-fg32">+		s.membatch.deletes[string(path)] = struct{}{}</span>
<span class="term-fg32">+		s.membatch.size += uint64(len(path))</span>
<span class="term-fg32">+	}</span>
 	delete(s.nodeReqs, string(req.path))
 	s.fetches[len(req.path)]--
&nbsp;
<span class="term-fg36">@@ -528,7 +591,7 @@</span> 	}
 	return nil
 }
&nbsp;
<span class="term-fg31">-&#47;&#47; commit finalizes a retrieval request and stores it into the membatch. If any</span>
<span class="term-fg32">+&#47;&#47; commitCodeRequest finalizes a retrieval request and stores it into the membatch. If any</span>
 &#47;&#47; of the referencing parent requests complete due to this commit, they are also
 &#47;&#47; committed themselves.
 func (s *Sync) commitCodeRequest(req *codeRequest) error {</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-6956bf64d4fd7a8b11dce8ab" role="button"
                   aria-expanded="false" aria-controls="id-6956bf64d4fd7a8b11dce8ab">
                    <code>trie/sync_test.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/3f40e65c484486dea6cff80b7db178985d21a2c6/trie/sync_test.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/650bb2f2b1dcfe30d9b1fa6f7dc9608055ed60e1/trie/sync_test.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+139</span></div>
                        <div class="text-start"><span class="text-danger">-24</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-6956bf64d4fd7a8b11dce8ab"><span class="term-fg1">diff --git go-ethereum&#47;trie&#47;sync_test.go op-geth&#47;trie&#47;sync_test.go</span>
<span class="term-fg1">index dd3506559df72094f1d6cf9e2a37c0774e7d8ece..3b7986ef67922c185022b2461d9d73c380fe34ab 100644</span>
<span class="term-fg1">--- go-ethereum&#47;trie&#47;sync_test.go</span>
<span class="term-fg1">+++ op-geth&#47;trie&#47;sync_test.go</span>
<span class="term-fg36">@@ -70,31 +70,53 @@</span> }
&nbsp;
 &#47;&#47; checkTrieContents cross references a reconstructed trie with an expected data
 &#47;&#47; content map.
<span class="term-fg31">-func checkTrieContents(t *testing.T, db ethdb.Database, scheme string, root []byte, content map[string][]byte) {</span>
<span class="term-fg32">+func checkTrieContents(t *testing.T, db ethdb.Database, scheme string, root []byte, content map[string][]byte, rawTrie bool) {</span>
 	&#47;&#47; Check root availability and trie contents
 	ndb := newTestDatabase(db, scheme)
<span class="term-fg31">-	trie, err := NewStateTrie(TrieID(common.BytesToHash(root)), ndb)</span>
<span class="term-fg31">-	if err != nil {</span>
<span class="term-fg31">-		t.Fatalf(&quot;failed to create trie at %x: %v&quot;, root, err)</span>
<span class="term-fg32">+	if err := checkTrieConsistency(db, scheme, common.BytesToHash(root), rawTrie); err != nil {</span>
<span class="term-fg32">+		t.Fatalf(&quot;inconsistent trie at %x: %v&quot;, root, err)</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	type reader interface {</span>
<span class="term-fg32">+		MustGet(key []byte) []byte</span>
 	}
<span class="term-fg31">-	if err := checkTrieConsistency(db, scheme, common.BytesToHash(root)); err != nil {</span>
<span class="term-fg31">-		t.Fatalf(&quot;inconsistent trie at %x: %v&quot;, root, err)</span>
<span class="term-fg32">+	var r reader</span>
<span class="term-fg32">+	if rawTrie {</span>
<span class="term-fg32">+		trie, err := New(TrieID(common.BytesToHash(root)), ndb)</span>
<span class="term-fg32">+		if err != nil {</span>
<span class="term-fg32">+			t.Fatalf(&quot;failed to create trie at %x: %v&quot;, root, err)</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+		r = trie</span>
<span class="term-fg32">+	} else {</span>
<span class="term-fg32">+		trie, err := NewStateTrie(TrieID(common.BytesToHash(root)), ndb)</span>
<span class="term-fg32">+		if err != nil {</span>
<span class="term-fg32">+			t.Fatalf(&quot;failed to create trie at %x: %v&quot;, root, err)</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+		r = trie</span>
 	}
 	for key, val := range content {
<span class="term-fg31">-		if have := trie.MustGet([]byte(key)); !bytes.Equal(have, val) {</span>
<span class="term-fg32">+		if have := r.MustGet([]byte(key)); !bytes.Equal(have, val) {</span>
 			t.Errorf(&quot;entry %x: content mismatch: have %x, want %x&quot;, key, have, val)
 		}
 	}
 }
&nbsp;
 &#47;&#47; checkTrieConsistency checks that all nodes in a trie are indeed present.
<span class="term-fg31">-func checkTrieConsistency(db ethdb.Database, scheme string, root common.Hash) error {</span>
<span class="term-fg32">+func checkTrieConsistency(db ethdb.Database, scheme string, root common.Hash, rawTrie bool) error {</span>
 	ndb := newTestDatabase(db, scheme)
<span class="term-fg31">-	trie, err := NewStateTrie(TrieID(root), ndb)</span>
<span class="term-fg31">-	if err != nil {</span>
<span class="term-fg31">-		return nil &#47;&#47; Consider a non existent state consistent</span>
<span class="term-fg32">+	var it NodeIterator</span>
<span class="term-fg32">+	if rawTrie {</span>
<span class="term-fg32">+		trie, err := New(TrieID(root), ndb)</span>
<span class="term-fg32">+		if err != nil {</span>
<span class="term-fg32">+			return nil &#47;&#47; Consider a non existent state consistent</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+		it = trie.MustNodeIterator(nil)</span>
<span class="term-fg32">+	} else {</span>
<span class="term-fg32">+		trie, err := NewStateTrie(TrieID(root), ndb)</span>
<span class="term-fg32">+		if err != nil {</span>
<span class="term-fg32">+			return nil &#47;&#47; Consider a non existent state consistent</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+		it = trie.MustNodeIterator(nil)</span>
 	}
<span class="term-fg31">-	it := trie.MustNodeIterator(nil)</span>
 	for it.Next(true) {
 	}
 	return it.Error()
<span class="term-fg36">@@ -205,7 +227,7 @@</span> 			})
 		}
 	}
 	&#47;&#47; Cross check that the two tries are in sync
<span class="term-fg31">-	checkTrieContents(t, diskdb, srcDb.Scheme(), srcTrie.Hash().Bytes(), srcData)</span>
<span class="term-fg32">+	checkTrieContents(t, diskdb, srcDb.Scheme(), srcTrie.Hash().Bytes(), srcData, false)</span>
 }
&nbsp;
 &#47;&#47; Tests that the trie scheduler can correctly reconstruct the state even if only
<span class="term-fg36">@@ -271,7 +293,7 @@</span> 			})
 		}
 	}
 	&#47;&#47; Cross check that the two tries are in sync
<span class="term-fg31">-	checkTrieContents(t, diskdb, srcDb.Scheme(), srcTrie.Hash().Bytes(), srcData)</span>
<span class="term-fg32">+	checkTrieContents(t, diskdb, srcDb.Scheme(), srcTrie.Hash().Bytes(), srcData, false)</span>
 }
&nbsp;
 &#47;&#47; Tests that given a root hash, a trie can sync iteratively on a single thread,
<span class="term-fg36">@@ -341,7 +363,7 @@</span> 			}
 		}
 	}
 	&#47;&#47; Cross check that the two tries are in sync
<span class="term-fg31">-	checkTrieContents(t, diskdb, srcDb.Scheme(), srcTrie.Hash().Bytes(), srcData)</span>
<span class="term-fg32">+	checkTrieContents(t, diskdb, srcDb.Scheme(), srcTrie.Hash().Bytes(), srcData, false)</span>
 }
&nbsp;
 &#47;&#47; Tests that the trie scheduler can correctly reconstruct the state even if only
<span class="term-fg36">@@ -413,7 +435,7 @@</span> 			}
 		}
 	}
 	&#47;&#47; Cross check that the two tries are in sync
<span class="term-fg31">-	checkTrieContents(t, diskdb, srcDb.Scheme(), srcTrie.Hash().Bytes(), srcData)</span>
<span class="term-fg32">+	checkTrieContents(t, diskdb, srcDb.Scheme(), srcTrie.Hash().Bytes(), srcData, false)</span>
 }
&nbsp;
 &#47;&#47; Tests that a trie sync will not request nodes multiple times, even if they
<span class="term-fg36">@@ -484,7 +506,7 @@</span> 			})
 		}
 	}
 	&#47;&#47; Cross check that the two tries are in sync
<span class="term-fg31">-	checkTrieContents(t, diskdb, srcDb.Scheme(), srcTrie.Hash().Bytes(), srcData)</span>
<span class="term-fg32">+	checkTrieContents(t, diskdb, srcDb.Scheme(), srcTrie.Hash().Bytes(), srcData, false)</span>
 }
&nbsp;
 &#47;&#47; Tests that at any point in time during a sync, only complete sub-tries are in
<span class="term-fg36">@@ -569,7 +591,7 @@</span> 		owner, inner := ResolvePath([]byte(path))
 		nodeHash := addedHashes[i]
 		value := rawdb.ReadTrieNode(diskdb, owner, inner, nodeHash, scheme)
 		rawdb.DeleteTrieNode(diskdb, owner, inner, nodeHash, scheme)
<span class="term-fg31">-		if err := checkTrieConsistency(diskdb, srcDb.Scheme(), root); err == nil {</span>
<span class="term-fg32">+		if err := checkTrieConsistency(diskdb, srcDb.Scheme(), root, false); err == nil {</span>
 			t.Fatalf(&quot;trie inconsistency not caught, missing: %x&quot;, path)
 		}
 		rawdb.WriteTrieNode(diskdb, owner, inner, nodeHash, value, scheme)
<span class="term-fg36">@@ -643,7 +665,7 @@</span> 			reqs = append(reqs, NewSyncPath([]byte(paths[i])))
 		}
 	}
 	&#47;&#47; Cross check that the two tries are in sync
<span class="term-fg31">-	checkTrieContents(t, diskdb, srcDb.Scheme(), srcTrie.Hash().Bytes(), srcData)</span>
<span class="term-fg32">+	checkTrieContents(t, diskdb, srcDb.Scheme(), srcTrie.Hash().Bytes(), srcData, false)</span>
&nbsp;
 	&#47;&#47; Check that the trie nodes have been requested path-ordered
 	for i := 0; i &lt; len(reqs)-1; i++ {
<span class="term-fg36">@@ -664,7 +686,7 @@</span> 	sched := NewSync(root, db, nil, srcDb.Scheme())
&nbsp;
 	&#47;&#47; The code requests are ignored here since there is no code
 	&#47;&#47; at the testing trie.
<span class="term-fg31">-	paths, nodes, _ := sched.Missing(1)</span>
<span class="term-fg32">+	paths, nodes, _ := sched.Missing(0)</span>
 	var elements []trieElement
 	for i := 0; i &lt; len(paths); i++ {
 		elements = append(elements, trieElement{
<span class="term-fg36">@@ -698,7 +720,7 @@</span> 			t.Fatalf(&quot;failed to commit data: %v&quot;, err)
 		}
 		batch.Write()
&nbsp;
<span class="term-fg31">-		paths, nodes, _ = sched.Missing(1)</span>
<span class="term-fg32">+		paths, nodes, _ = sched.Missing(0)</span>
 		elements = elements[:0]
 		for i := 0; i &lt; len(paths); i++ {
 			elements = append(elements, trieElement{
<span class="term-fg36">@@ -724,7 +746,7 @@</span>
 	&#47;&#47; Create a destination trie and sync with the scheduler
 	diskdb := rawdb.NewMemoryDatabase()
 	syncWith(t, srcTrie.Hash(), diskdb, srcDb)
<span class="term-fg31">-	checkTrieContents(t, diskdb, srcDb.Scheme(), srcTrie.Hash().Bytes(), srcData)</span>
<span class="term-fg32">+	checkTrieContents(t, diskdb, srcDb.Scheme(), srcTrie.Hash().Bytes(), srcData, false)</span>
&nbsp;
 	&#47;&#47; Push more modifications into the src trie, to see if dest trie can still
 	&#47;&#47; sync with it(overwrite stale states)
<span class="term-fg36">@@ -748,7 +770,7 @@</span> 	preRoot = root
 	srcTrie, _ = NewStateTrie(TrieID(root), srcDb)
&nbsp;
 	syncWith(t, srcTrie.Hash(), diskdb, srcDb)
<span class="term-fg31">-	checkTrieContents(t, diskdb, srcDb.Scheme(), srcTrie.Hash().Bytes(), diff)</span>
<span class="term-fg32">+	checkTrieContents(t, diskdb, srcDb.Scheme(), srcTrie.Hash().Bytes(), diff, false)</span>
&nbsp;
 	&#47;&#47; Revert added modifications from the src trie, to see if dest trie can still
 	&#47;&#47; sync with it(overwrite reverted states)
<span class="term-fg36">@@ -772,5 +794,98 @@</span> 	}
 	srcTrie, _ = NewStateTrie(TrieID(root), srcDb)
&nbsp;
 	syncWith(t, srcTrie.Hash(), diskdb, srcDb)
<span class="term-fg31">-	checkTrieContents(t, diskdb, srcDb.Scheme(), srcTrie.Hash().Bytes(), reverted)</span>
<span class="term-fg32">+	checkTrieContents(t, diskdb, srcDb.Scheme(), srcTrie.Hash().Bytes(), reverted, false)</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+&#47;&#47; Tests if state syncer can correctly catch up the pivot move.</span>
<span class="term-fg32">+func TestPivotMove(t *testing.T) {</span>
<span class="term-fg32">+	testPivotMove(t, rawdb.HashScheme, true)</span>
<span class="term-fg32">+	testPivotMove(t, rawdb.HashScheme, false)</span>
<span class="term-fg32">+	testPivotMove(t, rawdb.PathScheme, true)</span>
<span class="term-fg32">+	testPivotMove(t, rawdb.PathScheme, false)</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+func testPivotMove(t *testing.T, scheme string, tiny bool) {</span>
<span class="term-fg32">+	var (</span>
<span class="term-fg32">+		srcDisk    = rawdb.NewMemoryDatabase()</span>
<span class="term-fg32">+		srcTrieDB  = newTestDatabase(srcDisk, scheme)</span>
<span class="term-fg32">+		srcTrie, _ = New(TrieID(types.EmptyRootHash), srcTrieDB)</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+		deleteFn = func(key []byte, tr *Trie, states map[string][]byte) {</span>
<span class="term-fg32">+			tr.Delete(key)</span>
<span class="term-fg32">+			delete(states, string(key))</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+		writeFn = func(key []byte, val []byte, tr *Trie, states map[string][]byte) {</span>
<span class="term-fg32">+			if val == nil {</span>
<span class="term-fg32">+				if tiny {</span>
<span class="term-fg32">+					val = randBytes(4)</span>
<span class="term-fg32">+				} else {</span>
<span class="term-fg32">+					val = randBytes(32)</span>
<span class="term-fg32">+				}</span>
<span class="term-fg32">+			}</span>
<span class="term-fg32">+			tr.Update(key, val)</span>
<span class="term-fg32">+			states[string(key)] = common.CopyBytes(val)</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+		copyStates = func(states map[string][]byte) map[string][]byte {</span>
<span class="term-fg32">+			cpy := make(map[string][]byte)</span>
<span class="term-fg32">+			for k, v := range states {</span>
<span class="term-fg32">+				cpy[k] = v</span>
<span class="term-fg32">+			}</span>
<span class="term-fg32">+			return cpy</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+	)</span>
<span class="term-fg32">+	stateA := make(map[string][]byte)</span>
<span class="term-fg32">+	writeFn([]byte{0x01, 0x23}, nil, srcTrie, stateA)</span>
<span class="term-fg32">+	writeFn([]byte{0x01, 0x24}, nil, srcTrie, stateA)</span>
<span class="term-fg32">+	writeFn([]byte{0x12, 0x33}, nil, srcTrie, stateA)</span>
<span class="term-fg32">+	writeFn([]byte{0x12, 0x34}, nil, srcTrie, stateA)</span>
<span class="term-fg32">+	writeFn([]byte{0x02, 0x34}, nil, srcTrie, stateA)</span>
<span class="term-fg32">+	writeFn([]byte{0x13, 0x44}, nil, srcTrie, stateA)</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	rootA, nodesA, _ := srcTrie.Commit(false)</span>
<span class="term-fg32">+	if err := srcTrieDB.Update(rootA, types.EmptyRootHash, 0, trienode.NewWithNodeSet(nodesA), nil); err != nil {</span>
<span class="term-fg32">+		panic(err)</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	if err := srcTrieDB.Commit(rootA, false); err != nil {</span>
<span class="term-fg32">+		panic(err)</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	&#47;&#47; Create a destination trie and sync with the scheduler</span>
<span class="term-fg32">+	destDisk := rawdb.NewMemoryDatabase()</span>
<span class="term-fg32">+	syncWith(t, rootA, destDisk, srcTrieDB)</span>
<span class="term-fg32">+	checkTrieContents(t, destDisk, scheme, srcTrie.Hash().Bytes(), stateA, true)</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	&#47;&#47; Delete element to collapse trie</span>
<span class="term-fg32">+	stateB := copyStates(stateA)</span>
<span class="term-fg32">+	srcTrie, _ = New(TrieID(rootA), srcTrieDB)</span>
<span class="term-fg32">+	deleteFn([]byte{0x02, 0x34}, srcTrie, stateB)</span>
<span class="term-fg32">+	deleteFn([]byte{0x13, 0x44}, srcTrie, stateB)</span>
<span class="term-fg32">+	writeFn([]byte{0x01, 0x24}, nil, srcTrie, stateB)</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	rootB, nodesB, _ := srcTrie.Commit(false)</span>
<span class="term-fg32">+	if err := srcTrieDB.Update(rootB, rootA, 0, trienode.NewWithNodeSet(nodesB), nil); err != nil {</span>
<span class="term-fg32">+		panic(err)</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	if err := srcTrieDB.Commit(rootB, false); err != nil {</span>
<span class="term-fg32">+		panic(err)</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	syncWith(t, rootB, destDisk, srcTrieDB)</span>
<span class="term-fg32">+	checkTrieContents(t, destDisk, scheme, srcTrie.Hash().Bytes(), stateB, true)</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	&#47;&#47; Add elements to expand trie</span>
<span class="term-fg32">+	stateC := copyStates(stateB)</span>
<span class="term-fg32">+	srcTrie, _ = New(TrieID(rootB), srcTrieDB)</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	writeFn([]byte{0x01, 0x24}, stateA[string([]byte{0x01, 0x24})], srcTrie, stateC)</span>
<span class="term-fg32">+	writeFn([]byte{0x02, 0x34}, nil, srcTrie, stateC)</span>
<span class="term-fg32">+	writeFn([]byte{0x13, 0x44}, nil, srcTrie, stateC)</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	rootC, nodesC, _ := srcTrie.Commit(false)</span>
<span class="term-fg32">+	if err := srcTrieDB.Update(rootC, rootB, 0, trienode.NewWithNodeSet(nodesC), nil); err != nil {</span>
<span class="term-fg32">+		panic(err)</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	if err := srcTrieDB.Commit(rootC, false); err != nil {</span>
<span class="term-fg32">+		panic(err)</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	syncWith(t, rootC, destDisk, srcTrieDB)</span>
<span class="term-fg32">+	checkTrieContents(t, destDisk, scheme, srcTrie.Hash().Bytes(), stateC, true)</span>
 }</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-78d684d4e7004a9ca70c1367" role="button"
                   aria-expanded="false" aria-controls="id-78d684d4e7004a9ca70c1367">
                    <code>trie/trie_test.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/3f40e65c484486dea6cff80b7db178985d21a2c6/trie/trie_test.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/650bb2f2b1dcfe30d9b1fa6f7dc9608055ed60e1/trie/trie_test.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+10</span></div>
                        <div class="text-start"><span class="text-danger">-6</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-78d684d4e7004a9ca70c1367"><span class="term-fg1">diff --git go-ethereum&#47;trie&#47;trie_test.go op-geth&#47;trie&#47;trie_test.go</span>
<span class="term-fg1">index 35ccc772010cc49550befc24609a67d00fe9b9d8..2dfe81ef81d2ffd7860c169074ae6c808b1c8a1a 100644</span>
<span class="term-fg1">--- go-ethereum&#47;trie&#47;trie_test.go</span>
<span class="term-fg1">+++ op-geth&#47;trie&#47;trie_test.go</span>
<span class="term-fg36">@@ -614,7 +614,9 @@</span> 	trie := NewEmpty(triedb)
 	k := make([]byte, 32)
 	for i := 0; i &lt; benchElemCount; i++ {
 		binary.LittleEndian.PutUint64(k, uint64(i))
<span class="term-fg31">-		trie.MustUpdate(k, k)</span>
<span class="term-fg32">+		v := make([]byte, 32)</span>
<span class="term-fg32">+		binary.LittleEndian.PutUint64(v, uint64(i))</span>
<span class="term-fg32">+		trie.MustUpdate(k, v)</span>
 	}
 	binary.LittleEndian.PutUint64(k, benchElemCount&#47;2)
&nbsp;
<span class="term-fg36">@@ -630,8 +632,10 @@</span> 	trie := NewEmpty(NewDatabase(rawdb.NewMemoryDatabase(), nil))
 	k := make([]byte, 32)
 	b.ReportAllocs()
 	for i := 0; i &lt; b.N; i++ {
<span class="term-fg32">+		v := make([]byte, 32)</span>
 		e.PutUint64(k, uint64(i))
<span class="term-fg31">-		trie.MustUpdate(k, k)</span>
<span class="term-fg32">+		e.PutUint64(v, uint64(i))</span>
<span class="term-fg32">+		trie.MustUpdate(k, v)</span>
 	}
 	return trie
 }
<span class="term-fg36">@@ -908,8 +912,8 @@</span> 		db := NewDatabase(rawdb.NewDatabase(s), nil)
 		trie := NewEmpty(db)
 		&#47;&#47; Another sponge is used for the stacktrie commits
 		stackTrieSponge := &amp;spongeDb{sponge: sha3.NewLegacyKeccak256(), id: &quot;b&quot;}
<span class="term-fg31">-		stTrie := NewStackTrie(func(owner common.Hash, path []byte, hash common.Hash, blob []byte) {</span>
<span class="term-fg31">-			rawdb.WriteTrieNode(stackTrieSponge, owner, path, hash, blob, db.Scheme())</span>
<span class="term-fg32">+		stTrie := NewStackTrie(func(path []byte, hash common.Hash, blob []byte) {</span>
<span class="term-fg32">+			rawdb.WriteTrieNode(stackTrieSponge, common.Hash{}, path, hash, blob, db.Scheme())</span>
 		})
 		&#47;&#47; Fill the trie with elements
 		for i := 0; i &lt; count; i++ {
<span class="term-fg36">@@ -967,8 +971,8 @@</span> 	db := NewDatabase(rawdb.NewDatabase(s), nil)
 	trie := NewEmpty(db)
 	&#47;&#47; Another sponge is used for the stacktrie commits
 	stackTrieSponge := &amp;spongeDb{sponge: sha3.NewLegacyKeccak256(), id: &quot;b&quot;}
<span class="term-fg31">-	stTrie := NewStackTrie(func(owner common.Hash, path []byte, hash common.Hash, blob []byte) {</span>
<span class="term-fg31">-		rawdb.WriteTrieNode(stackTrieSponge, owner, path, hash, blob, db.Scheme())</span>
<span class="term-fg32">+	stTrie := NewStackTrie(func(path []byte, hash common.Hash, blob []byte) {</span>
<span class="term-fg32">+		rawdb.WriteTrieNode(stackTrieSponge, common.Hash{}, path, hash, blob, db.Scheme())</span>
 	})
 	&#47;&#47; Add a single small-element to the trie(s)
 	key := make([]byte, 5)</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-beb404ddf005bae37527e5c9" role="button"
                   aria-expanded="false" aria-controls="id-beb404ddf005bae37527e5c9">
                    <code>trie/triedb/pathdb/database.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/3f40e65c484486dea6cff80b7db178985d21a2c6/trie/triedb/pathdb/database.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/650bb2f2b1dcfe30d9b1fa6f7dc9608055ed60e1/trie/triedb/pathdb/database.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+70</span></div>
                        <div class="text-start"><span class="text-danger">-31</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-beb404ddf005bae37527e5c9"><span class="term-fg1">diff --git go-ethereum&#47;trie&#47;triedb&#47;pathdb&#47;database.go op-geth&#47;trie&#47;triedb&#47;pathdb&#47;database.go</span>
<span class="term-fg1">index 18cc36ffc3412669b23ed4426335cbe5863da8e2..dc64414e9b520aeca5a08e6ca44b090680729dcf 100644</span>
<span class="term-fg1">--- go-ethereum&#47;trie&#47;triedb&#47;pathdb&#47;database.go</span>
<span class="term-fg1">+++ op-geth&#47;trie&#47;triedb&#47;pathdb&#47;database.go</span>
<span class="term-fg36">@@ -128,7 +128,8 @@</span> type Database struct {
 	&#47;&#47; readOnly is the flag whether the mutation is allowed to be applied.
 	&#47;&#47; It will be set automatically when the database is journaled during
 	&#47;&#47; the shutdown to reject all following unexpected mutations.
<span class="term-fg31">-	readOnly   bool                     &#47;&#47; Indicator if database is opened in read only mode</span>
<span class="term-fg32">+	readOnly   bool                     &#47;&#47; Flag if database is opened in read only mode</span>
<span class="term-fg32">+	waitSync   bool                     &#47;&#47; Flag if database is deactivated due to initial state sync</span>
 	bufferSize int                      &#47;&#47; Memory allowance (in bytes) for caching dirty nodes
 	config     *Config                  &#47;&#47; Configuration for database
 	diskdb     ethdb.Database           &#47;&#47; Persistent storage for matured trie nodes
<span class="term-fg36">@@ -179,6 +180,12 @@</span> 		if pruned != 0 {
 			log.Warn(&quot;Truncated extra state histories&quot;, &quot;number&quot;, pruned)
 		}
 	}
<span class="term-fg32">+	&#47;&#47; Disable database in case node is still in the initial state sync stage.</span>
<span class="term-fg32">+	if rawdb.ReadSnapSyncStatusFlag(diskdb) == rawdb.StateSyncRunning &amp;&amp; !db.readOnly {</span>
<span class="term-fg32">+		if err := db.Disable(); err != nil {</span>
<span class="term-fg32">+			log.Crit(&quot;Failed to disable database&quot;, &quot;err&quot;, err) &#47;&#47; impossible to happen</span>
<span class="term-fg32">+		}</span>
<span class="term-fg32">+	}</span>
 	log.Warn(&quot;Path-based state scheme is an experimental feature&quot;)
 	return db
 }
<span class="term-fg36">@@ -204,9 +211,9 @@</span> 	&#47;&#47; Hold the lock to prevent concurrent mutations.
 	db.lock.Lock()
 	defer db.lock.Unlock()
&nbsp;
<span class="term-fg31">-	&#47;&#47; Short circuit if the database is in read only mode.</span>
<span class="term-fg31">-	if db.readOnly {</span>
<span class="term-fg31">-		return errSnapshotReadOnly</span>
<span class="term-fg32">+	&#47;&#47; Short circuit if the mutation is not allowed.</span>
<span class="term-fg32">+	if err := db.modifyAllowed(); err != nil {</span>
<span class="term-fg32">+		return err</span>
 	}
 	if err := db.tree.add(root, parentRoot, block, nodes, states); err != nil {
 		return err
<span class="term-fg36">@@ -227,45 +234,59 @@</span> 	&#47;&#47; Hold the lock to prevent concurrent mutations.
 	db.lock.Lock()
 	defer db.lock.Unlock()
&nbsp;
<span class="term-fg32">+	&#47;&#47; Short circuit if the mutation is not allowed.</span>
<span class="term-fg32">+	if err := db.modifyAllowed(); err != nil {</span>
<span class="term-fg32">+		return err</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	return db.tree.cap(root, 0)</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+&#47;&#47; Disable deactivates the database and invalidates all available state layers</span>
<span class="term-fg32">+&#47;&#47; as stale to prevent access to the persistent state, which is in the syncing</span>
<span class="term-fg32">+&#47;&#47; stage.</span>
<span class="term-fg32">+func (db *Database) Disable() error {</span>
<span class="term-fg32">+	db.lock.Lock()</span>
<span class="term-fg32">+	defer db.lock.Unlock()</span>
<span class="term-fg32">+</span>
 	&#47;&#47; Short circuit if the database is in read only mode.
 	if db.readOnly {
<span class="term-fg31">-		return errSnapshotReadOnly</span>
<span class="term-fg32">+		return errDatabaseReadOnly</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	&#47;&#47; Prevent duplicated disable operation.</span>
<span class="term-fg32">+	if db.waitSync {</span>
<span class="term-fg32">+		log.Error(&quot;Reject duplicated disable operation&quot;)</span>
<span class="term-fg32">+		return nil</span>
 	}
<span class="term-fg31">-	return db.tree.cap(root, 0)</span>
<span class="term-fg32">+	db.waitSync = true</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	&#47;&#47; Mark the disk layer as stale to prevent access to persistent state.</span>
<span class="term-fg32">+	db.tree.bottom().markStale()</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	&#47;&#47; Write the initial sync flag to persist it across restarts.</span>
<span class="term-fg32">+	rawdb.WriteSnapSyncStatusFlag(db.diskdb, rawdb.StateSyncRunning)</span>
<span class="term-fg32">+	log.Info(&quot;Disabled trie database due to state sync&quot;)</span>
<span class="term-fg32">+	return nil</span>
 }
&nbsp;
<span class="term-fg31">-&#47;&#47; Reset rebuilds the database with the specified state as the base.</span>
<span class="term-fg31">-&#47;&#47;</span>
<span class="term-fg31">-&#47;&#47;   - if target state is empty, clear the stored state and all layers on top</span>
<span class="term-fg31">-&#47;&#47;   - if target state is non-empty, ensure the stored state matches with it</span>
<span class="term-fg31">-&#47;&#47;     and clear all other layers on top.</span>
<span class="term-fg31">-func (db *Database) Reset(root common.Hash) error {</span>
<span class="term-fg32">+&#47;&#47; Enable activates database and resets the state tree with the provided persistent</span>
<span class="term-fg32">+&#47;&#47; state root once the state sync is finished.</span>
<span class="term-fg32">+func (db *Database) Enable(root common.Hash) error {</span>
 	db.lock.Lock()
 	defer db.lock.Unlock()
&nbsp;
 	&#47;&#47; Short circuit if the database is in read only mode.
 	if db.readOnly {
<span class="term-fg31">-		return errSnapshotReadOnly</span>
<span class="term-fg32">+		return errDatabaseReadOnly</span>
 	}
<span class="term-fg31">-	batch := db.diskdb.NewBatch()</span>
<span class="term-fg32">+	&#47;&#47; Ensure the provided state root matches the stored one.</span>
 	root = types.TrieRootHash(root)
<span class="term-fg31">-	if root == types.EmptyRootHash {</span>
<span class="term-fg31">-		&#47;&#47; Empty state is requested as the target, nuke out</span>
<span class="term-fg31">-		&#47;&#47; the root node and leave all others as dangling.</span>
<span class="term-fg31">-		rawdb.DeleteAccountTrieNode(batch, nil)</span>
<span class="term-fg31">-	} else {</span>
<span class="term-fg31">-		&#47;&#47; Ensure the requested state is existent before any</span>
<span class="term-fg31">-		&#47;&#47; action is applied.</span>
<span class="term-fg31">-		_, hash := rawdb.ReadAccountTrieNode(db.diskdb, nil)</span>
<span class="term-fg31">-		if hash != root {</span>
<span class="term-fg31">-			return fmt.Errorf(&quot;state is mismatched, local: %x, target: %x&quot;, hash, root)</span>
<span class="term-fg31">-		}</span>
<span class="term-fg32">+	_, stored := rawdb.ReadAccountTrieNode(db.diskdb, nil)</span>
<span class="term-fg32">+	if stored != root {</span>
<span class="term-fg32">+		return fmt.Errorf(&quot;state root mismatch: stored %x, synced %x&quot;, stored, root)</span>
 	}
<span class="term-fg31">-	&#47;&#47; Mark the disk layer as stale before applying any mutation.</span>
<span class="term-fg31">-	db.tree.bottom().markStale()</span>
<span class="term-fg31">-</span>
 	&#47;&#47; Drop the stale state journal in persistent database and
 	&#47;&#47; reset the persistent state id back to zero.
<span class="term-fg32">+	batch := db.diskdb.NewBatch()</span>
 	rawdb.DeleteTrieJournal(batch)
 	rawdb.WritePersistentStateID(batch, 0)
 	if err := batch.Write(); err != nil {
<span class="term-fg36">@@ -282,8 +303,11 @@</span> 		}
 	}
 	&#47;&#47; Re-construct a new disk layer backed by persistent state
 	&#47;&#47; with **empty clean cache and node buffer**.
<span class="term-fg31">-	dl := newDiskLayer(root, 0, db, nil, newNodeBuffer(db.bufferSize, nil, 0))</span>
<span class="term-fg31">-	db.tree.reset(dl)</span>
<span class="term-fg32">+	db.tree.reset(newDiskLayer(root, 0, db, nil, newNodeBuffer(db.bufferSize, nil, 0)))</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	&#47;&#47; Re-enable the database as the final step.</span>
<span class="term-fg32">+	db.waitSync = false</span>
<span class="term-fg32">+	rawdb.WriteSnapSyncStatusFlag(db.diskdb, rawdb.StateSyncFinished)</span>
 	log.Info(&quot;Rebuilt trie database&quot;, &quot;root&quot;, root)
 	return nil
 }
<span class="term-fg36">@@ -296,7 +320,10 @@</span> 	db.lock.Lock()
 	defer db.lock.Unlock()
&nbsp;
 	&#47;&#47; Short circuit if rollback operation is not supported.
<span class="term-fg31">-	if db.readOnly || db.freezer == nil {</span>
<span class="term-fg32">+	if err := db.modifyAllowed(); err != nil {</span>
<span class="term-fg32">+		return err</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	if db.freezer == nil {</span>
 		return errors.New(&quot;state rollback is non-supported&quot;)
 	}
 	&#47;&#47; Short circuit if the target state is not recoverable.
<span class="term-fg36">@@ -424,3 +451,15 @@</span> &#47;&#47; Scheme returns the node scheme used in the database.
 func (db *Database) Scheme() string {
 	return rawdb.PathScheme
 }
<span class="term-fg32">+</span>
<span class="term-fg32">+&#47;&#47; modifyAllowed returns the indicator if mutation is allowed. This function</span>
<span class="term-fg32">+&#47;&#47; assumes the db.lock is already held.</span>
<span class="term-fg32">+func (db *Database) modifyAllowed() error {</span>
<span class="term-fg32">+	if db.readOnly {</span>
<span class="term-fg32">+		return errDatabaseReadOnly</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	if db.waitSync {</span>
<span class="term-fg32">+		return errDatabaseWaitSync</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	return nil</span>
<span class="term-fg32">+}</span></div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-d34210aaf7130592931d41b8" role="button"
                   aria-expanded="false" aria-controls="id-d34210aaf7130592931d41b8">
                    <code>trie/triedb/pathdb/database_test.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/3f40e65c484486dea6cff80b7db178985d21a2c6/trie/triedb/pathdb/database_test.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/650bb2f2b1dcfe30d9b1fa6f7dc9608055ed60e1/trie/triedb/pathdb/database_test.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+19</span></div>
                        <div class="text-start"><span class="text-danger">-18</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-d34210aaf7130592931d41b8"><span class="term-fg1">diff --git go-ethereum&#47;trie&#47;triedb&#47;pathdb&#47;database_test.go op-geth&#47;trie&#47;triedb&#47;pathdb&#47;database_test.go</span>
<span class="term-fg1">index 6d346d20ea0b7cc0439e945d6db682d8381685ac..912364f7f44a90cfd1491b925bac5443aa51b7a0 100644</span>
<span class="term-fg1">--- go-ethereum&#47;trie&#47;triedb&#47;pathdb&#47;database_test.go</span>
<span class="term-fg1">+++ op-geth&#47;trie&#47;triedb&#47;pathdb&#47;database_test.go</span>
<span class="term-fg36">@@ -439,38 +439,39 @@</span> 		}
 	}
 }
&nbsp;
<span class="term-fg31">-func TestReset(t *testing.T) {</span>
<span class="term-fg31">-	var (</span>
<span class="term-fg31">-		tester = newTester(t)</span>
<span class="term-fg31">-		index  = tester.bottomIndex()</span>
<span class="term-fg31">-	)</span>
<span class="term-fg32">+func TestDisable(t *testing.T) {</span>
<span class="term-fg32">+	tester := newTester(t)</span>
 	defer tester.release()
&nbsp;
<span class="term-fg31">-	&#47;&#47; Reset database to unknown target, should reject it</span>
<span class="term-fg31">-	if err := tester.db.Reset(testutil.RandomHash()); err == nil {</span>
<span class="term-fg31">-		t.Fatal(&quot;Failed to reject invalid reset&quot;)</span>
<span class="term-fg32">+	_, stored := rawdb.ReadAccountTrieNode(tester.db.diskdb, nil)</span>
<span class="term-fg32">+	if err := tester.db.Disable(); err != nil {</span>
<span class="term-fg32">+		t.Fatal(&quot;Failed to deactivate database&quot;)</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	if err := tester.db.Enable(types.EmptyRootHash); err == nil {</span>
<span class="term-fg32">+		t.Fatalf(&quot;Invalid activation should be rejected&quot;)</span>
 	}
<span class="term-fg31">-	&#47;&#47; Reset database to state persisted in the disk</span>
<span class="term-fg31">-	if err := tester.db.Reset(types.EmptyRootHash); err != nil {</span>
<span class="term-fg31">-		t.Fatalf(&quot;Failed to reset database %v&quot;, err)</span>
<span class="term-fg32">+	if err := tester.db.Enable(stored); err != nil {</span>
<span class="term-fg32">+		t.Fatal(&quot;Failed to activate database&quot;)</span>
 	}
<span class="term-fg32">+</span>
 	&#47;&#47; Ensure journal is deleted from disk
 	if blob := rawdb.ReadTrieJournal(tester.db.diskdb); len(blob) != 0 {
 		t.Fatal(&quot;Failed to clean journal&quot;)
 	}
 	&#47;&#47; Ensure all trie histories are removed
<span class="term-fg31">-	for i := 0; i &lt;= index; i++ {</span>
<span class="term-fg31">-		_, err := readHistory(tester.db.freezer, uint64(i+1))</span>
<span class="term-fg31">-		if err == nil {</span>
<span class="term-fg31">-			t.Fatalf(&quot;Failed to clean state history, index %d&quot;, i+1)</span>
<span class="term-fg31">-		}</span>
<span class="term-fg32">+	n, err := tester.db.freezer.Ancients()</span>
<span class="term-fg32">+	if err != nil {</span>
<span class="term-fg32">+		t.Fatal(&quot;Failed to clean state history&quot;)</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	if n != 0 {</span>
<span class="term-fg32">+		t.Fatal(&quot;Failed to clean state history&quot;)</span>
 	}
 	&#47;&#47; Verify layer tree structure, single disk layer is expected
 	if tester.db.tree.len() != 1 {
 		t.Fatalf(&quot;Extra layer kept %d&quot;, tester.db.tree.len())
 	}
<span class="term-fg31">-	if tester.db.tree.bottom().rootHash() != types.EmptyRootHash {</span>
<span class="term-fg31">-		t.Fatalf(&quot;Root hash is not matched exp %x got %x&quot;, types.EmptyRootHash, tester.db.tree.bottom().rootHash())</span>
<span class="term-fg32">+	if tester.db.tree.bottom().rootHash() != stored {</span>
<span class="term-fg32">+		t.Fatalf(&quot;Root hash is not matched exp %x got %x&quot;, stored, tester.db.tree.bottom().rootHash())</span>
 	}
 }
</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-df245bb9c0ead50d5480bfdc" role="button"
                   aria-expanded="false" aria-controls="id-df245bb9c0ead50d5480bfdc">
                    <code>trie/triedb/pathdb/difflayer.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/3f40e65c484486dea6cff80b7db178985d21a2c6/trie/triedb/pathdb/difflayer.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/650bb2f2b1dcfe30d9b1fa6f7dc9608055ed60e1/trie/triedb/pathdb/difflayer.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+1</span></div>
                        <div class="text-start"><span class="text-danger">-1</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-df245bb9c0ead50d5480bfdc"><span class="term-fg1">diff --git go-ethereum&#47;trie&#47;triedb&#47;pathdb&#47;difflayer.go op-geth&#47;trie&#47;triedb&#47;pathdb&#47;difflayer.go</span>
<span class="term-fg1">index d25ac1c601d79ef86145abefe20a2fd02b7e4a11..10567715d2e71e98052ed8d755e1aedf0356d234 100644</span>
<span class="term-fg1">--- go-ethereum&#47;trie&#47;triedb&#47;pathdb&#47;difflayer.go</span>
<span class="term-fg1">+++ op-geth&#47;trie&#47;triedb&#47;pathdb&#47;difflayer.go</span>
<span class="term-fg36">@@ -114,7 +114,7 @@</span> 			&#47;&#47; bubble up an error here. It shouldn&#39;t happen at all.
 			if n.Hash != hash {
 				dirtyFalseMeter.Mark(1)
 				log.Error(&quot;Unexpected trie node in diff layer&quot;, &quot;owner&quot;, owner, &quot;path&quot;, path, &quot;expect&quot;, hash, &quot;got&quot;, n.Hash)
<span class="term-fg31">-				return nil, newUnexpectedNodeError(&quot;diff&quot;, hash, n.Hash, owner, path)</span>
<span class="term-fg32">+				return nil, newUnexpectedNodeError(&quot;diff&quot;, hash, n.Hash, owner, path, n.Blob)</span>
 			}
 			dirtyHitMeter.Mark(1)
 			dirtyNodeHitDepthHist.Update(int64(depth))</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-6553739f7d9dc1bfffbcb1fa" role="button"
                   aria-expanded="false" aria-controls="id-6553739f7d9dc1bfffbcb1fa">
                    <code>trie/triedb/pathdb/disklayer.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/3f40e65c484486dea6cff80b7db178985d21a2c6/trie/triedb/pathdb/disklayer.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/650bb2f2b1dcfe30d9b1fa6f7dc9608055ed60e1/trie/triedb/pathdb/disklayer.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+1</span></div>
                        <div class="text-start"><span class="text-danger">-1</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-6553739f7d9dc1bfffbcb1fa"><span class="term-fg1">diff --git go-ethereum&#47;trie&#47;triedb&#47;pathdb&#47;disklayer.go op-geth&#47;trie&#47;triedb&#47;pathdb&#47;disklayer.go</span>
<span class="term-fg1">index 87718290f9a7da4c26b17c97500472ce1680e55c..d3b6419cc59484c6a24368b6b24a545ff1bf1973 100644</span>
<span class="term-fg1">--- go-ethereum&#47;trie&#47;triedb&#47;pathdb&#47;disklayer.go</span>
<span class="term-fg1">+++ op-geth&#47;trie&#47;triedb&#47;pathdb&#47;disklayer.go</span>
<span class="term-fg36">@@ -150,7 +150,7 @@</span> 	}
 	if nHash != hash {
 		diskFalseMeter.Mark(1)
 		log.Error(&quot;Unexpected trie node in disk&quot;, &quot;owner&quot;, owner, &quot;path&quot;, path, &quot;expect&quot;, hash, &quot;got&quot;, nHash)
<span class="term-fg31">-		return nil, newUnexpectedNodeError(&quot;disk&quot;, hash, nHash, owner, path)</span>
<span class="term-fg32">+		return nil, newUnexpectedNodeError(&quot;disk&quot;, hash, nHash, owner, path, nBlob)</span>
 	}
 	if dl.cleans != nil &amp;&amp; len(nBlob) &gt; 0 {
 		dl.cleans.Set(key, nBlob)</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-7d728514fc485eebbcf5ebab" role="button"
                   aria-expanded="false" aria-controls="id-7d728514fc485eebbcf5ebab">
                    <code>trie/triedb/pathdb/errors.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/3f40e65c484486dea6cff80b7db178985d21a2c6/trie/triedb/pathdb/errors.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/650bb2f2b1dcfe30d9b1fa6f7dc9608055ed60e1/trie/triedb/pathdb/errors.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+14</span></div>
                        <div class="text-start"><span class="text-danger">-5</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-7d728514fc485eebbcf5ebab"><span class="term-fg1">diff --git go-ethereum&#47;trie&#47;triedb&#47;pathdb&#47;errors.go op-geth&#47;trie&#47;triedb&#47;pathdb&#47;errors.go</span>
<span class="term-fg1">index f503a9c49d2e0a0284149b27d2e933ec12084968..78ee4459fe50943d103ca2400173c6786317dfd0 100644</span>
<span class="term-fg1">--- go-ethereum&#47;trie&#47;triedb&#47;pathdb&#47;errors.go</span>
<span class="term-fg1">+++ op-geth&#47;trie&#47;triedb&#47;pathdb&#47;errors.go</span>
<span class="term-fg36">@@ -21,12 +21,17 @@</span> 	&quot;errors&quot;
 	&quot;fmt&quot;
&nbsp;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;common&quot;
<span class="term-fg32">+	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;common&#47;hexutil&quot;</span>
 )
&nbsp;
 var (
<span class="term-fg31">-	&#47;&#47; errSnapshotReadOnly is returned if the database is opened in read only mode</span>
<span class="term-fg31">-	&#47;&#47; and mutation is requested.</span>
<span class="term-fg31">-	errSnapshotReadOnly = errors.New(&quot;read only&quot;)</span>
<span class="term-fg32">+	&#47;&#47; errDatabaseReadOnly is returned if the database is opened in read only mode</span>
<span class="term-fg32">+	&#47;&#47; to prevent any mutation.</span>
<span class="term-fg32">+	errDatabaseReadOnly = errors.New(&quot;read only&quot;)</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+	&#47;&#47; errDatabaseWaitSync is returned if the initial state sync is not completed</span>
<span class="term-fg32">+	&#47;&#47; yet and database is disabled to prevent accessing state.</span>
<span class="term-fg32">+	errDatabaseWaitSync = errors.New(&quot;waiting for sync&quot;)</span>
&nbsp;
 	&#47;&#47; errSnapshotStale is returned from data accessors if the underlying layer
 	&#47;&#47; layer had been invalidated due to the chain progressing forward far enough
<span class="term-fg36">@@ -46,6 +51,10 @@</span> 	&#47;&#47; not hash matched with expectation.
 	errUnexpectedNode = errors.New(&quot;unexpected node&quot;)
 )
&nbsp;
<span class="term-fg31">-func newUnexpectedNodeError(loc string, expHash common.Hash, gotHash common.Hash, owner common.Hash, path []byte) error {</span>
<span class="term-fg31">-	return fmt.Errorf(&quot;%w, loc: %s, node: (%x %v), %x!=%x&quot;, errUnexpectedNode, loc, owner, path, expHash, gotHash)</span>
<span class="term-fg32">+func newUnexpectedNodeError(loc string, expHash common.Hash, gotHash common.Hash, owner common.Hash, path []byte, blob []byte) error {</span>
<span class="term-fg32">+	blobHex := &quot;nil&quot;</span>
<span class="term-fg32">+	if len(blob) &gt; 0 {</span>
<span class="term-fg32">+		blobHex = hexutil.Encode(blob)</span>
<span class="term-fg32">+	}</span>
<span class="term-fg32">+	return fmt.Errorf(&quot;%w, loc: %s, node: (%x %v), %x!=%x, blob: %s&quot;, errUnexpectedNode, loc, owner, path, expHash, gotHash, blobHex)</span>
 }</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-e0d959dfb6e52b52d13d02db" role="button"
                   aria-expanded="false" aria-controls="id-e0d959dfb6e52b52d13d02db">
                    <code>trie/triedb/pathdb/journal.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/3f40e65c484486dea6cff80b7db178985d21a2c6/trie/triedb/pathdb/journal.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/650bb2f2b1dcfe30d9b1fa6f7dc9608055ed60e1/trie/triedb/pathdb/journal.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+1</span></div>
                        <div class="text-start"><span class="text-danger">-1</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-e0d959dfb6e52b52d13d02db"><span class="term-fg1">diff --git go-ethereum&#47;trie&#47;triedb&#47;pathdb&#47;journal.go op-geth&#47;trie&#47;triedb&#47;pathdb&#47;journal.go</span>
<span class="term-fg1">index ea90207f298d33a0b1c170328b2f1afe61904fcd..ac770763e38df7315728ad1734720b8070776ec9 100644</span>
<span class="term-fg1">--- go-ethereum&#47;trie&#47;triedb&#47;pathdb&#47;journal.go</span>
<span class="term-fg1">+++ op-geth&#47;trie&#47;triedb&#47;pathdb&#47;journal.go</span>
<span class="term-fg36">@@ -356,7 +356,7 @@</span> 	defer db.lock.Unlock()
&nbsp;
 	&#47;&#47; Short circuit if the database is in read only mode.
 	if db.readOnly {
<span class="term-fg31">-		return errSnapshotReadOnly</span>
<span class="term-fg32">+		return errDatabaseReadOnly</span>
 	}
 	&#47;&#47; Firstly write out the metadata of journal
 	journal := new(bytes.Buffer)</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-438751d3b45cd76b418e2b4d" role="button"
                   aria-expanded="false" aria-controls="id-438751d3b45cd76b418e2b4d">
                    <code>trie/triedb/pathdb/nodebuffer.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/3f40e65c484486dea6cff80b7db178985d21a2c6/trie/triedb/pathdb/nodebuffer.go" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/650bb2f2b1dcfe30d9b1fa6f7dc9608055ed60e1/trie/triedb/pathdb/nodebuffer.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+1</span></div>
                        <div class="text-start"><span class="text-danger">-1</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-438751d3b45cd76b418e2b4d"><span class="term-fg1">diff --git go-ethereum&#47;trie&#47;triedb&#47;pathdb&#47;nodebuffer.go op-geth&#47;trie&#47;triedb&#47;pathdb&#47;nodebuffer.go</span>
<span class="term-fg1">index 67de225b0495993b833a0ed49d1f7cb2bc4f0c58..4a7d328b9afb8fbbad679028debbaf3a07146581 100644</span>
<span class="term-fg1">--- go-ethereum&#47;trie&#47;triedb&#47;pathdb&#47;nodebuffer.go</span>
<span class="term-fg1">+++ op-geth&#47;trie&#47;triedb&#47;pathdb&#47;nodebuffer.go</span>
<span class="term-fg36">@@ -71,7 +71,7 @@</span> 	}
 	if n.Hash != hash {
 		dirtyFalseMeter.Mark(1)
 		log.Error(&quot;Unexpected trie node in node buffer&quot;, &quot;owner&quot;, owner, &quot;path&quot;, path, &quot;expect&quot;, hash, &quot;got&quot;, n.Hash)
<span class="term-fg31">-		return nil, newUnexpectedNodeError(&quot;dirty&quot;, hash, n.Hash, owner, path)</span>
<span class="term-fg32">+		return nil, newUnexpectedNodeError(&quot;dirty&quot;, hash, n.Hash, owner, path, n.Blob)</span>
 	}
 	return n, nil
 }</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-d70125a4eb5aa2bd00d7bbbd" role="button"
                   aria-expanded="false" aria-controls="id-d70125a4eb5aa2bd00d7bbbd">
                    <code>trie/trienode/proof.go</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <span class="text-muted">(new)</span>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/650bb2f2b1dcfe30d9b1fa6f7dc9608055ed60e1/trie/trienode/proof.go" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+25</span></div>
                        <div class="text-start"><span class="text-danger">-25</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-d70125a4eb5aa2bd00d7bbbd"><span class="term-fg1">diff --git go-ethereum&#47;light&#47;nodeset.go op-geth&#47;trie&#47;trienode&#47;proof.go</span>
<span class="term-fg1">rename from light&#47;nodeset.go</span>
<span class="term-fg1">rename to trie&#47;trienode&#47;proof.go</span>
<span class="term-fg1">index 3662596785c79f85250d949eb653b4872f9827d0..012f0087dded262bea272f84e71c4c5c0af7337b 100644</span>
<span class="term-fg1">--- go-ethereum&#47;light&#47;nodeset.go</span>
<span class="term-fg1">+++ op-geth&#47;trie&#47;trienode&#47;proof.go</span>
<span class="term-fg36">@@ -14,7 +14,7 @@</span> &#47;&#47;
 &#47;&#47; You should have received a copy of the GNU Lesser General Public License
 &#47;&#47; along with the go-ethereum library. If not, see &lt;http:&#47;&#47;www.gnu.org&#47;licenses&#47;&gt;.
&nbsp;
<span class="term-fg31">-package light</span>
<span class="term-fg32">+package trienode</span>
&nbsp;
 import (
 	&quot;errors&quot;
<span class="term-fg36">@@ -26,9 +26,9 @@</span> 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;ethdb&quot;
 	&quot;github.com&#47;ethereum&#47;go-ethereum&#47;rlp&quot;
 )
&nbsp;
<span class="term-fg31">-&#47;&#47; NodeSet stores a set of trie nodes. It implements trie.Database and can also</span>
<span class="term-fg32">+&#47;&#47; ProofSet stores a set of trie nodes. It implements trie.Database and can also</span>
 &#47;&#47; act as a cache for another trie.Database.
<span class="term-fg31">-type NodeSet struct {</span>
<span class="term-fg32">+type ProofSet struct {</span>
 	nodes map[string][]byte
 	order []string
&nbsp;
<span class="term-fg36">@@ -36,15 +36,15 @@</span> 	dataSize int
 	lock     sync.RWMutex
 }
&nbsp;
<span class="term-fg31">-&#47;&#47; NewNodeSet creates an empty node set</span>
<span class="term-fg31">-func NewNodeSet() *NodeSet {</span>
<span class="term-fg31">-	return &amp;NodeSet{</span>
<span class="term-fg32">+&#47;&#47; NewProofSet creates an empty node set</span>
<span class="term-fg32">+func NewProofSet() *ProofSet {</span>
<span class="term-fg32">+	return &amp;ProofSet{</span>
 		nodes: make(map[string][]byte),
 	}
 }
&nbsp;
 &#47;&#47; Put stores a new node in the set
<span class="term-fg31">-func (db *NodeSet) Put(key []byte, value []byte) error {</span>
<span class="term-fg32">+func (db *ProofSet) Put(key []byte, value []byte) error {</span>
 	db.lock.Lock()
 	defer db.lock.Unlock()
&nbsp;
<span class="term-fg36">@@ -61,7 +61,7 @@</span> 	return nil
 }
&nbsp;
 &#47;&#47; Delete removes a node from the set
<span class="term-fg31">-func (db *NodeSet) Delete(key []byte) error {</span>
<span class="term-fg32">+func (db *ProofSet) Delete(key []byte) error {</span>
 	db.lock.Lock()
 	defer db.lock.Unlock()
&nbsp;
<span class="term-fg36">@@ -70,7 +70,7 @@</span> 	return nil
 }
&nbsp;
 &#47;&#47; Get returns a stored node
<span class="term-fg31">-func (db *NodeSet) Get(key []byte) ([]byte, error) {</span>
<span class="term-fg32">+func (db *ProofSet) Get(key []byte) ([]byte, error) {</span>
 	db.lock.RLock()
 	defer db.lock.RUnlock()
&nbsp;
<span class="term-fg36">@@ -81,13 +81,13 @@</span> 	return nil, errors.New(&quot;not found&quot;)
 }
&nbsp;
 &#47;&#47; Has returns true if the node set contains the given key
<span class="term-fg31">-func (db *NodeSet) Has(key []byte) (bool, error) {</span>
<span class="term-fg32">+func (db *ProofSet) Has(key []byte) (bool, error) {</span>
 	_, err := db.Get(key)
 	return err == nil, nil
 }
&nbsp;
 &#47;&#47; KeyCount returns the number of nodes in the set
<span class="term-fg31">-func (db *NodeSet) KeyCount() int {</span>
<span class="term-fg32">+func (db *ProofSet) KeyCount() int {</span>
 	db.lock.RLock()
 	defer db.lock.RUnlock()
&nbsp;
<span class="term-fg36">@@ -95,19 +95,19 @@</span> 	return len(db.nodes)
 }
&nbsp;
 &#47;&#47; DataSize returns the aggregated data size of nodes in the set
<span class="term-fg31">-func (db *NodeSet) DataSize() int {</span>
<span class="term-fg32">+func (db *ProofSet) DataSize() int {</span>
 	db.lock.RLock()
 	defer db.lock.RUnlock()
&nbsp;
 	return db.dataSize
 }
&nbsp;
<span class="term-fg31">-&#47;&#47; NodeList converts the node set to a NodeList</span>
<span class="term-fg31">-func (db *NodeSet) NodeList() NodeList {</span>
<span class="term-fg32">+&#47;&#47; List converts the node set to a ProofList</span>
<span class="term-fg32">+func (db *ProofSet) List() ProofList {</span>
 	db.lock.RLock()
 	defer db.lock.RUnlock()
&nbsp;
<span class="term-fg31">-	var values NodeList</span>
<span class="term-fg32">+	var values ProofList</span>
 	for _, key := range db.order {
 		values = append(values, db.nodes[key])
 	}
<span class="term-fg36">@@ -115,7 +115,7 @@</span> 	return values
 }
&nbsp;
 &#47;&#47; Store writes the contents of the set to the given database
<span class="term-fg31">-func (db *NodeSet) Store(target ethdb.KeyValueWriter) {</span>
<span class="term-fg32">+func (db *ProofSet) Store(target ethdb.KeyValueWriter) {</span>
 	db.lock.RLock()
 	defer db.lock.RUnlock()
&nbsp;
<span class="term-fg36">@@ -124,36 +124,36 @@</span> 		target.Put([]byte(key), value)
 	}
 }
&nbsp;
<span class="term-fg31">-&#47;&#47; NodeList stores an ordered list of trie nodes. It implements ethdb.KeyValueWriter.</span>
<span class="term-fg31">-type NodeList []rlp.RawValue</span>
<span class="term-fg32">+&#47;&#47; ProofList stores an ordered list of trie nodes. It implements ethdb.KeyValueWriter.</span>
<span class="term-fg32">+type ProofList []rlp.RawValue</span>
&nbsp;
 &#47;&#47; Store writes the contents of the list to the given database
<span class="term-fg31">-func (n NodeList) Store(db ethdb.KeyValueWriter) {</span>
<span class="term-fg32">+func (n ProofList) Store(db ethdb.KeyValueWriter) {</span>
 	for _, node := range n {
 		db.Put(crypto.Keccak256(node), node)
 	}
 }
&nbsp;
<span class="term-fg31">-&#47;&#47; NodeSet converts the node list to a NodeSet</span>
<span class="term-fg31">-func (n NodeList) NodeSet() *NodeSet {</span>
<span class="term-fg31">-	db := NewNodeSet()</span>
<span class="term-fg32">+&#47;&#47; Set converts the node list to a ProofSet</span>
<span class="term-fg32">+func (n ProofList) Set() *ProofSet {</span>
<span class="term-fg32">+	db := NewProofSet()</span>
 	n.Store(db)
 	return db
 }
&nbsp;
 &#47;&#47; Put stores a new node at the end of the list
<span class="term-fg31">-func (n *NodeList) Put(key []byte, value []byte) error {</span>
<span class="term-fg32">+func (n *ProofList) Put(key []byte, value []byte) error {</span>
 	*n = append(*n, value)
 	return nil
 }
&nbsp;
 &#47;&#47; Delete panics as there&#39;s no reason to remove a node from the list.
<span class="term-fg31">-func (n *NodeList) Delete(key []byte) error {</span>
<span class="term-fg32">+func (n *ProofList) Delete(key []byte) error {</span>
 	panic(&quot;not supported&quot;)
 }
&nbsp;
 &#47;&#47; DataSize returns the aggregated data size of nodes in the list
<span class="term-fg31">-func (n NodeList) DataSize() int {</span>
<span class="term-fg32">+func (n ProofList) DataSize() int {</span>
 	var size int
 	for _, node := range n {
 		size += len(node)</div>
    </div>

            
        </div>
        <div>
            
        </div>
    </div>
</div>

            
        </div>
    </div>
</div>

                
                    <div class="text-muted">
                        <div class="ps-1 py-2 my-1"><div class="row border-bottom border-1"data-bs-toggle="collapse" data-bs-target="#id-7a86d0dc35c0fd81e3697441"role="button" aria-expanded="false" aria-controls="id-7a86d0dc35c0fd81e3697441">
        
            <div class="col-12 col-sm-9 text-start"><h4>Ignored changes</h4></div>
        
        <div class="col-12 col-sm-3 ms-auto mt-2">
            <div class="row line-stat">
                <div class="text-end"><span class="text-success">+588</span></div>
                <div class="text-start"><span class="text-danger">-38</span></div>
            </div>
        </div>
    </div>

    <div class="row forkdef-content collapse  border-1 ps-3 my-3" id="id-7a86d0dc35c0fd81e3697441">
        <div></div>
        <div>
            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-a6970a5ec458638b4250171a" role="button"
                   aria-expanded="false" aria-controls="id-a6970a5ec458638b4250171a">
                    <code>.circleci/check-releases.sh</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <span class="text-muted">(new)</span>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/650bb2f2b1dcfe30d9b1fa6f7dc9608055ed60e1/.circleci/check-releases.sh" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+21</span></div>
                        <div class="text-start"><span class="text-danger">-0</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-a6970a5ec458638b4250171a"><span class="term-fg1">diff --git go-ethereum&#47;.circleci&#47;check-releases.sh op-geth&#47;.circleci&#47;check-releases.sh</span>
<span class="term-fg1">new file mode 100755</span>
<span class="term-fg1">index 0000000000000000000000000000000000000000..f3595e1320377bea4b17c13326d87342083071c0</span>
<span class="term-fg1">--- &#47;dev&#47;null</span>
<span class="term-fg1">+++ op-geth&#47;.circleci&#47;check-releases.sh</span>
<span class="term-fg36">@@ -0,0 +1,21 @@</span>
<span class="term-fg32">+#!&#47;bin&#47;bash</span>
<span class="term-fg32">+set -euo pipefail</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+LATEST_RELEASE=$(curl -s --fail -L \</span>
<span class="term-fg32">+  -H &quot;Accept: application&#47;vnd.github+json&quot; \</span>
<span class="term-fg32">+  -H &quot;X-GitHub-Api-Version: 2022-11-28&quot; \</span>
<span class="term-fg32">+  https:&#47;&#47;api.github.com&#47;repos&#47;ethereum&#47;go-ethereum&#47;releases \</span>
<span class="term-fg32">+  | jq -r &#39;(.[] | select(.draft==false) | select(.prerelease==false)).tag_name&#39; | head -n 1)</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+echo &quot;Detected latest go-ethereum release as ${LATEST_RELEASE}&quot;</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+git remote add upstream https:&#47;&#47;github.com&#47;ethereum&#47;go-ethereum</span>
<span class="term-fg32">+git fetch upstream &gt; &#47;dev&#47;null</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+if git branch --contains &quot;${LATEST_RELEASE}&quot; 2&gt;&amp;1 | grep -e &#39;^[ *]*optimism$&#39; &gt; &#47;dev&#47;null</span>
<span class="term-fg32">+then</span>
<span class="term-fg32">+  echo &quot;Up to date with latest release.  Great job! 🎉&quot;</span>
<span class="term-fg32">+else</span>
<span class="term-fg32">+  echo &quot;Release has not been merged&quot;</span>
<span class="term-fg32">+  exit 1</span>
<span class="term-fg32">+fi</span></div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-fb27398ae5c6c9f18a37d670" role="button"
                   aria-expanded="false" aria-controls="id-fb27398ae5c6c9f18a37d670">
                    <code>.circleci/ci-docker-tag-op-geth-release.sh</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <span class="text-muted">(new)</span>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/650bb2f2b1dcfe30d9b1fa6f7dc9608055ed60e1/.circleci/ci-docker-tag-op-geth-release.sh" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+38</span></div>
                        <div class="text-start"><span class="text-danger">-0</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-fb27398ae5c6c9f18a37d670"><span class="term-fg1">diff --git go-ethereum&#47;.circleci&#47;ci-docker-tag-op-geth-release.sh op-geth&#47;.circleci&#47;ci-docker-tag-op-geth-release.sh</span>
<span class="term-fg1">new file mode 100755</span>
<span class="term-fg1">index 0000000000000000000000000000000000000000..7b66e789a4d7e50699f2d22ff037117c0d7a3a35</span>
<span class="term-fg1">--- &#47;dev&#47;null</span>
<span class="term-fg1">+++ op-geth&#47;.circleci&#47;ci-docker-tag-op-geth-release.sh</span>
<span class="term-fg36">@@ -0,0 +1,38 @@</span>
<span class="term-fg32">+#!&#47;usr&#47;bin&#47;env bash</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+set -euo pipefail</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+DOCKER_REPO=$1</span>
<span class="term-fg32">+GIT_TAG=$2</span>
<span class="term-fg32">+GIT_SHA=$3</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+IMAGE_NAME=&quot;op-geth&quot;</span>
<span class="term-fg32">+IMAGE_TAG=$GIT_TAG</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+SOURCE_IMAGE_TAG=&quot;$DOCKER_REPO&#47;$IMAGE_NAME:$GIT_SHA&quot;</span>
<span class="term-fg32">+TARGET_IMAGE_TAG=&quot;$DOCKER_REPO&#47;$IMAGE_NAME:$IMAGE_TAG&quot;</span>
<span class="term-fg32">+TARGET_IMAGE_TAG_LATEST=&quot;$DOCKER_REPO&#47;$IMAGE_NAME:latest&quot;</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+echo &quot;Checking if docker images exist for &#39;$IMAGE_NAME&#39;&quot;</span>
<span class="term-fg32">+echo &quot;&quot;</span>
<span class="term-fg32">+tags=$(gcloud container images list-tags &quot;$DOCKER_REPO&#47;$IMAGE_NAME&quot; --limit 1 --format json)</span>
<span class="term-fg32">+if [ &quot;$tags&quot; = &quot;[]&quot; ]; then</span>
<span class="term-fg32">+  echo &quot;No existing docker images were found for &#39;$IMAGE_NAME&#39;. The code tagged with &#39;$GIT_TAG&#39; may not have an associated dockerfile or docker build job.&quot;</span>
<span class="term-fg32">+  echo &quot;If this service has a dockerfile, add a docker-publish job for it in the circleci config.&quot;</span>
<span class="term-fg32">+  echo &quot;&quot;</span>
<span class="term-fg32">+  echo &quot;Exiting&quot;</span>
<span class="term-fg32">+  exit 0</span>
<span class="term-fg32">+fi</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+echo &quot;Tagging $SOURCE_IMAGE_TAG with &#39;$IMAGE_TAG&#39;&quot;</span>
<span class="term-fg32">+gcloud container images add-tag -q &quot;$SOURCE_IMAGE_TAG&quot; &quot;$TARGET_IMAGE_TAG&quot;</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+# Do not tag with latest if the release is a release candidate.</span>
<span class="term-fg32">+if [[ &quot;$IMAGE_TAG&quot; == *&quot;rc&quot;* ]]; then</span>
<span class="term-fg32">+  echo &quot;Not tagging with &#39;latest&#39; because the release is a release candidate.&quot;</span>
<span class="term-fg32">+  exit 0</span>
<span class="term-fg32">+fi</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+echo &quot;Tagging $SOURCE_IMAGE_TAG with &#39;latest&#39;&quot;</span>
<span class="term-fg32">+gcloud container images add-tag -q &quot;$SOURCE_IMAGE_TAG&quot; &quot;$TARGET_IMAGE_TAG_LATEST&quot;</span>
<span class="term-fg32">+</span></div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-0884923e811994f2ad3d8c2b" role="button"
                   aria-expanded="false" aria-controls="id-0884923e811994f2ad3d8c2b">
                    <code>.circleci/config.yml</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <span class="text-muted">(new)</span>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/650bb2f2b1dcfe30d9b1fa6f7dc9608055ed60e1/.circleci/config.yml" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+198</span></div>
                        <div class="text-start"><span class="text-danger">-0</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-0884923e811994f2ad3d8c2b"><span class="term-fg1">diff --git go-ethereum&#47;.circleci&#47;config.yml op-geth&#47;.circleci&#47;config.yml</span>
<span class="term-fg1">new file mode 100644</span>
<span class="term-fg1">index 0000000000000000000000000000000000000000..374313392f10ecfe03d7971e7dd15d3eb5bfa493</span>
<span class="term-fg1">--- &#47;dev&#47;null</span>
<span class="term-fg1">+++ op-geth&#47;.circleci&#47;config.yml</span>
<span class="term-fg36">@@ -0,0 +1,198 @@</span>
<span class="term-fg32">+version: 2.1</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+orbs:</span>
<span class="term-fg32">+  gcp-cli: circleci&#47;gcp-cli@3.0.1</span>
<span class="term-fg32">+  slack: circleci&#47;slack@4.10.1</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+commands:</span>
<span class="term-fg32">+  gcp-oidc-authenticate:</span>
<span class="term-fg32">+    description: &quot;Authenticate with GCP using a CircleCI OIDC token.&quot;</span>
<span class="term-fg32">+    parameters:</span>
<span class="term-fg32">+      project_id:</span>
<span class="term-fg32">+        type: env_var_name</span>
<span class="term-fg32">+        default: GCP_PROJECT_ID</span>
<span class="term-fg32">+      workload_identity_pool_id:</span>
<span class="term-fg32">+        type: env_var_name</span>
<span class="term-fg32">+        default: GCP_WIP_ID</span>
<span class="term-fg32">+      workload_identity_pool_provider_id:</span>
<span class="term-fg32">+        type: env_var_name</span>
<span class="term-fg32">+        default: GCP_WIP_PROVIDER_ID</span>
<span class="term-fg32">+      service_account_email:</span>
<span class="term-fg32">+        type: env_var_name</span>
<span class="term-fg32">+        default: GCP_SERVICE_ACCOUNT_EMAIL</span>
<span class="term-fg32">+      gcp_cred_config_file_path:</span>
<span class="term-fg32">+        type: string</span>
<span class="term-fg32">+        default: &#47;home&#47;circleci&#47;gcp_cred_config.json</span>
<span class="term-fg32">+      oidc_token_file_path:</span>
<span class="term-fg32">+        type: string</span>
<span class="term-fg32">+        default: &#47;home&#47;circleci&#47;oidc_token.json</span>
<span class="term-fg32">+    steps:</span>
<span class="term-fg32">+      - run:</span>
<span class="term-fg32">+          name: &quot;Create OIDC credential configuration&quot;</span>
<span class="term-fg32">+          command: |</span>
<span class="term-fg32">+            # Store OIDC token in temp file</span>
<span class="term-fg32">+            echo $CIRCLE_OIDC_TOKEN &gt; &lt;&lt; parameters.oidc_token_file_path &gt;&gt;</span>
<span class="term-fg32">+            # Create a credential configuration for the generated OIDC ID Token</span>
<span class="term-fg32">+            gcloud iam workload-identity-pools create-cred-config \</span>
<span class="term-fg32">+                &quot;projects&#47;${&lt;&lt; parameters.project_id &gt;&gt;}&#47;locations&#47;global&#47;workloadIdentityPools&#47;${&lt;&lt; parameters.workload_identity_pool_id &gt;&gt;}&#47;providers&#47;${&lt;&lt; parameters.workload_identity_pool_provider_id &gt;&gt;}&quot;\</span>
<span class="term-fg32">+                --output-file=&quot;&lt;&lt; parameters.gcp_cred_config_file_path &gt;&gt;&quot; \</span>
<span class="term-fg32">+                --service-account=&quot;${&lt;&lt; parameters.service_account_email &gt;&gt;}&quot; \</span>
<span class="term-fg32">+                --credential-source-file=&lt;&lt; parameters.oidc_token_file_path &gt;&gt;</span>
<span class="term-fg32">+      - run:</span>
<span class="term-fg32">+          name: &quot;Authenticate with GCP using OIDC&quot;</span>
<span class="term-fg32">+          command: |</span>
<span class="term-fg32">+            # Configure gcloud to leverage the generated credential configuration</span>
<span class="term-fg32">+            gcloud auth login --brief --cred-file &quot;&lt;&lt; parameters.gcp_cred_config_file_path &gt;&gt;&quot;</span>
<span class="term-fg32">+            # Configure ADC</span>
<span class="term-fg32">+            echo &quot;export GOOGLE_APPLICATION_CREDENTIALS=&#39;&lt;&lt; parameters.gcp_cred_config_file_path &gt;&gt;&#39;&quot; | tee -a &quot;$BASH_ENV&quot;</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+jobs:</span>
<span class="term-fg32">+  docker-release:</span>
<span class="term-fg32">+    environment:</span>
<span class="term-fg32">+      DOCKER_BUILDKIT: 1</span>
<span class="term-fg32">+    parameters:</span>
<span class="term-fg32">+      docker_name:</span>
<span class="term-fg32">+        description: Docker image name</span>
<span class="term-fg32">+        type: string</span>
<span class="term-fg32">+        default: &quot;op-geth&quot;</span>
<span class="term-fg32">+      docker_tags:</span>
<span class="term-fg32">+        description: Docker image tags as csv</span>
<span class="term-fg32">+        type: string</span>
<span class="term-fg32">+      registry:</span>
<span class="term-fg32">+        description: Docker registry</span>
<span class="term-fg32">+        type: string</span>
<span class="term-fg32">+        default: &quot;us-docker.pkg.dev&quot;</span>
<span class="term-fg32">+      repo:</span>
<span class="term-fg32">+        description: Docker repo</span>
<span class="term-fg32">+        type: string</span>
<span class="term-fg32">+        default: &quot;oplabs-tools-artifacts&#47;images&quot;</span>
<span class="term-fg32">+      push_tags:</span>
<span class="term-fg32">+        description: Push release push tags</span>
<span class="term-fg32">+        type: boolean</span>
<span class="term-fg32">+        default: false</span>
<span class="term-fg32">+    machine:</span>
<span class="term-fg32">+      image: ubuntu-2204:2022.07.1</span>
<span class="term-fg32">+      resource_class: xlarge</span>
<span class="term-fg32">+    steps:</span>
<span class="term-fg32">+      - gcp-cli&#47;install</span>
<span class="term-fg32">+      - gcp-oidc-authenticate</span>
<span class="term-fg32">+      - checkout</span>
<span class="term-fg32">+      - run:</span>
<span class="term-fg32">+          name: Configure Docker</span>
<span class="term-fg32">+          command: |</span>
<span class="term-fg32">+            gcloud auth configure-docker &lt;&lt;parameters.registry&gt;&gt;</span>
<span class="term-fg32">+      - run:</span>
<span class="term-fg32">+          name: Build and push</span>
<span class="term-fg32">+          command: |</span>
<span class="term-fg32">+            RAW_TAGS=&quot;&lt;&lt;parameters.docker_tags&gt;&gt;&quot;</span>
<span class="term-fg32">+            if [ &quot;$CIRCLE_BRANCH&quot; = &quot;optimism&quot; ]; then</span>
<span class="term-fg32">+              RAW_TAGS=&quot;$RAW_TAGS,optimism&quot;</span>
<span class="term-fg32">+            fi</span>
<span class="term-fg32">+            IMAGE_BASE=&quot;&lt;&lt;parameters.registry&gt;&gt;&#47;&lt;&lt;parameters.repo&gt;&gt;&#47;&lt;&lt;parameters.docker_name&gt;&gt;&quot;</span>
<span class="term-fg32">+            DOCKER_TAGS=$(echo -ne &quot;$RAW_TAGS&quot; | sed &quot;s&#47;,&#47;\n&#47;g&quot; | sed &quot;s&#47;[^a-zA-Z0-9\n.]&#47;-&#47;g&quot; | sed -e &quot;s|^|-t ${IMAGE_BASE}:|&quot;)</span>
<span class="term-fg32">+            docker context create buildx-build</span>
<span class="term-fg32">+            docker buildx create --use buildx-build</span>
<span class="term-fg32">+            docker buildx build --push \</span>
<span class="term-fg32">+              $(echo -ne $DOCKER_TAGS | tr &#39;\n&#39; &#39; &#39;) \</span>
<span class="term-fg32">+              --platform=linux&#47;arm64,linux&#47;amd64 \</span>
<span class="term-fg32">+              --build-arg VERSION=$CIRCLE_TAG \</span>
<span class="term-fg32">+              --build-arg COMMIT=$CIRCLE_SHA \</span>
<span class="term-fg32">+              --build-arg BUILDNUM=$CIRCLE_BUILD_NUM \</span>
<span class="term-fg32">+              --progress plain \</span>
<span class="term-fg32">+              -f Dockerfile .</span>
<span class="term-fg32">+      - when:</span>
<span class="term-fg32">+          condition:</span>
<span class="term-fg32">+            equal: [ true, &lt;&lt;parameters.push_tags&gt;&gt; ]</span>
<span class="term-fg32">+          steps:</span>
<span class="term-fg32">+            - run:</span>
<span class="term-fg32">+                name: Tag</span>
<span class="term-fg32">+                command: |</span>
<span class="term-fg32">+                  .&#47;.circleci&#47;ci-docker-tag-op-geth-release.sh &lt;&lt;parameters.registry&gt;&gt;&#47;&lt;&lt;parameters.repo&gt;&gt; $CIRCLE_TAG $CIRCLE_SHA1</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+  build-geth:</span>
<span class="term-fg32">+    docker:</span>
<span class="term-fg32">+      - image: cimg&#47;go:1.20</span>
<span class="term-fg32">+    resource_class: xlarge</span>
<span class="term-fg32">+    steps:</span>
<span class="term-fg32">+      - checkout</span>
<span class="term-fg32">+      - run:</span>
<span class="term-fg32">+          command: go run build&#47;ci.go install</span>
<span class="term-fg32">+  unit-test:</span>
<span class="term-fg32">+    resource_class: xlarge</span>
<span class="term-fg32">+    docker:</span>
<span class="term-fg32">+      - image: cimg&#47;go:1.20</span>
<span class="term-fg32">+    steps:</span>
<span class="term-fg32">+      - checkout</span>
<span class="term-fg32">+      - run:</span>
<span class="term-fg32">+          command: go run build&#47;ci.go test</span>
<span class="term-fg32">+  lint-geth:</span>
<span class="term-fg32">+    resource_class: medium</span>
<span class="term-fg32">+    docker:</span>
<span class="term-fg32">+      - image: cimg&#47;go:1.20</span>
<span class="term-fg32">+    steps:</span>
<span class="term-fg32">+      - checkout</span>
<span class="term-fg32">+      - run:</span>
<span class="term-fg32">+          command: go run build&#47;ci.go lint</span>
<span class="term-fg32">+  check-releases:</span>
<span class="term-fg32">+    docker:</span>
<span class="term-fg32">+      - image: cimg&#47;go:1.20</span>
<span class="term-fg32">+    steps:</span>
<span class="term-fg32">+      - checkout</span>
<span class="term-fg32">+      - run:</span>
<span class="term-fg32">+          command: .circleci&#47;check-releases.sh</span>
<span class="term-fg32">+      - slack&#47;notify:</span>
<span class="term-fg32">+          channel: C03N11M0BBN</span>
<span class="term-fg32">+          branch_pattern: optimism</span>
<span class="term-fg32">+          event: fail</span>
<span class="term-fg32">+          template: basic_fail_1</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+workflows:</span>
<span class="term-fg32">+  main:</span>
<span class="term-fg32">+    jobs:</span>
<span class="term-fg32">+      - build-geth:</span>
<span class="term-fg32">+          name: Build geth</span>
<span class="term-fg32">+      - unit-test:</span>
<span class="term-fg32">+          name: Run unit tests for geth</span>
<span class="term-fg32">+      - lint-geth:</span>
<span class="term-fg32">+          name: Run linter over geth</span>
<span class="term-fg32">+      - docker-release:</span>
<span class="term-fg32">+          name: Push to Docker</span>
<span class="term-fg32">+          docker_tags: &lt;&lt;pipeline.git.revision&gt;&gt;</span>
<span class="term-fg32">+          context:</span>
<span class="term-fg32">+            - oplabs-gcr</span>
<span class="term-fg32">+  release:</span>
<span class="term-fg32">+    jobs:</span>
<span class="term-fg32">+      - hold:</span>
<span class="term-fg32">+          type: approval</span>
<span class="term-fg32">+          filters:</span>
<span class="term-fg32">+            tags:</span>
<span class="term-fg32">+              only: &#47;^v.*&#47;</span>
<span class="term-fg32">+            branches:</span>
<span class="term-fg32">+              ignore: &#47;.*&#47;</span>
<span class="term-fg32">+      - docker-release:</span>
<span class="term-fg32">+          name: Push to Docker (release)</span>
<span class="term-fg32">+          filters:</span>
<span class="term-fg32">+            tags:</span>
<span class="term-fg32">+              only: &#47;^v.*&#47;</span>
<span class="term-fg32">+            branches:</span>
<span class="term-fg32">+              ignore: &#47;.*&#47;</span>
<span class="term-fg32">+          docker_tags: &lt;&lt;pipeline.git.revision&gt;&gt;,&lt;&lt;pipeline.git.tag&gt;&gt;</span>
<span class="term-fg32">+          push_tags: true</span>
<span class="term-fg32">+          context:</span>
<span class="term-fg32">+            - oplabs-gcr-release</span>
<span class="term-fg32">+          requires:</span>
<span class="term-fg32">+            - hold</span>
<span class="term-fg32">+  scheduled:</span>
<span class="term-fg32">+    triggers:</span>
<span class="term-fg32">+      - schedule:</span>
<span class="term-fg32">+          # run daily</span>
<span class="term-fg32">+          cron: &quot;0 0 * * *&quot;</span>
<span class="term-fg32">+          filters:</span>
<span class="term-fg32">+            branches:</span>
<span class="term-fg32">+              only: [ &quot;optimism&quot; ]</span>
<span class="term-fg32">+    jobs:</span>
<span class="term-fg32">+      - check-releases:</span>
<span class="term-fg32">+          name: Check for new upstream releases</span>
<span class="term-fg32">+          context: slack</span></div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-660b6e269fc1f63ce0125ad5" role="button"
                   aria-expanded="false" aria-controls="id-660b6e269fc1f63ce0125ad5">
                    <code>.github/workflows/pages.yaml</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <span class="text-muted">(new)</span>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/650bb2f2b1dcfe30d9b1fa6f7dc9608055ed60e1/.github/workflows/pages.yaml" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+36</span></div>
                        <div class="text-start"><span class="text-danger">-0</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-660b6e269fc1f63ce0125ad5"><span class="term-fg1">diff --git go-ethereum&#47;.github&#47;workflows&#47;pages.yaml op-geth&#47;.github&#47;workflows&#47;pages.yaml</span>
<span class="term-fg1">new file mode 100644</span>
<span class="term-fg1">index 0000000000000000000000000000000000000000..6973b227ce779be6138ee2084e71bb5a5cdd57de</span>
<span class="term-fg1">--- &#47;dev&#47;null</span>
<span class="term-fg1">+++ op-geth&#47;.github&#47;workflows&#47;pages.yaml</span>
<span class="term-fg36">@@ -0,0 +1,36 @@</span>
<span class="term-fg32">+name: Build and publish forkdiff github-pages</span>
<span class="term-fg32">+permissions:</span>
<span class="term-fg32">+  contents: write</span>
<span class="term-fg32">+on:</span>
<span class="term-fg32">+  push:</span>
<span class="term-fg32">+    branches:</span>
<span class="term-fg32">+      - optimism</span>
<span class="term-fg32">+jobs:</span>
<span class="term-fg32">+  deploy:</span>
<span class="term-fg32">+    concurrency: ci-${{ github.ref }}</span>
<span class="term-fg32">+    runs-on: ubuntu-latest</span>
<span class="term-fg32">+    steps:</span>
<span class="term-fg32">+      - name: Checkout</span>
<span class="term-fg32">+        uses: actions&#47;checkout@v3</span>
<span class="term-fg32">+        with:</span>
<span class="term-fg32">+          fetch-depth: 1000  # make sure to fetch the old commit we diff against</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+      - name: Build forkdiff</span>
<span class="term-fg32">+        uses: &quot;docker:&#47;&#47;protolambda&#47;forkdiff:latest&quot;</span>
<span class="term-fg32">+        with:</span>
<span class="term-fg32">+          args: -repo=&#47;github&#47;workspace -fork=&#47;github&#47;workspace&#47;fork.yaml -out=&#47;github&#47;workspace&#47;index.html</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+      - name: Build pages</span>
<span class="term-fg32">+        run: |</span>
<span class="term-fg32">+          mkdir -p tmp&#47;pages</span>
<span class="term-fg32">+          mv index.html tmp&#47;pages&#47;index.html</span>
<span class="term-fg32">+          touch tmp&#47;pages&#47;.nojekyll</span>
<span class="term-fg32">+          if [ &quot;$GITHUB_REPOSITORY&quot; == &quot;ethereum-optimism&#47;op-geth&quot; ]; then</span>
<span class="term-fg32">+              echo &quot;op-geth.optimism.io&quot; &gt; tmp&#47;pages&#47;CNAME</span>
<span class="term-fg32">+          fi;</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+      - name: Deploy</span>
<span class="term-fg32">+        uses: JamesIves&#47;github-pages-deploy-action@v4</span>
<span class="term-fg32">+        with:</span>
<span class="term-fg32">+          folder: tmp&#47;pages</span>
<span class="term-fg32">+          clean: true</span></div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-0b01c0ab74828232ce853070" role="button"
                   aria-expanded="false" aria-controls="id-0b01c0ab74828232ce853070">
                    <code>fork.yaml</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <span class="text-muted">(new)</span>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/650bb2f2b1dcfe30d9b1fa6f7dc9608055ed60e1/fork.yaml" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+246</span></div>
                        <div class="text-start"><span class="text-danger">-0</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-0b01c0ab74828232ce853070"><span class="term-fg1">diff --git go-ethereum&#47;fork.yaml op-geth&#47;fork.yaml</span>
<span class="term-fg1">new file mode 100644</span>
<span class="term-fg1">index 0000000000000000000000000000000000000000..75952333c07a97902b7868e6bab473910e4a8db1</span>
<span class="term-fg1">--- &#47;dev&#47;null</span>
<span class="term-fg1">+++ op-geth&#47;fork.yaml</span>
<span class="term-fg36">@@ -0,0 +1,246 @@</span>
<span class="term-fg32">+title: &quot;op-geth - go-ethereum fork diff overview&quot;</span>
<span class="term-fg32">+footer: |</span>
<span class="term-fg32">+  Fork-diff overview of [`op-geth`](https:&#47;&#47;github.com&#47;ethereum-optimism&#47;op-geth), a fork of [`go-ethereum`](https:&#47;&#47;github.com&#47;ethereum&#47;go-ethereum).</span>
<span class="term-fg32">+  and execution-engine of the [OP-stack](https:&#47;&#47;github.com&#47;ethereum-optimism&#47;optimism).</span>
<span class="term-fg32">+base:</span>
<span class="term-fg32">+  name: go-ethereum</span>
<span class="term-fg32">+  url: https:&#47;&#47;github.com&#47;ethereum&#47;go-ethereum</span>
<span class="term-fg32">+  hash: 3f40e65c484486dea6cff80b7db178985d21a2c6  # v1.13.1</span>
<span class="term-fg32">+fork:</span>
<span class="term-fg32">+  name: op-geth</span>
<span class="term-fg32">+  url: https:&#47;&#47;github.com&#47;ethereum-optimism&#47;op-geth</span>
<span class="term-fg32">+  ref: refs&#47;heads&#47;optimism</span>
<span class="term-fg32">+def:</span>
<span class="term-fg32">+  title: &quot;op-geth&quot;</span>
<span class="term-fg32">+  description: |</span>
<span class="term-fg32">+    This is an overview of the changes in [`op-geth`](https:&#47;&#47;github.com&#47;ethereum-optimism&#47;op-geth),</span>
<span class="term-fg32">+    a fork of [`go-ethereum`](https:&#47;&#47;github.com&#47;ethereum&#47;go-ethereum), part of the OP-stack.</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+    The OP-stack architecture is modular, following the Consensus&#47;Execution split of post-Merge Ethereum L1:</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+      - [`op-node`](https:&#47;&#47;github.com&#47;ethereum-optimism&#47;optimism&#47;tree&#47;develop&#47;op-node) implements most rollup-specific functionality as Consensus-Layer, similar to a L1 beacon-node. </span>
<span class="term-fg32">+      - [`op-geth`](https:&#47;&#47;github.com&#47;ethereum-optimism&#47;op-geth) implements the Execution-Layer, with **minimal changes** for a secure Ethereum-equivalent application environment.</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+    Related [op-stack specifications](https:&#47;&#47;github.com&#47;ethereum-optimism&#47;optimism&#47;tree&#47;develop&#47;specs):</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+    - [L2 Execution Engine spec](https:&#47;&#47;github.com&#47;ethereum-optimism&#47;optimism&#47;blob&#47;develop&#47;specs&#47;exec-engine.md)</span>
<span class="term-fg32">+    - [Deposit Transaction spec](https:&#47;&#47;github.com&#47;ethereum-optimism&#47;optimism&#47;blob&#47;develop&#47;specs&#47;deposits.md)</span>
<span class="term-fg32">+  sub:</span>
<span class="term-fg32">+    - title: &quot;Core modifications&quot;</span>
<span class="term-fg32">+      sub:</span>
<span class="term-fg32">+        - title: &quot;State-transition modifications&quot;</span>
<span class="term-fg32">+          description: &quot;&quot;</span>
<span class="term-fg32">+          sub:</span>
<span class="term-fg32">+            - title: &quot;Deposit Transaction type&quot;</span>
<span class="term-fg32">+              description: |</span>
<span class="term-fg32">+                The Bedrock upgrade introduces a `Deposit` transaction-type (`0x7E`) to enable both users and the</span>
<span class="term-fg32">+                rollup system itself to change the L2 state based on L1 events and system rules as</span>
<span class="term-fg32">+                [specified](https:&#47;&#47;github.com&#47;ethereum-optimism&#47;optimism&#47;blob&#47;develop&#47;specs&#47;deposits.md).</span>
<span class="term-fg32">+              globs:</span>
<span class="term-fg32">+                - &quot;core&#47;types&#47;deposit_tx.go&quot;</span>
<span class="term-fg32">+                - &quot;core&#47;types&#47;transaction_marshalling.go&quot;</span>
<span class="term-fg32">+                - &quot;core&#47;types&#47;transaction_signing.go&quot;</span>
<span class="term-fg32">+            - title: &quot;Transaction properties&quot;</span>
<span class="term-fg32">+              description: |</span>
<span class="term-fg32">+                The `Transaction` type now exposes the deposit-transaction and L1-cost properties required for the rollup.</span>
<span class="term-fg32">+              globs:</span>
<span class="term-fg32">+                - &quot;core&#47;types&#47;transaction.go&quot;</span>
<span class="term-fg32">+                - &quot;core&#47;types&#47;tx_access_list.go&quot;</span>
<span class="term-fg32">+                - &quot;core&#47;types&#47;tx_dynamic_fee.go&quot;</span>
<span class="term-fg32">+                - &quot;core&#47;types&#47;tx_legacy.go&quot;</span>
<span class="term-fg32">+                - &quot;core&#47;types&#47;tx_blob.go&quot;</span>
<span class="term-fg32">+            - title: &quot;L1 cost computation&quot;</span>
<span class="term-fg32">+              description: |</span>
<span class="term-fg32">+                Transactions must pay an additional L1 cost based on the amount of rollup-data-gas they consume,</span>
<span class="term-fg32">+                estimated based on gas-price-oracle information and encoded tx size.&quot;</span>
<span class="term-fg32">+              globs:</span>
<span class="term-fg32">+                - &quot;core&#47;vm&#47;evm.go&quot;</span>
<span class="term-fg32">+                - &quot;core&#47;evm.go&quot;</span>
<span class="term-fg32">+                - &quot;core&#47;types&#47;rollup_l1_cost.go&quot;</span>
<span class="term-fg32">+                - &quot;core&#47;state_processor.go&quot;</span>
<span class="term-fg32">+                - &quot;core&#47;state_prefetcher.go&quot;</span>
<span class="term-fg32">+            - title: Transaction processing</span>
<span class="term-fg32">+              description: |</span>
<span class="term-fg32">+                Deposit transactions have special processing rules: gas is pre-paid on L1,</span>
<span class="term-fg32">+                and deposits with EVM-failure are included with rolled back changes (except mint).</span>
<span class="term-fg32">+                For regular transactions, at the end of the transition, the 1559 burn and L1 cost are routed to vaults.</span>
<span class="term-fg32">+              globs:</span>
<span class="term-fg32">+                - &quot;core&#47;state_transition.go&quot;</span>
<span class="term-fg32">+            - title: &quot;Core Error definitions&quot;</span>
<span class="term-fg32">+              globs:</span>
<span class="term-fg32">+                - &quot;core&#47;error.go&quot;</span>
<span class="term-fg32">+            - title: &quot;Gaslimit&quot;</span>
<span class="term-fg32">+              description: |</span>
<span class="term-fg32">+                The gaslimit is free to be set by the Engine API caller, instead of enforcing adjustments of the</span>
<span class="term-fg32">+                gaslimit in increments of 1&#47;1024 of the previous gaslimit.</span>
<span class="term-fg32">+                The gaslimit is changed (and limited) through the `SystemConfig` contract.</span>
<span class="term-fg32">+              globs:</span>
<span class="term-fg32">+                - &quot;consensus&#47;misc&#47;eip1559&#47;eip1559.go&quot;</span>
<span class="term-fg32">+            - title: &quot;Consensus tweaks&quot;</span>
<span class="term-fg32">+              description: |</span>
<span class="term-fg32">+                The Engine API is activated at the Merge transition, with a Total Terminal Difficulty (TTD).</span>
<span class="term-fg32">+                The rollup starts post-merge, and thus sets the TTD to 0.</span>
<span class="term-fg32">+              globs:</span>
<span class="term-fg32">+                - &quot;consensus&#47;beacon&#47;consensus.go&quot;</span>
<span class="term-fg32">+        - title: &quot;Engine API modifications&quot;</span>
<span class="term-fg32">+          description: |</span>
<span class="term-fg32">+            The Engine API is extended to insert transactions into the block and optionally exclude the tx-pool,</span>
<span class="term-fg32">+            to reproduce the exact block of the sequencer from just the inputs, as derived from L1 by the rollup-node.</span>
<span class="term-fg32">+            See [L2 execution engine specs](https:&#47;&#47;github.com&#47;ethereum-optimism&#47;optimism&#47;blob&#47;develop&#47;specs&#47;exec-engine.md).</span>
<span class="term-fg32">+          globs:</span>
<span class="term-fg32">+            - &quot;beacon&#47;engine&#47;types.go&quot;</span>
<span class="term-fg32">+            - &quot;beacon&#47;engine&#47;gen_blockparams.go&quot;</span>
<span class="term-fg32">+            - &quot;eth&#47;catalyst&#47;api.go&quot;</span>
<span class="term-fg32">+        - title: &quot;Block-building modifications&quot;</span>
<span class="term-fg32">+          description: |</span>
<span class="term-fg32">+            The block-building code (in the &quot;miner&quot; package because of Proof-Of-Work legacy of ethereum) implements the</span>
<span class="term-fg32">+            changes to support the transaction-inclusion, tx-pool toggle and gaslimit parameters of the Engine API.</span>
<span class="term-fg32">+          globs:</span>
<span class="term-fg32">+            - &quot;miner&#47;*&quot;</span>
<span class="term-fg32">+        - title: &quot;Tx-pool tx cost updates&quot;</span>
<span class="term-fg32">+          description: |</span>
<span class="term-fg32">+            Transaction queueing and inclusion needs to account for the L1 cost component.</span>
<span class="term-fg32">+          globs:</span>
<span class="term-fg32">+            - &quot;core&#47;txpool&#47;*&quot;</span>
<span class="term-fg32">+            - &quot;core&#47;txpool&#47;legacypool&#47;*&quot;</span>
<span class="term-fg32">+    - title: &quot;Chain Configuration&quot;</span>
<span class="term-fg32">+      sub:</span>
<span class="term-fg32">+        - title: &quot;Chain config&quot;</span>
<span class="term-fg32">+          description: |</span>
<span class="term-fg32">+            The rollup functionality is enabled with the `optimism` field in the chain config.</span>
<span class="term-fg32">+            The EIP-1559 parameters are configurable to adjust for faster more frequent and smaller blocks.</span>
<span class="term-fg32">+            The parameters can be overriden for testing.</span>
<span class="term-fg32">+          globs:</span>
<span class="term-fg32">+            - &quot;params&#47;config.go&quot;</span>
<span class="term-fg32">+            - &quot;params&#47;protocol_params.go&quot;</span>
<span class="term-fg32">+            - &quot;core&#47;genesis.go&quot;</span>
<span class="term-fg32">+        - title: &quot;Chain config cleanup&quot;</span>
<span class="term-fg32">+          description: |</span>
<span class="term-fg32">+            The optimism Goerli testnet used clique-config data to make geth internals accept blocks.</span>
<span class="term-fg32">+            Post-bedrock the beacon-consensus (i.e. follow Engine API) is now used, and the clique config is removed.</span>
<span class="term-fg32">+          globs:</span>
<span class="term-fg32">+            - &quot;core&#47;rawdb&#47;accessors_metadata.go&quot;</span>
<span class="term-fg32">+        - title: Genesis loading</span>
<span class="term-fg32">+          globs:</span>
<span class="term-fg32">+            - &quot;core&#47;gen_genesis.go&quot;</span>
<span class="term-fg32">+        - title: &quot;Superchain config&quot;</span>
<span class="term-fg32">+          description: Testing of the superchain configuration</span>
<span class="term-fg32">+          globs:</span>
<span class="term-fg32">+            - &quot;core&#47;superchain.go&quot;</span>
<span class="term-fg32">+            - &quot;params&#47;superchain.go&quot;</span>
<span class="term-fg32">+    - title: &quot;Node modifications&quot;</span>
<span class="term-fg32">+      description: Changes to the node configuration and services.</span>
<span class="term-fg32">+      sub:</span>
<span class="term-fg32">+        - title: &quot;CLI&quot;</span>
<span class="term-fg32">+          sub:</span>
<span class="term-fg32">+            - title: &quot;Flags&quot;</span>
<span class="term-fg32">+              description: |</span>
<span class="term-fg32">+                Flag changes:</span>
<span class="term-fg32">+                  - Transactions can be forwarded to an RPC for sequencing.</span>
<span class="term-fg32">+                  - Historical calls can be forwarded to a legacy node.</span>
<span class="term-fg32">+                  - The tx pool propagation can be enabled&#47;disabled.</span>
<span class="term-fg32">+                  - The Optimism bedrock fork activation can be changed for testing.</span>
<span class="term-fg32">+              globs:</span>
<span class="term-fg32">+                - &quot;cmd&#47;utils&#47;flags.go&quot;</span>
<span class="term-fg32">+                - &quot;cmd&#47;geth&#47;main.go&quot;</span>
<span class="term-fg32">+                - &quot;internal&#47;flags&#47;categories.go&quot;</span>
<span class="term-fg32">+                - &quot;cmd&#47;geth&#47;config.go&quot;</span>
<span class="term-fg32">+            - title: &quot;Versioning&quot;</span>
<span class="term-fg32">+              description: List the op-geth and upstream go-ethereum versions.</span>
<span class="term-fg32">+              globs:</span>
<span class="term-fg32">+                - &quot;cmd&#47;geth&#47;misccmd.go&quot;</span>
<span class="term-fg32">+                - &quot;params&#47;version.go&quot;</span>
<span class="term-fg32">+                - &quot;build&#47;ci.go&quot;</span>
<span class="term-fg32">+        - title: Node config</span>
<span class="term-fg32">+          globs:</span>
<span class="term-fg32">+            - &quot;eth&#47;ethconfig&#47;config.go&quot;</span>
<span class="term-fg32">+        - title: Tx gossip disable option</span>
<span class="term-fg32">+          globs:</span>
<span class="term-fg32">+            - &quot;eth&#47;handler.go&quot;</span>
<span class="term-fg32">+            - &quot;eth&#47;handler_eth.go&quot;</span>
<span class="term-fg32">+        - title: Warn on missing hardfork data</span>
<span class="term-fg32">+          globs:</span>
<span class="term-fg32">+            - &quot;core&#47;blockchain.go&quot;</span>
<span class="term-fg32">+        - title: Optional Engine API extensions</span>
<span class="term-fg32">+          globs:</span>
<span class="term-fg32">+            - &quot;eth&#47;catalyst&#47;superchain.go&quot;</span>
<span class="term-fg32">+        - title: Support legacy DBs when snap-syncing</span>
<span class="term-fg32">+          description: Snap-sync does not serve unprefixed code by default.</span>
<span class="term-fg32">+          globs:</span>
<span class="term-fg32">+            - &quot;core&#47;blockchain_reader.go&quot;</span>
<span class="term-fg32">+            - &quot;eth&#47;protocols&#47;snap&#47;handler.go&quot;</span>
<span class="term-fg32">+        - title: Discv5 node discovery</span>
<span class="term-fg32">+          description: Fix discv5 option to allow discv5 to be an active source for node-discovery.</span>
<span class="term-fg32">+          globs:</span>
<span class="term-fg32">+            - &quot;p2p&#47;server.go&quot;</span>
<span class="term-fg32">+        - title: Generated TOML config update</span>
<span class="term-fg32">+          globs:</span>
<span class="term-fg32">+            - &quot;eth&#47;ethconfig&#47;gen_config.go&quot;</span>
<span class="term-fg32">+    - title: &quot;User API enhancements&quot;</span>
<span class="term-fg32">+      description: &quot;Encode the Deposit Tx properties, the L1 costs, and daisy-chain RPC-calls for pre-Bedrock historical data&quot;</span>
<span class="term-fg32">+      sub:</span>
<span class="term-fg32">+        - title: &quot;Receipts metadata&quot;</span>
<span class="term-fg32">+          description: |</span>
<span class="term-fg32">+            Pre-Bedrock L1-cost receipt data is loaded from the database if available, and post-Bedrock the L1-cost </span>
<span class="term-fg32">+            metadata is hydrated on-the-fly based on the L1 fee information in the corresponding block.</span>
<span class="term-fg32">+          globs:</span>
<span class="term-fg32">+            - &quot;core&#47;types&#47;receipt.go&quot;</span>
<span class="term-fg32">+            - &quot;core&#47;types&#47;gen_receipt_json.go&quot;</span>
<span class="term-fg32">+            - &quot;core&#47;rawdb&#47;accessors_chain.go&quot;</span>
<span class="term-fg32">+        - title: &quot;API Backend&quot;</span>
<span class="term-fg32">+          description: |</span>
<span class="term-fg32">+            Forward transactions to the sequencer if configured.</span>
<span class="term-fg32">+          globs:</span>
<span class="term-fg32">+            - &quot;eth&#47;api_backend.go&quot;</span>
<span class="term-fg32">+            - &quot;eth&#47;backend.go&quot;</span>
<span class="term-fg32">+            - &quot;internal&#47;ethapi&#47;backend.go&quot;</span>
<span class="term-fg32">+        - title: &quot;Apply L1 cost in API responses&quot;</span>
<span class="term-fg32">+          globs:</span>
<span class="term-fg32">+            - &quot;eth&#47;state_accessor.go&quot;</span>
<span class="term-fg32">+        - title: API frontend</span>
<span class="term-fg32">+          description: Format deposit and L1-cost data in transaction responses. Add `debug_chainConfig` API.</span>
<span class="term-fg32">+          globs:</span>
<span class="term-fg32">+            - &quot;internal&#47;ethapi&#47;api.go&quot;</span>
<span class="term-fg32">+            - &quot;rpc&#47;errors.go&quot;</span>
<span class="term-fg32">+        - title: Tracer RPC daisy-chain</span>
<span class="term-fg32">+          description: Forward pre-bedrock tracing calls to legacy node.</span>
<span class="term-fg32">+          globs:</span>
<span class="term-fg32">+            - &quot;eth&#47;tracers&#47;api.go&quot;</span>
<span class="term-fg32">+        - title: &quot;Light Ethereum Subprotocol (LES) RPC&quot;</span>
<span class="term-fg32">+          description: Match the RPC changes in the LES RPC</span>
<span class="term-fg32">+          globs:</span>
<span class="term-fg32">+            - &quot;les&#47;*&quot;</span>
<span class="term-fg32">+        - title: &quot;Daisy Chain tests&quot;</span>
<span class="term-fg32">+          globs:</span>
<span class="term-fg32">+            - &quot;internal&#47;ethapi&#47;transaction_args_test.go&quot;</span>
<span class="term-fg32">+            - &quot;ethclient&#47;ethclient_test.go&quot;</span>
<span class="term-fg32">+            - &quot;eth&#47;tracers&#47;api_test.go&quot;</span>
<span class="term-fg32">+        - title: Debug API</span>
<span class="term-fg32">+          description: Fix Debug API block marshaling to include deposits</span>
<span class="term-fg32">+          globs:</span>
<span class="term-fg32">+            - &quot;eth&#47;api_debug.go&quot;</span>
<span class="term-fg32">+        - title: Eth gasprice suggestions</span>
<span class="term-fg32">+          description: gasprice suggestion adjustments to accommodate faster L2 blocks and lower fees.</span>
<span class="term-fg32">+          globs:</span>
<span class="term-fg32">+            - &quot;eth&#47;gasprice&#47;gasprice.go&quot;</span>
<span class="term-fg32">+            - &quot;eth&#47;gasprice&#47;optimism-gasprice.go&quot;</span>
<span class="term-fg32">+        - title: API testvector fix</span>
<span class="term-fg32">+          description: |</span>
<span class="term-fg32">+            Upstream test of broken behavior; in Optimism, a zero signature is valid (pre-bedrock for deposit-txs),</span>
<span class="term-fg32">+            and the chain ID formula on signature data must not be used, or an underflow happens.</span>
<span class="term-fg32">+          globs:</span>
<span class="term-fg32">+            - &quot;internal&#47;ethapi&#47;testdata&#47;eth_getBlockByNumber-tag-pending-fullTx.json&quot;</span>
<span class="term-fg32">+    - title: &quot;Geth extras&quot;</span>
<span class="term-fg32">+      description: Extend the tools available in geth to improve external testing and tooling.</span>
<span class="term-fg32">+      sub:</span>
<span class="term-fg32">+        - title: Simulated Backend</span>
<span class="term-fg32">+          globs:</span>
<span class="term-fg32">+            - &quot;accounts&#47;abi&#47;bind&#47;backends&#47;simulated.go&quot;</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+# ignored globally, does not count towards line count</span>
<span class="term-fg32">+ignore:</span>
<span class="term-fg32">+  - &quot;.circleci&#47;*&quot;</span>
<span class="term-fg32">+  - &quot;*.sum&quot;</span>
<span class="term-fg32">+  - &quot;go.mod&quot;</span>
<span class="term-fg32">+  - &quot;fork.yaml&quot;</span>
<span class="term-fg32">+  - &quot;.github&#47;workflows&#47;*&quot;</span></div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-15bee332ed2c153ab5a425c4" role="button"
                   aria-expanded="false" aria-controls="id-15bee332ed2c153ab5a425c4">
                    <code>go.mod</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/3f40e65c484486dea6cff80b7db178985d21a2c6/go.mod" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/650bb2f2b1dcfe30d9b1fa6f7dc9608055ed60e1/go.mod" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+17</span></div>
                        <div class="text-start"><span class="text-danger">-14</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-15bee332ed2c153ab5a425c4"><span class="term-fg1">diff --git go-ethereum&#47;go.mod op-geth&#47;go.mod</span>
<span class="term-fg1">index 8061220aa6ca12ea16733bfec3bdb2a95500b2cd..8e42314d46405b0d88ce32263e2afaf000697df2 100644</span>
<span class="term-fg1">--- go-ethereum&#47;go.mod</span>
<span class="term-fg1">+++ op-geth&#47;go.mod</span>
<span class="term-fg36">@@ -13,13 +13,15 @@</span> 	github.com&#47;aws&#47;aws-sdk-go-v2&#47;service&#47;route53 v1.1.1
 	github.com&#47;btcsuite&#47;btcd&#47;btcec&#47;v2 v2.2.0
 	github.com&#47;cespare&#47;cp v0.1.0
 	github.com&#47;cloudflare&#47;cloudflare-go v0.14.0
<span class="term-fg31">-	github.com&#47;cockroachdb&#47;pebble v0.0.0-20230906160148-46873a6a7a06</span>
<span class="term-fg32">+	github.com&#47;cockroachdb&#47;errors v1.8.1</span>
<span class="term-fg32">+	github.com&#47;cockroachdb&#47;pebble v0.0.0-20230928194634-aa077af62593</span>
 	github.com&#47;consensys&#47;gnark-crypto v0.10.0
 	github.com&#47;crate-crypto&#47;go-kzg-4844 v0.3.0
 	github.com&#47;davecgh&#47;go-spew v1.1.1
 	github.com&#47;deckarep&#47;golang-set&#47;v2 v2.1.0
 	github.com&#47;docker&#47;docker v24.0.5+incompatible
 	github.com&#47;dop251&#47;goja v0.0.0-20230806174421-c933cf95e127
<span class="term-fg32">+	github.com&#47;ethereum-optimism&#47;superchain-registry&#47;superchain v0.0.0-20231018164214-046f42968aec</span>
 	github.com&#47;ethereum&#47;c-kzg-4844 v0.3.1
 	github.com&#47;fatih&#47;color v1.7.0
 	github.com&#47;fjl&#47;gencodec v0.0.0-20230517082657-f9840df7b83e
<span class="term-fg36">@@ -30,7 +32,7 @@</span> 	github.com&#47;gballet&#47;go-verkle v0.0.0-20230607174250-df487255f46b
 	github.com&#47;go-stack&#47;stack v1.8.1
 	github.com&#47;gofrs&#47;flock v0.8.1
 	github.com&#47;golang-jwt&#47;jwt&#47;v4 v4.3.0
<span class="term-fg31">-	github.com&#47;golang&#47;protobuf v1.5.2</span>
<span class="term-fg32">+	github.com&#47;golang&#47;protobuf v1.5.3</span>
 	github.com&#47;golang&#47;snappy v0.0.5-0.20220116011046-fa5810519dcb
 	github.com&#47;google&#47;gofuzz v1.1.1-0.20200604201612-c04b05f3adfa
 	github.com&#47;google&#47;uuid v1.3.0
<span class="term-fg36">@@ -46,10 +48,10 @@</span> 	github.com&#47;influxdata&#47;influxdb1-client v0.0.0-20220302092344-a9ab5670611c
 	github.com&#47;jackpal&#47;go-nat-pmp v1.0.2
 	github.com&#47;jedisct1&#47;go-minisign v0.0.0-20230811132847-661be99b8267
 	github.com&#47;julienschmidt&#47;httprouter v1.3.0
<span class="term-fg31">-	github.com&#47;karalabe&#47;usb v0.0.3-0.20230711191512-61db3e06439c</span>
<span class="term-fg32">+	github.com&#47;karalabe&#47;usb v0.0.2</span>
 	github.com&#47;kylelemons&#47;godebug v1.1.0
 	github.com&#47;mattn&#47;go-colorable v0.1.13
<span class="term-fg31">-	github.com&#47;mattn&#47;go-isatty v0.0.16</span>
<span class="term-fg32">+	github.com&#47;mattn&#47;go-isatty v0.0.17</span>
 	github.com&#47;naoina&#47;toml v0.1.2-0.20170918210437-9fafd6967416
 	github.com&#47;olekukonko&#47;tablewriter v0.0.5
 	github.com&#47;peterh&#47;liner v1.1.1-0.20190123174540-a2c9a5303de7
<span class="term-fg36">@@ -57,19 +59,19 @@</span> 	github.com&#47;protolambda&#47;bls12-381-util v0.0.0-20220416220906-d8552aa452c7
 	github.com&#47;rs&#47;cors v1.7.0
 	github.com&#47;shirou&#47;gopsutil v3.21.4-0.20210419000835-c7a38de76ee5+incompatible
 	github.com&#47;status-im&#47;keycard-go v0.2.0
<span class="term-fg31">-	github.com&#47;stretchr&#47;testify v1.8.1</span>
<span class="term-fg32">+	github.com&#47;stretchr&#47;testify v1.8.2</span>
 	github.com&#47;supranational&#47;blst v0.3.11
 	github.com&#47;syndtr&#47;goleveldb v1.0.1-0.20210819022825-2ae1ddf74ef7
 	github.com&#47;tyler-smith&#47;go-bip39 v1.1.0
 	github.com&#47;urfave&#47;cli&#47;v2 v2.25.7
 	go.uber.org&#47;automaxprocs v1.5.2
<span class="term-fg31">-	golang.org&#47;x&#47;crypto v0.12.0</span>
<span class="term-fg31">-	golang.org&#47;x&#47;exp v0.0.0-20230810033253-352e893a4cad</span>
<span class="term-fg32">+	golang.org&#47;x&#47;crypto v0.13.0</span>
<span class="term-fg32">+	golang.org&#47;x&#47;exp v0.0.0-20230905200255-921286631fa9</span>
 	golang.org&#47;x&#47;sync v0.3.0
<span class="term-fg31">-	golang.org&#47;x&#47;sys v0.11.0</span>
<span class="term-fg31">-	golang.org&#47;x&#47;text v0.12.0</span>
<span class="term-fg32">+	golang.org&#47;x&#47;sys v0.12.0</span>
<span class="term-fg32">+	golang.org&#47;x&#47;text v0.13.0</span>
 	golang.org&#47;x&#47;time v0.3.0
<span class="term-fg31">-	golang.org&#47;x&#47;tools v0.9.1</span>
<span class="term-fg32">+	golang.org&#47;x&#47;tools v0.13.0</span>
 	gopkg.in&#47;natefinch&#47;lumberjack.v2 v2.0.0
 	gopkg.in&#47;yaml.v3 v3.0.1
 )
<span class="term-fg36">@@ -87,10 +89,10 @@</span> 	github.com&#47;aws&#47;smithy-go v1.1.0 &#47;&#47; indirect
 	github.com&#47;beorn7&#47;perks v1.0.1 &#47;&#47; indirect
 	github.com&#47;bits-and-blooms&#47;bitset v1.5.0 &#47;&#47; indirect
 	github.com&#47;cespare&#47;xxhash&#47;v2 v2.2.0 &#47;&#47; indirect
<span class="term-fg31">-	github.com&#47;cockroachdb&#47;errors v1.8.1 &#47;&#47; indirect</span>
 	github.com&#47;cockroachdb&#47;logtags v0.0.0-20190617123548-eb05cc24525f &#47;&#47; indirect
 	github.com&#47;cockroachdb&#47;redact v1.0.8 &#47;&#47; indirect
 	github.com&#47;cockroachdb&#47;sentry-go v0.6.1-cockroachdb.2 &#47;&#47; indirect
<span class="term-fg32">+	github.com&#47;cockroachdb&#47;tokenbucket v0.0.0-20230807174530-cc333fc44b06 &#47;&#47; indirect</span>
 	github.com&#47;consensys&#47;bavard v0.1.13 &#47;&#47; indirect
 	github.com&#47;cpuguy83&#47;go-md2man&#47;v2 v2.0.2 &#47;&#47; indirect
 	github.com&#47;crate-crypto&#47;go-ipa v0.0.0-20230601170251-1830d0757c80 &#47;&#47; indirect
<span class="term-fg36">@@ -123,13 +125,14 @@</span> 	github.com&#47;prometheus&#47;common v0.32.1 &#47;&#47; indirect
 	github.com&#47;prometheus&#47;procfs v0.7.3 &#47;&#47; indirect
 	github.com&#47;rogpeppe&#47;go-internal v1.6.1 &#47;&#47; indirect
 	github.com&#47;russross&#47;blackfriday&#47;v2 v2.1.0 &#47;&#47; indirect
<span class="term-fg32">+	github.com&#47;stretchr&#47;objx v0.5.0 &#47;&#47; indirect</span>
 	github.com&#47;tklauser&#47;go-sysconf v0.3.12 &#47;&#47; indirect
 	github.com&#47;tklauser&#47;numcpus v0.6.1 &#47;&#47; indirect
 	github.com&#47;xrash&#47;smetrics v0.0.0-20201216005158-039620a65673 &#47;&#47; indirect
<span class="term-fg31">-	golang.org&#47;x&#47;mod v0.11.0 &#47;&#47; indirect</span>
<span class="term-fg31">-	golang.org&#47;x&#47;net v0.10.0 &#47;&#47; indirect</span>
<span class="term-fg32">+	golang.org&#47;x&#47;mod v0.12.0 &#47;&#47; indirect</span>
<span class="term-fg32">+	golang.org&#47;x&#47;net v0.15.0 &#47;&#47; indirect</span>
 	google.golang.org&#47;protobuf v1.27.1 &#47;&#47; indirect
 	gopkg.in&#47;yaml.v2 v2.4.0 &#47;&#47; indirect
<span class="term-fg31">-	gotest.tools&#47;v3 v3.5.0 &#47;&#47; indirect</span>
<span class="term-fg32">+	gotest.tools&#47;v3 v3.5.1 &#47;&#47; indirect</span>
 	rsc.io&#47;tmplfunc v0.0.3 &#47;&#47; indirect
 )</div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-5742ad92d15577d6afe9d93c" role="button"
                   aria-expanded="false" aria-controls="id-5742ad92d15577d6afe9d93c">
                    <code>go.sum</code>
                </a>
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum/go-ethereum/blob/3f40e65c484486dea6cff80b7db178985d21a2c6/go.sum" target="_blank">go-ethereum <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/ethereum-optimism/op-geth/blob/650bb2f2b1dcfe30d9b1fa6f7dc9608055ed60e1/go.sum" target="_blank">op-geth <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        <div class="text-end"><span class="text-success">+32</span></div>
                        <div class="text-start"><span class="text-danger">-24</span></div>
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-5742ad92d15577d6afe9d93c"><span class="term-fg1">diff --git go-ethereum&#47;go.sum op-geth&#47;go.sum</span>
<span class="term-fg1">index 9c6fd74e4a1b7e262eb96b0837726936d8c340a9..ab5db630e3e9cc230347e48bdafe1896175f0912 100644</span>
<span class="term-fg1">--- go-ethereum&#47;go.sum</span>
<span class="term-fg1">+++ op-geth&#47;go.sum</span>
<span class="term-fg36">@@ -109,18 +109,20 @@</span> github.com&#47;cloudflare&#47;cloudflare-go v0.14.0 h1:gFqGlGl&#47;5f9UGXAaKapCGUfaTCgRKKnzu2VvzMZlOFA=
 github.com&#47;cloudflare&#47;cloudflare-go v0.14.0&#47;go.mod h1:EnwdgGMaFOruiPZRFSgn+TsQ3hQ7C&#47;YWzIGLeu5c304=
 github.com&#47;cncf&#47;udpa&#47;go v0.0.0-20191209042840-269d4d468f6f&#47;go.mod h1:M8M6+tZqaGXZJjfX53e64911xZQV5JYwmTeXPW+k8Sc=
 github.com&#47;cockroachdb&#47;datadriven v1.0.0&#47;go.mod h1:5Ib8Meh+jk1RlHIXej6Pzevx&#47;NLlNvQB9pmSBZErGA4=
<span class="term-fg31">-github.com&#47;cockroachdb&#47;datadriven v1.0.3-0.20230801171734-e384cf455877 h1:1MLK4YpFtIEo3ZtMA5C795Wtv5VuUnrXX7mQG+aHg6o=</span>
<span class="term-fg32">+github.com&#47;cockroachdb&#47;datadriven v1.0.3-0.20230413201302-be42291fc80f h1:otljaYPt5hWxV3MUfO5dFPFiOXg9CyG5&#47;kCfayTqsJ4=</span>
 github.com&#47;cockroachdb&#47;errors v1.6.1&#47;go.mod h1:tm6FTP5G81vwJ5lC0SizQo374JNCOPrHyXGitRJoDqM=
 github.com&#47;cockroachdb&#47;errors v1.8.1 h1:A5+txlVZfOqFBDa4mGz2bUWSp0aHElvHX2bKkdbQu+Y=
 github.com&#47;cockroachdb&#47;errors v1.8.1&#47;go.mod h1:qGwQn6JmZ+oMjuLwjWzUNqblqk0xl4CVV3SQbGwK7Ac=
 github.com&#47;cockroachdb&#47;logtags v0.0.0-20190617123548-eb05cc24525f h1:o&#47;kfcElHqOiXqcou5a3rIlMc7oJbMQkeLk0VQJ7zgqY=
 github.com&#47;cockroachdb&#47;logtags v0.0.0-20190617123548-eb05cc24525f&#47;go.mod h1:i&#47;u985jwjWRlyHXQbwatDASoW0RMlZ&#47;3i9yJHE2xLkI=
<span class="term-fg31">-github.com&#47;cockroachdb&#47;pebble v0.0.0-20230906160148-46873a6a7a06 h1:T+Np&#47;xtzIjYM&#47;P5NAw0e2Rf1FGvzDau1h54MKvx8G7w=</span>
<span class="term-fg31">-github.com&#47;cockroachdb&#47;pebble v0.0.0-20230906160148-46873a6a7a06&#47;go.mod h1:bynZ3gvVyhlvjLI7PT6dmZ7g76xzJ7HpxfjgkzCGz6s=</span>
<span class="term-fg32">+github.com&#47;cockroachdb&#47;pebble v0.0.0-20230928194634-aa077af62593 h1:aPEJyR4rPBvDmeyi+l&#47;FS&#47;VtA00IWvjeFvjen1m1l1A=</span>
<span class="term-fg32">+github.com&#47;cockroachdb&#47;pebble v0.0.0-20230928194634-aa077af62593&#47;go.mod h1:6hk1eMY&#47;u5t+Cf18q5lFMUA1Rc+Sm5I6Ra1QuPyxXCo=</span>
 github.com&#47;cockroachdb&#47;redact v1.0.8 h1:8QG&#47;764wK+vmEYoOlfobpe12EQcS81ukx&#47;a4hdVMxNw=
 github.com&#47;cockroachdb&#47;redact v1.0.8&#47;go.mod h1:BVNblN9mBWFyMyqK1k3AAiSxhvhfK2oOZZ2lK+dpvRg=
 github.com&#47;cockroachdb&#47;sentry-go v0.6.1-cockroachdb.2 h1:IKgmqgMQlVJIZj19CdocBeSfSaiCbEBZGKODaixqtHM=
 github.com&#47;cockroachdb&#47;sentry-go v0.6.1-cockroachdb.2&#47;go.mod h1:8BT+cPK6xvFOcRlk0R8eg+OTkcqI6baNH4xAkpiYVvQ=
<span class="term-fg32">+github.com&#47;cockroachdb&#47;tokenbucket v0.0.0-20230807174530-cc333fc44b06 h1:zuQyyAKVxetITBuuhv3BI9cMrmStnpT18zmgmTxunpo=</span>
<span class="term-fg32">+github.com&#47;cockroachdb&#47;tokenbucket v0.0.0-20230807174530-cc333fc44b06&#47;go.mod h1:7nc4anLGjupUW&#47;PeY5qiNYsdNXj7zopG+eqsS7To5IQ=</span>
 github.com&#47;codegangsta&#47;inject v0.0.0-20150114235600-33e0aa1cb7c0&#47;go.mod h1:4Zcjuz89kmFXt9morQgcfYZAYZ5n8WHjt81YYWIwtTM=
 github.com&#47;consensys&#47;bavard v0.1.13 h1:oLhMLOFGTLdlda&#47;kma4VOJazblc7IM5y5QPd2A&#47;YjhQ=
 github.com&#47;consensys&#47;bavard v0.1.13&#47;go.mod h1:9ItSMtA&#47;dXMAiL7BG6bqW2m3NdSEObYWoH223nGHukI=
<span class="term-fg36">@@ -173,6 +175,8 @@</span> github.com&#47;envoyproxy&#47;go-control-plane v0.9.1-0.20191026205805-5f8ba28d4473&#47;go.mod h1:YTl&#47;9mNaCwkRvm6d1a2C3ymFceY&#47;DCBVvsKhRF0iEA4=
 github.com&#47;envoyproxy&#47;go-control-plane v0.9.4&#47;go.mod h1:6rpuAdCZL397s3pYoYcLgu1mIlRU8Am5FuJP05cCM98=
 github.com&#47;envoyproxy&#47;protoc-gen-validate v0.1.0&#47;go.mod h1:iSmxcyjqTsJpI2R4NaDN7+kN2VEUnK&#47;pcBlmesArF7c=
 github.com&#47;etcd-io&#47;bbolt v1.3.3&#47;go.mod h1:ZF2nL25h33cCyBtcyWeZ2&#47;I3HQOfTP+0PIEvHjkjCrw=
<span class="term-fg32">+github.com&#47;ethereum-optimism&#47;superchain-registry&#47;superchain v0.0.0-20231018164214-046f42968aec h1:4wWqpBeK7nwMVncglr9XLYIFmU8j5w2XmhtklztraNY=</span>
<span class="term-fg32">+github.com&#47;ethereum-optimism&#47;superchain-registry&#47;superchain v0.0.0-20231018164214-046f42968aec&#47;go.mod h1:&#47;70H&#47;KqrtKcvWvNGVj6S3rAcLC+kUPr3t2aDmYIS+Xk=</span>
 github.com&#47;ethereum&#47;c-kzg-4844 v0.3.1 h1:sR65+68+WdnMKxseNWxSJuAv2tsUrihTpVBTfM&#47;U5Zg=
 github.com&#47;ethereum&#47;c-kzg-4844 v0.3.1&#47;go.mod h1:VewdlzQmpT5QSrVhbBuGoCdFJkpaJlO1aQputP83wc0=
 github.com&#47;fasthttp-contrib&#47;websocket v0.0.0-20160511215533-1f3b11f56072&#47;go.mod h1:duJ4Jxv5lDcvg4QuQr0oowTf7dz4&#47;CR8NtyCooz9HL8=
<span class="term-fg36">@@ -262,8 +266,9 @@</span> github.com&#47;golang&#47;protobuf v1.4.1&#47;go.mod h1:U8fpvMrcmy5pZrNK1lt4xCsGvpyWQ&#47;VVv6QDs8UjoX8=
 github.com&#47;golang&#47;protobuf v1.4.2&#47;go.mod h1:oDoupMAO8OvCJWAcko0GGGIgR6R6ocIYbsSw735rRwI=
 github.com&#47;golang&#47;protobuf v1.4.3&#47;go.mod h1:oDoupMAO8OvCJWAcko0GGGIgR6R6ocIYbsSw735rRwI=
 github.com&#47;golang&#47;protobuf v1.5.0&#47;go.mod h1:FsONVRAS9T7sI+LIUmWTfcYkHO4aIWwzhcaSAoJOfIk=
<span class="term-fg31">-github.com&#47;golang&#47;protobuf v1.5.2 h1:ROPKBNFfQgOUMifHyP+KYbvpjbdoFNs+aK7DXlji0Tw=</span>
 github.com&#47;golang&#47;protobuf v1.5.2&#47;go.mod h1:XVQd3VNwM+JqD3oG2Ue2ip4fOMUkwXdXDdiuN0vRsmY=
<span class="term-fg32">+github.com&#47;golang&#47;protobuf v1.5.3 h1:KhyjKVUg7Usr&#47;dYsdSqoFveMYd5ko72D+zANwlG1mmg=</span>
<span class="term-fg32">+github.com&#47;golang&#47;protobuf v1.5.3&#47;go.mod h1:XVQd3VNwM+JqD3oG2Ue2ip4fOMUkwXdXDdiuN0vRsmY=</span>
 github.com&#47;golang&#47;snappy v0.0.3&#47;go.mod h1:&#47;XxbfmMg8lxefKM7IXC3fBNl&#47;7bRcc72aCRzEWrmP2Q=
 github.com&#47;golang&#47;snappy v0.0.4&#47;go.mod h1:&#47;XxbfmMg8lxefKM7IXC3fBNl&#47;7bRcc72aCRzEWrmP2Q=
 github.com&#47;golang&#47;snappy v0.0.5-0.20220116011046-fa5810519dcb h1:PBC98N2aIaM3XXiurYmW7fx4GZkL8feAMVq7nEjURHk=
<span class="term-fg36">@@ -362,8 +367,8 @@</span> github.com&#47;julienschmidt&#47;httprouter v1.2.0&#47;go.mod h1:SYymIcj16QtmaHHD7aYtjjsJG7VTCxuUUipMqKk8s4w=
 github.com&#47;julienschmidt&#47;httprouter v1.3.0 h1:U0609e9tgbseu3rBINet9P48AI&#47;D3oJs4dN7jwJOQ1U=
 github.com&#47;julienschmidt&#47;httprouter v1.3.0&#47;go.mod h1:JR6WtHb+2LUe8TCKY3cZOxFyyO8IZAc4RVcycCCAKdM=
 github.com&#47;k0kubun&#47;colorstring v0.0.0-20150214042306-9440f1994b88&#47;go.mod h1:3w7q1U84EfirKl04SVQ&#47;s7nPm1ZPhiXd34z40TNz36k=
<span class="term-fg31">-github.com&#47;karalabe&#47;usb v0.0.3-0.20230711191512-61db3e06439c h1:AqsttAyEyIEsNz5WLRwuRwjiT5CMDUfLk6cFJDVPebs=</span>
<span class="term-fg31">-github.com&#47;karalabe&#47;usb v0.0.3-0.20230711191512-61db3e06439c&#47;go.mod h1:Od972xHfMJowv7NGVDiWVxk2zxnWgjLlJzE+F4F7AGU=</span>
<span class="term-fg32">+github.com&#47;karalabe&#47;usb v0.0.2 h1:M6QQBNxF+CQ8OFvxrT90BA0qBOXymndZnk5q235mFc4=</span>
<span class="term-fg32">+github.com&#47;karalabe&#47;usb v0.0.2&#47;go.mod h1:Od972xHfMJowv7NGVDiWVxk2zxnWgjLlJzE+F4F7AGU=</span>
 github.com&#47;kataras&#47;golog v0.0.9&#47;go.mod h1:12HJgwBIZFNGL0EJnMRhmvGA0PQGx8VFwrZtM4CqbAk=
 github.com&#47;kataras&#47;iris&#47;v12 v12.0.1&#47;go.mod h1:udK4vLQKkdDqMGJJVd&#47;msuMtN6hpYJhg&#47;lSzuxjhO+U=
 github.com&#47;kataras&#47;neffos v0.0.10&#47;go.mod h1:ZYmJC07hQPW67eKuzlfY7SO3bC0mw83A3j6im82hfqw=
<span class="term-fg36">@@ -409,8 +414,9 @@</span> github.com&#47;mattn&#47;go-isatty v0.0.7&#47;go.mod h1:Iq45c&#47;XA43vh69&#47;j3iqttzPXn0bhXyGjM0Hdxcsrc5s=
 github.com&#47;mattn&#47;go-isatty v0.0.8&#47;go.mod h1:Iq45c&#47;XA43vh69&#47;j3iqttzPXn0bhXyGjM0Hdxcsrc5s=
 github.com&#47;mattn&#47;go-isatty v0.0.9&#47;go.mod h1:YNRxwqDuOph6SZLI9vUUz6OYw3QyUt7WiY2yME+cCiQ=
 github.com&#47;mattn&#47;go-isatty v0.0.12&#47;go.mod h1:cbi8OIDigv2wuxKPP5vlRcQ1OAZbq2CE4Kysco4FUpU=
<span class="term-fg31">-github.com&#47;mattn&#47;go-isatty v0.0.16 h1:bq3VjFmv&#47;sOjHtdEhmkEV4x1AJtvUvOJ2PFAZ5+peKQ=</span>
 github.com&#47;mattn&#47;go-isatty v0.0.16&#47;go.mod h1:kYGgaQfpe5nmfYZH+SKPsOc2e4SrIfOl2e&#47;yFXSvRLM=
<span class="term-fg32">+github.com&#47;mattn&#47;go-isatty v0.0.17 h1:BTarxUcIeDqL27Mc+vyvdWYSL28zpIhv3RoTdsLMPng=</span>
<span class="term-fg32">+github.com&#47;mattn&#47;go-isatty v0.0.17&#47;go.mod h1:kYGgaQfpe5nmfYZH+SKPsOc2e4SrIfOl2e&#47;yFXSvRLM=</span>
 github.com&#47;mattn&#47;go-runewidth v0.0.3&#47;go.mod h1:LwmH8dsx7+W8Uxz3IHJYH5QSwggIsqBzpuz5H&#47;&#47;U1FU=
 github.com&#47;mattn&#47;go-runewidth v0.0.9 h1:Lm995f3rfxdpd6TSmuVCHVb&#47;QhupuXlYr8sCI&#47;QdE+0=
 github.com&#47;mattn&#47;go-runewidth v0.0.9&#47;go.mod h1:H031xJmbD&#47;WCDINGzjvQ9THkh0rPKHF+m2gUSrubnMI=
<span class="term-fg36">@@ -528,6 +534,7 @@</span> github.com&#47;status-im&#47;keycard-go v0.2.0&#47;go.mod h1:wlp8ZLbsmrF6g6WjugPAx+IzoLrkdf9+mHxBEeo3Hbg=
 github.com&#47;stretchr&#47;objx v0.1.0&#47;go.mod h1:HFkY916IF+rwdDfMAkV7OtwuqBVzrE8GR6GFx+wExME=
 github.com&#47;stretchr&#47;objx v0.1.1&#47;go.mod h1:HFkY916IF+rwdDfMAkV7OtwuqBVzrE8GR6GFx+wExME=
 github.com&#47;stretchr&#47;objx v0.4.0&#47;go.mod h1:YvHI0jy2hoMjB+UWwv71VJQ9isScKT&#47;TqJzVSSt89Yw=
<span class="term-fg32">+github.com&#47;stretchr&#47;objx v0.5.0 h1:1zr&#47;of2m5FGMsad5YfcqgdqdWrIhu+EBEJRhR1U7z&#47;c=</span>
 github.com&#47;stretchr&#47;objx v0.5.0&#47;go.mod h1:Yh+to48EsGEfYuaHDzXPcE3xhTkx73EhmCGUpEOglKo=
 github.com&#47;stretchr&#47;testify v1.2.2&#47;go.mod h1:a8OnRcib4nhh0OaRAV+Yts87kKdq0PP7pXfy6kDkUVs=
 github.com&#47;stretchr&#47;testify v1.3.0&#47;go.mod h1:M5WIy9Dh21IEIfnGCwXGc5bZfKNJtfHm1UVUgZn+9EI=
<span class="term-fg36">@@ -536,8 +543,8 @@</span> github.com&#47;stretchr&#47;testify v1.5.1&#47;go.mod h1:5W2xD1RspED5o8YsWQXVCued0rvSQ+mT+I5cxcmMvtA=
 github.com&#47;stretchr&#47;testify v1.7.0&#47;go.mod h1:6Fq8oRcR53rry900zMqJjRRixrwX3KX962&#47;h&#47;Wwjteg=
 github.com&#47;stretchr&#47;testify v1.7.1&#47;go.mod h1:6Fq8oRcR53rry900zMqJjRRixrwX3KX962&#47;h&#47;Wwjteg=
 github.com&#47;stretchr&#47;testify v1.8.0&#47;go.mod h1:yNjHg4UonilssWZ8iaSj1OCr&#47;vHnekPRkoO+kdMU+MU=
<span class="term-fg31">-github.com&#47;stretchr&#47;testify v1.8.1 h1:w7B6lhMri9wdJUVmEZPGGhZzrYTPvgJArz7wNPgYKsk=</span>
<span class="term-fg31">-github.com&#47;stretchr&#47;testify v1.8.1&#47;go.mod h1:w2LPCIKwWwSfY2zedu0+kehJoqGctiVI29o6fzry7u4=</span>
<span class="term-fg32">+github.com&#47;stretchr&#47;testify v1.8.2 h1:+h33VjcLVPDHtOdpUCuF+7gSuG3yGIftsP1YvFihtJ8=</span>
<span class="term-fg32">+github.com&#47;stretchr&#47;testify v1.8.2&#47;go.mod h1:w2LPCIKwWwSfY2zedu0+kehJoqGctiVI29o6fzry7u4=</span>
 github.com&#47;supranational&#47;blst v0.3.11 h1:LyU6FolezeWAhvQk0k6O&#47;d49jqgO52MSDDfYgbeoEm4=
 github.com&#47;supranational&#47;blst v0.3.11&#47;go.mod h1:jZJtfjgudtNl4en1tzwPIV3KjUnQUvG3&#47;j+w+fVonLw=
 github.com&#47;syndtr&#47;goleveldb v1.0.1-0.20210819022825-2ae1ddf74ef7 h1:epCh84lMvA70Z7CTTCmYQn2CKbY8j86K7&#47;FAIr141uY=
<span class="term-fg36">@@ -592,8 +599,8 @@</span> golang.org&#47;x&#47;crypto v0.0.0-20200622213623-75b288015ac9&#47;go.mod h1:LzIPMQfyMNhhGPhUkYOs5KpL4U8rLKemX1yGLhDgUto=
 golang.org&#47;x&#47;crypto v0.0.0-20200820211705-5c72a883971a&#47;go.mod h1:LzIPMQfyMNhhGPhUkYOs5KpL4U8rLKemX1yGLhDgUto=
 golang.org&#47;x&#47;crypto v0.0.0-20201221181555-eec23a3978ad&#47;go.mod h1:jdWPYTVW3xRLrWPugEBEK3UY2ZEsg3UU495nc5E+M+I=
 golang.org&#47;x&#47;crypto v0.0.0-20210921155107-089bfa567519&#47;go.mod h1:GvvjBRRGRdwPK5ydBHafDWAxML&#47;pGHZbMvKqRZ5+Abc=
<span class="term-fg31">-golang.org&#47;x&#47;crypto v0.12.0 h1:tFM&#47;ta59kqch6LlvYnPa0yx5a83cL2nHflFhYKvv9Yk=</span>
<span class="term-fg31">-golang.org&#47;x&#47;crypto v0.12.0&#47;go.mod h1:NF0Gs7EO5K4qLn+Ylc+fih8BSTeIjAP05siRnAh98yw=</span>
<span class="term-fg32">+golang.org&#47;x&#47;crypto v0.13.0 h1:mvySKfSWJ+UKUii46M40LOvyWfN0s2U+46&#47;jDd0e6Ck=</span>
<span class="term-fg32">+golang.org&#47;x&#47;crypto v0.13.0&#47;go.mod h1:y6Z2r+Rw4iayiXXAIxJIDAJ1zMW4yaTpebo8fPOliYc=</span>
 golang.org&#47;x&#47;exp v0.0.0-20190121172915-509febef88a4&#47;go.mod h1:CJ0aWSM057203Lf6IL+f9T1iT9GByDxfZKAQTCR3kQA=
 golang.org&#47;x&#47;exp v0.0.0-20190306152737-a1d7652674e8&#47;go.mod h1:CJ0aWSM057203Lf6IL+f9T1iT9GByDxfZKAQTCR3kQA=
 golang.org&#47;x&#47;exp v0.0.0-20190510132918-efd6b22b2522&#47;go.mod h1:ZjyILWgesfNpC6sMxTJOJm9Kp84zZh5NQWvqDGG3Qr8=
<span class="term-fg36">@@ -604,8 +611,8 @@</span> golang.org&#47;x&#47;exp v0.0.0-20191227195350-da58074b4299&#47;go.mod h1:2RIsYlXP63K8oxa1u096TMicItID8zy7Y6sNkU49FU4=
 golang.org&#47;x&#47;exp v0.0.0-20200119233911-0405dc783f0a&#47;go.mod h1:2RIsYlXP63K8oxa1u096TMicItID8zy7Y6sNkU49FU4=
 golang.org&#47;x&#47;exp v0.0.0-20200207192155-f17229e696bd&#47;go.mod h1:J&#47;WKrq2StrnmMY6+EHIKF9dgMWnmCNThgcyBT1FY9mM=
 golang.org&#47;x&#47;exp v0.0.0-20200224162631-6cc2880d07d6&#47;go.mod h1:3jZMyOhIsHpP37uCMkUooju7aAi5cS1Q23tOzKc+0MU=
<span class="term-fg31">-golang.org&#47;x&#47;exp v0.0.0-20230810033253-352e893a4cad h1:g0bG7Z4uG+OgH2QDODnjp6ggkk1bJDsINcuWmJN1iJU=</span>
<span class="term-fg31">-golang.org&#47;x&#47;exp v0.0.0-20230810033253-352e893a4cad&#47;go.mod h1:FXUEEKJgO7OQYeo8N01OfiKP8RXMtf6e8aTskBGqWdc=</span>
<span class="term-fg32">+golang.org&#47;x&#47;exp v0.0.0-20230905200255-921286631fa9 h1:GoHiUyI&#47;Tp2nVkLI2mCxVkOjsbSXD66ic0XW0js0R9g=</span>
<span class="term-fg32">+golang.org&#47;x&#47;exp v0.0.0-20230905200255-921286631fa9&#47;go.mod h1:S2oDrQGGwySpoQPVqRShND87VCbxmc6bL1Yd2oYrm6k=</span>
 golang.org&#47;x&#47;image v0.0.0-20190227222117-0694c2d4d067&#47;go.mod h1:kZ7UVZpmo3dzQBMxlp+ypCbDeSB+sBbTgSJuh5dn5js=
 golang.org&#47;x&#47;image v0.0.0-20190802002840-cff245a6509b&#47;go.mod h1:FeLwcggjj3mMvU+oOTbSwawSJRM1uh48EjtB4UJZlP0=
 golang.org&#47;x&#47;lint v0.0.0-20181026193005-c67002cb31c3&#47;go.mod h1:UVdnD1Gm6xHRNCYTkRU2&#47;jEulfH38KcIWyp&#47;GAMgvoE=
<span class="term-fg36">@@ -627,8 +634,8 @@</span> golang.org&#47;x&#47;mod v0.1.1-0.20191107180719-034126e5016b&#47;go.mod h1:QqPTAvyqsEbceGzBzNggFXnrqF1CaUcvgkdR5Ot7KZg=
 golang.org&#47;x&#47;mod v0.2.0&#47;go.mod h1:s0Qsj1ACt9ePp&#47;hMypM3fl4fZqREWJwdYDEqhRiZZUA=
 golang.org&#47;x&#47;mod v0.3.0&#47;go.mod h1:s0Qsj1ACt9ePp&#47;hMypM3fl4fZqREWJwdYDEqhRiZZUA=
 golang.org&#47;x&#47;mod v0.6.0-dev.0.20220419223038-86c51ed26bb4&#47;go.mod h1:jJ57K6gSWd91VN4djpZkiMVwK6gcyfeH4XE8wZrZaV4=
<span class="term-fg31">-golang.org&#47;x&#47;mod v0.11.0 h1:bUO06HqtnRcc&#47;7l71XBe4WcqTZ+3AH1J59zWDDwLKgU=</span>
<span class="term-fg31">-golang.org&#47;x&#47;mod v0.11.0&#47;go.mod h1:iBbtSCu2XBx23ZKBPSOrRkjjQPZFPuis4dIYUhu&#47;chs=</span>
<span class="term-fg32">+golang.org&#47;x&#47;mod v0.12.0 h1:rmsUpXtvNzj340zd98LZ4KntptpfRHwpFOHG188oHXc=</span>
<span class="term-fg32">+golang.org&#47;x&#47;mod v0.12.0&#47;go.mod h1:iBbtSCu2XBx23ZKBPSOrRkjjQPZFPuis4dIYUhu&#47;chs=</span>
 golang.org&#47;x&#47;net v0.0.0-20180724234803-3673e40ba225&#47;go.mod h1:mL1N&#47;T3taQHkDXs73rZJwtUhF3w3ftmwwsq0BUmARs4=
 golang.org&#47;x&#47;net v0.0.0-20180826012351-8a410e7b638d&#47;go.mod h1:mL1N&#47;T3taQHkDXs73rZJwtUhF3w3ftmwwsq0BUmARs4=
 golang.org&#47;x&#47;net v0.0.0-20180906233101-161cd47e91fd&#47;go.mod h1:mL1N&#47;T3taQHkDXs73rZJwtUhF3w3ftmwwsq0BUmARs4=
<span class="term-fg36">@@ -672,8 +679,8 @@</span> golang.org&#47;x&#47;net v0.0.0-20210525063256-abc453219eb5&#47;go.mod h1:9nx3DQGgdP8bBQD5qxJ1jj9UTztislL4KSBs9R2vV5Y=
 golang.org&#47;x&#47;net v0.0.0-20210610132358-84b48f89b13b&#47;go.mod h1:9nx3DQGgdP8bBQD5qxJ1jj9UTztislL4KSBs9R2vV5Y=
 golang.org&#47;x&#47;net v0.0.0-20210805182204-aaa1db679c0d&#47;go.mod h1:9nx3DQGgdP8bBQD5qxJ1jj9UTztislL4KSBs9R2vV5Y=
 golang.org&#47;x&#47;net v0.0.0-20220722155237-a158d28d115b&#47;go.mod h1:XRhObCWvk6IyKnWLug+ECip1KBveYUHfp+8e9klMJ9c=
<span class="term-fg31">-golang.org&#47;x&#47;net v0.10.0 h1:X2&#47;&#47;UzNDwYmtCLn7To6G58Wr6f5ahEAQgKNzv9Y951M=</span>
<span class="term-fg31">-golang.org&#47;x&#47;net v0.10.0&#47;go.mod h1:0qNGK6F8kojg2nk9dLZ2mShWaEBan6FAoqfSigmmuDg=</span>
<span class="term-fg32">+golang.org&#47;x&#47;net v0.15.0 h1:ugBLEUaxABaB5AJqW9enI0ACdci2RUd4eP51NTBvuJ8=</span>
<span class="term-fg32">+golang.org&#47;x&#47;net v0.15.0&#47;go.mod h1:idbUs1IY1+zTqbi8yxTbhexhEEk5ur9LInksu6HrEpk=</span>
 golang.org&#47;x&#47;oauth2 v0.0.0-20180821212333-d2e6202438be&#47;go.mod h1:N&#47;0e6XlmueqKjAGxoOufVs8QHGRruUQn6yWY3a++T0U=
 golang.org&#47;x&#47;oauth2 v0.0.0-20190226205417-e64efc72b421&#47;go.mod h1:gOpvHmFTYa4IltrdGE7lF6nIHvwfUNPOp7c8zoXwtLw=
 golang.org&#47;x&#47;oauth2 v0.0.0-20190604053449-0f29369cfe45&#47;go.mod h1:gOpvHmFTYa4IltrdGE7lF6nIHvwfUNPOp7c8zoXwtLw=
<span class="term-fg36">@@ -756,8 +763,9 @@</span> golang.org&#47;x&#47;sys v0.0.0-20220722155257-8c9f86f7a55f&#47;go.mod h1:oPkhp1MJrh7nUepCBck5+mAzfO9JrbApNNgaTdGDITg=
 golang.org&#47;x&#47;sys v0.0.0-20220811171246-fbc7d0a398ab&#47;go.mod h1:oPkhp1MJrh7nUepCBck5+mAzfO9JrbApNNgaTdGDITg=
 golang.org&#47;x&#47;sys v0.0.0-20220908164124-27713097b956&#47;go.mod h1:oPkhp1MJrh7nUepCBck5+mAzfO9JrbApNNgaTdGDITg=
 golang.org&#47;x&#47;sys v0.8.0&#47;go.mod h1:oPkhp1MJrh7nUepCBck5+mAzfO9JrbApNNgaTdGDITg=
<span class="term-fg31">-golang.org&#47;x&#47;sys v0.11.0 h1:eG7RXZHdqOJ1i+0lgLgCpSXAp6M3LYlAo6osgSi0xOM=</span>
 golang.org&#47;x&#47;sys v0.11.0&#47;go.mod h1:oPkhp1MJrh7nUepCBck5+mAzfO9JrbApNNgaTdGDITg=
<span class="term-fg32">+golang.org&#47;x&#47;sys v0.12.0 h1:CM0HF96J0hcLAwsHPJZjfdNzs0gftsLfgKt57wWHJ0o=</span>
<span class="term-fg32">+golang.org&#47;x&#47;sys v0.12.0&#47;go.mod h1:oPkhp1MJrh7nUepCBck5+mAzfO9JrbApNNgaTdGDITg=</span>
 golang.org&#47;x&#47;term v0.0.0-20201117132131-f5c789dd3221&#47;go.mod h1:Nr5EML6q2oocZ2LXRh80K7BxOlk5&#47;8JxuGnuhpl+muw=
 golang.org&#47;x&#47;term v0.0.0-20201126162022-7de9c90e9dd1&#47;go.mod h1:bj7SfCRtBDWHUb9snDiAeCFNEtKQo2Wmx5Cou7ajbmo=
 golang.org&#47;x&#47;term v0.0.0-20210927222741-03fcf44c2211&#47;go.mod h1:jbD1KX2456YbFQfuXm&#47;mYQcufACuNUgVhRMnK&#47;tPxf8=
<span class="term-fg36">@@ -771,8 +779,8 @@</span> golang.org&#47;x&#47;text v0.3.5&#47;go.mod h1:5Zoc&#47;QRtKVWzQhOtBMvqHzDpF6irO9z98xDceosuGiQ=
 golang.org&#47;x&#47;text v0.3.6&#47;go.mod h1:5Zoc&#47;QRtKVWzQhOtBMvqHzDpF6irO9z98xDceosuGiQ=
 golang.org&#47;x&#47;text v0.3.7&#47;go.mod h1:u+2+&#47;6zg+i71rQMx5EYifcz6MCKuco9NR6JIITiCfzQ=
 golang.org&#47;x&#47;text v0.3.8&#47;go.mod h1:E6s5w1FMmriuDzIBO73fBruAKo1PCIq6d2Q6DHfQ8WQ=
<span class="term-fg31">-golang.org&#47;x&#47;text v0.12.0 h1:k+n5B8goJNdU7hSvEtMUz3d1Q6D&#47;XW4COJSJR6fN0mc=</span>
<span class="term-fg31">-golang.org&#47;x&#47;text v0.12.0&#47;go.mod h1:TvPlkZtksWOMsz7fbANvkp4WM8x&#47;WCo&#47;om8BMLbz+aE=</span>
<span class="term-fg32">+golang.org&#47;x&#47;text v0.13.0 h1:ablQoSUd0tRdKxZewP80B+BaqeKJuVhuRxj&#47;dkrun3k=</span>
<span class="term-fg32">+golang.org&#47;x&#47;text v0.13.0&#47;go.mod h1:TvPlkZtksWOMsz7fbANvkp4WM8x&#47;WCo&#47;om8BMLbz+aE=</span>
 golang.org&#47;x&#47;time v0.0.0-20181108054448-85acf8d2951c&#47;go.mod h1:tRJNPiyCQ0inRvYxbN9jk5I+vvW&#47;OXSQhTDSoE431IQ=
 golang.org&#47;x&#47;time v0.0.0-20190308202827-9d24e82272b4&#47;go.mod h1:tRJNPiyCQ0inRvYxbN9jk5I+vvW&#47;OXSQhTDSoE431IQ=
 golang.org&#47;x&#47;time v0.0.0-20191024005414-555d28b269f0&#47;go.mod h1:tRJNPiyCQ0inRvYxbN9jk5I+vvW&#47;OXSQhTDSoE431IQ=
<span class="term-fg36">@@ -827,8 +835,8 @@</span> golang.org&#47;x&#47;tools v0.0.0-20200804011535-6c149bb5ef0d&#47;go.mod h1:njjCfa9FT2d7l9Bc6FUM5FLjQPp3cFF28FI3qnDFljA=
 golang.org&#47;x&#47;tools v0.0.0-20200825202427-b303f430e36d&#47;go.mod h1:njjCfa9FT2d7l9Bc6FUM5FLjQPp3cFF28FI3qnDFljA=
 golang.org&#47;x&#47;tools v0.0.0-20210106214847-113979e3529a&#47;go.mod h1:emZCQorbCU4vsT4fOWvOPXz4eW1wZW4PmDk9uLelYpA=
 golang.org&#47;x&#47;tools v0.1.12&#47;go.mod h1:hNGJHUnrk76NpqgfD5Aqm5Crs+Hm0VOH&#47;i9J2+nxYbc=
<span class="term-fg31">-golang.org&#47;x&#47;tools v0.9.1 h1:8WMNJAz3zrtPmnYC7ISf5dEn3MT0gY7jBJfw27yrrLo=</span>
<span class="term-fg31">-golang.org&#47;x&#47;tools v0.9.1&#47;go.mod h1:owI94Op576fPu3cIGQeHs3joujW&#47;2Oc6MtlxbF5dfNc=</span>
<span class="term-fg32">+golang.org&#47;x&#47;tools v0.13.0 h1:Iey4qkscZuv0VvIt8E0neZjtPVQFSc870HQ448QgEmQ=</span>
<span class="term-fg32">+golang.org&#47;x&#47;tools v0.13.0&#47;go.mod h1:HvlwmtVNQAhOuCjW7xxvovg8wbNq7LwfXh&#47;k7wXUl58=</span>
 golang.org&#47;x&#47;xerrors v0.0.0-20190717185122-a985d3407aa7&#47;go.mod h1:I&#47;5z698sn9Ka8TeJc9MKroUUfqBBauWjQqLJ2OPfmY0=
 golang.org&#47;x&#47;xerrors v0.0.0-20191011141410-1b5146add898&#47;go.mod h1:I&#47;5z698sn9Ka8TeJc9MKroUUfqBBauWjQqLJ2OPfmY0=
 golang.org&#47;x&#47;xerrors v0.0.0-20191204190536-9bdfabe68543&#47;go.mod h1:I&#47;5z698sn9Ka8TeJc9MKroUUfqBBauWjQqLJ2OPfmY0=
<span class="term-fg36">@@ -941,8 +949,8 @@</span> gopkg.in&#47;yaml.v3 v3.0.0-20200313102051-9f266ea9e77c&#47;go.mod h1:K4uyk7z7BCEPqu6E+C64Yfv1cQ7kz7rIZviUmN+EgEM=
 gopkg.in&#47;yaml.v3 v3.0.0-20210107192922-496545a6307b&#47;go.mod h1:K4uyk7z7BCEPqu6E+C64Yfv1cQ7kz7rIZviUmN+EgEM=
 gopkg.in&#47;yaml.v3 v3.0.1 h1:fxVm&#47;GzAzEWqLHuvctI91KS9hhNmmWOoWu0XTYJS7CA=
 gopkg.in&#47;yaml.v3 v3.0.1&#47;go.mod h1:K4uyk7z7BCEPqu6E+C64Yfv1cQ7kz7rIZviUmN+EgEM=
<span class="term-fg31">-gotest.tools&#47;v3 v3.5.0 h1:Ljk6PdHdOhAb5aDMWXjDLMMhph+BpztA4v1QdqEW2eY=</span>
<span class="term-fg31">-gotest.tools&#47;v3 v3.5.0&#47;go.mod h1:isy3WKz7GK6uNw&#47;sbHzfKBLvlvXwUyV06n6brMxxopU=</span>
<span class="term-fg32">+gotest.tools&#47;v3 v3.5.1 h1:EENdUnS3pdur5nybKYIh2Vfgc8IUNBjxDPSjtiJcOzU=</span>
<span class="term-fg32">+gotest.tools&#47;v3 v3.5.1&#47;go.mod h1:isy3WKz7GK6uNw&#47;sbHzfKBLvlvXwUyV06n6brMxxopU=</span>
 honnef.co&#47;go&#47;tools v0.0.0-20190102054323-c2f93a96b099&#47;go.mod h1:rf3lG4BRIbNafJWhAfAdb&#47;ePZxsR&#47;4RtNHQocxwk9r4=
 honnef.co&#47;go&#47;tools v0.0.0-20190106161140-3f1c8253044a&#47;go.mod h1:rf3lG4BRIbNafJWhAfAdb&#47;ePZxsR&#47;4RtNHQocxwk9r4=
 honnef.co&#47;go&#47;tools v0.0.0-20190418001031-e561f6794a2a&#47;go.mod h1:rf3lG4BRIbNafJWhAfAdb&#47;ePZxsR&#47;4RtNHQocxwk9r4=</div>
    </div>

            
        </div>
        <div>
            
        </div>
    </div>
</div>

                    </div>
                
            </div>
        </main>
    </div>

    <footer class="col-xl-10 col-xxl-8 mx-auto px-3 pt-5 my-5 text-muted border-top">
        <p>Fork-diff overview of <a href="https://github.com/ethereum-optimism/op-geth"><code>op-geth</code></a>, a fork of <a href="https://github.com/ethereum/go-ethereum"><code>go-ethereum</code></a>.
and execution-engine of the <a href="https://github.com/ethereum-optimism/optimism">OP-stack</a>.</p>

    </footer>

    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.6/dist/umd/popper.min.js" integrity="sha384-oBqDVmMz9ATKxIep9tiCxS/Z9fNfEXiDAYTujMAeBAsjFuCZSmKbSSUnQlmh/jp3" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.min.js" integrity="sha384-mQ93GR66B00ZXjt0YO5KlohRA5SY2XofN4zfuZxLkoj1gXtW8ANNCe9d5Y3eG5eD" crossorigin="anonymous"></script>
    <script type="text/javascript">
        const storedTheme = localStorage.getItem('theme')

        // Get the preferred theme from the user's OS
        const getPreferredTheme = () => {
            if (storedTheme) {
                return storedTheme
            }

            return window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light'
        }

        // Set the bootstrap theme
        const setTheme = function (theme) {
            document.documentElement.setAttribute('data-bs-theme', theme)
            if (theme === 'dark') {
                document.getElementById('dark-mode-toggle').setAttribute('checked', true)
                document.getElementById('dark-mode-icon').classList.replace('bi-brightness-high-fill', 'bi-brightness-low')
            } else {
                document.getElementById('dark-mode-toggle').setAttribute('checked', false)
                document.getElementById('dark-mode-icon').classList.replace('bi-brightness-low', 'bi-brightness-high-fill')
            }
        }

        // Returns true if the current theme is dark
        const isDark = () => {
            return document.documentElement.getAttribute('data-bs-theme') === 'dark'
        }

        // Toggles dark mode
        const toggleDarkMode = () => {
            const newTheme = isDark() ? 'light' : 'dark'
            setTheme(newTheme)
            localStorage.setItem('theme', newTheme)
        }

        // Set the preferred theme on page load
        window.onload = () => {
            // Set preferred theme
            setTheme(getPreferredTheme());
            // Initialize tooltips
            const tooltipTriggerList = document.querySelectorAll('[data-bs-toggle="tooltip"]')
            const tooltipList = [...tooltipTriggerList].map(tooltipTriggerEl => new bootstrap.Tooltip(tooltipTriggerEl))
        }

        // Toggle dark mode when the toggle button is clicked
        addEventListener("click", (event) => {
            if (event.target.id === 'dark-mode-toggle') {
                toggleDarkMode();
                // De-focus the toggle
                document.activeElement.blur()
            }
        });
    </script>
</body>
</html>
